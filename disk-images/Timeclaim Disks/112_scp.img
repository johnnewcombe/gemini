ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее -1)  bufsiz -= 512;
if (data == -1) {
    putstr("insufficient memory available\n");
    return;
}
dir = data;			/* Directory buffer			*/
open();				/* Open data file and load directory	*/
cmdlin(argc,argv);		/* Parse the command line		*/
fmtdisc();
fclose(channel);		/* Close the file			*/
smove(0);
clreol();			/* Clear the top line			*/
clreos(3,0);	   		/* Clear the rest of the screen		*/
byebye(0);
if (ex_com != 0) {
    exec(ex_com,ex_arg);
    putstr("Command: ");
    putstr(ex_com);
    putstr(" not found\n");
}

}

/*======================================================================*/
/*
.he                                                           SETFORM(CMDLIN)
.pa
*/
/*======================================================================*/
VOID                     /*						*/
cmdlin(argc,argv)        /* Parse out any options from the command line */
WORD	argc;					/* Number of arguments	*/
BYTE	*argv[];				/* Pointer to arguments	*/
/*======================================================================*/

{

/* Parse out any options from the command line				*/
/* Sets the following globals:						*/
/*	reqdrv - in response to <drive>					*/
/*	autofl - in response to -a  (no manual input)			*/
/*	ex_com - in response to -e<command args>			*/

LOCAL
WORD	n;

LOCAL
BYTE	*p,
	**q;

STATIC
BYTE	derr[] = { "\nDrive x is not defined\n" };

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n = argc - 1;
q = argv + 1;
if (n != 0) {				/* If any arguments		*/
    if (**q != '-' ) {			/* Get any drive		*/
	reqdrv = **q++ & 0x5F;
	--n;
	if ((reqdrv - 'A') < numwin || (reqdrv - 'A') >= *ndrives) {
	    derr[7] = reqdrv;
	    putstr(derr);
	    byebye();
	}
    }
    while (n-- != 0) {			/* Search the rest		*/
	p = *q++;			/* Point at argument		*/
	if (*p != '-' )	{
	    putstr("Unrecognised argument >");
	    putstr(p);
	    byebye();
	}
	++p;
	switch (*p & 0x5f) {

	    case 'A':
		if ((autofl = *++p) == 0)  ++autofl;	/* Ensure NZ	*/
		break;

	    case 'E':
		ex_com = ++p;		/* Pickup the command		*/
		if (n != 0) {
		    ex_arg = *q++;
		    --n;
		}
		else  ex_arg = "";
		break;

	    default:
		putstr("\07Unknown argument >");
		putstr(p);
		byebye();
	}
    }
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—UУ‘†ШBDRIVEБQУUQ dd’DDU85QIZINVERTБФ–“SСаdФеe4ФH%9bDENSITБP”–“аdd’EEШ5QQI.SPTА–Фа55H@∆GAP2Б–Tаdd’D%ХHM%SIZEFБФ÷T’T d$ƒф4µ8%IRRESTRKБСФФ’—`U4іUx1MARSPLEXMБФ‘“SТ`UE4іUx	==QMjSPCБT‘РU T‘TDФ9QNFATIDБФ—P’Р`	UJDEFLTБS DDD%JJБРХQФ“V†d4ДддXE1=R_BASEБТQ“TаdфФдEИAM9VBDRVА—†dEED(]MADOUBLEБСQСХ†dеT’tФи1%5%RSYSTRKБУ—СФ—U 4‘d(	%=NNDRIVEБСХХP†dE$$8QI9M
FDTEXTБQТTФ’ $’8Q2TTLБФ÷T„’`dE%dдЎUQ=2REQDRVБФ”—Х—`dД$EфXa}=6EX_ARGБФ—P–ХQ†eTе4Є9=Q5
BYEBYEБТSТUР`DДTH=A:SORTБФ‘Р“`d‘D4ГИQ9RRDENTБР””TT†dФе4U%HI5=YQLISTБРQЧ‘S dtUDd4ш5Q96GETFMTБСУСХ†d‘іU85%:CMDLINФUMP≈a’4UDdHuMQYSETHWЗФ—U‘!е4UDƒФ(}MQQI6\                                                                                                                                                                                                       .фЧА                                                                                                                                                                     і  А †`8  ААа@(а	\Q+Ц%tƒЃ–ХбљW∞JшЙ_Q+т%Д®(Э
ҐBt\NП	“!:V'LDйјЭ@®u N†	‘:А'QDкHЭO™вuxN±ЙА                                                                    ZДл`ЭnЃBu–L  њеўА`   -Ю     	vА                                                                                                                                                 -Ґ а∞(ЗhєY† В:ё l– ÷! †  Ш }s Ќв,X :Ѕ Мџf & \»yсj Љ ђX  ",X :ё lџТ & \√уxЛ( ЈР6т 	А„2 ё|Z≤®0Д≤ a–Р	8 "≈ј≠дЌЊ``хћp7∞кXДЖ c cРА,` √ђ`"® EМ uМBT ±А±АИJ`0 a÷0cfА lА §А# - )∞@   0йшлy≥hАШ }sм– Х^јD%Рњ ИIј4 o 6mg Ѓ`!љЫ\ YVdBD 0маД¶ c`÷тfЎP0 ъжўґ8ХmјD  Ё И@ B o 6m£ Ѓ`	љЫk YWTBH 0ојДШ cА÷уf№0 EПА[–ЫwјB( 4  d Vч Xи UЊ@ƒј< oP6mк Yx uљАўі$EЦАXЫE ДјD ``Fm Y uБЅі†L dАVdј÷f”0!0 EУАXЫQ ДјX o∞6mOe Vьe@Vю YX uАµhEЧ X Ы\@ДјJ `–Ad `РFmz ЃbљЫrАYV|BY 0нДЬ f ÷	fЎ∞!0 ъжўґP	Хo@Д%РаIј2 `рFm©f`÷f№p!h aFm–f†÷fЁР!l a0FmвfаVf p rИp†#ФB< 9Y† ВЅdИB (ЖїЙєY† ВЌ£@lЦh  !АҐ  Ќ  , 9fА ≈Ђ*Ю≥@ =d≤e @А ішZ| Бћ–( е=ЁІЧiбМа”p1јpT B† Ћ6ЄїHzфT Fа …шe≤јЎuƒ”-qk–7(ЖћЙєY† В}kј1÷Љfё∞#в’Еdјўі$ЫFА≈Zф" DYHUФБZьUѓјў†  Л[КµшМEѓј≈YHF#e Fm/l1VRИƒYHЫo ƒZ∞UФБb1Rf№†1√e AМEФБЈ`E±@≈YHF#e Fmжjа1VRИƒYHЫ} ƒ[B  µ†Ђ`БИµ` Ђ_Б≥m8ЛБК±иђEП@ƒg≈Ђ*Ь
µ`6ЛВ	А„0<ёЌ  ґ»	ХTБZ–F"÷Аb≠X  "-X √£АТ’ AVґrКµ†4  ЊПм– •[ЅZЎV"÷јl:§*„†b,z*«†bа D¶ И±иЂБИ≤Р Ђ)3h Л\≥i»#*ќВ
µј≠ЫdAґlХlA6tM Ќ  "  EЃ ƒ  фd  2e АА      KnA  ХЪ  0Y†  Д  r≥mр#CqƒƒY`B  9EY` ЌҐ@lЖхЙєY† C|Д№ђџ»Ѕkј6mЖ>-YTU≠ ƒYXB  ±иЂ[єEZ–ЫVБbђzЌ  T ЗIЅEXфF"«†l:
! АҐђzАЈј Ќ§јlД@ r≥@ Ђ+H  ЋХЫOЅX"(еfёјFЂ_Б≥ih#ђUХБіTХ}БEYXR)К]b≠ВeАAVXГ@ЦmZfўаFUИfА ђђ	 і»÷*ЎаaЧ+6©В∞Y† 4  ААQV=Гјџ
еf”`VB( 9Yµ,В*Ћ МЏъ
& \јsxFД YЈ  Ќ  "(еfўАVЂ+B@mђuКґ8d"	 \ђџ≤
ЅfўрQVVИ≤∞#ОВ∞иH36ДБ≥h–Д r≥@ &\і      іHCDEҐ>(еfА Л!БК≤сj Єј¬ђЖеc∞7(Е  r≥@ В*«`b,і*Ћ@В1Л-
≈lџ"»аbђіЌ©†¬,Т*»аa ЫxЅDYpUО@ЁbђЄcР1VArК≤а#6ЗИ≤Ђ!БєEXм"А \ҐђЄеf”pfВ*« b,Ц*ЋАО± Ќ  YpUО@ЁbђЄcР1VArК≤а#6љ≤6—Г∞о∞0ДrИi£ХЫvЅ,mdЋuЅЕXм   ¬ А d#АА°•рА≈f–Рsв’В 
≤HіДб8Д  %¬`4≤e†`мЛЕ ’bББ•рАЈd¬a≥$B  2eћ А   -c∞0И  f A "ћ@ВђјЌє†І≈Ђ*§ГК≥  D И≥  Ђ1ƒYИЗJБ≈Y$÷*ћ@М– ХW≈YИEТ@≈YИУ.d  %ђ вђЖеБ ЦmVuК≤8e Ќ  ,VCrИvАФBА 9Yґ@ВЅ`И≥  Ђ2Pр…сj ≥авО(еfЏАF6— 2eћјА      KhЅ≈Xм" DYШUТјƒY†UЪјЎ ! АY®UТ@Ёbђ‘Ќ  Tƒ!ЗyA≈Y®F"Ќ@Вђћ ",ћ√Є вђћЌ•јз≈Ђ*Ч
≥0#ФUЪµ§ ЌІA≠ЫMБTd UЪb1hrК≥0#4  a“аБVhИƒY†l НАђ‘еfЏ∞ЖіЄ!ЗtA≈Y†l НАЩs`       ”†Б 9fяАqXЛ6@@Ћ6ЯД
ƒYЄB ≥А Ђ8ђЂN√≠aђа+g FVfјAЛ63oH;ФUЫБb,№ЌЃa– ХiY∞Ы_ВҐђ№Ќ±AmaeZ Б √іa Т√ђ! У.r         Ц’Д@@Ћ6•
E"ЧXЂБЖDY–UТјƒYЎUЭБb1vfџ Гв’Х|YЎЫsҐђиеf”†ЖVЌ†AЂЏ√Њ;Ж*ќјМџЃ"ѕ Вђм#И≥∞ ђVЌЊБ≈Ђ*ИД∞п»CьДKDBEYЎ *ќјВ±[6В≥h†CФUЮґ!ХM ANALYSE C     p             ANALYSE COM  
	           AMIE    006  	
            ANALYSE H                    BADSM   C     
П                ANALYSE REL                   ANLIB   C     r             ANLIB   REL                   ANMAN   C     L              ANMAN   REL                   ANRUN   C                  ANRUN   REL   *               ANRW    C     / !               ANRW    REL   "                ANTF    C     N#$%              ANTF    REL   &                C80     COM  4'()*+,-./0       FASBL1  SUB   1                FASBL2  SUB   2                FASBLD  SUB   	3                FASLNK  SUB   4                MAKESET SUB   5                SET     C     Y678              SET     REL   d9:;<             SETBIO  C     m=>?@             SETBIO  REL   A                SETFD   C    cBCDEFGHI         SETFD   REL   0JK               SETFDP  C     5LM               SETFDP  REL   N                SETFIL  C    'OPQRST           SETFIL  REL    U                SETFMT  C    pVWXYZ[\]         SETFMT  REL   F^_`              SETFORM C     $ab               SETFORM REL   Hcde              SETHOP  C     f                SETHOP  REL   g                SETHW   C     Bhij              SETHW   OLD   >kl               SETLIB  C    ~mnopqrst         SETLIB  REL   "uv               SETLST  C     3wx               SETLST  REL   y                SETPAK  C     1z{               SETPAK  REL   |                SETSRCH C     }                SETSRCH REL   ~                SETTERM C                      SETTERM REL   А                SETUB   C     5БВ               SETUB   REL   Г                SETUP   C     1ДЕ               SETUP   H     ?ЖЗ               SETUP   REL   И                SETVF   C     JЙКЛ              SETVF   REL   М                SLRNK   COM   @НО              CTDRVS  C     Р               DCLASH  C     $СТ              DODVE   C     У               DVCHAN  C     Ф               GETFCE  C     Х               GETFNM  C     Ц               GETOFF  C     Ч               GETOS   C     Ш               GETSWT  C     Щ               GOCRT9  C     'ЪЫ              GSFAIL  C     	Ь               IDSFIL  C     
Э               OFFHAN  C     Ю               OPNSWT  C     Я               PRCENT  C     †               PRCFMT  C     !°Ґ              RD2LF   C     £               RDFORM  C     §               SECHAN  C     J•¶І             SETOVR  C    2®©™Ђђ≠          SETSEQ  C     !Ѓѓ              SETUP   C     ∞               SKIPWS  C     ±               STABOX  C     ≤               STATUS  C     ≥               STFAIL  C     
і               SYSBL1  SUB   µ               SYSBLD  SUB   ґ               SYSLI¬  REL  'ЈЄєЇїЉ          SYSLNK  SUB   љ               SYSMAN  C     <Њњ              SYSMAN  H     ј               SYSMAќ  REL   	Ѕ               TDVCPY  C     ¬               ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                                   ANALYSE
.pa
*/
#include	"portab.h"
#undef		EXTERN
#include	"analyse.h"
#define		EXTERN	extern
#include	"printf.h"

#asm
	.request anrun,anman,anrw,antf,anlib,sethw
#endasm

#define		BUFSIZ 1024

EXTERN
BYTE	hardware[];

#define		extern

EXTERN
WORD	fout;				/* Output file Channel Number	*/

BYTE	*bios,
	*mfbtxt,
	*drvtab,
	ms;					/* MS from bios 	*/

WORD	stepr,
	settle;

/*======================================================================*/
main(argc,argv)
WORD	argc;
BYTE	*argv[];
/*======================================================================*/
/*USE
Portability	Level 4 (Assembler)
Parent Module	ANALYSE
Revision History:-
15/11/89 V04.00 - ICFO
         Version number jumped to 04.00 to bring it into line with
         SET, SETUP etc - ICFO
         Listing converted to latest Timeclaim standards - ICFO
         Speed removed.  Manual analyse now uses 'omega' to select
     BEYЎV+g`F	g`AXђEЭБҐђиЌ£Ѕ,Щs–       ‘PС 9f—∞СH§Rлc∞0»Л=
≤XЛ>
≥а МF"ѕАМЏФ|Z≤ђHЂ>3k0KФUЮБ† *ј∞мKЃДК≥а#6ЄДЯђЂИ*ѕАВ1Л>
≈b,ь*ѕјВ1Л?
≈nQV|ИƒYрV+fЎpЦmB	>-YW%Зf¬Xvl%ЗsD5tQ Ќ≥АмLЇ            ЦжДИ@А(Д  r≥@ B%9D5ЄQ ЌєаћД hАAЖhАCв’ХD≈YEҐY,E†БZF#h AVИИі@ МшµeRр°VВfџУв’ХKЕZF#h F
А ¬-√®°B≠ "-√¶°B≠& \«уxDЮ f’vU
h@@Кј h@Fh  "— Мџ 
¬ЃЅB≠ЕЩµH)ЫZЩUь)Зu¬•ѓбB≠Ќ£°B-ЌЉ°Ђ"√ЇбB≠#Иі ђVЌ∞aB- *– Б@ 2"– В≠ Ќ≤!-*– Г` ЂB9EZ "шЖ\ђџ∆Ѕ`Кі #ФUҐ'–УЬ
і@#ьЕKwBД ХЪ  0Y† ЖЕКі@#ХЫRВЎ,:√°°lЏШwBГ`Ї ^P§H   aё∞¶р	h@GXД fџ†(ЂB	А„1ьёеfЁ`ЦU†Бґp)ЫbBЩTр,UС@ўіƒ-Ы]¬ЩU,B  2D &]  KRВƒ   еЫKВ№ђ– В& іP#яК≤(E €И≤(лК≤(E  И≤(лК≤(Eа€И≤(лК≤(D  И≤(лКіP DВ fўPЖІh†@Йh ЌЃБLЏz ґl;ђ*—@ОVm`И≤(л≥o–U^CА+XZ ^–`
Д   ;$*… aь2лdP6m•e_±VI®бСEdP0И Ќђ Н™!  YУ.М      Z! ,џ^еf’0ґЛF@ Оd∞1Рi AМE§Z@ЫS¬ўґ†-ХP√Z@ЫJ√і$1÷*—АМџƒЌ•ЅМ™ґ*“ В1ЛH
іp МE£БtЬ0U£Б2’рЅ |Z≤ѓh`Д rИk∞£ХЫqВШ,Ф.еа +6Є0X"(] !ј@Vh  Ѕ`ОµА6щВ	А;Z-ЩЦћЖKfCZјЫdГђЏФЅf№–Ц_a№ ∆mњ≥!ИpЩAА,»b fCА   CААҐ` еf„†6шµa]p∆m÷fўpгв’ХxГwі0Cb≈ђџТЅa’рЅ еА Vm&`∞Y2й @        	oЎ`Д  ` V  f”†√в’ХNГШtp4UА !  dEА t4UА  Р eЫACDZHUђАƒlЏИ І°Ґ≠$еk 6m%	f“а÷UFa–р—V,  Ѓ`!љЫOГYUl4B 0крhД  i@AV8 ЃбЦm:eW@— √ЃбҐ  E•БX  " YіР4"њЖE"СHD  єEZP÷*“јБСKD2Ќ¶бВ-0*ј X 2Ќ∞AҐ`хћю7єEXи L >єЯ∆цmx	e_—V  ВАЦm© ҐђX ЌЈБђ+№*ј P 2Ќє!Ґ`хћ7єEX∞ЫtГYµ@5Ы{√YT(8UА  ј eЫw√DјXЂ 3nH;6щ≤©pЂ  A† Ћ6€ЖЇ≈YЫBЩі,9ХKГЕZ`FЌ§AћЏX ¶бћ:t√°бҐђ  Ќ£«≈Ђ
§З_пцHЂI	А„0ё† Цm>i AV8 ЃбУв’Е\ГЕZH"  DZHUНА*„шdшµaXАбVТД СТi GXЂLDZHU§Б2й†@ [.! АђџЃЅi†Fm/e[ бVЪr≥k ;U¶Б2йј@      %ґБ¬ђ|  Аґd-ЕrCЕXш "< 3jc6—З0ЃјpЂ, @ mїf№†жUвА С  "”АВђ| лiјFm÷ePацiјAЛN0п@pЂNrhdl€aяАб  "”јВђ∞ "”АВђ| лeА ЋђUІЈј9ХtГЎtд<UІb-8√£Aв≠<…†aЦmWЯђЂ6!2 ZАUІБ942Ќ®!в6mўeVpсV†Иµ #6≠З≤ђ8xЂOƒZx÷*«јЏ> ∞Бв  EІБu<<U®ЛVЫЏAG+6уЖ0D &[6*”јБЪrКіа#Dъe†ђUІБ"-<*«ј±VЮfА ЂЮ*”јОQV> fџ∞aЮa“рс …ЧQ  Ё`сэю"÷@b` "‘@В≠Dеj FmWr≥hhcҐ}	3k@{*В
µ МE®БwИ<Cђ ZИU®БЈ®<шµeRсVҐИµ ≠ЫCД*WшdшµaRЅ/a–°VҐf—бв’ХXƒZИЫLƒђ– ВЌЊ°м™і *‘@МЏ| & \јуxЛYКµ ђE®Бј rИuАФB	 9Y† ВЅdИ@ +6с0OЛVUЖf—†6h  !ВЬҐj(еf„–∆ЫOАўґдB ?И≤Ђ БєY† EО@ƒlЏ“ Є"ђВ ?Г",В√іBђr#>-XWL@CxЕђџа
ЅdК±»ЛБ≥hР0Д ≥lаkФB YЈДA Ќђb,4  d07+4  `И@ +6дВ0YЈ–B 9D  ХЫ}Г,  еf—†6™ѕ ђ™Т"*≥јQU† r≥@ C@E\ђџЮ ЅYа+6Ы∞D4,U ЌІ¬,LЇР      	jPИ(Иr4ЭМҐјА“sНзAР f4ЫМ¶@P B YЈ§@V"‘АВ rЌ≠"1ЛT
µ !сj ЈвB≠PЌЃb,ЏЮ iњ√'≈Ђ*чИКµ@ МF"’ В±[6√≥lHИШ }sЌв+8 *‘АВ±§Yј КэюuКµ†6гЗ0ЃЄИ™ќ WпрЋФUѓјўґИEҐЌѓ!мЏМ  љв"Ђ8 }UJr≥j0ЛЫFАељв2ёсV§Иµ  Мшµe[с!V®ИƒZ†V+fўс¶j`Fm—іябУв’ХKДД4\U Ќљ",V¶r≥i УЫFА≈ZШF"‘јВ≠LЌҐB`хћ_7∞н`РЂSƒZШЫNDДVhЫkƒUxHUfАb+4 √ЈВB≠L#j`AЮ j@Cв’ХcDЕZ†F#jАAX≠ЫAƒДVА U©b-H√≤bBИ$"і ;x$!•вЃVm(`Кµ0#ХЫfƒШ,Џ4√ЈВLџ\QИ 
¬$E   ;,$√љв2џс&I†/&А	•2!<¶ *УЙ%В°§ $РЙ§B)` D#ФИДтШ ТC&
EА<¶9 ЙДRј ИE!АDтШ ™C)С “IHВG"АeByL I!У	§QРд G!У `ЖD#ј“yL E,»§¬a<Ь $§r ВP'У	Др$ЖL(JEPВP"Аep РP&HјЖA"К`єЬG+јтАћb &IƒRє@ 5  1p‘ 3 I P®T*НзAД@G2ЫM&гHАЪF!gУЩ– m
ЕB°P ЪF! 
¶гa§÷e6D3…ћиe6ИЗ#	М÷ 4ЫД"I<¶,Ng3©і“n3И  А@  АОe6ЪM∆С4кl:E§cy»Џa:HDТyL@ #ќF”	–  8НжsСДЏ +NG3IЉ№ √И @= "  В:# D“	P¶."JА©И C0ЫН∆у†АЎo1ШNЖQЮR&РJЕ1qВTЌ¬!»“v2И P®TD4ЬћbСФ¬dNG#y»T* 
#yЬдa6ИІ#СЉд @cy»Џa:јSq– rНз#iДи 1ЫћЖQ и@ #ќF”	–@c7ЩҐIћ@u7¶cIЄ d Fу9»¬mNG#y»@3 1HА»c4Иfу1–оa9D»аl 
ЖУiФ∆l0ЪMҐИдp8#Сјд i7ќ¶c1§∆i2ЫОВiФЏo9D±Д“l0ШНЖPP Жo6ЫL&г и@ НзAШёu7@©Єдe1ЫћжгIћ dNFs©і n:ј 9T№k7ќжбДдg:ЫL¶г†А| М÷Йbе5tХD8ЋЎЕABORTО•дD•х»Ќ8ЕALLOCОЌ dUDфd»тXA_INDXПFБƒ$E%hхиBIOSП) d$ƒф4µ8у BOOTSZП  4%8хАBUFFERП Бд%Te4Х®и–BYEBYEММ‘2д5(Ќ5C.DIVМкИƒ2дtX…8|C.GTМёЗƒ2дƒXќ МC.LTМ±d2д’T≈H РХC.NOTМќЖT2е5ЕHѕј]C.TSTП!Бд4ДддXсјCLOCKМВИд4≈$Tф»»АОCLREOSМ√ИD4≈%8лОCMDLINМџT4‘фDXй–FCOMPARМ№Вд4фдхUHЋUCONSTМбD5$ƒhс»DATAПYдDTdE%hч†DEFLTП dDTе4ХHсЎDIRП* dDХ$T5HхАDOUBLEПNБіE(цDPBBASПVдEED(р DRIVEО» dE%dдЎцDRVTABМц§RиќјЛE.0М ‘U%$х(…hМEXECМ®ƒUДХHн EX_ARGОѕ dUЕф4фЎуpFATIDМьИdd4ƒх4Xц8FDTEXTПdБ‘dХ%5HтPFMTBYTПАdd’DDU8ѕРЖFMTDISП dd’DE%hрFMTIDОлдd’DдЎс–FMTTPIП dd’EE$ЄпЎfFNDDRVМНГTdхTитјFRSTSEМ¶	$rит GAP1П# Dt(т@GAP3ОНдtUDTеHкшfGETFCOОЋЗdtUDd’HћPfGETFROМњ	$ВиѕаfHARDWAПgдД$EфXн»$HEADПƒДT≈тHHIGHESМќдДФ≈ффhћ0.HIL_ONПБФШс†INDEXОЯдФдХEdнXFINSERTП dФеdU%HсРINVSIDПБФ®»LDIRMП[‘ƒФ‘ХH»p4LOCKП. D≈5Hл∞ДMAINОЏd‘іU8и>MATCH8П5 T‘TDФхаMFBМЎƒ‘хdXЋАЖMOVSTRПeБ§’8…ЎjN.П_БддE$ХdXу`NFATSОДБддхD‘d( ЖNUMERIПZдеT’tФих–OFFSETОЙDхTих`PП&Бе4T4еXт–PSKEWМиВеUDеTЎћРЖPUTSATМ—ЙeUE5E(хpQМЏ•иоhMQLISTП"Б’ƒфdhл =RDENTМЅГ≈$THк(NREMOVEОќ e$UE%hт∞RESTRKП#Бе%ф$4XќPzS.П e44Ддxѕ0VSCRDUMПhе4T4%ThуАSECTRAМєе4TTµ$8т`SIDEFП' U4Х§Th»НSMOVEПfе4фeEфXн<SORTП3 558тSPDП4 U5dHтрSPLEXMП 55Hу SP_INIОлГe5$4ДDШћ`mSTATEМеЖe5E$4’ЌXSTRCPYП\е5Х5E$ЄтАSYSTYPОИ e5Х5хEШи TFLПbБеE$е4(уTSKEWОД 5ED»»ЎUNLOCKО— eTе4Єѕp}UPPERПWеu54Yј  Юhе4T4%ThуАSECTRAМєе4TTµ$8т`SIDEFП' U4Х§Th    Dual Speed and Dual Data Rate
         (Change in ANMAN / Various functions) - ICFO
         Error messages improved
         (Change in ANLIB / ERROR) - ICFO
         Check introduced to stop manual analyse going beyond
         the maximum track on the drive.  Applied to case 'T'  Case
         'C_RIGHT' can go two tracks beyond the drive maximum
         (Change in ANMAN / MANUAL) - ICFO
         Finding number of sides done before highest track number
         check so track number check can use the results of the
         side check
         (Change in ANRUN / AUTO) - ICFO
         'kflush' introduced into loop in manual analyse to stop
         repeat characters holding up the system.  Version from AMIE
         used
         (Change in ANMAN / MANUAL) - ICFO
         Gap sizes displayed in correct place when help has been
         requested
         (Change in ANTF / FGAPS) - ICFO
         Code for detection of index mark improved
         (Change in ANTF / FINDTF) - ICFO
         Main loop control improved.  User can loop thro' Auto and Manual
         at will
         (Change in ANRUN / AUTO, ANRUN / WAITGO, ANMAN / MANUAL and
         SETTERM / GETLIN to stop ESC operating the 'abort' mechanism.
         Also ANRUN / AGAIN removed as it is no longer used) - ICFO
         All calls to 'conout' changed to 'putvid' so that SVCLIB
         (or W50LIB) can be used.  Also TLIB used instead of CLIB.
         Note that for the linker used (SLRNK) the REL file must be
         present not the IRL file as used with LINK - ICFO
         Uses SVCLIB (or W50LIB) and TLIB.  Functions which are in
         these libraries removed from ANLIB.C - ICFO
         Calls to 'itoa' in ANLIB / GETINT turned round because the
         arguments were in the wrong order for the version in TLIB - ICFO
         All references to 'abort' have now been removed - ICFO
         If there is a peculiar side field on a single sided disc
         it no longer reports side fields for both sides
         (Change in ANRUN / CHKSIDE) - ICFO
         'fout' explicitly closed if there is a following program to
         be executed via 'exec'.  Without this the output file wasn't
         closed and therefore appeared as a zero length file - ICFO
         Gap 1 limit raised to 120 for both single and double density
         (Change in ANTF / FINDTF) - ICFO
         Program requires drive NUMBER or LETTER
         (Change in ANALYSE / GETDAD) - ICFO
12/05/88 V02.42
         Delay routines use MS picked up from bios patch area for HD64180
         CPU.
11/03/88 V02.41
         Code to handle Dual Density 3.5" TEAC FD35-HFN-22 amended to use
         the State Table defined in 'sethw'
17/02/88 V02.40
         Dual Density 3.5" TEAC FD35-HFN-22 added
22/10/86 V02.30
         'Terminalised' and adjusted to match new format of the
         drive field in SETHW.C
xx/02/86 V02.20
         Extensively modified. Command line arguments added. Can now enter
         drive letter from command line, -a for no pause for manual inputs
         -e for 'exec' on to another command. Also restructured and printf
         introduced so that the ouput can be redirected to a file.
30/09/85 V02.10
         Version number incremented at Gemini's request, preliminary
         to a new release.
08/06/85 V02.00
         Modified for GM849 & MFB II
         Hardware details now built into the software
04/09/84 V01.90
         Change in format file to HARDWARE.DAT. Concealed copyright
         message added. (Previously in clear).
31/03/84 V01.80
         "Max track" determination added. Bug with accepting
         drive names corrected.
27/02/84 V01.70
         Brought into line with BIOS 3.0.  Also "Read Track"
         analysis option included for the Cognescenti
14/11/83 V01.50
         "Deleted Data" error masked out on Read subroutine
13/09/83 V01.40
         Fixed Bug on analysing 8" discs
13/07/83 V01.30
         Brought into line with SETUP and HARDWARE with the
         use of the configuration entry in the data file
15/04/83 V01.20	Written by David Parkinson
                (c) dci software
                (c) Timeclaim Ltd
*/

{

STATIC
STATUS	getdcode();

STATIC
VOID
	init(),
	cmdlin();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

clrs();					/* Clear the screen		*/
init();

cmdlin(argc,argv);			/* Get command line options 	*/

move(0,4);
putstr("Analyse version 04.00    ");
move(0,30);
putstr("(c) dci software 1986 & Timeclaim Ltd 1988,1989");

move(5,0);
data = alloc(BUFSIZ);			/* Get some buffer space	*/
if (getdcode() == SUCCESS) {		/* Find drive to use		*/
    clreos(3,0);

    analyse();

    unlock();

    if (ex_com != 0) {
	fclose(fout);
	exec(ex_com,ex_arg);
	printf("Command <%s %s> not found\n",ex_com,ex_arg);
    }

}

exit();

}

/*======================================================================*/
/*
.he                                                           ANALYSE(CMDLIN)
.pa
*/
/ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                                    SETHOP
.pa
*/
#include	"portab.h"

EXTERN
WORD	autofl,		/* Set NZ if once-only automatic run-through 	*/
	soft_err,	/* Count tracks with soft errors during verify	*/
	hard_err;	/* Count tracks with hard errors during verify	*/

/*======================================================================*/
VOID                                                /*			*/
f_start()                                           /* Start the hopper */
/*======================================================================*/
/*USE
Portability	Level 4 (Depends on Hardware)
Parent Module	FORMAT
Revision History
26/10/89 Brought up to Timeclaim standards - ICFO
01/07/86 Version 3.4
         Module dealing with disc formatting (part).
         Added in release 3.4 of SETFORM.  Dummy module which could
         be replaced by an alternative module that handles a hopper
         feed for automatic formatting of discs.
         Written by David Parkinson
         (c) dci software 1986
*/

{

/* This entry point is called at the start of the format/verify loop.	*/
/* It is called before the software puts out the 'Format or Verify'	*/
/* prompt.  If the 'autofl' is set the prompt routine automatically	*/
/* assumes 'F'. (NB a check is also made for the presence of a disk	*/
/* in the drive).							*/
/*									*/
/* If the -a option is included in the command line 'autofl' is		*/
/* intialised with the character immediately following the 'a', or with	*/
/* 1 if nothing was entered. (The idea behind this is that -a9 for	*/
/* example could be taken as an instruction to repeat the loop 9 times.	*/
/* It is up to f_start() to count down and then to abort() at the	*/
/* appropriate moment).							*/
/*									*/
/* NULL routine for now. (Could be used for automatically loading a	*/
/* disk in a hopper-fed environment).					*/
/*									*/
/* NB an 'abort(1);' will terminate the formatting loop at this point.	*/

/* - *======================================================================*/
STATIC VOID
cmdlin(argc,argv)
WORD	argc;
BYTE	*argv[];
/*======================================================================*/

{

/* Parse out any options from the command line				*/
/* Sets the following globals:-						*/
/*	reqdrv - in response to <drive>					*/
/*	autofl - in response to -a  (no manual input)			*/
/*	ex_com - in response to -e<command args>			*/

LOCAL
WORD	n;

LOCAL
BYTE	*p,
	**q;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n = argc - 1;
q = argv + 1;
reqdrv = 0;
if (n != 0) {					/* If any arguments	*/
    if (**q != '-') {				/* Get any drive	*/
	reqdrv = toupper(**q++ & 0xff);
	--n;
	drive = -1;
	if (reqdrv >= '0' && reqdrv <= '8') {
	    strcpy(buffer,"DRIVE ");
	    buffer[6] = reqdrv;
	    buffer[7] = ' ';
	    buffer[8] = NULL;				/* Delimiter	*/
	    drvdat = hardware;
	    while (drvdat->id[0] != 0) {
		if (strcmp(buffer,drvdat->id) == MATCH) {/* Match found	*/
		    drive = drvdat->addr;
		    break;
		}
		++drvdat;
	    }
	}
	else if ((reqdrv - 'A') >= fstdrv && (reqdrv - 'A') < maxdrv)
								drive = 0;

	if (drive == -1) {
	    printf("Drive %c is not on this system\n",reqdrv);
	    exit();
	}
    }
    while (n-- != 0) {				/* Search the rest	*/
	p = *q++;				/* Point at argument	*/
	if (*p != '-') {
	    printf("Unrecognised argument >%s",p);
	    exit();
	}
	++p;
	switch (*p & 0x5F) {

	    case 'A':
		autofl = 1;			/* Automatic run	*/
		break;

	    case 'E':
		ex_com = ++p;			/* Pickup the command	*/
		if (n != 0) {
		    ex_arg = *q++;
		    --n;
		}
		else  ex_arg = "";
		break;

	    default:
		printf("Unknown argument >%s",p);
		exit();
	}
    }
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                           ANALYSE(NOTMFB)
.pa
*/
/*======================================================================*/
STATIC VOID
notmfb()
/*======================================================================*/

{

STATIC
VOID	byebye();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(1,16);
putstr("**** Not a Gemini MFB system ****");

byebye();

}

/*======================================================================*/
/*
.he                                                           ANALYSE(BYEBYE)
.pa
*/
/*======================================================================*/
STATIC
VOID
byebye()
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

unlock();					/* Unlock screen	*/
move(3,0);
exit();

}

/*======================================================================*/
/*
.he                                                             ANALYSE(INIT)
.pa
*/
/*======================================================================*/
STATIC VOID
init()
/*======================================================================*/

{

LOCAL
WORD	*ip;

LOCAL
BYTE	*ndrives;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
;   Pick up the vector to the MFB patch area
	ld	c,0E5h			; 849 check
	ld	a,0F7h
	out	(c),a
	in	a,(c)
	add	a,0E0h
	ld	hl,exit
	jr	c,L1$			; Exit if not proper 849
	ld	hl,(1)			; Do a CALL HOME
	ld	de,21
	add	hl,de
	call	L1$
	ld	(bios),bc		; Set the pointer
	ld	hl,(1)
	ld	de,55			; Offset to MS
	add	hl,de
	ld	a,(hl)
	ld	(ms),a
	jr	L2$
L1$:	jp	(hl)			; For an indirect CALL
L2$:
	.8080
#endasm

if (strcmp(bios,"MFB") != MATCH) {		/* Check BIOS		*/
    notmfb();
    byebye();
}

/* Set pointer to maximum number of drives and maximum number of drives	*/
/* defined								*/
ndrives = ip = (bios + 5);
++ndrives;

drvtab = *++ip;
ip += 5;
mfbtxt = *ip;
maxdrv = *ndrives;				/* Max of four drives	*/
fstdrv = 0;					/* No winchesters yet 	*/
while ((((*(drvtab + fstdrv * 16)) & 0x0f) == 0) && (fstdrv < maxdrv))
								 ++fstdrv;
if ((maxdrv - fstdrv) > 5)  maxdrv = fstdrv + 5;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                         ANALYSE(GETDCODE)
.pa
*/
/*======================================================================*/
STATIC STATUS
getdcode()
/*======================================================================*/

{

/* Select the drive to be used - must lie between fstdrv & maxdrv	*/

STATIC
STATUS	getdad();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (reqdrv == 0)  head();			/* Display options	*/

return(getdad());

}

/*======================================================================*/
/*
.he                                                             ANALYSE(HEAD)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETHOP(F_END)
.pa
*/
/*======================================================================*/
VOID                                                 /*			*/
f_end(status)                                        /* Stop the hopper */
WORD	status;						/* Chip status	*/
/*======================================================================*/

{

/* This function is called on the completion of the verification phase.	*/
/* The 'status' parameter is a copy of the 'status' register		*/
/* of the 2793.  This will only be set if there has been a serious	*/
/* error.								*/
/* 	(status & 0x80) >>>  Drive not ready.				*/
/*	(status & 0x40) >>>  Disc is write protected.			*/
/*	(status & 0x20) >>>  Write fault.				*/
/*									*/
/* The global variable soft_err holds the count of the number of	*/
/* sectors which were found to have errors.				*/
/*									*/
/* The global variable hard_err holds the count of the number of	*/
/* sectors which were found to have errors that did not clear after	*/
/* eight retries.							*/
/*									*/
/* If the function returns 0, the main program continues normally.	*/
/* If the function returns NZ, then further checking / error reporting	*/
/* is suppressed and the program repeats from the start of the		*/
/* formatting loop. (ie f_start() is called next ).			*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (hard_err != 0)  autofl = 0;	/* If 'hard' errors clear 'autofl'	*/

return(0);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—U‘ deх5D(}9P 5 ЦА 2E@ сj °а  D  @ Ld4 ™™'£&G@@*2ъ*r$t #/©™ ©F  9td$ ©"/Ґ∆  2Ъz2Ґъ,а  Ю                   LANEW–  MAN   %            BUILDB  SUB                 LTCDP†  MAN  е%( "      LLOYDS  OV3  їCЙM3      TAPEDUMPW50   56789      TIDY2   SUB   :              LTCDP†  OV0    з              LTCDP†  OV1   с              SETFDP  C     5§W            SETHOP  $$$                    MARCONI FLE   !              LTCDP†  OV2   &уф            ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее.pa
*/
/*======================================================================*/
VOID                                        /*				*/
head()                                      /* Display the main heading */
/*======================================================================*/

{

/* Put up the main heading for drive type entry.  Uses the global	*/
/* 'fstdrv' and 'maxdrv'						*/

LOCAL
WORD	i,
	j,
	k;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

clreos(1,0);
for (i = fstdrv; i < maxdrv; ++i) {
    move(1,(i - fstdrv) * 15);
    putvid(' ');
    putvid('A' + i);
    putstr(" = ");
    putstr(mfbtxt + i * 18);
    j = (*(drvtab + i * 16)) & 0x0f;
    move(2,(i - fstdrv) * 15);
    putvid('(');

#ifdef GM829
    for (k = -1; j > 0; j >>= 1)  ++k;
#else
    k = ttl[j & 7];
#endif

    putnum(k);
    putstr(")  ");
    putstr(mfbtxt + i * 18 + 9);
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                           ANALYSE(GETDAD)
.pa
*/
/*======================================================================*/
STATIC STATUS
getdad()
/*======================================================================*/

{

/* Get the Physical address for a drive					*/

LOCAL
WORD	mdv,		/* Local copy of 'maxdrv'			*/
	flag;

STATIC
BYTE	dlist[] = { "ABCDEFGHIJKL00000000" };

#ifndef	GM829

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

dlist[mdv = maxdrv] = NULL;				/* Zap the list	*/

while (TRUE) {
    if ((adl = reqdrv) == 0) {		/* Check command line option	*/
	move(10,20);
	putstr("Enter Drive [");
	putvid(dlist[mdv++] = (drvdat = hardware)->addr + '0');
	while ((++drvdat)->id[0] != NULL) {
	    putvid(',');
	    putvid(dlist[mdv++] = drvdat->addr + '0');
	}
	dlist[mdv] = NULL;
	putstr(" (or ");
	putvid('A' + fstdrv);
	putstr(" - ");
	putvid('A' - 1 + maxdrv);
	putstr(")] - ");
	clreos(-1,0);			/* Clear from where we are	*/
	adl = getltr(10,where() & 0xff,NULL,&dlist[fstdrv]);
    }
    if (adl >= '0' && adl <= '8') {
	strcpy(buffer,"DRIVE ");
	buffer[6] = adl;	
	buffer[7] = ' ';
	buffer[8] = NULL;				/* Delimiter	*/
	drvdat = hardware;
	while (drvdat->id[0] != 0) {
	    if (strcmp(buffer,drvdat->id) == MATCH) {/* Match found	*/
		drive = drvdat->addr;
		break;
	    }
	    ++drvdat;
	}
    }
    else {
	drive = ttl[(*(drvtab + (adl - 'A') * 16)) & 0x07];
	for (drvdat = hardware; drvdat->id[0] != 0; ++drvdat)
					if (drvdat->addr == drive)  break;
    }
    if (drvdat->id[0] == 0) {
	drive = -1;
	error("Can't locate drive");
    }
    else  break;
}

drive = tfl[drive];

settle = drvdat->settle;
stepr  = drvdat->stepr & 255;

return(SUCCESS);

}
	
/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*-----------------------------------------------------------------
 *	********* SETUP for the Multi-Format Bios *********
 *
 *	Version 3.0	02-07-84
 *
 *	Module: SETHW.C
 *
 *		Written by David Parkinson
 *		(c) dci software 1983, 1984, 1985
 *		(c) Timeclaim 1988
 *
 *	Module that holds the Hardware Configuration/details
 *	for an MFB system.
 *
 *	25/7/88 modified to use compiler command line to define drives
 *
 *      24/6/88 42 tracks introduced on 48 tpi drive
 *
 *	10/03/88 'drive->hdp' modified to use letter from 'A' ->
 *		 'A' = Must have format with no 'H' after Drive Type
 *                     and must have High clock rate
 *		 'B' = Can react to change of Line 2.  State determined
 *		       from presence or absence of 'H' after Drive Type.
 *		       Line 2 is low when rotational speed is High.
 *		 'C' = Must have format with no 'H' after Drive Type
 *		       and must have Low clock rate
 *		 'D' = Can react to change of line 2.  Line 2 must be high
 *		       when clock rate is high and low when clock rate is
 *		       low.  Must have no 'H' after Drive Type
 *		 '?' = New drive types may be added to the state table as
 *		       long as they are lettered consecutively.  An entry
 *		       in the table is made as follows:-
 *		-1  -  this combination of data rate and speed not supported
 *		 0  -  line 2 not used
 *	      0x08  -  line 2 set high
 *	      0x88  -  line 2 set low
 *		to correspond with each combination of data rate and setting
 *		of the H flag.  It may be necessary to alter the entry
 *		checking code table to allow new drive types.  No code has
 *		been added to invert the action of the clock rate setting
 *		which may be needed to support Sony 600 rpm drives.
 *		
 *		Code changes in 'fndfmt' in 'setfdp' - ICFO
 *
 *	***************************************************
 *
 *-----------------------------------------------------------------*/


int state[][4] = {

/*†Thiу† Tablе† specifieу thе settinз foт bitу ≥ anд Ј oж thе† Physicaм */Н
/*†Drivе Addresу whicи iу computeд iо variablе 'dІ belowЃ  Thе rowу arе */Н
/*†thе† settingу† froн† thе 'drive->hspІ entrщ† oж† thе† structureу† iо */Н
/*†'sethwІ† anд† thе columnу arе deduceд froн thе clocл ratе† 'Higи† oт */Н
/*†Low©† iо† thе formaф filе anд thе presencе oж aо 'HІ witи thе† Drivе */Н
/*†Typе (eз Drivе Typе 5» tп reaд higи coercivitщ 5.25Ґ discs)		*/

	  -1,         0,        -1,        -1,	/* 8" Drive	      A	*/

	0x08,        -1,        -1,      0x88,	/* 5.25" Dual Speed   B	*/

	   0,        -1,        -1,        -1,	/* 5.25" Single Speed C	*/
						/* 3.5" Single Density	*/
						/* 3"			*/

	0x88,      0x08,        -1,        -1	/* 3.5" Dual Density  D	*/

/*	Lo Clock   Hi Clock   Lo Clock   Hi Clock			*/
/*       No 'H'	    No 'H'      'H'        'H'				*/
	};


/*-----------------------------------------------------------------
 *	List of all drives + data on the system.
 *	18 bytes per entry
 *-----------------------------------------------------------------*/
#asm
	.z80
FIVE	equ	0
EIGHT	equ	1
THREEHALF equ	2
THREE	equ	3
FIVEH	equ	4

hardware::		

#ifdef D5DS
/*	*********************************************************/
/*	*********   5.25" Dual Speed Drive  Teac FD55GF  ********/
/*	*********************************************************/

	db	'DRIVE 0 ',0    /* Must be 8 bytes total + NULL */
	db	0		/* Drive physical address	*/
	db	FIVEH		/* Drive type	(msb set if HS opt) */
	db	96		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'B'		/* Hi speed opt */
#endif

#ifdef D548
/*	*********************************************************/
/*	*********   5.25" 48tpi             Teac FD55B   ********/
/*	*********************************************************/

	db	'DRIVE 1 ',0    /* Must be 8 bytes total + NULL */
	db	1		/* Drive physical address	*/
	db	FIVE		/* Drive type			*/
	db	48		/* TPI	   */
	db	42		/* Tracks note extra tracks */√?                                                                                                                                                                                ЌK0Ќ§! 9Ќw>е! 9Ќw>еЌvЅЅ!  е! еЌп0ЅЅ!ўеЌ0Ѕ!  е! еЌп0ЅЅ!уеЌ0Ѕ! е!  еЌп0ЅЅ! еЌЂ8Ѕ"tЌ~ЌЏ= l! е!  еЌa0ЅЅЌЙ
Ќа0*	|µ l* @еЌ™BЅ*	е*еЌЫ:ЅЅЌ‘1!#	е*	е*еЌ№1ЅЅЅЌљ?…      ! 9Ќw>+"p! 9Ќw>##"t!  }2*p|µ r*tЌw>Ќq>”€|µ µ*t##"t++Ќw>Ќq>& еЌО=Ѕ}2*p+"p!€€}2q:Ќr>0 Ќу= т:Ќr>8 Ќт=ЌЊ= a!е!>	еЌl=ЅЅ:Ќr>}2!  }2!  }2!a/"*Ќq>|µ ^!е*еЌO=ЅЅ|µ¬Q*	 Ќq>}2q√^* "√#√У:Ќr>њ€л*МЌт= Ж:Ќr>њ€л*ОЌ>ЌЊ= У!  }2q:qЌr>#|µ¬µЌ‘1!E	е:Ќr>еЌ№1ЅЅЌљ?*p+"p#|µ r*t##"t++Ќw>"r*rЌq>”€|µ фЌ‘1!e	е*rеЌ№1ЅЅЌљ?*r#"r*rЌq>& }ж_o√_! }2√o*r#"r"	*p|µ @*t##"t++Ќw>"*p+"p√F!т"√oЌ‘1!	е*rеЌ№1ЅЅЌљ?√oЌД>
A E   √I√µ…! е! еЌп0ЅЅ!Ф	еЌ0ЅЌМ…Ќа0! е!  еЌп0ЅЅЌљ?…    е>чнyнx∆а!љ?8*  ЌќнCґ* 7 ~2Љй*ґе!ґ	еЌO=ЅЅ|µ зЌsЌМ*ґ "†"Ґ*Ґ#"Ґ*†##"†Ќw>"Ї*†
 "†*†Ќw>"Є*ҐЌq>"О!  "М*М))))л*ЇЌq>& }жoЌЏ= P*Ол*МЌ>ЌЊ= `*М#"М√+*Ое*МЌ_> Ќ> }*М "О…:Ќr>|µ¬МЌЦЌЭ…      ! е!  еЌa0ЅЅ*М"Р*Ол*РЌ> Г√√*Р#"Р√©! е*Ре*МЌ_> ЌЮ>еЌп0ЅЅ!  еЌТ1Ѕ*РA еЌТ1Ѕ!Ї	еЌ0Ѕ*Р ЌЮ>л*ЄеЌ0Ѕ*Р))))л*ЇЌq>& }жo"Т! е*Ре*МЌ_> ЌЮ>еЌп0ЅЅ!( еЌТ1Ѕ*Т& }жoЃЌq>"Ф*ФеЌй<Ѕ!Њ	еЌ0Ѕ*Р ЌЮ>л*Є	 еЌ0Ѕ√є…    ABCDEFGHIJKL00000000 *О"ДИ6 ! |µ ®:Ќr>"РЌЏ= Ґ!
 е! еЌп0ЅЅ!¬	еЌ0Ѕ*Д#"Д+Ие!a/"	 Ќq>0 —}еЌТ1Ѕ* "Ќq>ЌЊ= <!, еЌТ1Ѕ*Д#"Д+Ие*	 Ќq>0 —}еЌТ1Ѕ√ы*ДИ6 !–	еЌ0Ѕ*МA еЌТ1Ѕ!÷	еЌ0Ѕ*О@ еЌТ1Ѕ!Џ	еЌ0Ѕ!€€е!  еЌa0ЅЅ!
 еЌб/& е!  е*МИеЌg-ЅЅЅЅ"Р*Р0 Ќу= Ј*Р8 Ќт=ЌЊ= #!е!>	еЌl=ЅЅ*Р}2!  }2!  }2!a/"*Ќq>|µ  !е*еЌO=ЅЅ|µ¬*	 Ќq>}2q√ * "√е√Е*Рњ€))))л*ЇЌq>& }жoЃЌq>}2q!a/"*Ќq>|µ Е√h* "√M*	 Ќq>е:qЌr>Ќ∆= В√Е√[*Ќq>|µ¬Ґ!€€}2q!а	еЌ√)Ѕ√•√®√©:qЌr>¶Ќq>}2q* Ќq>"њ* Ќq>& "љ!  …Analyse version 2.43x     (c) dci software 1986 & Timeclaim Ltd 1988,1989 Command <%s %s> not found
 DRIVE  Drive %c is not on this system
 Unrecognised argument >%s Unknown argument >%s **** Not a Gemini MFB system **** MFB  =  )   Enter Drive [  (or   -  )] -  Can't locate drive                                                                                                                                                       ! е!  еЌa0ЅЅ:Ќr>|µ І
Ќa√ы
! е! еЌп0ЅЅ!беЌ0Ѕ*еЌ0Ѕ!щеЌi+Ѕ! |µ ы
Ќь
"у	ЌЏ= ж
Ќ√ш
*у	+|µ¬х
Ќa√ш
√ы
√ћ
…! е! еЌп0ЅЅ!еЌ0Ѕ! |µ \Ќ>1еЌО=Ѕ√HЌK0!€€"х	√\! "х	√\ЌK0!  "х	√\√YЌД>$X 0A 9M   √*х	……:qЌr>"ч	ЌK0*ч	еЌ§Ѕ|µ {…ЌЌЇЌЌЯ|µ Н…Ќ‘1!.е*ЮеЌ№1ЅЅЌ≠Ќ‘"…! 9Ќw>& }ж'o}2q!EеЌ0ЅЌ*"!  }2v!
 }2wЌр!:qЌr>& }жo"ы	!  "щ	*щ	ьЌ>ЏЎ√€*щ	#"щ	√ж*ы	}2q* Ќq>њ€)))A/е*щ	)—Ќw>#|µ ’* Ќq>њ€)))A/е*щ	)—Ќw>& }жАoе:qЌr>Ќ†=}2q*щ	& }жo)))))е:qЌr>Ќ†=}2q!  "э	*э	шЌ>Џ«√Щ*э	#"э	√А*щ	0 еЌТ1ЅЌЫ!:yЌr>|µ¬ґ√«:qЌr>}оo}2q√П:yЌr>|µ¬’√Ў√х:yЌr>|µ¬п! еЌТ1ЅЌП0! "щ	*щ	ьЌ>Џs* Ќq>њ€)))A/е*щ	#"щ	+)—Ќw>"э	#ЌЊ= :*э	& }жoЌЊ=ЌЊ= pЌ‘1!VеЌ№1ЅЌ‘1:qЌr>& }жАo|µ e!m√h!rеЌ№1Ѕ√s√фЌ‘1!yеЌ№1ЅЌ‘1:qЌr>& }ж oЌЊ= Щ!m√Ь!КеЌ№1Ѕ:qЌr>& }жoЌЊ= √!S }2s!О"√–!D }2s!Х"Ќ‘1!Ье*еЌ№1ЅЅ*t###Ќq>"А√Ќ‘1!≥еЌ№1ЅЌ‘1!ўеЌ№1ЅЌ‘1!щеЌ№1Ѕ:yЌr>…*t"*Ќq>& }2w* Ќq>& "†:wЌr>√g√{*†)"†√{*†л! ЌE>"†√{!  "†√{ЌД>A
 D N   √^*†|µ¬©Ќ‘1!&еЌ№1ЅЌ‘1!Qе!
 е:wЌr>еЌ№1ЅЅЅ√єЌ‘1!lе*†еЌ№1ЅЅ…! "Ц"
ЌЫ!*t#"*Ќq>& "€	* Ќq>++|µ¬+! }2vЌЫ!:yЌr>|µ Ќ‘1!~еЌ№1Ѕ√(Ќ‘1!ЦеЌ№1Ѕ! "Ц*Ќq>& "
√AЌ‘1!ЃеЌ№1ЅЌ‘1!ќеЌ№1Ѕ!  }2v*€	ЌЊ=¬X*
+ЌЊ=ЌЊ= ЮЌ‘1!оеЌ№1ЅЌ‘1!е*€	еЌ№1ЅЅ*Ц++|µ¬УЌ‘1!.е*
еЌ№1ЅЅЌ‘1!CеЌ№1Ѕ…*t##"Ќк!!  }2v*Цл:vЌr>Ќ> *√“:vЌr>#}2v√±! "
!  "
!  "	
"
*
 Ќ>¬ь*	
 Ќ>ЌЊ= {ЌК!:yЌr>|µ √{*Ќq>& "В*
е*ВЌ∆= 2*
#"
*
е*ВЌ∆= F*	
#"	
*
л*ВЌ> _*В"
!  "
*
л*ВЌ> x*В"
!  "	
√з:yЌr>|µ СЌ‘1!@еЌ№1Ѕ:vЌr>|µ¬®*
"Т*
"Ф*
}2xЌ8"Ю:yЌr>|µ¬Ќ‘1!Fе:vЌr>еЌ№1ЅЅЌ‘1!Rе*
еЌ№1ЅЅЌ‘1!hе*
еЌ№1ЅЅЌ‘1!~е*
е*
Ќ_>#еЌ№1ЅЅ√'Ќ‘1!МеЌ№1ЅЌ‘1!µеЌ№1ЅЌy√ƒ!  }2v:yЌr>…!  "
ЌЯ!"
*
#"
+а€|µ¬X√c:yЌr>|µ¬>:yЌr>ЌЊ= u!  √x*
…Ќ‘1!…е:qЌr>& }жoе:wЌr>е:xЌr>е:yЌr>& еЌ№1ЅЅЅЅЅ…*Фе*ТЌ_>#"
*t##"Ќк!!  }2v!  "
*
ыЌ>ЏЦ√м*
#"
√”!  "
*
юЌ>ЏГ√*
#"
√тЌ‘!!  "Ж*
л*ЖЌ> А√.*Ж#"Ж√ЌЫ!:yЌr>|µ ?√А*Ќq>& "В*
+|µ¬n*Ж)
Ќw>е*ВЌд= k√А√}*Ж)
е*ВЌ|>√$√*
л*ЖЌу= У√Ц√в*
ыЌ>“∞Ќ‘1!еЌ№1Ѕ√Ќ‘1!2еЌ№1Ѕ!  "Ж*
л*ЖЌ> ц√џ*Ж#"Ж√ЅЌ‘1![е*Ж)
Ќw>еЌ№1ЅЅ√—Ќ‘1!CеЌ№1Ѕ…:wЌr>"Е
* Ќq>е*†)Ќ∆="З
Ќ*"* Ќq>& +}2w*З
|µ G:wЌr>+}2wЌр!:wЌr>|µ °Ќр!ЌЫ!:yЌr>ЌЏ= w*t###Ќq>е*АЌ∆=ЌЊ= А√°:wЌr>+}2w*З
|µ Ю:wЌr>+}2w√J:wЌr>"Ґ*t"*Ќq>& }2w* Ќq>–€ЌЏ= Џ*††€ЌЏ=ЌЊ= н:wЌr>≤€ЌЏ=ЌЊ= ю:wЌr>#}2w:wЌr>#}2w! еЌТ1ЅЌП0Ќ‘1!aе:wЌr>еЌ№1ЅЅ*Ц++|µ¬ћ*tЌq>"В! }2vЌЫ!:yЌr>ЌЊ=¬]*tЌq>е*ВЌд=ЌЊ=¬s*t###Ќq>е*АЌд=ЌЊ= ћЌ‘1!wеЌ№1ЅЌ‘1!™е*Ве*tЌq>еЌ№1ЅЅЅЌ‘1!‘е!А л*АЌX>е*t###Ќq>л!А лЌX>еЌ№1ЅЅЅ! "ЦЌ*"!
 }2wЌр!*Е
}2w…Please put the disc in   and sh
	db	2		/* Sides   */
	db	6		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt NO */
#endif

#ifdef D8
/*	*********************************************************/
/*	*********   8" DSDD           Mitsubishi M2896   ********/
/*	*********************************************************/

	db	'DRIVE 4 ',0    /* Must be 8 bytes total + NULL */
	db	4		/* Drive physical address	*/
	db	EIGHT		/* Drive type			*/
	db	48		/* TPI	   */
	db	77		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	50		/* Head load */
	db	18		/* Settle    */
	db	'A'		/* Hi speed opt */
#endif

#ifdef D3100
/*	*********************************************************/
/*	*********   3" SSDD           Hitachi HFD 305S   ********/
/*	*********************************************************/

	db	'DRIVE 5 ',0    /* Must be 8 bytes total + NULL */
	db	5		/* Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	100		/* TPI	   */
	db	40		/* Tracks  */
	db	1		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif

#ifdef D31006		/* IAN'S MACHINE ONLY			*/
/*	*********************************************************/
/*	*********   3" SSDD           Hitachi HFD 305S   ********/
/*	*********************************************************/

	db	'DRIVE 6*',0    /* Must be 8 bytes total + NULL */
	db	6		/* Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	100		/* TPI	   */
	db	40		/* Tracks  */
	db	1		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif

/*	*********************************************************/
/*	*********   3.5" DSDD              Teac FD35F    ********/
/*	***************************** or   Teac FD135HFN ********/
/*	*********************************************************/

#ifdef D356
	db	'DRIVE 6 ',0    /* Must be 8 bytes total + NULL */
	db	6		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Single Data Rate */
#endif

#ifdef D35H6
	db	'DRIVE 6 ',0    /* Must be 8 bytes total + NULL */
	db	6		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	44h		/* 'D' Dual data rate */
#endif

#ifdef D352
	db	'DRIVE 2 ',0    /* Must be 8 bytes total + NULL */
	db	2		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Single Data Rate */
#endif

#ifdef D35H2
	db	'DRIVE 2 ',0    /* Must be 8 bytes total + NULL */
	db	2		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	44h		/* 'D' Dual data rate */
#endif


/*	*********************************************************/
/*	*********  3" DSDD 200tpi National Panasonic EME 231 ****/
/*	*********************************************************/

#ifdef D32002
	db	'DRIVE 2 ',0    /* Must be 8 bytes total + NULL */
	db	2		/* Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	200		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	12		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif

#ifdef D32006
	db	'DRIVE 6 ',0    /* Must be 8 bytes total + NULL */
	db	6		/* Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	200		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	12		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif

	db	0		/* Table terminator */
	.8080
#endasm

/*-----------------------------------------------------------
 *		e n d	o f   S E T H W
 *-----------------------------------------------------------*/
 Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	200		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	12		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif

	db	0		/* Table ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееut the door Press 'A' to Analyse, 'X' to eXit 		%d bytes per sector
                  		Rotational Speed is  High Normal 
		Data Rate is  Low single double 
		Disc density is %s
 

		Unable to determine the density.
 
		The disc may be incompletely 
		formatted or incompatible with this drive 		*** WARNING Unable to determine TPI ***
 %dth track is numbered %d
 		Disc tpi is %d
 		Disc is single sided
 		Disc is double sided
 		Unable to examine second side  because drive is single-sided
 		*** WARNING Non standard side field(s) ***
		 %02xH on side 0 , %02xH on side 1 help! 		Side %d,  lowest sector = %2d,  highest sector = %2d  [%d sectors]
 		*** WARNING Unable to determine sector 		 information ***
 		Drive  = %02xH, Track  = %d, Sector = %d, Status = %02xH
 		Unable to reliably determine sector order
 		Physical sector order on side 0 is:
		 %2d   		Disc has %d tracks
 		*** WARNING Side 2 incompatible with Side 1 ***
 		  Side 1 track = %d, Side 2 track = %d
 		  Side 1 sector size = %d, Side 2 sector size = %d
                   !  }2w}2v"* Ќq>& "†ЌK0!  }2r* Ќq>њ€)))A/е:rЌr>)—Ќw>"В#ЌЏ= }:rЌr>#}2r√C:qЌr>& }ж_o}2q:rЌr>& }жo)))))е:qЌr>Ќ†=}2q*В& }жАoе:qЌr>Ќ†=}2q!  е! е!÷ еЌ∞.ЅЅЅ!  "~! "В*ВьЌ>ЏK* Ќq>њ€)))A/е*В#"В+)—Ќw>"Д#ЌЊ= '*Д& }жoЌЊ=ЌЊ= H!  е!> е!!еЌ∞.ЅЅЅ! "~√K√бЌ*"Ќ£!"И!  "К! |µ щЌ	ЌъЌ>1еЌО=Ѕ& √СЌ£!"И√ :qЌr>}оo}2qЌ£!"И√ :vЌr>}оo}2vЌ£!"И√ ! е! е:wЌr>еЌР+ЅЅЅ"К  Ќ> в:Ќr>|µ я!  }2w√* Ќq>& л*КЌу= * Ќq>& +}2w√*К}2wЌр!Ќ£!"И!  "К√ *}оo"√ ! |µ З:rЌr>#}2rь€|µ¬U!  }2r* Ќq>њ€)))A/е:rЌr>)—Ќw>"В#ЌЊ= Д√З√2:qЌr>& }ж_o}2q:rЌr>& }жo)))))е:qЌr>Ќ†=}2q*В& }жАoе:qЌr>Ќ†=}2qЌ£!"И! е!  еЌп0ЅЅ!!еЌ0Ѕ! еЌR*ЅЌ£!"И! е!  еЌa0ЅЅ√ …*Ка€"К√ *Каю"К√ *К  "К√ *К "К√ :wЌr>|µ Z!€€еЌљ ЅЌ£!"И!  "К√ * Ќq>& #л:wЌr>Ќ> Л! еЌљ ЅЌ£!"И!  "К√ √ ЌД>uR ~D ХS ђT %A 2W  Г З !Д .И ;Б ]В   *К АЌ>Џя!  "К√ц*Ил*КЌ> ц*И}жрo"К√Z…Ќ1|µ √ъ√ъ…! е! еЌп0ЅЅ:qЌr>& }жoЌЊ= .!/!√1!6!еЌ0Ѕ! е! еЌп0ЅЅ*†еЌй<Ѕ! е! еЌп0ЅЅ:wЌr>еЌй<ЅЌб/& "*#"+џЌ>ЏЗ!  еЌТ1Ѕ√k:vЌr>ЌЊ= Щ!1 √Ь!0 еЌТ1Ѕ! е!, еЌп0ЅЅ*ЌЊ= љ!=!√ј!A!еЌ0Ѕ! е!4 е:qЌr>& }ж oЌЊ= е!E!√и!J!еЌ∞.ЅЅЅ*~|µ !! е!@ е:qЌr>& }жАoЌЊ= !E!√!J!еЌ∞.ЅЅЅЌ%…! еЌђ/Ѕ*tл*К+"*К"Ж!  ":qЌr>& }жo|µ \!  √_!°€"! "В*В|µ K √}*В+"В√h*Ил*ЖЌ> Н√K *ЖеЌК Ѕ!  еЌТ1Ѕ! "Д*Д|µ +√Є*Д+"Д√£*Ќq>"*#"Ќq>"√*е*Ќ∆= с! "
* Ќq>"√ *е*Ќ∆= ! "
! "√ √ ЌД>—ю€фы€  *еЌY Ѕ√Ѓ*р€"!O!еЌ0Ѕ! "Д*Д|µ Э√X*Д+"Д√C*#"Ќq>& }жo"*  Ќ>¬Б*Б€ЌЏ=ЌЊ= Т!. еЌТ1Ѕ√Ъ*еЌТ1Ѕ√N!R!еЌ0Ѕ*Ж "Ж*|µ Ї*ЌЊ= …*В Ќ>ЌЊ= Ў* Ќ>ЌЊ= H !  "!T!еЌ0ЅЌП0!R!еЌ0Ѕ! "Д*|µ  √ *+"*Д)"Д√э√ √ *Д++))))"Д*л*Д"*Жл*Д"Ж*В+"В√s!€€е!  еЌa0ЅЅ…*
|µ } ЌШ0! 9Ќw>еЌК(ЅЌ°0*
+"
√Й ! 9Ќw>еЌК(Ѕ…! 9Ќw>л! ЌE>еЌ≤(Ѕ! 9Ќw>л! ЌE>еЌ≤(Ѕ! 9Ќw>еЌК(Ѕ…:wЌr>л! 9Ќw>}2wеЌр!Ѕ…Density    TPI      Track   Side    Abbr   Data Rate Rot. Speed Please wait a moment ... Single Double ON  OFF High  Low    
 .....................................................  ≈јЌ•!Ѕ:yЈ»т…јИаЌn"*tе—:x”в:x”вy”адџгw#н@(ьъЊ!џажя2yЈнR…Ќn"џб”г>ЌЂ"џажВ(ъo& …:w”б…Ќn":qц ”д:wWџбТ»x0нDXGyЌЂ":љ÷‘^"т:њЌ^":q”дџа2y…Ќn":qц ”дџб”г>>xЌЂ":љ÷‘^"џаж(нѓ”б:q”д:њЌ^"…Ј»≈G:Љгг= ыцЅ…:vЈ:q(цжч”д   џажА»џб”г>ЌЂ"е!–џажА(>Ќ^"+|µ р>АбЈ…>–”а:Љ÷L>
8>= эџаЋG ъ…                  !  "Ж*t"|ЌF$*t":sЌr>≠€ЌЏ= €"!< √#!x "Д!  "В*Дл*ВЌ> ¶#√%#*В#"В√#*#"+Ќq> |µ¬£#:sЌr>≠€|µ¬{#*Ќq>#ЌЏ=¬^#*Ќq>ЌЏ=ЌЊ= o#*++Ќq>ЌЏ=ЌЊ= x#√¶#√£#*Ќq>≤€ЌЏ= Ъ#*++Ќq>> ЌЏ=ЌЊ= £#√¶#√#*Ж#"Ж*Ж Ќ> √#*Де*ВЌ∆=ЌЊ=¬а"*Дл*ВЌ> я#!ч("ƒ"√2$*t":Ќr>|µ щ#!€("ƒ"√2$!)еЌ'Ѕ"В*ВЌЊ= $!ч(√$!)"ƒ"*В+"Вл*"*#"+6ьЌ‘1!-)е*ƒ"еЌ№1ЅЅЌЧ$…Ќ*"*Ґь€}2w* Ќq>& е*†Ќд= z$:wЌr>& ь€}2wЌр!ЌЫ!*t"*Ќq>}2wЌ£!"И…*"|! |µ !&Ќ‘1!>)еЌ№1ЅЌб/"∆"!x еЌ"&Ѕ+"Ш*ШЭ€ЌЏ= Ў$:Ќr>ЌЊ=ЌЊ= м$Ќ‘1!N)еЌ№1Ѕ√!&*∆"еЌђ/ЅЌ‘1!X)е*ШеЌ№1ЅЅ*|л*Ш#"z*z ""|Ќб/"∆"! "В*ВЬЌ>Џ\%√B%*В#"В√)%*#"+Ќq> |µ¬Y%√\%√8%*ВЬ€|µ¬П%:Ќr>|µ Д%Ќ‘1!P)еЌ№1Ѕ√!&√П%![)еЌ'Ѕ"В*В+"Ъ*∆"еЌђ/ЅЌ‘1!)е*ЪеЌ№1ЅЅ*|л*Ъл*Ю###"*"|Ќб/"∆"!Ц еЌ"&Ѕ+"Ь*∆"еЌђ/Ѕ*Ьk€ЌЏ= ч%:Ќr>ЌЊ=ЌЊ= &Ќ‘1!S)еЌ№1Ѕ√&Ќ‘1!Д)е*ЬеЌ№1ЅЅ√!&√Э$…*" "! "»"! 9Ќw>л*»"Ќ> {&√L&*»"#"»"√.&*#"+Ќq>##ЌЏ= o&*Ќq>е:wЌr>Ќ∆=ЌЊ= x&√{&√B&! 9Ќw>е*»"Ќ∆= Х&:Ќr>ЌЏ=ЌЊ= ’&!К)еЌ'Ѕ"»"*»"|µ ќ&* "л*»"+6ю* "л*»"е:wЌr>—}√’&*»"#"»"*»"…Enter offset from start (00 or <Return> if absent): Ќб/л! Ќњ>"ќ"*|еЌТ'Ѕ! е!  еЌп0ЅЅ! 9Ќw>еЌ0Ѕ!ђ)еЌ0Ѕ!ў&еЌ0Ѕ! е!ў&еЌ|=Ѕ#е!  еЌР+ЅЅЅ"ћ"#ЌЏ= s'!  "ћ"*ќ"#е!  еЌa0ЅЅ*ќ"е!  еЌп0ЅЅ*ћ"…ЌЗ+ЌШ0!ѓ)еЌ0Ѕ! "–"*–"жЌ>Џ“'√њ'*–"#"–"√¶'!  еЌТ1Ѕ*–"еЌe(Ѕ√µ'Ќ°0ЌЗ+!  "–"*–"ъЌ>Џd(√ч'*–"#"–"√ё'ЌШ0*–"ьЌ>Џ(!  еЌТ1Ѕ*–" ЌЮ>еЌe(ЅЌ°0!  еЌТ1Ѕ!  "“"*“"зЌ>Џ^(√F(*“"#"“"√-(! 9еЌw>#Ќ|>+Ќq>еЌК(Ѕ√<(ЌЗ+√н'…! 9Ќw>цЌ>Џ}(!0 еЌТ1Ѕ! 9Ќw>еЌй<Ѕ…! 9Ќq>л! ЌE>еЌ≤(Ѕ! 9Ќq>еЌ≤(Ѕ!  еЌТ1Ѕ…! 9е! 9Ќq>& }жo—}! 9Ќq>цЌ>“ж(! 9еЌq> —}! 9Ќq>0 еЌТ1Ѕ…present pееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*-----------------------------------------------------------------
 *	********* SETUP for the Multi-Format Bios *********
 *
 *	Version 3.0	02-07-84
 *
 *	Module: SETHW.C
 *
 *		Written by David Parkinson
 *		(c) dci software 1983, 1984, 1985
 *		(c) Timeclaim 1988
 *
 *	Module that holds the Hardware Configuration/details
 *	for an MFB system.
 *
 *	25/7/88 modified to use compiler command line to define drives
 *
 *      24/6/88 42 tracks introduced on 48 tpi drive
 *
 *	10/03/88 'drive->hdp' modified to use letter from 'A' ->
 *		 'A' = Must have format with no 'H' after Drive Type
 *                     and must have High clock rate
 *		 'B' = Can react to change of Line 2.  State determined
 *		       from presence or absence of 'H' after Drive Type.
 *		       Line 2 is low when rotational speed is High.
 *		 'C' = Must have format with no 'H' after Drive Type
 *		       and must have Low clock rate
 *		 'D' = Can react to change of line 2.  Line 2 must be high
 *		       when clock rate is high and low when clock rate is
 *		       low.  Must have no 'H' after Drive Type
 *		 '?' = New drive types may be added to the state table as
 *		       long as they are lettered consecutively.  An entry
 *		       in the table is made as follows:-
 *		-1  -  this combination of data rate and speed not supported
 *		 0  -  line 2 not used
 *	      0x08  -  line 2 set high
 *	      0x88  -  line 2 set low
 *		to correspond with each combination of data rate and setting
 *		of the H flag.  It may be necessary to alter the entry
 *		checking code table to allow new drive types.  No code has
 *		been added to invert the action of the clock rate setting
 *		which may be needed to support Sony 600 rpm drives.
 *		
 *		Code changes in 'fndfmt' in 'setfdp' - ICFO
 *
 *	***************************************************
 *
 *-----------------------------------------------------------------*/


int state[][4] = {

/*†Thiу† Tablе† specifieу thе settinз foт bitу ≥ anд Ј oж thе†robably absent Can't see the Index mark (FC) 		Index mark %s
 		Gaps 1/2/3 =  **/**/**
 %d Can't find start of data block (FB) /%2d /%2d
 Can't find the sector header (FE) .
                     ЌШ0Ќ≥0!  "≥)*≥)ьЌ>Џ>*√и)*≥)#"≥)√ѕ)! е!  еЌa0ЅЅ! е! еЌп0ЅЅ!  еЌТ1Ѕ! 9Ќw>еЌ0Ѕ!  еЌТ1Ѕ! еЌR*Ѕ! е!  еЌa0ЅЅ! еЌR*Ѕ√ё)Ќ°0Ќ™0! е!  еЌa0ЅЅ…! 9еЌw>+Ќ|>#|µ М*!  "Ј)*Ј)ј`Ќ>ЏЙ*√Г**Ј)#"Ј)√j*√y*√y*√R*…!  "є)! 9Ќw>л*є)Ќ> »*! 9еЌw>#Ќ|>+е! 9еЌw>#Ќ|>+Ќq>—}ЌЊ=ЌЊ= Ў**є)#"є)√У*! 9еЌw>++Ќ|>*є)+"є)#  Ќ> +! 9Ќw>Ќq>а€ЌЏ=ЌЊ= +! 9еЌw>+Ќ|>#√е*! 9еЌw>#Ќ|>6 …! 9Ќw>|µ h+! 9еЌw>#Ќ|>+е! 9еЌw>#Ќ|>+Ќq>—}! 9еЌw>+Ќ|>√,+…! 9Ќw>еЌ0Ѕ!
 еЌТ1Ѕ…! еЌТ1Ѕ…!&/еЌ0Ѕ…! 9Ќw>е!]еЌ3<ЅЅ! 9Ќw>е! 9Ќw>е!]еЌ,,ЅЅЅ#ЌЏ= ∆+!€€…!еЌ:Ѕ"ї)*ї)е!еЌ3<ЅЅ! 9Ќw>е! 9Ќw>еЌп0ЅЅ!еЌ0Ѕ*ї)…! 9Ќq>0 Ќу= ,! 9Ќq>9 Ќт=ЌЊ= (,! √+,!  …! 9Ќw>е! 9Ќw>еЌп0ЅЅЌЛ,#|µ¬N,!€€…:Ќr>|µ¬j,!е! 9Ќw>еЌl=ЅЅ! 9Ќw>е! 9Ќw>еЌп0ЅЅ!еЌ0Ѕ!  …!е!P еЌ©7ЅЅЌЊ= §,!€€√Ѓ,!еЌѓ,Ѕ& …! 9Ќw>Ќq>а€|µ¬’,! 9еЌw>#Ќ|>+Ќq>√ѓ,! 9Ќw>Ќq>еЌе,Ѕ…! 9Ќq>A Ќу= -! 9Ќq>Z Ќт=ЌЊ= -! 9Ќq>  √-! 9Ќq>…! 9Ќq>a Ќу= ;-! 9Ќq>z Ќт=ЌЊ= O-! 9Ќq>а€√V-! 9Ќq>…—Ѕбе≈’6 #x± ш……! 9Ќq>}2Ѕ)!  }2¬)! |µ f.! 9Ќw>е! 9Ќw>е!Ѕ)еЌ,,ЅЅЅ#ЌЏ= ¶-!€€…! 9Ќw>"љ)! 9е:Ќr>еЌ-Ѕ—}*љ)Ќq>ЌЊ= а-*љ)Ќq>е! 9Ќq>Ќд=ЌЊ= с-*љ)#"љ)+√√-*љ)Ќq>|µ €-√f.!е!(/еЌl=ЅЅ!"љ)! 9Ќw>"њ)*њ)Ќq>|µ V.*љ)#"љ)+е*њ)#"њ)+Ќq>—}*њ)Ќq>|µ S.*љ)#"љ)+6/√.*љ)6 !еЌ√)Ѕ√y-*љ)Ќq>…! 9Ќw>Ќq>а€ЌЏ=¬Т.! 9Ќw>Ќq>‘€ЌЏ=ЌЊ= ®.! 9еЌw>#Ќ|>+√m.! 9Ќw>…! 9Ќw>е! 9Ќw>еЌп0ЅЅ! 9Ќw>еЌ0Ѕ!9/еЌ0Ѕ…! 9Ќw>е! 9Ќw>еЌп0ЅЅ! 9Ќq>еЌТ1Ѕ…! 9Ќw>е! 9Ќw>еЌп0ЅЅ! 9Ќw>еЌй<Ѕ!:/еЌ0Ѕ…
 Entry should be          €€  €€€€ €€€€И   €€€€€€И  €€€€DRIVE 0   `P BDRIVE 1   0* CDRIVE 4  0M2ADRIVE 6  ЗP C   !Џ/еЌ0Ѕ! 9Ќw>  "™/*™/л! ЌE>еЌТ1Ѕ*™/еЌТ1Ѕ…=     !0еЌ0ЅЌЗ1 ЌЮ>"Ё/ЌЗ1е*я/Ќ_>л*Ё/"Ё/ЌЗ1*Ё/…? —бе’~Ј»ю
  Ќ)0_Ќ)0#мех’ЌТ1—сб……  БВГДЕЖЗИЙ *40е!  еЌп0ЅЅ!Я1еЌ0Ѕ…! 9Ќw> АЌ>“Ж0! 9Ќw>е! 9Ќw>еЌп0ЅЅ!Я1еЌ0Ѕ…!Ґ1еЌ0Ѕ…!•1еЌ0Ѕ…!®1еЌ0Ѕ…!Ђ1еЌ0Ѕ…!ѓ1еЌ0Ѕ…! 9Ќw>е!  еЌп0ЅЅ!≥1еЌ0Ѕ! 9Ќw>"40…!ґ1еЌ0Ѕ!  "40…џ≤8ы>”±џ≤8ы>=”±џ≤8ыб;Ѕс∆ ”±џ≤8ыx∆ ”±!ы€9щ…!є1еЌ0ЅЌЗ1|µ 51Ќ>1…√91!  ……    Ќ{1":1!50"<1*<1#"<1~Ј w1*<1#"<1+Ќq>е*:1Ќ∆= t1*<1Ќq>& …√J1*:1…!Љ1еЌ0ЅЌЗ1…џ≤8ыџ±o& …! 9џ≤8ы~”±…% * A N E  D  M O k K     Ґ7               ! 9"њ1…*њ1++"њ1Ќw>еЌT2Ѕ! 9л*њ1Ќ8> 2*њ1еЌ(3Ѕ√м1…*њ1++"њ1Ќw>"Ѕ1*Ѕ1е*њ1++"њ1Ќw>еЌf2ЅЅ√м1…*њ1++"њ1Ќw>"≈1*≈1е*њ1++"њ1Ќw>еЌ~2ЅЅ√м1…!  е! 9Ќw>еЌf2ЅЅ…! 9Ќw>"Ѕ1! 9Ќw>"√1ЌЪ2…! 9Ќw>"≈1!ю€е! 9Ќw>еЌf2ЅЅ…*√1Ќq>ЌЊ= ≥2*√1Ќq>џ€ЌЊ=ЌЊ= ћ2*√1#"√1+Ќq>еЌЌ2Ѕ√Ъ2…*Ѕ1√3! 9Ќq>еЌ€@Ѕ…*≈1#"≈1+е! 9Ќq>—}*≈16 …! 9Ќq>е*Ѕ1еЌЅCЅЅ√3ЌД>”2  а2ю€  √щ2…          ! 9е*њ1Ќ|>*њ1++"њ1!  "…1"3!€€" 3*√1#"√1Ќq>"Ћ1ЌЏ= ^3…!  }2Ќ1*Ћ1”€ЌЏ="ќ1|µ Е3*√1#"√1+Ќq>"Ћ1*Ћ1–€|µ¬¶3!0 }2Ќ1*√1#"√1+Ќq>"Ћ1Ќ5"«1*Ћ1“€|µ¬»3*√1#"√1Ќ5"…1" 3*√1#"√1+Ќq>"Ћ1Н€ЌЊ= й3*…1 Ќ>ЌЊ= х3! "…1*Ћ1√и4! 9еЌw>++Ќ|>"$3*$3е*$3#еЌз6ЅЅ√5! 9еЌw>++Ќ|>Ќw>е!
 еЌ6ЅЅ√5! "3√Q4!
 "3√Q4! "3! 9еЌw>++Ќ|>Ќw>""3*"3е*3еЌ®6ЅЅ√5! 9еЌw>++Ќ|>Ќw>"$3"&3*&3#"&3+~Ј Ъ4√К4*&3+"&3е*$3Ќ_>л*…1Ќ> µ4*…1ЌЊ= ∆4*$3л*…1"&3*$3е*&3еЌз6ЅЅ√5…*Ћ1еЌЌ2ЅЌЪ2√;3√5ЌД>ы3c 4d 94o B4u K4x t4s ÷4    √„4ЌЪ2…  *5е!  "5*√1Ќq>"Ћ10 Ќу= 75*Ћ19 Ќт=ЌЊ= ^5*5
 ЌЮ>е*√1#"√1+Ќq>—–€"5√5*5лб"5л…    ! 9Ќw>"h5! 9Ќw>"j5! 9еЌw>+Ќ|>е*h5ц€ЌЏ= ®5*j5л!
 ЌЇ>л√≥5*h5+е*j5Ќі=еЌ7Ѕ—}*h5ш€ЌЏ= ’5*j5л! ЌS>√щ5*h5ц€ЌЏ= п5*j5л!
 ЌЇ>√щ5*j5л! ЌS>"j5*j5|µ¬А5! 9Ќw>…  !∞€9щ!T 9Ќw>  Ќ> 06!T 9Ќw>Ќi>√76!T 9Ќw>"6!  9P "“1е*6е!V 9Ќw>еЌl5ЅЅЅ"–1!T 9Ќw> АЌ>ЏХ6:Ќ1Ќr>а€|µ М6!- еЌЌ2Ѕ*«1+"«1√Х6*–1+"–16-*–1е*“1еЌз6ЅЅ!P 9щ…!∞€9щ!  9P "“1е!V 9Ќw>е!V 9Ќw>еЌl5ЅЅЅ"–1*–1е*“1еЌз6ЅЅ!P 9щ…  ! 9Ќw>е! 9Ќw>Ќ_>"е6*ќ1ЌЏ= 7:Ќ1Ќr>е*е6еЌW7ЅЅ*е6+"е6#|µ A7! 9еЌw>#Ќ|>+Ќq>еЌЌ2Ѕ*«1+"«1√7*ќ1|µ V7!  е!  еЌW7ЅЅ…! 9Ќw>л*«1Ќ> ~7! 9Ќw>еЌЌ2Ѕ*«1+"«1√W7…! 9Ќw>	 Ќт= Х7!0 √Ш7!7 л! 9Ќw>…       ! 9еЌw>+Ќ|>! 9Ќw>"І7!  "£7*І7еЌ{1"•7—}*•7  Ќ>¬з7*•7 Ќу=ЌЊ= q8*•7√U8*£7+"£7#|µ¬8√µ7*І7+"І7!Э8еЌ0Ѕ√n8! 9Ќw>6 *£7+"£7#|µ 68!Э8еЌ0Ѕ√8*•7е€|µ¬F8! …√µ7*І76 !  …√n8ЌД>у7 у7 8 8 I8   √Щ8! 9Ќw>л*£7Ќ> Щ8*І7#"І7+Ќq>еЌТ1Ѕ*£7#"£7√≈7…  €€€€     *£8#|µ¬Ј8Ќ∞9! 9еЌw> Ќ|>*°8"І8! |µ 9*І8 Ќw>ЌЏ= ш8*І8##Ќw>е! 9Ќw>—Ќ%>ЌЊ= 9√9*І8Ќw>#|µ¬9!€€…*І8Ќw>"І8√ћ8*І8##Ќw>е! 9Ќw> —Ќ%> Ц9*І8л! 9Ќw>"©8*©8##е*І8##Ќw>е! 9Ќw>Ќ_>Ќ|>*©8е*І8Ќw>Ќ|>*©8 6 #6 *І8##е! 9Ќw>Ќ|>*І8е*©8Ќ|>*І8 6#6 *І8 …      !  еЌ#@Ѕ"Ѓ9Ќш9"ђ9!  "£8*Ѓ9"°8"™9*™9##е*ђ9е*Ѓ9Ќ_>Ќ|>*™96€#6€*™9 6 #6 …!  9» нR…    ! ":!  ":! 9Ќw>Ќq>√4:!€€":! 9еЌw>#Ќ|>√A:ЌД>:- %:+   ! 9Ќw>Ќq>0 Ќу= d:! 9Ќw>Ќq>9 Ќт=ЌЊ= Р:*:
 ЌЮ>е! 9еЌw>#Ќ|>+Ќq>—–€":√A:*:л*:ЌЮ>…√™:egal struct ! 9^#V!ƒ€9еееЌEб	 	6C#6O#6M—Ќ ю€¬Ў:б!€€…! 9~#foЌМ;*Ю:|µ¬щ:Ю:’!\ ЌEб√;л!\ ЌE*†:|µ¬;!†:л!l ЌEБ ! 9~#fo |µ (;ґ¬,;√B;> ~юaъ9;÷ #Ј¬1;!А pb;!÷ *w#¬N;Ѕ* щ!  е√÷  ’≈Ќ —’Ќ Ѕ—Ј ш А Ќ √ !А л√ў л∆;!Ю:ю  Ф;ю	 Ф;ю  ¬;q#p#ю  Љ;ю  Љ;ю	¬©;ѓ√У;w#w…n& "h*h##ЌяУ& }жo"	h*h##ЌяУ& }жo"h*	hЌ&У"hе*hЌ&У—"h√Ћk*h”€|µ¬,q√№k*h√Ќh√Ёh*h|µ¬Ёh√,q…        ! 9Ќw>"-<  Ќ> O<*-<Ќi>"-<! 9Ќw>"/<"1<*/<#"/<+е*-<л!
 Ќњ>л0 —}*-<л!
 Ќњ>"-<|µ¬\<! 9Ќw> АЌ>Џ£<*/<#"/<+6-*/<6 */<+"/<л*1<Ќ7> б<*1<Ќq>"+<*1<#"1<+е*/<Ќq>—}*/<е*+<—}√®<! 9Ќw>…! 9Ќw> АЌ>Џ=!- еЌТ1 Physicaм */Н
/*†Drivе Addresу whicи iу computeд iо variablе 'dІ belowЃ  Thе rowу arе */Н
/*†thе† settingу† froн† thе 'drive->hspІ entrщ† oж† thе† structureу† iо */Н
/*†'sethwІ† anд† thе columnу arе deduceд froн thе clocл ratе† 'Higи† oт */Н
/*†Low©† iо† thе formaф filе anд thе presencе oж aо 'HІ witи thе† Drivе */Н
/*†Typе (eз Drivе Typе 5» tп reaд higи coercivitщ 5.25Ґ discs)		*/

	  -1,         0,        -1,        -1,	/* 8" Drive	      A	*/

	0x08,        -1,        -1,      0x88,	/* 5.25" Dual Speed   B	*/

	   0,        -1,        -1,        -1,	/* 5.25" Single Speed C	*/
						/* 3.5" Single Density	*/
						/* 3"			*/

	0x88,      0x08,        -1,        -1	/* 3.5" Dual Density  D	*/

/*	Lo Clock   Hi Clock   Lo Clock   Hi Clock			*/
/*       No 'H'	    No 'H'      'H'        'H'				*/
	};


/*-----------------------------------------------------------------
 *	List of all drives + data on the system.
 *	18 bytes per entry
 *-----------------------------------------------------------------*/
#asm
	.z80
FIVE	equ	0
EIGHT	equ	1
THREEHALF equ	2
THREE	equ	3
FIVEH	equ	4

hardware::		

#ifdef D5DS
/*	*********************************************************/
/*	*********   5.25" Dual Speed Drive  Teac FD55GF  ********/
/*	*********************************************************/

	db	'DRIVE 0 ',0    /* Must be 8 bytes total + NULL */
	db	0		/* Drive physical address	*/
	db	FIVEH		/* Drive type	(msb set if HS opt) */
	db	96		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'B'		/* Hi speed opt */
#endif

#ifdef D548
/*	*********************************************************/
/*	*********   5.25" 48tpi             Teac FD55B   ********/
/*	*********************************************************/

	db	'DRIVE 1 ',0    /* Must be 8 bytes total + NULL */
	db	1		/* Drive physical address	*/
	db	FIVE		/* Drive type			*/
	db	48		/* TPI	   */
	db	42		/* Tracks note extra tracks */
	db	2		/* Sides   */
	db	6		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt NO */
#endif

#ifdef D8
/*	*********************************************************/
/*	*********   8" DSDD           Mitsubishi M2896   ********/
/*	*********************************************************/

	db	'DRIVE 4 ',0    /* Must be 8 bytes total + NULL */
	db	4		/* Drive physical address	*/
	db	EIGHT		/* Drive type			*/
	db	48		/* TPI	   */
	db	77		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	50		/* Head load */
	db	18		/* Settle    */
	db	'A'		/* Hi speed opt */
#endif

#ifdef D3100
/*	*********************************************************/
/*	*********   3" SSDD           Hitachi HFD 305S   ********/
/*	*********************************************************/

	db	'DRIVE 5 ',0    /* Must be 8 bytes total + NULL */
	db	5		/* Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	100		/* TPI	   */
	db	40		/* Tracks  */
	db	1		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif


/*	*********************************************************/
/*	*********   3.5" DSDD              Teac FD35F    ********/
/*	***************************** or   Teac FD135HFN ********/
/*	*********************************************************/

#ifdef D356
	db	'DRIVE 6 ',0    /* Must be 8 bytes total + NULL */
	db	6		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Single Data Rate */
#endif

#ifdef D35H6
	db	'DRIVE 6 ',0    /* Must be 8 bytes total + NULL */
	db	6		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	44h		/* 'D' Dual data rate */
#endif

#ifdef D352
	db	'DRIVE 2 ',0    /* Must be 8 bytes total + NULL */
	db	2		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Single Data Rate */
#endif

#ifdef D35H2
	db	'DRIVE 2 ',0    /* Must be 8 bytes total + NULL */
	db	2		/* Drive physical address	*/
	db	THREEHALF	/* Drive type			*/
	db	135		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	3		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	44h		/* 'D' Dual data rate */
#endif


/*	*********************************************************/
/*	*********  3" DSDD 200tpi National Panasonic EME 231 ****/
/*	*********************************************************/

#ifdef D32002
	db	'DRIVE 2 ',0    /* Must be 8 bytes total + NULL */
	db	2		/* Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	200		/* TPI	   */
	db	80Ѕ! 9е! 9Ќw>Ќi>Ќ|>! 9Ќw>цЌ>“6=! 9Ќw>л!
 Ќњ>еЌй<Ѕ! 9Ќw>л!
 Ќњ>л0 еЌТ1Ѕ…Ѕб—’е≈Њ¬d=#Ј¬U=!  …!€€Ў! …Ѕб—’е≈+#~Ј¬s=…Ѕ—’≈!  Ј Н=#√Г=…! 9n& }юaЎю{–о o…Ѕ—≈}≥o|≤g…Ѕ—≈}Ђo|™g…Ѕ—≈}£o|Ґg…|µ»!  ,…Ѕ—≈|Ї}!  ¬Ў=ї¬Ў=,…ѓ…|µ ƒ=!  ѓ…Ѕ—≈|Ї}! јїј-…лzЉ¬>{љ¬>!  ,…лzђъ>zЉ¬>{љ! Ў-…|І! ъ>µ…|оАg…л|Ї¬->}ї! “5>-…µ…лzЉ¬?>{љ! Ў-…л|ш|g}o√F>лѓ√H>лш)√Y>Ѕ—≈{ХozЬg…+|/g}/o…~oЯg…~#fo…лбгs#rл…лбN#F#x± Э>~#ї~#¬Ж>Ї¬Ж>`iйDM!  zЈ>¬≠>S\)л)л“µ>	=¬≠>…ѓх√ >zђхђльi>л|Јфi>MD!  x<¬ё>zБ>Џг>jS\>)л)л“л>#е	б“у>	=¬г>лсрлЌi>л√i>…   * +%"_A%"]A%"[A№€	"ђA	"™A	"®Ay€	6 "X@+6Д+щ?’!ЧEЌ7>б D?"K@!А ^6    ≈F+N+тQ?!* е!?е! 9~#Ј ђ?ю  g?Oю" А?ю' А? +—}|’е+#~Ј Ч?є¬К?6 #г~#ю< ћ?ю> ё?!?4б√g?б6€#6€*?е!?еЌЅ* @|µ …?еЌ™B√  е!Џ?еЌЌA"№?√й?r   е!@еЌЌA" @ЅЅЏц?б—’√g?@	Ќ  Ќ Can't open > or < file.$√љ?w   …—Ѕ≈’*K@ее—	ееЌ7>—¬>@!ю9Ќ%>—Ѕ!€€јл"K@≈б…ЧE…*№?еЌ<CЅ… h:W@<*X@ЊЎ»л
Ќ ѓ2W@
ЌЦ@√[@Ќ Ј»Ќ ю   ю @ю¬Х@>
_*X@~+Њ–#4N 	s>
їћ …Ќ@> !ЅAЌBAЎ≈:Z@є¬ѕ@Ќ[@2W@_ ~√‘@€Ќ Ѕю¬й@¬е@
Ќ !
 …¬т@ю ≠@ю ы@o& …!€€…Ѕ—’≈* @’еЌЅCЅЅ…л> е!≈AЌBA—Ў’л}ю
¬+A≈Ќ Ѕ>
_Ќ б…con:rdr:pun:lst: ÷ ЏTAютTA_ ~OЈј7√ы@…                                     €€€€€€€                                                         !"#    Ѕб—’е≈!1A ’ец Њ¬пA#¬№A—бi& … б—~Ј¬ЎA!A~ю€ B#¬ B√)CЅ—’≈л~#Fлч€6 , 6 щ€pщ€w# 6 2WBґAлЌb>е! 9Ќw>Ѕ≈y=еЌuEб )C’лЌE> юw¬hB—’Ќ —Ќ —< )C!~As 	ѓw#6в€	w+wт€	~#ґ¬ІB’е ≈Ќ#@Ѕлбs#r{≤— )Cлѓ…Ѕ—’≈{ю Џ B!≈AЌBA#Ў ^{Јƒ !  …!~A~< )C6€Ќ.C!УA~юr C!ЪAN!ЕA’Ќw>}Ј Cлх*|Ayюb 
C>w#¬C%се!А =тC)еЌFDЅЅ—{=’ЌuEЌ <бј!  7…!YAN#F≈б"|A…ЌЪCЈ ∞@ю “≤@ѓє+¬lCе’*|Aе! еЌvDЅЅ—’лґA	s{≤—б ы@’еЌw>#Ќ|>+л*|AF!ЪA—>bЊ ЦCxю <Cю ы@Ј <Ch& …бЅ—’≈е{Ј»ю –Ќ.C!ґA~!ЕAN#Fє{ј p+pH#…ЌЪCЈ¬—CЅб—’е≈√Aю ЏяCЅ—бе’≈√A+е! 9~ю
¬	Dе!ЪA~юb D!D5¬D>б√	D6б>
*|A	wгее`i#Ќ|>бѓЊб¬7DЅ—’≈’%,е! еЌFDЅЅЅ|µ!€€»ш! 9n& :DЈ ЅC…ѓ2ьD>√}DЌе! 9Ќw>лбе):ьD§х|!gAЖw“nD#4!uAсwб…>€2ьD>2OD:Z@Јƒx@ЌэD≈x± йD’е≈’лЌ —:ODOЌ ЅЈ¬ґD!А€	DMбА —√ЛDб—:ODю¬йDбѕD	Ќ !€€√пDWrite error - Disk full
$—`iЌb>еА Ќ б√PDt! 9~=+еЌuEб’V+^+F+Nбл… 	"kE> w+¬Eѓw 	w##w 	wа€	л#~+ю:¬HE~##ЌmE÷@~#Ј»ю. YEЌmE√HEл*kE++Ј»ЌmEw#√_E…!жюaш÷ …O !®A		~_#V≤је!$ еЌ#@лббr+sbk#|µ……                                                                                                        √	D6б>
*|A	wгее`i#Ќ|>бѓЊб¬7DЅ—’≈’%,е! еЌFDЅЅЅ|µ!€€»ш! 9n& :DЈ ЅC…ѓ2ьD>√}DЌе! 9Ќw>лбе):ьD§х|!gAЖw“nD#4!uAсwб…>€2ьD>2OD:Z@Јƒx@ЌэD≈x± йD’е≈’лЌ —:ODOЌ ЅЈ¬ґD!А€	DMбА —√ЛDб—:ODю¬йDбѕD	Ќ !€€√пDWrite error - Disk full
$—`iЌb>еА Ќ б√PDt! ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее		/* Tracks  */
	db	2		/* Sides   */
	db	12		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif

#ifdef D32006
	db	'DRIVE 6 ',0    /* Must be 8 bytes total + NULL */
	db	6		/* Drive physical address	*/
	db	THREE		/* Drive type			*/
	db	200		/* TPI	   */
	db	80		/* Tracks  */
	db	2		/* Sides   */
	db	12		/* Step rate */
	db	0		/* Head load */
	db	15		/* Settle    */
	db	'C'		/* Hi speed opt */
#endif

	db	0		/* Table terminator */
	.8080
#endasm

/*-----------------------------------------------------------
 *		e n d	o f   S E T H W
 *-----------------------------------------------------------*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                             SETLIB(ERROR)
.pa
*/
#include	"portab.h"

/*
02/11/89 Call to 'kflush' added at end of 'error' - ICFO
10/06/85 Version 3.0
         Written by David Parkinson
         (c) dci software 1983, 1984, 1985
         Module containing various library functions for SETUP
         Modified to include abbreviated screen addressing in order
         to reduce code size of SETUP
01/07/84 Include SEEKRC(n) function
17/10/83 Support new abort() function
*/

#define		_RC_ *256+	/* Used in ROW / COLUMN construct	*/
#define		BDOS	5
#define		RECSIZ	256
#define		S_DUMP	0x10

EXTERN
WORD	IObuf[],
	IOind[],
	IOsect[],
	IOfcb[];

EXTERN
BYTE	IOmode[],
	IObin[],
	IOrw[],
	buffer[],
	deflt[];

STATIC	hexify();

/*======================================================================*/
VOID                                /*					*/
error(p)                            /* Briefly display an error message */
BYTE	*p;					/* Error message	*/
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

hil_on();
for (i = 0; i < 3; ++i)	{
    smove(23 _RC_ (40 - strlen(p) / 2));
    conout(' ');
    putstr(p);
    conout(' ');
    wait(2);
    clreos(23,0);
    wait(1);
}
hil_off();
clreol();
kflush();

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(KFLUSH)
.pa
*/
/*======================================================================*/
VOID                                           /*			*/
kflush()                                       /* Flush keyboard buffer	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (const() != 0)  continue;

}

/*======================================================================*/
/*
.he                                                              SETLIB(WAIT)
.pa
*/
/*======================================================================*/
VOID                                                   /*		*/
wait(i)                                                /* Delay routine */
WORD	i;			                        /* Delay	*/
/*======================================================================*/

{

LOCAL
WORD	j;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (i-- != 0)  for (j = 0; j < 8000; ++j)  continue;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(MOVSTR)
.pa
*/
/*======================================================================*/
VOID                           /*					*/
movstr(dest,source,length)     /* Move a string from 'source' to 'dest' */
BYTE	*dest,				/* Pointer to destination	*/
	*source;			/* Pointer to source		*/
WORD	length;				/* Number of bytes to move	*/
/*======================================================================*/

{

/* Move a string from 'source' to 'dest' for max length 'l'		*/
/* Remove any trailing spaces from the string.				*/

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i = 0;
while (i < length && (*dest++ = *source++) != NULL)  ++i;

dest -= 2;

while (i-- > 0 && *dest == ' ')  *dest--;

*(++dest) = NULL;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(STRCPY)
.pa
*/
/*======================================================================*/
VOID                                                   /*		*/
strcpy(dest,source)    ј;                                                                                                                             Copyright Timeclaim Ltd 1988 05.2003.11€ DEVELOP №‘                                                                            √uА                                                                                                           ! 9Ќл"  Ќv" ЛА! √ОА!  "sАеЌƒЦЅ"_А#ЌN" §АЌРТ…! 9Ќл"###|µ¬ƒА!ZВеЌ™,Ѕ*_АеЌJФЅ…! 9Ќл" АЌУ"ЏуА! 9е! 9Ќл"#ЌN" нА!  √рА! Ќр"*sА+ЌN" Б! 9Ќл"ЌN"Ќ2" БЌ„°!Ае!H е!  еЌ.ЅЅЅ!  "]А!  е*sАе! 9Ќл"е*_АеЌµЪЅЅЅЅ"]Ае!€€Ќ:" TБЌРТ…!  е*]АеЌ4УЅЅ"[Ае!€€Ќ:" rБЌРТ…!aАеЌ"ЧЅ"qА#ЌN" ИБЌРТ…*[Ае!aАе!Ае! 9Ќл"еЌНШЅЅЅЅ#ЌN" ЃБЌРТ…!aАе!Ае! 9Ќл"е*qАе*sАеЌ•ЅЅЅЅЅ#ЌN" ўБЌРТ…!aАеЌыЧЅ#ЌN" мБЌРТ…!Ае! 9Ќл"еЌs§ЅЅ! е!  еЌ4УЅЅ! е!  е!  е!  еЌµЪЅЅЅЅ*sАЌN"¬5В! 9Ќл"+ЌN"Ќ2" VВ!  еЌќҐЅ! еЌќҐЅ*_АеЌJФЅЌэВ!  …AMIE.SWT €€  €€€€ €€€€И   €€€€€€И  €€€€DRIVE 0   `P BDRIVE 1   0* CDRIVE 4  0M2ADRIVE 5  d( CDRIVE 6  ЗP D                                !%Ее!нВе! еЌ*ЅЅЅ"дВ#ЌN" 'Г!%Ее! еЌЗЅЅ…!	 еЌ>Ѕ*Eе!.ЕеЌСЅЅ"ёВ#ЌN" TГ*Eе! еЌЗЅЅ…!1ЕеЌЕЅ!  "аВ*аВюЌУ"ЏXД√{Г*аВ#"аВ√bГ!' еЌЕЅ*аВH Ќ##еЌЕЅ!' еЌЕЅ!	 еЌЕЅ*аВH Ќ##G Ќе"еЌЕЅ!  "вВ*вВьЌУ"ЏMД√ёГ*вВ#"вВ+√ƒГ!	 еЌЕЅ*аВH Ќ##! е*вВ	 Ќ#—еЌЕЅ*аВ))л*вВ)нВЌл"Ќе"Ќ2" JД![ еЌЕЅ*аВ))л*вВ)нВЌл"еЌЕЅ!] еЌЕЅ√”Г!5ЕеЌЕЅ√qГ*Ќ2"¬gД*Ќ2"Ќ2"¬sД*!Ќ2"Ќ2" еД!;ЕеЌЕЅ*е!жВеЌшєЅЅ!жВеЌЕЅ! "вВ*вВэЌУ"ЏЁД√µД*вВ#"вВ√ЬД!, еЌЕЅ*вВ)Ќл"е!жВеЌшєЅЅ!жВеЌЕЅ√ЂД!@ЕеЌЕЅ! еЌЕЅ*ёВеЌљЅ*дВеЌ~Ѕ!  …*ёВе! 9Ќл"еЌЅЅ…! 9Ќе"е*ёВеЌRЅЅ…AMIE.SWT WC #
 
#
 [AL: ]
                                                                                                                                                                                                                ! 9Ќл"	 Ќл"е!cЕе!А еЌЭ-ЅЅЅЌhС!зЕе! 9Ќл"е!	 еЌ∆РЅЅЅ! 9Ќл" Ќл"  Ќg" xЖ! 9Ќл" Ќл"√{Ж!€€"Ж! 9Ќл")≥Ќл""шЕЌЪЖ"Ж*Ж…! |µ ёЖ!  "еЕЌ	З}2DЕ#Ќ2" єЖ√ёЖ! "еЕ* Ж)" ЖЌ	З}2DЕ#Ќ2" „Ж√ёЖ!€€…√ЪЖЌ§И#ЌN" мЖ!э€…ЌЕЛЌ§Н#ЌN" эЖ!ю€…*шЕ…        !ГВ"гЕ*гЕЌе"|µ ?И*гЕ	 Ќе""З*Ж#ЌN"¬;З*Зе*ЖЌ:"Ќ2" 2И*ъЕ& }жoЌ2" VЗ! √YЗ!  "З*юЕЄ€ЌN" oЗ! √rЗ!  "З*гЕ Ќе"њ€)))cВе*Зл*З)—Ќл""З*гЕ Ќе"& }жюoе* Ж& }жюoЌ:" мЗ*гЕ
 Ќе"& е*ъЕЌ:"¬йЗ*гЕ
 Ќе"& }жoе*ъЕЌ:"Ќ2"Ќ2" И*гЕ Ќе"& л*ЖЌf"Ќ2" И*гЕ Ќе"л*ЖЌf"Ќ2" )И*З#Ќ2"Ќ2" 2И√?И*гЕ "гЕ√З*гЕЌе"|µ¬NИ!€€…*З& }жoрЕЌе""З*юЕЄ€|µ¬wИ*З  "З:ЕЕЌж"& }жoЌN" УИ*З "З*Зл*З"З*З…  *Жл!А Ќ3#"ҐИ!  }2EЕ*ҐИюЌУ"“еИ√’И:EЕЌж"#}2EЕ√ЄИ*ҐИл! Ќ3#"ҐИ√«И*Жл!А Ќ3#+}2FЕ:ЧЕЌж"& }жo}2GЕ*ьЕ√TЙ√mЙ:GЕЌж" }2GЕ√mЙ:GЕЌж"  }2GЕ√mЙ:GЕЌж"@ }2GЕ√mЙ:GЕЌж" }2GЕ√mЙ√mЙЌш"
ЙS ЙT ЙU /ЙC @ЙB   :ЕЕЌж"& }жАoЌ2" НЙ:GЕЌж"А }2GЕ:ЬЕЌж"& }ж oЌ2" ≠Й:GЕЌж" }2GЕ:ХЕЌж" Ќ#л:ФЕЌж"+Ќ2" ‘Й:GЕЌж"##}2GЕ*Ж+}2HЕ:ОЕЌж" Ќ#л!А Ќ3#+}2IЕ*гЕ Ќе"+++}2JЕ:JЕЌж" АЌУ"ЏК!  }2JЕ*еЕ+ЌN" 3К:JЕЌж"А }2JЕ*гЕ Ќе"}2KЕ*гЕ Ќе"}2LЕ*Ж+}2MЕЌФО"NЕ###ЌN" jК!€€…*Жл!А Ќ3#л*ЖЌ#"ҐИ*ьЕљ€|µ¬ЧК*ҐИл*ЖЌ#"ҐИ*ЖЌ2" ™К*ҐИе*ЖЌX"Ќ2" ЇК*Ж}2PЕ√«К*ҐИ"Ж!  }2PЕ*Ж}2QЕ*Ж++|µ¬жК:QЕЌж"}цАo}2QЕ!ІЕЌе"#Ќ2" эК*ьЕљ€Ќ2"Ќ2" Л:GЕЌж"& }жюo}2GЕ:HЕЌж"#}2HЕ:ЯЕЌж"}2SЕ:ЮЕЌж"}2RЕ!DЕе*шЕ))))л*M-е! еЌЭ-ЅЅЅ*шЕ Ќ#л*S-е!зЕеЌЃЇЅЅ*шЕ Ќ#л*S-	 е*гЕеЌЃЇЅЅ!  …*Ж"TЕ*Жл*ЖЌ#л*ЖЌ#е*Жл!А Ќ3#—Ќ#"YЕ*Ж√√ЛЌOН√ѕЛЌсЛ√ѕЛ√ѕЛЌш"іЛ   √ЇЛ!TЕе*шЕ Ќ#л*O-е! еЌЭ-ЅЅЅ…    :ОЕЌж""нЛ! }2VЕ*нЛюЌУ"“.М√ М*нЛл! Ќ3#"нЛ√М:VЕЌж"#}2VЕ√М:IЕЌж"}2WЕ*СЕ& л*ЖЌ#е*YЕгЌ”""YЕ:ОЕЌж")))"нЛ*YЕл*нЛЌ.#+"YЕ*YЕ€ Ќђ" ЖМ:ОЕЌж"л! Ќ3#+√НМ:ОЕЌж"+}2XЕ:ИЕЌж"& ÷€Ќ2" ≥М:ИЕЌж"& –€}2XЕ:ОЕЌж"+ЌN" …М*YЕ€ Ќђ"Ќ2" №М!€ "YЕ!  }2XЕ*ПЕ+"[Е:ОЕЌж")))))"нЛ*ПЕл*нЛ+л*нЛЌ3#"нЛ!  "пЛ*нЛ+"нЛ#|µ +Н*пЛл! Ќє"|цАg"пЛ√
Н*пЛл! Ќє"}2]Е*пЛ}2^Е!  "_Е*СЕ& "aЕ…*ПЕ"[Е*†Е}2VЕ:ҐЕЌж"}2WЕ:£ЕЌж""_Е:§ЕЌж"}2XЕ:•ЕЌж"}2]Е:¶ЕЌж"}2^Е:•ЕЌж"}2]Е:¶ЕЌж"}2^Е…  *Ж|µ¬ЕО*шЕ))))л*Q- е!  Ќр"*YЕ#л! Ќ.##"ҐН*≥е*шЕЌ:" %О*шЕ))))л*Q- е*K- Ќл"Ќр"л*ҐНе*шЕ#))))л*Q- Ќл"—Ќf" "О!€€…√ЕО*шЕ))))л*Q- е!€€е*ҐНЌ”"Ќр"е*шЕ+))))л*Q- Ќл"е*шЕ+ Ќ#л*O- Ќл"#л! Ќ.#—#—ЌЪ" ЕО!€€……              !  "ТО"РО!ІЕЌе"#|µ ≠Р*ьЕљ€ЌN" љО*Ж)√јО*Ж"ИО*≥е*шЕЌ:" зО*шЕ#"ЖО*K- Ќл""ОО√П*шЕ+"ЖО*K- Ќл"І е*ИОЌ”""ОО*ЖО))))л*M-
 Ќл"е!  ЌX"¬9П*ЖО))))л*Q-Ќл"е!  ЌX"Ќ2" ±П*ЖО))))л*M-###Ќе"& }ж@oЌ2" ЙП*ЖО))))л*M- Ќе")І ’Ќ”"л*ИОЌg" ЖП!э€…√±П*ЖО))))л*M- Ќе"І ’Ќ”"л*ИОЌg" ±П!э€…!ІЕе*ООе*ИОеЌЭ-ЅЅЅ*ьЕљ€ЌN" ўП*ИО< Ќw"Ќ2" 4Р*ОО"КОе*ИОл! Ќ3#—"МО!  "ЖО*Жл*ЖОЌv" 4Р√Р*ЖО#"ЖО√ыП*МО#"МО+е*КО#"КО+Ќе"л*Ж—}√Р*ьЕљ€ЌN" LР:ЧЕЌж"& Ќ2"Ќ2" ЛР*ОО"КО!  "ЖО*ИОл*ЖОЌv" ЛР√xР*ЖО#"ЖО√^Р*КО#"КО+еЌе"+—}√nР*Жл!А Ќ3#юЌУ"“ІР*ОО"ТО√≠Р*ОО"РО*шЕ))))л*Q-е*РОЌр"*ТО…  !  "ƒР! 9Ќл"л*ƒРЌv" С! 9еЌл"#Ќр"+е! 9еЌл"#Ќр"+Ќе"—}Ќ2"Ќ2" С*ƒР#"ƒР√ћР! 9еЌл"++Ќр"*ƒР+"ƒР#  Ќw" @С! 9Ќл"Ќе"а€ЌN"Ќ2" YС! 9еЌл"+Ќр"#Ќе"√С! 9еЌл"#Ќр"6 …:ДЕЌж"л! Ќє"& }жo"ъЕ:ЬЕЌж"& }жАoЌ2" ЪС*ъЕ "ъЕ:ДЕЌж"& }ж?o"Ж:ЕЕЌж"& }жpo√иС!C "ьЕ√ Т!B "ьЕ√ Т!U "ьЕ√ Т!T "ьЕ√ Т!S "ьЕ√ Т√ ТЌш"ЄС@ ЅС0  С  ”С   √№С:ЕЕЌж"& }жoЌ2" Т! √Т! "Ж:ЕЕЌж"& }жoЌ2" 6Т!H √9Т!L "юЕ:ЖЕЌж"& "Ж:ЗЕЌж"А Ќ#"Ж!ЛЕЌе" Ќ#е!КЕЌе"—" Ж!НЕЌе" Ќ#е!МЕЌе"—"Ж:УЕЌж""Ж…Ќ‘Ч! е!  еЌ4УЅЅ! е!  е!  е!  еЌµЪЅЅЅЅ!€€…    ! 9Ќл"е! 9Ќл""їТЌр"ЌУ! 9Ќл"##е*їТЌр"!  "љТ*љТьЌУ"ЏУЌУ! 9                                 /* Copy a string */
BYTE	*dest,				/* Pointer to destination	*/
	*source;			/* Pointer to source		*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while ((*dest++ = *source++) != NULL)  continue;

/* Let C/80 supply the return						*/

}
 
/*======================================================================*/
/*
.he                                                             SETLIB(LDIRM)
.pa
*/
/*======================================================================*/
VOID                                                 /*			*/
ldirm(d,s,l)                                         /* LDIR equivalent */
BYTE	*d,				/* Pointer to destination	*/
	*s;				/* Pointer to source		*/
WORD	l; 				/* Number of bytes to move	*/
/*======================================================================*/

{

/* Equivalents  of the Z80 instruction LDIR used to move binary data	*/
/* about.								*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	pop	ix
	pop	bc
	pop	hl
	pop	de
	push	de
	push	hl
	push	bc
	ldir
	jp	(ix)
	.8080
#endasm

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETLIB(LDDRM)
.pa
*/
/*======================================================================*/
VOID                                                 /*			*/
lddrm(d,s,l)                                         /* LDDR equivalent */
BYTE	*d,				/* Pointer to destination	*/
	*s;				/* Pointer to source		*/
WORD	l; 				/* Number of bytes to move	*/
/*======================================================================*/

{

/* Equivalents  of the Z80 instruction LDIR used to move binary data	*/
/* about.								*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	pop	ix
	pop	bc
	pop	hl
	pop	de
	push	de
	push	hl
	push	bc
	lddr
	jp	(ix)
	.8080
#endasm

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTSTR)
.pa
*/
/*======================================================================*/
VOID                                                  /*		*/
putstr(p)                                             /* Print a string */
BYTE	*p;					/* String to print	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (*p != NULL)  conout(*p++);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTLIN)
.pa
*/
/*======================================================================*/
VOID                                /*					*/
putlin(p)                           /* Print a string followed by CR LF */
BYTE	*p;					/* String to print	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putstr(p);
conout('\n');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                                SETLIB(CR)
.pa
*/
/*======================================================================*/
VOID                                                    /*		*/
cr()                                                    /* Do just a CR */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

conout('\r');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                              SETLIB(CRLF)
.pa
*/
/*======================================================================*/
VOID                                                      /*		*/
crlf()                                                    /* Do a CR LF */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

conout('\n');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(GETINT)
.pa
*/
/*======================================================================*/
WORD                        /*						*/
getint(rowcol,defval)       /* Get a positive integer from the keyboЌл" е*љТ#"љТ+)—е*їТЌр"√нТ…*їТ#"їТ+Ќе"|µ 1У√У…  ! 9Ќл"√~У! еЌо)Ѕ"2Уе!€€Ќ:" WУ!€€…*2Уе! 9Ќл"еЌњТЅЅ*2У…*2УеЌу*Ѕ"2У!  …√ЛУЌш">У  lУ   …                                                                                                                                                                                           
# !  "!"""! 9Ќл"е!ЈЦеЌСЅЅ"МУ#ЌN" xФ!€€…!  "ЦУ*МУеЌ€б≈’   Ќ
ї ЂФ*МУе €€€≈’! еЌБµЅЅЅЅ! |µ HХ!  "ФУ! |µ )Х*МУеЌƒЅ}2ШУе*ФУGФЌе"Ќ:" ъФ*ФУ#"ФУе!GФеЌw.ЅЌ:" чФ√)Х√&Х:ШУЌж"#ЌN"¬Х:ШУЌж"ж€ЌN"Ќ2"  Х√ЂЦ√&Х!  "ФУ√єФ*МУеЌ_ЪЅ*МУеЌƒЅ•€|µ¬EХ√HХ√ЂФ*МУе!ЫУе!P еЌгЅЅЅ#ЌN" dХ√ЂЦ! е!ЫУе!;Фе!AФеЌ™ЅЅЅЅ"ТУ#ЌN" ОХ!€€"ЦУ√ЂЦ*ТУе!;Фе!ЇЦеЌ+ЅЅЅ"РУ#Ќ2" цХ*РУ)AФЌл"Ќе"еЌ–#ЅЉ€ЌN" ЌХ! √уХ*РУ)AФЌл"Ќе"еЌ–#ЅЂ€ЌN" рХ!€€√уХ!  "*ТУе!;Фе!љЦеЌ+ЅЅЅ"РУ#Ќ2" ЂЦ*РУ)AФЌл""ЩУ!  "ОУ*ОУэЌУ"ЏЂЦ√?Ц*ОУ#"ОУ√&Ц*ОУ)е*ЩУеЌ%єЅЌр"*ЩУЌе"еЌЇєЅ+ЌN"¬rЦ*ЩУЌе"”€ЌN"Ќ2"¬ЕЦ*ЩУЌе"’€ЌN"Ќ2" ХЦ*ЩУ#"ЩУ√SЦ*ЩУ#"ЩУ+Ќе"|µ¬®Ц√ЂЦ√5Ц*МУеЌљЅ*ЦУ…RC AR AL 	ЧЧ! 9Ќл"+ЌN" еЦ*јЦеЌ"ЄЅ+ЌN" еЦ*јЦ…*¬ЦеЌ"ЄЅЌN" Ч*¬Це! еЌЗЅЅ…√Ч*¬Ц……AMIE.009 AMIE.AS {Ш  €€  *ЧеЌ"ЄЅ+ЌN" bЧ*Че! 9Ќл"е! еЌ*ЅЅЅ"Ч#ЌN" _Ч*Че! еЌЗЅЅ…√ШЧ!  " Ч* ЧшЌУ"ЏШЧ√БЧ* Ч#" Ч√hЧ* Ч)л! 9Ќл"е!ГШЌр"√wЧ! еЌо)Ѕ"Че!€€Ќ:" ЊЧ*ЧеЌ~Ѕ! еЌpЅ…*Че! е!  еЌ.ЅЅЅ*Ч…*ЧеЌу*Ѕ"Ч*Ч#|µ цЧ*ЧеЌ~Ѕ!€€"Ч…    *Че!ДШеЌСЅЅ"чЧ#ЌN" #ШЌ‘Ч*Че! еЌЗЅЅ…!  "щЧ*щЧшЌУ"Џ_Ш√BШ*щЧ#"щЧ√)Ш*чЧе*щЧ)л! 9Ќл"Ќл"еЌvЅЅ√8Ш! е*чЧеЌRЅЅ*чЧеЌљЅЌ‘Ч!  …AMIE.SWT WC       ! 9Ќл"е!
 9Ќл"Ќл"е! 9Ќл"!! +еЌЙ.ЅЅЅ! 9Ќл"G е!
 9Ќл"##Ќл"Ќе"еЌ–#Ѕ—}"ЗШ*ЗШЉ€Ќ2" пШ*ЗШђ€Ќ2"Ќ2" €Ш*ЗШЈ€Ќ2"Ќ2" Щ! 9Ќл"Ќл"е!& еЌЗЅЅ…! 9Ќл"ЌN" -Щ!  √0Щ! "ЙШ!  "ЗШ*ЗШьЌУ"ЏYЪ√ZЩ*ЗШ#"ЗШ+*ЙШ#"ЙШ√9Щ! 9Ќл" е*ЗШ)—Ќл""ЛШ*ЛШЌе"Ќ2" ЛЩ*ЛШЌе"•€Ќ2"Ќ2" ЂЩ*ЛШе*ЛШ#"ЛШ+Ќе"еЌ–#Ѕ—}√rЩ*ЛШЌе"•€|µ¬
Ъ*ЛШ#"ЛШ+6 *ЙШ)л! 9Ќл"е*ЛШЌр"*ЛШЌе"Ќ2" сЩ*ЛШЌе"£€Ќ2"Ќ2" Ъ*ЛШ#"ЛШ+√ЎЩ*ЛШ6 √Ъ*ЙШ)л! 9Ќл"е*ЛШЌр"! 9Ќл"! е*ЗШ	 Ќ#—е!
 9Ќл" е*ЗШ)—Ќл"е!	 еЌЙ.ЅЅЅ√HЩ!  …  ! 9Ќл"еЌƒЅ"]Ъц€Ќ2" ЩЪ*]Ъ#ЌN"¬МЪ*]Ъж€ЌN"Ќ2" ЦЪ!€€…√_Ъ*]Ъ…                        ! 9Ќл"+|µ¬—Ъ*°ЪеЌу*Ѕ"°Ъ!  …! 9Ќл"е!В°еЌСЅЅ"ЭЪ#ЌN" рЪ!€€…!©ЪеЌ®ЄЅ"°Ъ"≥Ъе!€€Ќ:" Ы! еЌpЅЌX°…! 9Ќл"ЌN" 'Ы! √*Ы! "ѓЪ*ѓЪ+"ѓЪ#|µ ЫЌO°"ЯЪЁ€Ќ2" |Ы*ЯЪ#ЌN"¬^Ы*ЯЪж€ЌN"Ќ2" yЫ! 9Ќл"е!% еЌЗЅЅЌX°…√:Ы√-Ы*ЭЪеЌ_ЪЅ#ЌN" ТЫЌX°…ЌO°"ЯЪ#ЌN"¬©Ы*ЯЪж€ЌN"Ќ2" ƒЫ! 9Ќл"е!% еЌЗЅЅЌX°…*ЯЪў€|µ HЬ*ЭЪеЌ_ЪЅ#ЌN" гЫЌX°…*ЯЪЁ€|µ¬тЫ√HЬ*ЯЪ≈€|µ Ь! 9Ќл"е!% еЌЗЅЅЌX°…ЌO°"ЯЪ#ЌN"¬*Ь*ЯЪж€ЌN"Ќ2" EЬ! 9Ќл"е!% еЌЗЅЅЌX°…√ƒЫ*©Ъл!' Ќ.#)л*°Ъ"•Ъ"£Ъ!  "≠Ъ! 9Ќл"+ЌN" ҐЬ!  "ЂЪ% Ќ#л*•Ъ! е*ЭЪеЌYЈб≈’! Ќ%1ЌБ0бЌЇ0√PЮ*ЯЪЁ€|µ ЮЌO°"ЯЪ#ЌN"¬≈Ь*ЯЪж€ЌN"Ќ2" аЬ! 9Ќл"е!% еЌЗЅЅЌX°…*≠Ъ#"≠Ъ+)л*≥Ъе*•ЪЌр""±Ъ*•Ъе*°Ъл*©Ъе*•Ъ!! Ќ”"—ЌЩ" *Э! 9Ќл"е!% еЌЗЅЅЌX°…*•Ъ% "•Ъџ€! е*ЭЪеЌYЈббЌЇ0*ЯЪў€|µ ЩЭ*±Ъ#"±Ъ+е*ЯЪ—}ЌO°"ЯЪ#ЌN"¬{Э*ЯЪж€ЌN"Ќ2" ЦЭ! 9Ќл"е!% еЌЗЅЅЌX°…√IЭ*±Ъ#"±Ъ+6 *ЭЪеЌ_ЪЅ#ЌN" ґЭЌX°…! |µ ЮЌO°"ЯЪ≈€ЌN" дЭ*ЭЪеЌ_ЪЅ#ЌN" бЭЌX°…√Ю*ЯЪЁ€ЌN"¬ыЭ*ЯЪў€ЌN"Ќ2" Ю√Ю*ЭЪеЌ_ЪЅ#ЌN" ЮЌX°…√ґЭ√ҐЬ*≠Ъе*≥Ъе! 9Ќл"ЌN" 8Ю!2 √;Ю!3 еЌаЈЅЅЅ"ЂЪ#ЌN" PЮЌX°…*ЭЪе*ЂЪ% Ќ#л*£Ъ! Ќђ0≈’! Ќ%1Ќ~0≈’!  еЌБµЅЅЅЅ#ЌN" ЭЮ! 9Ќл"е!% еЌЗЅЅЌX°…! 9Ќл"еЌ„ЮЅ"ІЪе!€€Ќ:" ЇЮ!€€…*°Ъе*ІЪеЌ8)ЅЅ*ЭЪеЌљЅ*°Ъ…    *°Ъ"’ЮЌO°"ЯЪ#ЌN"¬фЮ*ЯЪж€ЌN"Ќ2" Я! 9Ќл"е!% еЌЗЅЅЌX°…*ЯЪў€|µ _Я*’Ю#"’Ю+е*ЯЪ—}ЌO°"ЯЪ#ЌN"¬AЯ*ЯЪж€ЌN"Ќ2" \Я! 9Ќл"е!% еЌЗЅЅЌX°…√Я*’Ю#"’Ю+6 ! "”ЮЌO°"ЯЪеЌ єЅ+ЌN"¬ЛЯ*ЯЪу€ЌN"Ќ2" ФЯ√oЯ*ЯЪ#ЌN"¬®Я*ЯЪж€ЌN"Ќ2" √Я! 9Ќл"е!% еЌЗЅЅЌX°…*’Ю#"’Ю+е*ЯЪ—}*”ЮъЌУ"ЏC°ЌO°"ЯЪеЌ єЅЌN" щЯ*ЯЪу€Ќ2"Ќ2" @†*ЯЪ#ЌN"¬†*ЯЪж€ЌN"Ќ2" .†! 9Ќл"е!% еЌЗЅЅЌX°…*’Ю#"’Ю+е*ЯЪ—}√ёЯ*”Ю#"”Ю*’Ю#"’Ю+6 ЌO°"ЯЪеЌ єЅ+ЌN"¬m†*ЯЪу€ЌN"Ќ2" v†√Q†*ЯЪ#ЌN"¬К†*ЯЪж€ЌN"Ќ2" •†! 9Ќл"е!% еЌЗЅЅЌX°…*’Ю#"’Ю+е*ЯЪ—}*ЯЪ≈€|µ¬@°*ЭЪеЌ_ЪЅ#ЌN" ”†ЌX°…*’Ю+"’ЮЌO°"ЯЪеЌ єЅ+ЌN"¬ц†*ЯЪу€ЌN"Ќ2" €†√Џ†*ЯЪ#ЌN"¬°*ЯЪж€ЌN"Ќ2" .°! 9Ќл"е!% еЌЗЅЅЌX°…*’Ю#"’Ю+е*ЯЪ—}√і†√“Я*’Юе*°ЪЌ”"+…*ЭЪеЌƒЅ…*ЭЪ€ЌУ"“l°*ЭЪеЌљЅ*°Ъ€€“~°*°ЪеЌу*Ѕ!€€…RC   ! 9Ќл"еЌƒЅ"Е°  Ќf" ©°*Е°ц€Ќ2"Ќ2" µ°√З°√З°*Е°#ЌN"¬…°*Е°ж€ЌN"Ќ2" ”°!€€…*Е°…Ќ7'!  е!  е!P е! еЌU-ЅЅЅЅ! е!  е!$ е! еЌVЅЅЅЅ! е!, е!$ е! еЌVЅЅЅЅ! е!# е!
 е! еЌVЅЅЅЅ! е!# еЌb(ЅЅ*"'еЌ)Ѕ! е!# еЌb(ЅЅ*'еЌ)Ѕ! е!, еЌb(ЅЅ*$'еЌ)Ѕ! е!, еЌb(ЅЅ* 'еЌ)ЅЌ*'! е!# еЌb(ЅЅ!іҐеЌД'Ѕ*+|µ¬≥Ґ!њҐеЌД'Ѕ…>--------- t= DtE     А ! 9Ќл"|µ¬эҐ! е! "»Ґе!" е! еЌU-ЅЅЅЅ!	 " Ґ√£! е!- "»Ґе!" е! еЌU-ЅЅЅЅ!
 " Ґ*ћҐе* Ґ)љЌл"еЌЃЇЅЅ! 9Ќл"H Ќ##G Ќе"√k£!* " Ґ√|£!+ " Ґ√|£!, " Ґ√|£√|£Ќш"M£D V£T _£I   *ћҐе!q§еЌ.ЅЅ*ћҐе* Ґ)љЌл"еЌ.ЅЅ! е*ћҐеЌ@§ЅЅ! е! 9Ќл"H Ќ##еЌ@§ЅЅ* Ґ÷€|µ¬<§*ћҐе! 9Ќл")≥Ќл"" Ґ Ќ#л*S-	 еЌЃЇЅЅ*ћҐе!q§еЌ.ЅЅ*ћҐе*чеЌ.ЅЅ*ћҐе* Ґ Ќ#л*S-еЌ.ЅЅ! е*ћҐеЌ@§ЅЅ!  …! 9Ќл"е*»Ґе!" е! 9Ќл"еЌІЅЅЅеЌb(ЅЅ! 9Ќл"еЌД'Ѕ…  ! 9Ќл"е! 9Ќл"H Ќ##е!H еЌЭ-ЅЅЅ!  …                                                                                                         ! 9Ќл"E е!
 9Ќл"еЌ&™ЅЌр"#ЌN" n•! 9Ќл"G Ќе"Љ€|µ T•! 9Ќл"E 6?#6 !  …√n•! 9Ќл"!  е!) еЌЗЅЅ…! 9Ќл"G Ќе"Љ€|µ Й•!  …! 9Ќл"ЌN" Ь•! √Я•! "ь§*ь§)л!
 9Ќл"Ќл""§§! е*§§е!¶§е!–§еЌ™ЅЅЅЅ"•#ЌN" Џ•!€€…! 9Ќл"E Ќл"Ќ2"¬¶*•е!¶§е!l®еЌ+ЅЅЅ"ъ§#ЌN"Ќ2" ЯІ*•е!¶§е!o®еЌ+ЅЅЅ"ъ§#Ќ2" >¶*ъ§)–§Ќл"Ќе"е!  ЌX"Ќ2" a¶!Ы§е*ъ§)–§Ќл"е!	 еЌЙ.ЅЅЅ√Н¶! 9Ќл"е!
 9Ќл"E Ќл"е!Ы§еЌО®ЅЅЅ#ЌN" Н¶!€€…*•е!¶§е!r®еЌ+ЅЅЅ"ъ§#Ќ2" ”¶*ъ§)–§Ќл"е! 9Ќл"еЌлѓЅЅ"ю§#ЌN" –¶!€€…√ў¶!ю€"ю§!Ы§"§§*§§е*§§#"§§+Ќе"еЌ–#Ѕ—}|µ ю¶√я¶!Ыard */
WORD	rowcol,					/* Cursor position	*/
	defval;					/* Default value	*/
/*======================================================================*/

{

LOCAL
WORD	x;

BYTE	*itoa();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

itoa(deflt,defval);		/* Convert the default value to string	*/
getfrom(rowcol,deflt);		/* Get input string			*/
x = atoi(buffer);		/* Convert input to integer		*/
putnat(rowcol,x);		/* Echo the new value			*/
return(x);			/* Return it				*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(GETHEX)
.pa
*/
/*======================================================================*/
WORD                      /*						*/
gethex(rowcol,defval)     /* Get two-digit hex number from the keyboard */
WORD	rowcol,					/* Cursor position	*/
	defval;                 		/* Default value	*/
/*======================================================================*/

{

LOCAL
WORD	x;

BYTE	*itoha();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

itoha(deflt,defval);			/* Convert the default		*/
getfrom(rowcol,deflt);
x = ahtoi(buffer) & 0xff;
puthat(rowcol,x);
return(x);

}

/*======================================================================*/
/*
.he                                                           SETLIB(GET4HEX)
.pa
*/
/*======================================================================*/
WORD                   /*						*/
get4hex(rowcol,defval) /* Get a four-digit hex number from the keyboard */
WORD	rowcol,					/* Cursor position	*/
	defval;                 		/* Default value	*/
/*======================================================================*/

{

LOCAL
WORD	x;

BYTE	*itoha();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

itoha(deflt,defval);			/* Convert the default		*/
getfrom(rowcol,deflt);
x = ahtoi(buffer);
puthat(rowcol,x);
return(x);

}

/*======================================================================*/
/*
.he                                                           SETLIB(GETFROM)
.pa
*/
/*======================================================================*/
VOID                         /*						*/
getfrom(rowcol,deflt)        /* Read in a string to the buffer from X,Y */
WORD	rowcol;					/* Cursor position	*/
BYTE	*deflt;					/* Default string	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(rowcol);
getstr();

/* If nothing entered then use the default				*/
if (buffer[0] == NULL)  strcpy(buffer,deflt);	

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(GETSTR)
.pa
*/
/*======================================================================*/
WORD                                  /*				*/
getstr()                              /* Read in a string to the buffer */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (getlin(buffer,80) != 0)  if (buffer[0] == 0)  abort(1);

return(scan(buffer));

}

/*======================================================================*/
/*
.he                                                              SETLIB(SCAN)
.pa
*/
/*======================================================================*/
VOID                   /*						*/
scan(p)                /* Scan the buffer for first non-blank character */
BYTE	*p;					/* Pointer to buffer	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (*p == ' ')  *p++;

return(lower(*p));

}

/*======================================================================*/
/*
.he                                                              SETLIB(ATOI)
.pa
*/
/*======================================================================*/
WORD                                  /*				*/
atoi(s)                               /* Convert from string to integer */
BYTE	*s;					/* String to convert	*/
/*======================================================================*/

{

LOCAL
WORD	x;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

x = 0;
while (numeric(*s) != 0)  x = x * 10 + ((*s++) - '0');

return(x);

}

/*======================================================================*/
/*
.he                                                             SETLIB(AHTOI)
.pa
*/
/*======================================================================*/
WORD                        /*						*/
ahtoi(s)                    /* Convert from ascii hex stri§е*ю§е! 9Ќл"E Ќл"е! 9Ќл"е!
 9Ќл"еЌrЂЅЅЅЅЅ#ЌN" 8І!€€…! 9Ќл"е!u®еЌЃЇЅЅ! 9Ќл"е!Ы§еЌ.ЅЅ! 9Ќл"е!y®еЌ.ЅЅ*ю§##ЌN" |І!* √ГІ*ю§0 }2Ы§!  }2Ь§! 9Ќл"е!Ы§еЌ.ЅЅ!  "ъ§*•л*ъ§Ќv" P®√јІ*ъ§#"ъ§+√•І*ъ§)¶§Ќл"е!o®еЌZ.ЅЅЌ2" уІ*ъ§)¶§Ќл"е!r®еЌZ.ЅЅЌ2"Ќ2" M®! 9Ќл"е!~®еЌ.ЅЅ! 9Ќл"е*ъ§)¶§Ќл"еЌ.ЅЅ! 9Ќл"е!w®еЌ.ЅЅ! 9Ќл"е*ъ§)–§Ќл"еЌ.ЅЅ√µІ*ь§)л!
 9Ќл"е! 9Ќл"Ќр"!  …DV FO FC FO: /FC: /               Ќ«≠! 9Ќл")л*≈≠Ќл"е! 9Ќл"  Ќw" ∆®! 9Ќл"+)л*≈≠Ќл"√…®!А "Д®Ќ”"л! Ќ.#"Ж®  ЌЩ" о®Ќ≤Ѓ!' еЌpЅ…*Ж® Ќ#еЌо)Ѕ"В®е!€€Ќ:" ©Ќ≤Ѓ! еЌpЅ…*Ж®)еЌо)Ѕ"М®е!€€Ќ:" 9©! еЌpЅ"И®√к©*Д®Ќ1≈’ЌCЃЅЅ"И®#ЌN" S©√к©!  "И®)л*М®е*В®Ќр"еЌvЃЅ"А®*И®#"И®л*Ж®Ќђ" Ъ©*И®)л*М®е*А®Ќр"еЌvЃЅ"А®√n©*Ж®е*М®е!
 9Ќл"ЌN" µ©!7 √Є©!8 еЌаЈЅЅЅ"И®#Ќ2" к©! 9Ќл"е*И® Ќ#л*В®е!	 еЌЙ.ЅЅЅЌ≤Ѓ*М®еЌу*Ѕ*В®еЌу*Ѕ!€€е*И®Ќ:" ™!€€√™!  …                  ! 9Ќл"!  "™! еЌ>Ѕ*Eе!№™еЌСЅЅ"$™#ЌN" e™*Eе! еЌЗЅЅ…*$™е!™е!	 еЌгЅЅЅ#ЌN" З™!€€""™√–™!  ""™!™е*™е!	 еЌ,,ЅЅЅ|µ –™*$™е!™е!	 еЌгЅЅЅ#ЌN" ∆™!€€""™√–™*"™#""™√Н™*$™еЌљЅ*"™…RC                                                                                                                                                    ! 9Ќл"+Ќ2" .ђ*≥"я™л! 9Ќл" Ќ#л*S-е! 9Ќл"еЌZ.ЅЅЌN" .ђ*я™л! 9Ќл"))))л*M-Ќе"& }жo)АЌл"е!
 9Ќл"Ќ:" жЂ!  …! 9Ќл"##ЌN" $ђ*я™))))л*M-Ќе"& }жoе*я™#))))л*M-Ќе"& }жoЌX"Ќ2" .ђ!  …! 9Ќл""lЂ!aЂе! 9Ќл"е!	 еЌЙ.ЅЅЅ! 9Ќл""pЂ!б™"jЂЌlЄ!aЂеЌЅђЅ#ЌN" tђ!€€…!aЂеЌЁЃЅ#ЌN" Зђ!€€…!aЂе! 9Ќл"е! 9Ќл"еЌД≥ЅЅЅ#ЌN" ђђ!€€…!  …                 !  "їђЌ«≠! 9Ќл" Ќл")л*≈≠Ќл"е! 9Ќл" Ќл"  Ќw" ≠! 9Ќл" Ќл"+)л*≈≠Ќл"√≠!А "љђЌ”"л! Ќ.#"њђ  ЌЩ" >≠!' еЌpЅ"їђ√Є≠*љђЌ1≈’ЌCЃЅЅ#ЌN" U≠√Є≠!∞ђеЌvЃЅ!∞ђе! 9Ќл"е! еЌ,,ЅЅЅ|µ ¶≠*њђ+"њђ|µ¬Ы≠! 9Ќл"е! еЌЗЅЅ"їђ√Є≠!∞ђеЌvЃЅ√]≠! 9Ќл" е*єђЌр"Ќ≤Ѓ*їђ…        !…Ѓе!“ЃеЌСЅЅ"њ≠#ЌN" м≠!…Ѓе! еЌЗЅЅ…!А еЌо)Ѕ"≈≠"√≠е!€€Ќ:" Ѓ*њ≠еЌљЅ! еЌpЅ…!€€"Ѕ≠*Ѕ≠#"Ѕ≠АЌУ"ЏBЃ*√≠#"√≠+е*њ≠еЌƒЅ—}√Ѓ…*њ≠е! 9Ќђ0≈’!  еЌБµЅЅЅЅ#ЌN" rЃ!…Ѓе! еЌЗЅЅ√uЃ!  …! 9Ќл""√≠!  "Ѕ≠*Ѕ≠#"Ѕ≠+хЌУ"ЏЃЃ*√≠#"√≠+е*њ≠еЌƒЅ—}√ЖЃ*√≠…*≈≠еЌу*Ѕ"≈≠*њ≠еЌљЅ"њ≠…AMIE.FRM RC       »ѓ!€€"’ЃЌЊЇ+ЌN" ѓ*џЃ6M*џЃе!÷ѓеЌСЅЅ"’Ѓ*’Ѓ#ЌN" 6ѓ*џЃ6A*џЃе!÷ѓеЌСЅЅ"’Ѓ#ЌN" 6ѓ*џЃе! еЌЗЅЅ…*’Ѓе! 9Ќл" Ќл"Ќ%1≈’А   Ќ
/≈’!  еЌБµЅЅЅЅ#ЌN" }ѓ*џЃе! еЌЗЅЅ"„Ѓ√Љѓ*’Ѓе! 9Ќл"	 Ќл"е!А еЌZЅЅЅА€|µ ґѓ*џЃе! еЌЗЅЅ"„Ѓ√Љѓ!  "„Ѓ*’ЃеЌљЅ*„Ѓ…?:FORMATS.DAT RB ГВХВІВєВЋВЁВпВГ  ! 9Ќл"Ќе"|µ O∞! 9Ќл"Ќе"÷€ЌN" ∞!ю€√N∞! 9Ќл"еЌ%єЅ"йѓ  Ќv"¬5∞*йѓ Ќw"Ќ2" K∞*йѓе!( еЌЗЅЅ√N∞*йѓ…ЌMµе!ўѓе! 9Ќл"ЌN" j∞!  √m∞! еЌаЈЅЅЅ Ќ#ГВ	 Ќе"…! 9Ќл"√√∞!* еЌpЅ√Ў∞! 9Ќл"е!+ еЌЗЅЅ√Ў∞! 9Ќл"е!3 еЌЗЅЅ√Ў∞Ќш"Р∞э€Р∞ю€Ы∞€€ѓ∞ь€  !€€…                                                                                                                                                                   *≥))))л*M-Ќе"& }жo)АЌл""а∞! е!  еЌь.ЅЅ"в∞ЌMµ"ё∞!к∞е! 9Ќл"}оo)≥Ќл" Ќ#л*S-еЌЃЇЅЅ!€∞"у∞! 9Ќл"}оoH Ќ##E Ќл""щ∞!к∞еЌЅђЅ#ЌN" ≤!€€…!к∞еЌЁЃЅ#ЌN" (≤!€€…! 9Ќл"|µ¬G≤! 9Ќл""ы∞!к∞"э∞√W≤!к∞"ы∞! 9Ќл""э∞!  "и∞!  "ж∞*и∞ЌN" u≤*ж∞ Ќf"Ќ2" _≥*ж∞)ЈЌл"ЌN" U≥*ё∞"№∞*ж∞)ы∞Ќл" 6 #6 *№∞+"№∞#  Ќw" љ≤*и∞ЌN"Ќ2" U≥√а≤*ж∞)ы∞Ќл" еЌл"#Ќр"√¶≤*ж∞)ы∞Ќл" Ќл"е*а∞ЌX" R≥*ж∞)ы∞Ќл"е*ж∞еЌЖЅЅ"д∞  Ќg" R≥*ж∞+ЌN" C≥*≥))))л*M- Ќе"& }жАoЌ2"Ќ2" L≥√∆≤! "и∞√∆≤*ж∞#"ж∞√c≤! е*в∞еЌь.ЅЅ*и∞+ЌN" |≥!  √≥!€€…    ! 9Ќл")Је! 9Ќл" Ќл"##Ќ2"Ќр"! е!  еЌь.ЅЅ"А≥! 9Ќл"+ЌN" ѕ≥! 9Ќл"ЌN"Ќ2" і*K- е*µ—}))))л*Q- 6€#6€*K- еЌе"#—}! 9Ќл"е! 9Ќл"еЌЖЅЅ"В≥! е*А≥еЌь.ЅЅ*В≥ АЌУ"Џpі*В≥#ЌN" Rі! 9Ќл" Ќл"##Ќ2"Ќ2" ^і!ь€"В≥*В≥е! 9Ќл"еЌЖ∞ЅЅ…! 9Ќл"+ЌN" Иі! 9Ќл"ЌN"Ќ2" Ті!  …! 9Ќл"}оoH Ќ##G Ќе"Љ€ЌN" жі*≥))))л*M-Ќе"& }жoе*µ))))л*M-Ќе"& }жoЌ:"Ќ2" µ! 9Ќл"е! 9Ќл"еЌ±ЅЅ*µ))))л*M- Ќе"& }жАoЌ2" Gµ!6 е!9 е! е!  еЌ!ЅЅЅЅЌ±(е€|µ¬Gµ!€€…!  …  !€€"Kµ*Kµ#"Kµ Ќ#ГВЌе"|µ oµ√Sµ*Kµ…              ! 9Ќл"))KЌл"ЌN" Ыµ!€€…! 9Ќл"))K##Ќл""wµ"yµ*yµ* Ќе"©€|µ¬ µ!€€…! 9Ќл"√ґ!}µЌµ0    √&ґ! 9Ќл"еЌYЈб!}µЌЇ0√&ґ! 9Ќл"еЌ€б!}µЌЇ0√&ґ!€€…√&ґЌш"‘µ  бµ цµ   √ґ! 9еЌђ0≈’!}µЌђ0ЌБ0бЌЇ0! 9Ќђ0≈’А   Ќv/Ќ31"sµ! 9Ќђ0≈’!А Ќ%1Ќq/Ќ31"uµ*wµ* #Ќе"љ€ЌN" Пґ*wµ$ Ќл"√Тґ!А "{µ! е*{µеЌь.ЅЅ*wµ! е*sµЌр"!! е*wµеЌь.ЅЅ|µ ∆ґ!€€…*wµ* #Ќе"љ€ЌN" мґ*wµ* Ќе"Ѓ€ЌN"Ќ2" 7Ј! е*wµеЌь.ЅЅ|µ Ј!€€…*wµ( е!А е*uµЌ”"Ќр"*wµ& е*wµ$ Ќл"л*uµЌр"*wµ/ е*sµеЌ`їА   Ќ
/бЌЇ0!  …  ! 9Ќл"))KЌл"ЌN" vЈ!€€Ќ%1…! 9Ќл"))K##Ќл""WЈ*WЈ* #Ќе"љ€|µ¬‘Ј*WЈ/ Ќђ0≈’*WЈ& Ќл"е*WЈ$ Ќл"Ќ”"А ’Ќ”"Ќ%1Ќ~0…√яЈ*WЈ/ Ќђ0……! 9Ќл")љЌл""W! 9Ќл""Y! 9Ќл""[! "c"_!Wе! е!  еЌsЅЅЅ…!№€9щ!& 9Ќл"е! 9еЌЂ-ЅЅ! е!А еЌь.ЅЅ! е! 9еЌь.ЅЅ#ЌN" aЄ!  √dЄ! л!$ 9щл…! е!  еЌшЇЅЅ!$ е!А еЌдЇЅЅ!' е!  еЌдЇЅЅ! е! еЌџЇЅеЌшЇЅЅ…  *ж)#|µ¬іЄЌд#*д)"¶Є*¶ЄЌл"#|µ “Є*¶ЄЌл""¶Є√ЇЄ*¶Є Ќл"+|µ¬хЄ! 9Ќл"6 #6 !€€…√ є*¶Є 6#6 ! 9Ќл"е*¶Є##Ќл"ъ€Ќр"*¶Є ……    ! "#є!  "!є! 9Ќл"Ќе"√Sє!€€"#є! 9еЌл"#Ќр"√`єЌш">є- Dє+   ! 9Ќл"Ќе"0 Ќg" Гє! 9Ќл"Ќе"9 Ќf"Ќ2" ѓє*!є
 Ќ#е! 9еЌл"#Ќр"+Ќе"—–€"!є√`є*#єл*!єЌ#…! 9~!  ю0Ўю:–,…! 9Ќл"√џє! …√мєЌш"‘є  ‘є	 ‘є
   !  …        ! 9Ќл""тє  Ќv" Ї*тєЌЁ""тє! 9Ќл""фє"цє*фє#"фє+е*тєл!
 Ќ3#л0 —}*тєл!
 Ќ3#"тє|µ¬!Ї! 9Ќл" АЌУ"ЏhЇ*фє#"фє+6-*фє6 *фє+"фєл*цєЌЂ" ¶Ї*цєЌе""рє*цє#"цє+е*фєЌе"—}*фєе*рє—}√mЇ! 9Ќл"…Ѕб—’е≈+#~Ј¬µЇ…! еЌџЇЅ. |жg|µ „Ї! √ЏЇ!  …! 9NЌ …бЅ—’≈е* kЌцЇoЯg…й…бЅ—’≈е*ng to integer */
BYTE	*s;					/* String to convert	*/
/*======================================================================*/

{

LOCAL
WORD	x,
	y;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

x = 0;
while ((ishex(y = *s++)) != 0) {
    if (y > '9')  y -= 7;
    x = (x << 4) + (y & 0x0f);
}

return(x);

}

/*======================================================================*/
/*
.he                                                           SETLIB(NUMERIC)
.pa
*/
/*======================================================================*/
WORD                                                /*			*/
numeric(c)                                          /* Check if numeric */
BYTE	c;					/* Byte to check	*/
/*======================================================================*/
{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((c >= '0' && c <= '9') ? TRUE : FALSE);

}

/*======================================================================*/
/*
.he                                                             SETLIB(ISHEX)
.pa
*/
/*======================================================================*/
WORD                                                    /*		*/
ishex(c)                                                /* Check if hex */
BYTE	c;					/* Byte to check	*/
/*======================================================================*/

{

LOCAL
WORD	ch;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

ch = upper(c);
return((numeric(ch) || (ch > '@' && ch < 'G')) ? TRUE : FALSE);

}

/*======================================================================*/
/*
.he                                                              SETLIB(ITOA)
.pa
*/
/*======================================================================*/
BYTE                                  /*				*/
*itoa(s,x)                            /* Convert from integer to string */
BYTE	*s;			/* String to receive the integer	*/
WORD	x;			/* Integer to convert			*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (x > 9)  s = itoa(s,x / 10);
*s++ = (x % 10) + 48;
*s = NULL;
return(s);

}

/*======================================================================*/
/*
.he                                                             SETLIB(ITOHA)
.pa
*/
/*======================================================================*/
BYTE                              /*					*/
*itoha(s,x)                       /* Convert from integer to hex string */
BYTE	*s;			/* String to receive the integer	*/
WORD	x;			/* Integer to convert			*/
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

*s++ = hexify(x >> 4);
*s++ = hexify(x);
*s = NULL;
return(s);

}

/*======================================================================*/
/*
.he                                                            SETLIB(HEXIFY)
.pa
*/
/*======================================================================*/
STATIC WORD                                           /*		*/
hexify(n)                                             /* Convert to hex */
WORD	n;					/* Number to convert	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n &= 0x0f;

return((n > 9) ? n + '7' : n + '0');

}

/*======================================================================*/
/*
.he                                                             SETLIB(LOWER)
.pa
*/
/*======================================================================*/
WORD                                             /*			*/
lower(c)                                         /* Force to lower case */
BYTE	c;					/* Character to convert	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((c >='A' && c <= 'Z') ? c + ('a' - 'A') : c);

}

/*======================================================================*/
/*
.he                                                             SETLIB(UPPER)
.pa
*/
/*======================================================================*/
WORD                                             /*			*/
upper(c)                                         /* Force to upper case */
BYTE	c;					/* Character to convert	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((c >= 'a' && c <= 'z') ? c - ('a' - 'A') : c);

}

/*======================================================================*/
/*
.he                    kй…! Ќш0! еЌ7їбхЌ	1¬їс√%їс! “%ї-—ЅЅ’-…! Ќш0! √ї! 9~У_#~ЪW#~ЩO#~hgШGх|≠тUїс?…с……ге!1√mїге!1√mїге!%1≈’е! 9Ќђ0б’Бї’е`i…! 9ЌЇ0б—Ѕ…е!51√Юїе!31√Юїе!31≈’е!
 9Ќђ0бЌЊїDM! 9^#V#ЌЇ0—Ѕбс…й…                 ИБ  $@   	   " "ИИ"  HИ ИА	"    @  @DD                     @Р    HС D   $DА   Д  DААЙ А СИ$H Й                                     H     $АA"ВDИБ@Б @H@С Р В	  Д@   H  H @$ АHH@@А@Р	@ Р$DВ Б @I I  I $А@	 РИИБ @	 @	     	 $	 $ РBHАHВA""IDБ А$ $ $Б HА  !  "$@Б ТI!D   @Р	 	 $Б Б@$@Р	 АР $ $ $ СHВ@$ СДIВ@Р$	@В   @В@   Д  	        А  I РЙ A" D А  $  @  	   @Р   HА$A$IИ Р IИ$Й" $ ТI      DА И    А   А H РВA РIИБ  AА@ААВ       В 	 Р "ИА А @""                           А Т   АРРИАH@ IС I"  Р" $ИА HА 	  A ИА HБАI@"	   $I	$ P HАС$   АР  @Р A DР A  	  А "A @ I  Р	"HА             	 	     Р	""@ АHА С $ HВ   D/*
.he                                                                 ANALYSE.H
.pa
*/
/*======================================================================*/
/*                          ANALYSE.H					*/
/*======================================================================*/
/*USE
Portablilty	Level 1
Parent Module	ANALYSE.C
Revision History:-
14/09/89 Brought up to Timeclaim standards from version
         dated 08-06-85 - ICFO
*/

/* ANALYSE Header file containing declarations for all Global defines	*/
/* & variables.								*/

#define		THREEHALF	2
#define		EIGHT		3		/* Define drive types	*/
#define		FIVEH		4

#define		RC	*256+

#define		C_LEFT	  0x81		/* Cursor key equivalents	*/
#define		C_RIGHT   0x82
#define		C_UP	  0x83
#define		C_DOWN	  0x84
#define		SC_UP	  0x87
#define		SC_DOWN	  0x88

/* Global variable declarations. These should be stored in successive	*/
/* memory locations.				     			*/

/* Configuration data/Drive specification				*/
#ifdef	EXTERN
EXTERN
#endif
struct	drec	{
	BYTE id[9],		/* Drive identifier			*/
	     addr,		/* Drive address			*/
	     type,		/* Drive type				*/
	     tpi,		/* Drive tracks-per-inch		*/
	     trk,		/* Drive tracks-per-surface		*/
	     sides,		/* Drive sides				*/
	     stepr,		/* Step rate (ms)			*/
	     hload,		/* Head load time			*/
	     settle,		/* Settling time			*/
	     hsp;		/* Dual speed opt			*/
} *drvdat;

#ifdef	EXTERN
EXTERN
#endif
BYTE	*p,
	autofl,		/* Auto run flag, set by -a option		*/
	reqdrv,		/* Requested drive from command line		*/
	*ex_com,	/* Command for follow-on exec			*/
	*ex_arg,	/* Arguments for follow-on exec			*/
	buffer[80],
	deflt[20],
	drive,
	omega,		/* Speed / Data Rate selector			*/
	density,
	*data,		/* Pointer to data file area			*/
	side,
	track,
	sector,
	status,
	*fsthead,
	*start;

#ifdef	EXTERN
EXTERN
#endif
WORD	rot,			/* Set to 1 if drive is variable speed	*/
	sectsz,			/* Sector sizae as in the Sector Header	*/
	i,j,n,
	limit,
	offset,
	fstdrv,
	maxdrv,
	adl,
	fstsec,
	maxsec,
	sides,
	gap1,
	gap2,
	gap3,
	secsize,		/* Sector size in bytes			*/
	fmttpi,
	hitrack,
	channel;


#ifdef EXTERN
EXTERN
BYTE	tfl[],			/* Drive translation - from logical	*/
	ttl[];			/*  "         "      -  to  logical	*/
#else
BYTE	tfl[]={1,2,3,0,5,6,7,4},		/* - from logical	*/
	ttl[]={3,0,1,2,7,4,5,6};		/* -  to  logical	*/
#endif

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее                                          SETLIB(RAISE)
.pa
*/
/*======================================================================*/
VOID                                  /*				*/
raise(s)                              /* Convert a string to upper case */
BYTE	*s;					/* String to convert	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (*s != 0)	{
    *s = upper(*s);
    ++s;
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                              SETLIB(ZERO)
.pa
*/
/*======================================================================*/
VOID                                          /*			*/
zero(pointer,length)                          /* Zero an area of memory */
BYTE	*pointer;			/* Address of area to zero	*/
WORD	length;				/* Number of bytes to zero	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	pop	de	; Get return address
	pop	bc	; Get length
	pop	hl	; Get pointer
	push	hl
	push	bc	; Restore
	push	de
z$l:	ld	(hl),0
	inc	hl
	dec	bc
	ld	a,b
	or	c
	jr	nz,z$l
	.8080
#endasm

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(WAITCR)
.pa
*/
/*======================================================================*/
VOID                                               /*			*/
waitcr()                                           /* Display a message */
/*======================================================================*/

{

/* Display a message -  "Press <RETURN> to continue".			*/
/* Abort on ESCAPE, or do screen dump on a ^P.				*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(23 _RC_ 20);
putstr("Press <RETURN> to continue");
while (TRUE) {
    switch (getkey()) {

	case ESC:
	    abort(1);				/* Break on ESCAPE	*/

	case CR:
	    return;

	case S_DUMP:
	    scrdump();				/* Screen dump		*/
    }
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTNUM)
.pa
*/
/*======================================================================*/
VOID                                           /*			*/
putnum(i)                                      /* Print a signed number */
WORD	i;					/* Number to print	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (i < 0) {
    conout('-');
    i = -i;
}
if (i > 9)  putnum(i / 10);

conout(i % 10 + 48);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETLIB(PUT2D)
.pa
*/
/*======================================================================*/
VOID                                  /*				*/
put2d(i)                              /* Print a 2-digit decimal number */
WORD	i;					/* Number to print	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (i < 10)  conout(' ');		/* Leading space if < 10	*/

putnum(i);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTHEX)
.pa
*/
/*======================================================================*/
VOID                              /*					*/
puthex(n)                         /* Print a 2-digit Hexadecimal number */
WORD	n;					/* Number to print	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

conout(hexify(n >> 4));
conout(hexify(n));

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(STRCMP)
.pa
*/
/*======================================================================*/
WORD                                /*					*/
strcmp(p,q)                         /* Compare two strings for equality */
BYTE	*p,				/* First  string to compare	*/
	*q;				/* Second string to compare	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

for (; *p == *q; ++p, ++q)  if (HH       А  H @Р    H "$   В	I H  DЙ@  ""DH  DБ    $ A @"  HР$   "A"!   И	В@Р А С@HРИ	 Р Т $I A" А    А@@I H @ @$B	@  "DHАР ТА  DBС@@Р А ИA"D $ $Б   В"DI @Р А ИA$@@ А  @I@                         $     @  H  	   $	!   А  АH   ! D  @                                      H   ИА 	 @С  "  А  " Б @С  ТD@ $И     "   А	I" $@@ А А           А  @ АH А Р А РБ Д DИВB"HА@А 	 A       	   $Й                         А    @ 	     @   $С  @    @    А @ $ААI  " $D $ DА @  $@$B D  H @ИD И	  $	АH Б  А    H I    $ $  *™А @   $ $D @А      !                        I    !    HАБ ТH$ $ HА И@$И "  "	    РI                	  А                      $@ @     $   А  B"       	  H @А $  @А   @D       $ @ А                   А   А  АHВH @ 	      А !     Р   D   !   @$С  Д И!ВD    В   А   АИ    @     @     $@$B D  H @ИD И	  $	АH Б  А    H I    $ $  *™А @   $ $D @А      !                        I    !    HАБ ТH$ $ HА И@$И "  "	    РI                	  А                      $@ @     $   А  B"       	  H @А $  @А   @D       $ @ А                   А   А  АHВH @ 	      А !     Р   D   !   ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕРSРSTаШBDRVDATБРUU—У e$UE%ha}=6EX_ARGБРХQССT†TDTd≈HI%YOMEGAБСSФ“U DDDM%TRACKБФ—P’‘†e5DEU8MQ!STARTА‘У’ e4T5E5®*NБSSRU dфde4UHMQIZMAXDRVА–Q de5E4T85aMSIDESБ–T`Dt(@ќSECSIZБСУU`dДХE$8!99TFLА’ D$Фх85	QaRDRVTABАУTаU5DU(MQQ1MAINБPQ%@RаЙp                                                                                                                                                                                         ЦА  @@0  ј C®) J©–к
rj
t8ВЬ§ѓ І*#C®)…Й(PкЪ*ҐBЉЇМ             KD † 6фБ@АЋ4  rИ@АЋ6НА9YґьВЅА Q еfА ЖКєY† B  9D!аХЫM ,.r≥iиB 9D  ХЫR@, еfА q f№06h   Ј` !  ђ– ВЅfА –  UБАЛVUї   Vh  Ѕ``(Ђ 9Y† ВЌ  5x *јјQV r≥@ Г-ї fА Щup       џр 9f“0XЛW @@Ћ6в ƒb-d !  £,
 *’ј≈Ђ*ЁБ
µР6зА3@  ЛMю>-YWшUђАb1≤ КўЈ§Ы{ ј+4  `ЯFX UЂАb-\ !њѕ£,№ :ј†–  "0 3@ U;`Pm$О – Ъ  2≠PЗ 9D5д Ќ  ,÷ f”0иЋ D иЋА@ иЋ	 @   ` m>-YVЬCВАҐђ  еfА 	сj¬≥@"ђ  А,Џа}*p == '\0')  return(1);

return(0);

}

/*======================================================================*/
/*
.he                                                            SETLIB(GETLTR)
.pa
*/
/*======================================================================*/
BYTE                         /*						*/
getltr(rowcol,t,s)           /* Get a single character from the set 's' */
WORD	rowcol;			/* Cursor position			*/
BYTE	t,			/* Default character			*/
	*s;			/* String of acceptable responses	*/
/*======================================================================*/

{

LOCAL
BYTE	*p,
	*q;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

deflt[0] = t;
deflt[1] = NULL;
while (TRUE) {
    getfrom(rowcol,deflt);		/* Get a letter			*/
    p = s;				/* point to Set			*/
    smove(rowcol);
    conout(t = upper(buffer[0]));
    while (*p != NULL && *p != t)  ++p;
    if (*p != 0)  break;
    strcpy(buffer,"Entry should be ");
    p = buffer + strlen(buffer);
    q = s;
    while (*q != NULL) {
	*p++ = *q++;
	if (*q != NULL)  *p++ = '/';
    }
    *p = NULL;
    error(buffer);
    smove(rowcol);
    conout(' ');
}

return(t);

}

/*======================================================================*/
/*
.he                                                              SETLIB(SKIP)
.pa
*/
/*======================================================================*/
BYTE                                                 /*			*/
*skip(p)                                             /* Skip whitespace */
BYTE	*p;				/* Pointer to string to search	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while(*p == ' ' || *p == ',')  ++p;
return(p);

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTSAT)
.pa
*/
/*======================================================================*/
VOID                                           /*			*/
putsat(rowcol,s)                               /* Put a string at (r,c) */
WORD	rowcol;					/* Cursor position	*/
BYTE	*s;					/* String to display	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(rowcol);
putstr(s);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                           SETLIB(PUTSFAT)
.pa
*/
/*======================================================================*/
VOID                         /*						*/
putsfat(rowcol,s,w)          /* Put a string at (r,c) in a field of (w) */
WORD	rowcol,					/* Cursor position	*/
	w;					/* Field width		*/
BYTE	*s;					/* String to display	*/
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(rowcol);
for (i = 0; i < w; ++i)  if (*s != NULL)  conout(*s++);
			 else		  conout(' ');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTCAT)
.pa
*/
/*======================================================================*/
VOID                                 /*					*/
putcat(rowcol,l)                     /* Put a single character at (r,c) */
WORD	rowcol;					/* Cursor position	*/
BYTE	l;					/* Character to display	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(rowcol);
conout(l);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTNAT)
.pa
*/
/*======================================================================*/
VOID                                           /*			*/
putnat(rowcol,n)                               /* Put a number at (r,c) */
WORD	rowcol,					/* Cursor position	*/
	n;					/* Number to display	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(rowcol);
putstr("     ");
smove(rowcol);
putnum(n);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETLIB(PUTHAT)
.pa
*/
/*======================================================================*/
VOID                                       /*				*/
puthat(rowcol,n)                       fаІ`  ИH ` laЁј÷ f’ КэюuКіH6ЬА≤ЃxлА3mpE~€Ї≈Z,Ъ  3iа*о И@ иЋ7 Kw GYЄЫpАDg≈Ђ
€ ≥m8 ЖјєGXЫx \ђџl Ѕ`≥mаЈш[ь*’ј±Ѓ ЯђЂv*÷@1ЛY 
≈lЏ"÷ ≠` Ќ≤ !Ыь2|Z≤©и6фАИm ;ФUђ ђџоЅ`≥oаЂX ƒZј Uђ і|L >єЛжц®А@—Ц aџА!V∞ ИµА Л 
µpсj ± B≠d #ИµР ђVЌҐјB, *’ј±Ѓ aЎр!-`АЄf“∞!ЇrКµАХЫMАШ,m;aџА&h TјИ 
ЇE   ;$√њј2џ∞&HД rИB +6ѓ 0X"Юеf’ 6кБ2Yґ B 9D  ХЫq@Ш,m£dЋ≠     [“-й9GѕwiеЏxc87Шp @® 2ЌҐ`n“£  @Є 2~jР ј“*‘`Qсr≥l В|Z≤©`6ё3n®ЂQА@† »ЛZ µ∞ Ђ[ ƒZЎ U≠ b1і f„†!І k@ И( k@Vі f‘Р1• k`mHh∞  "— ≠ )КE.±VІ ≥k(Ш }sЌмЏв  ≤†b≠ лhРh  ЌЇ ,ЂJ*— 1Й a„ 1VЛ rКіH4  Б@џЪ Є@b≠ А"- …`Pmу>-XWDЫu@ўЈ`У.Є       [™! АҐ  ЌѓаЂDАµј ЂEА:≈ZаЫdјўWЗ@БZа F"„ ;–! АҐ≠p еhРm≠Гј–  ЌЉ LД@ r≥@ Ђ\ H  ЋХЫHA"кеf№а&Ђ\ B@muКµ( e Ќ¶†МVЄ КE"ЧXЂSАYµфL >єБжсЇ ААQVЄ rКіH6ЗAаm?r≥hј#В! ђЏZЅk†0 ъжЫ¬4  2ЌЂ В-x *„АVh  ЅяРw+6§0EZа " 3k®#ђU©@!H 2еfЏPFь≤e„ј    -√ РИdB)ОH$ТЙdЅАј`0  ЂEАµр FбВFј |Z≤ѓ0лА3n8ЛFА3l0*оВИA@(Д( r≥k»#В!њ†оVmЉ`Кµр МEѓАaЖrИk8Л  A  Ћ6…ВF  ЋDъr≥l#UА !  dEА і†ЫeАўU№B, 9YіћВ*„ј1Њ Дn e *ј H 2Ќ® °А 2—>ДЬђЏЬ
Ѕa”`QVЊ №0@»Ў !°aVm`КіH DВ єYµƒВ!Ґ!VmЕ`КіX DА єYґDВ!Ґ°VmЩ`И_пч(Д  r≥nрВ! ђ–  L rИ@ (ЂDАn e Ќ  ,E£@Z4 "0 3iP*щКіh Dp fџРmDeUаa
 rИk»;ХЫRАX,VН >М∞А Д@ >М∞И Д  >М∞Р ЖПИ∞  Ђ  3k0)сj Ђ`¬ е` +6ОБ∞X'≈Ђ
І
∞  D ≥i 1фeЫАulUА !  dEА tАЗpЕZ4 "њЖE"СH•÷*‘аЦmE Ѓ`9Љ#B ,Џё}fа` V  f„јcв’ХpШvМUА !  dEА v UА  Р eЫcЬ£ђ№ ЌЊ М– ХoAШw ЗeБ•Є ¬ђ  Ќµ`«≈Ђ
оГ_пуиЋ7 hЎCХЪ  0XwАЗxЅШwРuЫАґ»#@ ,џИ}fаV  Д ЦmоjјV  ГАЦmь Z® B  2H&г	∞тs2И∆SСћ“o7Apј`  AМR 2Ќ"ЩЉћt;ШNFQ ƒr8¬°§Џe1Ы&УhАШt2#СјаX1О ЉЏm0ЫМВаФж Ь«¬qЉи 3ќ¶г ( D)JƒQ  Иr4ЭМҐ)М@i9И∆у†АёnУШАжy9Э¶–P ™n9Lfу9Є“s2ЩСЬкm2ЫОВрФж *ЫНfгy№№ 0ЬМзSiФ№tДІ0 ®T*	∆у†А¬ #ЩM¶Уq§@M#Д3…ћиe6ИB°P® M#АиА ) Sq– rFУ±Ф@[ уРА  И ТиАZ  ћ&б9–@l7Шћ'C(А»r4ЭМ†ЌH.SWITCПFА4D»Ћ8ALLOCМ¬ dд≈Х8р AUTOFLПQАD$Фх8рPBUFFERМшƒ2дtXѕАC.GTМтƒ2дƒXЌШC.LTМ„Вd2д’T≈Hѕ∞%C.NOTМуГT2е5ЕHхCHANNEМ№Вд4≈$Tх8»ИCLRSП8АDDDт–DEFLTП8 dDTе4ХHуpDRIVEП  dE%dDHх8DRVTABМЏГ$RиѕШ+E.0МлГTU%$х(ЌEXECМъDUДХHр@EX_ARGП dUЕф4фЎћ∞FCLOSEПNАdd’EEШћРFOUTПDАde5DE%hуЄFSTHEAПGАde5E4T8»H:G.ПJАDtфЄGAP2ПLАDt8ќ†.GETLTRМЃ§Вић6HARDWAОкБƒДTHфшHITRACП?АШфJПBАTƒФ‘ХHиАMAINПEАd‘ДE%hфИMAXSECПRАd‘d%EЕH» ,MOVEПTА$’8фNПCАdфde4UHуxOMEGAП ћШPRNF_1Мѕe$дeу(ћи&PUTNUMМ÷ВеUE5E(Ќ(.PUTVIDПАe$UE%hуЎROTМЈВ%2ифЎSECSIZП:Аe4T5Dх(уиSECTSZПV e4UEDƒXуШSIDEПIАU4ФDU8у»STARTП; e5DEU8хPSTEPRМЪe5E$4’»6STRCPYОА 5Dd»»XTOUPPEП: UE$4Єи@TTLМлeTдƒф4Єќ-WHEREЬ   ЮПTА$’ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                              ANLIB(ERROR)
.pa
*/
#include	"portab.h"

EXTERN
BYTE	buffer[],
	deflt[];

/*======================================================================*/
VOID                                /*					*/
error(p)                            /* Briefly display an error message */
BYTE	*p;				/* Error message for display	*/
/*======================================================================*/

{

LOCAL
WORD	i,
	j;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

hil_on();
cur_off();
for (i = 0; i < 4; ++i) {
    clreos(23,0);
    move(23,25);
    putvid(' ');
    putstr(p);
    putvid(' ');
    wait(2);
    clreos(23,0);
    wait(1);
}
hil_off();
cur_on();
clreos(23,0);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                               ANLIB(WAIT)
.pa
*/
/*======================================================================*/
VOID                                                   /*		*/
wait(i)                                                /* Delay routine */
WORD	i;						/* Delay	*/
/*======================================================================*/

{

LOCAL
WORD	j;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (i-- != 0)  for (j = 0; j < 8000; ++j)  continue;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            ANLIB(MOVESTR)
.pa
*/
/*======================================================================*/
VOID              /* Move a string from source to dest for max length l */
movstr(dest,source,length) /*						*/
BYTE	*dest,				/* Pointer to destination	*/
	*source;			/* Pointer to source		*/
WORD	length;				/* Number of bytes to move	*/
/*===    /* Put a hex number at (r,c) */
WORD	rowcol,					/* Cursor position	*/
	n;					/* Number to display	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(rowcol);
puthex(n);
putstr("   ");

/* Let C/80 supply the return						*/

}
/*======================================================================*/
/*
.he                                                            SETLIB(SEEKRC)
.pa
*/
/*======================================================================*/
STATUS                      /*						*/
seekrc(fdes,offset)         /* Move to another position in an open file */
WORD	fdes,		/* Channel number				*/
	offset;		/* Number of 128 byte records from file start	*/
/*======================================================================*/

{

/* The read / write pointer for the file open on channel 'fdes' is	*/
/* moved to 'offset' 128-byte records from the beginning of file	*/
/* Returns FAIL for error, else SUCCESS.				*/

LOCAL
WORD	sector;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

sector = offset;
if (pos(sector,fdes) != SUCCESS)  return(FAIL);
IOrw[fdes] = 0;
IOind[fdes] = 0;

return(SUCCESS);

}

/*======================================================================*/
/*
.he                                                               SETLIB(POS)
.pa
*/
/*======================================================================*/
STATUS                                          /*			*/
pos(sector,fdes)                                /* Position over sector */
WORD	sector,		/* Number of 128 byte records from file start	*/
	fdes;		/* Channel number				*/
/*======================================================================*/

{

/* Returns SUCCESS, FAIL for error					*/

LOCAL
WORD	*p,
	fcb;

LOCAL
BYTE	*q;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

q = p = 33 + (fcb = IOfcb[fdes-1]);
*p = sector;			/* Set sector number			*/
q[2] = 0;			/* Zero high byte 			*/
IObuf[fdes];

#asm
	MVI	C,26		; Set DMA address
	XCHG
	CALL	BDOS
#endasm
	fcb;
#asm
	XCHG			; Read random to set file pointer
	PUSH	D
	MVI	C,33
	CALL	BDOS
	POP	D
	ORA	A
	JZ 	pos1		; No error
	MVI	C,34		; Error: probably past EOF
	CALL	BDOS		; So try writing next
	LXI 	H,-1
	ORA 	A
	RNZ			; If still can't, give up
pos1:	DS 0
#endasm

IOsect[fdes] = sector;    	/* If success, remember where		*/

return(SUCCESS);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—UP†TU%$х(AUQMQJWAITБТ—УT“ d‘хe5E(MQIAfLDIRMБSУ`eUDƒФи	JCRLFБС—USХ DХDфQI>ATOIБФUРU dtUDДUИ%Q=!AHTOIБФUU dtUCDДXQMQJSCANБS’—T†dеT‘U$Ш%M!bUPPERБTРRT—`E§U$ш]%QJPUTNUMБTUС eUDДUИMQI5BGETLTRБ““T eUE4HAUQMPUTCATБФ—QR‘Ра5х9A ÷Ф*\    K@ †  Д  ` V  њOм– µ`@tИ UА b,  √°  rЌ  ђ– ВлАА–  "( 5Y†  D єY† B  9Y† B YіЬ ЌЈа,А еf‘†Д r≥l–B 9D  ХЪ  0X" Ќ≥@ fА – Ыbј2Ў∞h  |Z≤ђ»≈А0мX&\   KfА%≥@ rеf’ [4  ЯђЂ® !  X UАА,6И 6ЃИеА
∞ МEААv»Зp@wЗfА2а@  [™ !  X B YґА÷*јА– ХD D ` е ЌЉ 6m§ єD ` е ЌЊ@6mц ≥@ Йф$Ќ  і8ХH EX F"јА;ґ ! .Vm КўіUБ b, #А – ХSјD ` еЫIАYі "аЖY† 6ИА≤Ђ@Д єYµVЌ•`"6mFa“– 9r≥jЎНЫWјFјLµ№B \ђЏ№#f„ [ФB \ђЏъ#fЎ[6±АіO°&mPeZ@wa„pLґФЇб`ЄZ-W+Џ∞nЇY2џ лЕВбhµ\ђWjбЇйdЋoјD   еЫbјYґLшµe^` 9r≥n НЫcјElџОеf’аяА≤D   еЫu \ђџ~ЅВАVmа`≤D –ХЫ~ X,С( еf–&&\   KCАД  ФB YЈ∞ ЌЃ@МД ≥hЄФCCјЬђџђЅ`И@ +6≥∞DX B YіР	 *јјVmc	`∞EXУ.   %™ BPеБ Цm@r≥nЎ#В! ,Џ≤е’'+6л0X"bеfЏ†6Ш "Ѕ   rЌђјNQV r≥lАKВ*Ѕ ЩpP  -Ф÷†'(Д ≥l ХЫvЅ, 9fў–'(Ж Б9YЈX	ВЅ„0'+6’∞DX( B Yґ®	 *Ѕ@VmР	`∞EX(Т! ,џМеf‘ 6БО≠Є4  >-XTCyАЬҐ  rЌї`NVmw`∞Y"веФ Vh  Ѕ`Яђ™N:†`lџ“|Z∞©8Д r≥@ іЬCE@№ђЏ`ЅdЋL ƒ   еЫ~@ЩЈp"аЖOЛVVААЧ+6ЪБИўЈ`VЌІ l:`! ,ЏТЌ™ nVmh`≤eЅА  µШB  ∞` Д ≥jЎ6ѓєYіВ|Z≤≠0Ђ A@h  еБ Ч+6ЄБИўµ4VЌЃАaГь2—И∞`ґК∞`&\     Џ†1  "Ѕј rеfў 16 Кўґ`EД ђЏ\ЅfўРUэa  ЛюЌЈ +»*¬ Ћь2"¬ ђ )КE.QV  Ѓ`yљҐ`а∞`аHД ≥mрD` fА ™<! ,ЏА† 6дБ≤©P Д a“–A  …Ч	   “аA 9f—`G+6–В∞DXH UДАђЏЅ>-XUИUДА$ 6ЬА≤™ш Ђ	 Hаmз f—рFm`eVаA √Ѓ В Т! ,џl{ўЈT•iБ @ е ! ,ЏоеБАЦmМuИA@m3 r≥kР#ВЌЈ@b  rеfў@A6“
№Ґ  rЌµАО±( Ќ≥`О∞Иј hЯBB  rЌЈ Г` Д ≥nx#&\(   KvЅ @ е Ќї В6m∞єD @ еЫxAb Ъ  9YііВ—>ДД @ е ЌљјВ6mеєD @ еЫAA\ђЏZ
ЅhЯBB  rЌҐ@£` Д ≥i+$B \ђЏT
& \ју{6ДВИ@@Ћ6ЩВДA mQeUјQ 9f‘0PИ№ a÷pQ 9f’0PИј dИ@@Ћ6ЩВH meXPQ 9f÷–PЙh Ќ£АМЏ∆ ≥ Ґ rЌѓ†°  2√і Ґ rЌ≤ ђС 9f===================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i = 0;
while (i < length && (*dest++ = *source++) != NULL)  ++i;
dest -= 2;
while (i-- > 0 && *dest == ' ')  dest--;

*(++dest) = NULL;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                          ANLIB(MOVEBYTES)
.pa
*/
/*======================================================================*/
VOID                         /*						*/
movbytes(d,s,l)              /* Move bytes to dest to source for length */
BYTE	*d,				/* Pointer to destination	*/
	*s;				/* Pointer to source		*/
WORD	l;				/* Number of bytes to move	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (l != 0) {
    *d++ = *s++;
    --l;
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             ANLIB(PUTLIN)
.pa
*/
/*======================================================================*/
VOID                    /*						*/
putlin(p)               /* Print a line of characters followed by CR LF */
BYTE	*p;			/* Pointer to line to be printed	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putstr(p);
putvid('\n');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                                 ANLIB(CR)
.pa
*/
/*======================================================================*/
VOID                                                    /*		*/
cr()                                                    /* Do just a CR */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putvid('\r');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                               ANLIB(CRLF)
.pa
*/
/*======================================================================*/
VOID                                                 /*			*/
crlf()                                               /* Do just CR & LF */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putstr("\n");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             ANLIB(GETINT)
.pa
*/
/*======================================================================*/
WORD                    /*						*/
getint(r,c,defval)      /* Read in a positive integer from the keyboard */
WORD	r,					/* Row			*/
	c,					/* Column		*/
	defval;					/* Default value	*/
/*======================================================================*/

{

LOCAL
WORD	x;

BYTE	*itoa();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

itoa(defval,deflt);			/* Convert the default		*/
if (getfrom(r,c,deflt) == FAIL)  return(-1);
x = atoi(buffer);
itoa(x,buffer);
move(r,c);
putstr(buffer);

return(x);

}

/*======================================================================*/
/*
.he                                                            ANLIB(NUMERIC)
.pa
*/
/*======================================================================*/
BOOLEAN                                             /*			*/
numeric(c)                                          /* Check if numeric */
BYTE	c;					/* Character to check	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((c >= '0' && c <= '9') ? TRUE : FALSE);

}

/*======================================================================*/
/*
.he                                                            ANLIB(GETFROM)
.pa
*/
/*======================================================================*/
STATUS                       /*						*/
getfrom(r,c,deflt)           /* Read in a string to the buffer from X,Y */
WORD	r,					/* Row			*/
	c;					/* Column		*/
BYTE	*deflt;					/* Default value	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(r,c);
if (getstr() == -1)  return(FAIL);
if (*buffer == NULL)  strcpy(buffer,deflt);ўаPЙД ЌЃ`ђЂ|
! ,џL
= ґЫaБYWHB YґЎ"аЖXwdB YЈ$У-ЏААЦmafЁpSв’ХDБД   еЫwЅ\Ґ  rЌљјђџƒ
еfЏVDъААЧ+6ыИўірЗvБY2—0fЛ¬еbµFј,р±>"†] ЌїаLs
r≥mшB ђ™∆Ќ  u<B 9YіРВ…fА :јЌ  * 0lRБ†
Т   :d…ААЦm	АЏъЏ±ј¬h Ќ°@L 9rИ@АЋ6іГ3@ mААЦmЖљПмЏё“ґ ¬ rЌ≤`ќ±( ЌЄ ОVmd`И@@Ћ6—Г:ƒ †6’:¬#  e Ќѓ ћHД ≥m∞0EмfўРf’вИ Vm∆`И@@Ћ6зГ9YµРВ…ААЦmзuИ@Аmхr≥ih+ Ќїаћ 9fя@g+6ЦВ∞\ђЏЅdЋFAƒ @ еЫCўЈд ! ,Џ<Ќ§ м– ХZЎuHB \ђЏR#fЎјa 9r≥iи8НЫPAЎtdB Yµ$ЫKѕЛVeА@Ц7А Щp∞     K[ƒ @ еЫVБѕ£+\!  £) uА@≈Ђ*¬@јЋ6ЂГєD5р ЌЇјLД ≥lX8Л @јЋ6ќєYіЬВ! .Q’(f—А7+6–В∞Z'–УХЫEAЎ"ђ, ЌЃ мџ~
 Љ@вђ, Ќє оQ 9fЁPvh  ЌєАмЂд*¬ј1 a№PqV fЁ–sв’Х@v ClЅ№Ґеf„pC@BђЏV Ѕ–аА»Л @@Ћ6”И∞ј Ђ 3o∞9сj ђђ, #a`[ФUЖ b,0 +f“†ЖЙф$*√ ЏЖ|Z≤™и@Ђ ƒXX V6∞й0@Ђ А,еf– Д ≥iCХЫjБЎ"  ЌЄ@м~Б ЦmLdЋc   еЫ\Вґ$ "аЖYµ4ЕlB   еЫdBґP "‘ЖYґl!ЫxЅўW B \ђџJ#f‘–vМААЦmљdИ@АЋ6еД9YµЎ!В! ,џ¶еfџр&\4   Ky¬ ` еЫw¬ђџЃЅА ,4 ! ,џЎлa†m]eTРЦ	a†Л 0п»@Д ≥oрC6‘ђ™|! .Vm	≥n@≠ЫG¬\ђЏьЅa‘`СА еf”АЦЖД≤D @ еЫK\ђџаЅААЦm4	r≥jKТ! ,ЏЮеf’0ЦЖѕЕ9YґьВ! ,Џ–еf÷јЦД ≥kаKХЫYШ,С 9fЎАЧ+6ј∞D   еЫeB\ђџёЅЏІ+6яА∞Y2бј  [b! ,џB"√Ађ8 еБАЦmґ	r≥oјKВЌґAЂђ!њў"  rЌЄБ!  26 @АЋ6нДКB   dl НА У.       [р! ,џ–+Д@  Ћ6юДИ±  DB И∞р Л 
∞рФB Yі)ЫLEXИ F#    еЫGВЕ!  2Ќ•б@а”≠Ъ 
± ≠™≥@†КЁХVБ¬&h !њ÷м	jјPД ≥iЄP§"  \Ґ0 rЌЂ°LЏB!  %СФжs
DR°T§NЖсМёn:M«S( Кn:П"Щ†ёu6#(А   e@)Ђ§™!∆QA™
zТ§v®†§*'§«YАв
ҐzLeШ#!*£#"©F~Ѕ™r
ЪФfф°Ч"$ЂFobr:,d&!Ч#™Fkbrb,e$!Ч&*Faјтrj™b§f$°Ч'"£∆k¬*rrz§fЎ°Ч)ђ*FuA™rҐЪ§f!¶)"І¶F\А2bТ*zЬe|'!ІІ'™™Fc *zrЪ§wр!©GA@ҐТb4f<Ґ"£&*FKЅ“)tg4%ҐЧG@ **ТТzФel%#ЧGe ≤:*°ҐB,wX#Ґ™#)'«T ≤:*ҐB*ƒt8#Ґ™$І*FNЅ≤:*ҐZ*ћd,#Ґ™&$ІG[т:*ҐbҐФt#Ґ™)™)FZВТAtf$$¶/І£F@@2BJbъzt` §І°$ІFL¬™Jz™4d*§І£!°F{jJzJr$` $І¶ІҐ"∆wВbJzТЉeД+$І©Ґ°™GKБ*JЪB*ƒu»$™'†«vЅ*JҐzBv,%£&*©§GlАjb""ТlvФ¶"$©&«ZjbzЇ*ФwT&ІЂ)™)Fx“qtt'*¶Ґ©$«~ZВzЬw(®*™"GRВrВ™Ґ
§v@'(*™$ ™G{Ѕ≤В™ҐB*ƒwЬ(*™&$ІGX¬rВ™Ґr
§uР(*™'*¶«sВ2В™ҐЪ
§wЬ#(*™)£ «oјrВ™ҐЪҐФeі)(ЧGvБjТ
JЪ,dи)ЧGL вЪ
te()°©"*¶«lBrЪ**ZТv0")•§®FfBjЪjz≤,td)™)!¶®G]јrЪҐТВћdH#)™)&"ІGhAj™ВВ*Фvh+†§™GHБ≤Ї
JҐФtL-"©'ќ   Ю*ФwT&ІЂ)™)Fx“qtt'*¶Ґ©$«~ZВzЬw(®*™"GRВrВ™Ґ
§v@'(*™$ ™G{Ѕ≤В™ҐB*ƒwЬ(*™&$ІGX¬rВ™d,#Ґ™&$ІG[т:*ҐbҐФt#Ґ™)™)FZВТAtf$$¶/І£F@@2BJbъzt` §І°$ІFL¬™Jz™4d*§І£!°F{jJzJr$` $І¶ІҐ"∆wВbJzТЉeД+$І©Ґ°™GKБ*JЪB*ƒu»$™'†«vЅ*JҐzBv,%£&*©§GlАjb""ТlvФ¶"$©&«ZjbzЇ*ФwT&ІЂ)™)Fx“qtt'*¶Ґ©$«~ZВzЬw(®*™"GRВrВ™Ґ
§v@'(*™$ ™G{Ѕ≤В™ҐB*ƒwЬ(*™&$ІGX¬rВ™ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее
move(r,c);
putstr(buffer);

return(SUCCESS);
}

/*======================================================================*/
/*
.he                                                             ANLIB(GETSTR)
.pa
*/
/*======================================================================*/
WORD                                  /*				*/
getstr()                              /* Read in a string to the buffer */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((getlin(buffer,80) != 0) ? -1 : scan(buffer) & 0xff);

}

/*======================================================================*/
/*
.he                                                               ANLIB(SCAN)
.pa
*/
/*======================================================================*/
WORD                   /*						*/
scan(p)                /* Scan the buffer for first non-blank character */
BYTE	*p;				/* Pointer to buffer to scan	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (*p == ' ')  *p++;

return(lower(*p));

}

/*======================================================================*/
/*
.he                                                              ANLIB(LOWER)
.pa
*/
/*======================================================================*/
WORD                                             /*			*/
lower(c)                                         /* Force to lower case */
BYTE	c;			/* Character to force to lower case	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((c >= 'A' && c <= 'Z') ? c + ('a' - 'A') : c);

}

/*======================================================================*/
/*
.he                                                              ANLIB(UPPER)
.pa
*/
/*======================================================================*/
WORD                                             /*			*/
upper(c)                                         /* Force to upper case */
BYTE	c;			/* Character to force to upper case	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((c >= 'a' && c <= 'z') ? c - ('a' - 'A') : c);

}

/*======================================================================*/
/*
.he                                                               ANLIB(ZERO)
.pa
*/
/*======================================================================*/
VOID                                          /*			*/
zero()                                        /* Zero an area of memory */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Called by 'zero(pointer,length)'					*/

#asm
	.z80
	pop	de	; Get return address
	pop	bc	; Get length
	pop	hl	; Get pointer
	push	hl
	push	bc	; Restore
	push	de
z$l:	ld	(hl),0
	inc	hl
	dec	bc
	ld	a,b
	or	c
	jr	nz,z$l
	ret
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                             ANLIB(GETLTR)
.pa
*/
/*======================================================================*/
WORD                         /*						*/
getltr(r,c,t,s)              /* Get a single character from the set 's' */
WORD	r,				/* Row				*/
	c;				/* Column			*/
BYTE	t,				/* Default character		*/
	*s;				/* Pointer to string to search	*/
/*======================================================================*/

{

LOCAL
BYTE	*p,
	*q,
	deflt[2];

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

deflt[0] = t;
deflt[1] = NULL;
while (TRUE) {
    if (getfrom(r,c,deflt) == FAIL)  return(-1);/* Get a letter		*/
    p = s;					/* Point to Set		*/
    t = upper(*buffer);
    while (*p != NULL && *p != t)  p++;
    if (*p != NULL)  break;
    strcpy(buffer,"Entry should be ");
    p = buffer + 16;
    q = s;
    while (*q != NULL) {
	*p++ = *q++;
	if (*q != NULL)  *p++ = '/';
    }
    *p = NULL;
    error(buffer);
    putcat(r,c,' ');
}

return(*p);

}

/*======================================================================*/
/*
.he                                                               ANLIB(SKIP)
.pa
*/
/*======================================================================*/
WORD                             /*					*/
skip(p)                          /* Skip to next non-space or non-comma */
BYTE	*p;				/* Pointer to string to examine	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                           SETLST(LISTFMT)
.pa
*/
#ifndef	HEADER
#include	"portab.h"
#include	"setup.h"
#endif

STATIC
WORD	findf();

#ifndef	HEADER
/*======================================================================*/
VOID                            /*					*/
listfmt(c)                      /* Display format entries on the screen */
BYTE	c;		/* If 'Q' gives quick list else full list	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SET, SETUP etc
Revision History:
27/10/89 Brought up to Timeclaim standards - ICFO
29/09/85 Version 3.3
10/06/85 Some restructuring for MFB II & GM849.
         Edit & Delete options added to the full display
17/10/83 Screen dump added
         Written by David Parkinson
         (c) dci software 1983, 1984, 1985
*/

{

LOCAL
BYTE	**ap;

LOCAL
WORD	entry,
	key;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

clreos(3,0);
if (abort(0) == 0) {
    if (c == 'Q') {
	while (qlist() != 0) {
	    putsat(23 RC 15,"Use Cursor Keys to Scroll - RETURN to exit");
	    switch (key = (upper(getkey()) & 0xff)) {

		case ESC:
		case CR:
		    abort(1);		/* Exit				*/

		case S_DUMP:
		    scrdump();
		    break;

		default:
		    adj_ql(key);
		    break;
	    }
	}
	waitcr();
    }
    else {
	ap = a_indx;			/* Set index base		*/
	format();			/* Put up the proforma		*/
	for (entry = 1; ; ++entry) {
	    if (ap[entry] == 0)  entry = 1;
	    ldirm(fmtid,ap[entry],8);	/* Copy over the format name	*/
	    fmtid[8] = 0;		/* Ensure terminated		*/
	    getfmt();			/* Read it in			*/
	    fvalues();			/* Fill in the details		*/
	    putsat(22 RC 19,"Use Cursor/Alpha Keys to Select next entry");
	    putsat(23 RC 19,"or  ^E to Edit, ^D to Delete,  ESC to Exit");
	    kflush();
	    switch (key = (upper(getkey()) & 255)) {

		case C_LEFT:
		case C_UP:
		    if (entry == 1) {
			while (ap[++entry] != 0) continue;
		    }
		    entry -= 2;
		    break;	

		case CR:
		case C_RIGHT:
		case C_DOWN:
		    break;

		case  ESC:
		    abort(1);		/* Exit				*/

		case S_DUMP: 
		    scrdump();
		    break;

		case 0x05:
		    setformat(0);	/* Control / E			*/
		    break;

		case 0x04:
		    clreos(22,0);	/* Control / D			*/
		    putsat(23 RC 20,"Type 'Y' to delete the record ");
		    if (upper(getkey()) == 'Y') {
			putstr("Deleting");
			delete();
		    }
		    break;

		default:
		    entry = findf(key);
		    break;
	    }
	}
    }
}

abort(-1);				/* Remove the ESCAPE linkage	*/

}

/*======================================================================*/
#endif
/*
.he                                                             SETLST(QLIST)
.pa
*/
/*======================================================================*/
WORD                    /*						*/
qlist()                 /* Display the list of names from the directory */
/*======================================================================*/

{

/* QLIST just displays the list of names from the directory.  It skips	*/
/* the first <QLOFF> entries.  If <QLOFF> != 0, or more entries are	*/
/* undisplayed, it returns NZ, else it returns Z.			*/

LOCAL
BYTE	*q,
	**ap;

LOCAL
WORD	rc,
	count,
	m;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

clreos(4,0);
putsat(4 RC 37,"Formats");
count = m = 1;
while (m != 0) {		/* Main loop				*/
    m = qloff;
    ap = a_indx;		/* Start of directory entries		*/
    ++ap;
    while (m-- != 0) {
	if (*ap != 0)  ++ap;	/* If valid entry increment pointer	*/
    }
    for (rc = 0x600; ; rc += 10) {
	if ((rc & 127) > 79) {
	rc += 176;		/* Move to next line			*/
	if ((m = const()) != 0 || rc > 0x16ff)  break;
    }
    if ((m = *ap) == 0)  break;
    q = *ap++;
    q += 8;
    m = *q;			/* Put temp. NULL at end of string ...	*/
    *q = 0;
    putsat(rc,q - 8);		/*			...so can print	*/
    *q  - - -*/

while (*p == ' ' || *p == ',')  p++;

return(p);

}

/*======================================================================*/
/*
.he                                                             ANLIB(PUTSAT)
.pa
*/
/*======================================================================*/
VOID                                             /*			*/
putsat(r,c,s)                                    /* Put a string at r,c */
WORD	r,					/* Row			*/
	c;					/* Column		*/
BYTE	*s;					/* String to be output	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(r,c);
putstr(s);
putstr("       ");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             ANLIB(PUTCAT)
.pa
*/
/*======================================================================*/
VOID                                   /*				*/
putcat(r,c,l)                          /* Put a single character at r,c */
WORD	r,				/* Row				*/
	c;				/* Column			*/
BYTE	l;				/* Character to be output	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(r,c);
putvid(l);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             ANLIB(PUTNAT)
.pa
*/
/*======================================================================*/
VOID                                             /*			*/
putnat(r,c,n)                                    /* Put a number at r,c */
WORD	r,					/* Row			*/
	c,					/* Column		*/
	n;					/* Number to be output	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(r,c);
putnum(n);
putstr("      ");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
nat(r,c,n)                                    /* Put a number at r,c */
WORD	r,					/* Row			*/
	c,					/* Column		*/
	n;					/* Number to be output	*/
/*======================================================================*/

{

/* - - - - - - - ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕPSУP†TU%$х(]%RMOVSTRБУS’РЦU eUDƒФи	JCRLFБС—USХ dtUDe$ш9U5I&GETSTRБ––S†TƒхtU(UAAJZEROБС—U†eUD4HM-%BPUTSATБФUРU% YАYp      K@ † 4  А ,  *ј бэЪ  6ЂЎТА
∞  МEА t0 B 9D  ХЪ  0X"Є !Ађ– ВЅИ Vh  ЅААЦh  еfА А еf‘@Д r≥lxB 9D  ХЫKА, еfЎрНА3@ h  !АҐ  Ќ≠А&\   Kcј%±а rеf‘ј[4  ЯђЂТ !  X UБ ,6ЙА6Ѓ0а 
∞  МEБ vЬЗmАvЎЗcј2а`  [Ф !  X B YґT÷*јј– ХA@D ` е ЌЇ†6mЩ єD ` е ЌЉа6mл ≥@ Йф$Ќ  іХE@EX F"јј;† ! .Vmх КўЈд UБАb, #А – ХQ D ` еЫFјYЈф "аЖY† 6Г ≤™–Д єYіаVЌ§ "6"БАЧ+6® ИўµPl dЋZ@D   еЫX OЛVU•БАЧ+6Ј ИўµРVеБАЧ+6љАИўµьVЌІ`-иHB \ђџ+fЎ–idИ@@Ћ6ќ єYµ@В! ђЏ∞ ЅdИA†+6џА∞Y"ъ
еfЏр&\   Ks@D   еЫjј\Ґ  Ќ  , 9fЁ (Д ≥oФCuА\ђЏ“Ѕ`∞DlЏД †`BыэТ!  ђ– В"Ѕ ђ е–@'+6н ∞X"0 rЌљ`.Q 9f“ '+6ЭА0X"&еf№РЂ 2D   еЫd@B# 4  eUР! 9f‘ Ид Ќ  µХY@Д і@ HД ≥i@ФB YµЄ	 Ќ•АL6дѕЛVЛњямС’1fА ≈Ђ
”Бl`ФB YµЎ	 Ќ  , 9fўр'(Д ≥m`ХЫ^АШ,Чr≥i®B  2D6ф	 !( ђ– ВЅf’†&Uбњям;= m;
}
switch (m) {

    case ESC:
    case CR:
	abort(1);		/* Exit					*/

    case S_DUMP:
	scrdump();
	break;

    default:
	adj_ql(m);
	break;
    }
}
clreos(rc >> 8,rc & 127);
if (*ap == 0 && qloff == 0)  return(0);

return(1);

}

/*======================================================================*/
/*
.he                                                            SETLST(ADJ_QL)
.pa
*/
/*======================================================================*/
VOID                                   /*				*/
adj_ql(key)                            /* Increment and decrement QLOFF */
WORD	key;				/* Character from the operator	*/
/*======================================================================*/
{

/* If the key is an ASCII character, then adjust 'qloff' so that it	*/
/* points to the point in the list where the format names start	with	*/
/* that letter.								*/

LOCAL
WORD	op;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

switch (op = (upper(key) & 0xff)) {

    case SC_UP:
	qloff -= 128;
	break;

    case SC_DOWN:
	qloff += 128;
	break;

    case C_UP:
	qloff -= 16;
	break;

    case C_DOWN:
	qloff += 16;
	break;

    default:
	if (op < 'A' || op > 'Z' )  break;
	qloff = findf(op);
}
if (qloff > highest - 96)  qloff = highest - 96;	/* Crude limit	*/
	    
if (qloff < 0)  qloff = 0;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETLST(FINDF)
.pa
*/
/*======================================================================*/
STATIC WORD  /*								*/
findf(c)     /* Position to format entry starting with the given letter */
BYTE	c;					/* Letter to search for	*/
/*======================================================================*/

{

LOCAL
WORD	n,
	offset;

LOCAL
BYTE	**ap;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n = upper(c);
offset = 0;
ap = a_indx;				/* Start of alpha index		*/
++ap;
while (*ap != 0 && **ap < n) {
    ++ap;
    ++offset;
}

return(offset);

}

/*======================================================================*/
==============*/

{

LOCAL
WORD	n,
	offset;

LOCAL
BYTE	**ap;

/* - - - - - - - - - - - - - - - - - - - - - - - - - -ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—U’ dƒХ5DdЎE1%MRADJ_QLФ MHeј        K@  0ФB  9Y† В!  ђ– В|Z∞Ѓ†Д ≥@  Кљю>-XV Ыw@OЛVUВ Г¬оQor≥@ Ъ  9Y† L `@k ЦІА@ +6Й 0Y† њА
∞ ХЫVАЎ,:ю √ѓа– ІАј<  ™аР   √Ђ†:T Ќ  wPT  ∞ 4  А@, √іАђ #` Ч ` KђUА ,–  шµa[∞ "ј@  *ј@ЧXЂ  YґЄ ! ђ– ВЅ`И@ и Ho † 4  Д¬ќQЪr≥iЎВ!	Е№ҐКеfёјЪ  3j ХЫQ "` Л 0н(і@UААg≈Ђ
Ъ К∞ МEАА.±V  ≥nHсj ¶А,:2√£ 2”@V КƒXЗt@eІа2”р—А@VmT `≥jјиАИ@ +4  `∞оИД, rИ@ +6ДА0X"†] !Њ ОVmщ `∞Yі Ќ††,КЭю>-XVDCCЅ\ђ– ВЌ  wDUБ ђЏ(Ѕ` —aЁml Ґ (AА)ш4OјP@
~Д T Ў• Ґ@@
 Ђ` @   √≤А,;4-‘Цк И_пч+6£А∞Y2а`           [Ї! Ґ  ЌђА,ДJrИhј+ХЫ\@X, "Ѕј, *Ѕј≈Ђ*РКА  XР `АМEВ X8 V"Ѕј3в’ХOјЕX ЫIјOЛVU<`АМEВ tpB ∞P™Б
∞P D И∞PҐБ
∞P Ш }sЌбxЪ  2ђxЂ V  »Л 3@  fА +*Ѕ@шYЫXАЩµа	ХcјШwЬ
[*Ѕ ЏZ"Ѕј– Хh@ШwЬUВ b1 КўґLEБАX " DX UБАі| EГАX l `†(Ђ _рЋХЫ|јX,V rК∞pDъa‘А!V a–Р9ohД r≥n»ЫRјXttUГАђЏіЅa—–6fЏ`Џ ^– hъБ"@  эБ0и Ђ :ƒ А÷!є NVmм`ЙАЩo`Д ≥m†6®Б\р…сj¬Ґ@b rеfя!6– КўЈ–	З{ Д   еЫA@ўі4 Ќ§@lHД ≥h–DВ f‘p&U?ААЦm'ЦАЏЃЌЇјL™¶! ,Џn ,:і! ,ЏФ…ААЦmXШ@ЏZ ѓ b rЌђ a–ЫO@ўµ Хc ƒ   еЫ\ ¬.шeЗdјƒ   еЫ`јў2ў@6Л¬еbµFј,р±>,ЩpP       Џ@1 9fў3иЋ @ иЋА@ в’ХoA А еЫEј№Ґ@ rЌЄ`nQ r≥kHВЅ≥o–*сБИ_пцHД ≥nXЛ @АЋФuxАЩґ<	 ЌЂ`lЙф$*Ѕ@џRЌѓ l™:*Ѕ@ЏеБАЦmfА Џ •јВђ #`†[А
∞P6Мђ™x√Ј†Вже„рW+6—Б0X" А=`† 9fёА1 `јm2>-YVLUВАb, +rК∞` МEГ lЏЇ—>ДЕX0Ы]БЛVUР`†Л 
∆¬цY`†∞ CRБђЏ  ЅВ ЦmTrИA Ћ6“В9D" ХЫLAX,џК∞P6њВ2eЄАВ rЌµ†МџВp?√,џі¬љ В rЌє МџШj?√,џ¶Ќ£јМЂю! .VmЁ≥hH≠Зq   еЫ}A"0 rЌ†АЃQ 9f–јW+6№0X" rЌҐАЃVmЅ`ИlА+ХЫIAX,С 9f“W(Д ≥i∞+ХЫFX, 9fё G+6а ∞Y"0 rЌІјЃQ 9f’АW+6°∞X" rЌђ ЃVh  ЅўW+6ЦВ∞Y †№t9D3AЉкl2FQ  @  2U“c3 Щ	UJ2мЋС—c;АєR2ћЋУc%ј1є1R3ќ	PЋУУ’#>јuєMaR3\PЋХ’#1@1I=N;vР‘£ЄА1I12Р’TЧ”—£/аUI}=:3ёQQУ#=@НЄ¬: QTФУ‘£)`©Ї:“С—UФУгє†9Q%9R3ҐС—US£іАyQ1QJ;РС—U’£-†© Ї2шТS”—£  !%1}=:2.U–c§@u1=]J:“УS’РЦU#,А±5=Y;ФУS’Ф’£#`Й8Ї:xУХSQTТc¶ єAUQR;LФUS£™`єAUQ9R2вФUХSc†аєAUQMR2тФU’£)аєAUQY%3тФK£љАQM:;И	““T#(†ЩMQIAf:ґUTT£±а]%R;(СTУз   ЮЇ:“С—UФУгє†9Q%9R3ҐС—US£іАyQ1QJ;РС—U’£-†© Ї2шееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                             ANMAN(MANUAL)
.pa
*/
#include	"portab.h"
#include	"analyse.h"

STATIC
WORD	hilite,
	squash,
	size = 0;

EXTERN
WORD	state[][4];

/*======================================================================*/
VOID                                                     /*		*/
manual()                                                 /* Manual mode */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	ANALYSE
Revision History:-
25/09/89 Drive Speed and Data Rate are set from 'omega' - ICFO
21/09/89 'kflush' introduced into loop in manual analyse to stop
         repeat characters holding up the system - ICFO
20/09/89 Check introduced to stop manual analyse going beyond
         the maximum track on the drive.  Applied to case 'T'  Case
         'C_RIGHT' can go two tracks beyond the drive maximum - ICFO
18/09/89 Brought up to Timeclaim Standards
*/

{

/* There is no return from this function except when the operator	*/
/* presses 'Esc'							*/

STATIC
VOID	step(),
	mhead();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

squash = side = track = 0;		/* Initialise variables		*/
fmttpi = (drvdat->tpi) & 0xff;
clrs();					/* Clear the screen 		*/
omega = 0;				/* Set initial value		*/
while ((i = state[drvdat->hsp - 'A'][omega]) == -1)  ++omega;
drive &= 0x5f;				/* Clear bits			*/
drive |= ((omega & 0x01) << 5);		/* Set Data Rate		*/
drive |= (i & 0x80);			/* Set Line 2			*/
putsat(0,7,"Density    TPI      Track   Side    Abbr   Data Rate");
rot = 0;
i = 2;					/* Set 'rot' if variable speed	*/
while (i < 4) {
    if ((j = state[drvdat->hsp - 'A'][i++]) != -1 && (j & 0x08) != 0) {
	putsat(0,62,"Rot. Speed");
	rot = 1;
	break;
    }
}
seek0();				/* Zero the head		*/
limit = readtrk();			/* Initialise the buffer	*/
offset = 0;				/* We're at the start		*/
while (TRUE) {
    mhead();				/* Update the dis4  rК∞P Ш }sЌоVmж`∞EX Ыk Щґd	ХS ≈T$	ЫP@ўґ	ХUАƒ  $B 2e¬   µhB Yіш Ќѓ@,0 EД w8UQј¬(шdE[јЎwШU]А¬(  dE_ ЎwШU`ј¬/шdEb@ЎwШUd ¬!  dEeАЎwШUД $4  a[p1V ЦАџЌ©†lЂА√Љјbђ  еf—@FКќБ∞п06Е÷а48љБҐ   ≤†h@   √і@b†  "†Ж]bЂТЌґ†l™*Љаaь2"љаbЂю  † jЙВ@ dЋДА       ЦК@@Ћ6яБ9YµМВ"¬@  EЕ T<EЕАXX F#a`V f’р6mЄeU0AV f”∞FmuК∞Р6щ≥iр#*µВ
∞∞ МF"¬јђ( #a@7a@ITжeќІ#ЩЉд %ЩO'1–ё )ШќFуa∞@-И•B©HЬ :ƒSЅ§и *ЬћҐ‘дs7ЬЕдaј–aћІУШАиoћ¶√)Ми 7OAФ№t9@уРА@^"ИЖс»i:в Аиo¶√)– ,•2АиoOУ† ®y8Dr»Ь@t7ИЖSaФиeQ» c7ЬМВ  l2Э&г8 Мo9L'CШ3ЮЛФ’“Uг>@U	=IR:іРQЧ‘S#%@Щ}%9b0 СХ£  	%=N0 РУ–“‘г  	==QMj0  –Фг  	UJ0 РХQФ“V£% uєMJ3RЋС’#* Сє1R2ФPЋУУ’#! ХєQMR0 Р“SУСc  1=.2lР”СS‘г.@U=9MR0 Uc  IZ0 QQУ#1а91Q0 СSФ“U#  %J0 СTСP’#  =U	10  —£  A		N0 СP£  I%Y0 СХУРSc  IYQ
2®—KМ#  Q%0 ССV#  %IMR0 СУUЦU#  5QN0 СУUХ£;`5Q%0 СУUc  5QQI.3СУ‘УPU#  IMQM3¬СХРSQc)@ЙЇ0 –Tc  @ 0 –Tг;јQ5R2мС—U—Vc(аЙ Ї0 S#? y!%!N0  Rc  %9b0 ТSХСTХ#  %9YM%0  R£?ј-1UM"3ҐSTУc  1%5%R: УT’Уc  1MAR0 SQQPc  5
0  УTг  9I%Y0 SСРUг  9U5]%:0 У—СФ—U#  B0 Ф—P”Хc  AM-^3ђФU–U#1`9AUQMQJ0  Tcї†5E1%MR2"	TS—С£  IMQI.0 ФЧ–РT—c  M!93мФ–‘СSc  MQI2™Ф—UУ‘£  M%0 T“VСQ£  MA0  ‘‘#  MAR0 Ф‘Vc  MAR0 Ф‘“SТc  MeMQI.0 Ф÷T’T#  MeM}Qf0  ’У#  QI9M
0 U“—Uг  QQ22:	UTT£0`]%QJ0 Х‘‘P—g   Ю^3ђФU–U#1`9AUQMQJ0  Tcї†5E1%MR2"	TSееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                              SETPAK(PACK)
.pa
*/
#ifndef  HEADER
#include	"portab.h"
#include	"setup.h"
#endif

#define		C_fmt	64	/* Various side change techniques	*/
#define		B_fmt	48
#define		U_fmt	32
#define		T_fmt	16

struct	format	{		/* Record structure of Format record	*/
	BYTE	pdesc[33],	/* Format description			*/
		drvsys,		/* Hi 2 bits = drive type,		*/
				/* Lo 6 bits = SYS id			*/
		flag,		/* Bit					*/
				/*  7	Set for Inverted data		*/
				/*  6)					*/
				/*  5)	Side change technique		*/
				/*  4)					*/
				/*  3	Set for Index Mark		*/
				/*  2	Set for double density		*/
				/*  1	Set for double-sided disk	*/
				/*  0	Set for 2MHz clock		*/
		pspt,		/* Sectors-per-track			*/
		pbps,		/* Bytes-per-sector(/128)		*/
		splexm,		/* Non-standard extent mask		*/
		pskew;		/* Physical skew			*/
	WORD	ptpi;		/* TPI required				*/
	WORD	ptrk;		/* Tracks-per-disc req.			*/
	BYTE 	blksz;		/* CP/M blocks size in K		*/
	WORD	dirent;		/* Directory entries			*/
	WORD	restrk;		/* Reserved tracks			*/
	BYTE	lspt;		/* Logical sectors-per-track		*/
	WORD	sidef;		/* Side fields in header		*/
	BYTE	sizef,		/* Size field in header 		*/
		fsec,		/* First sector number  		*/
		gap1,		/* Formatting gaps			*/
		gap2,		/*	"				*/
		gap3,		/*	"				*/
		fmtbyt,		/* Formatting byte			*/
		flg2,		/* Another Flag byte:			*/
				/* Bit 7 = High Speed			*/
				/* Bit 6 = spec. init			*/
				/* Bit 5 = Invert side			*/
		xxx;		/* Spare bytes				*/
	WORD	ttt;		/* Used by Steve for track skewing 	*/
/*----MSDOS----*/
	WORD	bootsz;		/* Boot size in sectors			*/
	BYTE	spc,		/* Sectors per cluster			*/
		spfat,		/* Sectors per FAT			*/
		media,		/* MEDIA byte				*/
		nfats,		/* Number of FATS ASCII 		*/
		fatid,		/* FAT ID byte				*/
		sectran[60];	/* Sector translation table		*/
} secbuf;

#ifndef HEADER
/*======================================================================*/
VOID                            /*					*/
pack()    play 		*/
    kflush();				/* Empty keyboard buffer	*/
    switch (toupper(getkey()) & 0xff) {

	case 'R':			/* Re-read the track 		*/
	    limit = readtrk();
	    break;

	case 'D':			/* Toggle the density		*/
	    drive = drive ^ 0x10;
	    limit = readtrk();
	    break;

	case 'S':			/* Toggle the side    		*/
	    side ^= 1;
	    limit = readtrk();
	    break;

	case 'T':			/* New track			*/
					/* Use 'offset' saves a variable*/
	    if ((offset = getint(1,29,track)) < 0) {
		if (buffer[0] != NULL)  track = 0;
	    }
	    else if (offset >= (WORD) (drvdat->trk & 0xff)) {
		track = (drvdat->trk & 0xff) - 1;
	    }
	    else track = offset;
	    seek();
	    limit = readtrk();
	    offset = 0;
	    break;

	case 'A':			/* Abbreviate display 		*/
	    squash ^= 1;
	    break;

	case 'W':			/* Speed / data rate		*/
	    while (TRUE) {
		if (++omega == 4)  omega = 0;
		if ((i = state[drvdat->hsp - 'A'][omega]) != -1)  break;
	    }
	    drive &= 0x5f;		/* Clear bits			*/
	    drive |= ((omega & 1) << 5);/* Set Data Rate		*/
	    drive |= (i & 0x80);	/* Set Line 2			*/
	    limit = readtrk();
	    move(lppage() - 1,0);
	    putstr("Please wait a moment ...");
	    wait(2);
	    limit = readtrk();
	    clreos(lppage() - 1,0);
	    break;

	case ESC:			/* Abort on ESC	     		*/
	    return;

	case C_UP:			/* Move up two lines		*/
	    offset -= 32;
	    break;

	case SC_UP:			/* Move up 18 lines		*/
	    offset -= 288;
	    break;

	case C_DOWN:			/* Down two lines		*/
	    offset += 32;
	    break;

	case SC_DOWN:			/* Down 18 lines     		*/
	    offset += 288;
	    break;

	case C_LEFT:			/* Step in			*/
	    if (track != 0) {
		step(-1);
		limit = readtrk();
		offset = 0;
	    }
	    break;

	case C_RIGHT:			/* Step out			*/
	    if (track < (drvdat->trk & 0xff) + 1) {/* 2 beyond maximum	*/
		step(1);
		limit = readtrk();
		offset = 0;
	    }
	    break;
    }
    if (offset < 0)  offset = 0;
    else if (offset > limit)  offset = (limit & 0xFFF0);
}

}

/*======================================================================*/
/*
.he                                                    ANMAN(MANUAL / KFLUSH)
.pa
*/
/*======================================================================*/
VOID                                           /*			*/
kflush()                                       /* Flush keyboard buffer	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (const() != 0)  continue;

}

/*======================================================================*/
/*
.he                                                     ANMAN(MANUAL / MHEAD)
.pa
*/
/*======================================================================*/
STATIC VOID                      /*					*/
mhead()                          /* Put up the heading for this section */
/*======================================================================*/

{

LOCAL
WORD	i;

STATIC
VOID	dispbuff();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(1,7);
putstr(((drive & 0x10) != 0) ? "Single" : "Double");
move(1,19);
putnum(fmttpi);
move(1,29);
putnum(track);
i = where() & 0xff;
while (i++ < 37)  putvid(' ');
putvid((side != 0) ? '1' : '0');
move(1,44);
putstr((squash != 0) ? "ON " : "OFF");
putsat(1,52,((drive & 0x20) != 0) ? "High" : " Low");
if (rot != 0)  putsat(1,64,((drive & 0x80) != 0) ? "High" : " Low");

dispbuff();

}

/*======================================================================*/
/*
.he                                                   ANMAN(MANUAL / DISPBUF)
.pa
*/
/*======================================================================*/
STATIC VOID                           /*				*/
dispbuff()                            /* Display the data in the buffer */
/*======================================================================*/

{

LOCAL
WORD	b,
	last,
	this,
	datamark,
	leadin;

STATIC
VOID	puth4(),
	puthxi();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(4 RC 0);
p = data + offset -1;	/* Initialise the pointer */
n = offset;		/* <N> is the address counter */
datamark = 0;
leadin = ((drive & 0x10) ? 0 : 0xFFA1);
for (i = 19; i != 0; --i) {
    if (n > limit)  break;
    puth4( n );
    putvid(' ');
    for (j = 16; j != 0; --j) {
	last = *p;
	switch (this = *++p) {

	    case 0xFFFE:
		if (last == leadin) {
		    hilite = 5;
		    size = *(p+4);		/* Get size field	*/
		}
		break;

	    case 0xFFFB:
		if (last == leadin) {
		    hilite = 1;
		    datamark = 1;		/* Flag data start 	*/
		}
		break;
	}
	puthxi(this);
    }
    p -= 16;		/* repeat for Alpha display */
    putstr("  ");
    for (j = 16; j != 0; --j) {
	b = (*++p & 0x7F);
	if ((b < ' ') || b == 0x7F)  putvid('.');
	else			     putvid(b);
    }
    putstr("\n");
    n += 16;
    if (dat                      /* Pack a record ready for writing disk */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SET, SETUP etc
Revision History:
04/11/89 'sidef' is not masked with 255 or side fields for side 1
         are lost - ICFO
27/10/89 Brought up to Timeclaim Standards - ICFO
21/06/86 Drive / system field modified from 4:4 to 2:6.
         Allows for up to 63 types of operating  system.
20/09/85 Version 3.3
10/06/85 Module introduced for MFB II & GM849.
         File record format now packed to allow room for MSDOS
         parameters etc...
         Written by David Parkinson
         (c) dci software 1983, 1984, 1985
*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

zero(&secbuf,128);			/* Clear out the buffer		*/
strcpy(secbuf.pdesc,fmtdesc);		/* Copy over descriptor		*/
secbuf.drvsys = (fmtdrv << 6) + systyp;
i = (invert == 'Y') ? 128 : 0;
switch (schange) {

    case 'C':
	i += C_fmt;
	break;

    case 'U':
	i += U_fmt;
	break;

    case 'T':
	i += T_fmt;
	break;

    case 'B':
	i += B_fmt;
	break;
}					/* Default is nothing (=='S')	*/
if (index == 'Y')  i += 8;
if (density == 'D')  i += 4;
if (spd == 2)  i += 2;
if (clock == 'H')  ++i;
secbuf.flag = i;
secbuf.fsec = frstsec;
secbuf.pspt = spt;
secbuf.pbps = bps / 128;
secbuf.ptpi = fmttpi;
secbuf.ptrk = fmttrk;
secbuf.splexm = splexm;
secbuf.pskew  = pskew;
secbuf.gap1 = gap1;
secbuf.gap2 = gap2;
secbuf.gap3 = gap3;
secbuf.blksz = blocksz;
secbuf.dirent = directry;
secbuf.restrk = restrk;
secbuf.lspt = lspt;
secbuf.fmtbyt = fmtbyt;
secbuf.sidef = sidef;
secbuf.sizef = sizef;
secbuf.bootsz = bootsz;
secbuf.flg2 = ((fmtdrv << 5) & 0x80) + (sp_init == 'Y' ? 0x40 : 0);
if (invside == 'Y')  secbuf.flg2 += 0x20;
secbuf.spc = spc;
secbuf.spfat = spfat;
secbuf.media = media;
secbuf.nfats = nfats;
secbuf.fatid = fatid;
secbuf.ttt = tskew;
ldirm(secbuf.sectran,sectrans,60);

/* Let C/80 supply the return						*/

}
/*======================================================================*/
#endif
/*
.he                                                            SETPAK(UNPACK)
.pa
*/
/*======================================================================*/
VOID                         /*						*/
unpack()                     /* Unpack a record after reading from disk */
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

strcpy(fmtdesc,secbuf.pdesc);	/* Copy over descriptor */
fmtdrv = ((secbuf.drvsys >> 6) & 0x3);
if (secbuf.flg2 & 0x80 )  fmtdrv += 4;		/* Set the 'H' marker	*/
systyp = secbuf.drvsys & 63;
invert = (secbuf.flag & 128 ? 'Y' : 'N');
switch (secbuf.flag & 0x70) {

    case C_fmt:
	schange = 'C';
	break;

    case B_fmt:
	schange = 'B';
	break;

    case U_fmt:
	schange = 'U';
	break;

    case T_fmt:
	schange = 'T';
	break;

    default:
	schange = 'S';
	break;
}
index = ((secbuf.flag & 8) != 0) ? 'Y' : 'N';
density = ((secbuf.flag & 4) != 0) ? 'D' : 'S';
spd = ((secbuf.flag & 2) != 0) ? 2 : 1;
clock = ((secbuf.flag & 1) != 0) ? 'H' : 'L';
spt = secbuf.pspt & 255;
bps = secbuf.pbps * 128;
fmttpi = secbuf.ptpi & 255;
fmttrk = secbuf.ptrk & 255;
splexm = secbuf.splexm &255;
pskew = secbuf.pskew;
gap1 = secbuf.gap1 & 255;
gap2 = secbuf.gap2 & 255;
gap3 = secbuf.gap3 & 255;
sidef = secbuf.sidef;
sizef = secbuf.sizef & 255;
frstsec = secbuf.fsec & 255;
blocksz = secbuf.blksz;
directry = secbuf.dirent;
restrk = secbuf.restrk & 255;
lspt = secbuf.lspt;
fmtbyt = secbuf.fmtbyt & 255;
bootsz = secbuf.bootsz;
sp_init = ((secbuf.flg2 & 0x40) != 0) ? 'Y' : 'N';
invside = ((secbuf.flg2 & 0x20) != 0) ? 'Y' : 'N';
spc = secbuf.spc;
spfat = secbuf.spfat;
media = secbuf.media;
nfats = secbuf.nfats;
fatid = secbuf.fatid;
tskew = secbuf.ttt;
ldirm(sectrans,secbuf.sectran,60);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
trk = secbuf.restrk & 255;
lspt = secbuf.lspt;
fmtbyt = secbuf.fmtbyt & 255;
bootsz = secbuf.bootsz;
sp_init = ((secbuf.flg2 & 0x40) != 0) ? 'Y' : 'N';
invside = ((secbuf.flg2 & 0x20) != 0) ? 'Y' : 'N';
spc = secbuf.spc;
spfat = secbuf.spfat;
media = secbuf.media;
nfats = secbuf.nfats;
fatid = secbuf.fatid;
tskew = secbuf.ttt;
ldirm(sectrans,secbuf.sectran,60);

/* Leееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееamark && squash && i > 2 && size < 4) {
	datamark= 0;
	putstr(".....................................................");
	clreol();
	putstr("\n");
	for (j = 8; size; --size, j <<= 1)  continue;
	j = (16 * (j-2));
	p += j;
	n += j;
	--i;			/* allow for line of dots */
    }
}

clreos( -1, 0 );	/* Clear from where we are */

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                    ANMAN(MANUAL / PUTHXI)
.pa
*/
/*======================================================================*/
STATIC VOID  /*								*/
puthxi(i)    /* Display a possibly highlighted two character Hex number */
int i;						/* Number to print	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (hilite != 0) {
    hil_on();
    puthex(i);
    hil_off();
    --hilite;
}
else    puthex(i);

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                     ANMAN(MANUAL / PUTH4)
.pa
*/
/*======================================================================*/
STATIC VOID                         /*					*/
puth4(h)                            /* Display a four-digit Hex address */
int h;						/* Address to display	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

puth1(h >> 12);
puth1(h >> 8);
puthex(h);

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                      ANMAN(MANUAL / STEP)
.pa
*/
/*======================================================================*/
STATIC VOID                   /*					*/
step(size)                    /* Step the drive by the amount requested */
WORD	size;				/* Number of tracks to step	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

seek(track += size);

/* Let C80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—URаe4T4%ThA.UNPACKФB MUБ%ј                                                                                                                                                   і  CА Ґ  Ќ  ,  rИ@ +4  `∞E@  §R)КE.±P  >М± ®  ©ябЦh   Іа ЗPА   Л@ 
А В h  Й  h Ч h  ИА h Ч h  И@ h Ч h  Иј h Ч aўph Rј`
∞ U VP†є А   ®  ©ябУв’Еk@Z  " DZ  T  WПр…сj¬Є`≠   "-  *  b≥в’Еu@Z  F#h P  \?√'≈Ђ
ф 
і  МE† Z  ъ2ƒ@†  ъ2∆А†  ъ2ƒ`† ÷!@ † фeЙ @  ЛА
А )   —Ц%   —Ц&   —Ц5   —Ц6   —Ц7   —Ц+   ,X *  XЄ T  FXј T  FXа T  ±И ®  >М±Ш ®  c–U КE"СHШ }s оQP  Sњ√,Џh  ≤ " ЗdјD  D2}cРP  Sњ√'≈Ђ
ўАО±»4  И УиЋА
А иЋА
А иЋ  
А иЋ А
А иЋ! 
А иЋ!А
А ; д@(Д  rИGА+4  `∞X,Щt  -п— (З  9YіXВЅbm©uИ@јh  & \ј3xКЈАО±»6А	А„2 ё|Z≤©h™И@А »КТ±6Л	А„0ьё"§†ђD Ќ¶ B`хћА7Яђ™¶!,АuXBN ©h л 3j Ш }sм;0!!АUЗl Д$  Кґ0нАД™ WP&∞Х *ь√ґ BШ EaјШvј	Зl Щґі ƒ` ѓ@B Г   Мb m] Ѓ`AљЪ  2Ѓ@Д≤ a№∞!	8 "≥ ђD ЌґАB`хћ7≥mи*уHАйФј+\ :ƒ@џ§& \ј#{6нБ2® Д a–p1 "ЄАђD ЌЊ B`хћ7≥o»*СИI %У +ђ :ƒ`Џ& ѓЄ л 3i`E  fА +ь *ƒа` КЖ К±H Ш "Ґ@#ђJ Ќ¶аb` КМ О±06ЂИ®шлА3kШ "§ј#ђl Ќ≠@b` КЦАО±Є6ЇБЙА*h*∆ *Є:∆`џ & Ђл 3lИШ "Њ ђV Ќ≥Аb*v*≈А*Д*≈ј` К§ О±А6”БИ™pл 3mрШ "™†"ђz "≠ #ђr ЌЄаb`хћ@7≥hЄ*цИK пУА*ь:« џ∞& \¬{6рБ≤®P Д≤ a––A	8 "≥@#ђ~ ЌЊјb+h:» Џ("Ј`#ђВ Ќ£†В+Д:»@ЏL"є #ђЖ Ќ•аВ+†*«`+Ѓ!Љ .QD rИGА+6фА∞X,Lfd)Ђ§™!∆  2
ъJr"ƒ` !")+F  "JzЬf®!&'°•©∆tАтzzҐЪ‘e °()∆  2™22*Ф` !*£)§≠FAј™r
ЪФd°Ч"$ЂFO@тrj™b§f°Ч''™FN*rЪ¬§` !§ І'"∆IАкbz\` " ™ ∆  2"*2"Ті` Ґ"£&*FzА≤"*rЪJ§` Ґ$©Fl т"JТ*§` "'™°&"∆  "В` "(!! ©∆  2"ВҐҐ
` Ґ)$Ђ"∆  2"Т≤r
l` ")+* °FјЏ)qДdм£ ™$ҐF  22"Ґ*¬§` £$©)™Fs т2jҐ §gј#&™""©∆Jј≤2jҐ"Ті` £&™$ҐFR т2jҐҐВLe@#&™*)%∆h@т2ТЪҐЪ,` #ЧF[јв:
БМeи#†®Fa@в:
БЬ` $"¶(F  2BJ:B*Ь`  §∆s ™Jr"*ƒe\$І+"©*FCБ2Jr≤ЪJ$`  •FT*b"JТl` ¶$¶§™Fp@вbЪВ§d§¶ҐҐ$†∆  j2` &©∆  2r"ТJ≤,d»І# ™)∆  2r™jЇJt` '£#)Ґ™F  
Дt ( °•∆  2ВЪ*rђeР®)•ҐЂ∆  
М` ®¶'£#Fn тТ*ЪҐТ\` )/° ©Ґ∆d ≤ЪB
r<x )Ґ°°*£FQ2Ъ*ҐТf,©§Ґ"£FeАкЪJ“*4d\©®!∆B ЏЪВ$dА©®# ™FVјтЪВb*¬ldƒ©®*F| тЪВъJrLgа)™)!®,∆  2Ъ ЪҐТ\dи)ђ©™,®F  2Ъ ЪъҐћ` ™#&F  2ҐТ
rЪe™)•ҐЂ∆  ҐҐdwЉ*І( °•∆  2ЇЪВ
,d$-"©'ќ   ЮF  
Дt ( °•∆  2ВЪ*rђeР®)•ҐЂ∆  
М` ®¶'£#Fn тТ*ЪҐТ\` )/° ©Ґ∆ҐFR т2jҐҐВLe@#&™*)%∆h@т2ТЪҐЪ,` #ЧF[јв:
БМeи#†®Fa@в:
БЬ` $"¶(F  2BJ:B*Ь`  §∆s ™Jr"*ƒe\$І+"©*FCБ2Jr≤ЪJ$`  •FT*b"JТl` ¶$¶§™Fp@вbЪВ§d§¶ҐҐ$†∆  j2` &©∆  2r"ТJ≤,d»І# ™)∆  2r™jЇJt` '£#)Ґ™F  
Дt ( °•∆  2ВЪ*rђeР®)•ҐЂ∆  
М` ®¶'£#Fn тТ*ЪҐТ\` )/° ©Ґ∆ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕPSУPS†d‘еT»-1UM"P 5rЧ      і    А —Р  }  , *   ∞ eЪ  	А  Ъ  @ и»  Q ИD f—А КэюКE!  2еRph  )hЖY†  И  ≥@ Uc T mC ЯFUXЗJ@@ 6ђА	А„1|ё}V@’^ f÷p0 ъж Ы≈"СH§RеWmw fА —ХЖ Tј0 ъж@№£Ђ  Ќ± џ }Y–  еБјQЊr≥@ В!  @  Д Y0U≈ њм– µL@ET® " Yіƒ "њЖE"СHFЭА\ҐЂР #^†X•Ґf‘Р  #fА ™*њ `хћ7≥oа6ЕА≤©pД  rИGј(ЖщГєYґЎВЅ`И@ њ a”« fА –  D  @   ! АЛVUбfя6mвfА Vh  Ѕ uдЫM@DTаЗlА«VЬЫh ЃаБЉъ2ђ†,ЏЄ"Ђа,;d:°`Џ–}w Mз—Х|f„0vaџ 1 еЗ@Q’ f„р+4  `∞X"*|  † *д ОА mЮ>-YWB  FVlЗ~@EWP " YЈl L uК≠@4  e_ U…Г Цm– g—Х√aяРU÷>МѓhЈдЪ  3lPК∆АИ@ уaџ 1V >їА&с aџ 9hјД >-YUіu] ґ№F}R Лсю>-XTмB  FT§UwјB! eЫyАB+чшdR)Дo( e :І LЏH)hЖYЈ‘ E{АlЏ ≠@L:Џ√£ C™аЌ™†B`хћ_7ЯFUЄuTАЩµƒL >єА&сH§R)єGUм	Ы`@ЩґМ ъ2≤ B™Љ& \»{ФufАЩґL	ЫeАП£+NЌњ†"* Ќ  nQ  еfА Ж€єY† B 9Y† Ыm ДV№	ЫnАЕnQ  еfА ў≤ET"аЖDWј	ЗlА≈W№"аDWф	ЗlА≈T"  DT(ЗlА≈TD"  ЖDT\ЗlА«W№ЫjАПЛVUBњяоVm•`≥nјКнБ@ aџ 1U<Г ЦmC n±’$f“p6mЃeW01 еfЏPv6ЫБИ©–Д  T 6≤aџ 6h VјJ@
»D W∞Ш… Х ,В £ EpоА/x Ра
Д Q`4@СБ†@   Uƒ" @3npjгБИ@ ≥aЁа1UkuКЃ4  e]а1U»>єЮсћЦп∞к &[ƒЌ  ЛVUрaё 6вdЋБ   	oИД rИ@а+6бБ0X#ЂbЌ™аb`хћ7≥k*ЛhЄCМВhрCХЫs Ш" !	АђџфЅ`К®иХЪ  0D ФB 9YіЬВЅU@6mr≥iА#Ъ  	А, *јА1 Д[gцmєmVрAА еfА SXpmDf–∞FUБМ@;! ђЏ“ЅА@Q∞ еf”јFUААµЎХiA4Ф!Зj4§! Ќ£`М еН Q’€f„0A0 ъжўґhХsA4і!Зt4»! Ќ§ ,UJ@OЛVU	А@Q	  е[`Fmє ЃdљЫpБWьCKBtCLВђџ§Ѕ`∞Yі4У.            %°†Ґ  Ќ  "† ÷*їАaСXИ  Q†Q  !  X0 uzЈђL >єВув’ХQD  £ВИT/с Дј+:*©јІ≈Ђ*ЩГ∞л((™®ВКƒUpЗTEWT÷*§†ђџЮ Ѓ†ђ:f*≠@ЃVmr`ИD +6√0D!  КБ КђH)сj Ґ`ћ;@
*±АҐ±ЧaЎ∞QUf‘–1 ZQК’≥m (Л 0пЎ(Ђ 9EX Ъ  2Ѓ»(Д
 ` UЃБ Цm±P `а(Ђ 3n+*ъВИ@   А@, √° ћ:Ќѓ@vдь€їАѓЈш  *Ѕ@VmA`∞м∞(™жВД^р»ККiЄCХЫjБ"А EfЅET§шµeXPf@RјaXКЫГ0йX0™НГƒUЫuDјлШюo``V И Џі¬≠ ¬ђ @њ√,Џ† ЌЊАМ™ф! ђџ
ЅaЎ aV r≥k†3ЗMБД4и! Ќ§@ћUvД СО`јв’ХhБЕXЫZБЩVƒUXB  6ґВ≥m3*а
®  D f’†fm≤eS q  "ЅАxеfЎ†f4  ”†З+6иГ0D А КЭГ
® сj †ам:*† ±  ^0aHКь0п(3ш0пА0™ю
≈bСH§R"° в™КлQp»КККђ®3ђUF√"*>*µ ¬±*a’∞QэюеА Vmз`∞Y"ђ  |Z≤Ђ(;4  ААЦm[r≥@ 4  ` XЛ  0лИ8Д ≥jИ;ХЫUAЎ,С 9f÷†wXД fА Vh  ЅААЦmwuИA m~r≥l;B Yґ( Ќ≠јмHк†В3iИ+ђB Yґt2}Z`w+6э ∞Y$C)Єжi:D А®P$И А@T9Lf± А@S4ЩҐ А@A1ОB АИa:D#	–  )ќВбLаe2Щ aФ¬s2ИжI–@aMж”)Єи ЕјЩ§№g6@Cy‘ƒl2А	дб  ЮF# 	У9†  &ќа А 
 Е¬бpЄ\.Е¬бpЄ\.Е¬бpЄ\.Е¬бpЄ\.Е¬бpЄ\.Е¬бpЄ\.Е¬бpЄь≈ jй*ИqА ВИЩ  »*™Йи…СЫ@Д™ММК•С®e»*jQЫаhЖ\О©ўИe…И±ЪрhЖ\Ш©g®e……кСЪРzЖ\¶∞©_®e КjСА ЖРВЬЬЛ’»iКH©йСУј|ЖШ§КЮІ  ИiКJqЮ0:ЖЮЬ¶©ИИ*И1А 
ИКМШ©  »И© i*СТаZИ§ТђЛF»КJ»И*СЮ@TК]Ѕh•∆А К∞ЊВ§П  »Ђиiй±ТјLМЪ®®†У  » jИКJ—А М¶®РКГ  » jКh®qФАdО]  Ии*1А ОВ†e  Ии*qЪ ОК®ТЬ©O»и™ЙhЂ1ЫtР]Y…	)Лйи—Ф†|РТШЊЮЭ  …	*КH(qТаrУ#)Qё <ЦМШ™¶Сf©Й)©*СЭа,Ш††ВОЛ …®) ®)СА ЪВ∞И§≠  …®+
h®qЩ HЪЮђЛ')—Ъ–$Ю]"…и» h™СЧа*ЮЪКОГ*ЩPz†™®Рc° 
™ЙЂФАL†™®Ь™Ы 
™Кh*СЭјl†™®¶®• 
™К…(СЦА<§КВИ®•   H™(КJ—ЭАF§Ю©   h®ji+QА ¶КЖ®Ю•   h®jКkQЫ†x¶ККЧ2™h®©fЧ H¶ТИЛ  ™i(И™qС Z¶ЪЮђЛ  ™jИ*JСФ–*¶®В®Л   jИ*К™qА ®МЩS Йк™
±Ы`z®§ВЖЧ  jКЙСЭ@(ЃВТ©L™й™H≥А  Ю–$Ю]"…и» h™СЧа*ЮЪКОГ*ЩPz†™®Рc° 
™ЙЂФАL†™®Ь™Ы 
™Кh*СЭјl†™®¶®• 
™К…(СЦА<§КВИ®•   H™(КJ—ЭАF§Ю*1А ОВ†e  Ии*qЪ ОК®ТЬ©O»и™ЙhЂ1ЫtР]Y…	)Лйи—Ф†|РТШЊЮЭ  …	*КH(qТаrУ#)Qё <ЦМШ™¶Сf©Й)©*СЭа,Ш††ВОЛ …®) ®)СА ЪВ∞И§≠  …®+
h®qЩ HЪЮђЛ')—Ъ–$Ю]"…и» h™СЧа*ЮЪКОГ*ЩPz†™®Рc° 
™ЙЂФАL†™®Ь™Ы 
™Кh*СЭјl†™®¶®• 
™К…(СЦА<§КВИ®•   H™(КJ—ЭАF§Юееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            ANALYSE(ANRUN)
.pa
*/
#include	"portab.h"
#include	"printf.h"
#include	"analyse.h"

#define		TRACK 10			/* Density check track	*/

#ifndef	GM829
EXTERN
WORD	state[][4];
#endif

/*======================================================================*/
VOID                                              /*			*/
analyse()                                         /* Automatic analysis */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	ANALYSE
Revision History:-
15/09/89 Listing brought up to latest standards - ICFO
14/03/88 Output of Number of Tracks is now ONLY sent to the
         output file.  It is not echoed separately to the
         screen. - ICFO
04/02/86 Change introduced to sector number analysis. Now uses
         'read address' to determine highest & lowest sector
         numbers, together with the sector order on each side.
*/

{

LOCA/*
.he                                                         SETSRCH(SAME_FMT)
.pa
*/
#include	"portab.h"
#include	"setup.h"

/*======================================================================*/
VOID
same_fmt()                                     /* List matching formats */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SETUP
Revision History:
27/10/89 Brought up to Timeclaim standards - ICFO
22/06/86 First version.
         Written by David Parkinson
         (c) dci software 1983, 1984, 1985
*/

{

/* List all formats from the data file that match another record in	*/
/* various respects.							*/

LOCAL
BYTE	**ap;

LOCAL
WORD	entry,
	mark,
	keydrv,
	keytpi,
	keyspt,
	keybps,
	keyden,
	keysid,
	keysdf,
	keyszf,
	keyfsn,
	keyivd;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

clreos(3,0);
format();				/* Set up the display		*/
if (abort(0) == 0) {
    while (TRUE) {
	putsfat(5 RC 30,"--------",8);
	putsat(23 RC 15,"Enter the Format name that requires matching");
	if (fillname(1) == 0) {		/* Get the format ID		*/
	    error("Format does not exist - re-enter");
	    continue;
	}
	keydrv = fmtdrv;		/* Copy search key data		*/
	keytpi = fmttpi;
	keyspt = spt;
	keybps = bps;
	keyden = density;
	keysid = spd;
	keysdf = sidef;
	keyszf = sizef;
	keyfsn = frstsec;
	keyivd = invert;
	ap = a_indx;			/* Start here			*/
	mark = 80;
	for (entry = 1; ; ++entry) {
	    if (ap[entry] == 0)  break;
	    if (++mark > 65) {
		putsat(23 RC 0,"Searching..");
		clreol();
		mark = 0;
	    }
	    else  conout( '.' );
	    ldirm(fmtid,ap[entry],8);	/* Copy over the format name	*/
	    fmtid[8] = 0;		/* Ensure terminated		*/
	    getfmt();			/* Read it in			*/
	    if (keydrv == fmtdrv	/* Check for a match		*/
	     && keytpi == fmttpi
	     && keyspt == spt
	     && keybps == bps
	     && keyden == density
	     && keysid == spd
	     && keysdf == sidef
	     && keyszf == sizef
	     && keyfsn == frstsec
	     && keyivd == invert) {
		fvalues();		/* Fill in the details		*/
		mark = 80;
	 	waitcr();
	    }
	}
	clreos(23,0);
	putsat(23 RC 20,"Search complete - RETURN to repeat,ESC to exit");
	while (mark = conin()) {
	    if (mark == 0x0d)  break;
	    else if (mark == 0x1b)  abort(1);
	}
	clreos(3,0);
	formats();
    }
}

abort(-1);				/* Remove the ESCAPE linkage	*/

}

/*======================================================================*/
*/
		mark = 80;
	 	waitcr();
	    }
	}
	clreos(23,0);
	putsat(23 RC 20,"Search complete - RETURN to repeat,ESC to exit");
	while (mark = conin()) {
	    if (mark == 0x0d)  break;
	    else if (mark == 0x1b)  abort(1);
	}
	clreos(3,0);
	formats();
    }
}

abort(-1);				/* Remove the ESCAPE linkage	*/

}

/*========================================================ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—U‘Раe4‘Uфi@–„$
\                               K@  0ФB  9Y† ВЌ    ХЪ  0OЛV.А@≈Ђ*ЧCјW(ЖЫБ9D АХЪ  0X,<.е‘ '+4  `∞D ХЪ  0OЛV\ ÷–'+4  `∞ии ®  ``P  "Ѕ †  EВА@  Л 
А    ,  *  XH T  ∞† ®  a`P  "√ †  EА %  Л @  aџpV И∞’ 
∞ •÷*ј Цh  |Z∞ЃXжАК∞  МEБ +гы4  i_@ .еЎа'+6† 0X,–  B  ∞ ю Eј+4  `И@ (Ђ 
]bђ  f№(Д r≥@ В!  £) @э fА ™Ї е``h   І "™∆ е`Аm)fА ™Р*≠ QV
 f”`m9eUАUo rК∞`6£ ≥jH*і КЂ®ФUГАµXЫV@YUаU^јҐђ  Ќђј,Џ“ ± "Ђ еa mvf„РUШXp(Ђ
 3l06ƒА≤≠@™∆А9EXXЫeАYґdХn EVL *√ џLЌµ ,ЂФЌ  %  Л 3@ ≠ ЕјQ  еf–РBєD6h	 ЌЉА4  `@в’ХFјЕX "уЖOЛVa—∞&`@ ЛХю>-XT`B 9YіTГ-aёp еА Vm÷`∞Y† ОАKKАД/чыХЫE@Ш,СhіZ-ЛEҐ–№t2ЬДCAФ@F7ЬН¶†А№a6ЩDCAДи 9N'SI» sL'C†“n3А∆уСі¬tжSША№o:ІГIћи ИFQiФ№t2ЬА3)Ддc4M∆qpЄ S2ШNF3@А∆o6ЬЖS°Ф@-И•B©HЬ :ƒ#)ј a:•2АиoOУ†2fPPУ‘Х#3 }%9b0 СХ£  	%=N0 РУ–“‘г  	==QMj2Ю–Фг  	UJ0 РХQФ“V£:јєQMR0 Р“SУСc  1=.3“Р”СS”#$АY1I=N3–P””ТS£? =9=UR0 L
WORD	n;			/* Response from 'waitgo'		*/

STATIC
WORD	waitgo();

STATIC
VOID	auto();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

clreos(3,0);
if (autofl != 0)  auto();			/* Automatic run thru'	*/
else {
    move(12,16);
    putstr("Please put the disc in ");
    putstr(drvdat->id);
    putline(" and shut the door");
    while (TRUE) {
	if ((n = waitgo()) == 0)  manual();
	else if (n == 1)	  auto();
	else  break;
    }
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                   ANALYSE(ANRUN / WAITGO)
.pa
*/
/*======================================================================*/
STATIC WORD                        /*					*/
waitgo()                           /* Get auto run or manual run option */
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(lppage() - 1,27);
kflush();
putstr("Press 'A' to Analyse, 'X' to eXit");

while (TRUE) {
    switch (toupper(getkey())) {

	case 'X':
	    clrs();
	    i = -1;
	    CLEANUP;

	case 'A':
	    i = 1;
	    CLEANUP;

	case 'M':
	    clrs();
	    i = 0;
	    CLEANUP;
    }
}

cleanup:

return(i);

}

/*======================================================================*/
/*
.he                                                     ANALYSE(ANRUN / AUTO)
.pa
*/
/*======================================================================*/
STATIC VOID                           /*				*/
auto()                                /* Automatic analysis of the disc */
/*======================================================================*/

{

LOCAL
WORD	idrv;

STATIC
WORD	findfst(),
	fdensity();

STATIC
VOID	chktrks(),
	order(),
	chkside(),
	chktpi();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

idrv = drive;				/* Starting point		*/
clrs();
if (fdensity(idrv) != 0)  return;	/* Find the density		*/
chktpi();				/* Check out the TPI		*/
chkside();				/* See if 1/2 sides		*/
chktrks();				/* Check out tracks / surface	*/
if (findfst() != 0)  return;		/* Determine First sector number*/
printf("\t\t%d bytes per sector\n",secsize);
order();			/* Determine physical sector order	*/
findtf();

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                 ANALYSE(ANRUN / FDENSITY)
.pa
*/
/*======================================================================*/
STATIC WORD                           /*				*/
fdensity(drv)                         /* Find out the density of a disc */
WORD	drv;						/* Drive number	*/
/*======================================================================*/

{

/* Find out the density of a disc.  To do this it uses 'Read Address'	*/
/* on track TRACK.  It also incorporates a speed change if appropriate	*/

LOCAL
WORD	i;

#ifndef	GM829
LOCAL
WORD	dv1,j;
#endif

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

drive = drv & 0x27;			/* Start with lspd, Double Dens	*/

putstr("                ");
seek0();				/* Zero the head		*/
side  = 0;				/* First side			*/
track = TRACK;				/* Move in a bit		*/
seek();
	
#ifdef	GM829
i = 0;
do {
    putvid('0');
    drive ^= 0x10
    readad();
} while (status != 0 && ++i < 8);

putvid(0x0D);

clreol();
if (status == 0) {
    if (drive & 0x10) {
	density = 'S';
	p = "single";
    }
    else {
	density = 'D';
	p = "double";
    }
    printf("\t\tDisc density is %s\n",p);
}
else {
    printf("\n\n\t\tUnable to determine the density.\n");
    printf("\n\t\tThe disc may be incompletely");
    printf("\n\t\tformatted or incompatible with this drive");
}

#else

dv1 = drive & 0x07;			/* Just the Drive Address	*/
for (i = 0; i < 4; ++i) {
    drive = dv1;
    if (state[drvdat->hsp - 'A'][i] != -1) {
	drive |= (state[drvdat->hsp - 'A'][i] & 0x80);	/* Line 2 state	*/
	drive |= (i & 1) << 5;				/* Data Rate	*/
	for (j = 0; j < 8; ++j) {
	    putvid('0' + i);
	    readad();
	    if (status == 0)  break;
	    drive ^= 0x10;
	}
	if (status == 0)  break;
    }
}
if (status == 0) {
    putvid('\r');
    clreol();	/* Determine rotational speed				*/
    i = 2;	/* Only examine Columns 3 and 4 (H after drive type)	*/
    while (i < 4) {
	if ((j = state[drvdat->hsp - 'A'][i++]) != -1 && (j & 0x08) != 0){
	    printf("\t\tRotational Speed is ");
	    printf((drive & 0x80) ? "High" : "Normal");
	    break;
	}
    }

    printf("\n\t\tData Rate is ");
    printf(((drive & 0x20) != 0) ? "High" : "Low");

    if ((drive & 0x10) != 0) {
	density = 'S';
	p = "single";
    }
    else {
	density = 'D';
	p = "double";
    }
    printf("\n\t\tDisc density is %s\n",p);
    sectsz = *(data + 3);		/* Sector size on trUc  IZ0 QQУ#+а99M%R0  —T£  %IR0 С’PУc  A
0 СРРTг  AQQ
0 QТUСc  IY960 СХХP£6ј)Ї3r—KМ#*јII=J0 QРUQ#  QaR2ТСТSРc  %IMR0 СУUЦU#  5QN2DСУUХ£#А55Q%2^СУUc  5QQI.2СУ‘УPU#% Y=I5R3>СФФ’—c7а9Y1U0  СЋ£  @∆0 –T£  @ќ2>С—UУU#!@) Ї0 S#  !%!N0  Rc  %9b3^ТSХСTХ#  %9YM%0  R£"@51%I60 SSRU#  1MAR0 SQQPc  5
0  УTг  9I%Y0 SСРUг  9U5]%:0 У—СФ—U#  B0 Ф—P”Хc  AM-^3∆ФU–U#&@AUQM0  Tc  E1=0 ФСT’Тг  I}	M: Ф–SQW—£  M!90 Ф—P’Рc/а5M%3T“VСQ£  MA2ё‘‘#  MAR0 Ф‘Vc'а-MAR0 Ф‘“SТc  MeMQI.0 Ф÷T’T#  MeM}Qf0  ’У#  QI9M
0 U“—Uг  QQ23РХ–RU‘£  ]MAp  ЮУ—СФ—U#  B0 Ф—P”Хc  AM-^3∆ФU–U#&@AUQM0  Tc  E1=0 ФСT’Тг  I}	ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                           SETTERM(CONOUT)
.pa
*/
#include	"portab.h"
#include	"setup.h"

/*======================================================================*/
VOID                                 /*					*/
conout(i)                            /* Send a character to the console */
WORD	i;				/* Character to be output	*/
/*======================================================================*/

{

/* Expands TAB characters and keeps a column count.  LFs are converted	*/
/* to CR LF as expected by C programs					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	pop	hl
	pop	bc		; Character to C
	push	bc
	push	hl
	ld	a,c		; Check character
	ld	hl,column	; Update position
	inc	(hl)
	cp	' '		; Control?
	jr	nc,sendit	; No,skip
	cp	TAB	
	jr	z,dotab
	cp	BS
	jr	z,dobs
	cp	ESC
	jr	z,dobs		; Ignore some bytes
	cp	CR
	jr	z,docr
	cp	LF
	jr	z,dolf
	jr	sendit

;   Handle a CR
docr:	ld	(hl),0		; Zero count
	jr	sendit

;   Handle a LF
dolf:	ld	c,CR
	call	docr
	ld	c,LF
	jr	sendit

;   Tab to next 8th Col
dotab:	ld	c,' '
	call	sendit
	ld	hl,column
	ld	a,(hl)
	and	7h
 	ret	z
	inc	(hl)
	jr	dotab

column:	defb	0	

;   Backspace
dobs:	dec	(hl)
	dec	(hl)

;   Send the character in C
sendit:	ld	de,9
	call	cind##		; Call CONOUT
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                           SETTERM(GETLIN)
.pa
*/
/*======================================================================*/
WORD                                    /*				*/
getlin(buffer,length)                   /* Get a line from the operator */
BYTE	*buffer;				/* Address of buffer	*/
WORD	length;					/* Length of buffer	*/
/*======================================================================*/

{

LOCAL
WORD	i,			/* Chars in buffer			*/
	c,
	col,			/* Column on display 			*/
	colt,			/* Cols to juack TRACK	*/
}
else {
    printf("\n\n\t\tUnable to determine the density.\n");
    printf("\n\t\tThe disc may be incompletely");
    printf("\n\t\tformatted or incompatible with this drive");
}
#endif

return(status);

}

/*======================================================================*/
/*
.he                                                   ANALYSE(ANRUN / CHKTPI)
.pa
*/
/*======================================================================*/
STATIC VOID                               /*				*/
chktpi()                                  /* Check the TPI of the drive */
/*======================================================================*/

{

/* Checks the TPI of the drive.  The density check will have moved the	*/
/* head to track TRACK, so the buffer will contain a header from a	*/
/* sector in track TRACK.						*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = data;					/* Now check the header	*/
track = *p & 255;				/* Set track to match	*/
fmttpi = drvdat->tpi & 255;			/* Set default value	*/
switch (track) {

    case TRACK:
	break;					/* Got it right		*/

    case TRACK * 2:
	fmttpi <<= 1;
	break;

    case TRACK / 2:
	fmttpi >>= 1;
	break;

    default:
	fmttpi = 0;				/* Unknown TPI		*/
}

if (fmttpi == 0) {
    printf("\t\t*** WARNING Unable to determine TPI ***\n");
    printf("  %dth track is numbered %d\n",TRACK,track);
}
else  printf("\t\tDisc tpi is %d\n",fmttpi);

}

/*======================================================================*/
/*
.he                                                  ANALYSE(ANRUN / CHKSIDE)
.pa
*/
/*======================================================================*/
STATIC VOID               /*						*/
chkside()                 /* Check if anything is on side 2 of the disc */
/*======================================================================*/

{

/* Check if anything is on side 2 of the disc if the drive allows.	*/
/* Also verifies that side fields are correct.				*/

LOCAL
WORD	s0,
	s1;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

s1 = sides = 1;			/* Flag as single sided for now		*/
readad();			/* Load the buffer with side 0		*/
p = data + 1;			/* Point at the side field		*/
s0 = *p & 255;			/* Keep what is in side 0 field 	*/
if (drvdat->sides == 2) {
    side = 2;			/* Try other side			*/
    readad();
    if (status != 0)  printf("\t\tDisc is single sided\n");
    else {
	printf("\t\tDisc is double sided\n");
	sides = 2;
	s1 = *p & 255;
    }
}
else {
    printf("\t\tUnable to examine second side");
    printf(" because drive is single-sided\n");
}

side = 0;			/* Reset side flag			*/
if (s0 != 0 || s1 != 1) {
    printf("\t\t*** WARNING Non standard side field(s) ***\n\t\t");
    printf("  %02xH on side 0",s0);
    if (sides == 2)  printf(", %02xH on side 1",s1);
    printf("\n");
}

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                  ANALYSE(ANRUN / FINDFST)
.pa
*/
/*======================================================================*/
STATIC WORD            /*						*/
findfst()              /* Find the first sector and set the sector size */
/*======================================================================*/

{
/* Find the first sector and set the sector size. To cope with weird	*/
/* sector numbering, it uses 'rd_address'.				*/

LOCAL
WORD	lo_sec,
	hi_sec,
	lo_rpt,
	hi_rpt,
	count;

STATIC
VOID	pdts(),
	rdretry();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = data + 2;			/* Point at sector field */
settrack();			/* Set 2793 track register */
for (side = 0; side < sides; ++side ) {
    lo_sec = 256;		/* First sector read */
    hi_sec = 0;
    lo_rpt = hi_rpt = 0;
    while ((lo_rpt < 2) || (hi_rpt < 2)) {
	radd();			/* Read address with retries */
	if (status != 0)  break;
	i = *p & 255;
	if (i == lo_sec)  ++lo_rpt;
	if (i == hi_sec)  ++hi_rpt;
	if (i < lo_sec) {
	    lo_sec = i;
	    lo_rpt = 0;
	}
	if (i > hi_sec) {
	    hi_sec = i;
	    hi_rpt = 0;
	}
    }
    if (status != 0)  printf("help!");
    if (side == 0) {
	fstsec = lo_sec;
	maxsec = hi_sec;
    }
    sector = lo_sec;		/* Select lo sector number		*/
    secsize = rdretry();
    if (status == 0) {
	printf("\t\tSide %d, ",side);
	printf("lowest sector = %2d, ",lo_sec);
	printf("highest sector = %2d ",hi_sec);
	printf("[%d sectors]\n",hi_sec - lo_sec + 1);
    }
    else {
	printf("\t\t*** WARNING Unable to determine sector");
	printf("\t\t information ***\n");
	pdts();
    }
}
side = 0;

return(status);

}

/*======================================================================*/
/*
.he                                                  ANALYSE(ANRUN / RDRETRY)
.pa
*/
/*======================================================================*/
STATIC WORD         mp - used during BS 	*/
	rpt;			/* 1=normal, 0=start again, -1=abort 	*/

LOCAL
BYTE	*p,
	*q;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (TRUE) {
    p = buffer;
    rpt = 1;
    col = 0;
    i = 0;
    while(rpt != 0) {
	c = getkey();			/* Get and store a character	*/
	*p = c;
	if (c < ' ' || c >= DEL || (c >= C_LEFT && c <= SC_DOWN)) {
	    switch (c) {		/* Handle control characters	*/

		case DEL:
		case BS:
		    if (i == 0)  break;
		    --p;
		    --i;
		    --col;
		    if (c == TAB) {	/* case DEL or BS can this be??	*/
			q = buffer;
			colt = 0;
			while (q < p)  if(*q++ == TAB)  colt = 0;
				       else		++colt;
			colt = ((col - colt) & 7);
			col  = col - colt;
			while (colt-- != 0)  conout(BS);
		    }
		    conout(BS);
		    break;

		case ESC:
		    abort(1);		/* Direct abort if option set 	*/
		    rpt = 0;		/* Escape = Abort		*/
		    *buffer = 0;	/* Clear buffer			*/

/* * * * * * * * * * * Note the Drop Thro' * * * * * ** * * * * * * * * */

		case CANCL:
		    for (i = col; i > 0; --i)  conout(BS);
		    --rpt;		/* Sets 0, or -1 if Esc		*/
		    break;

		case C_UP: 
		case C_DOWN:
		case SC_UP:
		case SC_DOWN:
		    if (i != 0)  break;  /* Ignore if not Col 0		*/
		    ++p;

/* * * * * * * * * * * Note the Drop Thro' * * * * * ** * * * * * * * * */

		case CR:
		    *p = 0;		/* Terminator			*/
		    return(0);

		case TAB:
		    if (i < length - 1) {
			++p;
			++i;
			while ((++col & 7) != 0)  conout(' ');
			conout(' ');
		    }
		    break;
	    }				/* End of switch		*/
	    if (rpt == -1)
	    return(1);			/* Abort			*/
	}				/* End of 'if' control char	*/
	else				/* Not a control char		*/
	if (i < length - 1) {
	    conout(*p++);
	    ++i;
	    ++col;
	}
    }					/* End of while(rpt) loop 	*/
}					/* End of while (TRUE) loop	*/

}

/*======================================================================*/
ЕФ—UT†d4фдхUHQ1%:P5ЭЦА K@ ,+Фт!ІаGрА`5Eчр P+≈wр4PЕ `ј|l Ѕј÷m# Г pБЫPА4ь ьж≤БЗИ j5В@– У.                 ZТ-I А@≈Ђ*ќ@АЋ4  `† "Ѕ   EБ    Л  
∞@сj ≥ L–  EААX( *ј@иHUАА" 4  aY†V Яј– Ъ  0≠ј Ђ P mШ e[PV Ґ – ЫfјґЎХYАЕXЗJ@•ЄАђ  |Z∞ЃxЂ
∞P ђEВАX  V"ј ђ +`@V љябУв’Е[ D @ еЫUАX0 B  ∞0 Ђ :≈X0Ъ  2©†Ђ ƒX0 VЌ  /wшdшµaR†  "јј:b*јј1 a– V rК∞04   Ѓ`9ЉEБАX *јјЏx"јАђ +``сj ≠А"@ Ќ† TЦґ ИA +6А 0XuXB 9Y† B  ∞@ Д ≥o® Ў *јА,  *ј щэЪ  4≠ј÷АК∞  ђEА vPB 9Yі В√і`"ђ +`АVЦб ЋpАeЄ@"ђ  |Z≤ЃhЂ
∞P МEВАX( l А С 9fЎ†[ђUА ґ0ХHјЕX( F"Ѕ@ђ  #` V И∞  Ш }sЌмџr  £`B  Ќ† эИ Vm  `∞к∞Ђ3@ И  \@ @їАЖј80 Є@(0¬B .
pАQ ® ]–H   `Асj¬ђ`BТ√≤јB rЌЉ@"ЈXЂ  3oP*Ћ
∞P МEВАlЏ,еf– Ђ  ƒX  UБ b,-Цa÷–I d∆JА±rЪЇJҐeр†°'©*F  2
ъJr"ƒ` !")+F  "JzЬ` !&'°•©∆  2zzҐЪ‘` °()∆  2™22*Ф` !*£)§≠Flј"r:,eћ
!Ч#™Fiј"rb,fl°Ч*)™FB jr™:§` !§ І'"∆QА"Jr$` °¶'°•«@ 2zrz™§` " ™ ∆  2"*2"Ті` Ґ"£&*F  2"*rЪJ§` Ґ$©F  2"JТ*§` "'™°&"∆  "В` "(!! ©∆  2"ВҐҐ
` Ґ)$Ђ"∆  2"Т≤r
l` ")+* °FBјЪ)qД` £ ™$ҐF  22"Ґ*¬§` £$©)™F  22jҐ §` #&™""©∆  22jҐ"Ті` £&™$ҐF  22jҐҐВL` #&™*)%∆  22ТЪҐЪ,f	#ЧF  ":
БМ` #†®F  ":
БЬeЎ#Ґ™%Ґђ«R@2:*ҐbJteђ	$F  "B*bД` $$£§"©∆  
L` §І""ђF  2Jr≤*Т§` $І+)§ҐF  
T` ¶$¶§™F  "bЪВ§` ¶ҐҐ$†∆  j2` &©∆  2r"ТJ≤,` І# ™)∆  2r™jЇJt` '£#)Ґ™F  
Д` ()Ґ°І*∆  *ВЪZ*Љ`  ®∆  *Кbz24` )"©™)%∆  2Тъ
Ъ,e<)ЧF  2ЪB
r<` )Ґ°™) ∆  *ЪJ"*4` ©§≠"£F  ЪВ` ©®"F  *ЪВ2
§` )®&"ђ&∆  ЪВ§` )®/§І$∆  2Ъ ЪҐТ\` )ђ©™,®F  2Ъ ЪъҐћ` ™#&F  2ҐТ
rЪ` ™)•ҐЂ∆  ҐҐd` +©® °Ґќ   Ю©∆  2r"ТJ≤,` І# ™)∆  2r™jЇJt` '£#)Ґ™F  
Д` ©)™F  22jҐ §` #&™""©∆  22jҐ"Ті` £&™$ҐF  22jҐҐВL` #&™*)%∆  22ТЪҐЪ,f	#ЧF  ":
БМ` #†®F  ":
БЬeЎ#Ґ™%Ґђ«R@2:*ҐbJteђ	$F  "B*bД` $$£§"©∆  
L` §І""ђF  2Jr≤*Т§` $І+)§ҐF  
T` ¶$¶§™F  "bЪВ§` ¶ҐҐ$†∆  j2` &©∆  2r"ТJ≤,` І# ™)∆  2r™jЇJt` '£#)Ґ™F  
Д` ()Ґ°І*∆  *ВЪZ*Љ`  ®∆  *Кbz24` )"©™)%∆  2Тъ
Ъ,e<)ЧF  2ЪB
r<` )Ґ°™) ∆  *ЪJ"*4` ©§≠"£F  ЪВ` ©®"F  *ЪВ2
§` )®&"ђ&∆  ЪВ§` ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее                      /*				*/
rdretry()                                 /* Read a sector with retries */
/*======================================================================*/

{

LOCAL
WORD	i,
	s;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i = 0;
do {
    s = readsc();
    if (i++ == 32)  break;
} while (status != 0);

return((status != 0) ? 0 : s);

}

/*======================================================================*/
/*
.he                                                     ANALYSE(ANRUN / PDTS)
.pa
*/
/*======================================================================*/
STATIC VOID                             /*				*/
pdts()                                  /* Print drive / track / status */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

printf("\t\tDrive  = %02xH, Track  = %d, Sector = %d, Status = %02xH\n", \
				    drive & 25,track,sector,status & 255);

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                    ANALYSE(ANRUN / ORDER)
.pa
*/
/*======================================================================*/
STATIC VOID           /*						*/
order()               /* Approximation of sector number order on side 0 */
/*======================================================================*/

{

/* Algorithm:	Wait for Index hole.
/*		Read in N sectors using successive rd_address() calls.	*/
/*		Repeat the read comparing the repeat values with those	*/
/*		stored in the table.					*/
/*		If the two match, then everything went ok - so accept	*/
/*		the values. Otherwise try again.			*/

LOCAL
WORD	attempts,
	pass,
	count,
	secs[55];

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

count = maxsec - fstsec + 1;
p = data + 2;				/* Point at sector field	*/
settrack();				/* Set 2793 track register	*/
side = 0;
for (attempts = 0; attempts < 5; ++attempts) {
    for (pass = 0; pass < 2; ++pass) {
	wt_ndx();			/* Wait for index hole		*/
	for (n = 0; n < count; ++n) {
	    readad();
	    if (status != 0)  break;
	    i = *p & 255;		/* Get the sector number 	*/
	    if (pass == 1) {
		if (secs[n] != i)  break;	/* Different, try again	*/
	    }
	    else  secs[n] = i;		/* Build table on pass 0	*/
	}
    }
    if (n >= count)  break;		/* Break on success		*/
}

if (attempts > 4 )
		printf("\t\tUnable to reliably determine sector order\n");
else {
    printf("\t\tPhysical sector order on side 0 is:\n\t\t");
    for (n = 0; n < count; ++n)  printf("%2d  ",secs[n]);
    printf("\n");
}

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                  ANALYSE(ANRUN / CHKTRKS)
.pa
*/
/*======================================================================*/
STATIC VOID  /*								*/
chktrks()    /* Check to see what the highest track in use on a disc is */
/*======================================================================*/

{

LOCAL
WORD	t,
	double;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

t = track;				/* Save the current track	*/
double = (drvdat->tpi == (2 * fmttpi));
seek0();				/* Zero the head		*/
track = (drvdat->trk & 255) - 1;	/* Furthest we can go.		*/
if (double != 0)  --track;
seek();					/* Get there			*/
while (track != 0) {
    seek();				/* Move to the track		*/
    readad();				/* Try a 'read address'		*/
    if (status == 0 && *(data + 3) == sectsz)  break;/* Stop if OK	*/
    --track;
    if (double != 0)  --track;
}
hitrack = track;			/* Save the Hi track number 	*/
p = data;				/* Point at the header		*/
track = (*p & 255);			/* Read the track number	*/
if ((drvdat->tpi == 48) && (fmttpi == 96) && (track == 78))  ++track;
++track;
putvid('\r');
clreol();
printf("\t\tDisc has %d tracks\n", track);
if (sides == 2) {
    i = *data;				/* Track number			*/
    side = 1;
    readad();
    if (status != 0 || i != *data || sectsz != *(data + 3)) {
	printf("\t\t*** WARNING Side 2 incompatible with Side 1 ***\n");
	if (status != 0) {
	    printf("\t\t  Side 1 track = %d\n",i);
	    printf("\t\t  Unable to read corresponding Side 2\n");
	}
	else {
	    printf("\t\t  Side 1 track = %d, Side 2 track = %d\n",
								 i,*data);
	    printf("\t\t  Side 1 sector size = %d,",128 << sectsz);
	    printf(" Side 2 sector size = %d\n",128 << *(data + 3));
	}
	sides = 1;			/* Force to single sided	*/
    }
}
seek0();				/* Restore 			*/
track = TRACK;
seek();
track = t;

/* Let C80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SETUB(WRTBIOS)
.pa
*/
#ifndef SET
#include	"portab.h"
#include	"setup.h"
#endif

STATIC
VOID	slcta(),
	setsec(),
	settrk(),
	setdma(),
	rdsec(),
	wrtsec();

/*======================================================================*/
VOID             /*							*/
wrtbios()        /* Update the BIOS on the system track to match memory */
/*======================================================================*/
/*USE
Portability	Level 4 (Assembler)
Parent Module	SET, SETUP
Revision History:
27/10/89 Brought up to Timeclaim standards - ICFO
29/09/85 Version 3.3
         Written by David Parkinson
         (c) dci software 1983, 1984
*/

{

LOCAL
WORD	track,
	sector,
	limit,
	*ip,
	remainder;

LOCAL
BYTE	*p,
	*q;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

initvar();				/* Reset pointers		*/
ip = slcta(0);				/* Select drive A		*/
if (ip == 0) {
    error("Cannot select Drive A");
    return;
}
if (abort(0) != 0)  error("Read / Write error on BIOS update");
else {
    ip += 5;				/* Point to DPB pointer		*/
    ip = *ip;				/* Load it			*/
    i = *ip;				/* Load sectors/track		*/
    track = systrk;			/* Get system track		*/
    sector = 49;
    if (i < 49)	{			/* Allow for a floppy system	*/
	track++;
	sector = 49 - i;
    }
    settrk(track);
    limit = (transb - bios) + 167;	/* Length of patched area	*/

/* Deal with the first (partial) sector					*/
    setdma(0x80);			/* Use default buffer		*/
    setsec(sector);
    rdsec();				/* Read in the first sector	*/

#asm
	.z80
	ld	hl,(bios)		; Get BIOS value
	ld	h,0			; Mask off MSB
	ld	(i),hl			; Store in the Global 'i'
	.8080
#endasm
    q = i;				/* Move into the local 'q'	*/
    p = 0x100;				/* Set p = 100H			*/
    remainder = p - q;			/* Length to move		*/
    p = bios;				/* Start here			*/
    ldirm(q,p,remainder);		/* Update			*/
    wrtsec();				/* Write away			*/
    sector++;				/* Next sector			*/
    p += remainder;			/* Bump the pointer		*/
    limit -= remainder;			/* Update limit			*/
    remainder = limit % 0x80;		/* Bytes in last sector		*/
    limit /= 128;			/* Make sectors			*/
    for (i = 0; i < limit; ++i)	{
	setsec(sector++);
	setdma(p);
	wrtsec();
	p =+ 128;
    }

/* Now the last partial sector						*/
    setdma(0x80);
    setsec(sector);
    rdsec();
    q = 0x80;
    ldirm(q,p,remainder);		/* Move changed bytes over	*/
    wrtsec();				/* Write it away		*/
}

abort(-1);				/* Unlink abort route		*/

}
/*======================================================================*/
/*
.he                                                              SETUB(SLCTA)
.pa
*/
/*======================================================================*/
STATIC VOID                                           /*		*/
slcta(drv)                                            /* Select drive A */
WORD	drv;				/* Always zero to select Drive A*/
/*======================================================================*/

{

/* Returns HL pointing to the DPB					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	e,1bh
	jr	gobios
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                             SETUB(SETSEC)
.pa
*/
/*======================================================================*/
STATIC VOID                                            /*		*/
setsec(sector)                                         /* Select sector */
WORD	sector;					/* Sector to select	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	e,21h
	jr	gobios
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                      ЕPSФХS†dд≈Х9D∞„ш:\    K@  0ФB  9Y† В:  † сj £јџЄ √Ѓ@` ! ђ– ВЅў І+4  `КА +6Ш 0D6†) Ќ  " шµeW ms ` h   Ђ†– З[јX  V|Z∞Ђ`6о 0лxє K[јuZд …Ч   „0h  +rИC`+6УА0X,–  Cn¬ЬђЏp ЅА@≈Ђ*лА3@ +4  `∞о4  њяв, √Їа EААw\Ыh    Л 0оЄк 3@ > X Z∞Џ @  ∆ KuјXТ…Ч   Ёј–  ЌҐ , Ќґ†ђ еf—р	сj ЊјЦmТf”PFm}f—†Sв’ХB Y,–  CwBЬҐ†  Ќ  ,m(fА Щp0       —р 9fА `хћ'7ЯFWt C}Ьђџ ЅfА   ъ2   †фd  3@ ’.fё 0 ъжЫƒX  B  ∞0 Ђ _Зцh  Џ™`L:ф*јј1 a÷V >М™h™Ъ B  Ћ4  ѓябСH§R  .QV іC,ЏH#>-YU@U`АB! eЫb@B+чшdR)ДlШe *јјЦИeЫgАDјлЩ orОЂш6® ≥@ и жАК∞0 Ш }s MвСH§R)rОЃЄ6и ≥nШ	фez@D   Л 
∞P Eрf÷А’Ba—@!V
 И∞PэАК∞0 D` єY† Ъ  А mм>-XTƒ	ЗPАЗWћЫIјПЃаБЉъ2¶@L::§АLЏj|Z∞™А©БKT ШuјuPјЩµшµaV†14 еf—–&4  АА, *јјбэЫ@АЫWЄUiјB! eЫkАB+чшdR)Дmјe *јј1 КZ!Цm√`†4  e[P!V
  Ѓ`AљЫi Щґћ	ХzјЩі$CAB№ђЏ(Ѕfџј!’=f’p!0 ъж@ѕЛVUа—јґг“Ј+6бБ0XwЄ	З[јЩЈCJ№ђџ Ѕfёр!’ f№–!0 ъжўґЎ	ХE ƒ4p-ЗEјƒ4д- ЌЊјL’эf– 10 ъжўі$ХOАƒ%0фd  iиXИ  a‘∞1	 }S01DSР6mъ‘∞Ј(™§БєYіdВЅ  1НЫ`јД@ ≈Б≥j`Ж±єYµ\ВЌ≠`bеf„ 66їИm@[ХЫ_@Ў#™®Ќ§ lСU\U01UЦf÷ 10 ъ2®а"™шА,џ8& А ’ҐfЎр6вaя`1U±ИЃ ыКЃ ђB 3@  aя`1  "ЇАl;мЌЄАр Јаa@…А  ў]–3в’ЕIґCuB№ђџЅfяр1 rИA@(кЏ≥mЄХЫAБ,Ъ3hP ЖОЖ9EW№ Ќ£АМ&\     ”PA "  X8ЫH@ЕVLF"≥ b™МЌµАb` Л 
≠(D ≥j` ђV|Z∞≠0 Д >М™ 6ЯВђ`6МђЂЌ§†В^еf” F—В3k– Ж£Ж9YґВ! TдURAµlL `аЉfЎАA_r≥lx#ЫiЅ5ь1 ЌµјМ  }VРAV f“Р6”`а[6гВ3nИ#*МВ≥mР ЖѕЖ9YґдВЌї@ВЮе`ј+6рВ0X"Ђ,+Яђ*
ЌЉ†В¬е`а+6ш0X,џю!ЊANVm
`≤e¬            іhUPБb1ЩfА   ъ2Є ВЂклR†VmrfА ЂJ√©†£™b
Ќ¶АҐ3и †∞й`(Д a   "¬@  EЕАXP UЕ   6ЫВ∞ЂЄ(Ђ @@mifЁ@FUцfА ™ёЌ®`І≈Ђ*«∞п∞(™Р≥lа Ш "  X@ *≤ађ– ХkAEXP F"¬Ађ$ еYаVm°e\QV И∞∞ Ђ :≈V»Ы]AYWhUqБDX@ B  ∞† Ђ	 :≈W<Ъ  2ѓШ(™пВИ∞Р Д  a`bXVmД>-YT0ЫCЅD7ћ1 ЌҐјђ’Hfя†Sв’ЕHЅЕX@ D  
∞Р И  a и»  fџ0a_pVm>-XV$Ы@БД7д1 :°†ћЏhеf–РfЫOД45 *¬ VmJ`∞Yµ<CF√\Ґђ$ еf’†fЫWЅД4ƒ5 *¬@QV fА 7+6µ0X,;DЌ≠а¬~еfЎ f6≈k@kХЫdAШ,џи√ІаҐ  ъ2®`√™bЌ®јћЩp–     KlЅД   Л 3@  a†Л 
¬.шdшµa]0fёЦйГ≠h36Ўђ+r:ЇАћџЃЌѓ ђЂа!  wћUЗ ,џ*!ѓБЃQ’fё a0 ъжЫ№£™*ЌњаќQ’(f–јw(кпГ3hШ8Ш еfўјfВЅ`≤e√ј                                                                                                                                  -(Rg(™НГ3kи0МEИАTlF#XрVm#А —Х™А ,< *√јўэЫ]АЫTD!ЗYЅ≈Xx F"√ј:Ь!  XА UИ /гы6™Гґѓр;√К±  МEИ uіЪ  @   *ƒ@±UНf№РVUыaЏРqUФИ≠ ;«Г≥k` кЛГ≥h–9сj Ј@м;ц*ІАмџ$
& ѓ@(Ђ 
ѕЛVйZ@qHG Yґt	 *Є`м– ХyБЎwмЗ~≈W<RƒАЧ(™нГ≥@ Яa„јqV" uКѓP;4  ePаЖa’–qV ЊѕмЏи“•aџк!ЈЃVm `∞лаC6Пo(kХЫIB"  E@¬XИ÷*ІAџ. Ѓ!:ђ*®!1Ma”јЖm,–аз(™®Д
B8Р 2ЌЇаоVm3`∞Xu0!ЫU¬7») Ќ≠ALЇH     %ѓ°™Ќґ в-$ *™АБX 2ЌЈјоQU,≥m®(ЛJ 3i»™√ДAА Ћ6«	А≥и њ
і†сj ЄAЂZЌ∞!≥и №3jPка3mЎAсj £Б,џЖЌµ@гЂZЌє!Џ§  ЊA™n#ИўґШ! *ђ†lџ,ЌЉ†ћЂц√£Б#ЂМЌїA≥и ю
і†сj £!#™Ќњб≥и ЗД∞о(@кЛД≥hРHИ  ^0БїRРЦmй £*:*≥бX 2Ќ•б!Гь2Ќї°™™*≤Aь2Ќ®Ѕ,џж ≠#™jЌ§!Уь2Ќ™a,Џђ ѓ!#™ЄЌЂб"3и ЈДОЂЄK6єИѕ£*ф!АђЏ∆Ѕf÷p&mr—@з(кЅ≥kиKХЫ^B,U-КѕЛV{
R`Цm?	_0q }T`vm‘]pЖmЪ	f÷РЦЎ	Z–Цm∞	rК≠ШK6п≥n0K
чКЃ`HМF#f№рЧ(™цД3n∞K6мД≤ЂЎS6»ИiPsХЫgВX#ЂАЌЄa'≈Ђ*Ф3o®HЖЃЗ9EWL% ЌњБ,6ЕЕk†sХЫEВШ,:кЌ£aB:еQ І(™пД≥o(KХЫHВШ,6ФЕn8sФBА :≈W§%Ъ  9Yім)ВЅf‘°дrК©†PМF#f”pІXЕ  u≥jxSХЫT¬Ш, "іa2„∞¶mЬВА—ХЧ	fЁБVТ >МђS$†l2ШNfQјкtQР“s1И&б  @a73A‘и :Ґ!Љёr FSЩћ@' ЙƒCxАВn0Ы'3(∞@',	ƒCxА X4Э  РHФ» 1NЖSШАаe9fS–ёr  А@  А@   РIHёt0Э&уqДЎ )Ь¶S А“s 	У9† N7ЬН¶` 	С'CА§a:DУША L7Эј3IЄќl2АЖу©ИЎe Б Т!§жc¶гЩ§иyNb)ћ Б Т©Є¬b6DCxА»e:NF”IЄ  :Ґ!Ф№s4Э"аP 	ХQР“s1И¶»АƒeM∆3yіаl2Э¶√» 	ЩНз#iДиt2ЩуРА“n1ЫЌІ	–“b6DsI–– :'1Рдi;@ РH®T*»%"q$ЬGM∆∞  :ƒC)– r6ЪM∆QP†I
ЕB†P @ ЩЖБ–дa1ЪƒУША№u6ШМІ#)Р@%2А РI“s1ИЗHА“s	LА† $D4ЬћbIћ@s4ЫМж√(Ажi2LА† $D4ЬћbIћ@d7ЭLF√(Ажi2LА† $U7LF√(АиoOi§№eћ¶3yЄ» 9ЪLЖP Аƒe1ШNІ3(А»r4ЭМҐIћ@s4ЫМж√(іжi2LА† $*
Дr	HЬI'ƒгyЄ@s:M∆C	»» 9ЪLЖQШ“e61HАT*Б Р А@%ПБЉ№ 9ЪLЖQ ј ,	F#Ѕ @o7fУ!Ф@1 ¶√АД 	ФЌ&C(АJd √y№ s:fS–ёrDQСРX  &sAФжtћ¶3°Љд И£# А [Щ3)Миo9Ћ†† $*
Дr	HЬI'ƒSqДƒl2ИЖсР t2ЬН¶УqФ@s2ШќЖуР 	M∆cy»Џa:Mжб ®T*  Т!»“v2И— Ф`2<В°»¬c5И— Ф»,ћ¶3°Љд И¶A`А¶t0ЭІ1 ф@%ПАP 	*ЫМ&#aФ@t7ИFSa§¬b6DC)– r6ЪM∆Qћ c:ќBy»»e9А РI@–y9ЪLf`Ажe1Эз!Љдd2ЬДуpАжi2D§ж:A (»»   Т!§жc'1 Ф» :М&3Yћ ВEB°PАЃA)Й$в8А¶i2D!§№c7ЫN°§ƒl2ИжУ°†@S4ЩҐИАT*А РHА@S4ЩҐИАиr0ШЌbиАJd  С А™n0ШНЖQ–ё 9L&AМёr9NgyЄ»i7ƒ3IР  А РHА@S4ЩҐИАиr0ШЌbиАJd
fУ!Ф@2Fђ@=	LА† $ Ќ&C(Аb 9ЩLgCy»@s4ЮМҐиАJd 3IР  fS–ёrЌ'£(Аz Щ@ѕ.SWITCМ  4D»и ANALYSМЗ dUDфd»ј BUFFERМґЕT2д4»ќИC.ASRМҐD2дuH»0DC.LEМсƒ2д≈HЋ0MC.NOTМБЕT2е5ЕH»јEC.TSTМ  d4ДддXћhNCLREOLМДАd4≈$Tх8ѕ0CLRSМѓЕDDDј DEFLTМ°БдDTе4ХHѕа5DRIVEМЬдE%dDHѕАBE.МчДіRгј EX_ARGМ  dUЕф4фЎ»аFINDTFМ¶дd’EEШј FSTDRVМ  de5DДT…h>FSTSECМ≤Е$rиј GAP1М  Dt(ј GAP3М АdtUDіUШЋ0BH.МСДдДХE$8…АQIМ  ®ћKFLUSHМ  TƒФ‘ХHЋ†LPPAGEМђ d‘еT»ј MAXDRVМФГд‘Е4T8ЋиMOVEМѓиѕ`JN.МчА§тиј OFFSETМ  Tф‘Tt…`IPМђe$дeуЋИVPRNF_2М† eUDƒФи…®                       SETUB(SETTRK)
.pa
*/
/*======================================================================*/
STATIC VOID                                             /*		*/
settrk(track)                                           /* Select track */
WORD	track;					/* Track to select	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	e,1Eh
	jr	gobios
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                             SETUB(SETDMA)
.pa
*/
/*======================================================================*/
STATIC VOID                                                  /*		*/
setdma(dma)                                                  /* Set DMA */
WORD	dma;					/* Address to set	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	e,24h
gobios:	pop	hl
	pop	bc
	push	bc
	push	hl
ind:	ld	hl,(1)
	ld	l,e
	jp	(hl)
	.8080
#endasm
}

/*======================================================================*/
/*
.he                                                              SETUB(RDSEC)
.pa
*/
/*======================================================================*/
STATIC VOID                                         /*			*/
rdsec()                                             /* Read a sector in */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	e,27h
	jr	rwsec		; Continue as below
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                             SETUB(WRTSEC)
.pa
*/
/*======================================================================*/
STATIC VOID                                       /*			*/
wrtsec()                                          /* Write a sector out */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	e,2ah
	ld	c,1	; Flag as directory write
rwsec:	call	ind	; Go
	or	a	; any error?
	ret	z	; return if none
	.8080
#endasm

abort(1);			/* Abort on error			*/

}

/*======================================================================*/
                                          /* Write a sector out */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	e,2ah
	ld	c,1	; Flag as directory write
rwsec:	call	ind	; Go
	or	a	; any error?
	ret	z	; return if none
	.8080
#endasm

abort(1);	ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕT—UP†eu%D$Фщ@ ‘\               h  !  ђџZЅP`U >-XTі Cwј\ђ– В…А Vh  Ѕ>-YU C}@\ђЏR ЅaЏ@U ВАС P`h  "†ј™ Ќ™`   T  ®  Дb P U_ ≥ѕм– µcАT  F"† ±ƒ еVаh  "†@™  еfџp®  rКА mЙ ©јС † VmЉ`К®ХЫlАX,џР*≥`` К√ 
Ѓ  КЖ @ 
 P†(™Ж 3lр КД 
≠Ў КЕ 
®`ФUBАҐ™ еfА Ыs@ET F"†@±U
 uК®@ dEBАT *° џђ "†А™ л† – ÷"° ™ л† Џ<"†А  EpјT÷*¶†,– Х]АXuDUO Db*Р√¶а"™ #P [ХЫlАX"™ еfџј6жАК®P E  И®P£АИP +6ё ∞ET Ќґ@,m»† * *°АQU
 rК®@ХЫ{А,6жАИ_пч+6Щ 0Y2Џ–рl0dЋlАC¬ј!У-ЈГ 6Lґр<$p∞XЃQP kt≤eє !б8`
…ЦжАЗЕ@а6б ≠ў Ќµ ,I¬n7ќВЩФЎe1ЭCС§мe@#)Д» И
з#I–  2ЬОFуРАёnЙ$тШАкp2NЖPgl†°'©*F  2
ъJr"ƒ` !")+Fw "JzЬ` !&'°•©∆  2zzҐЪ‘` °()∆  2™22*Ф` !*£)§≠FK jr"Jіdь!Ч#™F] *rҐЪ§` !§ І'"∆  *bz\` " ™ ∆  2"*2"Ті` Ґ"£&*F  2"*rЪJ§` Ґ$©F  2"JТ*§` "'™°&"∆  "В` "(!! ©∆  2"ВҐҐ
` Ґ)$Ђ"∆  2"Т≤r
l` ")+* °FOј**ТТzФ` £ ™$ҐF  22"Ґ*¬§` £$©)™F  22jҐ §` #&™""©∆  22jҐ"Ті` £&™$ҐF  22jҐҐВL` #&™*)%∆  22ТЪҐЪ,` #ЧF  ":
БМ` #†®F  ":
БЬep$F  "BPUTSTRМƒДеUEdФHѕ∞:Q.Мњ≈$DHЌиNREADADМЁe$TE48ј REQDRVМ  5$хH…А:S.МЧe4T54Х®»А>SECTORМ¶e4T5E5®ћ0TSEEKМЊU4TT≥…ш>SETTRAМЁ≈4ФDXЋ»USIDESМ  U5D%HћhSTATEМАe5DEU8ј TFLМћАeDхUXћhUTRACKМ  5ED»ћ8>WT_NDXЬ   Ю  Tф‘Tt…`IPМђe$дeуЋИVPRNF_2М† eUDƒФи…®ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                                      ANRW
.pa
*/
#asm
	.z80
	title Read/Write routines for Analyse
;
; Routines to handle the disc drive for a "C" program
;

	external	drive		; Drive address
	external 	track,sector,stepr,settle,side
	external	data,status,ms

;	****** Interface card addresses *****

;	2793 Ports & Auxillary ports

I2793$	equ	0e0H		; Base address

cmdreg	equ	I2793$		; Command register
statrg	equ	I2793$		; Status register
trkreg	equ	I2793$ + 1	; Track register
secreg	equ	I2793$ + 2	; Sector register
datarg	equ	I2793$ + 3	; Data register
drivep	equ	I2793$ + 4	; Drive select port
stport	equ	I2793$ + 4	; DRQ/IRQ


;	2793 Commands

restor	equ	08H		; Restore command
SEEKCM	equ	18H		; Seek comand
stepcm	equ	38H		; Step command
STEPIN	equ	58H		; Step in command
STEPOUT	equ	78H
RDCMD	equ	88H		; Read Sector
WRCMD	equ	0A8H		; Write sector
RDADDR	equ	0C0H		; Read address
CLEARC	equ	0D0H		; Clear command
RDTRK	equ	0E0H		; Read track

.comment >
;=========================================================================
;     	Read Section
;	entry points:
;		read()		; Read at current track
;		readad()	; Read address of current track
;		readtrk()	; Read track
;		radd()		; Read address with retries
;=========================================================================
/*USE
Portability	Level 4 (Assembler)
Parent Module	ANALYSE
Revision History:-
18/09/89 Brought up to Timeclaim standards - ICFO
01/04/84 Last updated for correct (3ms) stepping
*/
>

radd::
	ld	b,32		; 32 retries
rad0:	push	bc
	ld	c,RDADDR	; Read address
	call	dord
	pop	bc
	ld	a,(status)
	or	a
	ret	z
	djnz	rad0
	ret
readad::
	ld	c,RDADDR	; Normal read address entry
	jr	dord

readsc::
	ld	c,RDCMD		; Read sector
	jr	dord

readtrk::
	ld	c,RDTRK

dord:	call	moton		; Get drive going
	ld	hl,(data)	; Pickup DMA address
	push	hl
	pop	de		; Copy to DE
	ld	a,(sector)	; Set sector
	out	(secreg),a
	ld	a,(sector)	; Set sector
	out*bД` $$£§"©∆S JL` §І""ђFCј2JrJҐ≤` $І+"©*F  2Jr≤ЪJ$`  •Fg jb"JТl` ¶$¶§™F  "bЪВ§` ¶ҐҐ$†∆  j2` &©∆  2r"ТJ≤,` І# ™)∆  2r™jЇJt` '£#)Ґ™F  
Д` ()Ґ°І*∆  *ВЪZ*Љ`  ®∆  *Кbz24` )"©™)%∆  2Тъ
Ъ,dD)ЧF  2ЪB
r<` )Ґ°™) ∆  *ЪJ"*4` ©§≠"£F  ЪВ` ©®"F  *ЪВ2
§` )®&"ђ&∆  ЪВ§` )®/§І$∆XА2Ъ ЪҐТ\` )ђ©™,®F  2Ъ ЪъҐћ` ™#&Feј2ҐТ
rЪ` ™)•ҐЂ∆  ҐҐdt8+©*!$І∆  2ЇЪВ
,а  Ю≤,` І# ™)∆  2r™jееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                                     SETUP
.pa
*/
#include	"portab.h"
#undef		EXTERN
#include	"setup.h"		/* Global variables		*/
#define		EXTERN	extern

#asm
	.request setlst,setfil,setpak,setfmt,setfdp,setbio,setub
	.request setlib,sethw,setsrch,setterm
#endasm

/*======================================================================*/
main(argc,argv)                                     /* Main entry point */
WORD	argc;
BYTE	*argv[];
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SETUP
Revision History
27/10/89 Brought up to Timeclaim standards
12/05/88 Version 3.45 - ICFO
         Delay routines use MS picked up from bios patch area for
         HD64180 CPU
10/03/88 Version 3.44 - ICFO
         SETFDP has a major change to rethink the setting of Line 2 to
         the relevant drive
16/02/88 Version 3.43
         SETFDP changed to suit dual density 3.5" TEAC FD35 HFN-22
         drives.  Density is toggled on line 2 of ribbon cable. 
         High density is HIGH
20/07/86 Version 3.41
         Small restructuring of insert() to prevent double entries in
         the alpha index table when an existing format is edited and
         resaved.  Also a spare 'word' in the data file is now carried
         over & stuffed into the BIOS when a new format is set up.
28/06/86 Version 3.4
         "Search" option added to SETUP.
         'First letter' control added to 'quick' lists.
         'OPSYS' field extended to 63 formats.
29/09/85 Version 3.3
         .INI option implemented when formatting discs
06/08/85 Version 3.2
         Various small bugs tidied up. (Cosmetic only).
30/06/85 Version 3.1
         SETFMT altered on Skew table entry.
         SETBIO changed to handle setup of skew tables properly
10/06/85 Version 3.0  (still)
         HARDWARE.DAT dropped & hardware data now compiled in to the
         program.  Hopefully this provides greater protection 	(secreg),a
	ld	a,c
	out	(cmdreg),a	; Issue Command
	ld	c,stport	; Point to status port
	jr	rdwait		; Wait

read1:	in	a,(datarg)	; Read data
	ld	(hl),a		; Put in memory
	inc	hl		; Bump address
rdwait:	in	b,(c)		; Read Status
	jr	z,rdwait	; Loop on no request
	jp	m,read1		; Jump on DRQ

	in	a,(statrg)	; Read status
	and	NOT 20H
	ld	(status),a	; Save it
	or	a
	sbc	hl,de		; Return length read
	ret			; Done

.comment >
.pa
>
;  Wait for the Index hole.

wt_ndx::
	call	moton		; Start the motor
	in	a,(trkreg)	; Get Type 1 command going
	out	(datarg),a
	ld	a,seekcm
	call	dotypi
ndx_lp:	in	a,(statrg)	; Wait for index
	and	82h		; Set if Index hole seen
	jr	z,ndx_lp
	ld	l,a
	ld	h,0
	ret

;  Copy TRACK to the track register

settrack::
	ld	a,(track)
	out	(trkreg),a
	ret

;  SEEK to track <track>

seek::
	call	moton
	ld	a,(drive)	; Set for 3ms min step.
	or	20h		; Make like an 8"
	out	(drivep),a
	ld	a,(track)
	ld	d,a
	in	a,(trkreg)	; See if there
	sub	d
	ret	z		; Return if so
	ld	c,STEPOUT	; In case out
	jr	nc,stepo	; Skip if so
	neg
	ld	c,STEPIN	; Set for IN
stepo:	ld	b,a		; Count to B
step:	ld	a,c		; Command to A
	call	dotypi		; Do it
	ld	a,(stepr)	; Extra delay
	sub	3		; Remove the base time of 3ms
	call	nc,delay
	djnz	step		; Loop if more
	ld	a,(settle)	; Add settling time
	call	delay
	ld	a,(drive)	; Reset
	out	(drivep),a
	in	a,(statrg)
	ld	(status),a
	ret

; SEEK to track 0

seek0::
	call	moton
	ld	a,(drive)	; Set for 3ms min step.
	or	20h		; Make like an 8"
	out	(drivep),a
	in	a,(trkreg)
	out	(datarg),a
	ld	a,seekcm	; Get head loaded
	jr	seek01
seek00:	ld	a,STEPOUT	; Issue a command
seek01:	call	dotypi		; Do it
	ld	a,(stepr)	; Extra delay
	sub	3		; Allow for 3ms already
	call	nc,delay
	in	a,(statrg)	; There?
	and	4
	jr	z,seek00	; No,loop
	xor	a
	out	(trkreg),a
	ld	a,(drive)
	out	(drivep),a
	ld	a,(settle)	; Add settling time
	call	delay
	ret

.comment >
.pa
>
	SUBTTL	Hardware Drivers

;********************************
;	Utilities		*
;********************************

;	Delay for <A> ms

delay:	or	a		; Immediate return
	ret	z		; ...if zero
	push	bc
	ld	b,a
msdel0:	ld	a,(ms)		; Set count
msdel1:	ex	(sp),hl
	ex	(sp),hl
	dec	a		; Delay
	jr	nz,msdel1
	djnz	msdel0
	pop	bc
	ret

; MOTON	Ensures the drive motors are running
;	- waits for them to start up if previously
;	stopped.
;	Returns A=80H and NZ if no disk
;		A=00  and  Z if a disk is present

moton:	ld	a,(side)	; Get side number
	or	a		; Check if > 0
	ld	a,(drive)	; Get drive address
	jr	z,is_0		; Skip if 0
	or	8		; else set side bit
	jr	is_1
is_0:	and	0F7h
is_1:	out	(drivep),a	; Address it
	nop			; Delay
	nop
	nop
   	in	a,(statrg)	; Check READY
 	and	80H		; Mask it
	ret	z		; Return if going
	in	a,(trkreg)	; Get head loaded
	out	(datarg),a
	ld	a,seekcm
	call	dotypi		; ..if necessary
; Following Time out is for those drives that return a "READY" line.
; With it, and no disc in the drive, there would be a hang up
	push	hl		; Save HL
	ld	hl,2000		; Set timeout 2 seconds
mot0:	in	a,(statrg)	; Check status
	and	80H
	jr	z,mot1		; Exit if ready
	ld	a,1		; Delay
	call	delay
	dec	hl		; Check count
	ld	a,h
	or	l
	jr	nz,mot0		; Loop if more
	ld	a,80H		; Set flag
mot1:	pop	hl		; Reset HL
	or	a		; Set Z/NZ
	ret			; Done

.comment >
.pa
>
;	Clear the 2793

clear:	ld	a,CLEARC	; Load the command

;	Do a Type I command

dotypi:	out	(cmdreg),a	; Issue command
	ld	a,(ms)		; Get seed
	sub	76		; 4MHz clock?
	ld	a,10		; Short delay
	jr	c,doid
	ld	a,20		; For faster CPU
doid:	dec	a
	jr	nz,doid
doiw:	in	a,(statrg)	; Read status
	bit	0,a		; Busy?
	jr	nz,doiw		; Yes,loop
	ret			; Else done

	end
;=========================================================================
#endasm


;	Do a Type I command

dotypi:	out	(cmdreg),a	; Issue command
	ld	a,(ms)		; Get seed
	sub	76		; 4MHz clock?
	ld	a,10		;ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееagainst
         rip-offs.
         Preliminary release for MFB II & GM849.
24/08/84 Version 3.0
         HIDDEN Macro introduced to conceal text within SETUP in order
         to prevent Signon messages and	text headings being changed by
         the unscrupulous.
         "U" format introduced to cope with the IBM PC.
         DRVFMT.DAT split into two files - HARDWARE.DAT and FORMATS.DAT.
         The latter has a directory appended on the front, and only this
         is read into memory.  This way a much larger format list can be
         supported, as only the directory is held in memory.
         Conditional Compilation also added to provide for SET.  This is
         a stripped down version of SETUP that reads a file and sets up
         a configuration to suit.
         Skew table entry altered to allow the skew to be extended over
         a combination of the first and second sides.
27/03/84 Version 2.9x
         Modified so that Format & Verify step the drive at the correct
         rate, rather than the slowest rate.  Also a 'verify only' mode
         added.
         Version 2.8
         Modified for dynamic buffer size allocation & MSDOS support in
         the data file.
         Version 2.7
         Modified to support Multiple Winchester drives.  i.e. it will
         not re-define any Winchester drives defined at system
         generation time.
06/01/84 Version 2.6
         Modified to be compatible with BIOS 2.X or 3.X
         ("MFB" ID in different places!).
         Also screen lock added to keep things tidy
01/11/83 Version 2.5
         Added  handling of ITT3030 (Restricts max block number to 255
         if 1K block allocation specified).
         Changed SETUB so only updated info re-written to the system
         track. (Because of Grope software and "M"-drive).
17/10/83 Version 2.4
         Added Screen dump and altered abort method.
16/08/83 Version 2.3
         Added option for non-standard extent masks.
14/08/83 Version 2.2
         Format display tidied up for large data file
29/06/83 Version 2.1
         Still tidying odd ends of 2.0 (which was never released)
23/06/83 Version 2.0
         Major revision that moves all references to DRIVES to a
         separate program
19/06/83 Version 1.4
         SETVER added to the suite to verify discs following FORMAT
16/06/83 Version 1.3
         A few Bugs corrected. Re-compiled under C/80 vers 2.0
         "Logical spt" added to cope with Merlin Format etc.
         Written by David Parkinson
         (c) dci software 1983, 1984
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (abort(0) != 0)  byebye();
clrs();					/* Clear screen			*/

putsat(10 RC 15,"(c) dci software 1986 & Timeclaim Ltd 1988, 1989");

initvar();				/* Set up pointers to BIOS	*/
head();					/* Put up a heading		*/

bufsiz = 32512;
while (bufsiz > 256) {
    if ((data = alloc(bufsiz)) != FAIL)  break;
    bufsiz -= 512;
}
if (bufsiz <= 256) {
    putstr("Insufficient memory available\n");
    return;
}

dir = data;				/* Directory buffer		*/
open();					/* Open data file load directory*/
while (TRUE) {
    qloff = 0;
    clreos(3,0);
    putsat( 6 RC 23,"Return to CP/M...............0");
    putsat( 7 RC 23,"Enter/Edit a format..........1");
    putsat( 8 RC 23,"List current Formats.........2");
    putsat( 9 RC 23,"Assign formats to drives.....3");
    putsat(10 RC 23,"Locate a similar format......4");
    putsat(12 RC 23,"Enter required option : ");
    clreos(12,23 + strlen("Enter required option : "));
    switch (buffer[0] = getkey()) {	/* Get it			*/

	case '0':
	    fclose(channel);		/* Close the file		*/
	    smove(0);
	    clreol();			/* Clear the top line		*/
	    clreos(3,0);	   	/* Clear the rest of screen	*/
	    byebye();

	case '1':
	    setformat(1);
	    break;

	case '2':
	    conout(buffer[0]);
	    listfmt(upper(getkey()));
	    break;

	case '3':
	    setbios();
	    break;

	case '4':
	    same_fmt(); break;
    }
}

}

/*======================================================================*/
   fclose(channel);		/* Close the file		*/
	    smove(0);
	    clreol();			/* Clear the top line		*/
	    clreos(3,0);	   	/* Clear the rest of screen	*/
	    byebye();

	case '1':
	    setformat(1);
	    break;

	case '2':
	    conout(buffer[0]);
	    listfmt(upper(getkey()));
	    break;

	case '3':
	    setbios();
	    break;

	case '4':
	    same_fmt(); breaееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФЩXY’аE$DHIREADSCБФСPQ†euEфдEИMQQISEEKБT—QRћ%  SА0БК`3hЎt  -ўУ$јБ»Ајаfё@P  еhОА ЫИuI n#ЋMјr НЈ№Fн 
П™h џp9Ыг* ЈvФЩ,џ» џpі№cа√6РАґ№d°фo #† ¶бd≥o  и  {nA’a +ґ№)&@8р0;HАвЅтЌ§ #† ђj]@ Г»t  3n† кµ 4№НЈ  Ґ 2YЈР ueА¬ЫСґбiЄ«ЅАј|xf“’Ж k ЏЧPґаs’{M¬:іА7 к» 3n†%n»bС«@ Н∆=>¬f$t  -«W$ P{ '3Ё¶д   ЈЩ »mЄZn1рaЫH@\ҐАґаs  ЅрЫu g≈®Ба>@8VмСуA¶а]Р±0|
 ЗЅAиБъџp2»в”&2>Uc= I%Y2HУTг† I:"ФСPQQ#Ґ†IM:2ФСPQ£% MQ=J:ћ—QRгі M,¬3ЬФ—Ucђ MQQI3 “Qc3†MQQUN3pT’T£. QI.:ФХ’”С'   ЮН∆=>¬f$t  -«W$ P{ '3Ё¶д   ЈЩ »mЄZn1рaЫH@\ҐАґаs  ЅрЫu g≈№Fн 
П™h џp9Ыг* ЈvФЩ,џ» џpі№cа√6РАґ№d°фo #† ¶бd≥o  и  {nA’a +ґ№)&@8р0;HАвЅтЌ§ #† ђj]@ Г»t  3n† кµ 4№НЈ  Ґ 2YЈР ueА¬ЫСґбiЄ«ЅАј|xf“’Ж k ЏЧPґаs’{M¬:іА7 к» 3n†%n»bС«@ Н∆=>¬f$t  -«W$ P{ '3Ё¶д   ЈЩ »mЄZn1рaЫH@\ҐАґаs  ЅрЫu g≈®Ба>@8VмСуA¶а]Р±0|
 ЗЅAиБъџp2»в”&2>Uc= I%Y2HУTг† I:"ФСPQQ#Ґ†IM:2ФСPQ£% MQ=J:ћ—QRгі M,¬3ЬФ—Uееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                                   SETUP.H
.pa
*/
/*======================================================================*/
/*                           SETUP.H					*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SET, SETUP, etc
Revision History:
05/10/89 Brought up to Timeclaim standards - ICFO
         Table of operating system names now same as AMIE.011 - ICFO
18/10/86 Internal Key codes added (C_UP etc)
20/06/86 <tskew> variable added.
07/06/85 Config/Hardware now compiled in.
19/04/85 Format record now packed/unpacked to INTs
14/04/85 Split out from SETUP.C.
10/06/85 For SETUP Version 3.0
*/

/* SETUP Header file containing declarations for all Global defines &	*/
/* variables.								*/

#define		CPM	0	/* CP/M data entry			*/
#define		MSDS	1	/* MSDOS alternative			*/
#define		MAXSYS	64	/* Only 63 alternatives			*/
#define		DIRSIZE	8192	/* FORMATS directory size		*/

#define		FIND	1
#define		ADD	2
#define		DELETE	3

#define		RC	*256+	/* Used in abreviated Screen moves	*/

/* Global variable declarations. These should be stored in successive	*/
/* memory locations.							*/

#ifdef	EXTERN
EXTERN
#endif
struct	drec	{		/* Configuration Data / Drive spec.	*/
	BYTE	id[9],		/* Drive identifier			*/
		addr,		/* Drive address			*/
		type,		/* Drive type				*/
		tpi,		/* Drive tracks-per-inch		*/
		trk,		/* Drive tracks-per-surface		*/
		sides,		/* Drive sides				*/
		stepr,		/* Step rate (ms)			*/
		hload,		/* Head load time			*/
		settle,		/* Settling time			*/
		hsp;		/* Dual speed opt			*/
} *drive;

/* Format specification. This is now filled in from the disk record via	*/
/* a pack/unpack routine. This allows economical compilation, whilst	*/
/* allowing the information to be held on disk in 128 byte records.	*/

#ifdef	EXTERN
EXTERN
#endif
BYTE	fmtid[9],		/* Format identifier			*/
	fmtdesc[33];		/* Format description			*/

#ifdef	EXTERN
EXTERN
#endif
WORD	fmtdrv,			/* Format drive type required 		*/
	invert,			/* Inverted data flag			*/
	schange,		/* Side change flag			*/
	invside,		/* Invert side flag			*/
	index,			/* Index flag				*/
	density,		/* Density flag				*/
	clock,			/* Data transf. rate			*/
	fmttpi,			/* TPI required				*/
	fmttrk,			/* Tracks-per-disc req.			*/
	spt,			/* Sectors-per-track			*/
	bps,			/* Bytes-per-sector			*/
	spd,			/* Sides-per-disc			*/
	gap1,			/* Formatting gaps			*/
	gap2,			/*	"				*/
	gap3,			/*	"				*/
	fmtbyt,			/* Format byte				*/
	sidef,			/* Bytes for side fields		*/
	sizef,			/* Size field of sector 		*/
	systyp,			/* System type flag			*/
	blocksz,		/* CP/M blocks size			*/
	directry,		/* Directory entries			*/
	restrk,			/* Reserved tracks			*/
	frstsec,		/* First physical sector 		*/
	pskew,			/* Physical skew			*/
	lspt,			/* Logical sectors per track 		*/
	splexm,			/* Non-standard extent mask  		*/
	sp_init,		/* Special initialisation 		*/
	tskew,			/* Track skew param used externally to	*/
				/* SETUP 				*/
/* MSDOS extras								*/
	bootsz,			/* Boot size in sectors 		*/
	spc,			/* Sectors per cluster			*/
	spfat,			/* Sectors per FAT			*/
	media,			/* Media byte				*/
	nfats,			/* Number of FATS			*/
	fatid;			/* FAT ID byte				*/

#ifdef	EXTERN
EXTERN
#endif
BYTE	sectrans[60];		/* Sector translation table		*/

/* End of record images - start of global variables			*/

#ifdef	EXTERN
EXTERN
#endif
BYTE	*p,
	*q,			/* General pointers 			*/
#ifdef SET
	*bp,			/* Pointer used by SET			*/
#endif
	buffer[324],		/* Line buffer				*/
	deflt[324],		/* Default entries for line buffer	*/
	help,
	*data,			/* Pointer to data file area		*/
	*dir;			/* Pointer to FORMATS directory		*/

#ifdef	EXTERN
EXTERN
#endif
WORD	i,
	j,			/* General INTs				*/
	bufsiz,			/* Buffer size				*/
	channel,		/* Channel no. of data file		*/
	qloff,			/* Offset for quicklist			*/
	r_base,			/* Base record number for data records	*/
	highest,		/* Highest e/*
.he                                                              ANTF(FINDTF)
.pa
*/
#include	"portab.h"
#include	"analyse.h"
#include	"printf.h"

/*======================================================================*/
VOID              /*							*/
findtf()          /* Seek to an inner track to do "Read Track" analysis */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	ANALYSE
Revision History:-
02/10/89 Gap 1 limit raised to 120 for Single Density - ICFO
21/09/89 Gaps are now written in the correct place on the screen when
         help has been requested.  Achieved by the use of 'where'
         and 'smove'
         (Change in FGAPS) - ICFO
         Detection of index mark more sophicticated
         (Change in FINDTF) - ICFO
18/09/89 Brought up to Timeclaim Standards - ICFO
15/04/83 Last updated
*/

{

/* Hopefully the original format output may not be overwritten so	*/
/* preventing the "Read Track" losing sync.				*/

/* Although the code for the detection of the index mark has been 	*/
/* considerably tightened up it could still detect an invalid index 	*/
/* mark if the CRC for the Sector Header had the value 0xC2, 0xFC (in 	*/
/* Double Density) or 0x00, 0xFC in single density.  The code to detect */
/* the Sector Header (0xFE) and the Data Address Mark (0xFB) could be	*/
/* improved in the same way.						*/

LOCAL
WORD	l;

LOCAL
BYTE	*index;

STATIC
VOID	fgaps(),
	reload();

STATIC
WORD	help();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n = 0;
start = data;				/* Zero pointer			*/
do {
    reload();				/* Fill the buffer		*/
    p = data;				/* Initialise pointer		*/
    j = (density == 'S') ? 60 : 120; 	/* Search limit			*/
    for (i = 0; i < j; ++i)  if (*p++ == 0xFFFC) {
	if (density == 'S') {
	    if ((*p == 0xffff || *p == 0x0000) && *(p - 2) == 0x0000)
								    break;
	}	/* Braces necessary to tie 'else' with correct 'if'	*/
	else if (*p == 0x004e && *(p - 2) == 0xffc2)  break;
    }
    ++n;
} while ((n < 3) && (i == j));

if (i < j)  index = "present";
else {
    p = data;				/* Reset pointer		*/
    if (autofl != 0)  index = "probably absent";
    else {
	i = help("Can't see the Index mark (FC)");
	index = (i != 0) ? "present" : "absent";
	p += --i;
	*p++ = 0xFC;
    }
}
printf("\t\tIndex mark %s\n",index);
fgaps();

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                     ANTF(FINDTF / RELOAD)
.pa
*/
/*======================================================================*/
STATIC VOID                         /*					*/
reload()                            /* Reload the buffer with the track */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

seek0();
track = hitrack - 4;			/* Use previously det. Hi track	*/
if (fmttpi != (drvdat->tpi & 255))  track = (track & 0xFF) - 4;
seek();
readad();				/* Set up the track		*/
p = data;
track = *p;				/* Track as read		*/
limit = readtrk();			/* Now fill the buffer		*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                      ANTF(FINDTF / FGAPS)
.pa
*/
/*======================================================================*/
STATIC VOID /*								*/
fgaps()   /* Search the buffer for 1st sector header to determine gap 1 */
/*======================================================================*/

{

LOCAL
WORD	rc;			/* Row / Column of current position	*/

STATIC
WORD	fsh();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

start = p;				/* Save where we are		*/
while (TRUE) {
    printf("\t\tGaps 1/2/3 = ");
    rc = where();
    gap1 = fsh(120) - 1;		/* Locate sector header		*/
    if (gap1 == 99  && autofl != 0) {
	printf("**/**/**\n");
	break;
    }
    smove(rc);
    printf("%d",gap1);
    fsthead = gap1 + start + 1;
    start = p = fsthead + 6;		/* Move past header		*/
    rc = where();
    for (i = 1; i < 100; ++i)  if (*p++ == 0xFFFB)  break;
    if (i == 100) {
	if (autofl != 0) {
	    printf("/**/**\n");
	    break;
	}
	else {
	    i = help("Can't find start of data block (FB)");
	}
    }
    gap2 = i - 1;
    smove(rc);
    printf("/%2d",gap2);
    p = start + gap2 + secsize + 3;
    start = p;
    rc = where();
    gap3 = fsh(150) - 1;		/* Locate next header		*/
    smove(rc);
    if (gap3 == 149 && autofl != 0)  printf("/**\n");
    else			     printf("/%2d\n",gap3);
    break;
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                        ANTF(FINDTF / FSH)
.pa
*/
/*=============ntry used in the directory	*/
	*a_indx;		/* Start of alphabetic index		*/

#ifdef	EXTERN
EXTERN
#endif
BYTE	psecnum[64];		/* Physical sector table		*/

#ifdef	EXTERN
EXTERN
#endif
struct	btable	{		/* Image of BIOS drive table		*/
	BYTE	pda,		/* Physical drive address		*/
		log2ps,		/* LOG2(Physical sector size/128)	*/
		psm,		/* Physical sector mask			*/
		flg,		/* First sector number + flags		*/
		pst,		/* Physical sectors/track		*/
		blmm,		/* BLM for DPB				*/
		str,		/* Step rate				*/
		stm,		/* Settling time			*/
		hlt,		/* Headload time			*/
		mts;		/* Max track before side-swap		*/
	WORD	sttp;		/* Sector translate table pointer	*/
	BYTE	lst,		/* Logical sectors per track		*/
		sys;		/* Op system - CP/M  or MSDOS		*/
	WORD	tskew;		/* Track skew - used outside SETUP	*/
} bdrv;

#ifdef	EXTERN
EXTERN
#endif
struct	dpblock	{		/* Image of Disc Parameter block	*/
	WORD	spt;		/* CP/M sectors/track			*/
	BYTE	bsh,
		blm,
		exm;
	WORD	dsm,
		drm;
	BYTE	al0,
		al1;
	WORD	cks,
		off;
} dpb;

/* Various pointers used while patching the BIOS			*/
#ifdef	EXTERN
EXTERN
#endif
WORD	*dpttab,		/* Pointer to the Drive table area	*/
	wspace,			/* Current start of free workspace	*/
	double,			/* Double step flag for 48/96		*/
	defdrv,			/* defauilt drive in format request	*/
	numwin,			/* number of logical Winis defined	*/
	limit,			/* Max no of drives available		*/
	systrk,			/* System track number			*/
	offset;

#ifdef	EXTERN
EXTERN
#endif
BYTE	mfb,			/* Set TRUE if BIOS is a MFB		*/
	*bios,			/* Set to BIOS base address		*/
	*ndrives,		/* Number of drives implemented		*/
	*drvtab,		/* Pointer to the Drive table base	*/
	*dpbbas,		/* Pointer to the Disc param. block area*/
	*transb,		/* Pointer to the Sector trans. tables	*/
	*fdtext,		/* Pointer to format/drive descriptors	*/
	*first,
	ms;			/* Seed for delays			*/


#ifdef EXTERN
EXTERN
BYTE	tfl[],			/* Drive translation - from logical	*/
	ttl[];			/*  "         "      -  to  logical	*/
#else
BYTE	tfl[]={1,2,3,0,5,6,7,4},	/* - from logical		*/
	ttl[]={3,0,1,2,7,4,5,6};	/* -  to  logical		*/
#endif

/* Operating system types						*/

#ifndef SET
#ifdef EXTERN
EXTERN
BYTE	*sys_typ[MAXSYS];
#else
BYTE	*sys_type[MAXSYS] = {
		"CP/M",
		"MSDOS",
		"UNIXTAR",
		"IBMDEX",
		"DGRDOS",
		"ICLDRX",
		"OS9",
		"FLEX",
		"DEC",
		"BOS",
		"UCSD",
		"MIRAGE",
		"CTOS",
		"ICLME29",
		"GCOS",
		"BBCDFS",
		"MOS",
		"EXCELLON",
		"HPEGC",
		"APOLLO",
		"ICLPERQ",
		"TAPE",
		"TAPE",
		"TAPE",
		"TAPE",
		"TAPE",
		"TAPE",
		"CPN",
		"HPLIF",
		"BBCADFS",
		"WANGVS",
		"OP31",
		"LANEWP"
	};	       		/* 0-32 for now.  63 = NONE		*/
                        
#endif                  
#endif                  
#define		DEFSYS	 33		/* 33 formats defined 		*/
                        
/* Drive types		        					*/
                        
#define FIVE	0       
#define EIGHT	1       
#define THREEHALF 2     
#define THREE	3       
#define FIVEH	4	        	/* High speed option on 5" drive*/
                        
#define H_BIT	4	        	/* High speed marker bit	*/
                        
#ifndef SET             
#ifdef EXTERN           
EXTERN                  
BYTE	*drvname[5];    
#else                   
BYTE	*drvname[] = {  
	"5",            
	"8",            
	"3.5",          
	"3",            
	"5H"  };        
#endif                  
#endif                  
                        
/* Internal control codes from the keyboard				*/
                        
#define C_LEFT	  0x81
#define C_RIGHT   0x82
#define C_UP	  0x83
#define C_DOWN	  0x84
#define SC_LEFT   0x85
#define SC_RIGHT  0x86
#define SC_UP	  0x87
#define SC_DOWN   0x88
#define S_DUMP	  0x89

/*======================================================================*/
              
#endif                  
                        
/* Internal control codes from the keyboard				*/
         ЕT—UT ШBDRIVEБQУUQ dd’DDU85QIZINVERTБФ–“SСаdФеe4ФH%9bDENSITБP”–“аdd’EEШ5QQI.SPTА–Фа55H@∆GAP2Б–Tаdd’D%ХHM%SIZEFБФ÷T’T d$ƒф4µ8%IRRESTRKБСФФ’—`U4іUx1MARSPLEXMБФ‘“SТ`UE4іUx	==QMjSPCБT‘РU T‘TDФ9QNFATIDБФ—P’Р`	UJDEFLTБS DDD%JJБРХQФ“V†d4ДддXE1=R_BASEБТQ“TаdфФдEИAM9VBDRVА—†dEED(]MADOUBLEБСQСХ†dеT’tФи1%5%RSYSTRKБУ—СФ—U 4‘d(	%=NNDRIVEБСХХP†dE$$8QI9M
FDTEXTБQТTФ’ $’8Q2TTLБФ÷T„’`dE%dдЎ5%:QШ5ЋЧ                                                                                                                                                                                                        Kљ e« `                                                                                                                                                                     -   АА` (А   8
Ґ TT
НБR0*TL@©ј<® U
§БTа*™VАЂg≠јU»
љБX+d ђАР≤ V@
»YP+2gј≠8Ѓґ`@                                                         =========================================================*/
STATIC VOID                        /*					*/
fsh(limit)                         /* Find the next sector header start */
WORD	limit;				/* Number of bytes to try	*/
/*======================================================================*/

{

LOCAL
WORD	i;

LOCAL
BYTE	*org;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

org = p;
for (i = 1; i < limit; ++i)  if ((*p++ == 0xFFFE) && (*p == track)) break;
if ((i == limit) && (autofl == 0)) {
    i = help("Can't find the sector header (FE)");
    if (i != 0) {
	*(org + i - 1) = 0xFE;		/* Set it for next scan		*/
	*(org + i) = track;
    }
    else  ++i;
}

return(i);

}

/*======================================================================*/
/*
.he                                                       ANTF(FINDTF / HELP)
.pa
*/
/*======================================================================*/
STATIC WORD                    /*					*/
help(s)                        /* Manual Help for buffer interpretation */
BYTE	*s;					/* String to output	*/
/*======================================================================*/

{

LOCAL
WORD	i,
	l;

STATIC
BYTE	s1[] = "Enter offset from start (00 or <Return> if absent):";

STATIC
VOID	pb();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

l = where() / 256;				/* Find current row	*/
pb(start);
move(lppage() - 2,0);
putstr(s);
putstr(".\n");
putstr(s1);
if ((i = getint(24,strlen(s1) + 1,0)) == -1)  i = 0;
clreos(l + 1,0);
move(l,0);

return(i);

}

/*======================================================================*/
/*
.he                                                         ANTF(FINDTF / PB)
.pa
*/
/*======================================================================*/
STATIC VOID                        /*					*/
pb(p)                              /* Print out the start of the buffer */
BYTE	*p;				/* Pointer to buffer to print	*/
/*======================================================================*/

{

LOCAL
WORD	i,
	j;

STATIC
VOID	prtdec();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

crlf();
hil_on();
putstr("   ");
for (i = 1; i < 26; ++i) {
    putvid(' ');
    prtdec(i);
}
hil_off();
crlf();
for (i = 0; i < 6; ++i)	{
    hil_on();
    if (i < 4)  putvid( ' ' );
    prtdec(i * 25);
    hil_off();
    putvid(' ');
    for (j = 0; j < 25 ; ++j)  puthex( *p++ );
    crlf();
}

/* Let C80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                     ANTF(FINDTF / PRTDEC)
.pa
*/
/*======================================================================*/
STATIC VOID                           /*				*/
prtdec(i)                             /* Print a 2-digit decimal number */
WORD	i;					/* Number to print	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (i < 10)  putvid('0');
putnum(i);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                     ANTF(FINDTF / PUTHEX)
.pa
*/
/*======================================================================*/
VOID                                           /*			*/
puthex(a)                                      /* Print a Hex character */
BYTE	a;					/* Character to print	*/
/*======================================================================*/

{

VOID	puth1();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

puth1(a >> 4);
puth1(a);
putvid(' ');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                      ANTF(FINDTF / PUTH1)
.pa
*/
/*======================================================================*/
VOID                                            /*			*/
puth1(c)                                        /* Print one hex nibble */
char c;	                                             /* Nibble to print */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

c = c & 0xF;;
if (c > 9)  c += 7;
putvid(c + '0');

/* Let C/80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее            [†+xoАЃƒЗФ—U’!е4UDdФ»yMQA.SETFMTЗФ—UС!е4UD$ФшuMQU
SETLIBЗT—Uбх4UE5$4И}MQQI4B  9Y† шµeZ†h  Ќ   рSФCqјЬђ– ВЅfА –  B ?И≤Ђ БД_зжh  “ЊАђВеfА 9≥@ Uз aя@VAАЅСAa№`VAњѕћџЪ Џ° "реfА HЂБИ±Ў4  А@≈Ђ*ЗБ@ EАјQ  еfА Д.rИhЄХЫmА,\е”`7+6Ы ∞X"Є! !™†nVmC`∞D!pKФC] №ђЏ†Ѕ`ИBаІ(Ж…БєYµtВЅЕЅОQ≤r≥kPВ! ҐdеfА И\ r≥iHВЌ  £-` √Њ`"ђЖеfА   еfА h  !АҐ  Ќ±†,6‘ @ +4  `∞и`лX 3@ +4  `≥lРХЪ  0\ђ– В√°АL– ЗC Щ† Ж0и`4  ≥`# ЊА.H»y F`‘4   :$…!Фд–4¶D'ФјRq$∞T ФАТ4ИE, ДrСЮS Hd¬!H∞ 'Ф« 10КX §0ЮS He2  ЪI)HдP®O)А	$2a4К2Ад2yL B!»ДbШ ЪO)А•ВШL'УАВБОC Jтa0Ю $Р…Е)HҐ *JP†N 
¬I B!»$B1L W УИеbШ ЮPМ@¬	8КW( †ј f.А`©  (1КDC§@s7ЩОЗs	»  ОGa Ш@T4ЫL¶3aД“mЖA ƒr8»аr $ЫОgS1Ш“c4ЩM«Aі m7ЬП"	Ў¬i6LF√(( R2ЭІ#pАиo тhЄ\.Е¬бpЄ\.Е¬бА Кn:NBт)Р“tDcy»Џa:Е¬бpЄ\.Е√0“s:gSС» n:∆уСі¬t9ЛЕ¬бpЄ\.Ж@	ћжi3ЫДcy»Џa:ƒCxА»r4ЭМІ1pЄ\.ј√yМ¬t2И"Щ§Џi6NB1Љдm0Э¬бpЄ\. ¶г°Фд 9N'SI» dќCIЉ№  Я@\¶ЃТ®ЗЯ ®(IкJСЭp
ВШШЮЗK»+й)»Ли–8ДИ§≠љИI)кqе ДШЮЖЦІd »IйкКkQд Д†І∞ »J®»»™Qд<Д™М¶ТµЉ»K(®K(±Ь–Ж\¶∞©ы ®e КjСд0<ЖРВЬЬЛ8 ®iЙиiqЪјЖШ§КЮЩЈ»iКH©кqЪ∞ЖШ§І—»iй…к™СгР8ИВ®Г≤»И®»КJ—п@ИКМШ©6 »И© i*Сг∞6ИТ•T »Й*H®jСл <ИЮ™ДШЛЭhКQм0<И†ДДВІђ»К
КИ(Qа 
И§ТђЛР »КJ…»)±м<И§ђ®ВЕя h•∆жа
МВ®ТЙ†»»iЙкh±мp<МИ®К∞©…®…*JjСд†МЪ®Д≤© »…™ИИ™qвјМЪ®И§≠ ®…™Й(Сг†МЪ®®†У< »…™ККIqеАМ§¶®¶Л  Hе—д@ОВ†cF Ии*QдАОВ†g’»и™ЙhЂ1ЫаРКВЙ8Й©КдР<РТОРКІ=)1г@
ТЬИК±ї …)…*К»1ваТЬђК§©2 …)  i(Сгр2Хґ©Й)©*СЭаШТ¶®МЫ\ ЙКj
Сў†ЪВТЭj ©®®Й(1лј6ЪМЕЋI™qлр<ЬИ§ТђЛl ©»»*Кqл@<Ь™ЪЃТЭЇ…и» h™СС Ю†КЭђ *д–<†¶КЖЬЂZ ™
ih™сЧp†™®¶В© 
™КjКQка£E™)Йи»—е`§К¶®§ЧG KиH*h±Ю∞¶ВЪКЊН0  hi)»сз ¶КЖ®§Ге h™ИI)сЬ0¶К®МЮ•L ™i(И®—да
¶ТіКН®™i©к»±ж`¶†ЗB jjСжА
¶†МВ©^  j	ИЂ	±га¶†©`  jй)…1Ш@¶®§ШКЭЄ k*jКIqе ¶≤¶®≤°  k*kкЛ1– ®МЩ≈ КH) hQж 
®¶ЦКѓ jКЙСЭР™††К•Ѓ кj(h≥А  ЮВееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                               SETVF(VERIFY)
.pa
*/
#include	"portab.h"
#include	"setup.h"

/* 2793 or 1797 registers						*/
#define		CMDREG	0E0h
#define		STSREG	0E0h
#define		TRKREG	0E1h
#define		SECREG	0E2h
#define		DATREG	0E3h
#define		DRVPRT	0E4h
#define		SEEKCM	018h
#define		STEPIN  058h
#define		STEPOUT 078h

/* Variables used by verify						*/

WORD	track,
	sector,
	side,
	erflag;

EXTERN
WORD	pda,
	autofl,
	soft_err,		/* Number of tracks with soft errors	*/
	hard_err;		/* Number of tracks with hard errors	*/

STATIC
WORD	line,
	lppge;

/*======================================================================*/
WORD                /*							*/
verify()            /* Read Verification of a disc reporting all errors */
/*======================================================================*/
/*USE
Portability	Level 4 (Assembler and depends on Gemini hardware)
Parent Module	FORMAT
Revision History:
01/01/91 Major upheaval to 'readtrk' because if a DDM or RNF was
         found on track 0 the Physical Drive Address ('pda') was
         set to Double Density.  This was OK for IBMDEX discs with
         track 0 written at single density but the rest of the disc
         at double density but not for a disc which really was
         written at single density throughout - ICFO
28/12/90 Screen is scrolled when it is filled and 'break' or
         'verification complete' message now displayed on line 7
         of the screen - ICFO
06/11/89 Screen layout tarted up a bit - ICFO
         Can handle single sided formats on side 2 of the disc
         (eg BBC48S1)(BR523)
         Change to SETVF / READTRK) - ICFO
         'home' changed to 'd_home' to avoid confusion with 'home' in
         terminal library for cursor positioning - ICFO
27/10/89 Brought up to Timeclaim standards - ICFO
01/07/86 Soft/hard error count introduced.
03/07/85 Side compare enabled if approp. during verify
10/06/85 Version 3.0
         Modified ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕSХ†ddФдEDhAUQ!bPUTH1Ф	 MxA•ј     -  А    T  А mrPp  :  †  EZ€≥@ U+ П :\ !< @  Д    ™^ лSPh   Ї@:Ґ *ІА1H a”pU И™Р ≠Ъ  @А …сj¬єа™, Ќ£ kь2|Z∞≠8 ™Ђ 3j– НЫH V( U]@µаЫ_ † *ЌА
ђ ђVЌ∞†џ Ќ±`ЂH √Ї@;Ю *≤ џ, Y?√,џ2  ЄјЂP +≥mX D| ≥mР6ќ 2Ѓxй Ksј%єа:О *†А1” ]p И ЌІаЂё *І QUL fА џО ¬°АЂћ л^†mа eP∞%` ^Q Є   Џ“ |Z≤©(ЖЦГ∞ѓ Иiи3ХЫNA"+ф *•ј,џа  Іа"J√®@"l"ј@™b+T`X™ЗАЖDU8UTАDb*™+?%Ђј,–  CVЅЬҐђ еfА 6бА≤Y†  ®  њбУи»    X 2ЌЈ†`ФT  3@ U¶Wаm /«шdъ2≤а,– Ъ  
®`КђАК≠А6ƒ ЯFVРЪ  А LЄ   ЦбАК≠ШКЕ @ в’ХS@ўµ|C[ЬђЏ‘ЅfА , !< ђЏЬЅИА UмІ_бЦmƒ eP@!’fў†m4f– &UfЁ |r≥n»ЗS@≈X Ќ  ,Џ!∞јќQUпr≥hРВ*Єа.±U(Иƒ@  ™Э@ј »Кв И©И6оАИ∞  Д T†USІм– µb ШuЄUUАДb* √™†B™И#Vр![6џ Д@† …сj¬∞†L;√ђАB™“N?√'≈Ђ
ЁБѓа6€АЯђЂ`Ќ§ Bьеf“ј&¶Б∞нЎЖƒГ9YідВ"± Rџ∞!UєИА V r≥hиЫh Д6і *Є NVmІ`∞EU	÷*Ї@AЧX®  Иƒb1s^∞!џf‘†! •АVmN`Кƒ@  Ђ 9YЈ	В*†`a[ь2ЌЊј,™F:≤†Lџ0Ќ††LЏB ¶аlџЦ!∞ ќVm÷`∞к86ХИmР3ФUCА№ђЏbЅ`∞кhдА≤eјј    -N^а! А@, ! ,– ÷*јјџъ  іаl:р*јј1 a’†1UOИЂ»≠Ы]јДb6meY∞1U}fЎ7(кЁ ≥hр6цА3i *“∞н8ЈИ@@Ћ6ѓБєEXЫf@ўWuFјўґXЫaАўґpХ@A6а ЌІ М ``в’Х~А≈X ÷*јјСXўь*Ѕ ±V єGVLЫo Џ'–УАВ
∞0 МEБА%† Вђ …Ч     іКn:NByШћs2ЭcСЉЏ 9Э'#†АP0з! р§e:NFбрА“fLG3)Єи) Ј–	÷!  Y†  Л 
ѓИХЫp,–  V+rИ@ +4  `∞D   еЫk №ђ– В!ї@ќVmf`Иh(#ХЫ[Б"ј !††ОVh  ЅєD  ХЪ  0X,
 ≥mш*–В@ 
 `јФB  9Y† В*ЅАQ  еf’РFUВА2аа     Ца3@ h  !ї†ќVmv`И@  `а ЛШюЌЂАM™ 
√љ†Вђ #`а‘И Vh  Ѕ`а+6…В∞XwМЪ  3n Д  `аV ЊПмџґЏ≤@ђ:J
*Ѕј1 a–јVmƒ`а ЛрюЌҐ`≠™x
! ђџдЅ`а Иd Ќ  ђџ&
Ѕf–QА еf”РVД  a V єѕмЏ^
Џ±Ађ:и
*¬ 1 a’∞Q 9r≥k НЪ  
ўґ< ЌЈ ђjf–@VdИ@@Ћ6љД^«цmbmZ∞Qј еf’ VД ≥lј+ХЪ  0Y" rЌ∞@Ѓ± Ќ  ђџј
ЅААЦmљr≥o +B  9Yґ†В…ААЧ(Д ≥nА(Ш }sЌниHB YЈ®"ц?≥lр+JК@@ЋХЫ~БB p eҐ}	@@Ћ6ЕГF  ЋХЫwX,УБ» s2ЫОАБ»ёb0ШНЗСДƒs2ЫОАД№':fS(Аиh2И	&г!Фр 6ШNF± †МCА ТIЄ»e<¶Сђ@%9ВА РI¬p9И"сРЉf И °PЉT*КЕ@† Ф» !ШM¬s†Аћi73°Ддtћ¬!ДиaНЖуђ@(#Е xФdd ƒ£# ( C0ЫДзAШ“n2ЖГ(Ажe1Эз!† a2NBAК) Б@ А@ М  4D»Ќ»AUTOFLМ  d%TddU(ќ -C.ASRМ†ВT2дDХhЋ0C.GTМ°Вд2д’T≈Hћ∞%C.NOTМщ‘2е5ЕH» 5C.TSTМ  d4ДддXЌX&CLREOSМ∆Вƒ5$ƒhЌhDATAМ  TDTd≈HЋ0DENSITМ  TE$ХdXћDRVDATМўБ§RиќE.0М  dUЕф$xј EX_COMОА ddФдEDhћpFMTTPIМ  de5DE%h…иFSTHEAМ  de5E4T8»»2G.МЪБDtќшGAP2МЯБƒt8ћ`&GETINTМЎ§Ви X.HIL_OFМУдДФ≈ффиЋ∞HITRACМёШѕ∞JМа ‘ƒФ‘ХH x&LPPAGEМ  d‘ДE%hј MAXSECМ№D‘хdXќ–NМ»А§виј OFFSETМ  Tф‘Ttћ`PМЬе$дeу PRNF_2Ор’UDГнј.PUTHEXМЏеUDеTЎќX&PUTSTRМРГeUEdФHЋр*Q.М’ е$TDHЌиREADTRМ  e$UE%hј ROTМтe4T54Х®ј SECTORМ  e4T5E5®Ќ8SEEKМєА’4TT≥ј SIDEМ  U4ФDU8»PSMOVEМ£ВU5D%Hј STATUSМЅe5E$ƒTиј TFLМчБ’E$4Єј TTLМЭUtДU$Yј  ЮFFSETМ  Tф‘Ttћ`PМЬе$дeу PRNF_2Ор’UDГнј.PUTHEXМЏеUDеTЎќXееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееfor GM849
24/08/84 Returns 0 if verify errors.
30/03/84 Head stepping at the appropriate rate.
         Written by David Parkinson
         (c) dci software 1983, 1984
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

lppge = lppage() - 4;
fmthead("**** Verifying ****");
makepst();				/* Ensure table is set up	*/
soft_err = hard_err = erflag = track = 0;
line = 10;
if (abort(0) == 0) {
    while (TRUE) {
	putsat(9 RC 30,"Track --> ");
	put2d(track);
	readtrk();
	++track;
	if (const() == ESC || track == fmttrk)  break;
	seek(1);			/* Step in one track		*/
    }
}
abort(-1);				/* Unlink			*/
d_home();				/* Restore to 0			*/
putsat(7 RC 30,"****");
if (track == fmttrk)  putstr(" Verification complete ****");
else		      putstr(" Break ****");
clreol();

return(erflag);				/* Return NZ if errors		*/ 

}
	      
/*======================================================================*/
/*
.he                                                              SETVF(READTRK)
.pa
*/
/*======================================================================*/
VOID                      /*						*/
readtrk()                 /* Read a complete track reporting any errors */
/*======================================================================*/

{

LOCAL
WORD	sect,
	error,
	ss;

BYTE	*fail();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

for (side = 0; side < spd; ++side) {
    if (invside == 'Y' && spd == 1)  side = 1;
    for (ss = 0; ss < spt; ++ss) {
	error = 0;			/* No errors 			*/
	do {
	    if (track < restrk)  sector = ss + frstsec;
	    else		 sector = psecnum[ss];
	    i = readsec();
	    if (i != 0)	{
		if (error == 0) {
		    if (++line > lppge) {
			--line;
			scroll(11,-1);
		    }
		}
		if ((i & 0x10) != 0 || (i & 0x20) != 0) {/* RNF or DDM	*/
		    if (track == 0) {
			putsat(line RC 30,"Track 0 Side ");
			putnum(side);
			if ((i & 0x10) != 0) {		/* RNF		*/
			    if ((pda & 0x10) == 0) {	/* Double Dens.	*/
				sect = sector;
				pda |= 0x10;	/* Set single density	*/
				sector = 1;
				i = readsec();
				if (i == 0)  putstr(" Single Density\n");
				else if ((i & 0x10) != 0) {	/* RNF	*/
				    putstr(
					 " RNF but not single density\n");
				    i = 0;	/* Accept the error	*/
				}
				else {	/* Should never get here	*/
				    putsat(line RC 0,"Track ");
				    put2d(track);
				    putstr(" Sector ");
				    put2d(sector);
				    putstr( "  Side " );
				    clreol();
				    put2d(side);
				    ++soft_err;/* Bump 'soft error' cnt	*/
				    putstr(fail(i));/* Add error type	*/
				}
				pda &= 0xef;	/* Reset Double Density	*/
			    }
			    else {		/* Was already Single	*/
				putsat(line RC 0,"Track ");
				put2d(track);
				putstr(" Sector ");
				put2d(sector);
				putstr( "  Side " );
				clreol();
				put2d(side);
				++soft_err;/* Bump 'soft error' count	*/
				putstr(fail(i));/* Add error type	*/
			    }
			}
			else {			/* Deleted Data Mark	*/
			    putstr(" Deleted Data Mark\n");
			    i = 0;		/* Accept error		*/
			}
			sector = sect;
			ss = spt;		/* Skip rest of side	*/
			continue;
		    }
		}
		erflag = 1;		/* Flag an error has occurred	*/
		if (error++ == 0) {
		    putsat(line RC 0,"Track ");
		    put2d(track);
		    putstr(" Sector ");
		    put2d(sector);
		    putstr( "  Side " );
		    clreol();
		    put2d(side);
		    ++soft_err;		/* Bump the 'soft error' count	*/
		}
		putstr(fail(i));	/* Add the error type		*/
		if (const() == ESC)  abort(1);	/* Stop on ESCape	*/
		if (error == 8)  break;
		if (recover(error) != 0)  break;/* Move head about? 	*/
	    }
	} while (i != 0);
	if (error == 8) {
	    putstr(" <<< Bad <<<");
	    ++hard_err;			/* Bump  the 'hard error' count	*/
	}
    }
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                              SETVF(READSEC)
.pa
*/
/*======================================================================*/
WORD                      /*						*/
readsec()                 /*  Read a sector using Track / Sector / Side */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	a,(side)	; Get side
	add	a,a		; Shift up
	add	a,a
	add	a,a
	ld	e,a
	ld	a,(pda)		; Set the address
	and	0F7h		; Mask out old side
	or	e		; Include the new
	ld	(pda),a
	out	(DRVPRT),a
	ld	a,(track)	; Get Track
	out	(TRKREG),a	; Write to TRACK REG
	ld	a,(sector)
	out	(SECREG),a	; Write to SEC REG
	ld	hl,(sidef)
	dec	hl		; See if == 1
	ld	a,h
	or	l
	ld	a,80h		; Make READ command
	jr	nz,nossc	; Skip if no compare
	add	a,2		; Else force compare
nossc:	or	e		; Include the side
	out	(CMDREG),a	; Issue it
	ld	c,DRVPRT	; Point at Flags
rrr:	in	a,(STSREG)	; Await busy
	rrca
	jr	nc,rrr
rdwait:	in	a,(c)		; Read/ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее√_Ф,–и2 »               A:   ь                                        d Ю€                                         €€                                                                                                Љ                                                !∞€9щ*$еЌт1ЅЌ`НRЌnНT|µ —√9Ќ`НR√&ЌНRЌ“У"п#"п+n& ”€|µ¬—*п~Ј ќЌ”Мпn& еЌВaЅ√z*Ќ5У"√TЌz"√T*B|µ¬^Ќz"√TЌz"√T*Ќ5У"√T!  "p√T*Ќ5У"√TЌz"^!  "r√TЌz"у|µ №*у√в*Ќ5У"√T*Ќ5У"√TЌЮМД√T*B|µ¬*еЌ∆Ѕ"B*пеЌ∆;Ѕ√ќЌz"√TЌz"√TЌЮМt√T*п"г√ќЌz"	√T*Ќ5У"√T*Ќ5У"√TЌНRЌ“УеЌ2Ѕ!;еЌ2Ѕл!P 9щл…ЌяУlA xC БD ТE ЫF ІG ∞K ЉL ЋM иO фP ьQ R #S ,T 4V =W FX RZ   √^√2*++Ќ5У"Ґ*B|µ¬п*еЌ∆Ѕ"B*л! ЌФе*гЌЇУ"|*	))еЌ∆Ѕ":"<*еЌ∆Ѕ">!» еЌ∆Ѕ"F*++е*еЌ∆Ѕ"0"2—"4* ЌщУ"еЌ∆Ѕ"**| ЌщУл**"&**л*о€"(*Fd "H!  9"6"8**",*& ".!  "RЌ»2Ќ:1"bЌНRЌ“УеЌ"ЅЌyЌ≠! еЌg	ЅЌ»yЌ÷Ќ–√r*j|µ а!NеЌ1ЅЌr*hеЌsЅ!PеЌиqЅ*бл!иЌФеЌsЅ!hеЌиqЅ*h|µ ! еЌњ=Ѕ…       Ќ»2!  "n.Ќ!Н|µ¬N!* еЌZЦЅ! 9е*FЌ„УеЌ#3ЅЌН""!!"*~Ј ФЌ”Мn& √Д!!"√Ф*+"√СЌяУq= z.   √^*6 *n& √€|µ „!е!:е*+Ќ5У ј!v√√!{е!Ае!®еЌЅЅЅЅЅ"nЌ”Мn& |µ¬лЌН"*6.*"¶!е!:е!Ве!Ее!®еЌЅЅЅЅЅ"ТЌ»2…    ЌН
еЌН
еЌН
еЌЅЅЅ"еЌНеЌ(ЧЅЅ"Ќ5У \!ЗеЌт1Ѕ*еЌт1ЅЌХЌSН+еЌ”Мn& —}|µ¬\*…    !  "vЌ”Мпn& –€"x  ЌNУ °*x	 ЌMУЌУ ї*v
 ЌщУл*x"v√АЌРМп*v…  ЌНеЌ~ХЅ"ƒ#Ќ5У д!ЩеЌ2ЅЌХ*ƒ…                               !  "!р"о"к"иЌН"м*оеЌ”Ммn& —}|µ NЌ”Моn& ∆€|µ¬ *о"к√N*к"мЌНЌ“У"оЌ”МкеЌ”Моn& —}√”*м"и√шЌРМк*к+n& ∆€|µ µ*|µ¬µЌН"мЌ”МкеЌ”Ммn& —}|µ¬Я*к6 ЌНеЌРМоЌ„У*и…ЌЮМ√шЌяУr: {  {  {	 {, {
 {= Ћ.   √^…C/80 Compiler 3.1 (3/10/84) - (c) 1984 The Software Toolworks
 : Illegal switch.
 }  errors in compilation
 K bytes free
 .MAC .ASM w .c r Can't open file:  Not enough memory.
 *l|µ¬ж!w!еЌz>Ѕ|µ »Ќc.√а! еЌчЅ|µ¬а!|!еЌэ<ЅЌР0Ќу>√≠…                                                                  *з|µ `	*зк6 !Й!еЌиqЅ!' еЌ†qЅ!кеЌиqЅ!' еЌ†qЅ!  "з…      *|µ —	ЌН|µ —	**"e	*,е*e	Ќ?У —	√Ю	*e	 Ќ“У"e	√~	*e	 Ќ“У& }жo+++Ќ5У ќ	*e	 Ќ“У|µ¬ќ	*e	еЌЅ√О	*@|µ»ЌJy*bеЌP1ЅЌ r*Ґ"c	!  "ҐЌ>x!  "з"a	*@л*a	Ќ]У Б
√
Ќ”Мa	√э	*>л*a	n& }2й√b
Ќ)	!Й!еЌиqЅ*й& еЌsЅ√r
*й& аЌzУ“'
Ќ”Мзке*й& —}√r
ЌяУ'
\ '
'   √?
*з¬ЌzУ№)	√
Ќr!  "@Ќ:1"b*c	"Ґ…        *Ю++|µ¬±
!П!еЌэ<ЅЌу>Ќ°2}2Ч
√ !> }2Ч
ЌЄ2*J"Щ
*Щ
n& е*Ч
& Ќ?У ш
Ќ”МЩ
n& |µ¬ќ
!Ч
еЌ1Ѕ√ш
*Щ
6 √ЌяУЊ
< ≈
"   *J"Щ
*Ч
& ¬€Ќ5У¬G!Щ
е*¶е!{!еЌЅЅЅ"Ы
е!З!еЌ(ЧЅЅ"Э
Ќ5УЌУ c*J"Ы
е!З!еЌ(ЧЅЅ"Э
Ќ5УЌУ t!Я!еЌэ<Ѕ√“ЌЮМЮ)Те*Э
Ќ„У*Ю ЌщУ®"Щ
Ќ”МЩ
еЌ”МЫ
n& —}|µ¬Х*Ю)џе*Ю)Ме*Ю)Ше!  Ќ„УЌ„УЌ„УЌ»2…*n|µ ж*nеЌШЅ!  "n…          ЌуМн!  "п! |µ ћ!  "х.ЌН  Ќ]У 9!ѓ!еЌі>Ѕ|µ 3! √6! √™!Ј!еЌі>Ѕ|µ L!€ √™!Њ!еЌі>Ѕ|µ nЌН|µ h!ю √k! √™ЌН  Ќ^У Б! √™!≈!еЌі>Ѕ|µ Ф! √™!ѓ!еЌі>Ѕ|µ І! √™!  "сЌТ"у√*с√мЌН АЌzУЏэ*плб"нб"пб"сб"уб"хл…! "х√эЌяУЉ …  г   ! "у√ЌяУe€€ґ    ЌуМсЌНеЌvЅЅЅ"нЌН√X*dл*н"d√e*н|µ J! √ћ*х|µ e!  √ћЌяУ.  <   ! "пЌM(Ќу>*l|µ¬ГЌ°2Ё€Ќ5УЌУ П*п√ћ√! !еЌі>Ѕ|µ Ђ!–!еЌі>Ѕ! …*HЕ|µ¬п!‘!еЌі>Ѕ|µ –!–!еЌі>Ѕ! …!ў!еЌі>Ѕ|µ¬е!я!еЌі>ЅЌУ п! …!ж!еЌі>Ѕ|µ !–!еЌі>Ѕ! …!о!еЌі>Ѕ|µ ! √a!–!еЌі>Ѕ|µ .! √a!у!еЌі>Ѕ|µ F!  еЌ5Ѕ√a!ъ!еЌі>Ѕ|µ ^! еЌ5Ѕ√a!  …                    !  "fЌѕ0|µ И*f…ЌНеЌZЅ"n*"r*n|µ ђЌН  Ќ^УЌУ  *nеЌНеЌНеЌ\#ЅЅЅ! …!  "h*х& |µћк0!€"jЌН"p*э& }жo"n+++Ќ5У *p√!€ "p√ЌяУю    √*p|µ¬T*n√DЌ:Н|µ ;! "p√T! "p√TЌяУ)  2   √;*p√*n+++|µ u*|µ u!хеЌЅ! "r√©*эЌzУ“Т! "еЌэ<ЅЌ:1"hеЌi1Ѕ"t*n+++|µ¬“!хе!  еЌЩЅЅ|µ √!  "h!ю "p√u!х"tЌу>Ќ°2≈€ЌУ мЌ°2‘€ЌУЌУ шЌJy√ыЌvy*tеЌиqЅЌ r*p+|µ¬**Ґ|µ "*tеЌ"Ѕ√**|µƒ r*pы€|µ¬A*еЌБЅ√ЪЌ>x!"еЌz>Ѕ|µ v*pы€Ќ5У¬h*pь€Ќ5УЌУ v!"еЌэ<Ѕ*"d*эеЌНе*jе! еЌTЅЅЅЅ*d"rЌr*pы€|µ –!хе*эеЌН
е*hе*pе*jе*еЌЃл! 9щл√1ЌН АЌzУЏЄ*э& }жo+Ќ5У ЌЮМэ! "r"ЌЙtest flags
	jr	z,rdwait
	in	a,(DATREG)	; Read data
	jp	m,rdwait	; Loop if was DRQ
	in	a,(STSREG)	; Else read status
	ld	l,a		; & return it
	ld	h,0
	ret
	.8080
#endasm
}

/*======================================================================*/
/*
.he                                                                 SETVF(FAIL)
.pa
*/
/*======================================================================*/
BYTE                          /*					*/
*fail(code)                   /* Return a pointer to error type message */
WORD	code;						/* Error number	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	pop	bc		; Save address
	pop	de		; Get error code
	push	de
	push	bc
	ld	a,e		; Load it
	ld	bc,6		; Offset
	ld	hl,errtab - 6	; Point at error table
fail0:	add	hl,bc
	rlca
	jr	nc,fail0
	ret			; Return pointer

errtab:	defb	' DNR',7,0	; Drive Not Ready
	defb	' WP ',7,0	; Write Protected
	defb	' DDM',7,0	; Deleted Data Mark
	defb	' RNF',7,0	; Record not found
	defb	' CRC',7,0	; Cyclic Redundancy Check
	defb	' LD ',7,0	; Lost Data
	defb	' ???',7,0
	defb	' ???',7,0
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                              SETVF(RECOVER)
.pa
*/
/*======================================================================*/
WORD                                /*					*/
recover(error)                      /* Attempt to recover from an error */
WORD	error;					/* Error attempt number	*/
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (const() == ESC)  return(1);		/* Abort flag			*/
if (track == 0) {
    seek(1);
    seek(-1);
}
else switch (error) {

    case 2:
    case 6:
	seek(-1);
	seek(1);
	break;

    case 4:
	d_home();
	seek(track);

    default:
}

return(0);

}

/*======================================================================*/
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (const() == ESC)  return(1);		/* Abort flag			*/
if (track == 0) {
    seek(1);
    seek(-1);
}
else switch (error) {

    case 2:
    case 6:
	seek(-1);
	seek(1);
	break;

  ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееМjЌРМ!хеЌЅ"tЌ5У¬"* Ќ^УЌУ 3!/"еЌэ<Ѕ√µ*t е*эЌ„У*t еЌН—}*j"l*t "сЌ≈М|µ ~ЌЊМсеЌЊМlЌ“УЌ„У√`! ""r*pы€|µ¬µ*t
 6*t еЌ:1Ќ„УеЌi1Ѕ"t√“√*fе*ЌЇУ"f!хе*эеЌН
е*dл*fе*pе*jе*еЌЃл! 9щл!"еЌz>Ѕ|µ !"еЌэ<ЅЌ»2*f…√1ЌяУZ€ ~ Тю Т ћ ” а   *r|µ¬A!A"еЌэ<Ѕ!S"еЌz>Ѕ|µ¬|*f…        !  "X}2х""э*b|µ }!U"еЌэ<Ѕ√!! "bЌp"X! "!€"V*э"T√Ѓ*Tл! Ќ†У"T√Ы*T& }жo√M! "√!Ќ2НЌ5У ”! √ЌНы€Ќ5У¬мЌНь€Ќ5УЌУ ш! √ЌН Ќ]У ! √ЌНеЌ	!Ѕ"R Ќ“У"*л*ЌщУ"!  "b*X…ЌЊМVЌ“Ул*ЌщУ"√bЌяУЇ Ї √  8   √Ю…          ЌуМh*fе!  "j"l"h"f! |µ ≤Ќу>Ќ°2÷€|µ¬≤ЌЄ2*f))}цo"f√ЙЌ°2Ў€|µ¬ ЌЄ2Ќp*э"h! "n*nе*hЌУ|µ х√н*n))"n√–ЌЙМl√в!e"еЌ€0Ѕ√!хеЌ± Ѕ"j! |µ ЏЌу>Ќ°2√нЌЄ2ЌJ! "n√АЌЄ2Ќу>! "nЌ°2„€|µ b*j|µ SЌ°2еЌґ1ЅЌУ ™! "j√ЖЌЄ2Ќу>*j|µ zЌ°2Е€Ќ5УЌУ¬Ж!  "j*nл*lЌ≥Уе*hЌыТ"hЌЙМl*j|µ¬∞√!  "j*fл*lЌ≥Уе*hЌыТ"э. |жјg|µ „!U"еЌэ<Ѕ*jлб"fб"hб"jб"lл…ЌяУ[ +(   √™*э))еЌНЌыТ"э. |жјg|µ  !U"еЌэ<Ѕ…                    !Ф€9щЌуМ!
!x 9е!  "!—}!x 9еЌ± Ѕ|µ h!x 9еЌ6!Ѕ"!!g"еЌz>Ѕ|µ¬И*!|µ¬Е!i"еЌэ<Ѕ√*!|µ ЦЌц0√Є*2"!*2 "2л*4ЌАУ Є!"еЌэ<Ѕ*!"%!x 9"#Ќ”М%еЌ”М#n& —}|µ¬≈!  "1"/"+*!еЌ Ѕ"3€ Ќ^У !Х"еЌэ<ЅЌТ")Ќ5У J!¶"еЌэ<Ѕ!€€лб"!б"#б"%б"'б")б"+б"-б"/б"1б"3!l 9щл…*)еЌZЅ*)е*3Ќ!У Я*э"'√x*'л! Ќ†У"'√e*'& }жo√П!ѓ"еЌэ<Ѕ√ЙЌяУД  Я   √h!хе! еЌЩЅЅ"-|µ щ*- Ќ“Уе*/Ќ?У¬ў*- Ќ“Уе*эЌ?УЌУ¬р*- n& е*)Ќ?УЌУƒц0√"!хе*эе*)е*/е!э е!€е*еЌЃл! 9щл"-ЌНВ|µ A*+л*Ќ^У >*"+√O*+л*"+"/*|µ¬_!A"еЌэ<Ѕ*1ќ€|µ¬v!Ј"еЌэ<Ѕ√ЙЌ”М1)л! 9е*-Ќ„У!S"еЌz>Ѕ|µ¬JЌM(!»"еЌz>Ѕ|µ *! е*+Ќ„У*!
 е*4"-Ќ„У!  "'*1л*'Ќ]У уЌћМ-еЌ”М')л! 9Ќ“УЌ„У√ЋЌћМ-6 #6 *-"4л*2ЌУУ !"еЌэ<Ѕ*!еЌ Ѕ√*0еЌНгЌЇУл! ЌФ …	                          !о€9щЌуМ8ЌН$"8"B!g"еЌz>Ѕ"<|µ В!€€"8√Ќ°2√ч*B++Ќ5У Щ*Ќ5УЌУ §*. ЌУ Џ*еЌБЅлб"8б":б"<б">б"@б"Bб"Dб"F! 9щл…!  "B*B"8++Ќ5У ф! "8√ЌяУИ, И} И;   √аЌН*& }жo√е!  √≤ЌН&"D":|µ DЌ`Н&++Ќ“У":|µ D!  "D*@"HЌCН*л! Ќ†УЌ„УЌ5У eЌ2Н(Ќ5УЌУ n*8ЌУ А! 9еЌbЅ"NЌУ ! "d.9ЌmТлл*>"L"J*H"@Ќ≈МN|µ ’Ќ”МJn& е! еЌђxЅЅ*:|µ “ЌРМ:|µ ’√§!  е*:еЌђxЅЅ*D|µ ю*Dе*Jе*LЌЇУЌ„У√*NюЌzУ“! "еЌэ<Ѕ√ъ*:|µ¬%*8|µ kЌН*еЌН*еЌН*е*8еЌTЅЅЅЅ"8*D|µ V*DеЌ“У#Ќ„У+*:|µ hЌРМ:|µ k√√OЌН(рЌzУЏ±ЌН(√Э! ":√n! ":√n! ":√nЌяУВ Л Л   √ФЌН(еЌ	!Ѕ"> Ќ“У"N*>
 Ќ“У"@!  ":*@++Ќ“У"F|µ ч*F Ќ“УЌ5УЌУ !  е*NеЌђxЅЅ!  √≤ЌћМ@Ќ“У"F|µ O*F Ќ“Уе*F n& е*F е*8еЌTЅЅЅЅ"8√*<|µ¬]*8√≤√ъ! ":.(96#6 *8|µ¬Ж!  е*:еЌђxЅЅ√в! "d!”"еЌz>Ѕ"N! 9е! еЌVCЅЅ*N|µ ѕЌН|µ¬ѕЌН& }жo+ЌУ ѕ!’"еЌэ<ЅЌН√ќ! 9еЌлxЅ*:++|µ с!д"еЌэ<Ѕ√вЌН"N ЌNУ¬ЌН( ЌNУЌУ SЌН(л*NЌ^У¬йЌН(ы€Ќ5У :*Nы€ЌУЌУ S! 9е! 9ЌmТЌ$РбЌ{Т! 9ЌmТ!PЌ{ТЌН(ы€Ќ5У¬yЌН(ь€Ќ5УЌУ ѓ!PЌmТле! еЌђxЅЅ!PЌmТ≈’! ЌжТЌvСле! еЌђxЅЅ√ј!PЌmТле*:еЌђxЅЅ√в!т"еЌэ<Ѕ√вЌяУф  √ √€   √÷√ъЌяУ  n  `   *<|µ !S"еЌz>Ѕ!»"еЌ€0Ѕ*B  ЌNУ¬)!S"еЌz>ЅЌ5УЌУ 5!  √≤Ќу>Ќ°2Г€ЌУЌƒУ√≤  !  "H!#еЌz>Ѕ|µ¬kЌКA"H!#еЌ€0Ѕ*|µ Г*H|µ¬Г!A"еЌэ<ЅЌ”М)€е*HЌ„У…    ЌН"Ч**"Х*,е*ХЌ?У щЌуМХЌ+>ЅЅ|µ яЌНЌУе*Х
 n& €Ќ5УЌ!УЌУ й*Х…*Х Ќ“У"Х√¶!  …    ЌН"€*& "э*.е*эЌ?У CЌуМэЌ+>ЅЅ|µ 3*э…*э Ќ“У"э√!  …ЌНеЌЅ"п|µ v*п n& ш€|µ s!#еЌэ<Ѕ√ЫЌНе! е.еЌ:1е! е. ееЌЃл! 9щл"п*п Ќ“У…        ЌН√! 96#6 √ ! 96#6 ЌНеЌН€Ќ5УеЌЩЅЅ"п*,"¶*&"®√%ЌНеЌЅ"п*."¶*("®√%ЌяУµ€ Ѕю    э   √т*п|µ аЌН& }жo+++Ќ5У V*п Ќ“У& }жo+++Ќ5УЌУ ў*п Ќ“УеЌНЌ!У Г*п n& еЌНЌ!УЌУ Ы*п
 n& еЌНЌ!УЌУ ќ*п Ќ“У|µ¬¬*п еЌН
Ќ„У√ЋЌН|µƒц0√÷!#еЌэ<Ѕ√№Ќц0*п…*¶"п*п "™*®л*™ЌБУ 	 !0#еЌэ<Ѕ*¶…ЌnН#|µ ( ЌЊМ™еЌ`Н++Ќ“УЌ„У√рЌ”М¶еЌSН+n& —}еЌе1Ѕ|µ¬( *п еЌНЌ„У*п еЌН—}*п еЌН
Ќ„У*п
 еЌН—}*п е*™Ќ„У*&е*®Ќ!У £ *™",√© *™".*п…    Ќу>Ќ°2еЌґ1Ѕ|µ¬≈ !  …ЌН"≠  +"ѓ Ќ°2еЌе1Ѕ|µ  !*≠ еЌЄ2—}*ѓ е*≠ Ќ?У э ЌЮМ≠ √‘ *≠ 6 ! …ЌCНр€Ќ„У  Ќ]У #!!  √3!*0еЌН ЌщУ—…  *0"4!*2е*4!Ќ?У s!√Y!*4! "4!√<!ЌНе*4!еЌ+>ЅЅ|µ p!*4!…√L!!  …#asm syntax error 
	DB	 nested too deep Can't find file registe extern static auto short int long float double unsigne char struct union too large for register = can't initialize auto improper argument dimension missing , too complicated ) { undefined struct name struct table overflow too many structs bad type nesting struct too large } too long & not an address type mismatch illegal initializer ] not a label type (re)declared after use symbol table overflow                       !о€9щЌН"J#ЌН+++|µ¬}#! 96ю#6 Ќ2НЌ5У Н#! √®#!хе!  еЌЩЅЅ|µ •#!  √®#Ќ:1"V#!хе*эеЌНе*V#еЌНе!  ееЌЃл! 9щл"L#ЌН€|µ¬х#*L# Ќ“УеЌi1Ѕ"Z#√$!х"Z#*|µ $!хеЌ"Ѕ! "V#ЌРМV# АЌzУ“8$*V#зе*Z#л*V#n& —}√$*& ".!  "d"f.Ќ:Н|µ¬ћ$!+?еЌz>Ѕ|µ¬ƒ$!  9еЌ± Ѕ|µ¬w$Ќк0ЌР0!  9е!  е.е*fе! е.
9е! еЌЃл! 9щлЌЙМfЌу>Ќ°2„€|µ є$!-?еЌ€0ЅЌѕ0|µ¬ƒ$√V$!€€еЌчЅ!/?еЌz>Ѕ|µ б$!1?еЌэ<Ѕ!C?еЌz>Ѕ|µ С&!  еЌчЅЌJy*d"T#!ЕT—UС†UE$4ЄMQ=JSIDEБСTСУQаedU$ФeШIQJREADSEБРRS e$T4хdY@†÷ \               – h  ~?√", !єАОVh  ЅfА   EА X D  А ( "Ѕ   Ќ  '≈Ђ
ƒА@ в’Хb@!аKФCxђ– ВЅ` +4  `≥n@ Ђ  ƒX Ъ  \ѓрЋ4  aWPP  е` h  Ќ  UшЗb@ ХЪ  0Xt№[ !њ№ђЏ^ ЅfА р !ї`ОVmH `∞EU∞ *ј Џж  Ј ÷еfА Ѕ –pW+6ўА0Y†  Ђ 2eЅА       Kr    Л 
А XЂ 3@ UЏaёАV И∞ з 
А  КЭюf÷`Uь \р[6ш 3k∞*Д И@  А ,  *  bђ  ЌЇјЂЃ√• "ђ  #a А , *  bђ  ЌҐј,™Т*¬ ±P  ` Va  И  fА , Ќї`b   UVАOЛVU±`ав’Еd@EX  F"Ѕ ±V
 f”`UС`АXЛ A`(Ею€r≥@ ["*Ђ†"`хћ7≥oи
÷ КђРШ }sмџ6Ќµ@,™2*ј ≈Ђ
МБК∞@ D fА р 2е—0W+6ќА0X"ђ еfА U° Ѓ`БљЫk@YWрT  	А„0@ёЌњ@ЂN*ј@, *љ '„∞@ё"њј" EААЈlEvАETDшµaR`!!r≥mрЗf ЕTPL >єВцmгeT`!2r≥i B  ©8ћ
∞@ D f№(ЖІВєYЈ4ВЅ` +6®А0D5X ЌІ@LV r≥jрCWЅ\ђЏћЅf№ V r≥kpUHАb+
*® NVm`єYµЎ	Г-ШPP!0 ъжwЫƒVd	З~@ЕX  "  ≥jhФCSЅ\ђЏ™Ѕ`К∞ ХЫ`@Ш"ђ
еfўP&Ђ 9Yґь	В!ЂаЃVm«`≥k–Ђ 9YЈ<	В*± B1жXј'+6ОВ0\ђџЃЅa–†1gr≥o∞B  ѓhЂ ∞ ™ЗАИ∞АЎБЋF@ƒ  Л 
∞p МEГАg≈Ђ
ЄБК∞@ D fЏа'(ЖІВєYґЎ	ВЅ` +6с0D5X Ќ† lV r≥j CWЅ\ђЏШЅfЁ∞!V r≥j†UzАДb*÷*° nVm`єYµpВЌЂа+ь2|Z∞ђРД r≥lpUГА/ЗшdшµaZ6є`а+6ѓ0OЛVU±aџР9mИґƒU\АѕЛV.`а Лбю>-XWPC^Ѕ\ђЏцЅQрКз∞ирп 2eї`cђ ЗC°ЋгЂDж{ђ∆WМ¶д` ЫДuААn!P  +>-G» 	МYі№ з#mј>ЁІБCсґг}P–FџАё& 2Y2—–FE™≈=А@ј'Б∆∆HАИN)јє@@ ДBh  )Ијp АЖR!Бјa@ гсш  П«аp&\$   KWБµь"еЖOЛVnА@СV  >-XV$B 9YґВ!њ№ђЏцЅa№АA 9fА ;h	-УњяоVmГ`И@ +6ћ0Xw ЫdАX  Ќі М»fА L ≤`А`¶   ±Цд@ H®T*
∆SС§ћy4ЫМвP®T* Fђ@-ПД X r4ЩН&3	–“o7fуiјЎe:D°P®T ОFS	ђ@*
Е@°»¬c5ИЩ§»e 3IЄќl2ИЖSqћ“t<ВАС8М 1NВqЉи 9ЪM∆saФ@d2ЫОfУ°д *М&3XА  )ЩLgCy»@ 
fУ!Ф@ ¶√)– d'CАЪa9Ѕ@ рx<М&A рx< FmA1rЪЇJҐf<†°'©*F  2
™Ґz2d`  ѓ§І",F  ""Ті` !$І©∆  2bzZЬ` !'І™)≠F  ВЬ` !*£#"©F  2™2ЪJ‘eа!Ч#™FLјтrj™b§g»°Ч''™F  2B
rr,` °¶'°•∆X тbТ*zde|°ІІ)™F  ""
Ґ` ""£")+F  *"*2b§` ""І)§™F  "JФ` "$©"°™F  2"z™b,` Ґ(!F  2"В
Ь` "(** °F  *"ТJ≤,` ")+' ¶∆  2"Т≤Ґ
fЬ"/§'¶Ґ∆j@)tdј	ҐЧGБА2*Т2b
<tt# §¶F  *2
ҐJ$` #"*"ђ*F  *2JТЪ§` #&™!,™F  22jҐ"*Ь` #&™")+FCј22jҐB*` £&™$ҐF  22jҐҐВLfИ#&™*)%∆P r2ТЪҐЪ,eD#ЧF  ":
БМ` #†®F  ":
БЬf8$FtАтB
Т"ъ,` $"¶(F  2BJ:B*Ьf»§∆  *Jr"*ƒ` $І+"©*Fz@2Jr≤ЪJ$`  •F  *bJjJ§d&(( £Ґ∆  "bЪВ§dL&†•Ґ®)∆  *j*"J` ¶£!F  jЬ` '")$Ђ"∆  *r2
ҐЬ` '*¶Ђ§ІF  2z22Ъ*§`  ®Fz@ЏВ"e4()Ґ°І*∆  *ВЪZ*ЉeЬ®*™"FuАrВ™Ґr™ldм(*™)†™FrАтВ™ҐЪҐФ`  ®∆  *Кbz24wl)"†Ґ)Ґ«r 2Т*
"ҐФux)"°ІЂ"∆KјrТ*ЪҐТ\` )/° ©Ґ∆  2ЪB
r<f4)°©'¶&GАА2Ъ*ҐzФ` )Ґ°™) ∆kБ"Ъ**\x)§Ґ"∆~ кЪJ"*4` ©§≠"£F[јтЪz2Ґъ,` ©®!∆}АЪВ$` ©®# ™F  2ЪВb*¬ldD©®*F  2ЪВъJrL` )ђ©™)%∆  2Ъ ЪҐ Д` )ђ©ѓ™,∆  Ґ2dx ™) °•∆  2ҐТ
rЪ` ™)•ҐЂ∆  ҐҐdt +"©$£,∆  2ЇЪВ
,а  Юr 2Т*
"ҐФux)"°ІЂ"∆KјrТ*ЪҐТ\` )/° ©Ґ∆  2ЪB
r<f4)°©'¶&GАА2Ъ*ҐzФ` )Ґ°™) ∆kБ"Ъ**\x)§Ґ"∆~ кЪJ"*4` ©&†•Ґ®)∆  *j*"J` ¶£!F  jЬ` '")$Ђ"∆  *r2
ҐЬ` '*¶Ђ§ІF  2z22Ъ*§`  ®Fz@ЏВ"e4()Ґ°І*∆  *ВЪZ*ЉeЬ®*™"FuАrВ™Ґr™ldм(*™)†™FrАтВ™ҐЪҐФ`  ®∆  *Кbz24wl)"†Ґ)Ґ«r 2Т*
"ҐФux)"°ІЂ"∆KјrТ*ЪҐТ\` )/° ©Ґ∆  2ЪB
r<f4)°©'¶&GАА2Ъ*ҐzФ` )Ґ°™) ∆kБ"Ъ**\x)§Ґ"∆~ кЪJ"*4` ©ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее√Ћ   € RELRELSUBSYMCOMCIMHEXCopyright (c) 1983 by SLR Systems, Butler, PA**CHRIST is the Answer**TўF?эЖССDўFдђцц%HжёД_idўD∞dњ@Ы±X”≈^&@їжЖ@ВЫЉІжй0gЫqУ}НУЩЉK}}}ћЎiнуvь}

}}ћ}ж∆А≠†pИэ`ЖІ BWДЉСђх”Р Зў.ЗЬЈиТґа6 ґ 7и≤»жќГD∞@„d+BдЫ≥/B+Bе≠дЫ≥+B+BеЭдt?@ЮPzeБB#жgЛЗ8МіЎ≤@'¬ґ ЯЫ
жЙБTЙ(И0жoц§eѕB∞DИeЖ цaжT,@цЦjDДD,@шш®Ѓ&Аю l џX0B@ МD,@4жа"Y@*жаoamБT>@цґ,@Ыџ)`n"Y@ жа З80жHВTЙ(И0жoц§eѕЫbР¬"Y@А џXЫј0цґ,@Р—дСжСl TjDМ"хDАОмT>@цґ,@џџ)PXЦPАHЊ≥ІџPЖPГ |Ы*змJм@z
ж®БЫЯжйМЫj0ж
"Y@ жа З80а√дџ≠ђBtD9FєFС„„ЋвЮтЛА!ЅъdуDc£BуD„С ~џ"$ѕНВИPСTtDтлРѕЫи:хlЖFСг4Сl€BУFtжйМЫW0ж
√ш	≥ъg ЈDtDИ„ГАОрУР ВЗЌ.Р™Б dжўПT,@Т@ЕъџСk—k
0ьzР0А"5DцAцAцAРЗў.Р† цґjD
џXB ∞УЙЬІЬЦ¶*В'И†§"@І™*†™®Р  DќDж{ПЫй>dЧ?Щ€$лжЙБT,@И Аoц§:РЖЫў.баА&¶кєиЮ9“≥“7@†иb`$Ы
Риџ≠СЂА
 џXџ•ш
©HИ АУцaб АB,DИ¬Д цaР6АџPџPџP_	|d?@jблB,D?oИдД цaB„d>DбЖB,DИ¬Д цaР*АџPџPџP_	xьџљФЗїжЖГDќDбс	Ы≥'B+BеНд З80„d@ Р0жDЙ(бZ|€dZDg  "dЌ.r*Д|µƒiЌr*L#еЌezЅЌ r*T#е!  ееЌЃВЅЅЅ"d!  "V#*."T#*& е*T#Ќ?У И&√Y%*L#"T#√<%*& "L#*L# Ќ“У"R#е*T#Ќ?У Ж%√}%*R#"L#√c%*L#
 n& "X#√t&*L#еЌ9zЅ!  96€!  9еЌ~Ѕ*X#ы€|µ¬Е&ЌЙМV#!  9е! ее. ее*V#ЌжТ≈’!  ееЌkcл! 9щл!  9еЌzsЅ*L#еЌZzЅ√Е&*L# Ќ“У АЌzУ“q&*L# еЌЙМV#Ќ„У*L# n& "N#ы€Ќ5У¬;&*N#ь€Ќ5УЌУ f&*L# Ќ“У& }жo"P#Ќ5У¬c&*P#+++Ќ5УЌУЌУ q&ЌЙМV#√Е&ЌяУЦ% Ц% ч%   √P%ЌX("R#√≠&Ќ.r*Д|µƒi!зеЌиqЅЌ rЌп&"R#*R#+++|µ ј&!  еЌµ,Ѕ!  "d*& ".!  "H#"§*|µ й&!  еЌg	Ѕ! 9щ…Ќ°2Ќ5Уе*lЌУ|µј!E?еЌі>Ѕ|µ  '! еЌµ,ЅЌM(! "z√I(!C?еЌz>Ѕ|µ 3'ЌX(√I(!L?еЌі>Ѕ|µ F'ЌЩ(√C(!O?еЌі>Ѕ|µ ^'!  еЌИ*Ѕ√C(!U?еЌі>Ѕ|µ v'! еЌИ*Ѕ√C(!Y?еЌі>Ѕ|µ О'! еЌИ*Ѕ√C(!\?еЌі>Ѕ|µ ©'! еЌ.ЅЌM(√C(!b?еЌі>Ѕ|µ Љ'Ќ)√C(!i?еЌі>Ѕ|µ ѕ'Ќэ)√C(!n?еЌі>Ѕ|µ в'Ќj*√C(!v?еЌі>Ѕ|µ э'!  еЌ.ЅЌM(√C(!/?еЌz>Ѕ|µ¬C(!~?еЌz>Ѕ|µ (Ќc.√C(!Г?еЌі>Ѕ|µ 0(Ќz,√C(Ќ$,|µ¬C(!  еЌOAЅЌM(! "z*z…!/?еЌ€0Ѕ…  ЌЮМj! "V(!И?еЌz>Ѕ|µ¬М(*l|µ Г(!И?еЌ1Ѕ√М(Ќп&"V(√c(ЌРМj*V(…    ЌуМХ(Ќ:1"Х(!К?еЌ€0Ѕ*Х(е!  е!+?еЌ€]ЅЅЅЌп&!М?еЌі>Ѕ|µ¬а(*Х(еЌ@1Ѕб"Х(б"Ч(…Ќ:1"Ч(еЌіЅ*Х(еЌ@1ЅЌп&*Ч(еЌ@1Ѕ√„(      !л€9щЌуМ)*~")!  "~*<")! 96 #6 ! 9##еЌ:1Ќ„У! 9еЌ 2Ѕ!К?еЌ€0Ѕ! 9е! еЌЋAЅЅ! 9еЌzsЅ! 9еЌбДЅ|µ Р)ЌН√Г)ЌoЕ√Р)ЌxЕ√Р)ЌяУw) })   !+?еЌ€0ЅЌ:1")еЌіЅЌп&! 9##Ќ“УеЌіЅ*)еЌ@1Ѕ*)е*<е*~еЌПАЅЅЅ! 9##Ќ“УеЌ@1Ѕ*)"<*)"~Ќl2б")б")б")! 9щ…*~#|µ¬*!С?еЌэ<Ѕ…*< е*	)л*:—ЌАУ 0*!†?еЌэ<Ѕ…ЌЊМ<еЌ:1Ќ„УеЌ@1ЅЌЊМ<еЌКAЌ„У*ИAьЌzУ“a*!ѓ?еЌэ<Ѕ!∆?еЌ€0Ѕ…!∆?еЌ€0ЅЌ:1"~еЌ@1Ѕ…          !л€9щЌуМ~*Ќ:1"~*"В*Ќ:1"А*Ќ:Н!|µ¬є*Ќ:1"~*еЌ@1Ѕ√Ш+ЌН!|µ у*Ќ:1"Д*!К?еЌ€0Ѕ!/?еЌz>Ѕ|µ¬и*!  еЌOAЅЌM(*Д*еЌ@1Ѕ√+*~*еЌ@1Ѕ!К?еЌ€0ЅЌН!Ќ5У¬+!/?еЌz>ЅЌ5УЌУ A+*А*е!  е.%ЌН%|µ 7+!/?√:+!+?еЌ€]ЅЅЅЌН!|µ Ш+Ќу>Ќ°2„€|µ¬e+*Д*"~*"В*√Р+Ќ:1"Ж*еЌіЅ*~*еЌ@1Ѕ!  еЌOAЅ*Д*еЌіЅ*Ж*еЌ@1Ѕ!+?еЌ€0Ѕ! 9е*В*Ќ„У! 9##е*А*Ќ„У! 9еЌ 2ЅЌп&Ќ:Н!|µ –+*~*еЌіЅ√э+!O?еЌ€0Ѕ*В*еЌ@1Ѕ!К?еЌ€0Ѕ*~*е! е!+?еЌ€]ЅЅЅЌM(*А*еЌ@1ЅЌl2б"~*б"А*б"В*б"Д*б"Ж*! 9щ…  ≈≈≈≈*",еЌу>*J"",! 9еЌ± Ѕ|µ n,ЌЄ2∆€|µ¬n,! 9еЌGЅеЌ@1ЅЌп&! лб"",ЅЅЅЅл…*","J!  √c,≈≈≈≈!  9еЌ± Ѕ|µ Э,!  9еЌGЅеЌіЅ√•,!»?еЌэ<ЅЌM(ЅЅЅЅ…        !у€9щ!  "≥,"ѓ,.ЌН|µ "-Ќѕ0|µ¬-!  9е! еЌЋAЅЅ!  9еЌzsЅЌНе*J#еЌ:ИЅЅ*J#ь€Ќ5Уе*J#ы€Ќ5УЌыТ"≥,√"-! 96 #6 *d"±,Ќ5У 9-Ќ?л! 9щл…*§|µ _-ЌНЌ5У¬N-*H#ЌУ _-*§еЌіЅ√1-Ќ:1"§еЌ@1ЅЌН"H#*& "≠,*.л*≠,ЌТУ т-√Ы-*≠, Ќ“У"≠,√{-*≠,
 n& √в-ЌН|µ ‘-*≥,|µ ¬-!  "ѓ,√Ћ-Ќx}! "ѓ,! 96 #6 Ќ¶~*≠,еЌZzЅ√п-ЌяУ®- ®-   √Л-!  е.ЌНе*≥,еЌЃВЅЅЅ*ѓ,|µƒx}Ќ?*±,"d√1-  Ќ2".Ќ5УјЌН)л*.Ќ“У|µ¬N.*.ь€".л*6ЌУУј√'.ЌН)л*.Ќ“УеЌіЅ…  *Ґ"a.!  "ҐЌэx!~?еЌиqЅЌr!  "v! |µ і.ЌV3!“?еЌz>Ѕ|µ¬і.*l|µ¬і.Ќ°7*FеЌиqЅЌr√Г.Ќ»2! "vЌэx!“?еЌиqЅЌr*a."Ґ…X*    !у€9щЌуМ“.ЌН"“.!  "‘.Ќу>*“.n& √/*“.е!  еЌzsЅЅ*“.еЌ~Ѕ√(/ЌяУ	/€ / /   √ь.*Jе!+?еЌ>ЅЅ|µ¬ћ/Ќѕ0|µ¬ћ/! 9е! еЌVCЅЅеЌzsЅ! 9еЌбДЅ|µ j/ЌНЌ5УЌУ •/*“.n& €|µ¬Ъ/Ќ¶~*“.6€Ќy~ЌЙМ‘.*“.еЌ~Ѕ√Ґ/Ќy~ЌЙМ‘.√Ј/*“.n& €|µћ≤~Ќф}ЌЙМ‘.!-?еЌz>Ѕ|µ ћ/√(/!+?еЌ€0Ѕ*“.n& √O0ЌВ√c0*“. Ќ“УеЌi1Ѕ"÷.√0*“. Ќ“У"÷.*Д|µ 60!Џ?еЌЊ~ЅЌБ*÷.еЌиqЅ!-?еЌиqЅ!зеЌиqЅЌr√A0*÷.еЌш~ЅЌr√c0!а?еЌэ<Ѕ√c0ЌяУЁ/ю г/ ш/   √D0*dл*‘.е! е*“.еЌбДЅеЌЃВЅЅЅ"dб"“.б"‘.! 9щ…Ќ‘2еЌе1Ѕ|µ ∞0Ќ°2еЌе1Ѕ|µ Ћ0ЌЄ2√Э0Ќ°2еЌе1Ѕ|µ¬Ћ0Ќ°2|µ Ћ0ЌЄ2√∞0Ќу>…Ќу>*Jе!/?еЌ>ЅЅеЌ°2Ќ5УЌыТ…!ц?еЌэ<ЅЌР0…!
@еЌэ<Ѕ…ЌНеЌz>Ѕ|µ¬1ЌНеЌ1Ѕ…!  еЌэ<ЅЌНеЌ2Ѕ!@еЌ2Ѕ…!/@еЌэ<Ѕ…ЌЮМ^…Ќ.rЌНеЌP1ЅЌ r…ЌНеЌi1ЅеЌиqЅ…          !_1"g1#"g1+6.ЌSНЌН|µ ≠1Ќ”Мg1еЌНл! ЌФлa —}ЌCНл! ЌФЌ„У√z1*g16 !_1…! 9~! ю{“—1юa–ю_»ю[“—1юA–+…! 9~! ю0Џг1ю:Ў+…! 9ЌЇ1}=¬”1…!
 еЌZЦЅЌНеЌ2Ѕ…ЌН~Ј 2ЌSН+n& еЌZЦЅ√2…  *6P ь€е*8Ќ!У >2!G@еЌэ<Ѕ…!  "2*2юЌzУЏk2ЌЊМ8еЌ”М2)лЌНЌ“УЌ„У√D2…Ќ2|µ ~2*8ь€"8…*6е*8Ќ!У Ш2!^@еЌэ<Ѕ!  …*8ь€……*Jn& …*JѓЊ і2#ng…!  …*J~Ј і2#"Jo& …*F6 *F"J…Ќ°2|µ¬ц2*lл*F#|µ н2!  …ЌV3Ќ°7√‘2ЌЄ2…Ќ°2|µ¬3*F#|µ 3!  …ЌV3*l|µ 3!  …ЌЄ2…  ЌН"!3Ќ”М!3еЌ©Х—}ц€ЌУ¬*3ЌРМ!36 ЌН…          ≈≈≈≈*R3е*Ю)ШЌ“У"N3! |µ |3*l|µ Е3б"R3ЅЅЅЅ…*Ю)ТЌ“У"L3*Ю)МеЌ“У#Ќ„УЌ»2:O3Јъ∞4*L3еЌЧШЅ"N3|Јъ∞4:ВЈ }4*N3Ґ€|µ¬ё3*L3еЌЧШЅ"N3√z4*N3§€|µ¬X4*L3еЌЧШЅ"N3√84!` "N3√X4!| "N3√X4!{ "N3√X4!} "N3√X4!~ "N3√X4!^ "N3√X4Ќ”МJ6\√X4ЌяУш3' 4! 
4( 4) 4- %4_   √.4*N3њЌzУ“z4*N3•ЌzУЏz4*N3  "N3*N3}ю
 ∞4*F:JХ_:KЬW*P“Ґ4!o@еЌэ<Ѕ√∞4*J:N3w#"J√≠3*J6 *Fе*JЌ!У 5*N3 АЌzУЏl3*L3еЌШЅ!  "N3*Ю|µ¬ф4!  "N3"Т#"l√5ЌРМЮ)џЌ“У"В*Ю)ШЌ“У"N3*F"J!}@еЌЙ>Ѕе!Е@еЌЙ>Ѕ)—"R3|µ ≤5! 9еЌ± Ѕ|µ ]5! 9еЌЙ<Ѕ|µ ]5! е*R3ЌЇУ"R3ЌЮМ\ы€|µ¬{5!М@еЌэ<ЅЌРМ\√l3*\+)RЌ“УюЌzУ“†5*\)R6#6 √l3*\)Rе*R3Ќ„У√l3!£@еЌЙ>Ѕ|µ 86! "F#Ќ°7! "R3*J "JЌ°2|µ b6! 9еЌ± Ѕ|µ¬ф5Ќк0√b6! 9е!  еЌЩЅЅ"T3|µ 6*T3 Ќ“УЌ5УЌУ &6! "R3√b6Ќ°2‘€|µ¬b6ЌЄ2√Ў5!Ђ@еЌЙ>Ѕ|µ k6! "F#Ќ°7*J "JЌКAЌ5У#"R3!  "F#√]5*\|µ ё6!ѓ@еЌЙ>Ѕ|µ µ6*\)RЌ“УэЌzУЏ≤6*\)Rе*\)RЌ“У ’ЌЇУЌ„У√l3!µ@еЌЙ>Ѕ|µ  6ЌРМ\√l3*\)RЌ“УюЌzУЏl3*F"J*tе*vЌУ|µ 7Ќэx*FеЌиqЅЌr*Ю)Ше*N3Ќ„У√|3      *Nе*LЌ!У И7*N)еЌ~ХЅ"7#Ќ5У D7!Љ@еЌэ<ЅЌХ*H"7*7"7Ќ≈МN|µ n7Ќ”М7еЌ”М7n& —}√P7*7"H*L)"N! е*NЌЇУ"PЌ”МLл*HеЌН—}…      ≈≈≈≈!№@еЌЙ>Ѕ|µ й7!  9еЌ± Ѕ|µ¬∆7Ќк0√г7!  9еЌЙ<Ѕ"Ы7|µ г7*Ы7++л*B6 ЌV3√•7!  "L*F"JЌ°2|µ 0:Ќ°2√:*v|µ 	9!  еЌ7ЅЌ°2а€Ќ5У¬*8Ќ°2ч€Ќ5УЌУ х7ЌЄ2√8*v|µ 	9Ќ°2"Э7еЌ7ЅЌЄ2Ќ°2е*Э7Ќ?У Щ8Ќ°2|µ¬l8!г@еЌ1Ѕ√Щ8Ќ°2§€|µ¬О8Ќ®2|µ¬Ж8ЌV3√L8ЌЄ2еЌ7ЅЌЄ2еЌ7Ѕ√L8ЌЄ2*Э7еЌ7Ѕ√х7Ќ®2÷€|µ¬ы8Ќъ2Ќъ2Ќ°2÷€ЌУ¬–8Ќ®2—€ЌУЌУ т8Ќ°2|µ¬д8ЌV3√з8Ќъ2*l|µ¬т8√є8Ќъ2Ќъ2√х7Ќ®2|µУ€шЗ°<€ЃРУЙВ1ё9иZИіжµ@#к6ЎBшЏPЫ}
аd,DшЏPЫ
баАB9D?o„d>DИ∞Д цaжЖBy
И? цaж&ЛpF/F+џ©;Ы–&шъжэЖшжэЖ|бdРD€ґl€B—ЇЖ|бd.мTЃ@м_ІzBт
И цaж[ЕTї@„оСоСоСоРЬСМСрЎPЙЉСђСЋ©2?їF?ї√Ћ/F+„>kїд#Т'Т©Р@@@H¶К¶§ђ€№шЏСю",DА џXЉСђц¶7DжуЫ–
жт0нЫz≠РTЗ ДД∞»И9“; Љ≠ PхэИ`у$ЙД0МЮЧ",D	Ы±t≈ЙОЉ$Йрж∆АэPэЧP	эЖPэP$Й фBбА
ъ|$Й ~г^ж≈АЫ±йioшЏ@√боАB,DИД цaРАtњ@џPБBцAцAцA„$ИЗЫ80@ЛBИ1џPџPџP"«@жаxLР_l Ыє2•шЏPЛtOHужа|Аd™BџУж«_лИ@ГTЅ@тB«@„жgЛ√З8ЗЖ∞№УиЮ8 7@#“6 	МіЎ≤@'¬ґ ®ЈёШЈ№≥Ы±tЄИAИЫ±t	&лФ€	|И!?0ГЫ±tpР  џ≠gС4XN@F^>6Й≠pэp≠Гэpэ`RФRФkЈ0jџ©gСУРYГЗ tК<а≤∆: 2BёбА!¬2@$ <@"“≥“:!“cЌя!V цЌяЈнRЋ<ЋELлЋ#Ћ#ш х…B  ж
 JЊэ`_А0|0|АdІ@И≠џ©ЫВ 2ж
 deDdеD€ѓT ХуТJСBЅжКМBдИ† цaРш"Њ@А€Аl џXB@ ?oСDўFfёДBњ  СЬ цж%HИM≥ oЗї©к8 9Ші№µ 9@°ё8т9“≥–:@ЖФ@ШrfƒЉ@©Ш)@©тєи≤Џє@) 6 ∞ж≤@Ш\`F$ОШbЩdЖ€ Vь   €€@MЦMЦEХАM&Т!@@@)К&€     OPжЇД‘ fґЛџ≠жСдА фўP6РnџTџTџT|АdЪHцґЅ@Р∞Д цaРАџPџPџP_	џ≠ЗЫ80P	B‘аДTЅ@И@ 2 баАBжgЛЗшЏС/F+џ©VдHбдДЫ!Рю l(„жа"6жаBњ  СьџPpFgСО?э∞pГэљ`БЌпоС шlЖУРjМl "ј ц¶ўF4?Fsю¬цsњ4n	эPЂ8Ш…вЂьЮЫ≥2жйМTЅ@ИH „М„жЮМ„(ж
 ЫВ4иГ@oewДTЅ@Ич€2/F+ЂжТ√>kaаАB9аДЗ8РћЫў.ЈЙ|€$lрjtЂBџСжДBј бКМ<ТЗ80кџ≠дХж√шЏСИnVцQцQцQд&“7 ®ЈёШЈ№≥xdЗ∆РDњDж†Жэь@wBPR=ФЫИ≠Ы"ж†Жёж†ЖќSСЫ(ЈЫ(≥D’FґD$Hж†Жэ}@¶Ыgo~ж&ЛpЧ?@_g хЫ9.хСжСдС„ж†Ж$Й ь0дtѕDc
І Ы9.чС„Р?ЬџX0оЫ@,ГъЮgoaТT‘F;Ы„(WСDќDжъЙгч>жDЖЫ(ЈЫ(≥DќDжйИ„южСDњDж†Ж0олґl T$HъT$H?FkхFЮ@$"ѕD' цa€	ьСЉСђСD$HжЎЖDќDжс	0jЬСМСьСЉСђСD$HвЫ6;√т"В М"PDА" џX√жч	0VгъD≠@ж†Жo}БЕОЫ(жэЖ |0цЫв—Ѕ,k!Bk Иk Мk Цk ™≤kЅ√Њ РВ2/F+„фЫ.ЊЫ>З"ЪБжэЖ≥к≥иTЎDМVЊБжэЖшУжЄЖЗ/"жЄЖDќDбCЙН`эяpВЫ(cбйЫ.б|ЙЫ.;ЗЧ&ј»KЌYџ∆∆\bд∆∆∆∆∆∆∆∆∆∆∆gjт∆∆∆t}ЕИ°T=@€Р=D=@х”ИH0w"И8”И#Ђ€жЄЖDѕP{!=|€d–Pд"Kѕгt@@џЩ(И–0`"]8wИ50[|€dF@дB√@8BD@ж†ЖоС ьУбЫж„=ФжСдСDORдЫРAьџ@tеDїЗh ж†ЖЫ.;Ы*€ѓ√бт√д"PD"ж†Ж$Йэ€P ъB†б7Л|И!л?УТ7м∞Ўі»¶ЉЏ1ё6≥?FВ≥`≥жЋЖ≥дЌЗэЗPШлж†ЖЊж†ЖЃшoB[Сz,_Сz І B@DДЬР±Р?F3ёМ_€д„ужqЖ|ЗЧ?ССЉСђх| УsІЫ(ЈЫ(≥тџССЉСђх_дЫ(џPЖBOR ІДЉСђхУР£ЖЗЌ.ЙД∞»К<и≤д7¬6@'кґƒ≤дб—ЖЋРІjрБъЂвЫє2Р=Ги гдЗАм$ЙмБмЋЇ_ц§ZP\ ърЮмУкЛА АЫ9.*ЇцЦЃ@џџ!PДИ¶„Х®Ѓ(цqРЉhРТhРьhа£БРD≠@ш0БЫ(џх1Ож†Ж э0x≠pp*≠Бpt≠p≠БpНP≠Бpm≠ЕpИPjzHkFkTЪР'ЗЌ.МіЎ≤@°ё9дЇа:Ы\[ж©0TЫж†ЖЫ(;жDЖ0LНpэXpэ`pЌЗэЗPkЫ(ж†Ж0@эяЩ(б§Ы(жЄЖЗЉмBOH мУД∞»МіЎ≤B  SСD’F[СD„FcСtўDџХTшЏСґD$HжеЗP™tћDџ@ІtNDџPэPэВPэЗ@Ю0ТtѕDc
І Ы9.
С„Р?ЬцaР;џPџP0аЫЁ yРD≠@дЫЙ.aеьY„dўDРD≠@бЖT≠@ РD≠@?эВ@FИ?Ь цaИ;џPџPЋжйИ√≈жэЖЫyс3o5ъжэЖш—9Р•ЗЮ ДЉСђхЫиѓфwБМИйИ		с	^ЙvЙъЙCЙ]
_
є
ЛК≥е(ЦЩ,оћ їС≥
жЭКд|ЫК,3o&ІЫg*ЈЫg*≥тжґDMD{€д|ЫК,9эВpЖэpэЗpoдЫ. ж*o£BѕDїFжЭКоуСн€од|ЫК,ІЫg*ЈЫg*≥тжґDќD{€дB= бAЛ °ёґЏЈ№™7»≤ћі№≤»ж9Pr"lBМЉСђц¶ЎFд",BхЬСМСрЎСхBPD}бС@ыBSљМн€УИ≠05BSDИOГ цqЧ$BѕDKPµ  ' СО@С эT7D>k.А "PD&цCuзУДЉСђх0тЕ жґЛџ≠аD8D=gИ Д хєF9BPDцa„$Й$дBѕD' џXУРvИЗP.Д∞»®Ља≤@BPD?FkВ|ЮPzЅ?F/F+„жґ„фнHоСжСдСD=@дBѕD?jІ „ЙB–DцaжЧ?|ЗPlF/F+_•?Ю$ЮPДЫ”(жO
ЗјжO
З»*2 РЂИ?oaйЗЪ"k*жеЗХяЮdBхбQЛzeЙzeУ0pyёuЁcXeўi    Џmџq№    `ГaЗbЫN rЊБЂ„цЦќDџџ!„hB$бAЛ°ёґЏЈ№Діќ≥ 9B$б7ЛfЖЈЏґё7жЪ∞р„РQo2ЊэЊ`ptѕDcІ Ы≠.хV9VєЋРAЖџXTќDхжСдђРЌ„цЦ∞@ДD∞@цЦЋDДDЋDр"TљМ„Р±Р2ЄF8„дTќD>kdЫ@,еьСЬСМцґќDбTЙџ•;F/вСђ8цYСкTќDцЦjDД„∆nц§ZЇџ)p„/F+„>kЌх£9VєУРѓ	З\.ИЇа6“±¬: ¶ЉЏ1ё6Bw$бAЛ!¬2@°–∞“7Ы@,еь•еэцЦќDС„V0
TjDМ„∆nц§ЧЇџ)pb„/вСђ8фў@qУР  џ≠;oц§;„РтjfƒЙTї@єF9FхЫе&мЂмTЎDахжСдСDї@дlЂА	 Ы≠.цґї@о„„оСоСжСдиУ;D’Fхt+Bs¬D„FМD∞@дT D_С2+У;DЏDТ@КъџP≠БP≠В@Дџ≠∞oц§®Р≠ЙD€ЫэЖУъtЫшУшЋкЛъЫЙ(шГи√дBмЂ&
BА€Ж|бdмЂм√цґЏDџџ)DjD>^≥ъЧёСDЎDхD,@шУЫтBА€Ж|бdр≥иTЎDМ„шoц§ц¶>@цґЏD∞oц§ЦТ"ЪЇЇT$HДD$HъъЫ9.Х®ЃхЋцЦ±@џџ!И¶√БPџ\TЏD∞„∆oц§©шЧќЊ^ЈFcTjDМЋ∞џ≠©2иnц§iЛЂм£тЗДжеЗСбGЛУ;D‘Fхt+Bs¬D÷FМD∞@'D÷FМD…D[СDќDбCЙЫ*€ѓЫЗ,рЗz@†)Ю£@†§ҐВ@"В*ВВ)К†@жEП|Ц$ЙХЫQ>@	&	&д"&HЃРoРьџ@108BkDжЬtkDk"цИ£|$Й ~ЫИ*™Р©oЪЉ$ЙT‘F>k Р„
Ы'0[Сџ•SСЫВ*WСшЏPB|(жЬT„FцЦ’Fж
КB√@?l ob2BF@?l oРПКЙ'0ц¶∆Dжп≥к≥иTЎDМ„шoц§ц¶>@;шЏP|бd™@ђtZDgУрУTҐ§)TГ≥Цъ
тЫ,ро№ їС|!$
*£Ч ~ОФ ю≠џ"О> ё≥дре(щ£ЧОЧ }ОЊЈмУмрмэС£_мЧ
.ЦЩ,оћ їС≥ўдBйDЪ\ БкЛъЫє2оBOHшГи\ УжеЗPэtћDџ@ъtNDЁжЗzџСхT÷FЮPT„FЮPTЎF„2д≥оBѕHоћ€\ ≥дnдЫЙ.ут„FTѓ@СFЊVц§"ЪЊV*ЇХVцq?Н ЮжґЛ£т„єF9B.цAцAцAцAцAРAџXB-@Ъ√`ЋА АЫ9.Х®ЃхЋцЦ±@џџ!И¶√БPџ\|@d-@м(мB2@BкDBYDЪB/@B§HB?D√д     АCХTѓ@>Л0B  БnцДZеxе:еЛДЋ/F+BВ М"PD}ЙF@ы√/F+„џУрDП.£а0eн€n>ЛУСoцДСЋкџ≠ґ(ц§и√h0ЙT≠@тґЂцґdDКџ)£р±РЛЗЌ.ЗЮ™®Ю#@¶К¶Ю)≤BжgЛ0БЫ\. баЫў.жqЛЗ8€A"&HтЫ0РЫ'0РѓьЙЂ0ѓxРЙ'0РAьЙЂ0рЫ'0o мЂмГc@	&ХЫQ>хlЖFСl€B&HбКМZB«@?oшЏPШF?ЌњэPВ$ЙFй$ ?ЌњэС\	&?Ќњ$ЙFс„С%РБР|џУРƒЬС џXУ	&?F€с@	&д°ё7жЈЎ≤B&HбКМЫz2e  ЫВ ж
У€жйМ"Y@&ж
 "Y@,ж
 xЏР•l F°„жЮМB@ ЭЫВ4дџ≠°џ•Э|€} цAuqЫj0ИІ@ „ц¶hDцЖgDдЋкЛРЊ|АoПџ5С ~"UсМ}а£рБтЛИeКЫ80џPЙ"Y@¬	9ЌV3√х7Ќ°2–€|µ¬N9ЌЄ2еЌ7ЅЌ°2еЌВaЅ®€|µ¬69ЌЄ2еЌ7ЅЌ°2еЌе1Ѕ|µ :ЌЄ2еЌ7Ѕ√69Ќ°2еЌґ1Ѕ|µ :!  "Ы7Ќ°2еЌе1Ѕ|µ w9*Ы7 Ќ]УЌУ Х9√А9Ќ”МЫ7л!  9еЌЄ2—}√a9!  9л*Ы76 !  9"Я7еЌЙ<Ѕ"Ы7|µ њ9*Bл*Ы7"Я7Ќ”МЯ7n& "Э7|µ Џ9*Э7еЌ7Ѕ√њ9Ќ°2еЌе1Ѕ|µ :ЌЄ2"Э7*vл*Ы7|µ¬:*Э7еЌ7Ѕ√Џ9ЌЄ2еЌ7Ѕ√х7ЌяУ8  8	 68" 68' І8/ ы8\   √	9!  еЌ7Ѕ*F"Ы7*H"F"J*Ы7"H*7|µ x:*NеЌ~ХЅ"H#Ќ5У r:!Љ@еЌэ<ЅЌХ!  "7*Fn& Ё€|µ¬ѕ:!к@еЌЙ>Ѕ|µ Ъ:ЌЯ
√‘:!у@еЌЙ>Ѕ|µ ≠:ЌP;√‘:!ы@еЌЙ>Ѕ|µ ѕ:*Ю)џе! Ќ„У"В√‘:ЅЅЅЅ…ЌV3√•7                    ЌНеЌ*;Ѕ*к:)Џ:еЌ“Уе*м:ЌыТЌ„У…ЌНеЌ*;Ѕ*к:)Џ:Ќ“Уе*м:ЌУ…ЌНл! Ќ†У"к:ЌН& }жoл! лЌ≥У"м:…  ≈≈≈≈!  9еЌ± Ѕ|µ¬m;Ќк0Ќ»2ЅЅЅЅ…ЌН еЌо:Ѕ!  9"N;Ќ”МN;n& еЌE<Ѕ|µ¬};Ќ°2а€Ќ5УеЌ°2ч€Ќ5УЌыТ|µ ≤;ЌЄ2√П;ЌЄ2еЌE<Ѕ|µ¬≤;√h;    *ƒ;е*¬;е! "¬;.ЌНn& еЌе1Ѕ|µ у;ЌНn& еЌо:ЅЌНn& "ƒ;√€Ќ5У <*¬;|µ <!  "ƒ;"¬;*ƒ;еЌE<ЅЌSН+~Ј¬у;*¬;|µ :<!  еЌE<Ѕб"¬;б"ƒ;…  *Bл*DеЌН—}*+л*DЌ]У k<Ќ”МD√~<*C<|µ¬~<!A"C<еЌэ<ЅЌН…      ЌН"З<n& еЌ;Ѕ|µ¬°<!  …*B"Г<л*D"Е<*Е<л*Г<ЌТУ ч<*З<е*Г<еЌ+>ЅЅ|µ г<Ќ”МГ<~Ј¬ќ<*Г<е*BЌЇУ…*Г<ѓЊ#¬з<Њ#¬м<"Г<√ѓ<!  …  *FеЌ2Ѕ!
 еЌZЦЅ*F"п*Jл*пЌТУ C=Ќ”Мпn& ч€Ќ5У 8=!	 √;=!  еЌZЦЅ√=!AеЌ2Ѕ*Ю ЌщУ®еЌ2Ѕ!AеЌ2Ѕ*n"ы<!  "n*Ю)МЌ“УеЌsЅ*ы<"n!%AеЌ2ЅЌН|µ ±=ЌНеЌ2Ѕ!(AеЌ2Ѕ!
 еЌZЦЅЌЮМh!  еЌњ=Ѕ…*{Х|µ¬>*|µ >ЌН|µ¬и=*†###"†л*ЌMУЌУ >!1AеЌ2ЅЌ©Хц€|µ¬ц=! "†…  Ќ_>"	>Ќ5У >!  …*	>еЌНЌЇУ…    Ќ_>"'>Ќ5У =>!  √^>*'>n& еЌе1Ѕ|µ S>!  √^>*'>еЌНЌЇУ…Ѕб—геЈ r>Њ# d>!  лбг≈е≈л…Ќу>ЌНеЌЙ>Ѕ…  *JеЌНеЌ>ЅЅ"З>|µ Ѓ>*Jл*З>"J! …!  …  Ќу>*JеЌНеЌ+>ЅЅ"≤>|µ п>*Jл*≤>"JЌ°2еЌе1Ѕ|µ л>Ќ‘2√Ў>! …!  …Ќ°2}Ј¬?*F#|µјЌV3Ќ°7:lЈ у>Ќ°2}ю  #?ю #?ю	 #?ЈрЌЮМJ√у>) , ; extra ; (ignored) { return if while for do break switch case default continu #asm goto } ( else misplaced case too many cases illegal constant value : bad label #endasm CALL_ illegal function call illegal symbol name previously defined  missing. ******
 not a declared variable too many active whiles no active whiles line too long #ifndef #ifdef ifdefs nested too deep #ifneed #if #else #endif Not enough memory for long line #undef " or ' #include #define #UPPER macro table full ^
******    Line  :    ****** Hit <RETURN> to continue.     !у€9щ!  9еЌНеЌЋAЅЅЌН|µ¬sAЌН ЌУЌУ ВA!  9еЌzsЅ! 9щ…  !у€9щ!  9е! еЌVCЅЅЌН |µ¬љAЌН"ИA! 9ЌmТлл! 9щл…!	fеЌэ<Ѕ!  √µAЌНеЌНеЌVCЅЅ!fеЌz>Ѕ|µ¬ЋAЌН…!у€9щ!  9е! еЌVCЅЅеЌzsЅ! 9щ…f  Ќу>ЌіB"B|µ (BЌНеЌгBЅ√ЧB!6fеЌz>Ѕ|µ¬9B!  …ЌНеЌгBЅ"B|µ ЧBЌ°2√ЖBЌ®2√rB√ЧB*
B еЌ°2—}*
BеЌэ<Ѕ√ЧBЌяУVB  VB	 VB    √YBЌяУPB- PB* PB&   Ќ≈МB|µ ІBЌЄ2√ЧB!  "KA#…     !±BеЌгBЅ"ѓB|µ ЁB*Jл*ѓBn& √€|µ¬ЁB*ѓB#…!  …  ЌН"бBЌ°2√CЌ°2еЌ®2Ќ?У¬ECЌ”МбBеЌ°2—}Ќ”МбBеЌ°2—}√ECЌяУрB> рB< 	C+ 	C- 	C* 	C/ 	C% 	C^ 	C| 	C&   *бB6 *бBеЌНЌЇУ…;≈ЌНеЌnFЅ!  9еЌBЅ|µ ДCЌНе! 9еЌН	еЌ†CЅЅЅЌН3Ѕ…ЌНе! еЌVCЅЅ… .    !у€9щЌуМЪCЌН"ЪCеЌeЅ*ЪCеЌуdЅ|µ¬ћC*ЪCеЌЙsЅ*ЪCn& €|µ¬иC*ЪCе! еЌН}ЅЅЌН~Ј D! 9е*ЪCеЌ!WЅЅЌНе!ЛCе!
 9еЌ≥PЅЅЅ√$D! 9е! еЌVCЅЅЌНЌ5У 5DЌНЌ5УЌУ ¶D*ЪCn& √ХD*ЪCеЌЙsЅ*ЪCеЌя}Ѕ! 9е*ЪCеЌ:EЅЅ*ЪCе! 9еЌЖ{ЅЅ*ЪCе! 9еЌ!WЅЅ*ЪCлб"ЪCб"ЬCб"ЮC! 9щл…ЌяУDD LD LD€   ! 9еЌzsЅ*ЪCеЌя}Ѕ! 9е*ЪCеЌ”DЅЅ*ЪCеЌ,{Ѕ*ЪC√БDЌНеЌбДЅеЌНеЌбДЅ)—√"EЌНеЌНеЌ(ЗЅЅ√3EЌНеЌНеЌюЖЅЅ√3EЌНеЌНеЌЗЅЅ√3EЌяУмD юD E   …      *4EеЌН"4E#n& "6EЌ!Нn& "8EЌ)НЌ“У|µ БE*6Eы€|µ¬vE!8fеЌэ<Ѕ*4E#6б"4E…ЌНеЌбДЅ|µ хE*8E√еE*6Eы€|µ¬ЇE*4E е*4E ЌmТЌYРбЌ{Т√тE*6Eы€|µ вE*4E е*4E ЌmТЌ$РбЌ{Т√тEЌяУХE љE   √F*6Eы€|µ¬F*4E е*4E ЌmТЌYРбЌ{Т*4E#е*8E—}√|EЌНn& Ќ5У KFЌН ЌmТ≈’    ЌГТЌУ…KN                             ЌуМOFЌН"OFе!  еЌPHЅЅ!KfеЌz>Ѕ|µ $H!  "KA*OFеЌzsЅ*OFеЌ:1"SFе! еЌќЅЅЅ*OFеЌnFЅ*OFеЌ(FЅ"YF*OFеЌzsЅ*OF#n& "UF*OF##Ќ“У"WF!MfеЌ€0ЅЌ:1"QFеЌіЅ*SFеЌ@1Ѕ*OFеЌnFЅ*OFеЌ(FЅ"_F*OFеЌzsЅ*UF}2bF*OF#n& "]F*OF##Ќ“У"[FЌУ xG*[Fе*WFЌ?У¬TG*UFе*]FЌ?УЌУ uG*YF|µ rG*[F"WF*]F}2bF√uGЌOq√H*WF|µ МG*_FЌ5УƒOq√H*]Fе*UFЌ!У¬H*]Fл*bF& Ќ]У ѓG*]F}2bF*bF& ьЌzУ“H*WF"cF*]Fе*bF& Ќ!У цGЌ:1"[FеЌіЅ*QFеЌ@1Ѕ*[F"QF*OF#е*UF—}*OFе!aFеЌ”DЅЅ*OF#е*bF& —}*OF##е*WFЌ„У*QFеЌ@1Ѕ*OFлб"OFб"QFб"SFб"UFб"WFб"YFл…OfRfPfUfSf    !у€9щЌуМLHЌНыЌzУ“БHЌНеЌЧIЅлб"LHб"NH! 9щл…ЌНеЌ!НеЌPHЅЅЌН)BHЌ“У"NH! |µ ЖIЌу>Ќ°2е*NHn& Ќ?У¬ЖIЌ®2е*NHn& Ќ!У ÷H*NH#n& |µ ЖI!  "KAЌіB|µ¬пH*NHеЌz>ЅЌ5УЌУ¬ЖIЌНюЌzУЏ%IЌНеЌzsЅЌНеЌ:1"LHеЌНеЌќЅЅЅ√3IЌНе!  еЌН}ЅЅ! 9еЌ!НеЌPHЅЅЌНюЌzУЏfI! 9еЌzsЅ*LHеЌ@1ЅЌГД√ГIЌНеЌя}Ѕ*NHеЌНе! 9еЌ
hЅЅЅ√ЯHЌН√qH          !у€9щ*ПIе*НIеЌН"НIеЌJLЅЌу>Ќ°2√ѕI*НIлб"НIб"ПI! 9щл…√яIЌяУћI= ћI!   √єI! |µ ЉI!Wf"ПIеЌz>Ѕ|µ¬J!Zf"ПIеЌz>ЅЌУ ?L*НIе!  еЌН}ЅЅ! 9еЌJLЅ*НIеЌбДЅ"СI! 9еЌбДЅ)"УIЌНЌ5У KJ*СIл*УIЌ5УЌУ ЁJ*НIеЌя}Ѕ*НI##Ќ“У|µ vJ*НI##6 #6 *НI#6!]fе*НIе! 9еЌ
hЅЅЅ*НIеЌzsЅЌу>*KA#Ќ5У ®JЌ°2е*MAЌ!УЌУ ¬J*ПIn& √€ЌУ#"KA√ЏJ*ПIn& √€|µ¬„JЌYД√ЏJЌГД√'L! 9еЌzsЅ*НIеЌя}Ѕ*НIn& €ЌУ"ХI|µ K! 9еЌ~Ѕ*НIеЌzsЅ*СIл*УI|µ¬?KЌФ~*ПIn& √€|µ¬9KЌТД√<KЌ°Д√'L*СIл*УI√»K*ХI|µ cK! 9е*НIеЌЪЕЅЅ√qK! 9е*НIеЌюЖЅЅ√ўK*ХI|µ НK*НIе! 9еЌюЖЅЅ√ЫK*НIе! 9еЌЪЕЅЅ√ўK*ХI|µ ЈK*НIе! 9еЌ(ЗЅЅ√≈K! 9е*НIеЌ(ЗЅЅ√ўKЌяУJK tK ЮK   *d "d*НI#n& ы€Ќ5У¬€KЌНы€Ќ5УЌУ"СI*ПIn& √€|µ¬L*СIеЌ3ЕЅ√'L*СIеЌQЕЅ*НI6€*НI#6*НI##6 #6 √EL*НI√ЉI√яI  *HLеЌН"HLеЌMPЅЌу>Ќ°2√zLЌ®2еЌ°2Ќ?У¬КL*HLлб"HLл…ЌяУcL< cL>   √pL! |µ sL*HLе!_fе!  еЌ'MЅЅЅ|µ¬КL*HLе!bfе! еЌ'MЅЅЅ|µ¬КL*HLе!efе! еЌ'MЅЅЅ|µ¬КL*HLе!gfе! еЌ'MЅЅЅ|µ¬КL*HL√sL√КL          жаB	2жКМ З80а√дИіжµ@#к6ЎРBЖ€У?o|FѓВЋж
 √едьџсСЊтЫВ р0y†ƒЈд:BжйМЫ2ж
УтT¬@џџ)PЖџ©ЂвЫВ а£рУРХ}dоѓЗ80АofzжќМЫz2Р=Ыq2И 2лHB  И PГОМ ю2 •ЫВ4дЫz2Xж
 "OHжЮМ"«@(ж
 oЮz>P>П>ПЌГлXж
 гџ0ZЋв„жЮМ"«@(ж
 Грoд≥сЂвїтытЋмtВџСэУtВџPАз≥рырїрГи«мУкTD@Х"…эЉЌБ@А62зц§тЉЌБ@В|сdP4ЉН&ё ИЫы:@	√И9€4ЙЮД`В&Й&лцДт„Иu|$ЙџPџPџP$рFИqъ@	&жпО"aDР|ЫQ:t	&жEО|$Рo£бЬ√%¬7…# 1√¶¬9≈†а9√¶¬Љ≈%к7√%к6√†к≥≈© 8√І∆:≈'ё;√" ±≠]PzЮ@АЎ КХшЧќЊ^Ј0√ж@НгфоСFСD=@длжbНpwгu}УъЋжbНpm£шЂт≠XBҐ6√Ю ДЬСМр£ж^Н„фlHFєF9FфУвУфVХV?эѕ~lD=@СЉСђхУI6J6÷6ш6ы6ѕ6L6S6e6р6ї6ї6ї6ї6ї6Ј6>6B6E6Ѕ6≈6„џ)PB  дB€€д_ц§злх_ц§цƒд„ц§Яџ1_д2дoц§дшYќЊgЈУ>E≥ъ—ёдшUќЊWЈУтџ)√хД•"  еpе2х2хR<casН„дфџ@Зц џС£ЧЧО }У„ќЈУ=oсљэ`щodОФ юУжпНјіУ>ЪР  o е"Лџ5џ)`А2ЯЧИ.з£Уж~О<q@ъжэЖRpАJd0ЫЯ:ЊЫ>odxdB•8бgЛ<рэЗ@ВЂжbО£љЫп8„ЗИДЉи≤@Ік:@Іћ§∞№≥   РЦЫў.„ёдлж~О@HТ@БъjЊ√аЮoCООЉaбэЖэЗЩШ:—жњгбэЖЫЯ:’3Z@БъjЊ#oЮ+P/тбэЖЫЯ:”љZ@БъsПbЊъ{ПбэЖЫЯ:ВЅжњB  nъt@@џ@Ыљ:шэяp
эh`лА Ы9.ХVХгС≠яохЫе&мЂм√цЦЎDД„СжСддъжэЖшбэЖB:б7Л#“7“є–К9дЈдoѕхЫљ:?•obОt–PPЪBOP?„A<°hА ждЛ4ждЛ4kїFхFСFєжцО„цa©А З9.=ЌЗTѕPдЫ(ѓЫ(ЂTjDМЋм£ мьCОУ 0О`ЧpџЈ0БЫ`:жБОџЈFлдџЈэPВ$ЙУЉ$Й|У£еpцёЉџЈэpНГ$Йтцёtc	&С уУ `к"x±жjP£	&к"щжjP£	&к"N€жjP£	&к"{€жjP£	&къc`и$ЙУ„2p~џ)zЎС`ЎУжўПT7D>khРpЫҐ2№"&H?Н $Й|$Й СџXЋхlЖFСl€B&HжКМ√/F+„>kЂ∞ozР∞"Y@А џXB	цAцAцA„$жBW0ПЫb<°lЫj0ИeЫ80РКМDД>„d,DдB&HTѓ@ИEХoц§dЧЧОPАH&КРEХ|БЉСђСЫЯ>Ю@БЫы<гЖ@wэБ°тЂвT∆DСlF€РШЫҐ2РШD∆Dа£рУШ≤ћ:€шo,СЉСђтT∆DхЫQ>@	&рFСFJшxЪтЂвлхьџхП>И
 2тBќ>цґ∆DцAцAцAцAцAрtГА"ИoВ|€0џP}ушлЮPЖtГџ@В@	&щц¶∆DшГи√д	&Љ≠Юн’T@шжOПъъ>П>ПЫX>шЌЗнэpНГ$ЙУЊ"QVц¶o>џџ)ЧЧОF’ПУ’ПV’ПшЏСР  ЉСђСDo>хьд  T,@ИШЫQ>Z	&шVжEП„@СlFхT>@цЦ,@џџ!ЫQ>хlФFС„Сџ•ґoцДжEПBЛ>А џXB&HбКМШіƒ9¬9“≤ж§≤вЇ єи≤»€                                                           | S - Check remaining space
D - Delete file         | T - Tag file for mass
E - Erase T/U files     | U - Untag file/*
.he                                                             SYSMAN(BADSM)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

#define		CLOSE	1

/*======================================================================*/
STATUS                      /*						*/
badsm()                     /* Return on error from sysman to amie main */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:-
25/01/90 Third parameter to 'dvc_han' removed because it wasn't used
27/06/89 Calls to 'cls_ent' and 'cls_sec' replaced with direct calls to
         'dvc_handle' and 'sec_han' - ICFO
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

abtswt();		/* Crash close the switch handler		*/
dvc_handle(CLOSE,NULLPTR);/* Close the section of assignment file used*/
sec_han(CLOSE,0,0,0);	/* Close all device descriptor entries		*/

return(FAIL);

}

/*======================================================================*/
 DAR
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

abtswt();		/* Crash close the switch handler		*/
dvc_handle(CLOSE,NULLPTR);/* Close the section of assignment file used*/
sec_han(CLOSE,0,0,0);	/* Close all deееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее     ifofuf{fБfЗfНfУfЩfЮf£f®f≠f≥fєfњf  !у€9щ*€LеЌН"€LЌНеЌz>Ѕ|µ фOЌН"эL*€Ln& €|µ¬hM*€Lе!  еЌН}ЅЅ! 9еЌMPЅ*€L"чLеЌя}Ѕ! 9"щLn& €Ќ5У ЭM*чLn& €ЌУЌУƒ.P*чLеЌбДЅ"M*щLеЌбДЅ"M*Mл*M|µ ^N*чLn& €|µ еM*чLеЌzsЅ*чLеЌ~Ѕ*щLеЌzsЅ*M|µ¬N*чLе*щLеЌЪЕЅЅ*чL#е*щL#n& —}√NЌуМчLЌ”DЅЅ*чL#n& ь€Ќ5У 6N!  √9N! "M*эLл*M)MЌ“УеЌЊ~Ѕ*d "d√ O*чLn& €|µ УO*щLеЌіdЅ|µƒ.P*чLеЌіdЅ|µ [O*щLеЌzsЅЌу>*KA#Ќ5У ¶NЌ°2е*MAЌ!УЌУ µN*чLn& Ќ5УЌУ PO*чL ЌmТлЌƒУ"M*чLеЌъOЅе*щLеЌъOЅЌыТш€Ќ5У"M|µ щN*M|оАg"M*эL√-OЌРМM|µ¬O! е*эLЌЇУеЌ∞wЅ√–O*эL& }жo###"KA√=OЌяУ€N €N   √O*MеЌ)xЅ*MеЌaАЅ√ O*чLеЌјwЅ√ЮO*чLеЌуdЅ|µƒ.P*чLеЌzsЅ*щLеЌуdЅ|µ ЛOЌx}*щLеЌzsЅ√ЮO*чLеЌ~Ѕ*щLеЌzsЅЌЪ~*чLеЌъOЅе*щLеЌъOЅЌыТ"M*эLл*M)MЌ“УеЌЊ~Ѕ! "Ж*€L#6*€L6€*€L##6 #6 ! лб"€L! 9щл…!  √иOЌ)НЌ“У& }жo√PЌ!Нn& +++|µ¬*P! …ЌяУ
P  P   ! …*щL"ыL*чL"щL*ыL"чL*эL}оo"эL…  ЌНеЌQQЅЌу>Ќ°2√°PЌіB|µ¬ЮP!≈f"KPеЌz>Ѕ|µ¬ВP!»f"KPеЌz>ЅЌУ ЮP*KPе!QQеЌНеЌ≥PЅЅЅ√gP√ЃPЌяУ_P> _P<   ЌН…!у€9щЌНn& €Ќ5У¬’PЌНеЌ$QЅЌ5УЌУ йPЌНе!  еЌН}ЅЅЌНе! 9ге!щPгйЅЌНеЌя}ЅЌНеЌНе! 9еЌ
hЅЅЅЌНл! 9щл…ЌНn& √2Q! …ЌяУ.Q+ .Q* .Q| .Q& .Q^   !  …  ЌНеЌєQЅЌу>Ќ°2√•QЌіB|µ¬ҐQ!Ћf"OQеЌz>Ѕ|µ¬ЖQ!]f"OQеЌz>ЅЌУ ҐQ*OQе!єQеЌНеЌ≥PЅЅЅ√kQ√≤QЌяУcQ+ cQ-   ЌН…  ЌНеЌ>RЅЌу>Ќ°2√RЌіB|µ¬R!Ќf"ЈQеЌz>Ѕ|µ¬оQ!ѕf"ЈQеЌz>ЅЌУ¬€Q!—f"ЈQеЌz>ЅЌУ R*ЈQе!>RеЌНеЌ≥PЅЅЅ√”Q√/RЌяУЋQ* ЋQ/ ЋQ%   ЌН…"d        !у€9щЌуМ4RЌН"4R!”fеЌі>Ѕ|µ S!ЏfеЌz>Ѕ|µ¬uR*4RеЌ>RЅ√іRЌТ"6R|µ ЯR*6RеЌZЅ!  "8R*"6R!№fеЌ€0Ѕ√ЁR*4Rе!  еЌЋAЅЅ!№fеЌ€0Ѕ*4Rn& "8R*4R##е*4R##Ќ“У))##Ќ„У*4RеЌ&ZЅ"6R*4Rе!  е.е. ее*6RЌжТ≈’!  ееЌkcл! 9щл*8R€|µ¬S*4RеЌzsЅ√ЊVЌўV":R|µ 6S*4RеЌ>RЅ!  "6R√%VЌ°2√кUЌЄ2"6R*4RеЌ>RЅ*4Rn& |µ¬пS*6R√ёS*4R#n& ы€|µ¬ЗS*4R е*4R ЌmТЌњНбЌ{Т√†S*4R е*4R ЌmТЌOТбЌ{Т√ЊV*4R е*4R ЌmТЌѕТЌжТбЌ{Т√ЊV*4R е*4R ЌmТЌ`ТбЌ{Т√ЊVЌяУ[S- £S! ¬S~   *4RеЌzsЅ*4RеЌбДЅ|µ vT*4R#n& ь€Ќ5У"<R*6R√bT*<R|µ )TЌєД√,TЌ¬Д√ЊV*<R|µ =TЌЋД√@TЌ‘Д*4R#6√ЊV*<R|µ WTЌ∞Д√_T!ёfеЌэ<Ѕ√ЊVЌяУT- /T! IT~   √ЯT*6R√ОTЌPД√ЊVЌYД√ЊVЌhД√ЊVЌяУ|T- ВT! ИT~   ЌЄ2*4RеЌ>RЅ*4R ~Ј ЊT*4RеЌzsЅ*4RеЌТeЅ√ЊVЌЄ2*4RеЌ>RЅ*4R##Ќ“УЌУ¬пT*4R#n&  Ќ]УЌУ эT*4RеЌeЅ*4RеЌЙsЅ*4R##е*4R##Ќ“У))##Ќ„У*4R 6 √ЊVЌЄ2ЌТ"6R|µ ЏU*6RеЌZЅ!№fеЌ€0Ѕ*юЌzУ“XU!gеЌэ<Ѕ*э"8R& }жo+Ќ5У pUЌЮМ8R*4RеЌ>RЅ*4RеЌzsЅ*4R##Ќ“У& }жoЌУ ЪU! √°U*4R#n& е*8R& }жoЌУ ЈU! √ЇU*6RеЌ:ИЅЅ*4R#е*6R—}*4R##е*8RЌ„У√ЊV*4Rе! еЌYWЅЅ√VЌяУ<S- <S! <S~ ЯT* …T& &U(   *4Rе!  еЌYWЅЅЌўV":R|µ ЊV! "6R*4RеЌeЅ*4RеЌуdЅЌ5У HV*4Rn& €ЌУЌУ ^V*4RеЌЙsЅ*4RеЌ~Ѕ! 9е*4RеЌ!WЅЅ*4Rn& €|µ¬АV*4R6€*:Rе*4Rе! еЌѓ[ЅЅЅ! 9еЌ,{Ѕ*6R|µ µV*:Rе*4Rе!€€еЌѓ[ЅЅЅ*4R 6 *4Rлб"4Rб"6Rб"8Rб":R! 9щл…Ќу>Ќ°2√WЌ®2’€|µ¬шVЌЄ2ЌЄ2!Ћf…Ќ®2”€|µ¬WЌЄ2ЌЄ2!]f…ЌяУвV+ шV-   !  …  *Wе! "WЌ≈МW|µ LW√8WЌSН+еЌSН+n& —}√+Wб"W…        !у€9щЌуМQWЌН"QWеЌНеЌ\ЅЅ! |µ X*QW##Ќ“У"SW& }жo"UW!ЏfеЌz>Ѕ|µ бW*UW+++|µ µW!gеЌэ<Ѕ√љW*QWеЌЎ.Ѕ*QW6€*QW 6 *QW##е*SWл! Ќ†УЌ„У√vW*UW+++|µ¬)X*QW##е*SW))}цoЌ„У*QW
 еЌ“У##Ќ„У*QWлб"QWб"SWб"UWб"WW! 9щл…Ќ°2√ZЌЄ2*UW√CX!gеЌэ<Ѕ√SXЌяУ@X @X   √8X*QWе!  еЌН}ЅЅ! 9е! еЌЋAЅЅ*QWеЌя}Ѕ!Ћfе*QWе! 9еЌ
hЅЅЅ*QW ~Ј ЭX*QWеЌzsЅ*QWеЌТeЅ!/gеЌ€0Ѕ√vWЌЄ2*QW#n&  ЌNУ …X*UWЌ5УЌУ ўX*QW n& ЌУ иX! 9еЌ± ЅЌУ €X! 9е!э еЌЩЅЅ"WWЌУ 8Y*QWn& €|µ ОY*QW еЌmТ≈’*WW Ќ“УЌжТЌBТбЌ{Т√јY!1gеЌэ<ЅЌР0√vW!JgеЌz>Ѕ|µ Z*UW++|µ¬8Y! 9еЌ± ЅЌ5У¬АY! 9е!э еЌЩЅЅ"WWЌ5УЌУ¬8Y*QWеЌzsЅ*QW#6*QW##6 #6 *QW 6 !Ћfе*QWе*WW Ќ“УеЌѓ[ЅЅЅ*QW#е*WW n& —}*QW##е*WW Ќ“УЌ„У*QW
 е*WW Ќ„У*QW 6√vW*QW√X√vWЌяУ/X[ ∞X. FY-   √Z      ЌуМ ZЌН
 Ќ“У" ZЌ)НЌ“У""Z& }жo√F[! "$Z√[ЌЙМ Z! "$Z! |µ [*"Zл! Ќ†У""Z& }жo√.[*$Zл*$Z"$Z√[* Z|µ¬†Z!MgеЌэ<Ѕ√≤ZЌЊМ ZЌ“Ул*$ZЌщУ"$Z√aZЌ!Нn& ""ZрЌzУ“дZ*"ZеЌ	!Ѕ Ќ“Ул*$ZЌщУ"$Z√[*"Z√[*$Z"$Z√[*$Z))"$Z√[*$Z)"$Z√[ЌяУкZ уZ уZ   √юZ*$Zлб" Zб""Zб"$Zл…ЌяУZ Z НZ µZ    √aZЌяУVZ [Z   √MZЌНn& √h[! …! …ЌяУ`[ю d[€   ЌНеЌіdЅ|µ Ђ[ЌНЌ5У У[! √™[ЌНеЌ$QЅ|µ І[!  √™[! …! …!у€9щ!  9е!  е.е. ее.ЌНЌжТ≈’!  ееЌkcл! 9щлЌНеЌНе! 9еЌ
hЅЅЅ! 9щ…>Ѕ            ≈≈≈≈*щ[еЌН"щ[! 9е*(ЌЇУ"э[л*бЌУУ 4\*э["бЌН|µ¬E\!ЏfеЌz>ЅЌУ i\!  "KA*щ[е! еЌЋAЅЅ!№fеЌ€0Ѕ√с]! 9еЌ± Ѕ|µ °]! 9еЌЅ"\Ќ5У Э\! 9е!  еЌЩЅЅ"\Ќ5УЌУ “\! 9е! е+е. е#е+ееЌЃл! 9щл"\Ќу>Ќ°2Ў€|µƒ11!  "€["э["ы[*\ Ќ“У"\*\
 n& "\√*]*\"ы[√C]*\ Ќ“У"э[√C]! "\*\ Ќ“У"ы[√C]ЌяУы\ ] ] ] ]   *\& }жo√X]! "€[√e]ЌяУO]  O]   *щ[е*\е*\ n& е*\е*ы[е*э[ЌжТ≈’*\ е*€[еЌkcл! 9щл√с]*щ[еЌg^ЅЌ5У Ї]*щ[еЌbЅЌ5УЌУ с]!`gеЌэ<Ѕ*щ[е!  е.е. ее    ≈’!  ееЌkcл! 9щлЌР0*щ[лб"щ[ЅЅЅЅл…!у€9щЌНn& "MA!€€"KA!  9е! еЌЋAЅЅЌНеЌ€0ЅЌРМKA АЌzУЏ?^! "KA!  9еЌНеЌНе*KAЌУеЌќЅЅЅ!  "KA! 9щ…ЌНеЌМ^Ѕ|µ¬~^ЌНеЌґaЅЌУ…          !ё€9щ!  "Д^9ЌvТ    ! 9"В^Ќ°2"И^“€Ќ5У ј^*HЕЌ5УЌУ _Ќ”МВ^е*И^—}ЌЄ2Ќa"И^еЌВaЅї€|µ¬6_Ќ”МВ^е*И^—}ЌЄ2Ќ°2"И^’€Ќ5Уе*И^”€Ќ5УЌыТе*И^еЌ”1ЅЌыТ|µ 6_Ќ”МВ^е*И^—}ЌЄ2Ќa*В^6 !  9е! 9еЌЮРббЌ{ТЌН$е!  е.е. ее.
9ЌmТ≈’!  ееЌkcл! 9щл! л!" 9щл…Ќ°2еЌ”1Ѕ|µ aЌ°2–€|µ¬ї_! "Д^ЌЄ2Ќ°2еЌВaЅ®€|µ¬ї_! "Д^ЌЄ2Ќ°2еЌDaЅ|µ f`Ќ°2еЌСaЅ"И^	 Ќ^У ж_*Д^ь€ЌУЌУ¬f`Ќ”МВ^еЌЄ2—}*Д^|µ `!  9еЌmТ≈’*Д^ЌжТЌїСбЌ{Т√L`!  9е! 9ЌmТ≈’   ЌїС≈’! 9ЌmТЌBТ≈’   ЌїСбЌ{Т!  9еЌmТ≈’*И^ЌжТЌBТбЌ{Т√ї_*HЕ|µ¬Ў`Ќ°2"И^еЌВaЅ√ƒ`! "Ж^ЌЄ2√ё`*Д^ЌУЌжТ≈’   ЌBТ≈’! 9ЌmТЌґТЌvСЌ Т ї`! √Њ`! "Ж^√ё`ЌяУ∆^. й^E А`L   √М`! "Ж^ЌН$е!  е*Ж^е!  ее.
9ЌmТ≈’!  ееЌkcееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(CTDRVS)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
WORD               /*							*/
ctdrvs()           /* Count the number of drives attached to the system */
/*======================================================================*/
/*USE
Portability	Level 4 (Depends on Gemini hardware)
Parent Module	AMIE System Manager
Revision History:
07/02/90 Started - ICFO
*/

{

LOCAL
WORD	mxdef;		/* Counter					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Get number of drives defined						*/
mxdef = -1;
while (hardware[++mxdef].ddfname[0] != NULL) ;	/* Do nothing loop	*/

return(mxdef);

}

/*======================================================================*/
========*/
/*USE
Portability	Level 4 (Depends on Gemini hardware)
Parent Module	AMIE System Manager
Revision History:
07/02еееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееел! 9щл! √w_!  √w_√w_ Ќ°2}2aеЌ”1Ѕ|µ <aЌ”МВ^е*a& —}ЌЄ2√a*a& …  ЌНеЌ”1Ѕ|µ Va! …ЌНеЌВaЅ"BaA ЌNУ ta*BaF ЌMУЌУ ~a! …!  …—бе’}юaЎю{–÷ o…ЌНеЌ”1Ѕ|µ ®aЌН–€…ЌНеЌВaЅ…€…!sgеЌz>Ѕ|µ¬«a!  …ЌНе!  е.е. ееЌdЌжТ≈’!  ееЌkcл! 9щл!sgеЌ€0Ѕ! …            !Ь€9щ!ugеЌz>Ѕ|µ¬#b!  л!d 9щл…!  9"ьaЌ°2ё€|µ MbЌ°2|µ MbЌ”МьaеЌd—}√*bЌЄ2Ќ”Мьa6 *ьaе! 9ЌЇУ"b*|µ бb*>"юa*>л*@л*юaЌТУ бb!  9" bЌ”Мюa"b*ьaл* bЌТУ їbЌ”М bn& еЌ”Мbn& Ќ?У¬ёb√Фb*>л*@л*bЌАУ ёb*юaе*>ЌЇУ+"b√;c√sb*@"b!  9" b*ьaл* bЌТУ ;c*+л*@ЌNУ "c*ъa|µ¬c!wgеЌэ<Ѕ! "ъa√;cЌ”М@л*>еЌ”М bn& —}√оbЌНfе! е.ее*bе*bЌЎТ≈’!  ееЌkcл! 9щл*b√bеЌ*icеЌН"icеЌН—}*ic#еЌН—}*ic##еЌНЌ„У*ic еЌНЌ„У*ic е!
 9ЌmТбЌ{Т*ic
 еЌНЌ„У*ic еЌН—}ЌН√рc! "К√эc! "И√эcЌяУёc зc   б"ic…     ЌЄ2}2d§€ЌУ d*d& …ЌЄ2}2d!Оg"d*d~Ј VdЌ”Мdn& е*d& Ќ!У Nd*dn& …Ќ”Мd√+d*d& еЌ”1Ѕ|µ Ђd*d& –€}2d! "dЌРМdЌУеЌ°2еЌ”1ЅЌУ|µ Ђd*d& )))еЌЄ2–€ЌыТ}2d√xd*d& }√ЌУЌНn& √ЏdЌ)НЌ“У& }жo+ЌУ ÷d!  …! …ЌяУЊd Њd Њd ÷d    !  …ЌНn& √e! …ЌяУэd  эd эd эd   !  …ЌН ~Ј +e! …Ќ)НЌ“У& }жo√NeЌ!Нn& рЌzУ“_e√ВeЌяУ;e  Ke Ke   ЌНn& √me! …ЌяУie ie ie ie   !ЩgеЌэ<Ѕ!  ……Ќ  *ОeеЌН"Оe##Ќ“У& }жo√пe!ЇgеЌэ<Ѕ*Оe
 Ќ“У"Рe*Оe
 еЌЙМРeЌ„У*Оe##еЌ“Ул! Ќ†УЌ„У*Оe 6√€eЌяУ≥e –e   √Ђe*Оeлб"Оeл…must be a constant , Warning - =X op assumed = illegal assignment ? : || && ^ == != - <= >= < > cl.le cl.ge cl.lt cl.gt cf.le cf.ge cf.lt cf.gt c.le c.ge c.lt c.gt c.ule c.uge c.ult c.ugt << >> + * / % sizeof ( ) operands and/or operator incompatible too complex not a function can't subscript ] illegal struct reference -> can't compute size invalid expression ' " string space exhausted n
t	brf Illegal expression - need lvalue not a pointer Xq‘ГZqЁГ]qжГ_qпГaqДcqGДfq/ДiqДlqДoq&Д  ”DЅЅ                    ЌуМфg
ЌН"фg*тgеЌН"тg" h*фg"h* hn& €|µ¬Bh* hеЌzsЅ*hn& €|µ¬Yh*hеЌzsЅЌНn& "юg* h##Ќ“У& }жo"ьg*h##Ќ“У& }жo"шg*ьgЌУ"цgе*шgЌУ—"ъg√Њk*юg”€|µ¬q√ѕk*юg√јh√–h*цg|µ¬–h√qЌяУ≤h+ µh-   √љh*цg|µ¬кh* h"h*h" h*h"h*hеЌбДЅ|µ¬q* hеЌ&ZЅ"шg+Ќ5У¬ѕk*hn& €|µ¬(iЌ≤~*h6€* h6ю√Di* hn& €|µ¬Di* hе!  еЌН}ЅЅ!]qе*hе*шgеЌѓ[ЅЅЅ* hеЌя}Ѕ*h#е* h#n& —}*h##е* h##Ќ“УЌ„У√ѕk* hеЌбДЅе*hеЌбДЅ—"h|µ їk* hеЌбДЅ|µ мj*hn& €|µ¬cj*hеЌzsЅ*hеЌбДЅ|µ¬џiЌуМ hЌюЖЅЅ√$j*h#n& ы€|µ¬j* hn& €|µ¬j* hе*hеЌЪЕЅЅ* h#е*h#n& —}√$jЌуМ hЌ(ЗЅЅ*h#е* h#n& —}* hn& €|µ `j*hеЌ~Ѕ* hеЌzsЅЌНеЌ$QЅ|µћБЕ√<k* hn& √№j* hеЌzsЅ* hеЌ~Ѕ*hеЌzsЅ*hеЌбДЅ|µ¬ЯjЌуМ hЌюЖЅЅ√ўj*h#n& ы€|µ¬ќj* hе*hеЌЪЕЅЅ* h#е*h#n& —}√ўjЌуМ hЌ(ЗЅЅ√<kЌяУlj€ |jю   √lj*hеЌбДЅ|µ їk* hn& €|µ k* hеЌzsЅ* hеЌ~Ѕ* hе*hеЌЪЕЅЅ* h#е*h#n& —}*hеЌzsЅ* h#n& ы€Ќ5У¬[k*h#n& ы€Ќ5УЌУ Ыk*юg√{kЌ!Нn& е*юgЌ?У¬Ыk√qЌяУgk< gk> xk% xk& xk| xk^   √ЫkЌНе* hеЌnЖЅЅ*тg#е* h#n& —}√Їp√ѕkЌяУЭh ђh Бi    *hn& |µ¬Ѓn* h ЌmТл"цg*h ЌmТл"шg|µ¬.l*юg√lЌ!Нn& е*юgЌ?У¬.l√`mЌяУl< l> l+ l- l|   * hn& √pm*ьg+|µ¬Еm*юg√!m*цgл*шg"цg√Nm*цgе*шgЌЇУ"цg√Nm*цgл*шgЌщУ"цg√Nm*цgл*шgЌФ"цg√Nm*цgл*шgЌФл"цg√Nm*цgе*шgЌыТ"цg√Nm*цgе*шgЌУ"цg√Nm*цgе*шgЌУ"цg√NmЌ!Нn& ƒ€Ќ5У гl*цgл*шgЌ≥У√нl*шgл*цgЌ]У"цg√NmЌ!Нn& ¬€Ќ5У m*цgл*шgЌ†У√m*шgл*цgЌ^У"цg√NmЌяУFl+ Tl- dl* tl/ Дl% Хl| •l& µl^ ≈l< уl>   * h е*цgЌжТбЌ{Т*тgе* hеЌ!WЅЅ√"qЌяУ7l 7l 7l @l    * hеЌzsЅ*юg√Йn*шgЌƒУ"шg*шg АЌzУЏЇm!zД"h*шgЌƒУ"цg√∆m!qД"h*шg"цg*цg√шm*hе!’mгй*hе!ёmгй*hе!зmгй√Їp*шgеЌ)xЅЌ‘Г√ЇpЌяУћm ’m ёm   √кm*шg+|µ Їp√ЃnЌ!Нn& ƒ€|µ¬Ѓn! л*шgЌ≥У"шg*шg√PnЌЋГЌЋГЌЋГЌЋГЌЋГЌЋГ√ЇpЌяУ;n@ >n  An Dn Gn Jn Mn   √Ѓn*юgе*шgеЌ;БЅЅ|µ¬Їp√ЃnЌяУУm- Ьm+ n/ n< 5n* tn& tn| tn^   ЌНеЌ$QЅ|µ ≈n* hn& Ќ5УЌУ аn* h"h*h" h*h"h√ѕk!»g"сЌЊМсЌ“У"h|µ q√oЌЙМс√жnЌ”Мhn& е*юgЌ!У qЌ!Нn& Ќ5У¬3oЌ”Мhn& еЌ!Нn& Ќ!УЌУ q*hn& Ч€"шg* hе*шgеЌН еЌV[ЅЅЅе*hе*шgеЌН"еЌV[ЅЅЅ—Ќ^У Жo* h"h*h" h*h"h* hn& √p*hn& €|µ¬іo* hеЌјwЅ*шg|µ¬-pЌ~√p* hеЌzsЅ*шg|µ щoЌНеЌ$QЅ|µ Џo*hеЌіdЅЌУ лo*hеЌјwЅ√цoЌx}*hеЌzsЅ√-p* hеЌ~Ѕ*hеЌzsЅ√pЌяУЉo€ pю   √Пo*шg|µ *pЌЪ~√-pЌФ~*ъg|µ¬kp*h#n& +++Ќ5У¬Rp* h#n& +++Ќ5УЌУ kp* h#е*h#е! —}—}*тgе* hЌ?У ДpЌНеЌ$QЅЌ5УЌУ Ыp*шg|µ ШpЌx}√ЫpЌ≤~*сЌ“У"hе* h#n& +++Ќ5Уге!єpгйЅ*тg6€*ъg√q*юg”€|µ¬q* hеЌ&ZЅ"цgе*hеЌ&ZЅЌ?У¬q*тg#6*тg##6 #6 !_qе*тgе*цgеЌѓ[ЅЅЅ√qЌяУ≈p   √"q√щnЌOqб"тgб"фgб"цgб"шgб"ъgб"ьgб"юgб" hб"hб"hб"h…!rqеЌэ<Ѕ…+ -i * / % << >> |i ^i &i operands and/or operator incompatible         бЅ≈е:ҐЈ Їqyю.¬≥q@ю_¬Їq?≈yЈ дq*n}і бqеЌЩ—+|ітдqЌ÷!эИеЌэ<Ѕ√дqЌZЦб…  ЌН"жqЌ”Мжqn& еЌ†qЅ|µ¬пq…!
 еЌ†qЅ!  "Ъq"Ж"А…!	 еЌ†qЅ…! "А.:еЌ†qЅ…*А|µ >r!  еЌњrЅ*Ъqл*А|µƒr…ЌНеЌYrЅЌr…ЌrЌНеЌиqЅ…ЌНеЌњrЅЌr…    ЙЙЙ#Й(Й,Й1Й8Й>ЙCЙHЙWЙ\ЙcЙiЙpЙwЙДЙКЙРЙЦЙЬЙ£Й™Й∞ЙЙµЙ“ЙгЙЙлЙККККџЙЌrЌН  ЌNУ ўrЌН$ Ќ]УЌУ фrЌН)wrЌ“У"sr"ur√ьr!5КеЌэ<Ѕ*urеЌиqЅ…  ЌН"s АЌ5У !s!MКеЌиqЅ…*s АЌzУЏ>s!- еЌ†qЅ*sЌƒУ"s*sеЌGsЅ…ЌНцЌzУ“dsЌНл!
 ЌФеЌGsЅЌНл!
 ЌФл0 еЌ†qЅ…ЌНе!  еЌ tЅЅ…ЌНе! еЌ tЅЅ…  ЌНn& €Ќ5У ґsЌ!Нn& +Ќ5УЌУ  sЌН n& Ќ5УЌУ №sЌ!Не! —}…! "Шs#ЌНе!  еЌ tЅЅ!  "Шs…4R      ≈≈*юsе*шsеЌН"шsе*ЬqЌ?Уƒµ}ЌН
"ьs*шs##Ќ“У"ъs& }жo√Пt*шs#n&  ЌNУ MtЌН
Ќ5УЌУ¬—v√Ьt*шs##е*ъs}жьo}цoЌ„У*шs
 еЌ“У##Ќ„УЌН
|µ¬—v!
 96#6 √ЬtЌяУ6t  Vt   *шsеЌҐ|ЅЌ5У¬ЃtЌН
ЌУ Иu*шsn& √lu*шs ~Ј¬-u√шv*шsеЌбДЅ|µ  u!SКеЌYrЅ*шsеЌ®zЅЌrЌ2Н
|µ шv!ZКеЌЊ~Ѕ√шv/*
.he                                                            SYSMAN(DCLASH)
.pa
*/
#include	"amie.h"
#include	"sysman.h"
#include	"dformat.h"
#include	"disc.h"

EXTERN
struct	dtext	*fdtext;	/* Pointer to format names in BIOS	*/

EXTERN
struct	drvtbl	*drvtab;	/* Pointer to BIOS drive tables		*/

EXTERN
struct	disctb	*dtbl;		/* Pointer to BIOS disc tables		*/

EXTERN
WORD	phytran[];	/* Translate table for drive values from BIOS	*/

EXTERN
BOOLEAN	f_forced[];		/* Flags if format forced onto a drive	*/

/*======================================================================*/
STATUS                   /*						*/
dvclash(sframe,sdtype)   /* Try to alter setup struct after drive clash */
struct	ssf	*sframe;/* SOURCE / DEST versions of setup structure	*/
WORD	sdtype;		/* SOURCE or DEST				*/
/*======================================================================*/
/*USE
Portability	Level 4
Parent Module	AMIE system manager
Revision history:-
07/02/90 'sdtype' introduced - ICFO
02/02/90 Much modified to allow for setting up of either
         SOURCE OR DEST - ICFO
22/06/89 Listing brought up to latest standards - ICFO
15/06/87 Created - DAR
*/

{

LOCAL
WORD	mxdef,		/* Number of drives defined in drive table	*/
	mxdef1,		/* As 'mxdef' but computed once only		*/
	clashdv,	/* Drive on which clash ocurred			*/
	cd,		/* Current logged in drive			*/
	srv,		/* 'setovl' return value			*/
	pass;		/* 'sframe' indexer				*/

LOCAL
BOOLEAN	defined;	/* Flags whether clash has been resolved	*/

LOCAL
struct	ssf	tssf,	/* Local copy of setup structure		*/
		*ssfp[2];/* Pointer to SOURCE / DEST setup structures	*/

LOCAL
struct	dformat	fmtdet;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#ifdef BUG
putstr("\n\nDVCLASH - IDENTICAL DRIVES DETECTED REASSIGN");
getkey();
#endif

/* Get drive producing clash						*/
clashdv = phytran[(drvtab[floppy[SOURCE]].dvt_dadty & 0x07)];

/* Get logged in drive							*/
cd = bdos(0x19,0);

#ifdef BUG
putstr("\nClash drive = ");
putnum(clashdv);
putstr("\nFloppy SOURCE was ");
if (f_forced[SOURCE]) putstr("FORCED");
else		      putstr("NOT FORCED");
putstr("\nFloppy DEST   was ");
if (f_forced[DEST]) putstr("FORCED");
else		    putstr("NOT FORCED");
getkey();
#endif

/* Get number of drives defined						*/
mxdef1 = ctdrvs();

/* Set up the 'setup' structure for the 'other' drive to be setup	*/
strcpy(tssf.fmtnm,fdtext[floppy[sdtype ^ 1]].dtxt_format);
tssf.fdata = &fmtdet;
tssf.osnum = device[sdtype ^ 1].opsys;
if (getoff(&tssf) == FAIL)  return(FAIL);
if (rdform(&tssf) == FAIL)  return(FAIL);

#ifdef	BUG
putstr("\nStructure sframe\n");
srv = 0;
while (srv < sizeof(struct ssf)) {
  puthex(*((BYTE *) sframe + srv++));
  putvid(' ');
}
getkey();
putstr("\nStructure tssf\n");
srv = 0;
while (srv < sizeof(struct ssf)) {
  puthex(*((BYTE *) &tssf + srv++));
  putvid(' ');
}
getkey();
#endif

if (sdtype == SOURCE) {
    ssfp[0] = sframe;
    ssfp[1] = &tssf;
}
else {
    ssfp[0] = &tssf;
    ssfp[1] = sframe;
}

defined = FALSE;
pass = SOURCE;
while (defined == FALSE && pass <= DEST) {

/* If this drive has been forced go straight on to the next		*/
    if (f_forced[pass] == FALSE) {

	mxdef = mxdef1;

/* Try to assign format to remaining drives excluding 'clashdv'		*/
	for (ssfp[pass]->fdriv = 0; mxdef-- > 0 && defined == FALSE;
						    ++ssfp[pass]->fdriv) {
	    if (ssfp[pass]->fdriv != clashdv) {

#ifdef BUG
		putstr("\nTry to assign ");
		putstr((pass == SOURCE) ? "SOURCE" : "DEST  ");
		putstr(" to drive ");
		putnum(ssfp[pass]->fdriv);
		getkey();
#endif

/* Try to define this format on the source drive.  Succeed only if the	*/
/* double step flag not set						*/
		if ((srv = setovr(ssfp[pass],pass)) >= 0) {
		    if (pass == DEST
		       && (drvtab[floppy[SOURCE]].dvt_step & 0x80) != 0) {
#ifdef BUG
			putstr("\nforce succeeds step fails");
			getkey();
#endif
			continue;
		    }
#ifdef BUG
		    putstr("\nFORCE SUCCEEDS on drive ");
		    putnum(ssfp[pass]->fdriv);
		    getkey();
#endif
		    defined = TRUE;
		}
#ifdef BUG
		else {
		    putstr("\nFORCE FAILS on drive ");
		    putnum(ssfp[pass]->fdriv);
		    putstr(" error ");
		    putnum(srv);
		    getkey();
		}
#endif

	    }
	}
    }
    ++pass;
}

/* Restore logged in drive						*/
bdos(0x0e,cd);

return((defined == TRUE) ? SUCCESS : FAIL);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЌН
|µ u!SК√u!aКеЌYrЅ*шsеЌ®zЅЌr√шv*шsеЌwЅЌН
|µ¬iu*шsеЌбДЅ|µ Nu!ZКеЌЊ~Ѕ√iu*|µ au! еЌfrЅ√iu!gКеЌЊ~Ѕ√шvЌяУљt€ †u  ћt ћt %u   √—v*шsn& √№v*шs ~Ј¬Нv√шv*шsеЌбДЅ|µ¬јu*шs ЌmТлеЌ∞wЅ√шv! 9е*шs ЌmТ≈’€€  Ќ^СбЌ{Т! 9ЌmТлеЌ)xЅ!jКеЌYrЅ! 9е*шs ЌmТ≈’! ЌжТЌvСбЌ{Т! 9ЌmТлеЌsЅЌr√шv*е*ШsЌыТ|µ 9v!qК√<v!aКеЌYrЅ*шsеЌ®zЅЌr*Шs|µ¬Вv*|µ zv*|µ ov! еЌfrЅ√wv!vКеЌЊ~Ѕ√Вv!# еЌfrЅ√шv*шsеЌwЅ*Шs|µ †v! еЌfrЅ√ќv*|µ¬≥v! еЌfrЅ√ќv*|µ ∆v! еЌfrЅ√Lv!^КеЌЊ~Ѕ√шv!|КеЌэ<Ѕ√шvЌяУСu€ †u  $v $v Еv   √—v*шs6€*шs е*ьs—}*шsлб"шsб"юsЅЅл…"*wеЌН"w ЌmТ≈’€€  ЌсС Ww*w еЌmТ≈’! ЌжТЌvСбЌ{Т*w Ќ“Уе*w ЌmТл—е*dЌЇУеЌ∞wЅ! еЌfrЅб"w…ЌН|µ ѓwЌН€ЌzУ“¶w!+ еЌ†qЅЌНеЌsЅ…ЌБ}ЌНеЌsЅЌr…!ИКеЌYrЅЌНn& |µ аwЌНеЌ®zЅ√%xЌН ЌmТ≈’€€  ЌсС xЌН еЌmТ≈’! ЌжТЌvСбЌ{ТЌН ЌmТлеЌsЅЌr…!ИКеЌYrЅЌНеЌsЅЌr…!  "Ъq"Шq…  *ШqеЌНЌ?У ix*Шq|µƒrЌН"ШqЌ2Н)HxЌ“Уе*ЪqЌУ|µ Мx!, еЌ†qЅ√¶x*Ъq|µƒr*Шq+|µ¬£xЌфА√¶xЌБЌЮМЪq…ЌН€ЌzУ“кxЌ2НЌ5У …x! √ћx! еЌLxЅЌНеЌsЅ! 96 #6 Ќ{Н√ђx…! еЌLxЅЌНеЌ®zЅ…Ќ.r*Ъq|µƒ>x!; еЌ†qЅ…Ќэx*$еЌиqЅЌr*r|µ Gy*|µ¬Gy!ПКеЌ£yЅ*Д|µ Gy!ШКеЌ£yЅ…€€*|µ¬Xy*HyЌ5УЌУј!  "Hy*|µ uy!ЮКеЌиqЅЌr…*|µ¬Еy*Hy+Ќ5УЌУј! "Hy*|µ Ґy!§КеЌиqЅЌr…!™КеЌYrЅ*геЌиqЅЌНеЌиqЅ!±КеЌиqЅЌr…*|µ гy!^КеЌЅ!ґКеЌLrЅ√8z*r|µ 8z*И|µ ыy!ЇКеЌ£yЅ*К|µ z!√КеЌ£yЅ*Ил*К|µ  z!ЋКеЌ£yЅ!‘КеЌиqЅ!  еЌfrЅ!ўКеЌLrЅ…!aКеЌYrЅЌН Ќ“УеЌi1ЅеЌиqЅЌr…!гКеЌYrЅ√AzЌН
 n& √ЧzЌН Ќ“УеЌi1ЅеЌиqЅ√£zЌНеЌиqЅ√£zЌяУsz   √Лz…    ЌН"¶z Ќ“У"§z*¶zn& √Ёz*§zеЌi1ЅеЌиqЅ√йz*§zеЌиqЅ√йzЌяУ¬z   √“z*¶z ЌmТ≈’€€  ЌсС {*¶z еЌmТ≈’! ЌжТЌvСбЌ{Т*¶z ЌmТлеЌИwЅ…ЌНn& √Y{ЌНеЌ¬|Ѕ√m{ЌНеЌ.}Ѕ√m{!|КеЌэ<Ѕ√m{ЌяУ6{ 6{ B{ю   √N{ЌН6€ЌН 6 ЌН… √  ≈≈ЌуМВ{ЌН"В{! 9еЌН ЌmТбЌ{Т*В{еЌбДЅ|µ #|*В{n& +++|µ¬“{ЌБ}*В{еЌ®zЅЌr!йКеЌЊ~ЅЌБ! 9ЌmТ≈’€€  Ќ^СлеЌsЅ!, еЌ†qЅ! 9ЌmТ≈’! ЌжТЌvСлеЌsЅЌrб"В{б"Д{ЅЅ…ЌН
 ЌmТл"Д{*В{n& +++|µ¬Y|ЌБ}*Д{еЌsЅЌr*В{еЌ,{Ѕ√|!оКеЌYrЅ*Д{& еЌsЅЌr*В{еЌҐ|Ѕ|µ¬Я|! еЌfrЅ!оКеЌYrЅ*Д{л! Ќ†У& еЌsЅЌr√|Ќ!Нn& +Ќ5У Ї|Ќ)НЌ“УЌ5УЌУ…€  ЌуМЊ|ЌН"Њ|еЌбДЅ|µ ш|ЌБ}*Њ|еЌ®zЅЌr!хКеЌЊ~Ѕб"Њ|б"ј|…*Њ|еЌҐ|Ѕ|µ }! еЌfrЅ!ьКеЌYrЅ√ }!гКеЌYrЅ*Њ|еЌ®zЅЌr√п|ЌНеЌбДЅ|µ H}Ќ¶~!хКеЌЊ~Ѕ…ЌНеЌҐ|Ѕ|µ l}ЌЪ~! еЌfrЅ! еЌfrЅ√w}ЌФ~!ЛеЌЊ~Ѕ…! еЌfrЅ…Ќµ}!SКеЌYrЅ…ЌНn& €|µ °}!  …Ќµ}ЌН"ЮqЌН"Ьq…  *Ьq|µ ё}*Ьq"≥}!  "Ьq*≥}е*ЮqеЌ tЅЅ*≥}еЌ~Ѕ…ЌНе*ЬqЌ!У у}!  "Ьq…ЌЧМd! еЌfrЅ…ЌЧМd! еЌfrЅ…ЌЋ*~еЌН"~еЌбДЅ|µ 4~*~ n& Ќ5УЌУ @~Ќy~√C~Ќф}*~n& €|µ¬g~*Ьq|µ o~*Ьqе*~Ќ?У o~!5КеЌэ<Ѕ*~6юб"~…*dь€"d! еЌfrЅ! еЌfrЅ…ЌЙМd…ЌФ~! еЌfrЅ…ЌФ~! еЌfrЅ…Ќµ}! еЌfrЅ…ЌНеЌш~Ѕ*Ґ|µ ё~ЌrЌНеЌЅ√ч~*|µ ф~!ЛеЌиqЅЌr√ч~Ќr…Ќµ}!ЛеЌYrЅЌНеЌиqЅ…!ЛеЌYrЅЌНеЌиqЅЌr…*|µ >!ЛеЌиqЅЌНеЌиqЅЌr…*Д|µ `!ЛеЌЊ~ЅЌБ!зеЌиqЅЌr√h!#ЛеЌLrЅ…!'ЛеЌYrЅ!зеЌиqЅ!.ЛеЌиqЅ…ЌБ}*|µ¬Ш!=ЛеЌиqЅ√†!AЛеЌиqЅЌrЌ≤~!	 еЌfrЅЌЙМd…! еЌњrЅЌНеЌP1ЅЌr… !ЌНеЌЪsЅ*Ж|µ¬DАЌ)НЌ“УЌ5У ъЌН n& Ќ5УЌУ <АЌ!Нn& √+А!EЛеЌЊ~Ѕ√DА!LЛеЌЊ~Ѕ√DА! еЌfrЅ√DАЌяУ
А А  А   !
 еЌfrЅЌН…n& еЌњrЅЌНеЌP1ЅЌr…ЌН|µ¬pАЌ‘Г√ОА*|µ ЖА!" еЌfrЅЌ‘Г√ОА!RЛеЌЊ~Ѕ…!XЛеЌЊ~ЅЌНеЌНЌ?У ”АЌБЌ`Н++Ќ“УеЌP1Ѕ!, еЌ†qЅЌ`Н++Ќ“УеЌsЅЌr√ЧАЌБ!  еЌsЅЌrЌН|µ уАЌНеЌіЅ…!`ЛеЌYrЅ…!dЛеЌYrЅ…!kЛеЌYrЅЌНеЌsЅ…!oЛеЌYrЅ…€   sЛ  € xЛ   }Л        ЌНл! Ќ†У& "3БЌН& "5БЌН√vБ!!Б"7Б√ЖБ!'Б"7Б√ЖБ!-Б"7Б√ЖБЌяУ[Б& dБ|   √mБ! "9Б*7Б##Ќ“Уе*3БЌ!У ЃБ!H е*3БеЌЖВЅЅ√ƒБ*7БЌ“Уе*3БЌ?У ƒБ!  "9Б*7Б##Ќ“Уе*5БЌ!У жБ!L е*5БеЌЖВЅЅ√В*7БЌ“Уе*5БЌ?У В*9Б|µ В!L е*7Б Ќ“Уе*5БеЌ@ВЅЅЅ*9Б…*9Б|µ¬<В!H е*7Б Ќ“Уе*3БеЌ@ВЅЅЅ! …!ВЛеЌYrЅЌНеЌ†qЅЌrЌНеЌYrЅЌНеЌsЅЌr!ЙЛеЌYrЅЌНеЌ†qЅ!ѕЙеЌиqЅЌr…!ОЛеЌYrЅЌНеЌ†qЅ!, еЌ†qЅЌНеЌsЅЌr…  ЌНе*dЌЇУ"ђВ|µ¬∆ВЌН…*ђВ АЌzУ“%Г*ђВхЌzУЏ%Г*ђВ& }жo|µ щВ! еЌfrЅЌ≈МђВ*ђВ|µ  ГЌН|µ Г! √Г! еЌfrЅЌЧМђВ√щВЌН…*ђВ АЌzУЏДГ*ђВ
АЌzУ“ДГ*ђВ& }жo|µ XГ! еЌfrЅЌ”МђВ*ђВ|µ ГЌН|µ oГ! √rГ! еЌfrЅЌЙМђВ√XГЌН…ЌН|µ ФГЌНЌ5УЌУƒx}ЌБ}*ђВеЌsЅЌr! еЌfrЅЌН|µ јГЌНЌ5УЌУƒx}ЌН…! еЌfrЅ…! еЌfrЅ…!УЛеЌЊ~Ѕ…!ЦЛеЌЊ~Ѕ…ЌН|µ юГ!ЭЛ√Д!£ЛеЌЊ~Ѕ…ЌНеЌпГЅЌx}…!©ЛеЌЊ~Ѕ…!ђЛеЌЊ~Ѕ…!ѓЛеЌЊ~Ѕ…ЌН|µ >Д!≤Л√AД!ЄЛеЌЊ~Ѕ…!ЊЛеЌЊ~Ѕ…!ƒЛеЌЊ~Ѕ…! ЛеЌЊ~Ѕ! "Ж…!–ЛеЌЊ~Ѕ…! еЌfrЅ…! еЌfrЅ…!÷ЛеЌЊ~Ѕ! "Ж…!ЏЛеЌЊ~Ѕ! "Ж…!ЁЛеЌЊ~Ѕ! "Ж…!аЛеЌЊ~Ѕ…!жЛеЌЊ~Ѕ…!мЛеЌЊ~Ѕ…!тЛеЌЊ~Ѕ…!шЛеЌЊ~Ѕ…    ЌуМЁДЌ!Нn& "ЁДЌ)НЌ“У& }жo"яД++|µ¬Е!  лб"ЁДб"яДл…*ЁДь€Ќ5У¬-Е*ЁДы€Ќ5УЌУ√ЕЌН|µ BЕ!юЛ√EЕ!МеЌЊ~Ѕ! "Ж…ЌН|µ `Е!	М√cЕ!МеЌЊ~Ѕ! "Ж…! еЌfrЅ…!МеЌЊ~Ѕ…!МеЌЊ~Ѕ…?ciulf @..@     ЌуМЦЕЌ!Нn& "ЦЕЌ!Нn& "ШЕе*ЦЕЌ!У «Еб"ЦЕб"ШЕ…*ЦЕКЕn& еЌВaЅ}2СЕ*ШЕКЕn& еЌВaЅ}2ФЕ!СЕеЌЊ~Ѕ*ЦЕ Ќ]У 
Ж*ШЕ ЌNУЌУ ЖЌЧМd*ЦЕ ЌNУ *Ж*ШЕ Ќ]УЌУ 5ЖЌЙМd√ЊЕ            "М$М(М*М.М0М4М•Л6М8М<МјЛ>МЇЛ@МЙBМDМHМJМ  !>Ж"8Ж#"8Ж+еЌ!Нn& КЕn& еЌВaЅ—}Ќ”М8Ж6.!DЖ"<ЖЌЊМ<ЖЌ“У":Ж|µ лЖ*:Жn& еЌНn& Ќ!У гЖ*<ЖЌ“У":ЖЌ”М8ЖеЌ”М:Жn& —}|µ¬ Ж√лЖЌЙМ<Ж√ЭЖ!>ЖеЌЊ~Ѕ*d "d…ЌНеЌНе! еЌGЗЅЅЅ…ЌНеЌНе! еЌGЗЅЅЅ…ЌНеЌНе! еЌGЗЅЅЅ…Xx.Xx     ЌНеЌИЅ"CЗЌНеЌИЅ"EЗЌН+++Ќ5У vЗ*EЗе*CЗЌ!УЌУј*CЗКЕn& }2>З*EЗКЕn& }2AЗЌ:НЌ5У ђЗ*>З& Ф€Ќ5УЌУ №З*AЗ& Э€Ќ5Уе*AЗ& Ч€Ќ5УЌыТ|µ №З! еЌfrЅ…ЌН Ќ]У пЗ!H √тЗ!B }2=ЗЌН& }жo|µ И!B √И!H }2@З!=ЗеЌЊ~Ѕ…Ќ)НЌ“У& }жoЌУ 2И! …Ќ!Нn& …ЌНеЌНЌ!УјЌНьЌzУЏЂИЌНьЌzУ–ЌН√ЮИЌН+++Ќ5У yИ!NМ√|И!TМеЌЊ~Ѕ…ЌН+++Ќ5У ХИ!ZМ√ШИ!`МеЌЊ~Ѕ…ЌяУfИ ВИ   ЌН√пИЌНьЌzУЏ И! еЌfrЅ√“И!fМеЌЊ~Ѕ…ЌН Ќ]У жИ!М√йИ!lМеЌЊ~Ѕ…ЌяУ≤И ”И   …Outееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                             SYSMAN(DODVE)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

STATIC
BYTE	*ptr;

/*======================================================================*/
VOID                           /*					*/
dodve(dvc,dptr)                /* Set up pointers to device descriptors */
struct	dvcent	*dvc;	/* Array of device descriptors			*/
BYTE	*dptr;		/* Pointer to start of device strings area	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:-
25/01/90 Simplified a little further and speeded up by introducing a
         local variable and static procedure - ICFO
27/06/89 Simplified because there is now never more than 1 assignment
         by the time it gets to here - ICFO
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

LOCAL
WORD	n;	/* Processor counter					*/

STATIC
VOID	skip();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Fill in device descriptor from data in section			*/
dvc->dv_id = ptr = dptr;
skip();
dvc->dv_type = ptr;
n = 0;
while (n < 4) {
    skip();
    dvc->dv_prc[n++] = ptr;
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                      SYSMAN(DODVE / SKIP)
.pa
*/
/*======================================================================*/
STATIC VOID                             /*				*/
skip()                                  /* Skip characters to next NULL */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (*ptr++ != NULL) ;			/* Do nothing loop	*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
put file error DS	0 DAD	SP MOV	A,L JNZ	 JZ	 XCHG PUSH	H POP	D XTHL PCHL MOV	A,H
	ORA	L DW	0 INX	SP POP	B DCX	SP PUSH	B DAD	SP
	SPHL DAD	H DAD	D INX	H DCX	H STAX	D PUSH	D POP	H JMP	 MOV	L,A
	RLC
	SBB	A
	MOV	H,A MOV	L,M
	MVI	H,0 MOV	A,M MOV	A,M
	INX	H
	MOV	H,M
	MOV	L,A ORA	A JNC	 JC	 MOV	A,H
	XRI	128
	MOV	H,A internal compiler error 32768 LXI	H, llong. LHLD	 h. LXI	B, LDA	 c.sxt usage error LXI	D, CLIBRARY CPROF 	CSEG 	DSEG XTEXT  .ASM END FLOATLIB LONGLIB LGFLTLIB $END END	$INIT SHLD	 st4. MVI	M, slong. STA	 q. ## CALL	 EXTRN	 
	PUBLIC	 RET_ RET DB	0,' ',0,0,0,0,0,0
 *+5 $+5 long.0 flt.0 c.tst .switch DB	 .LONG	 DS	 DW	 ANI	 ORI	 XRI	 MOV	A, MOV	 MVI	 s. c.mult c.udv c.div o. x. a. c.usr c.asr c.asl c.neg c.not c.com e.0 e. n. L.com L.neg F.neg L.not F.not cf.eq eq.4 cf.ne neq.4 Bf.Hi swap4. + add - sub * mul / % mod < > | ^ xor & and Hu.Bl Hi.Bl Hu.Bf Hi.Bf Bl.Bf Bf.Bl б"ЕМб~#е’_ ! 9—√    ! √°М…!€€√°М…!ю€√°М…! "ЗМб’^#V#гел:ЗМЖ_w#:ИМОwgk—……! √÷М…!€€√÷М…!ю€√÷М…! "ЗМб’^#V#гел^:ЗМГw#V:ИМКwл—……б^#V#~#лO 		+F+N≈=¬ Нлй…ЌrМ√ћУ…ЌrМn& …ЌrМ√“У…ЌrМЌ“У#…ЌrМЌ“У##…ЌrМЌ“У+…ЌrМЌ“У++…ЌrМге! 9Ќ“У√“У…ЌrМеЌ“У#Ќ„У……ЌrМеЌ“У##Ќ„У……ЌrМеЌ“У+Ќ„У……ЌrМеЌ“У++Ќ„У……               ѓ√ЮН>ЌђПб—Ѕе!ЈПе!їНЈ ґН=##√ђН~#foй«НƒНyоАO…ЌФПxЈ»:МНЈ ђПР“бН/<лЌЬПлЌђПЅ—ю–хЌњПgсЌЖОі!ЙНтОЌfО“JО#4.ЌЬО√JОѓРG~Ы_#~ЪW#~ЩO№rОhcѓGyЈ¬7ОJTeox÷юа¬Оѓ2МН…)zWyПOт/Оx\EЈ JО!МНЖw“*О»x!МНЈь\ОF#~жА©O√ђПјјјА4…~Г_#~КW#~ЙO…!НН~/wѓoРG}Ы_}ЪW}ЩO… ÷ЏХОCZQ √ИО∆	oѓ-»yOzW{_xG√ШОб…ЌЬП Д  ЌђПЅ—ЌlП.€Ќ3П44+~2ФН+~2ХН+~2ЦНAлѓOW_2ЧНе≈}е!ЦНЦбo|е!ХНЮбgxе!ФНЮбG:ЧНё ?“П2ЧНсс7“Ѕбy<=ъKО{_zWyO)xG:ЧН2ЧНy≤≥¬№Ое!МН5б¬№ОxЈ WП}!МНЃАG®xтVП∆Аw ™ОЌњПw+…ЌlП/бЈб√*ОЌЈПxЈ»∆GЌ«Н!МН4…:МНЈ»:ЛНю/Яј<…Шy√ЖПИ  !МНOp #6А√О!ЛН~оАw…л*ЙНге*ЛНгел…ЌmТл"ЙН`i"ЛНл…!ЙН√mТ#…!ЛН~7w?##wy7OЃ… iQYЌ«Н!МН~GOW_Ј»еЌЈПЌњПЃgьР>ШРЌЖО|№\О №rОб…z£<ј…!МН~юШ:ЙН–~ЌаП6Ш{хyЌОс…xЈт.РЌOТ>€х≈ Ќ{ПЅЌЬПYP Ќ{П:МНЈ LР∆2МНЅ—Ќ«НсЈьФП√ЈПxЈ¬bРOW_…!  yоАъmРO$xю†“ФРюШЏ|Р÷G,еЌђПЌ‘П б-¬ПРAJS %ј√OТ€€€√ПР…! 9^#Vл~Ќ≠Р√ЈПю-х єРю+ єР+Ќ*ОGW_/OЌ=СЏСю. кРюe ÷РюE¬оРЌ=СЌMСЌ=СЏ1С¬оРѓУ_ ЅРе{РфСтэРхЌђОс<¬сР—сћФПл…»хЌ[Пс=…’WxЙG≈е’Ќ[Пс÷0Ќ&СбЅ—√ЅРЌЬПЌБПЅ—√«Н{ГЖ÷0_√№Р#~ю:–ю  =Сю0?<=…ю®»ю-»ю+»юІ»+……! 9~£_#~ҐW#~°O#~†Gб33г…ѓ∞±≤¬§С≥ †С{ю “§С! 9ѓ~ЈтФС7~w+¬ФС¬ЗСб—Ѕй! 9~Ј> т∞С=w+¬≤С√†Сѓ∞±≤¬вС≥ †С{ю “вС! 9ѓ~w#¬”С¬ћС√†С! 9ѓ√∞С…! ЌєТ! еЌТбхЌ Т¬Тс√Тс! “Т-—ЅЅ’-…! ЌєТ! √фС! 9~У_#~ЪW#~ЩO#~hgШGх|≠т<Тс?…с……ЌOТбглбг}ЙO|ИG…> У_> ЪW> ЩO> ШG…{/_z/Wy/Ox/G…^#V#N#F#…гЌmТгs#r#q#p…б≈√ОТб≈ ’е! 9л! 9Њ#¬™Т¬ЫТѓ√ђТ>б———г& ©o…! 9~s_#~rW#~qO#~pG…x±≤≥…! Ќ Тј-…л  …}ЌоТ]WOG…|ЌоТлOG…Ј>€ш<…л…л√ЌУ…Ѕ—≈}≥o|≤g…Ѕ—≈}Ђo|™g…Ѕ—≈}£o|Ґg…|µ»!  ,…Ѕ—≈|Ї}!  ¬3Уї¬3У,…ѓ…|µ У!  ѓ…Ѕ—≈|Ї}! јїј-…лzЉ¬_У{љ¬jУ!  ,…лzђъpУzЉ¬jУ{љ! Ў-…|І! ъnУµ…|оАg…л|Ї¬ИУ}ї! “РУ-…µ…лzЉ¬ЪУ{љ! Ў-…л|ш|g}o√°Улѓ√£Улш)√іУЅ—≈{ХozЬg…+|/g}/o…~oЯg…~#fo…лбгs#rл…лбN#F#x± шУ~#ї~#¬бУЇ¬бУ`iйDM!  zЈ>¬ФS\)л)л“Ф	=¬Ф…ѓх√%ФzђхђльƒУл|ЈфƒУMD!  x<¬9ФzБ>Џ>ФjS\>)л)л“FФ#е	б“NФ	=¬>ФлсрлЌƒУл√ƒУ…   * +%"ЇЦ%"ЄЦ%"ґЦ№€	"Ч	"Ч	"Чy€	6 "≥Х+6Д+щ^Ф’!тЪЌТУб ЯФ"¶Х!А ^6    ≈F+N+тђФ!* е!aФе! 9~#Ј Хю  ¬ФOю" џФю' џФ +—}|’е+#~Ј тФє¬еФ6 #г~#ю< 'Хю> 9Х!_Ф4б√¬Фб6€#6€*_Фе!aФеЌ*{Х|µ $ХеЌШ√  е!5ХеЌ(Ч"7Х√DХr   е!yХеЌ(Ч"{ХЅЅЏQХб—’√¬Ф^Х	Ќ  Ќ Can't open > or < file.$√Хw   …—Ѕ≈’*¶Хее—	ееЌТУ—¬ЩХ!ю9ЌАУ—Ѕ!€€јл"¶Х≈б…тЪ…*7ХеЌЧШЅ… rЅ:≤Х<*≥ХЊЎ»л
Ќ ѓ2≤Х
ЌсХ√ґХЌ Ј»Ќ ю   ю vХю¬рХ>
_*≥Х~+Њ–#4N 	s>
їћ …ЌvХ> !ЧЌЭЦЎ≈:µХє¬*ЦЌґХ2≤Х_ ~√/Ц€Ќ Ѕю¬DЦ¬@Ц
Ќ !
 …¬MЦю Цю VЦo& …!€€…Ѕ—’≈*{Х’еЌЩЅЅ…л> е! ЧЌЭЦ—Ў’л}ю
¬ЖЦ≈Ќ Ѕ>
_Ќ б…con:rdr:pun:lst: ÷ ЏѓЦютѓЦ_ ~OЈј7√VЦ…                                     €€€€€€€                                                         !"#    Ѕб—’е≈!МЦ ’ец Њ¬JЧ#¬7Ч—бi& … б—~Ј¬3Ч!ЏЦ~ю€ iЧ#¬[Ч√ДШЅ—’≈л~#Fлч€6 , 6 щ€pщ€w# 6 2≤ЧЧлЌљУе! 9Ќ“УЅ≈y=еЌ–Ъб ДШ’лЌoЪ> юw¬√Ч—’Ќ —Ќ —< ДШ!ўЦs 	ѓw#6в€	w+wт€	~#ґ¬Ш’е ≈Ќ~ХЅлбs#r{≤— ДШлѓ…Ѕ—’≈{ю Џ%Ш! ЧЌЭЦ#Ў ^{Јƒ !  …!ўЦ~< ДШ6€ЌЙШ!оЦ~юr vШ!хЦN!аЦ’Ќ“У}Ј uШлх*„Цyюb eШ>w#¬^Ш%се!А =тoШ)еЌ°ЩЅЅ—{=’Ќ–ЪЌ <бј!  7…!іЦN#F≈б"„Ц…ЌхШЈ Цю “Цѓє+¬«Ше’*„Це! еЌ—ЩЅЅ—’лЧ	s{≤—б VЦ’еЌ“У#Ќ„У+л*„ЦF!хЦ—>bЊ сШxю ЧШю VЦЈ ЧШh& …бЅ—’≈е{Ј»ю –ЌЙШ!Ч~!аЦN#Fє{ј p+pH#…ЌхШЈ¬,ЩЅб—’е≈√iЦю Џ:ЩЅ—бе’≈√lЦ+е! 9~ю
¬dЩе!хЦ~юb aЩ!^Щ5¬_Щ>б√dЩ6б>
*„Ц	wгее`i#Ќ„УбѓЊб¬ТЩЅ—’≈’%,е! еЌ°ЩЅЅЅ|µ!€€»ш! 9n& :^ЩЈ Щ…ѓ2WЪ>√ЎЩ е! 9Ќ“Улбе):WЪ§х|!¬ЦЖw“…Щ#4!–Цсwб…>€2WЪ>2™Щ:µХЈƒ”ХЌXЪ≈x± DЪ’е≈’лЌ —:™ЩOЌ ЅЈ¬Ъ!А€	DMбА —√жЩб—:™Щю¬DЪб*Ъ	Ќ !€€√JЪWrite error - Disk full
$—`iЌљУеА Ќ б√ЂЩ ! 9~=+еЌ–Ъб’V+^+F+Nбл… 	"∆Ъ> w+¬xЪѓw 	w##w 	wа€	л#~+ю:¬£Ъ~##Ќ»Ъ÷@~#Ј»ю. іЪЌ»Ъ√£Ъл*∆Ъ++Ј»Ќ»Ъw#√ЇЪ  жюaш÷ …O !Ч		~_#V≤је!$ еЌ~Хлббr+sbk#|µ……"∆Ъ> w+¬xЪѓwееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(DVCHAN)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

#define		OPEN	0
#define		CLOSE	1

/*======================================================================*/
struct dvcent                          /*				*/
*dvc_handle(op,ssect)                  /* Operate on device descriptors */
WORD	op;			/* Device descriptor operation code	*/
BYTE	*ssect;			/* Points to assignment file section	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:-
25/01/90 Third argument ('sdtype') removed because it wasn't used - ICFO
         'dodve' is VOID therefore we cannot test its return value - ICFO
27/06/89 Much simplified due to major rewrite to 'sechan' - ICFO
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

STATIC
struct	dvcent	*dvdesc = 0;	/* Point to base of device descriptors	*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

switch (op) {

    case OPEN:		/* Set up descriptor structures			*/

/* Allocate room for the device descriptors				*/
	if ((dvdesc = (struct dvcent *) spalloc(sizeof(struct dvcent))) ==
			   (BYTE *) FAIL)  return((struct dvcent *) FAIL);

/* Set up the pointers to the device descriptors			*/
	dodve(dvdesc,ssect);

	return(dvdesc);

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

    case CLOSE:		/* Release device descriptors from use		*/
	dvdesc = (struct dvcent *) spfree(dvdesc);
	return((struct dvcent *) SUCCESS);
}

}

/*======================================================================*/
ct dvcent))) ==
			   (BYTE *) FAIL)  return((struct dvcent *) FAIL);

/* Set up the pointers to the device descriptors			*/
	dodve(dvdesc,ssect);

	return(dvdesc);

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

    ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееPIP M:=B:$1.C[G20]
C80 $1
ERA $1.C
M80 =$1
ERA $1.MAC
XP B:[G20]=$1.REL
ERA $1.REL
FNDPR√  C     	О              
MEGGAЄ5 MAN   О              GTPRO√  C     ≤              
MEGGAЄ5 OUT   
Р              MARCONI AS    №              
MEGGA≥0 MAN   Т              PTSWCH  C     №              
MEGGA≥0 OUT   
Ф              BASIC   SUB   З              
EMMA2±0 OUT   
Ц              	BAPACLOGOV2   !∆«            LS1CST  C     ;ЋЌ            ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(GETFCE)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
WORD                   /*						*/
getfce(fcd,sdtype)     /* Return number of forced drive given ID string */
BYTE	*fcd;				/* ID string of forced drive	*/
WORD	sdtype;				/* 0 - SOURCE  1 - DEST		*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:-
29/01 90 Optimised a little and test for no drives defined removed.  It
         is such an unlikely condition and is under the control of
         the 'COLLECT' procedure for distribution that I don't feel
         the code is worth its memory allocation - ICFO
22/06/89 Listing brought up to latest standards - ICFO
03/10/88 Function now returns the Physical Drive Address not the entry
         number in the 'sethw' table - ICFO
         Code optimised - ICFO
16/05/88 Messages 64 and 65 changed to 0 and 1 - ICFO
12/10/87 External definition of 'hardware' removed
13/06/87 Created - DAR
*/

{

STATIC
BYTE	*drvdef[] = {
		&hardware[0],
		&hardware[1],
		&hardware[2],
		&hardware[3],
		&hardware[4],
		&hardware[5],
		&hardware[6],
		&hardware[7]
	};

LOCAL
WORD	fdrv;		/* Forced drive					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (*fcd != 0)  return((*fcd == '*')
		   ? -2
		   : ((fdrv = atoi(fcd)) < 0 || fdrv > 7) ? flerr(fdrv,40)
							  : fdrv);

/* Select a drive from those available					*/
return(hardware[bigmen(ctdrvs(),drvdef,
				     (sdtype == SOURCE) ? 0 : 1)].ddfadr);

}

/*======================================================================*/
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (*fcd != 0)  return((*fcd == '*')
		   ? -2
		   :ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееC $1
M80 =$1
ERA $1.MAC
XP B:[G20]=$1.REL
ERA $1.REL
SET  †  REL   o0123        SETHW   REL   8              ANMAN   REL   9              ANRUN   REL   *:;            ANRW    REL   <              ANTF    REL   =              C80     COM  А>?MNOPQRFASBL2  $$$                    SETBIO  REL   4              SETFIL  REL   H              SETFMT  REL   DJKL          SETFD   REL   156            ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееXSUBM
PIP
M:=B:C80.COM[G20]
M:=B:ANALYSE.H[G20]
M:=B:FASBL1.SUB[G20]

DEXSUB
X FASBL1 ANALYSE
X FASBL1 ANLIB
X FASBL1 ANMAN
X FASBL1 ANRUN
X FASBL1 ANRW
X FASBL1 ANTF
ERA FASBL1.SUB
ERA ANALYSE.H
XSUBM
PIP
M:=B:SETUP.H[G20]
M:=B:SETBIO.C[G20]
M:=B:SETFD.C[G20]
M:=B:SETFDP.C[G20]
M:=B:SETFIL.C[G20]
M:=B:SETFMT.C[G20]
M:=B:SETHOP.C[G20]
M:=B:SETLIB.C[G20]
M:=B:SETLST.C[G20]
M:=B:SETPAK.C[G20]
M:=B:SETSRCH.C[G20]
M:=B:SETTERM.C[G20]
M:=B:SETUB.C[G20]
M:=B:SETVF.C[G20]
M:=B:SET.C[G20]
M:=B:SETFORM.C[G20]
M:=B:SETUP.C[G20]
M:=B:FASBL2.SUB[G20]

DEXSUB
X FASBL2 SETBIO
X FASBL2 SETFD
X FASBL2 SETFDP
X FASBL2 SETFIL
X FASBL2 SETFMT
X FASBL2 SETHOP
X FASBL2 SETLIB
X FASBL2 SETLST
X FASBL2 SETPAK
X FASBL2 SETSRCH
X FASBL2 SETTERM
X FASBL2 SETUP
X FASBL2 SETVF
X FASBL2 SET
X FASBL2 SETFORM
X FASBL2 SETUP
ERA FASBL2.SUB
ERA SETUP.H
ERA SETBIO.C
ERA SETFD.C
ERA SETFDP.C
ERA SETFIL.C
ERA SETFMT.C
ERA SETHOP.C
ERA SETLIB.C
ERA SETLST.C
ERA SETPAK.C
ERA SETSRCH./*
.he                                                            SYSMAN(GETFNM)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

EXTERN
UWORD	*offsets;	/* Pointer to Operating System name pointers	*/

/*======================================================================*/
STATUS                                     /*				*/
getfnm(sdtype,osno,fmtnam)                 /* Return format in 'fmtnam' */
WORD	sdtype,				/* 0 - SOURCE  1 - DEST		*/
	osno;				/* Operating system code	*/
BYTE	*fmtnam;			/* Pointer to format name area	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
29/01/90 Optimised a little and 'offopen' and 'offclos' introduced 
         (code in OFFHAN.C) - ICFO
22/06/89 Listing brought up to latest standards - ICFO
16/05/88 Messages 62 and 63 changed to 55 and 56 - ICFO
08/06/87 Created - DAR
*/

{

LOCAL
struct	osn	*ptr,
		*osentry;

LOCAL
UWORD	stoff,
	totent,		/* Total number of entries / OS			*/
	n,		/* General counter				*/
	i;		/* Ditto					*/

LOCAL
BYTE	**menopt;	/* Pointer to menu option pointer array		*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Open the formats file and read details into memory			*/
/* Sets up 'offsets'							*/
offopen();

/* Calculate total OS entries for this section				*/
if ((totent = (offsets[osno] - (stoff = (osno > 0)
		 ? offsets[osno - 1] : 128)) / sizeof(struct osn)) <= 0) {

    offclos();
    return(nferr(39));			/* No formats for this op sys	*/
}

/* Reserve space for the names & offsets to come			*/
if ((osentry = (struct osn *) alloc(totent * sizeof(struct osn))) ==
						    (struct osn *) FAIL) {
    offclos();
    return(nferr(1));			/* No space			*/
}

/* Reserve space for menu option pointers				*/
if ((menopt = (BYTE **) alloc(totent * sizeof(BYTE *))) ==
							 (BYTE **) FAIL) {
    
    n = (WORD) nferr(1);		/* No space			*/
    CLEANUP;				/* 'menopt' = -1 so 'free' is OK*/
}

/* Seek to start of section						*/
if ((n = offseek((LONG) stoff)) == FAIL)  CLEANUP;
 
/* Set up the pointers to the formats					*/
ptr = offgetc(menopt[n = 0] = osentry[0].osname);
while (++n < totent)  ptr = offgetc(menopt[n] = ptr->osname);

/* Select title message and request format name from operator		*/
if ((n = bigmen(totent,menopt,(sdtype == SOURCE) ? 55 : 56)) != FAIL)
				      strncpy(fmtnam,osentry[n].osname,9);

cleanup:

/* Close AMIE.FRM							*/
offclos();

free(menopt);
free(osentry);

return((n == (WORD) FAIL) ? FAIL : SUCCESS);

}

/*======================================================================*/
ptr = offgetc(menopt[n] = ptr->osname);

/* Select title message and request format name from operator		*/
if ((n = bigmen(totent,menopt,(sdtype == SOURCE) ? 55 : 56)) != FAIL)
				      strncpy(fmtnam,osentry[n].osname,9);

cleanup:

/* Close AMIEееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(GETOFF)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

EXTERN
UWORD	*offsets;	/* Pointer to OS name pointers			*/

/*======================================================================*/
STATUS                            /*					*/
getoff(sframe)                    /* Get formats offset into format.dat */
struct	ssf	*sframe;	/* 'Setup' information structure	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:-
07/02/90 Simplified further - ICFO
29/01/90 Simplified and 'sdtype' introduced because we can now set
         up SOURCE and DEST separately (see SETOVR) - ICFO
         Uses code from OFFHAN.C - ICFO
22/06/89 Listing brought up to latest standards - ICFO
25/10/88 When 'format not found' all files are closed and buffers
         released - ICFO
         Optimised - ICFO
08/06/87 Created - DAR
*/

{C
ERA SETTERM.C
ERA SETUB.C
ERA SETVF.C
ERA SET.C
ERA SETFORM.C
ERA SETUP.C
ERA C80.COM
ERA FASBLD.SUB
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееpip m:=b:skipif.com[g16]
pip m:=b:makeset.sub[g20]
skipif same $4,DX3
x makeset svc 5ds 548 8 356
skipif unequal $4,DX3
x makeset w50 5ds 548 8 3100 35h6
era skipif.com
era faslnk.sub
SETFDP  REL   E              FASLNK  $$$                    SETFMT  C    pLbdeЙЛМФFASLNЋ  SUB   H              ANLIB   C     rЪЫЬЭ        ANRW    C     /Z            FASBLƒ  BAK   	B              ANRUN   C     ПРСТ        ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее

LOCAL
struct	osn	fdets;	/* Structure to hold format name & offset	*/

LOCAL
STATUS	rv;		/* Return value					*/

LOCAL
UWORD	stoff,		/* Start offset					*/
	totent;		/* Total number of entries / OS			*/

#ifdef	BUG
int i;
#endif
/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

rv = SUCCESS;				/* Optimistic start		*/

/* Open the formats file						*/
/* Sets up pointers to operating systems				*/
offopen();

#ifdef	BUG
putstr("\nOffsets are - ");
for (i = 0; i < 128; ++i) {
  puthex(*((BYTE *) offsets + i));
  putvid(' ');
}
putstr("\nStoff = ");
putnum((sframe->osnum > 0) ? offsets[sframe->osnum - 1] : 128);
putstr(" Offsets = ");
putnum(offsets[sframe->osnum]);
putstr(" Totent = ");
putnum((offsets[sframe->osnum] - (stoff =
    (sframe->osnum > 0) ? offsets[sframe->osnum - 1] : 128))
						    / sizeof(struct osn));
getkey();
#endif

/* Calculate total OS entries for this section				*/
/* Calculated from 'end offset' - 'start offset'			*/
/* Error if <= 0							*/
if ((totent = (offsets[sframe->osnum] - (stoff =
    (sframe->osnum > 0) ? offsets[sframe->osnum - 1] : 128))
					     / sizeof(struct osn)) <= 0) {
    rv = nferr(39);			/* No formats for this op sys	*/
    CLEANUP;
}

/* Seek to start of section						*/
if (offseek((LONG) stoff) == FAIL)  CLEANUP;
 
#ifdef	BUG
putstr("\nLooking for ");
putstr(sframe->fmtnm);
#endif

/* Read the first entry							*/
offgetc(&fdets);

#ifdef	BUG
putstr("\n      Found ");
putstr(fdets.osname);
#endif

/* Read in format names & offsets until match found			*/
while (strncmp(fdets.osname,sframe->fmtnm,8) != MATCH) {

/* If match not found return error					*/
    if (--totent == 0) {
	rv = flerr(sframe->fmtnm,16);		/* Format not found	*/
	CLEANUP;
    }

/* Read in next entry							*/
    offgetc(&fdets);

#ifdef	BUG
putstr("\n      Found ");
putstr(fdets.osname);
if (getkey() == ESC)  return(FAIL);
#endif

}

/* Place format offset into setup structure				*/
sframe->fmtoff = fdets.osoff;

cleanup:

/* Free the header details and close AMIE.FRM				*/
offclos();

return(rv);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                             SYSMAN(GETOS)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
WORD                                      /*				*/
getos(dvc)                                /* Enter OS number for driver */
struct	dvce	*dvc;				/* Device descriptor	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
25/01/90 Tidied up and fitted more into the Jackson model using
         'read ahead' - ICFO
         Type of function changed to WORD - ICFO
22/06/89 Listing brought up to latest standards - ICFO
08/06/87 Created - DAR
*/

{

LOCAL
BYTE	*dvrnam,	/* Pointer to I/O driver name			*/
	tstnam[12];	/* Holds driver name from file			*/

LOCAL
WORD	osvar;		/* Holds OS number from file			*/

LOCAL
FILE	ffd;		/* OS list file descriptor			*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Point to I/O driver name						*/
dvrnam = &dvc->proc[2][0];

/* Open AMIE.011 - the list of operating system types			*/
mknam(11);
if ((ffd = spopen(exov,"RC")) == OPENFAIL)  return((WORD) flerr(exov,3));

if (getstr(ffd,tstnam,9) == FAIL) {
    osvar = (WORD) FAIL;
    CLEANUP;
}
osvar = 0;
while (strncmp(tstnam,dvrnam,9) != MATCH) {
    if (getstr(ffd,tstnam,9) == FAIL) {
	osvar = (WORD) FAIL;
	CLEANUP;
    }
    ++osvar;
}

cleanup:

spclose(ffd);

return(osvar);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее;  Generation of SETUP,SET,SETFORM,ANALYSE
;  *** Edit sethw ***
;  Last modified 17/10/88 PN - 09/11/89 ICFO
;*****************************************************
; Generating system files for $1
; Drives $2
;        $3
;        $4
;        $5
;        $6
;        $7
;        $8
;*****************************************************
;
;
; terminal options are SVC or W50 (ie not SVC) NOT WYSE50
;
; drive options are 5DS 548 8 3100 32002 32006 352 356 35H2 35H6
;
xsubm
pip
m:=b:ANALYSE.REL[g20
m:=b:ANLIB.REL[g20
m:=b:ANMAN.REL[g20
m:=b:ANRUN.REL[g20
m:=b:ANRW.REL[g20
m:=b:ANTF.REL[g20
m:=b:C80.COM[g20
m:=b:SET.REL[g20
m:=b:SETBIO.REL[g20
m:=b:SETFD.REL[g20
m:=b:SETFDP.REL[g20
m:=b:SETFIL.REL[g20
m:=b:SETFMT.REL[g20
m:=b:SETFORM.REL[g20
m:=b:SETHOP.REL[g20
m:=b:SETHW.C[g20
m:=b:SETLIB.REL[g20
m:=b:SETLST.REL[g20
m:=b:SETPAK.REL[g20
m:=b:SETSRCH.REL[g20
m:=b:SETTERM.REL[g20
m:=b:SETUB.REL[g20
m:=b:SETUP.REL[g20
m:=b:SETVF.REL[g20
m:=b:SLRNK.COM[g20
m:=b:SKIPIF.COM[g16

dexsub
c80 -qD$2 -qD$3 -qD$4 -qD$5 -qD$6 -qD$7 -qD$8 sethw
era sethw.c
m80 =sethw
era sethw.mac
xp b:[g16]=sethw.rel
;
xsubm
slrnk setup,setup/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
slrnk set,set/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
slrnk setform,setform/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
slrnk analyse,analyse/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
pip
d:=setup.com
d:=set.com
d:=analyse.com
d:format.com=setform.com

dexsub
era setform.com
era setup.com
era set.com
era analyse.com
era set*.rel
era an*.rel
era slrnk.com
era c80.com
era makeset.sub

;
xsubm
slrnk setup,setup/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
slrnk set,set/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
slrnk setform,setform/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
slrnk analyse,analyse/n/e
$1lib/s,
tlib/s,
/e

dexsub
xsubm
pip
d:=setup.com
d:=set.com
d:=analyse.com
d:format.com=setform.com

dexsub
era setform.com
era setup.com
erееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(GETSWT)
.pa
*/
#include	"portab.h"

#define		MAXSWT	3	/* Allow for up to 3 switches		*/
#define		NALARMS	3	/* Error, End-of-File and End-of-Run	*/

EXTERN
WORD	autorun,	/* Set non-zero if AutoRun			*/
	alarm[];	/* Controls 'beeps'				*/

/*======================================================================*/
STATUS                                       /* FAIL if error in file	*/
getswt(sfile)                                /* Set up the Run Switches */
BYTE	*sfile;			/* Pointer to "AMIE.009" or "AMIE.AS"	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	System Manager
Revision History:
03/01/91 Correction to search for Global Switches - ICFO
25/10/88 Method of finding the 'AR' and 'AL' switches rewritten for
         speed - ICFO
20/10/88 Switch values for AutoRun changed 'toupper' - ICFO
11/05/88 'alarm' is now a one dimensional array - ICFO
09/05/88 Code for ALarm added - ICFO
         Maximum number of switches reduced from 20 to 3 to save
         space - ICFO
02/02/88 Started - ICFO
*/

{

LOCAL
FILE	fd;		/* File descriptor for input file		*/

LOCAL
WORD	i,		/* Loop counter used in setting up 'alarm'	*/
	index,		/* Index of switch in question			*/
	nswtch,		/* Actual number of switches present		*/
	count;		/* Number of lines beginning '#' to find	*/

LOCAL
STATUS	rv;		/* Return value					*/

LOCAL
BYTE	c,		/* Character from the file			*/
	*ptr,		/* Working pointer to the ALarm switch value	*/
	*swtch[80],	/* The switches					*/
	*namep[MAXSWT],	/* Pointers to the switch names			*/
	*valuep[MAXSWT];/* Pointers to the switch values		*/

STATIC
BYTE	s[] = { 0x0a, '#', NULL };

LONG	filesize();	/* Returns the size of the file in bytes	*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

autorun = alarm[0] = alarm[1] = alarm[2] = 0;

/* Open the relevant assignment file and seek to 256 bytes from the end	*/
if ((fd = spopen(sfile,"RC")) == OPENFAIL)  return(FAIL);
rv = SUCCESS;
if (filesize(fd) > 256L)  spseek(fd,-256L,2);

/* Find the '[' at the beginning of a line following a '#' at the	*/
/* beginning of the line						*/
while (TRUE) {
    count = 0;
    while (TRUE) {
	if ((c = spgetc(fd)) == *(s + count)) {
	    if (++count == strlen(s))  break;
	}
	else if (c == -1 || c == 0x1a)  CLEANUP;
	else count = 0;
    }
    if (rd2lf(fd) == (WORD) FAIL)  CLEANUP;
    if ((c = spgetc(fd)) == -1 || c == 0x1a)  CLEANUP;
    if (c == '[')  break;
}

/* Read in the switches							*/
if (getstr(fd,swtch,80) == FAIL)  CLEANUP;

/* Parse the switches and find the "AR" switch if any			*/
/* NB Don't try to amalgamate this computation of 'nswtch' with its use	*/
/* in the next line because if it is ever used with a compiler which 	*/
/* handles its arguments from right to left (as it is at liberty to do	*/
/* according to K & R) this will involve 'namep' being used befoееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                                       SET
.pa
*/
#include	"portab.h"

#asm
	.request sethw,setlib,setterm
#endasm

/* The flag SET is a conditional compilation switch within the modules	*/
/* SETFIL.C and SETBIO.C						*/
#define		SET	0	/* Define SET to flag we doing it	*/
#define		HEADER		/* Stop SETUP.H includes within include	*/
				/* files				*/

EXTERN
BYTE	hardware[],		/* Table in SETHW			*/
	Cmode;

EXTERN
WORD	state [][4];

BYTE	savef,			/* Set to 'Y' for automatic save	*/
	*ex_com,		/* Command for any exec() call		*/
	*ex_arg;		/* Pointer for arg to exec()		*/

#undef		EXTERN
#include 	"setup.h"		/* Global variables			*/
#define		EXTERN	extern

#include "SETPAK.C" 		/* Get SETPAK..				*/
#include "SETFIL.C"		/* ..and SETFIL				*/
#include "SETLST.C"		/* ..and SETLST				*/
#include "SETBIO.C"		/* ..and SETBIO				*/
#include "SETFDP.C" 		/* ..and SETFDP				*/
#include "SETUB.C"		/* ..and SETUB				*/

/*======================================================================*/
main(argc,argv)
WORD	argc;
BYTE	*argv[];
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SET
Version		03.45x
For AMIE	05.14
Revision History:
04/10/89 Version 03.45x
         Brought up to Timeclaim standards
04/02/86 Version 03.40
         Modifications added for command line arguments.  SET will now
         save a copy of the BIOS if the format list is terminated with
         a 'Y'.
         Formats may be entered on the command line using '-f' switch.
         SET will chain to another program if the '-e' switch is used.
         Version 03.00	First official release for MFB II
*/

{

/* Version  number matches that of SETUP due to common code.		*/

/* This module in conjunction with SETUP.C and SETBIO.C	offers a	*/
/* "Batch" mode of operation for setting up formats.  It will read in	*/
/* data from a specified file and setup the BIOS to suit.		*/

LOCAL
WORD	arg;

STATIC
VOID	badarg(),
	cmdlin();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (argc < 2 )  badarg("");

cmdlin(argc,argv);			/* Extract parameters		*/

if (abort(0))  byebye();

clrs();			/* Clear screen					*/
initvar();		/* Set up pointers to BIOS			*/
head();			/* Put up a heading				*/

move(10,17);
putstr("Copyright (c) dci software 1984, 1985 and Timeclaim 1989");

wait(2);		/* Small delay					*/

bufsiz = 32512;
			/* Reserve memory for the data file		*/
while ((data = alloc(bufsiz)) == -1)  bufsiz -= 512;
if (data == -1)	{
    putstr("Insufficient memory available\n");
    return;
}
dir = data;		/* Directory buffer				*/
data += DIRSIZE;	/* Reserve space for it	all			*/
bufsiz -= DIRSIZE;
open();			/* Open the data file and load the directory	*/
setbios();		/* Set up the bios 				*/
move(0,0);
clreol();
clreos(3,0);
byebye(0);

if (ex_com != 0) {
    exec(ex_com,ex_arg);
    putstr("\nCannot execute <");
    putstr(ex_com);
    putstr(" ");
    putstr(ex_arg);
    putstr(">\n");
}

exit();

}

/*======================================================================*/
/*
.he                                                               SET(CMDLIN)
.pa
*/
/*======================================================================*/
STATIC VOID
cmdlin(argc, argv)
WORD	argc;
BYTE	*argv[];
/*======================================================================*/

{

/* Parse out any options from the command line				*/
/* Sets the following globals:						*/
/*	reqdrv - in response to <drive>					*/
/*	autofl - in response to -a  (no manual input)			*/
/*	ex_com - in response to -e<command args>			*/

LOCAL
WORD	n,
	file;

LOCAL
BYTE	*p,
	**q;

STATIC
VOID	optcfg(),
	optfmt();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n = argc - 1;
q = argv + 1;
file = 0;
if (n != 0) {				/* If any arguments		*/
    if (**q != '-') {			/* Get any filename		*/
	re it	*/
/* is set up.								*/
if ((nswtch = setswt(MAXSWT,swtch,namep,valuep)) == FAIL) {
    rv = FAIL;
    CLEANUP;
}
if ((index = fndswt(nswtch,namep,"AR")) != FAIL)
		    autorun = (toupper(valuep[index][0]) == 'D') ? 1
			    : (toupper(valuep[index][0]) == 'U') ? -1 : 0;

/* Set up the "AL" switch						*/
if ((index = fndswt(nswtch,namep,"AL")) != FAIL) {
    ptr = *(valuep + index);
    for (i = 0; i < NALARMS; ++i) {
	alarm[i] = atoi(ptr);
	while (isdigit(*ptr) == TRUE || *ptr == '-' || *ptr == '+') ++ptr;
	if (*ptr++ == NULL)  break;
    }
}

cleanup:

spclose(fd);

return(rv);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(GOCRT9)
.pa
*/
#include	"amie.h"

#define		S_QUOTE	0x27	/* Single quote				*/

STATIC
FILE	fd;		/* File descriptor				*/

STATIC
WORD	n_bytes;	/* Count of number of bytes in the file		*/
			/* Limited to 32767 - should be more than enough*/

EXTERN
WORD	alarm[];	/* Set as described in AMIE.C			*/

/*======================================================================*/
BOOLEAN                      /*						*/
gocrt9()                     /* Create AMIE.009 reentry assignment file */
/*======================================================================*/
/*USE
Portability	Level 2
Parent Module	System Manager
Revision History:
03/01/91 'n_bytes' introduced to enable the remainder of the 128
         byte block to be zeroed - ICFO
29/01/90 Optimised and two static functions added - ICFO
22/06/89 Listing brought up to latest standards - ICFO
11/05/88 'alarm' is now a one dimensional array - ICFO
*/

{

/* AMIE.009 contains a special initialisation file containing the 	*/
/* current I/O device configuration. When AMIE is rechained this file	*/
/* will be looked for and used if present. This utility allows the exit	*/
/* from and reentry to AMIE with no change in current settings		*/ 

LOCAL
WORD	n,		/* Loop counters				*/
	i,
	td;		/* Text descriptor				*/

LOCAL
BYTE	s[7],		/* For 'itoa' to store a number			*/
	*swpoint[8];	/* Array of pointers to pointers to switches	*/

STATIC
VOID	puts(),
	putc();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Read in the current switches						*/
if ((td = opn_txt("AMIE.SWT",swpoint,8)) == FAIL)
					      return(flerr("AMIE.SWT",3));

/* Create name AMIE.009 in global name area				*/
mknam(9);

/* Open text file using level 2 open functions				*/
if ((fd = spopen(exov,"WC")) == FAIL)  return(flerr(exov,2));

/* Clear number of bytes in the file					*/
n_bytes = 0;

/* Write pound sign header						*/
puts("#\r\n");	

/* Write current I/O device descriptions to a standard init file format	*/
for (n = SOURCE; n <= DEST; ++n) {
    putc(S_QUOTE);				/* Single quote		*/

/* Write device name							*/
    puts(device[n].dv_name);
    putc(S_QUOTE);				/* Another quote	*/

/* TAB									*/
    putc(TAB);

/* Write medium ID byte							*/
    putc(device[n].medium);

/* Write device driver names or '-' if they do not exist		*/
    for (i = 0; i < 4; i++) {
	putc(TAB);
	puts(&device[n].proc[i][0]);

/* If switches present then add them in square brackets			*/
	if (*(swpoint[n * 4 + i]) != 0) {
	    putc('[');
	    puts(swpoint[n * 4 + i]);
	    putc(']');
	}
    }

    puts("\r\n#\r\n");
}

/* Output the 'ALarm' switch if necessary				*/
/* Note that AMIE never outputs the 'AutoRun' switch to AMIE.009 or an	*/
/* infinite loop could occur.  It is up to the calling program (which	*/
/* as in the case of TCDP could be AMIE itself) to write an AMIE.009	*/
/* with the 'AutoRun' switch set and then reboot to call AMIE.		*/
if (alarm[0] != 0 || alarm[1] != 0 || alarm[2] != 0) {
    puts("[AL:");
    itoa(alarm[0],s);
    puts(s);
    for (i = 1; i < 3; ++i) {
	putc(',');
	itoa(alarm[i],s);
	puts(s);
    }
    puts("]\r\n");
}

/* CP/M EOF char for good measure					*/
putc(TXTEOF);

while (n_bytes % 128 != 0)  putc(NULL);

spclose(fd);

/* Free off the switches						*/
cls_txt(td);

return(SUCCESS);

}

/*======================================================================*/
/*
.he                                                     SYSMAN(GOCRT9 / PUTS)
.pa
*/
/*======================================================================*/
STATIC VOID                  /*						*/
puts(s)                      /* Put a string to the file opened on 'fd' */
BYTE	*s;					/* String to be output	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n_byteoptcfg(*q++);			/* Deal with the file option	*/
	--n;
	file = 1;			/* Flag as taken		*/
    }
    while(n-- != 0) {			/* Search the rest  		*/
	p = *q++;			/* Point at arg	    		*/
	if (*p != '-')  badarg(p);
	switch(*++p & 0x5F) {

	    case 'F':
		if (file != 0) {
		    putstr("Cannot specify .CFG file and format list!\n");
		    exit();
		}
		optfmt(++p);		/* Command line format list	*/
		break;

	    case 'E':
		ex_com = ++p;		/* Pickup the command		*/
		if (n != 0) {
		    ex_arg = *q++;
		    --n;
		}
		else  ex_arg = "";
		break;

	    default:
		badarg( --p );
		break;
	}
    }
}
else badarg("");			/* Must be something!		*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                               SET(BADARG)
.pa
*/
/*======================================================================*/
STATIC VOID           /*						*/
badarg(arg)           /* Bad argument - display a message and then exit */
BYTE	*arg;
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (*arg != NULL) {
    putstr("\nUnrecognised argument: ");
    putstr(arg);
}
putstr("\nCorrect Usage is:");
putstr("\n\tSET <filename> [-e<command> <tail>]");
putstr("\n\tSET -fformat/format/etc  [-e<command> <tail>]\n");
exit();

}

/*======================================================================*/
/*
.he                                                               SET(OPTCFG)
.pa
*/
/*======================================================================*/
STATIC VOID              /*						*/
optcfg(name)             /* Parse out a file name from the command line */
BYTE	*name;
/*======================================================================*/

{

/* This parses out a file name from the command line, and loads the	*/
/* file into memory ready for SETUP to read the data.			*/

STATIC
VOID	chksav();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = name;			/* Parse out the file name		*/
q = buffer;
*q++ = 'A';			/* Set file file spec to A		*/
*q++ = ':';
if (*(p + 1) == ':')  p += 2;
while ((*q++ = *p++) != NULL)  continue;
q = buffer;			/* Scan for '.' or name end		*/
while(*q != NULL && *q != '.')  ++q;
strcpy(q,".CFG");		/* Add the correct extension		*/
channel = fopen(buffer,"rb");	/* Open the CFG file 			*/
if (channel == 0) {
    putstr("Cannot open the file : ");
    putstr(buffer);
    exit();
}
bp = alloc(256);		/* Allocate some buffer space		*/
*bp = 0x1A;			/* Mark EOF 				*/
i = read(channel,bp,256);	/* Load in the data			*/
fclose(channel);
*(bp + 255) = 0x1A;		/* ensure EOF marker			*/
p = q = bp;
for (j = 0; j < i + 1; ++j) {	/* Now scan the data			*/

    switch (*p) {

	case 0xD:
	    *q++ = '\n';

	case 0xA:
	    ++p;
	    break;

	case ';':
	    while(*p > ' ')  ++p;

	case 0x1A:
	    break;

	default:
	    *q++ = *p++;
    }

    if (*p == 0x1A)  break;
}
*q = 0;				/* Mark the end of TBUF			*/

chksav(bp);			/* Check for automatic save		*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                               SET(OPTFMT)
.pa
*/
/*======================================================================*/
STATIC VOID              /*						*/
optfmt(s)                /* Reformat the data for the extraction routine */
char *s;
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = bp = s;			/* Set the pointers			*/
--p;
while(*++p) {			/* Now scan the data			*/
    if (*p == '/')  *p = '\n';
}

chksav(s);			/* Check for auto save			*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                               SET(CHKSAV)
.pa
*/
/*======================================================================*/
STATIC VOID                                    /*			*/
chksav(s)                                      /* Check for save option */
BYTE	*s;
/*======================================================================*/

{

/* Check for save option. If it exists set the global flag and strip	*/
/* the 'Y' from the end of the format list.				*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while(*s != 0)  ++s;			/* Scan to end of buffer	*/

--s;
if (*s == '\n')	--s;			/* Allow for a trailing \n	*/

if ((*(s - 1) == '\n') && ((*s & 0x5F) == 'Y')) {
    *s = 0;
    savef = 'Y';
}
else  savef = 'N';

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                        s += strlen(s);

sfputs(fd,s);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                     SYSMAN(GOCRT9 / PUTC)
.pa
*/
/*======================================================================*/
STATIC VOID               /*						*/
putc(c)                   /* Put a character to the file opened on 'fd' */
BYTE	c;				/* Character to be output	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

++n_bytes;

spputc(c,fd);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
        /* Put a character to the file opened on 'fd' */
BYTE	c;				/* Character to be output	*/
/*===========================ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(GSFAIL)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
BYTE                            /*					*/
*gsfail(asfd,sect)              /* Action failure in 'getsect' function */
FILE	asfd;		/* File descriptor >0 if file open		*/
BYTE	*sect;		/* Pointer to allocated area (> 0 if allocated)	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (asfd > 0)  spclose(asfd);
/* I note that if 'sect > 0' it could not possibly be == -1 (could it?)	*/
if (sect > 0 && sect != -1)  spfree(sect);

return((BYTE *) FAIL);		/* All error functions return FAIL	*/

}

/*========================                                     SET(GETFCODE)
.pa
*/
/*======================================================================*/
VOID                             /*					*/
getfcode()                       /* Get the format code from the buffer */
/*======================================================================*/

{

/* This gets the format code from the buffer TBUF that was set up at	*/
/* the start of the program. It uses the global pointer BP.		*/

LOCAL
BYTE	*p;

STATIC
VOID	fmtname();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = buffer;
if (*bp == NULL)  abort(1);		/* Entries are complete		*/
if (*bp == '\n')  strcpy(p,fmtid);	/* If default entry copy default*/
else {
    while (*bp != NULL&& *bp != '\n')  *p++ = *bp++;
    *p = 0;
}
if (*bp != 0)  ++bp;			/* Skip any EOL delimiter	*/
fmtname();
if (getfmt() != 0)  return;
move(3,0);
putstr(fmtid);
putstr(" - Format code is undefined");
unlock();
exit();

}

/*======================================================================*/
/*
.he                                                              SET(FMTNAME)
.pa
*/
/*======================================================================*/
STATIC VOID                       /*					*/
fmtname()                      /* Extract next format/drive combination */
/*======================================================================*/

{

/* Extract the next format/drive combination from the buffer		*/

LOCAL
BYTE	*p;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

defdrv = -1;			/* Flag no specific drive		*/
p = buffer;			/* Scan buffer for name			*/
while(*p = upper(*p))  ++p;
p = buffer;			/* Look for drive address option	*/
while (*p != NULL)  if (*p++ == '[')  break;
if (*p != NULL)	{
    if (numeric(*p))  defdrv = *p & 7;	/* Mask out address		*/
    *--p = '\0';		/* Set NULL				*/
}

movstr(fmtid,buffer,9);		/* Copy name over			*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееД‘—U ШBSAVEFБСV–””`dUЕф$xI%YFMTIDБСУUTаdd’DE%h%9YIRSCHANGБТSХФ“Q TФдDUИ9M%RCLOCKБСУU`dd’EE$ЄMARBPSА‘‘ Dt@ GAP3БСУUЦU U4ФDThM%iSYSTYPБРУ–“‘аdDХ$T5HIMQI.FRSTSEБT“—UаD≈5HMA1a6SP_INIБU“—Uаd$фхE5®MASPFATБSQQP`TдdE8Q%SECTRAАT`$%	UJDEFLTБS DDD%JJБРХQФ“V†d4ДддXE1=R_BASEБТQ“TаdфФдEИAM9VBDRVА—†dEED(]MADOUBLEБСQСХ†dеT’tФи1%5%RSYSTRKБУ—СФ—U 4‘d(	%=NNDRIVEБСХХP†dE$$8QI9M
FDTEXTБQТTФ’ $’8Q2TTLБФ—P–ХQ†eTе4Є9=Q5
BYEBYEБТSТUР`DДTH=A:SORTБФ‘Р“`d‘D4ГИQ9RRDENTБР””TT†dФе4U%HI5=YQLISTБРQЧ‘S $DиMQRSETBIOБС—UР”аddдDE%h]IQ	%>GETFMTБPRS•`УSтuMQ!^SETLIBЗ‘—UTУeј                                                                                                                                                                                                               %я`2гр0                                                                                                                                                                      ЦА  @@0  ј Kіјј                                                                                                                                                 	hА З 9D;L Ќ  ,÷фfА ± Ќ  јлШoc÷f“0 ъж@ѕЛVUN c И c÷фf”p0 ъжЫƒYT uљ@ўµH L >єРув’Х] %РїАIј3 oP6ma  ЃcБљЗn@$0 ЛА0оИ ДД cP— Х@,j √Ї † EН@wD BS ±®иА0оИ4  ±  Т  ,Ў Аi    Зk@[‘Ы_АјлШofА Ђ“ !,Аw∞ BN ±» лzБ≥n® Ш }sмџЉ  †а" ЗBАD%0 ЛАЈ®6щА	А„0ёЌњА™J! t†B ≤8 лzБ≥hИШ }s MмЏ4 ®`"@ЗQАD$ј ЛАЈ∞6ЧАЙА,Ж :ёаlЏЪ@ †  Л"А
Ј–Ш "«а≠ш& ≤ л|≥jјШ "ћ`≠тЌЃа",Њ :Ѕ Мџ& ≤H лВ3lXШ "…`ђЌ≤ј"` Л&А
∞  Л(А∞0#6–АЙА,¶ :јаМџd& ≤и л≥mиЛ+А
ЈшЛ,А
∞ Ш "Ћ`ђЌє ",¬ :Ѕ`МџЊ& ≤x Ђ≥H л3o@Ш }sмЏp °†B»ЗD Д$а Л2А∞`#6ьАЙА„0АёЌ†@L™V!,АtЄBN ±Є л	3hЄЛ5А∞Ш#6ЪБ≥h л
3iрЛ7А∞®#6£Б≥И л3jАЛ9А
∞p Л3Аs®ФCЕЅҐа Ќ  ,$B єD7du Ќ  ,mИd≥@  еА Vh  Ѕ`И@@Ћ4  >-YV®	Ъ  0нX%У.U  %µАRЏј р fБ@ з(щон<їOg Ж“БВ† "==============================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(IDSFIL)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
BYTE                              /*					*/
*idsfile(iniseq)	          /* Get name of assignment file to use */
BOOLEAN	iniseq;		/* Are we in initialisation sequence Y/N	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:
13/12/89 Error message if neither AMIE.009 or AMIE.as are present - ICFO
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

STATIC
BYTE	*reent = "AMIE.009",	/* Amie reentry assignment file		*/
	*normas = "AMIE.AS";	/* Amie normal  assignment file		*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (iniseq == TRUE) {			/* Initialisation required	*/

/* Do we take from AMIE.009 or AMIE.AS					*/
    if (fexist(reent) == TRUE)  return(reent);		/* Use if there	*/
}

if (fexist(normas) == FALSE)  return((BYTE *) flerr(normas,2));
else			      return(normas);

}

/*======================================================================*/
ent file		*/
	*normas = "AMIE.AS";	/* Amie normal  assignment file		*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (iniseq == TRUE) {			/* Initialisation required	*/

/* Do we take from AMIE.009 or AMIE.AS					*/ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее YЈx	ЏCЎАb† "7 O√-§√їаNЩnшЂbєD7мu Ќ  ,иЋaБОґ6ђБђ*ЌЃаLџ*ЎАa( 2" †Вђ™"Ўјb≠МЌ  ZфU±Аƒb-М* †В1Л*В3lиЛdК≤® МF" †МЏT"÷`bђ™#И≤®#6ЬИґPЂ*Вƒb,™Ќ®јb-Ш* †В1Л*В3j†ЛZБК≤® МF" †МЏƒ"ўјb  EЃј≈[ Eђ@[ЫE@ƒYUС ≈b,И#>-YVШUђ@ґL >єБжцh  Ќ§ LЂА*„`b1їk И@ kКЦаКµиФUЃјў†  EфfА +Ї*„†b±љa№ 1Vƒd@1VD %0 dEС ≈YEХAYTЫ\ ƒZьЫiјўT,Uѓј≈lџюЌ° М™>!њгЃVh  ЅА -~!  £  У.W      ZN!  ђ– ВЌ    ХЫK"R<"Ћ`В  *Ћ`ОVmА`∞D54y Ќ  "¶<еf’ FлaБ≥o†сj Ѓ Ґ≠v"Ћ В  EС ≈Zф *„`lџРлd@6h   ≠јђ;**»Аb1Da„@A еd@0И< ЌЂј.VmФ`∞D" ХЪ  0EYd"A \ђџZЅ÷°з+6≠0E[ЫfјЁbђ≤Ќ∞`М™»
*Ћ ВСH§RлlА0»Л-В
≤Ў D ≥n@#6Ж2ѓ∞#4  eР@ИH Ќі О±VќєYЈВЌ  †  Д rК≤ D fя–G+6“0X"@ ЌЈ МV[fё∞A0 ъжЫ¬4  2Ќ•јЃVh  Ѕ÷бз+6Г∞EYd" 3h–+ђU≥А√!H 2еf‘pV6ЖВК≤» МEЦAv,З]ЅYµ№	Ыb Д 0ХЪ  0Y2е–@      %∞ Ґд<еЎз+4  `∞DY(UТАѕЛVU4d†7(Ђ!єD( ХЪ  0X,VBe–AV]ИƒYtV+fяР1Ne–Fmїe 1VN† ЏҐ
"ЋаВђАлeр@»Л К≤@ФUЧЅµрEТ ≈Y( *»@a  2еeрG+6“В∞X,V@e 1V_uИ@Аh  "ЋаВђАлeр@»Л К≤@ФUЧЅЈ†EТ ўіDЗQД АФC`«ЬђЏТЅ`≥l@&ZК*»@`   ! е/Д Ц+6їГђ 0UФ Ё§'Ѕƒ!  .•У-q`і\.VЂ/Д uї F=Щ" У.c    	l@0Ђ!ДA  »Л1В@ ef0Fm;>-YV№UШЅ А dEШЅYФF"ћ†М;0*  n±VefА ЂФ*ћ†В,†*ћ†МЩs8  -ќd†7(Д ≥n +ђUУА√.Vh  Ѕ`К≤PФCіј№Ґ  ЌњјђEЩЅYЬ"АЖOЛVUЏБз+6Л0Yі@У.i      Z"*»@a@ 2"Ќ Вђ§"Ќ`Вђ÷6 ∆ј "Ќ†Вђ†лf–Fh   ≥ам:¶*Ќ†В1mfР@И  fРF/fРFmЬ>-YVpUЪAҐђ÷ЌЇаќVm®`∞ElџH ∞авђ÷#И≥X#ФUЪA† ќК≥X МF"Ќ`Г` Мl f–G+6МД0e≥Ам:~*Ќ`Г` Мl dЋЫЅ       Ц‘И@АЋ6≥КƒYЉB YґіV"ќ В@ EЬЅYћшµeQPЖўg0AXЛ9В0о 8Ђ7ВƒYЉЫUЅ№Ґђв#gFmбfА ™$*ЌаМџЎеgFmшh≥nx#*З@ А ЦѕА Щs®         іd B YґаR)Ї≈Y2"ќаВђ§"ѕ Вђт#И≥»#6Пђ™Љ*ѕ МЏtеgpG+6‘∞X"ґmpeU∞Ж^a”БVyf‘PБ{gРAМEЮAbґmb>-YUь!ЗY¬uЬ"Zю*ѕ ОQVyКўµ»!Ы`Б№ҐђцЌљамЂF*ѕ В±XЛ<В0лш@Ђ<В
≈b,теgpFmМdЋЯA       ЦўД@@Ћ6ƒД
E"ЧXЂ!ЖDYфUФАƒYьUЯЅb1fџАГв’Х|BYьЫuҐђъЌ  WЄ!З|Bw, UЯЅЈ| шµeS СVИƒYьV+hAVБИƒZV+rК≥ш МF"ѕаВ±[6ъД3mАAсj •б,:√°!,:t!Ј√ќVm
`≤e–`А          ім$B 9D  ХЪ  0X"( !єгќVm=`∞D  ЛEВіH ЂEВђ™ь*…Аb-* @b-
*–†В1ЛBВ
іX ђEҐЅg≈Ђ*ќДКі(#6ПДЯђЂ4*–†В1ЛBВ0л–HД hpF≥	hp@И( hpF£	hpA0 ъж?Ы¬$р6яГ2ѓhHЂCВV  »ЛCВ3@ ЛfёаFд	hp@Ль,ЌЄ,џђ љ°,:К-н	hPFmЛ	h∞FmSe_рЦE
hPAМE°Abґmс	h0AVГВ СГh0Fm€h∞AVГ Z *–`Б√ь2еf’ЦU†ЅҐ≠—>ДШvШ$UҐЅuЬ*ZЦ! Ађ– ВЌ  uм(UҐЅђџpЅa„∞¶{
fџ†
Ц T∞†h©Е"@  ђЕ0крHЂCВ:ƒ А6Ф 9EZL >єПжч+6Ґ∞X"≠
Ќ°ALџо µABђШЌ≥бLџ  ґБB Т! А2и–@ [p! ,џ8еfА 0 E£At∞,UУ ¬(шdEУ Ўu,UУ ¬(  dEУ Ўu,UУ ¬/шdEУ Ўu,UУ ¬!  dEУ Ўu,U£A$6БД0®®XЂFВK@mв	fЏ∞¶Ua‘@±VНr≥kР[EУ Ўu-ЫZЃ`RvBС ћГ _0§    a– ±VP®бЧXЂ&≥hШ[*ѓЕК≤АE@€И≤`Ђ&Д@mќmW±  "…АlЩtx       „ ± 9f—–І+6аЕ0DZ<B  іИ Ђ)ИіШ ЂIВƒb-&*“`МџzЌҐЅlЂb*“`Мџ2ЌЃбn±VПf’ ґmЬe\Р±VУИƒZLU§Ab-"√≤°b≠"…ЧJВ      -Ќk∞6m≤e]ј±VїaЁр± "” В≠МеiРFЙф$!  Z\ЫIЅґ∞B  FX B 9D  ХЫeШ,  еf’ ¶	сj £БМ;¶*” В-**„†n±VХf–pґU”a”јЅVХИі®#СKO сj ±°МЏfЌђAђџ8!  Z№ЫyДѕ£-(#fЁґUdaЎ–Ѕ "÷аbђ~ )cрmж>Мі†НЫWV1ЗcC7\y Ќ¶б,<fЏ`÷m2f—Q!VµА џ^ µaВ≠j і®1Ы^ГW0C}ЬђџЅњј-*√є°В≠МеiPADъf“pF2ЦйЖ@`(Д  r≥h@cВ!§cв-b *÷ † 2еkр0Иј hЯBBјQ *÷ Vm4
`∞D#∞£ХЫMЅ#ђ  Ќђ ОVm'`О∞ 6ИЖДTпр…сj¬•Aђџ>*!њ№ђЏ"ЅdИ@ 7(ЖҐєYі5ВЅf÷ QVХrКµЎ6ФГAаm–А aЧ(Ж©єYір5ВЅdЋ¶Ѕ  	khЂJВB@mQuКґpdEђ@8 *÷ Vm `∞EZTR)К]b≠РkV± fЏА±0 ъжЫ¬4  2Ќ≤aҐ-r…ЧNВ      -¶dPXЕ  f—a°А —ЦХj@ЛшюЌђЅm+ќ√Їб£≠*Ќ£БҐ3иЋJБ∞н–hЂPВ:ƒ  6„Иµ#дЖК≤(ђBА 3nшhђъ2“јbђЇ & \јyфe•ј≈X‘ЗT√Шu∞8u•јўЈ44" O£-.√≠Б√≠.ЌҐЅ  2}ip6lip6m!Р УиЋKБ∞л`pлKБ≥iРpD ЯFZ\З[Шu∞9ЫKBиHqLCКА
:U RавЯЗА   ЂАTпр…сj¬∞Ѕ√≠.Ќ®aЅ  2}ip1V7 ©ябУв’ЕhЗZ\Ы_В А dъ2“аbђҐ +>-YV‘8u•јўґX8F#>МіЄЂ!А
ѕ£-0* а ЫZC]b Ы{√Eg—ЦЩ`P И8 fЏ —XђV}i†1÷ЪfЏ–аИ ЌЄ!≠Ђт!  £-4*÷аg≈Ђ*ЗЗОі–6уЗP  …фe¶А≈X " YЈh8ъ2”`bђ
 А,Џ.}iј1VA ЯFZtЫ\ДZxUС@b Ыr√ЭbђЖ ЌЄБ¬-B*∆†ль2|Z∞Ђ0xЂPВ:≈YЫRƒZДUШ@ґ∞1Х^C≈ZД *ћ џ&Ќ≠AмЂ*ћ —Ц†aў`сV°f  }j 1VU >Мµл:А3h(xНЫ^ГўV–<UН@+„шeЫiCўґ»=ХuC«Z\ЫhCƒјлЩьo>МіЄлL≥mрxМъ2” bђќ "‘@b≠*)КE.±V»ИµИ ЂXА9D:P ! ђЏвЅ`∞EZT" 3k{ђU≥А√"-b *÷ Q r≥kаkВ*÷ H 2"÷ ≠b е`P+6Л0X,СVa j@1VA uК≤86БИ:≈YЫPҐђК л† ЏВ—f‘q©ePpfЏ|f–!&|a„ЅmTђ"     √ђв≠*АµXA÷*ў@aС± k(ЗRєD рХЫ}√Ў,&]F  KhY\ EС ƒ 0фe©А≈Y"ю?≥ohsJнИ0о`АЂ"Їƒ  6©≤ ÷Иµ06зИѕ£-L+aџЅ÷ЩfЁиЋSБК≤ЎђUШ@ґA *’ n6mKjР1VW КE",И*’ n±VDf№AXЛTБКµHEю fў–∆U+epXД f–±[ЧИК≤Є ђъ2’ bђ∆ k?√'≈Ђ*•К≥ E†€ЯFZ†UХјlџP ЂҐ"≠RАі`EЫmCўUаDB€ µHД  >Мµ@ЖѓєYґЎ1В*Ћ ±ЂepH§R)И≤ Ђ,А:≈Y2+uК≤ 6ТИИ≤ Д  j0AVD>-YW0EЗnEYV"»Аl;F"*‘`О± Ќ∞ЅG«≤ ќ"‘`М;\"*‘`О±  ЌЄ'—Ц≠j0CиЋWК≤»ђB 3lјИЛWБК≤Ў ЛXБ≤@`p <  ?яа    !‘јnQхrИA†+6Ќ0X,LЇФ  ЦКЙ
і® §R)Ї≈Zћ2"‘†В≠J "-J*‘†В1ЛRВ
≈nQVµf“ СVY uИ@АmйuКµ®dE≠@≈ZФ *÷†lЏz$*’ b7XД f‘q!ђU≠@√"-j…ЧSВ               -pА -V"’ В≠*)КE.±V≥Иµh ЂfИµx л:А3nшАМшµe]Б1V5 ѓ_бЦmOeZб!VC ∞нИРЂ!Аµ8 ЂKВ:≈ZЬ2"“аБ8ЫVƒYWPHCcЗ№ђЏк"ЅА СVћrИs®ФU©ЅђЏ$Ѕ`∞EX‘ "љЖYґИIХЕZЬ"< 3nУ6ѓ≤™»ШЂfИµИ ЂSВ:ƒ  6≤	:≈[02"÷`В  EСА≈Y÷*»јlџR Ђ"l:t&*»јb1Fa“1V≥ИµШ ≠ *÷ В1±ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                  SYSMAN(OFFHAN / OFFOPEN)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

STATIC
FILE	fd;			/* File descriptor for AMIE.FRM		*/

STATIC
WORD	i;			/* General counter			*/

STATIC
BYTE	*ptr;			/* General pointer			*/

UWORD	*offsets = 0;		/* Pointer to offsets			*/

/*======================================================================*/
VOID                                           /*			*/
offopen()                                      /* Open the offsets file */
/*======================================================================*/
/*USE
Portability	Level 2 (Uses SPOPEN etc)
Parent Module	System Manager SYSMAN
Revision History:
31/01/90 Started - ICFO
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Open the file							*/
if ((fd = spopen("AMIE.FRM","RC")) == OPENFAIL)
				     return((BYTE *) flerr("AMIE.FRM",3));

/* Allocate memory for the offsets					*/
if ((ptr = (BYTE *) (offsets = (UWORD *) alloc(64 * sizeof(UWORD)))) ==
							  (BYTE *) FAIL) {
    spclose(fd);
    return((UWORD *) nferr(1));
}

/* Read the 128 bytes (equivalent to 64 UWORDs)				*/
i = -1;
while (++i < 64 * sizeof(UWORD))  *ptr++ = spgetc(fd);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                  SYSMAN(OFFHAN / OFFSEEK)
.pa
*/
/*======================================================================*/
STATUS                                      /*				*/
offseek(off)                                /* Seek in the offsets file */
LONG	off;					/* Position to seek to	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((spseek(fd,off,0) == FAIL) ? flerr("AMIE.FRM",11)/* Seek error	*/
				  : SUCCESS);

}

/*======================================================================*/
/*
.he                                                  SYSMAN(OFFHAN / OFFGETC)
.pa
*/
/*======================================================================*/
struct osn              /*						*/
*offgetc(ptr1)          /* Get an 'osn' structure from the offsets file */
struct	osn	*ptr1;		/* Pointer to an 'osn' structure	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

ptr = (BYTE *) ptr1;

i = 0;
while (i++ < sizeof(struct osn))  *ptr++ = spgetc(fd);

return((struct osn *) ptr);

}

/*======================================================================*/
/*
.he                                                  SYSMAN(OFFHAN / OFFCLOS)
.pa
*/
/*======================================================================*/
VOID                                          /*			*/
offclos()                                     /* Close the of≥i({ђUРј-иIЗLеЂ"bђj ^њ√,џ№$ ≠ВbђЇ ЌњҐLЏ‘& µbb≠Ш"÷ В  EСА≈ZЬ÷*»јlЏP& µbl;0&*»јb1Fa„б1V±ИµИ ≠ Ќ©ВbґЙф$√±¬rЏ±1VE uИP mњПмџh “Євb≠Ш"’`М;Ъ&*ўАb-R*ўАn±VІИґ`ЂVВ9EZ§ЫVDЕZђУ.µ         Цу	И@  `PmҐ>-YTФUЗA≈X " DXЗ{≈X "	 YЈјLE≠AZдFЌ≠Ґl™P(*÷†ОQVєf„pцmeSFъc0 ъжўі§QХQЕ  §К@ Јc– Кбюf÷6U_А@:ƒ(!  ZдUБ@! eЫC≈+чшdR)Д@  ЋФU≠Ѕb≠rіC,џJ"„`Вђ
 А,ЏЏ(& \ѕг{ФUПјјлЩьofё`ЖU№`P И( fўAA0 *∆ џN(¬ї"Вђ
  ,џh(& \ј3{ФUМ@ґфQЫN≈ЈhQХ}EX " YЈ(PL uК≤6ЫГ≥nи£*Ж
К∞( D ≥oP£ђUСјЈћQЫ}ЕTdTUЃЅlЏ*ЌҐвђ™D*√§Ґђ;ф&*ј†Џ*|Z∞©†®Ею€dКµ® Ш }sЌб  f“СQµc– Кбю>-XUtTU≠A"  dE≠AXм "≠ЖOЛVskP@И@ kPAVµuКµЎ dE≠AZ‘У.љ  %∞BҐ Ќ®†ћљf—°VUЫk–G+6з0EZфУ.њ               [>*ЌµАB  ЌІ¬м≈lPCв’ЕoЕD6ј} ЌєҐLHД  r≥ixkшµe]aQ∆r≥m–ЂЗME≈["
 D[U±AґPE±A[ЫyDYUѓјƒZьB1 ґ Ђ"ДYзцmєmQсaVњИµш ђB1 9EYЫ}D[UѓЅђЏР.Ѕlј7(Ђb≥h–∞EN Иґ Е  r≥jhїU∞AђЏЖ.Ѕf’СqVƒ YUС ƒ[,B  ИґH ЂdВ9E[,ЫK≈Д[U± ƒ[$U≤ЅҐ≠ТеlpG+6рЙ0X,m^lAЛ`В
≈[$÷*ЎаБС…l0G(ЂcВ3k8∞ЛaВ
ґ#ђBА 3mШЫђE±Ѕ[÷!@ ґЉXE∞Ѕ   Л"Кґ#ђUС ўґMХA≈ЎwИXUС ƒb,И√є¬≠В#lA[ХЫP≈Ў"≠Теf‘—v6ѓКґH E  ИґH#мP +6¶Л∞E[ Ќ®bмmY† -Ц*ў`ОQV…rКґ8#ХЫ_≈Ш,6ѓИ_пч+6бК∞Y2”бpрl0dЋP≈√¬ј!У-HГ 6Lµ4\<$p∞XЃQP kt≤eЂ"бб8`
…ЦѓЗЕ@а6©Л≠ў ЌІBмLї4  ЦЄИ@АЋ6цКД_«цmmXБqъr≥m®ЋB Yµ‘] ! ,џ.еfўЖB  9Yµ∞]В|Z≤≠hї6ƒ3@ mђf“pA( еД@Vm`∞D7†} ЌЂјђ еfА  ю"… bђРеfА @≥j†£*ьК≤@D юИ≤@мЛК≤ МшµaP°Б! r≥n@їТ*» b,Д*» a А2"» bђР 8",РЌ∞ ђџЪ!  Ґ  ЌЈвм6†ЖИ@`(Д  r≥nаcВ!  ђџЅ`в’ХcX *ј`Vh  Ѕ`ИjХЫAЖ"ђ еf÷СЖЖ•П9YµƒaВ*ј`Vmy`ИjСХЫ`F,џ|…ЧgВ         Kd @ еЫeE≈b-Ю! ,џ*0#Иґ® Д  mAVѕ>-YV∞dUµAґАaЫPЕB-7шdшµe^aБV’Иƒ[TV+fџСЗ+6ъ∞E[<V"ўаВ EіA%Љ√≠Ю+lрAсj µ#"≠™#Иґ® ђVЌЇC-¶*Џ`Мџx0iњ√'≈Ђ*НКґШ#ХЫmFX"≠¶#m0Fm ЃbщљЗeЖE[DшµeTСU r≥lH√ЫcF[LF"Џ`ОVm©`∞н0»ЂiВƒ[LEА@[<шµeW±СV’Иƒ[TV+fябБ lрAXЛgВ0м»ЖэИ∞”КґШ ђEіЅђџj2ЅaЏaЦ¶f„
Z2F TсТ(   aЎAЦжaџAСъr≥m®ЋТ! ,ЏЎ2Ќ§C'≈Ђ*мИlХЫNЖX" rЌЈC.Vm…`Иl…ХЫuFX"X@еfЁ—ЦЖй9YЈФeВЌІ√,С 9fЁС± лp≥ k0ЛYА
∆ƒV≥ ИµШ ђl:k6ёМДXѕрЋ6у≤©И–ЂXАƒb-b-1k0ЛYА
№Ґ≠b #k[6ОН4O°&mОeUA¶1a”°Ј k0V≥ f‘1¶mIeW1°V≥ f’б†ЛIюf÷¶mqeX1°V≥ ИµШ≠
µШФC@»\ђЏZ Ѕ`ИuЄФCB\ђџ
Ѕ`И≤PЂ%Яђ+v4!°d.Vmн`ИuЄХЫkFШ,џв2!  \ђџЉ.ЅkPVµ ЕY( *÷†Q еfяfВ"»АbђФеfА Vµ њјС∞hU≠@Zћ Eђ@   Л#К≤ Н÷*»јlџ†, ≥cl:66*»јb1Fa–±V± f÷°¶nk0ЛYА
∆ј°V± ИµИ√ЋN≈ZƒЫG∆¬-уы6љЛі™ИЎЂXАƒZƒЗNе™#l;6*÷`1≥ єEZƒ F"÷ ґm<hЯBL;6Ќ≤г4Рl •√`†8А*ИЎh   0к†ЎЂXА3k0ЎEћ€Яђ+06√≥cl:"6*÷`` ЂZА9YЈіmВ…ААЦmщkP± kXЛXА
µИ МEђ@ЋvUаkmКі_бУв’ЕwF≈Zƒ l
aџ—± 9fЏбЈ+6цН∞Y2ё—± 9fёQґmЌ>-YT,pB \ђџд6#fё6нААЧ+6Б
ўіpB YіDqЫ}F¬/gшdшµaSaЅ 9r≥hаа≠ЫEG   еЫLlЏ>8{?√,ЏH4 ђCВ rЌІcМЏ~8& \≈уxEN€≥j0г6Ї2ЂЎаД ≥jАаЎ !,А£,  √∞CВp ъ2ј ЩvЄ  -Глp„kPmS>-XVppB 9YґИ]В*÷†џ8{?√'≈Ђ
ЁО
ґЄ#ФCБјђџ4Ѕ`∞п»дґмpU≠@ґАqЫX«WPpU≠@ґьp"цЖYЈqЫtЗW–pUµЅb-Ѓ+rКµ® МE≠@lџЦ8—>ДШvмpUµЅјVµ fёЅ√в’ХB«EZ‘ F"÷†Џv:Ќ∞BІ≈Ђ*ЛО≤D 0ФB  9YіћaВЅаp+6ЏН0D4МЕ Ќ•#ђmЙfџС¶Lїd  ЦЭОИ_псєлpўmРG(ЂlВ3oигХЫ^¬Ў-иHшµeVБ—VўИґ»#£ОИuЄ ЛlВ
ґ»#6ІОЯђЂ&:*џ В1ў≥kРиEJ€Яђ+ :√≤cђ:№:*џ Мџ:|Z≤Ѓ0иЂlВ3lЄлХЪ  0OЛVUљmРFmҐ Ѓ`9ЉEЃ@≈[dV"џ Г` ЗА9D:№ !Ађ– ВЅ`≤EB°P®@N7Э m4ЫН"iД 9ЮNgC)і@*
Е@iД *ЫНЖУYФЎyѕ'3°ФЏ :М&3XА“nЙ$тШ∞@a9Ьќ¶”IЄќ   А@ 9ФЏi7D”©∞иiСНз#iДи-!Iе1  ¶e:N јдo3ЬМ&—X r9ЪMжб јh.@иА ) —ЮR&РJЕ1qВT L@Д№n7Э√yМ¬t2ИƒтС4ВT)ЛИД†АёnFУ±Ф@A 
ЕBҐ!§жcМ¶ А r9ќB°P® P9ћз#	і@e9Нз! –j #ќF”	–ж 'ƒCС§мe&г!∞ sУШАћo9L'@\ёr5ЬќФ@O;NFcaЉо ИFSЙ‘“r2ЬƒћЏa6І!ћтs:M†iЉ»i3D3…ћиe6ИЗ#	М÷ ,Жсі¬t1Ъв ёn3LзSС§№gПАсxЉ^/Л≈всx 15ИF√yМ÷sDCIћ∆ 1ШN§иyМ¶C©М dвР‘j 1ж3Yћ S2ШќЖуРАиr0ЫОf√	–“o7Ж∞  7ЭМІ#1∞ёw ћ&гqЉи 9ЩMЖS–@D9N∆Q R2ШLВxАЃr4ЭҐ)»дo9жбТO)ИІ!Диe Ќз…»“g4Г§@d1ЪD3yШиw0ЬМҐИдp4#Сј‘@a7CIі c6M&— ƒr8А	&гЩ‘ћf4ШЌ&Sq–@m2ЫMз#»А¬v0ЪMЖ∞ 
 ИfqЄёtOS‘иe аP Жa7НзAћаe1ЪL«С ЄЖF#И∆УaФ@a7cy»Џa:ЖУЩ–B
 К¶гСФ∆o3ЫН'3)Р@a9ќ¶”)Єи: D3y»дe1ЭSЩДќeNc† (S"Х√1§Ўe7M¶QрАґ-2Пfуiі¬n2Д√°Д“l@ †ILКTL∆cy»Џa:ћ∆уСі¬tЩNЖ1 Аґ-2Пfуiі¬n2Д√°Д“lA@qМG М@Д№n7ЭуБФ№ :Ґ1§ЎeД  і@F7ЬН¶†А∆o2DУШАкn2L∆УqФ» МЈНве5tХD8ћ»еABORTО№dD•х»ќ ’ALLOCП)дфФдEИф†BDRVПbƒ$Фх8тЄBLOCKSП4Аd$фхE5®х®BPП"А4%8хЄBUFFERП$д%Te4Х®м@BYEBYEМк‘2д5(ЌиµC.DIVМЕ
ƒ2дtX»H№C.GTМэ	D2д≈HѕhЖC.MULTМ∞T2ддхHћРХC.SXTМ°‘2еE5HтPCHANNEПАT4ƒф4Є…ј∆CLREOLМ°Мd4≈$Tх8ЌpЉCLRSМТT4‘фDXн@>COMPARМКЖд4фдхUHќАMCONSTМШD5$ƒhт DATAП\БдDTdE%hчЎDEFLTПАdDTе4ХHтDIRП,АdDХ$T5Hф®"DNП[БдDхT$ƒXх DPBПeдE$$8хШDPTTABПАTE$ХdXц@DRVTABМлК$Rиќ®гE.0Ми
‘U%$х(Ћ ƒEXECМЬƒUДХHрEX_ARGП АdUЕф4фЎуШFATIDМтНdd4ƒх4XцpFDTEXTПh‘dХ%5HтxFMTBYTП dd’DDU8сИFMTDRVПАTd’DФHсшFMTTPIП Аdd’EE$Єп0ЮFNDDRVМћНTdхTитиFRSTSEМў§rитHGAP1П%АDt(тhGAP3ОƒdtUDTеHмжGETFCOОЅ
дtUDd’HЋhвH.МуЙдД$Etй8$HEADПБƒДT≈тАHIGHESМЕдДФ≈ффhѕ†&HIL_ONП"ФШс»INDEXО÷dФдХEdи»FINSERTПАdФеdU%HсЄINVSIDП#Ф®…hљLDIRMП^Б‘ƒФ‘ХHЋа,LOCKП0АD≈5HлАЉMAINОЄГd‘D4ГИуxMEDIAПaБі‘d(… мMOVEМйОд‘хe5E(цРMSМУ
$виц0NDRIVEП8АTдdE8лЄNOTMFBМ”деT‘U$ШхЎNUMWINП`Бдфde4UHм ,OPENПXАfsets file */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

offsets = free(offsets);

fd = spclose(fd);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(OPNSWT)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

#define		SCRSIZE 1024	/* Size of switch scratchpad area	*/

STATIC
BYTE	*swfname = "AMIE.SWT",	/* Amie switch file name		*/
	*scrmem = 0;		/* Switch scratchpad area		*/

STATIC
WORD	td = -1;		/* Text descriptor flagged as closed	*/
				/* Scope is opn_swt() & cls_swt()	*/

/*======================================================================*/
BYTE                           /*					*/
*opn_swit(swpoint)             /* Open switch list ready for processing */
BYTE	*swpoint[];		/* Array of pointers to switch strings	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

LOCAL
WORD	i;		/* Switch string index				*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (fexist(swfname) == TRUE) { 	/* Switch file exists so read it	*/
    if ((td = opn_txt(swfname,swpoint,8)) == FAIL)
						 return(flerr(swfname,3));
}
else {		/* set all switch pointers to 0				*/
    for (i = 0; i < 8 ; ++i)  swpoint[i] = "";
}

/* Set up the switch scratch area					*/
if ((scrmem = spalloc(SCRSIZE)) == (BYTE *) FAIL) {
    cls_txt(td);
    return(nferr(1));					/* No space	*/
}

/* Make scratch area all 0						*/
setmem(scrmem,SCRSIZE,0);

return(scrmem);

}

/*======================================================================*/
/*
.he                                                            SYSMAN(ABTSWT)
.pa
*/
/*======================================================================*/
VOID                                 /*					*/
abtswt()                             /* Crash close the switch handlers */
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager sysman
Revision history:-
22/06/89 Listing brought up to latest standards - ICFO
08/06/87 Created - DAR
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

scrmem = spfree(scrmem);

if (td != -1){
    cls_txt(td);
    td = -1;
}

}

/*======================================================================*/
/*
.he                                                            SYSMAN(CLSSWT)
.pa
*/
/*======================================================================*/
STATUS                            /*					*/
cls_swit(swpoint)                 /* Close switch list after processing */
BYTE	*swpoint[];		/* Array of pointers to switch strings	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

LOCAL
FILE	swfile;		/* Switch file descriptor			*/

LOCAL
WORD	i;		/* Loop counter					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if ((swfile = spopen(swfname,"WC")) == OPENFAIL) {
    abtswt();
    return(flerr(swfname,3));
}

for (i = 0; i < 8 ; ++i)  fputs(swfile,swpoint[i]);

spputc(0x1a,swfile);

spclose(swfile);

/* Close the alloced areas						*/
abtswt();

return(SUCCESS);

}

/*======================================================================*/
еееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееет†PSECNUП/АU4іUx…ш.PUTNUMМЃЖеUE4H…ИоPUTSTRПYА…†вQ.ОЭД’ƒХ5Hт`QLOFFОзU$DTеHќј‘READОўДe$T‘хdXтЎRESTRKП'е%ф$4XЌ≤S.П  U4dThс®SCHANGМ™e45$ETЎцШSECBUFП:Аe4T5E$ѕ 6SEEKRCОжЕе4UD$ФштИSIDEFП)АU4Х§Th»PmSMOVEОИГ≈4х%HуXSPCП#А55HуhSPFATП1Аe5ƒUДЎтSPTП2Аe5фФдШк(6SRCHDIМїКU5DDXѕ@STRCMPМЏe5E$5ШфЄ#STTП_Бе5Х5E$Єт®SYSTYPОА 5Dd»ц`TRANSBП3АUE4іUxи@TTLМЪОеTдƒф4ЄиАUNPACKМ©О’UU(ќАЉWAITОѕКеu%D$Фшх®WSPACEЬ   Ю5E$ѕ 6SEEKRCОжЕе4UD$ФштИSIDEFП)АU4Х§Th»PmSMOVEОИГ≈4х%HуXSPCП#А55HуhSPFATП1Аe5ƒUДЎтееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                           SETBIO(SETBIOS)
.pa
*/
#ifndef	HEADER		/* Defined if an INCLUDE Compilation for SET */
#include	"portab.h"
#include	"setup.h"
#endif

#define 	STLENGTH 167	/* Length of sector translate table	*/

WORD	dn,		/* Drive number					*/
	stt;		/* Sector translation count			*/

/*======================================================================*/
VOID                     /*						*/
setbios()                /* Section of setup to patch the Bios directly */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SET, SETUP etc
Revision History:
02/11/89 For SETUP only drives from 'numwin + 1' can be modified.  This
         prevents the user from changing the assignment for 'minflop'.
         It will always therefore be possible to read GEMQDDS discs.  No
         change for SET - ICFO
05/10/89 Listing brought up to Timeclaim standards - ICFO
20/07/86 Version 3.41/*
.he                                                            SYSMAN(PRCENT)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
STATUS                                    /*				*/
prcent(dvc,swpoint,tdvce,sdtype)          /* Process entry and switches */
struct	dvcent	*dvc;		/* Pointer to base of device descriptor	*/
BYTE	*swpoint[];		/* Array of pointers to switch strings	*/
struct	dvce	*tdvce;		/* Temporary device descriptors		*/
WORD	sdtype;			/* 0 - SOURCE  1 - DEST			*/
/*======================================================================*/
/*USE
Portability level 1
Parent module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/10/87 Device name taken as 'sizeof...' not fixed value
05/06/87 Created - DAR
*/

{

LOCAL
WORD	i,		/* Index into 'swpoint' array + general use	*/
	swindex;	/* Index into 'swpoint' array			*/

LOCAL
BYTE	*sptr;		/* Pointer working in strings			*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Copy device name to temporary device structure			*/
strncpy(tdvce->dv_name,dvc->dv_id,sizeof(tdvce->dv_name) - 1);

i = tdvce->medium = toupper(dvc->dv_type[0]);

/* Validate the device type						*/
/* Error 38 is 'invalid device description'				*/
if (i != 'D' && i != 'T' && i != 'I')  return(flerr(dvc->dv_id,38));

/* Calculate the 'swpoint' element to start at				*/
swindex = (sdtype == SOURCE) ? 0 : 4;

for (i = 0; i < 4; i++, ++swindex) {
    sptr = dvc->dv_prc[i];

/* Attempt to locate a switch list in the device string			*/
    while (*sptr != 0 && *sptr != '[')  *sptr = toupper(*sptr++);
    if (*sptr == '[') {
	*sptr++ = 0;
	swpoint[swindex] = sptr;
	while (*sptr != 0 && *sptr !=']')  sptr++;
	*sptr = 0;
    }
    else swpoint[swindex] = sptr;

/* Copy device driver to temporary device description			*/
    strncpy(&tdvce->proc[i][0],dvc->dv_prc[i],9);
}		

return(SUCCESS);

}

/*======================================================================*/
ice string			*/
    while (*sptr != 0 && *sptr != '[')  *sptr = toupper(*sptr++);
    if (*sptr == '[') {
	*sptr++ = 0;
	swpoint[swindex] = sptr;
	while (*sptr != 0 && *sptr !=']')  sptr++;
	*sptr = 0;
    }
    else swpoint[swindex] = sptr;

/* Copy device driver to temporary device description			*/
    strncpy(&tdvce->proc[i][0],dvc->dv_prc[i],9);
}		

return(SUCCESееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(PRCFMT)
.pa
*/
#include	"amie.h"
#include	"sysman.h"
#include	"disc.h"

/*======================================================================*/
STATUS                             /* Set up formats from switch string */
prcfmt(swpoint,tdvce,sdtype,scratch,iniseq)/*				*/
BYTE	*swpoint[];		/* Array of pointers to switch strings	*/
struct	dvce	*tdvce;		/* Temp device descriptors		*/
WORD	sdtype;			/* 0 - SOURCE  1 - DEST			*/
BYTE	*scratch;		/* Switch scratch working area		*/
BOOLEAN	iniseq;			/* Are we in init sequence yes or no	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
17/04/89 If "DV" switch present it now allows for other switches but
         not "FO or "FC" - ICFO
16/05/88 If 'setswt' returns an error then this function returns
         FA	
20/07/86 External 'track skew' parameter added to the bios
         table.
04/02/86 'Save to system track' option added to SET
03/07/85 'Invert side' & 'side compare' options added
10/06/85 Modified for GM849 & MFB II
         "C" formats etc..
24/08/84 Modified to take account of new "T" option
         Sector translate tables.
29/06/84 "U" format added.
01/04/84 Addition SKIPDR = 1 for the floppy based case.
*/

{

/* Module that constructs new drive / format tables in the BIOS.	*/

LOCAL
WORD	skipdr;

STATIC
WORD	allst();

STATIC
VOID
	dptable(),
	odddpb(),
	cpmdpb(),
	dpbentry(),
	dtentry(),
	getdflt(),
	cbhead();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

skipdr = (numwin != 0) ? numwin : 1;/* Allow for multiple logical drvs	*/
*ndrives = skipdr;		/* Accept unchanging drives		*/
stt = 0;			/* No space used yet			*/
head();
initvar();			/* Zero all pointers			*/
fmtid[0] = 0;
clreos(3,0);			/* Clear the screen			*/

#ifndef SET
qlist();			/* Get the Format list up		*/
#endif

if (abort(0) != 0)  goto done;	/* Set abort linkage			*/
#ifndef	SET
for (dn = skipdr + 1; dn < limit; ++dn) {
#else
for (dn = skipdr; dn < limit; ++dn) {
#endif
    while (TRUE) {
	cbhead();
	getdflt();		/* Get any default values		*/
	getfcode();		/* Get the format info			*/
	double = 0;		/* No double step yet			*/
	if ((bdrv.pda = fnddrv()) != -1)  break;
	double = 1;		/* Try for double step maybe		*/
	fmttpi *= 2;		/* Temp double it			*/
	if ((bdrv.pda = fnddrv()) != -1)  break;/* Try again		*/
	error("No drive handles this format");
    }

/* Construct the BIOS information needed				*/
/* * * * * * * * * *  NB DON'T CHANGE ORDER  * * * * * * * * * * * * * **/
    dtentry();			/* Compute drive table entry		*/
    dpbentry();			/* Compute disc parameter block		*/
    dptable();			/* Disc parameter table			*/
    if ((wspace > 0) && (wspace < 4096)) {
	error("Workspace Overflow - requires a smaller system");
	dn = 255;		/* Force termination			*/
    }
    else  *ndrives = dn + 1;
    head();			/* Update main heading			*/
}

done:
clreos(3,0);
p = "Modify system track X to match? ";
p[20] = systrk + '0';
putsat(20 RC 24,p);

#ifndef SET
if (getltr(20 RC 59,'N',"YN") == 'Y')  wrtbios();
#else
smove( 20 RC 59 );
conout(savef);
if (savef == 'Y')  wrtbios();
#endif

abort(-1);					/* Unlink the trap	*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                  SETBIO(SETBIOS / CBHEAD)
.pa
*/
/*======================================================================*/
STATIC VOID           /*						*/
cbhead()              /* Display a Heading for this section of the BIOS */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putsat(3 RC 0,"Configuring->");
clreol();
putsat(3 RC ((dn - numwin) * 15)," ^^^^^^^^^^");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                 SETBIO(SETBIOS / GETDFLT)
.pa
*/
/*======================================================================*/
STATIC VOID                /*						*/
getdflt()                  /* Get current Format/Drive from the heading */
/*======================================================================*/

{

/* Get any current Format/Drive from the heading.  With the drive the	*/
/* address will suffice.  This needs translating back if GM829		*/

LOCAL
WORD	i;
 
/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = fdtext + dn * 18;			/* Point to text area		*/
strcpy(fmtid,p);
p = drvtab + dn * 16;			/* Index into drive table	*/

#ifdef GM829
d = *p & 0x0f;				/* Set default drive address	*/
defdrv = -1;
while ((d /= 2) != 0)  ++defdrv;
#else
defdrv = ttl[*p & 0x07];		/* Translate to logical		*/
#endif

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                 SETBIO(SETBIOS / DTENTRY)
.pa
*/
/*======================================================================*/
STATIC VOID                 /*						*/
dtentry()                   /* Compute "Drive Table" entry for the BIOS */
/*======================================================================*/

{

/* Drive and Format have been found.  Now compute "Drive Table" entry	*/
/* for the BIOS.							*/

/* NB>>> Must  be called before DPBENTRY, as sets <lspt> entry properly	*/

/* Note:- bdrv.pda is already set					*/

LOCAL
WORD	c,
	d,
	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i = bps / 128;				/* Bytes-per-sector 		*/
for (bdrv.log2ps = 0; i > 1; ++bdrv.log2ps)  i /= 2;

bdrv.psm = (bps / 128) - 1;		/* Physical sector maskIL - ICFO
02/10/87 'iniseq' added
08/06/87 Created - DAR
*/

{

LOCAL
BYTE	fmtnam[9],		/* Format name				*/
	*swptr,			/* Local pointer to switch list		*/
	*namep[21],		/* Switch names				*/
	*valuep[21];		/* Switch values			*/

LOCAL
WORD	index,			/* Index into swindex/swpoint array	*/
	pindex,			/* Processor index			*/
	fcedrv,			/* Number of drive to force -2 is none	*/
				/* 0 - 7 is drive number		*/
	n,			/* Switch string length			*/
	swtnum;			/* Number of switches in list		*/

EXTERN
struct	drvtbl	*drvtab;	/* Pointer to BIOS drive tables		*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Get the operating system associated with this driver			*/
if ((tdvce->opsys = getos(tdvce)) == FAIL){
    if(tdvce->medium != 'D') {
	tdvce->opsys = 63;	/* None					*/
	return(SUCCESS);
    }
    else return(flerr(tdvce->proc[2],41));/* Driver ID not in OpSys list*/
}

/* If device medium is not a disk then no format is required		*/
if (tdvce->medium != 'D')  return(SUCCESS);

/* Get the switches for the I/O processor 				*/
pindex = (sdtype == SOURCE) ? 2 : 6;

/* Get pointer to original switch list					*/
swptr = swpoint[pindex];

/* Set up the switches							*/
if ((swtnum = setswt(20,swptr,namep,valuep)) == FAIL)  return(FAIL);

#ifdef BUG
putstr("\nswitches are");
for (n = 0;n < swtnum; ++n) {
    putstr("\nname = ");
    putstr(namep[n]);
    putstr("  val = ");
    putstr(valuep[n]);
}
getkey();
#endif

/* If device = CPM then look for a DV: switch - no format reqd if there	*/
if (tdvce->opsys != 0 || (index = fndswt(swtnum,namep,"DV")) == FAIL) {

/* If FO: switch specified with format use it				*/
    if (((index = fndswt(swtnum,namep,"FO")) != FAIL) 
					 && (*(valuep[index]) != NULLPTR))
					  strncpy(fmtnam,valuep[index],9);

/* Otherwise nothing is defined then get a format			*/
    else if (getfnm(sdtype,tdvce->opsys,fmtnam) == FAIL)  return(FAIL);

/* Get the forced drive if present					*/
    if ((index = fndswt(swtnum,namep,"FC")) != FAIL) {
	if ((fcedrv = getfce(valuep[index],sdtype)) == FAIL) return(FAIL);
    }			/* Braces required to link 'else' to right 'if'	*/
    else fcedrv = -2;	/* This means put on best available drive	*/

/* Change format name to upper case					*/
    swptr = fmtnam;
    while (*swptr = toupper(*swptr++));

    if (setup(fmtnam,fcedrv,tdvce->opsys,sdtype,iniseq) == FAIL)
							     return(FAIL);

/* Make new switch list in scratch area					*/
    strcpy(scratch,"FO:");
    strcat(scratch,fmtnam);
    strcat(scratch,"/FC:");

    fmtnam[0] = (fcedrv == -2) ? '*' : fcedrv + '0';
    fmtnam[1] = NULL;
    strcat(scratch,fmtnam);
}

for (index = 0 ; index < swtnum ; index++){
    if ((strcmp(namep[index],"FO") != 0 )
	&& (strcmp(namep[index],"FC") != 0)) {
	strcat(scratch,"/");
	strcat(scratch,namep[index]);		/* Put in switch ID	*/
	strcat(scratch,":");
	strcat(scratch,valuep[index]);
    }
}

swpoint[pindex] = scratch;	/* Point list entry at new format string*/

return(SUCCESS);

}

/*======================================================================*/
tnam[1] = NULL;
    strcat(scratch,fmtnam);
}

for (index = 0 ; index < swtnum ; index++){
    if ((strcmp(namep[index],"FO") != 0 )
	&& (strcmp(namep[index],"FC") != 0)) {
	strcat(scratch,"/");
	strcat(scratch,namep[index]);		/* Put in switch ID	*/
	strcat(scratch,":");
	strcat(scratch,valuep[index]);
    }
}

swpoint[pindex] = scratch;	/* Point list entry at new forееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее		*/
bdrv.flg = frstsec & 0x01;		/* Flag byte ..1st sec		*/
switch (schange) {

    case 'S':
	break;

    case 'T':			/* Flag 'T' format			*/
	bdrv.flg += 16;
	break;

    case 'U':			/* Flag 'U' format			*/
	bdrv.flg += 32;
	break;

    case 'C':			/* Flag 'C' format			*/
	bdrv.flg += 64;
	break;

    case 'B':			/* Flag 'B' format			*/
	bdrv.flg +=  4;
	break;
}

if (invert  == 'Y')  bdrv.flg += 128;	/* Flag inverted data		*/
if (invside == 'Y')  bdrv.flg +=   8;	/* Invert side			*/
if (sidef   !=  1 )  bdrv.flg +=   2;	/* Disable check		*/

bdrv.pst = spt - 1;		/* last sector number before swap	*/

bdrv.blmm = (blocksz * 1024)/128 - 1;
bdrv.str = drive->stepr - 3;	/* Always fast step on 829 		*/

if (bdrv.str < 0)  bdrv.str = 0;	/* In case underflow		*/
if (double != 0)  bdrv.str += 128;	/* Set MSB if to double step	*/
bdrv.stm = drive->settle;
bdrv.hlt = drive->hload;
bdrv.mts = fmttrk - 1;
bdrv.sttp= allst();		/* Do sector translate			*/
i = spt * (bps/128);		/* Set Logical SPT if necessary		*/
if (schange == 'C')  i *= spd;
if (lspt != 0 && lspt != i)  bdrv.lst = lspt;	/* Set only if a funny	*/
else {
    lspt = i;			/* Set for DPBENTRY!			*/
    bdrv.lst = 0;
}
bdrv.sys = systyp;		/* Set system type flag			*/
if (sectrans[0] != -1 && schange != 'C') {
    bdrv.flg &= 0xFE;		/* Transl. sets correct sector number	*/
    ++bdrv.pst;			/* Prevent false change			*/
}
bdrv.tskew = tskew;		/* Transfer tskew parameter		*/
p = drvtab + dn * 16;		/* Index into table			*/
ldirm(p,&bdrv.pda,16);		/* Copy over				*/
p = fdtext + dn * 18;		/* Point to text area			*/
strcpy(p,fmtid);		/* Copy over Format info		*/
p += 9;
strcpy(p,&drive->id[0]);	/* Copy over Drive Id			*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                SETBIO(SETBIOS / DPBENTRY)
.pa
*/
/*======================================================================*/
STATIC VOID                   /*					*/
dpbentry()                    /* Compute the disc parameter block entry */
/*======================================================================*/

{

/* Compute the disc parameter block entry.  For an MSDOS machine this	*/
/* is rather cobbled & contrived.					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

dpb.spt = lspt;					/* Set sectors per track*/
dpb.dsm = fmttrk * spd * spt * (bps/128); 	/* No. of 128byte secs	*/
switch (systyp) {

    case CPM:
	cpmdpb();
	break;

    default:
	odddpb();
	break;
}

p = dpbbas + dn * 15;				/* Index into table	*/
ldirm(p,&dpb.spt,15);				/* Copy across		*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                  SETBIO(SETBIOS / CPMDPB)
.pa
*/
/*======================================================================*/
STATIC VOID              /*						*/
cpmdpb()                 /* Set up a standard CP/M disc parameter block */
/*======================================================================*/

{

LOCAL
WORD	res;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i  = blocksz;
for (dpb.bsh = 3; i > 1; i /= 2)  dpb.bsh++;
dpb.blm = bdrv.blmm;
dpb.dsm -= (restrk * lspt);		/* Remove reserved tracks	*/
i = blocksz * 8;			/* Sectors per block		*/
dpb.dsm = dpb.dsm / i - 1;		/* Size in blocks		*/
dpb.exm = (dpb.dsm > 255) ? blocksz/2 -1 : blocksz -1;
if (splexm != '*')  dpb.exm = splexm - '0'; 	/* Strange setting!	*/

/* Special case eg ITT3030 where whole disc isn't used */
if ((blocksz == 1) && dpb.dsm > 255) {	/* Invalid condition		*/
    dpb.dsm = 255;			/* Restrict the size		*/
    dpb.exm = 0;			/* Ensure correct values	*/
    error("1k blocks - disc capacity reduced to 255 blocks");
}

dpb.drm = directry - 1;
i = blocksz * 32;			/* Directory entries per block	*/
i = (directry + i - 1)/i;		/* locks per directory		*/
res = 0;				/* Reserved blocks		*/
for(; i != 0; --i)  res = res >> 1 | 0x8000;
dpb.al0 = res >> 8;
dpb.al1 = res;
dpb.cks = directry / 4;
dpb.off = restrk;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                  SETBIO(SETBIOS / ODDDPB)
.pa
*/
/*======================================================================*/
STATIC VOID              		   /*				*/
odddpb()                                   /* Create a non-standard DPB */
/*======================================================================*/

{

/* Non CP/M system, create a non-standard DPB to prevent user		*/
/* corruption of the disk.						*/

STATIC
BYTE	nonstd[] = { 3, 7, 0, 15, 0, 16, 0, 255, 255, 0, 0, 0, 0 };

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

ldirm(&dpb.bsh,nonstd,13);

/* Let C/80 supply the return						*/

}

/ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                             SYSMAN(RD2LF)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
WORD                                    /*				*/
rd2lf(fd)                               /* Wind file on to next LF char */
FILE	fd;					/* File descriptor	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/
{

LOCAL
WORD	c;			/* Character returned from 'spgetc'	*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while ((c = spgetc(fd)) != LF)
			   if (c == -1 || c == 0x1a)  return((WORD) FAIL);
return(c);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*======================================================================*/
/*
.he                                                 SETBIO(SETBIOS / DPTABLE)
.pa
*/
/*======================================================================*/
STATIC VOID              	    /*					*/
dptable()                           /* Compute the disc parameter table */
/*======================================================================*/

{

/* Compute the disc parameter table.  All we have to do is set the	*/
/* vector to the Check area and the vector to the allocation area	*/

LOCAL
WORD	*p;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = dpttab + dn * 8;		/* Set up the pointer			*/
p += 6;				/* Point at CHK vector			*/
*p++ = wspace;
wspace += directry/4;		/* Advance the pointer			*/
*p = wspace;			/* Allocation pointer			*/
wspace += (dpb.dsm+1)/8 + 1;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                   SETBIO(SETBIOS / ALLST)
.pa
*/
/*======================================================================*/
STATIC VOID       /*							*/
allst()           /* Allocate some memory to the sector translate table */
/*======================================================================*/

{

LOCAL
WORD	length,
	sb,
	sd,
	*ip;

LOCAL
BYTE	*st,
	*p,
	*q;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

sb = sd = 0;			/* No translation yet			*/
ip = dpttab + dn * 8;		/* Pointer into DPT			*/
st = transb;
if (sectrans[0] != -1) {	/* If translation table..		*/
    length = (schange == 'C') ? spt * 2 : spt;
    if ((stt += length) > STLENGTH) {
	error("Sector translation table overflow");
	return(0);
    }
    ldirm(transb,&sectrans[0],length);		/* Copy over		*/
    if (schange == 'C' && length > 60) {	/* Dup skew for 2nd side*/
	p = transb;
	q = transb + length / 2;
	for (j = 0; j < spt; ++j)  *q++ = *p++ + spt;
    }
    if (schange == 'C' && frstsec != 0)	{	/* Then adjust for FSN	*/
	p = transb;
	for (j = 0; j < length; ++j)  *p++ -= 1;/* - what BIOS will add */
    }
    if (bps / 128 > 1)  sd = transb;	/* If blocked then BIOS trans.	*/
    else		sb = transb;	/* Else SECTRAN translation	*/
    transb += length;			/* Update pointer		*/
}
*ip = sb;				/* Normal translation		*/

return(sd);				/* Blocked translation		*/

}

/*======================================================================*/
r (j = 0; j < length; ++j)  *p++ -= 1;/* - what BIOS will add */
    }
    if (bps / 128 > 1)  sd = transb;	/* If blocked then BIOS trans.	*/
    else		sb = transb;	/* Else SECTRAN translation	*/
    transb += length;			/* Update pointer		*/
}
*ip = sb;				/* Normal translation		*/

return(sd);				/* Blocked translation		*/

}

/*========================================ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(RDFORM)
.pa
*/
#include	"amie.h"
#include	"sysman.h"
#include	"dformat.h"

/*======================================================================*/
STATUS                                 /*				*/
rdform(sframe)                         /* Read format details into area */
struct	ssf	*sframe;		/* SOURCE or DEST setup details	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
07/02/90 'sdtype' removed - ICFO
29/01/90 Much modified because we can now setup SOURCE and DEST
         separately - ICFO
22/06/89 Listing brought up to latest standards - ICFO
         Optimised a little - ICFO
08/06/87 Created - DAR
*/

{

LOCAL
FILE	ffd;		/* File descriptor for FORMATS.DAT		*/

LOCAL
STATUS	rv;		/* Return value					*/

LOCAL
WORD	n;		/* SOURCE / DEST loop counter			*/

STATIC
BYTE	*fmtfil = "?:FORMATS.DAT";

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

ffd = OPENFAIL;

if (is_mdrive() == TRUE) {
    fmtfil[0] = 'M';
    ffd = spopen(fmtfil,"RB");
}

if (ffd == OPENFAIL) {
    fmtfil[0] = 'A';
    if ((ffd = spopen(fmtfil,"RB")) == OPENFAIL)  return(flerr(fmtfil,3));
}

/* Seek to specified position in the file				*/
if (spseek(ffd,(LONG) sframe->fmtoff * 128L,0) == FAIL) {
    rv = flerr(fmtfil,11);			/* Seek error		*/
    CLEANUP;
}

/* Read format details into the given area				*/
if (spread(ffd,sframe->fdata,128) != 128) {
    rv = flerr(fmtfil,5);			/* Disc read error	*/
    CLEANUP;
}

rv = SUCCESS;

cleanup:

spclose(ffd);

return(rv);

}

/*======================================================================*/
NG) sframe->fmtoff * 128L,0) == FAIL) {
    rv = flerr(fmtfil,11);			/* Seek error		*/
    CLEANUP;
}

/* Read format detaiееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—UТSа$DиMQRSETBIOФ M|В%ј        K@ @ 4  ePрU a—  "јА†  *јАиHB  ∞4  fА   ъ2   0ФB  9Y† ВЌ    ХЪ  0OЛVUR a–†V И∞  ®  uК∞ 4  eP†s ` Л  0к»µћ B ђЂИ Ќђ`,џ$Ќ     И  fА —Р  #f–@UЫ a№@ "± †  R"і@џ }Xр6…А2≠»в h∞CХЪ  0XuћЫuАYµИЫQAЕ@  D  fА Ђƒ *єј AЫX@ґƒХ~@4ћ! ЌЈјь "ј :*ҐјQV  іO°&m& a÷Р	hPД rИ@ +6ЭА0X"ƒ"  Tl" \Ґ†  "0 Z'–РД0rК®рХЪ  0X"ЎQ !' ҐеfА "ІЖOЛVZfА ыэ Ќ®аHД rИl0CХЫN X,h  *ј QU
 fА xЪ  @ 0ЋФCeђЏЎЅ`≤eјј  ґHUА ! 6јАЇ≈@  dEM D4ј *і .Vh  Ѕ`К∞  §R)Ї≈@  dEj EVфЪ  	А„0ё  ,џЖ"  2аА       %Їј"† ÷!@ †  Л @ и Hk@X0 "ю?≥@ Хa–p!‘Рф ≥@ фe$ њ@,;‘*ЅА± Ќїј", √њ "ЂЃл† Џ+>М§А@T  	А„0ё}I ј) ®  aЎ0&ЬI ј)И6юАДB  …фe$ І†L;8:ТАTА&m@И Уи HSАШvpu$ Ђ LЏҐ  '—ФРѓБ0макHZАЩµИ" O£) paўј&ЬfА д¶ ІАE@M*А*р[јИ@   T  Tпр…сj¬ґјC© {f„0 К  >М§А`§T  Tпр…сj¬Ї C© іfЏј И  >М§А`T  
ѕЛVUеI ј.p6гƒg—ФРн
А Yфe$ Љ`B†  " 3l»ђBА 3hшђъ2ТА^∞!P   ,џ†+Кѕ£) 0 IА(И6оБ@mсmRР1  }IА(†™ѕАђ™~:Т Rp6m† Уи HLА≈T" Yі(ъ2ТАS–1U@ГјЦmG>М§Б ,T  
ѕ£) HYfЏ aР(∞БК®јђBА 3oЎђUyАЩЈ–EГ T–"љЖOЛVЦ`јX®  f„А1   џ∆  µ bђ еYp6h  Ќ≥@lЂr*іАg—ФР0≥Б∞о0Ђ ≠АД  >М§БА–T  FR@–И:  і‘FЌµ@lЂ»*ѓјaль2ЌЇ†lџƒ ††Г© ЋfЁ10 ъжѕ£) лI /ј6чИѕ£)  ы  ) p` H§R)uК≠»dEp ET` !° ОQ@ еfА UА ! 6»БЇ≈Vt2"£`В™vеЏ@+6÷ ∞X"™|А"*Ц*™@ОQUNr≥j0#В…[–1  *ЂАn±UОf”0GX™ЇБ≥kА#ФUZАЁb Ы\@Џ,Џо"ТАV`AU«aЏ Fm–aЏјFm2aЏјFђfЎ@+"    ;.*ј xЫaБb†  2"™†ВЂvеЎРG(Д r≥i8#ВЅdЋГА  	nА ™чА  }I А. ™к_«цmiP∞Vь]аGXД fЎ AнaЁ–A‘РнВ3oрМъ2Т _–A[ц§А†|Ы@O£)   ±Ucfџ0G(™H
DЅ\lЏц"ТАRQU—КE"+о*ТАRАWX™ШВ≥o† ђE$ ¶АҐ© (?њјџ®  Ђ`Ґ™V
лААЏv
+a’рQUNЯFR@@
Д
*  -gшdшµeW†QUdібУи HXAEUpVЌ  V4U$ ѓ °шЫRYЈФХjD/р КH
aAD  фe$ ≤аҐ@еfё–®  И§АаxU^ЅE"СH§R"І ҐЂR
л[АP»≠÷*ЈађЏ™
"Є†Ґ  EГАW,шµe_јVи]@QXКпВ∞оШ(Ђ :ƒ 4  >=Рq aЁаQV uИA mр>М§Б іUГА£) P[∞WXД f№АQР,ЗГ
®∞(КHGЩ 08   пр    … А)3ФCIAЬҐh Ќє@МУ.   %®†¬ђ  )КE.±P  a V Г С a МEД bЈ(™н 3@ UuИ@АmuКЂP0dE^ЅЕX@ *ѓаћЏЏ*ТАS0aђB 3kЄ0Н÷*∞јЅСЩdЋДА                Ц–@  a@V  КE"ЧX™ІDX` T  ∞– кз≥hx(МшµePАБUџѓ_бЦme]аaUt∞п0™м∞Р Ђ :≈XH 2"ј@8ЫbЅYTCtђџJ
ЅА СUєrИmш3ФUДАђЏ~Ѕ`∞EW,"љЖYЈHХK≈XH "< 3oШ36«≤ђH8™ВГИ∞а Ђ	 :ƒ  6 :≈Tћ2"√ј  D  
Ѓш3ђUSБўЈАХbAЎu®UUAƒb*¬√™ вђ< #aа[ФUЗ b,8 +f’P7X™®ГЖZ'–У∞ЋbA≈T\"љЖYіxХg≈TЬ	ЫKAўґhХvЅ≈UEЗ    К≤ГК∞РђUkўµ`ХvЅЎw UlЅƒb+~√µјвђ8 #aј[ХЫ_≈mиIЗoБеї`в™цл† ЏАўЈР•}Ѕ≈VМEЕАwфU{ЅƒXP U~Ёbђ$ _аqV rК∞†6ƒГ
∞∞$ЬoFУ±Ф@h0ЫМЖ√)ћ@t4Nb1Љдm0Э sy»÷s8LfQ<мe9НЖуЄАZ 9N'SI» sD3iДЎl2ЬД3…ћиe6А	¶у!§ћyѕ'3°ФЏ :М&3XА∞ :ƒ”	–∆hИ Тp Жo7Н&s©»“n3ЛGјxЉ^/Л≈всxЉ Ъƒ#aЉ∆k9ИҐ!§жcћ'	М“t<ИFS!‘∆e2Жс »j5НЖуђж )ЩLgCy»@t9M«3aДиi7ЫДC	ИЎeќ∆SСШЎo;А#4 ШєM]%Q2ЊPPУ‘Х#  }%9b2СХ£  	%=N3`РУ–“‘г  	==QMj3Є–Фг  	UJ0 РХQФ“V£ А’єMJ3∆PЋСU£6јсєR2TЋУ##†єє5U1R3"PЋУУ’#8@’єMaR3“PЋХ’#  !990 P”–“г. 91I=22&Р”СS‘г  Q3¶СQСХ£  1R0 СSФ“U#  %J2аСTСP’#ј 	:2TС’PУc1АЌA
3n	СРРTг6@ўAQQ
2≤	QТUСc  IY962(	СХХP£3†нЄ¬3ъQTФУ‘£  Q%2n	ССV#  %IMR0 СУUЦU#  5QN0 СУUХ£(@Х5Q%3LСУUc- Щ5QQI.3RСУСХ£2ащIMQM3§СЋ£  @∆0 –T£  @ќ3С—UР”г) 9Q1QJ2
PQ#  !1B0 ТQ“Tг<`•&0 RSСV#% %9%QY3:ТSХСTХ#6аY%9YM%3ЖR£" х1%I62іSSRU##@±1MAR0 SQQPc  5
0  УTг4аi8Ї3фУСТUСc  9QN2рУХSU“S£  =MR3|T#  AM9V0 T“—Uг1†9AUQMR0  Tc"	DЇ2АTST’#  E1=2>ФСT’Тг  I}	M2J
ФЋ£1@щM!92Ф—P’Рc† MQ	%>3ҐT“QQ£  M%i0  ‘‘г-†НMA0 T‘РU#. єMA1a63 ‘‘#  MA}%9&2Ї	Ф’Р‘cј@MQR2LФ÷T’Тг1АЩMeMQeB0 Ф÷T„’c  Q22ХРSФ–£ јХQM-^3Ш’#+ 9]IQ	%>3:Х‘‘P—g   Ю—Uг1†9AUQMR0  Tc"	DЇ2АTST’#  E1=2>ФСT’Тг  I}	M2J
ФЋ£1@щM!92Ф—P’Рc† MQ	%>3ҐT“QQ£  M%i0  ‘‘г-†НMA0 T‘ТSХСTХ#6аY%9YM%3ЖR£" х1%I62іSSRU##@±1MAR0 SQQPc  5
0  УTг4аi8Ї3фУСТUСc  9QN2рУХSU“S£  =MR3|T#  AM9V0 T/*
.he                                                            SETFD(FMTDISC)
.pa
*/
#include	"portab.h"
#include	"setup.h"

#define		STEP	6	/* Offset to step rate in BIOS table	*/

/* 2793 registers							*/
#define		CMDREG	0E0h
#define 	STSREG	0E0h
#define 	TRKREG	0E1h
#define		SECREG	0E2h
#define		DATREG	0E3h
#define		DRVPRT	0E4h

#define		SEEKCM	18h
#define 	STEPIN  58h
#define 	STEPOUT 78h
#define 	WRTCMD  0xB0		/* Multi sector write		*/
#define 	FMTCMD  0xF0		/* Format track			*/

BYTE	fdl;				/* Format drive letter		*/

WORD	pda,				/* Physical drive address	*/
	stepr,
	settle;

EXTERN
struct	drec	hardware[];		/* System Hardware Definitions	*/

EXTERN
WORD	reqdrv,
	autofl,
	soft_err,
	hard_err;

/*======================================================================*/
VOID                        /*						*/
fmtdisc()                   /* Entry point to start formatting the disc */
/*======================================================================*/
//*
.he                                                           SYSMAN(SEC_HAN)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

#define		OPEN	0
#define		CLOSE	1

STATIC
FILE	fd;		/* File descriptor of assignment file		*/

STATIC
WORD	c;		/* Return character from 'getc'			*/


STATIC
BYTE	*sect = 0;	/* Area containing the section			*/

/*======================================================================*/
BYTE                         /* Open / close section of assignment file */
*sec_han(op,iniseq,sdtype,sfile)/*					*/
WORD	op;			/* 0 = OPEN 1 = CLOSE			*/
BOOLEAN	iniseq;			/* TRUE if in initialisation sequence	*/
WORD	sdtype;			/* 0 - SOURCE  1 - DEST			*/
BYTE	*sfile;			/* File name of assignment file		*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
29/01/90 'getc' introduced and 'gsfail' made static to save space - ICFO
28/09/89 Assignments can now be on several lines - ICFO
09/08/89 Bug fixed which caused the system to miss off the last
         assignment in a section - ICFO
26/06/89 Major rewrite - ICFO
25/06/89 'iniseq' added to argument list - ICFO
         OPEN and CLOSE introduced as synonyms for 0 and 1
         respectively - ICFO
22/06/89 Listing brought up to latest standards - ICFO
13/05/88 Assignment name must now begin and end with single quote only
         (not double quote) to allow double quote to be used within the
         name for 'inches' - ICFO
12/05/88 Recoded to allow for items of an assignment to be separated by
         'new-line' as well as 'space' or 'tab' - ICFO
05/06/87 Created - DAR
*/

{

LOCAL
struct	_asgn	*a_ptr0,/* Pointer to start of text string structures	*/
		*a_ptr;	/* Working pointer to text string structure	*/

LOCAL
UWORD	n_bytes,	/* Number of bytes in chosen assignment		*/
	size;		/* Maximum allocated area			*/

LOCAL
WORD	choice,		/* Operators choice from the menu		*/
	asgn_no,	/* Assignment number				*/
	skipmk;		/* Number of '#' chars to skip in file		*/

LOCAL
BYTE	*t_ptr,		/* Pointer to text string			*/
	**text;		/* Pointers to text strings			*/

LONG	sptell();	/* Disc address of next byte			*/

STATIC
WORD	getc(),
	read_as();	/* Read in an assignment line			*/

STATIC
BYTE	*gsfail();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (op == CLOSE) {			/* Close the section		*/
    sect = spfree(sect);
    return(NULLPTR);
}

/* Open the assignment file						*/
if ((fd = spopen(sfile,"RC")) == OPENFAIL)  return((BYTE *) FAIL);

/* Create space for section						*/
if ((text = (BYTE **) (sect = allocmax(&size))) == (BYTE **) FAIL) {
    nferr(1);
    return(gsfail());
}

/* Search to start of the section					*/
skipmk = (sdtype == SOURCE) ? 1 : 2;	/* Calculate # marks to skip	*/
while (skipmk-- != 0) {	/* Skip the required number of '#' marks	*/
    while ((c = getc()) != '#') {
	if (c == -1 || c == 0x1a) {
	    flerr(sfile,37);
	    return(gsfail());
	}
    }
}

/* Wind on to end of '#' line						*/
if (rd2lf(fd) == FAIL)  return(gsfail());

/* Get the first character from the next line				*/
if ((c = getc()) == -1 || c == 0x1a) {
    flerr(sfile,37);
    return(gsfail());
}

/* Skip any comment lines.  If '#' found terminate			*/
while (c != '\'') {
    if (rd2lf(fd) == FAIL)  return(gsfail());
    if (c == '#')  break;		/* Section is empty		*/
    if (c != ';') {
	flerr(sfile,37);
	return(gsfail());
    }
    if ((c = getc()) == -1 || c == 0x1a) {
	flerr(sfile,37);
	return(gsfail());
    }
}

/* Set pointer to text string						*/
a_ptr0 = a_ptr = (struct _asgn *) (sect +
       (size / (sizeof(BYTE *) + sizeof(struct _asgn))) * sizeof(BYTE *));

/* Zero count of assignments						*/
asgn_no = 0;

/* If in initialisation sequence take the first item in the section	*/
if (iniseq == TRUE)  (a_ptr + (choice = 0))->as_addr = sptell(fd) + 1;
else {

/* Set loop to run until the next # is found at beginning of a 'line'	*/
    while (c != '#') {

/* Loop through the name field looking for the terminating '		*/
	if ((c = getc()) == -1 || c == 0x1a) {
	    flerr(sfile,37);
	    return(gsfail());
	}

/* Store address of text and disc address of assignment			*/
	t_ptr = *(text + asgn_no++) = (BYTE *) a_ptr;
	if ((BYTE *) a_ptr >= sect + size - sizeof(a_ptr->as_name)) {
	    flerr(sfile,37);
	    return(gsfail());
	}
	(a_ptr++)->as_addr = sptell(fd);

/* Store the assignment name						*/
	while (c != '\'') {
	    *t_ptr++ = c;
	    if ((c = getc()) == -1 || c == 0x1a) {
		flerr(sfile,37);
		return(gsfail());
	    }
	}

/* Terminate the field with a NULL					*/
	*t_ptr++ = NULL;

/* Skip to the end of the line						*/
	if (rd2lf(fd) == FAIL)  return(gsfail());

/* If the first character of the new 'line' is not # or ' or ; it is a	*/
/* continuation of the same assignment					*/
	while (TRUE) {
	    if ((c = getc()) == ';') {
		if (rd2lf(fd) == FAIL)  return(gsfail());
	    }
*USE
Portability	Level 4 (Assembler and dependancy on Gemini hardware)
Parent Module	SET, SETUP etc
Revision History:
28/12/90 Cursor turned off unless required - ICFO
         On completion of verification program returns to main "'F'
         to format" message.  This involved a number of changes to clear
         screen instructions - ICFO
06/11/89 Call to 'image' moved into main loop so that 'no skew' is
         reset for subsequent discs before formatting reserved tracks
         (BR520)
         (Change in SETFD / FMTDISC) - ICFO
         'home' changed to 'd_home' to avoid confusion with 'home' in
         terminal library for cursor positioning - ICFO
05/11/89 <return> no longer valid response for 'Which Drive' or
         leaving the finger too long on the <return> key when
         invoking FORMAT could cause Drive 'minflop' to be
         formatted.  Also only one character is allowed to fix
         BR44 (typing 'esc' could format 'E')
         (Change in SETFD / MFBDRV) - ICFO
22/10/89 Brought up to Timeclaim standards - ICFO
03/10/85 Added image() call following Initialisation.
         This is because the read of the .INI file destroyed
         the memory track image, and resulted in garbage
         formatting on a repeated format operation.
18/09/85 Added 'Initialisation' option that will add info
         from a .INI file to the disc after it has been
         formatted.
04/09/85 Correction so that 'double' is set correctly
         when extracting info from the BIOS tables
10/06/85 Version 3.0
         Revamped for GM849 + MFB II
24/08/84 No. of keypresses reduced.
30/03/84 Verify only option added.
         Drive stepping at the correct rate.
         Written by David Parkinson
        (c) dci software 1983, 1984
*/

{

/* Module dealing with disc formatting.					*/

STATIC
WORD	c,		/* Character from the operator			*/
	track,
	sector,
	side,
	size,
	status,
	init;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (abort(0) != 0)  CLEANUP;		/* Set ESCape route		*/

initvar();
clreos(3,0);
fmtid[0] = init = 0;
getdfa();				/* Locate a Format & drive	*/
if (lspt != 0 )  restrk = 0;		/* Remove 'no skew' if funny 	*/
cur_off();
while (TRUE) {
    while (TRUE) { 
	image();			/* Set up a track image		*/
	f_start();			/* So hopper feed(?) can load??	*/
	if (initdrv() == 'F') {		/* Restore/ check for disc 	*/
	    fmthead("**** Formatting ****");
	    track = 0;
	    if (abort(0) != 0) {
		putsat(20 RC 24,"Error during formatting");
		if ((status & 0x80) != 0)  error("Drive not ready");
		if ((status & 0x40) != 0)  error("Disc Write Protected");
		if ((status & 0x20) != 0)  error("Write Fault");
		abort(-1);		/* Remove ESCape linkage	*/
		break;
	    }
	    else {
		do {
		    putsat(9 RC 30,"Track --> ");
		    put2d(track);
		    for (side = 0; side < spd; ++side) {
			nexttrk(track,side);	/* Next track/side	*/
			if ((status = 
				wrttrk(FMTCMD,(invside == 'Y' && spd == 1)
					      ? 1 : side)) != 0) abort(1);
		    }
		    seek(1);		/* Step in one track		*/
		    ++track;
		    if (const() == ESC)  track = fmttrk;/* User BREAK	*/
		} while (track < fmttrk);
		d_home();		/* Restore to track 0		*/
		if (init_disk() != SUCCESS)  CLEANUP;
		abort(-1);		/* Remove ESCape link		*/
	    }
	}
	while (TRUE) {
	    status = verify();		/* Verify the disc		*/
	    if (f_end(status) != 0) {
		status = 1;
		break;
	    }
/*	    if (status == 0)  break;	/* Break if all ok		*/
/*	    putsat(23 RC 20,					!!!!!!!!*/
/*			"Verification errors - press <Return> to repeat");
/*	    while ((c = getkey()) != CR && c != ESC)  continue;	!!!!!!!!*/
/*	    if (c == ESC)  break;				!!!!!!!!*/
/*	    clreos(23,0);					!!!!!!!!*/
/*	    putsat(23 RC 35,"Please wait a moment");		!!!!!!!!*/
	    d_home();
	    break;
	}
/*	if (status == 0)  break;				!!!!!!!!*/
	break;
    }
    if (autofl != 0)  CLEANUP;		/* Break if autorun		*/
/*    waitcr();							!!!!!!!!*/
}

cleanup:

cur_on();

abort(-1);				/* Remove ESCape linkage	*/

}

/*======================================================================*/
/*
.he                                                             SETFD(GETDFA)
.pa
*/
/*======================================================================*/
VOID        /*								*/
getdfa()    /* Find out which Format to use & which drive to operate on */
/*======================================================================*/

{

/* Find out which Format to use & which drive to operate on and modify	*/
/* the heading to reflect this						*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (mfbdrv() != SUCCESS)  nmfbdrv();	/* Get one or the other		*/

stepr  = drive->stepr;			/* Set correct rates		*/
settle = drive->settle;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFD(FMT	    else if (c == '#' || c == '\'')  break;
	    if (rd2lf(fd) == FAIL)  return(gsfail());
	}
    }

/* Ask the operator to choose						*/
    if ((choice = bigmen(asgn_no,text,(sdtype == SOURCE) ? 50 : 51))
				      == FAIL)  return(gsfail());
}

/* We've now got the disc address of the required assignment so read it	*/
/* into memory								*/
if (spseek(fd,(a_ptr0 + choice)->as_addr - 1,0) == FAIL) {
    flerr(sfile,37);
    return(gsfail());
}
if ((n_bytes = read_as(sfile)) == (WORD) FAIL)  return((BYTE *) FAIL);

realloc(sect,n_bytes);

spclose(fd);

return(sect);

}

/*======================================================================*/
/*
.he                                                  SYSMAN(SECHAN / READ_AS)
.pa
*/
/*======================================================================*/
STATIC WORD                                    /*			*/
read_as(sfile)                                 /* Read in an assignment */
BYTE	*sfile;		/* File name of assignment file			*/
/*======================================================================*/

{

LOCAL
WORD	stcnt;		/* Number of strings held in a line		*/

LOCAL
BYTE	*sptr;		/* Working byte pointer				*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Point the working pointer to the start of the area			*/
sptr = sect;

/* Store the assignment name						*/
if ((c = getc()) == -1 || c == 0x1a) {
    flerr(sfile,37);
    return((WORD) gsfail());
}
while (c != '\'') {
    *sptr++ = c;
    if ((c = getc()) == -1 || c == 0x1a) {
	flerr(sfile,37);
	return((WORD) gsfail());
    }
}

/* Terminate the field with a NULL					*/
*sptr++ = NULL;

/* Initialise the number of items on this 'line'			*/
stcnt = 1;

/* Skip over the WhiteSpace						*/
while (isspace(c = getc()) == TRUE || c == '\r') ;/* Do nothing loop	*/

/* Store the first character of the item				*/
if (c == -1 || c == 0x1a) {
	flerr(sfile,37);
	return((WORD) gsfail());
}
*sptr++ = c;

/* Set loop to count the rest of the items				*/
while (stcnt < EPERLIN) {

/* Read in the next item						*/
    while (isspace(c = getc()) == FALSE && c != '\r') {
	if (c == -1 || c == 0x1a) {
	    flerr(sfile,37);
	    return((WORD) gsfail());
	}
	*sptr++ = c;
    }

/* Count the item							*/
    ++stcnt;

/* Terminate the field with a NULL					*/
    *sptr++ = NULL;

/* Skip over the WhiteSpace						*/
    while (isspace(c = getc()) == TRUE || c == '\r') ;

/* Store the first character of the item				*/
    if (c == -1 || c == 0x1a) {
	flerr(sfile,37);
	return((WORD) gsfail());
    }
    *sptr++ = c;

/* Skip the line if it is a comment					*/
    while (c == ';') {
	if (rd2lf(fd) == FAIL)  return((WORD) gsfail());
	--sptr;
	while (isspace(c = getc()) == TRUE || c == '\r') ;/* Do nothing	*/
	if (c == -1 || c == 0x1a) {
	    flerr(sfile,37);
	    return((WORD) gsfail());
	}
	*sptr++ = c;
    }
}

return(sptr - sect - 1);

}

/*======================================================================*/
/*
.he                                                     SYSMAN(SECHAN / GETC)
.pa
*/
/*======================================================================*/
STATIC WORD             /*						*/
getc()                  /* Get a character from the file opened on 'fd' */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return(spgetc(fd));

}

/*======================================================================*/
/*
.he                                                   SYSMAN(SECHAN / GSFAIL)
.pa
*/
/*======================================================================*/
STATIC BYTE                     /*					*/
*gsfail()                       /* Action failure in 'getsect' function */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (fd > 0)  spclose(fd);
if (sect > 0)  spfree(sect);

return((BYTE *) FAIL);		/* All error functions return FAIL	*/

}

/*======================================================================*/
E                     /*					*/
*gsfail()                       /* Action failure in 'getsect' function */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееHEAD)
.pa
*/
/*======================================================================*/
VOID                                                /*			*/
fmthead(op)                                         /* Put up a heading */
BYTE	*op;					/* String to output	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/*clreos(3,0);							!!!!!!!!*/
move(4,30);
putstr("Drive is ");
putstr(drive->id);
move(5,30);
putstr("Format is ");
putstr(fmtid);
putsat(7 RC 30,op);
if (strlen(op) != 0)  clreol();
move(9,30);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFD(NMFBDRV)
.pa
*/
/*======================================================================*/
VOID                      /*						*/
nmfbdrv()                 /* For a Non-MFB system request a format name */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (TRUE) {
    fdl = ' ';				/* No drive number..look up??	*/
    qlist();				/* Display the formats		*/
    getfcode();				/* Get one			*/
    double = 0;				/* Single stepping		*/
    if ((pda = fnddrv()) != -1)  break;
    if (fmttpi == 48 ) {		/* Try for a double step	*/
	fmttpi = 96;
	double = 1;			/* Try again with DS option	*/
	if ((pda = fnddrv()) != -1)  break;
    }
    error("No drive supports this format");
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETFD(MFBDRV)
.pa
*/
/*======================================================================*/
STATUS                                            /*			*/
mfbdrv()                                          /* Get a drive letter */
/*======================================================================*/

{

/* For an MFB system get a drive letter and work from  there		*/
/* Returns SUCCESS if everything is Ok, else returns FAIL		*/

LOCAL
BYTE	*p;

LOCAL
WORD	d;

STATIC
BYTE	dls[] = { "ABCDEFGHIJKL" };

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (abort(0) != 0 || mfb == 0) {
    abort(-1);				/* Unlink			*/
    return(FAIL);			/* Try alternate prompt		*/
}
while (TRUE) {
    d = 'A' + numwin;			/* Starting drive		*/
    move(8,16);
    putstr("Which Drive? [");
    conout(d);
    putstr(" - ");
    conout('A' + *ndrives - 1);
    putstr(" or <ESC>]");
    clreol();
    if (reqdrv == -1) {
	dls[*ndrives] = NULL;
	d = getltr(8 RC 46,NULL,&dls[numwin]);
	while (buffer[0] == NULL || buffer[1] != NULL) {
	    if (buffer[1] != NULL) {
		error("Only one character required");
		smove(8 RC 46);
		for (d = 0; d < strlen(buffer); ++d)  conout(' ');
	    }
	    d = getltr(8 RC 46,NULL,&dls[numwin]);
	}
    }
    else d = reqdrv;
    fdl = d;				/* Save letter			*/
    d -= 'A';				/* Compute drive number		*/
    p = drvtab + d * 16;
    pda = *p;				/* Set drive address		*/
    double = (*(p + STEP) & 128);
    p = fdtext + d * 18;		/* Pick up name....		*/
    strcpy(fmtid,p);			/* ...and format....		*/
    d = ttl[pda & 7];			/* Correct address for search	*/
    for (drive = hardware; drive->id[0]; ++drive) {
	if (d == drive->addr)  break;	/* Locate drive */
    }
    if (drive->id[0] == 0) {
	error("Drive is undefined");
	continue;
    }
    if (getfmt() == 0) {
	error("Format is undefined");
	continue;
    }
    abort(-1);				/* Unlink ESCape route		*/
    break;
}

move(8,0);
clreol();

return(SUCCESS);

}
/*======================================================================*/
/*
.he                                                              SETFD(IMAGE)
.pa
*/
/*======================================================================*/
VOID       /*								*/
image()    /* Construct an image of the track format in the data buffer */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = data;				/* Point to the data area	*/
if (index == 'Y')  indexmark();
putgap(gap1);
for (i = 0; i < spt; ++i) {		/* Construct Basic image	*/
    put(1,0xFE);
    put(2,0);
    put(1,i + frstsec);			/* Sector number		*/
    put(1,sizef);
    put(1,0xF7);			/* CRC 				*/
    putgap(gap2);
    putdata();
    putgap(gap3);
    if ((p - data + bps*2 - bufsiz) > 0) {
	error("Track too long for buffer!!!");
	break;
    }
}
i = p - data;				/* Current length 		*/
i = bufsiz - i - 15;
put(i,fmtbyt);				/* Pad out rest of the buffer	*/
p = data;				/* Find first sector header	*/
while (*p++ != 0xFFFE)  continue;
first = p;				/* First sector			*/
while (*p++ != 0xFFFE)  continue;	/* Locate the next	ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(SETOVR)
.pa
*/
#include	"amie.h"
#include	"sysman.h"
#include	"disc.h"
#include	"dformat.h"

/* This module is very dependant upon AMIE and, in particular, assumes	*/
/* that the two drives are set up as 'minflop' and 'minflop + 1'.  This	*/
/* is done in the initialisation code of AMIE				*/

#define		STLENGTH	167	/* Length of sec. tran. table	*/
					/* Depends on number set in BIOS*/

#define		NODRIVE		-1	/* }				*/
#define		WORKSPACE	-2	/* } Error returns		*/
#define		NOSPACE		-3	/* }				*/

/* Side change techniques						*/
#define		C_fmt		0x40	/* CYLINDRICAL			*/
#define		U_fmt		0x20	/* U format (like SEQUENTIAL)	*/
#define		T_fmt		0x10	/* TOGGLE			*/
#define		fB_fmt		0x30	/* BUTLER (in FORMATS.DAT)	*/
#define		dB_fmt		0x04	/* BUTLER (in Drive Table)	*/

#define		H_BIT		0x04

#define		CPM		0	/* Operating system types	*/
#define		MSDOS		1

STATIC
struct	drvtbl	bdrv;			/* Drive table			*/

STATIC
struct	dpblk	dpbf;			/* Disc parameter block		*/

STATIC
struct	dformat	secbuf;			/* 128 bytes from FORMATS.DAT	*/

STATIC
struct	ddf	*drive;

STATIC
BOOLEAN	double;				/* Double step flag for 48/96	*/

STATIC
BYTE	fmtid[9],			/* Format name			*/
	tfl[] = { 1, 2, 3, 0, 5, 6, 7, 4 };	/* - from logical	*/

STATIC
WORD	dn,				/* Drive number			*/
	fmtdrv,				/* Format drive type required	*/
	schange,			/* Side change flag		*/
	clock,				/* Data transf. rate		*/
	fmttpi,				/* Tracks-per-inch required	*/
	fmttrk,				/* Tracks-per-disc required	*/
	spt,				/* Sectors-per-track		*/
	bps,				/* Bytes-per-sector		*/
	spd,				/* Sides-per-disc		*/
	sizef,				/* Size field of sector 	*/
	lspt,				/* Logical sectors per track	*/
	systyp,				/* System type flag		*/
	splexm,				/* Non-standard extent mask  	*/
	fatid,				/* FAT ID byte			*/
	bufsiz,				/* Buffer size  		*/
	defdrv;				/* Default drive		*/

EXTERN
struct	disctb	*dtbl;

EXTERN
struct	drvtbl	*drvtab;

EXTERN
struct	dpblk	*dpb;

EXTERN
struct	dphdr	*dph;

EXTERN
struct	dtext	*fdtext;

EXTERN
WORD	state[4][4];		/* BEWARE if the 4 needs to change	*/

/*======================================================================*/
WORD                                                  /*		*/
setovr(sframe,sdtype)                                 /* Patch the BIOS */
struct	ssf	sframe[];/* SOURCE / DEST versions of setup structure	*/
WORD	sdtype;		/* 0 = SOURCE  1 = DEST				*/
/*======================================================================*/
/*USE
Portability	Level 4 (Depends on BIOS)
Parent Module	System Manager
Revision History:
08/01/90 Much modified and fitted more closely into the AMIE
         environment - ICFO
         No check for changed discs ('dpb_cks' and 'dph_alv' set to
         zero) - ICFO
29/06/89 'strcpy' removed (we have it in TLIB) - ICFO
         'ldirm' changed to 'cpymem' (and order of arguments
         changed) - ICFO
         'upper' and 'numeric' removed because they wer	*/
offset = p - first;			/* Offset from then on		*/

}

/*======================================================================*/
/*
.he                                                            SETFD(INITDRV)
.pa
*/
/*======================================================================*/
WORD           /*							*/
initdrv()      /* Intialise the drive ready for formatting or verifying */
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

fmthead("");
flashin();				/* Wait for the disc		*/
if (autofl == 0) {
    putsat(23 RC 15,"'F' to Format, ESC to exit, ");
    putstr("any other key to Verify");
    if ((n = upper(getkey())) == ESC)  abort(1);
}
else  n = 'F';

clreos(11,0);	
flashin();				/* Confirm disc is there	*/
waitsec();				/* Wait one second		*/

return(n);

}

/*======================================================================*/
/*
.he                                                            SETFD(FLASHIN)
.pa
*/
/*======================================================================*/
VOID              /*							*/
flashin()         /* Flash a message until a disc is there in the drive */
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n = 1;
while (wdisc() == 0) {
    if (n != 0) {
	move(9,0);
	clreol();
	n = 0;
    }
    else {
	putstr("\t\t\tInsert the Disc in the drive");
	n = 1;
    }
    if (const() == ESC)  abort(1);		/* Abort on ESCAPE	*/
}

move(9,0);
clreol();

}

/*======================================================================*/
/*
.he                                                              SETFD(WDISC)
.pa
*/
/*======================================================================*/
WORD         /*								*/
wdisc()      /* Spend a while waiting for a disc to appear in the drive */
/*======================================================================*/

{

/* Return NZ when the disc appears					*/

LOCAL
WORD	t;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

for (t = 0; t < 3; ++t)	{
    if (d_home() == 4)  return(hole());		/* Zero the head	*/
    if (const() == ESC)  abort(1);		/* Possible abort	*/
}

return(0);

}

/*======================================================================*/
/*
.he                                                               SETFD(HOLE)
.pa
*/
/*======================================================================*/
WORD                               /*					*/
hole()                             /* Perform a check for an Index hole */
/*======================================================================*/

{

/* Perform a check for an Index hole to confirm that there is a disc	*/
/* actually present in the drive					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	in	a,(STSREG)	; Read current value
	ld	e,a		; Save in E
	ld	d,0		; Clear D
	ld	l,d		; Set the timeout count
	ld	a,(ms)
	ld	h,a
hloop:	in	a,(STSREG)	; Read status
	xor	e		; Compare against E
	or	d		; Save result in D
	ld	d,a
	dec	hl		; Check the timeout
	ld	a,h
	or	l
	jr	nz,hloop
	ld	a,d		; Check for a change in INDEX
	and	2
	ld	l,a
	.8080
#endasm

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                                SETFD(PUT)
.pa
*/
/*======================================================================*/
VOID                   /*						*/
put(i,c)               /* Put a certain number of bytes into the buffer */
WORD	i;			/* Number of times to put the character	*/
BYTE	c;			/* Character to put			*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	pop	hl
	pop	de
	pop	bc
	push	bc
	push	de
	push	hl
	ld	hl,(p)			; Load buffer pointer
ptlp:	ld	(hl),e
	inc	hl
	dec	bc
	ld	a,b
	or	c
	jp	nz,ptlp
	ld	(p),hl
	.8080
#endasm

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETFD(PUTGAP)
.pa
*/
/*======================================================================*/
VOID                                     /*				*/
putgap(i)                                /* Put a "gap" into the buffer */
WORD	i;				/* Number of bytes in the "gap"	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

switch (density) {

    case 'S':
	put(i - 6,0xFF);
	put(6,0);
	break;

    case 'D':
	put(i - 15,0x4E);
	put(12,0e not used - ICFO
18/05/88 Symbol state table made external for AMIE V05 - ICFO
14/03/88 'fnddrv' rewritten to introduce the state table.  The state
         table is held in this file for AMIE V4.  For AMIE V5 it
         will be transferred to 'sethw' - ICFO
22/12/87 Workspace is only needed for CP/M. Trouble if attempt to set
         it up for MSDOS - PN
15/12/87 Function 'dpbentry' now sets up a 'proper' DPB for all
         operating systems except MSDOS in which case a non-standard
         one is set up - ICFO
21/06/86 Drive/system field modified from 4:4 to 2:6.  Allows for up
         to 63 types of operating  system.
10/06/85 Module introduced for MFB II & GM849.
         File record format now packed to allow room for MSDOS
         parameters etc
*/

{

LOCAL
WORD	status;

STATIC
STATUS	dptable();

STATIC
WORD	fnddrv(),
	setbios(),
	dtentry(),
	dpbentry();

STATIC
BYTE	*allst();

STATIC
VOID	cpmdpb(),
	odddpb(),
	movstr(),
	unpack();

#ifdef	BUG							/*!!!!!!*/
WORD	i;
#endif								/*!!!!!!*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

cpymem(sframe->fdata,&secbuf,128);
unpack();
movstr(fmtid,sframe->fmtnm,9);		/* Format name to global storage*/
defdrv = (sframe->fdriv >= 0) ? sframe->fdriv : -1;
dn = floppy[sdtype];
status = setbios();			/* Set up the BIOS		*/

#ifdef	BUG							/*!!!!!!*/
/************************************************************************/
/*           Display the results of our deliberations			*/
/************************************************************************/
putstr("\nDrive Number = ");
putnum(dn);
putstr(" Status = ");
putnum(status);
if (status >= 0) {
    putstr("\nDisc table = ");
    put2hex(dtbl);
    putstr("\n");
    i = 0;
    while (i < sizeof(struct disctb)) {
	puthex(*((BYTE *) dtbl + i++));
	putvid(' ');
    }
    putstr("\nDrive table = ");
    put2hex(&drvtab[dn]);
    putstr("\n");
    i = 0;
    while (i < sizeof(struct drvtbl)) {
	puthex(*((BYTE *) &drvtab[dn] + i++));
	putvid(' ');
    }
    putstr("\nDPB table = ");
    put2hex(&dpb[dn]);
    putstr("\n");
    i = 0;
    while (i < sizeof(struct dpblk)) {
	puthex(*((BYTE *) &dpb[dn] + i++));
	putvid(' ');
    }
    putstr("\nDPH table = ");
    put2hex(&dph[dn]);
    putstr("\n");
    i = 0;
    while (i < sizeof(struct dphdr)) {
	puthex(*((BYTE *) &dph[dn] + i++));
	putvid(' ');
    }
    putstr("\nDrive text table = ");
    put2hex(&fdtext[dn]);
    putstr("\n");
    i = 0;
    while (i < sizeof(struct dtext)) {
	puthex(*((BYTE *) &fdtext[dn] + i++));
	putvid(' ');
    }
    putstr(fdtext[dn].dtxt_format);
    putvid(' ');
    putstr(fdtext[dn].dtxt_drive);
    putstr("\nSector translate table = ");
    put2hex(dtbl->dct_transb);
    putstr("\n");
    i = 0;
    while (i < STLENGTH) {
	puthex(*((BYTE *) dtbl->dct_transb + i++));
	putvid(' ');
    }
    getkey();
}
/************************************************************************/
#endif								/*!!!!!!*/

return(status);

}

/*======================================================================*/
/*
.he                                                  SYSMAN(SETOVR / SETBIOS)
.pa
*/
/*======================================================================*/
STATIC WORD              /*						*/
setbios()                /* Section of setup to patch the Bios directly */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (TRUE) {
    double = FALSE;			/* No double step yet		*/
    if ((bdrv.dvt_dadty = fnddrv()) != -1)  break;
    double = TRUE;			/* Try for double step maybe	*/
    fmttpi *= 2;			/* Temporarily double it	*/
    if ((bdrv.dvt_dadty = fnddrv()) != -1)  break;	/* Try again	*/
    return(NODRIVE);
}

/* Ok, now construct the BIOS info needed				*/
/* NB DON'T CHANGE ORDER 						*/
if (dtentry() == FAIL)  return(NOSPACE);/* Compute drive table entry	*/
dpbentry();				/* Compute disc parameter block	*/

/* Set up the Disc Parameter Header					*/
/* Force termination if workspace overflow				*/
if (dptable() == FAIL)  return(WORKSPACE);

return(dn);

}

/*======================================================================*/
/*
.he                                                   SYSMAN(SETOVR / FNDDRV)
.pa
*/
/*======================================================================*/
STATIC WORD                                  /*				*/
fnddrv()                                     /* Select a suitable drive */
/*======================================================================*/

{

/* Given a format, locate the appropriate drive to use.			*/
/* Returns the drive address if found, otherwise -1			*/
/* Also uses DEFDRV if one is given.					*/

LOCAL
WORD	d,
	h,
	klock,
	bits3n7;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

drive = hardware;
while (drive->ddfname[0] != NULL) {);
	put(3,0xF5);
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                          SETFD(INDEXMARK)
.pa
*/
/*======================================================================*/
VOID                            /*					*/
indexmark()                     /* Insert an Index mark into the buffer */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

switch (density) {

    case 'S':
	put(40,0xFF);
	put(6,0);
	break;

    case 'D':
	put(80,0x4E);
	put(12,0);
	put(3,0xF6);
}

put(1,0xFC);		/* Index mark */

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFD(PUTDATA)
.pa
*/
/*======================================================================*/
VOID                                          /*			*/
putdata()                                     /* Insert the sector data */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

put(1,0xFB);				/* Data mark			*/
put(bps,(invert == 'Y') ? ~fmtbyt : fmtbyt);	/* Unary ones complement*/
put(1,0xF7);				/* CRC bytes			*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFD(NEXTTRK)
.pa
*/
/*======================================================================*/
VOID                    /*						*/
nexttrk(track,side)     /* Update the track / side / sector information */
WORD	track,					/* New track number	*/
	side;					/* New side		*/
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (track == restrk)  skewsecs();
p = first;
for (n = 0; n < spt; ++n) {
    *p = track;
    *(p + 1) = (side != 0) ? sidef : sidef >> 8;
    p += offset;
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                           SETFD(SKEWSECS)
.pa
*/
/*======================================================================*/
VOID                        /*						*/
skewsecs()                  /* Physically skew the sectors if necessary */
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (makepst() != 0) {
    p = first + 2;
    for (n = 0; n < spt; ++n) {
	*p = psecnum[n];
	p += offset;
    }
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETFD(FIREUP)
.pa
*/
/*======================================================================*/
WORD           /*							*/
fireup()       /* Start up the drive and ensure that the head is loaded */
/*======================================================================*/

{

/* Returns <A> = return status of 1797.					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	a,(pda)		; Ensure drive addressed & the
	and	0F7h		;   ... (clear side bit) ...
	out	(DRVPRT),a	; drive motor is running
	ld	b,2		; Use B & HL for possible time out
mt00:	ld	hl,0
moton:	in	a,(DRVPRT)	; Check ready
	and	07eh
	jr	z,go$on		; Continue if Ok
	dec	hl		; ... else check the timeout
	ld	a,h
	or	l
	jr	nz,moton
	djnz	mt00
go$on:	in	a,(TRKREG)	; Issue a SEEK to the current track
	out	(DATREG),a	; This ensures the head is loaded
	ld	a,SEEKCM
	call	dti
dnr:	ld	l,a		; Return in A & HL
	ld	h,a
	.8080
#endasm

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETFD(D_HOME)
.pa
*/
/*======================================================================*/
WORD                                      /*				*/
d_home()                                  /* Home the head of the drive */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if ((fireup() & 4) == 0)  return(seek(-127));
else			  return(4);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                               SETFD(SEEK)
.pa
*/
/*================================================================

/* No match if address doesn't match any default			*/
    d = drive->ddfadr;

#ifdef	BUG
putstr("\nD = ");
putnum(d);
putstr(" Defdrv = ");
putnum(defdrv);
getkey();
#endif

    if (defdrv == -1 || defdrv == d) {

/* Set the values for bits 3 and 7 if valid				*/
	h = ((fmtdrv & H_BIT) != 0) ? 2 : 0;
	klock = (clock == 'H') ? 1 : 0;
	bits3n7 = state[drive->ddfhso - 'A'][h + klock];

#ifdef	BUG
putstr("\nH = ");
putnum(h);
putstr(" Klock = ");
putnum(klock);
putstr(" Bits3n7 = ");
putnum(bits3n7);
putstr("\nDrive TPI = ");
putnum(drive->ddftpi);
putstr(" Fmttpi = ");
putnum(fmttpi);
putstr(" Drive type = ");
putnum(drive->ddftyp);
putstr(" Fmtdrv = ");
putnum(fmtdrv);
putstr("\nDrive track = ");
putnum(drive->ddftrk);
putstr(" Fmttrk = ");
putnum(fmttrk);
putstr("\nDrive sides = ");
putnum(drive->ddfsde);
putstr(" Spd = ");
putnum(spd);
getkey();
#endif

	if ((drive->ddftpi & 0xfe) == (fmttpi & 0xfe)
	&& ((drive->ddftyp & 0xff) ==  fmtdrv
				      || (drive->ddftyp & 0x03) == fmtdrv)
	&& fmttrk <= (drive->ddftrk & 0xff)
	&& spd <= drive->ddfsde
	&& bits3n7 != -1)  break;
    }
    ++drive;
}
if (drive->ddfname[0] == NULL)  return(NODRIVE);	/* Not found	*/

d = tfl[d & 0x07];			/* Allow for skewed addresses	*/
if (clock == 'H')  d += 32;
if ((secbuf.f_dsid & 0x04) == 0)  d += 16;	/* Single density	*/

d += bits3n7;

return(d);

}

/*======================================================================*/
/*
.he                                                  SYSMAN(SETOVR / DTENTRY)
.pa
*/
/*======================================================================*/
STATIC STATUS                                 /*			*/
dtentry()                                     /* Set up the Drive Table */
/*======================================================================*/

{

/* Drive and Format have been found.					*/
/* Now compute "Drive Table" entry for the BIOS.			*/
/* NB>>> Must  be called before DPBENTRY, as sets logical sectors per	*/
/* track properly							*/
/* 'bdrv.dvt_dadty' is already set					*/

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i = bps / 128;				/* Bytes per sector		*/
for (bdrv.dvt_ps = 0; i > 1; ++bdrv.dvt_ps)  i /= 2;
bdrv.dvt_pm = (bps / 128) - 1;		/* Physical sector mask		*/
bdrv.dvt_sidec = secbuf.f_fsec & 0x01;	/* Flag byte ..1st sec		*/
switch (schange) {
    case 'S':				/* Flag 'S' format		*/
	break;

    case 'T':				/* Flag 'T' format 		*/
	bdrv.dvt_sidec += T_fmt;
	break;

    case 'U':				/* Flag 'U' format		*/
	bdrv.dvt_sidec += U_fmt;
	break;

    case 'C':				/* Flag 'C' format		*/
	bdrv.dvt_sidec += C_fmt;
	break;

    case 'B':				/* Flag 'B' format		*/
	bdrv.dvt_sidec += dB_fmt;
	break;
}
if ((secbuf.f_dsid & 0x80) != 0)  bdrv.dvt_sidec += 0x80;/* Invert data	*/
if ((secbuf.f_odds & 0x20) != 0)  bdrv.dvt_sidec += 0x08;/* Invert side	*/

/* Disable check of side field if non-standard value			*/
if ((secbuf.f_sb0 * 256 + secbuf.f_sb1) !=  1)  bdrv.dvt_sidec += 2;
bdrv.dvt_pt = spt - 1;		/* Last sector number before swap	*/
bdrv.dvt_dblm = (secbuf.f_bksz * 1024) / 128 - 1;
bdrv.dvt_step = drive->ddfstp - 3;	/* Always fast step on 829	*/
if (bdrv.dvt_step < 0)  bdrv.dvt_step = 0;/* In case underflow		*/
if (double == TRUE)  bdrv.dvt_step += 0x80;/* Set MSB if to double step	*/
bdrv.dvt_settl = drive->ddfstl;
bdrv.dvt_hdlod = drive->ddfhdl;
bdrv.dvt_maxtrk = fmttrk - 1;

/* Do sector translate							*/
if ((bdrv.dvt_sectrn = allst()) == NOSPACE)  return(FAIL);

/* Set Logical Sectors Per Track if needed				*/
i = spt * (bps / 128);
if (schange == 'C')  i *= spd;
if (lspt != 0 && lspt != i)  bdrv.dvt_lsect = lspt;	/* Set if funny	*/
else {
    lspt = i;				/* Set for DPBENTRY!		*/
    bdrv.dvt_lsect = 0;
}

/* Set system type flag							*/
bdrv.dvt_opsys = systyp;
if (spd == 2)  bdrv.dvt_opsys |= 0x80;		/* Mark double sided	*/

if (secbuf.f_sctr[0] != -1 && schange != 'C') {
    bdrv.dvt_sidec &= 0xfe;		/* Translate set correct sector#*/
    ++bdrv.dvt_pt;			/* Prevent false change 	*/
}

bdrv.dvt_toffset = secbuf.f_toffset;	/* Transfer 'tskew' parameter	*/
bdrv.dvt_tskew = secbuf.f_tskew;

/* Index into table and copy over					*/
cpymem((BYTE *) &bdrv,(BYTE *) &drvtab[dn],sizeof(struct drvtbl));

/* Copy over Format information						*/
strcpy(fdtext[dn].dtxt_format,fmtid);

/* Copy over Drive ID 							*/
strcpy(fdtext[dn].dtxt_drive,&drive->ddfname[0]);

return(SUCCESS);

}

/*======================================================================*/
/*
.he                                                 SYSMAN(SETOVR / DPBENTRY)
.pa
*/
/*======================================================================*/
STATIC VOID                          /*					*/
dpbentry()                           /* Set up the Disc Parameter Block */
/*======================================================================*/

{

/* Compute the disc parameter block entry				*/
/* For an M======*/
WORD                               /*					*/
seek(rtrack)                       /* Seek in or out a number of tracks */
WORD	rtrack;			/* Signed number of tracks to seek	*/
/*======================================================================*/

{

/* Includes a check for track 0 so can be used in place of RESTORE.	*/
/* Uses the drive parameters to achieve the max possible step rate.	*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

fireup();			/* Get drive going			*/

#asm
	.z80
	pop	de		; Get the RTRACK parameter
	pop	hl
	push	hl
	push	de
	ld	a,l		; Check direction/value
	or	a
	ret	z		; Return if it was zero
	ld	c,STEPIN	; In case IN
	bit	7,a
	jr	z,stepo		; Skip if so
	neg
	ld	c,STEPOUT	; Set for OUT
stepo:	ld	b,a		; Count to B
;	Achieve the 3 ms step rate
	ld	a,(pda)		; Get drive addresss
	push	af
	or	20h		; Works with GM829....
	out	(DRVPRT),a	; ...makes an 8"
step:	ld	a,c		; Command to A
	call	dti		; Do it
	push	af		; Save status return
	ld	a,(double)	; See if double stepped
	or	a
	jr	z,onestp	; Skip if no double step
	ld	a,(stepr)	; Do any delay
	sub	3
	call	nc,delay	; Wait
	ld	a,c		; Get command
	and	11101111b	; No track update
	call	dti		; Do it
onestp:	ld	a,(stepr)
	and	7fh
	sub	3	
	call	nc,delay
	pop	af		; Check status return
	and	4		; Track 0?
	jr	z,not0		; No, skip
	xor	a		; Clear TRK reg
	out	(TRKREG),a
	ld	b,1		; No more stepping
not0:	djnz	step		; Loop if more
	pop	af		; Reset drive type
	out	(DRVPRT),a
	ld	a,(settle)	; Add settling time
	call	delay
	in	a,(STSREG)
	ld	l,a		; Move to HL
	ld	h,0
	ret

;	Do a Type I command

dti:	out	(CMDREG),a	; Issue command
	ld	a,(ms)		; Get seed
	sub	76		; 4MHz clock?
	ld	a,10
	jr	c,dtid		; Yes ==>
	ld	a,20		; Increase delay
dtid:	dec	a
	jr	nz,dtid
dtiw:	in	a,(STSREG)	; Read status
	bit	0,a		; Busy?
	jr	nz,dtiw		; Yes,loop
	ret			; Else done

; Short delay for <A> ms

delay:	or	a		; Immediate return
	ret	z		; ...if zero
	push	bc
	ld	b,a
msdel0:	ld	a,(ms)		; Set count
msdel1:	ex	(sp),hl
	ex	(sp),hl
	dec	a		; Delay
	jr	nz,msdel1
	djnz	msdel0
	pop	bc
	ret
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                            SETFD(WAITSEC)
.pa
*/
/*======================================================================*/
VOID                                            /*			*/
waitsec()                                       /* Delay for one second */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	ld	b,4
wsl:	ld	a,255
	call	delay
	djnz	wsl
	.8080
#endasm

}
	
/*======================================================================*/
/*
.he                                                             SETFD(WRTTRK)
.pa
*/
/*======================================================================*/
WORD                                         /*				*/
wrttrk(command,side)                         /* Write a track image out */
WORD	command,				/* Write command	*/
	side;					/* Side to write	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	pop	hl
	pop	bc		; Side to C
	pop	de		; Command to E
	push	de
	push	bc
	push	hl
	ld	a,(frstsec)	; Set first sector
	out	(SECREG),a	; (may be used)
	ld	a,c		; Side to A
	add	a,a
	add	a,a
	add	a,a		; Shift up to side position
	ld	l,a
	ld	a,(pda)		; Keep drive going
	and	0F7h		; Mask out any side
	add	a,l		; Set correct side
	ld	(pda),a
	out	(DRVPRT),a
	ld	a,e		; WRTCMD or FMTCMD command
	out	(CMDREG),a	; Issue command
	ld	c,DRVPRT	; Point to status port
	ld	hl,(data)	; Point to buffer
wrt1:	ld	a,(hl)		; Get next byte ready
	inc	hl
wrt2:	in	b,(c)		; Wait
	jr	z,wrt2
	out	(DATREG),a
	jp	m,wrt1
	ld	a,5		; ..5ms delay?
	call	delay
	in	a,(STSREG)
	and	0fch
	ld	l,a
	ld	h,0
	.8080
#endasm	

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                          SETFD(INIT_DISC)
.pa
*/
/*======================================================================*/
STATUS             /*							*/
init_disk()        /* Initialise the disc from an INI file if necessary */
/*======================================================================*/

{

/* See if to do any special initialisation on completion of the		*/
/* formatting process. If so read the file xxxxxx.INI			*/
/*	File format is:							*/
/*	<number of entries>		(byte)				*/
/*	<track><side>  * N		(2N bytes)			*/
/*	---------------------------					*/
/*	<physical sector info> * N	Starts on 128 byte boundary	*/

LOCAL
BYTE	*p;

LOCAL
WORD	i,
	track,
	side,
	status,
	chan;

LOCAL
STATUS	rv;

/* - - - - - - - - - - - - - - SDOS machine this is rather cobbled & contrived.		*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

dpbf.dpb_spt = lspt;				/* Set sectors / track	*/
dpbf.dpb_dsm = fmttrk * spd * spt * (bps / 128);/* # 128 byte secs 	*/
switch (systyp) {

    case MSDOS:
	odddpb();
	break;

    default:
	cpmdpb();
	break;
}

/* Index into table and copy across					*/
cpymem((BYTE *) &dpbf,(BYTE *) &dpb[dn],sizeof(struct dpblk));

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                   SYSMAN(SETOVR / CPMDPB)
.pa
*/
/*======================================================================*/
STATIC VOID              /*						*/
cpmdpb()                 /* Set up a standard CP/M disc parameter block */
/*======================================================================*/

{

LOCAL
WORD	i,
	res;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i  = secbuf.f_bksz;
for (dpbf.dpb_bsh = 3; i > 1; i /= 2)  ++dpbf.dpb_bsh;
dpbf.dpb_blm = bdrv.dvt_dblm;

/* Remove reserved tracks						*/
dpbf.dpb_dsm -= ((secbuf.f_rstk & 0xff) * lspt);
i = secbuf.f_bksz * 8;			/* Sectors per block		*/
dpbf.dpb_dsm = dpbf.dpb_dsm / i - 1;	/* Size in blocks		*/
dpbf.dpb_exm = (dpbf.dpb_dsm > 255) ? secbuf.f_bksz / 2 - 1
				    : secbuf.f_bksz - 1;
if ((secbuf.f_exm & 0xff) != '*')	/* Strange setting		*/
			       dpbf.dpb_exm = (secbuf.f_exm & 0xff) - '0';
/* Special case egITT3030 where whole disc isn't used			*/
if (secbuf.f_bksz == 1 && dpbf.dpb_dsm > 255) {/* Invalid condition	*/
    dpbf.dpb_dsm = 255;			/* Restrict the size		*/
    dpbf.dpb_exm = 0;			/* Ensure correct values	*/
}
dpbf.dpb_drm = secbuf.f_dir - 1;
i = secbuf.f_bksz * 32;			/* Directory entries per block	*/
i = (secbuf.f_dir + i - 1) / i;		/* Blocks per directory		*/
res = 0;				/* Reserved blocks		*/
while (i-- != 0)  res = res >> 1 | 0x8000;
dpbf.dpb_al0 = res >> 8;
dpbf.dpb_al1 = res;
dpbf.dpb_cks = 0;			/* No check for changed disc	*/
dpbf.dpb_off = secbuf.f_rstk & 0xff;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                   SYSMAN(SETOVR / ODDDPB)
.pa
*/
/*======================================================================*/
STATIC VOID        /*							*/
odddpb()           /* Set up a special version of a DPB for MS-DOS ONLY */
/*======================================================================*/

{

/* MSDOS system, create a non-standard DPB so processor can get		*/
/* information from disc tables						*/
/* Does not alter 'spt' or 'dsm'					*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

dpbf.dpb_drm = secbuf.f_dir;	/* NOTE - No -1				*/
dpbf.dpb_bsh = secbuf.f_boot;	/* Size of Boot Sector			*/
dpbf.dpb_blm = secbuf.f_sccl;	/* Sectors per Cluster			*/
dpbf.dpb_cks = secbuf.f_scft;	/* Sectors per FAT			*/
dpbf.dpb_exm = secbuf.f_medb;	/* Media Byte				*/
dpbf.dpb_al0 = secbuf.f_nfat;	/* Number of FATS - ASCII		*/
dpbf.dpb_al1 = secbuf.f_ftid;	/* FAT ID_medb;	/* Media Byte				*/
dpbf.dpb_al0 = secbuf.f_nfat;	/* Number of FATS - ASCII		*/
dpbf.dpb_al1 = secbuf.f_ftid;	/* FAT ID				*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                  SYSMAN(SETOVR / DPTABLE)
.pa
*/
/*======================================================================*/
STATIC STATUS                       /*					*/
dptable()                           /* Compute the disc parameter table */
/*======================================================================*/

{

/* All we have to do is set the vector to the allocation area		*/

LOCAL
WORD	wsize;		/* Size of workspace required for current format*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (systyp == CPM) {		/* Workspace needed only for CP/M	*/
    dph[dn].dph_csv = NULLPTR;	/* No check for changed disc		*/
    wsize = (dpbf.dpb_dsm + 1) / 8 + 1;
    if (dn == floppy[SOURCE]) {
	if ((dph[dn].dph_alv = dtbl->dct_biosend) + wsize >=
				       dph[dn + 1].dph_alv)  return(FAIL);
    }
    else {
	if ((dph[dn].dph_alv = MEMTOP - wsize) <= dph[dn - 1].dph_alv +
			 (dpb[dn - 1].dpb_dsm + 1) / 8 + 1)  return(FAIL);
    }
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                    SYSMAN(SETOVR / ALLST)
.pa
*/
/*======================================================================*/
STATIC BYTE            /*						*/
*allst()               /* Allocate memory to the sector translate table */
/*======================================================================*/

{

LOCAL
WORD	i,			/* General counter and # of ot- - - - - - - - - - - - - - - - - - - - -*/

if (sp_init != 'Y' )  return(SUCCESS);	/* Nothing to do		*/

fmthead("**** Initialising ****");
strcpy(buffer,fmtid);			/* Copy over the format name	*/
p = buffer;
while (*p++ != NULL)  continue;		/* Locate the end		*/
--p;					/* Back to the NULL		*/
strcpy(p,".INI");			/* Add the extension		*/
if ((chan = fopen(buffer,"rb")) == 0) {	/* Try to open the file		*/
    putsat(22 RC 23,"Cannot locate .INI file on drive A");
    rv = FAIL;
    CLEANUP;
}
read(chan,data,128);			/* Preliminary information	*/
ldirm(buffer,data,80);			/* Get to buffer		*/
p = &buffer[1];				/* Start of info		*/
i = 9;
while (buffer[0]-- != 0) {
    track = *p++;
    side  = *p++;
    putsat(i RC 30,"Track: ");
    ++i;
    putnum(track);
    putstr("   side: ");
    putnum(side);
    if (track < 0 || track > drive->trk
				     || side < 0 || side > drive->sides) {
	putsat(22 RC 27,"Illegal track / side value");
	rv = FAIL;
	CLEANUP;
    }
    else {
	read(chan,data,bps * spt);	/* Fill the buffer		*/
	d_home();
	seek(track);
	status = wrttrk(WRTCMD,(invside == 'Y' && spd == 1) ? 1 : side);
	if (status != 0x10 || getsec() != (spt + frstsec)) {
	    putsat(22 RC 29,"Error during INI write");
	    rv = FAIL;
	    CLEANUP;
	}
    }
}
rv = SUCCESS;

cleanup:

if (rv == FAIL) {
    putsat(23 RC 22,"Press <Return> or <Esc> to continue");
    while ((status = getkey()) != CR && status != ESC)  continue;
}

fclose(chan);
d_home();
image();				/* Set up the Image again	*/
wait(3);

return(rv);

}


/*======================================================================*/
/*
.he                                                             SETFD(GETSEC)
.pa
*/
/*======================================================================*/
WORD                                    /*				*/
getsec()	                        /* Return current sector number */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80
	in	a,(SECREG)
	ld	l,a
	ld	h,0
	.8080
#endasm

/* Let C/80 supply the return						*/

}

/*======================================================================*/
      /* Return current sector number */
/*======================================================================*/

{

/* ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееher drive	*/
	length;			/* Length of sector translation table	*/

LOCAL
BYTE	*p,			/* General BYTE pointer			*/
	*q,			/* General BYTE pointer			*/
	*transb,		/* Pointer to sector translation tables	*/
	*sb,			/* Pointer to translation table for	*/
				/* 		    SECTRAN translation	*/
	*sd;			/* Pointer to translation table for	*/
				/*		       BIOS translation	*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

sb = sd = NULLPTR;				/* No translation yet	*/
if (secbuf.f_sctr[0] != -1) {
    length = (schange == 'C') ? spt * 2 : spt;

/* Set up drive number of the other drive and the starting point for	*/
/* the Sector Translation Table						*/
    if (dn == floppy[SOURCE]) {
	i = dn + 1;
	transb = dtbl->dct_transb;
    }
    else {
	i = dn - 1;
	transb = dtbl->dct_transb + STLENGTH - length;
    }

/* If the other format uses a sector translation table check that there	*/
/* is room for this format's sector translation table			*/
    if (drvtab[i].dvt_sectrn != NULLPTR || dph[i].dph_xlt != NULLPTR) {
	if ((drvtab[i].dvt_sidec & C_fmt) != 0) {
	    if (length >= STLENGTH - drvtab[i].dvt_pt * 2)return(NOSPACE);
	}
	else {
	    if (length >= STLENGTH - drvtab[i].dvt_pt)  return(NOSPACE);
	}
    }

    cpymem(secbuf.f_sctr,transb,length); 	/* Copy over		*/

/* We must duplicate skew for the second side				*/
    if (schange == 'C' && length > 60 ) {
	q = (p = transb) + length / 2;
	for (i = 0; i < spt; ++i)  *q++ = *p++ + spt;
    }

/* Adjust for Lowest Sector Number					*/
    if (schange == 'C' && (secbuf.f_fsec & 0xff) != 0) {
	p = transb;
	for (i = 0; i < length; ++i)  *p++ -= 1;/* Remove what BIOS adds*/
    }
    if (bps / 128 > 1)  sd = transb;	/* If blocked, BIOS translation	*/
    else		sb = transb;	/* else SECTRAN translation 	*/
}

dph[dn].dph_xlt = sb;			/* Normal translation...	*/
return(sd);	     			/*	 ...blocked translation */

}

/*======================================================================*/
/*
.he                                                   SYSMAN(SETOVR / MOVSTR)
.pa
*/
/*======================================================================*/
STATIC VOID         /*							*/
movstr(d,s,l)       /* Move a string from 's' to 'd' for max length 'l' */
BYTE	*d,					/* Destination		*/
	*s;					/* Source		*/
WORD	l;					/* Number of characters	*/
/*======================================================================*/

{ 

/* Removes any trailing spaces from the string.				*/

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

i = 0;
while (i < l && (*d++ = *s++) != NULL)  ++i;

d -= 2;

while (i-- > 0 && *d == ' ')  *d--;

*(++d) = NULL;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                   SYSMAN(SETOVR / UNPACK)
.pa
*/
/*======================================================================*/
STATIC VOID                  /*						*/
unpack()                     /* Unpack a record after reading from disk */
/*======================================================================*/

{

/* NOTE 'lspt' can be computed in 'dtentry' to be greater than 128 so	*/
/* needs WORD to avoid any sign extension				*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

fmtdrv = ((secbuf.f_dvos >> 6) & 0x03);
if ((secbuf.f_odds & 0x80) != 0)  fmtdrv += H_BIT;/* Set the 'H' marker	*/
systyp = secbuf.f_dvos & 0x3f;
switch (secbuf.f_dsid & 0x70) {

    case C_fmt:
	schange = 'C';
	break;

    case fB_fmt:
	schange = 'B';
	break;

    case U_fmt:
	schange = 'U';
	break;

    case T_fmt:
	schange = 'T';
	break;

    default:
	schange = 'S';
	break;
}
spd	= (((secbuf.f_dsid & 0x02) != 0) ?  2  :  1 );
clock	= (((secbuf.f_dsid & 0x01) != 0) ? 'H' : 'L');
spt	= secbuf.f_phys & 0xff;
bps	= secbuf.f_ssiz * 128;
fmttpi	= secbuf.f_tpi[1] * 256 + secbuf.f_tpi[0];
fmttrk	= secbuf.f_trks[1] * 256 + secbuf.f_trks[0];
lspt    = secbuf.f_lspt;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
    default:
	schange = 'S';
	break;
}
spd	= (((secbuf.f_dsid & 0x02) != 0) ?  2  :  1 );
clock	= (((secbuf.f_dsid & 0x01) != 0) ? 'H' : 'L');
spt	= secbuf.f_phys & 0xff;
bps	= secbuf.f_ssiz * 128;
fmttpi	= secbuf.f_tpi[1] * 256 + secbuf.f_tpi[0];ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕT—UС 4dD»ASTEPRБФ—U`dd’DDХ8QIMAGEБТSТU†dd’DДT9aQQJWRTTRKБ—QRаdEфДф‘X%9%Q}MFBDRVБУУQРС†dФдDUДЎAUQBPUTБФUU ddƒ4ДШ]%QMWDISCБ”`e4іUu4X%IUBGETSECФАM~√•ј                         ЦА @ +4  `Яђ™  √ЉА,–  B 9D  ХЪ  0X"  EДј£  Ы| E@ сj І`  D  3@  |Z≤ѓ Д >-YWXЫEY† 6ІWOр…сj¬і`"ƒеf—p&Д  `Р  еf–P	сj ї`јQ !ЊбОVh  Ѕ`К∞И Ш }s м– Хgј4<5 Ќ  "ђ" & \ƒ{6… 2≠∞ ЖПЖєYґpВ*¬ `хћ 7≥mH*жАi†kХЫlј"ыэ ЌЃ`÷aЏ0nЎ Д<	rИj kХЫa ,V	 r≥@ Д  `–P  л`–h   Ђј,: *Ѕ†1 aя`V	 rК∞hХЫhB,ј е  ;ь2Ќ  T‘U}јlЏRЌЄ ™В! АuUГ@ђЏ~Ѕ`И∞И6Ы ≤™ЎД r≥nРЗAАD ХЫlВX"ђ #`Рh  rњ√'≈Ђ
њАКА 	 ЦњАКЂ–ђUВ@ЈшЕvјґH%Ы^ВЩµ8ХfјXwРB€єYµ`Г-£Ц—АИ@ в’Хt Y†  ЛА
∞ИХЪ  0OЛVU«А@," √Ї ,џ$√Ї ,;F√Їј,:М *  ЛVUбaё@> Цт ≥@ эюеfЏ %Ы| ЩґLХ YґT  Aј Ћ4  `0UэД Цm`PHД rИCј+4  `∞D5,5 Ќ  "™еf“Р&Д
 rИCј+6Р0X"™еf”&ЖФ 9Yµ	В!№Ґ  rЌ  ђџ» Ѕ`И@@Ћ6≠9Y† шµeW`&h  !АҐр ЌІ†L&[! АЛVUвИ —Ц  fА –  B  А h  "ј 6mфeZр&в  Гь2|Z∞ЃЄДј [ ! "≥†Lџ@"ј 6mІe]p&вЦлБk kХЫrА,;…Ч
А    ЈМВB!С§b9 ТJ%У   ЌљА,mѕaPp1–  Ќ  іћЫ~@ЩTdB€єYЈ‘	В!њў2—Р1 |Z≤® (®  Р@С В Q@ еf„р&C_Г\ђЏЬЅap+4  `ИlhkХЫO@Ў"† ЫD@В$ dVеf‘P6Ж»ЖєYµ4ВЌЃАB†  F|Z∞®р ™®Б≥j†FсБFјЄеА QU"ё0 ЋХЪ  0X,   ЏЌ††l+\:Т АY†6mЭf–А6mђeQ∞A‘Р”≥mHсj њаb8еfЁј&Д\r≥@ Д  apµr≥kX÷*¬аџ њаl;и*¬а1 aЁP1А еf’–6хЋјƒ"аCФB  9EV$#xјГ.VmС`∞X",. √≥ l:H*≠Аb,. *¬а—Ц  ap КэюapV КE"ЧX®  И∞® Ђ
А3kјЛ А
∞® D ≥j@ Ш }s в+К*¬аРЪ  :≈@  dEЕ@5(	 *¬†Vh  Ѕ`К∞ Ш }sЌб  2Ќ™†В,. !  TіUeAЋvU…aЏрAUШДАС£aўpAU™В@ЦmМrК∞Є4  e\`F…aЏ AU∞fџpCв’ЕwЅ6а5 ЌЄАlfА ≈Ђ
щnXkХЫvA,:2!њ№ђЏ$Ѕa– VВ Q  еf”@6ЫZ@ƒ  $T  А P  Sњ√'≈Ђ
ФВ≥oЎ8®  r≥lА;B  А P  лSPVmвe]РVQSјQК§∞йЄ(Д rИ_ј+6љГ∞X" !  ђЏцЅ`И@ (™¶Ї≈@  e Ќѓ`мД rКА +6љГ∞X" !{АђЏцЅ`КА +6»∞YµМ T  9Yґ@В*£ ЃQUfА QP  )hЖ\Ґ† ЫlБB  4  e]`Qяr≥o`#ЗvAXuUjЅ\ҐЂ^
ЌЄ Ґ*а
*Ј†ЃQUдfёPЛ≈ю^∞QUхrКА +6љГ∞X"ЂЉ
"ї@Ґ™#P∞a[6жВƒg≈Ђ*С0иP3Е
®x0И  R0aКФГ
ўіLF#>-YU ЗJШt†UKAЬҐ™LЌљјҐ  У.   %©ј¬меf—p&6ўГ
ЃЄ	сj¬≤ј¬x] !њБЃVm^`∞D4d9 Ќђ†lh  еfА  є_бЦm†eY0a еfяpFќHј ВјQ  еf—јЫlЅЩі‘(UЖ@2б∞  [f! АXlЫFѕЛVa∞в’ХxБД РФB  9Yі$ВЅf–аQ  "√`;а!¶!ќVms`И@  f÷аЛХю>-XTB 9Yґ@В√Ј ¬H !  ђџ§Ѕ`≥nЄ3&\:   KFƒ   ЛА
∞и EъfА ™Љ√¶авђ: #a–fў РЛсю>-XUЫXБў,џвrњ√'≈Ђ
≠ГИ@ +6АГ∞XtіB  2eђ@нЈ|, 5А ;mјЂY≈g≈®Бмzs НмЩkЎ;ЕҐЅbµ\Ґ™ВsВѕДX vH®  aё–q 9f÷p ЛйюrИ_а+6љГ∞X"0 !  ђЏцЅ`∞п–8Д ≥lЎ8Eв€єD$аХЫ^ЅЎ,0 еА Vm{`∞D 0ФBх 9YµмВЅaя†vh eБ `vD   СUСa‘АБ† ењјVm{`∞D `ФB  9YµмВЅa’PБ	@ еУАVm{`∞D јФB  9YµмВЅАјQЎ еf„∞vЗUBЈЄАДјx И    ФBь 9YµмВЅdИ@ (Ец r≥kЎ;В*ґјЃQP  Sњ√,џ ±AЂш
Ќ  v4 U`ВђЏцЅ`И@ (Ео r≥kЎ;В…ЧА  ЏБU9 rИ@јЋ6а≥mр#*ЏД3hиH™ҐГђh8Д  aрU8uК∞ш6ЯВ≤®аKнД
∞ш МEЗјw UnBҐ0 rЌµAиHUwnQ 9fё@ЖmѓePСP  √°a"ЂшлВ – Ґ}	
ѓPCђURЅГ"*√Ї!Щq  -	fА ≈Ђ*ґК≠∞@МF"Ґб"  EИ@W!÷*ƒ џТ ≠Б,:Ъ*ƒ 1! a”0СU+	rК± D  ≥iИ3DъTаЧX™ЙДЖDU|%ЗP¬e≠Б,ЩkhHл А9Юн7 !  nG1шPЯҐ®Aаџpі№cа√6ЖЕћмЦmm	 Ѓ`!љЫ_Vі$BБєYґ»%В…aџС …d≥khKE¬еjЯVмАqaЦ§@qаО:ј W∞Б¶д<≥hhS‘uWБвАpлА5АmJHys;ўі4(uАј«ц∞©IЮ.` †
ѓiЄ@јГEв”r∞(6Т6№с0Т”pЂH;XШ> Cа†ф@эmЄdqйТЈd1Hг™ гqПD∞ГўВ…dЋMBАјAуэЫIВЦLіь)¬ЅhµXЃQ’tiЄП(t:ё:ј gЇeА@nCџMјr
®(1шFн 
Н7к±АђЏHџp9ЯЖс0У.#                Zф*  *wшdшµeX†°  …’з+6ЛБ0D7X !Ѓ@ОVmz`∞D6L(EИјXМ F"ƒ`ґmY	>-YVм)ЗiBШvФ(UИјb,F *ƒ`Qhr≥lЎSВ!іNQmr≥@ EЛ@ґp%Х~¬Д!p≥ФC\ЬђЏ‘Ѕ`И_пс/ aЎPЅV- rКЂ SФBА 9Y† ВЅЁ І(™АєD% ХЪ  0X,РЗИ± Д bP’ fџА1YфeKƒg≈Ђ*њЖ
± МEИјlџ\"ƒађF #b0[6ҐЕИ±H ЂА@ mgЗАЧ(Ж…З9YЈЄ)ВЅbPЛА
±8ХЪ  0D6l9 ЌЉаћV) r≥kЎ[UЙј  6ЭД∞≠XX™еAА Ћ6©ЕЇ≈XЬЫqБYЈЎ!ЕnВ≈X§ "  3l®[6÷∞ЃИX™ЌЕДA† Ћ6—Ї≈X§ЫjBўґм-Х|ƒ!∞≥ФCiCЬђЏ÷Ѕ`И_пс/ aЎP∆|b–(™ЙєEUƒ!÷*¶Б,ЏЊеf–АґВЌ≤A"ђN еfџ ЦЕ` rК©EN€≥o S*Ц
©x≠ЫHЈH-ХN ЭЖ
±HХЫO¬Ш,+ b∞ ЛЅюf“–∆`fЁј«(™юЕЇ≈U(2Ќ  µ01Х_!–≥ФCpЬђџјЅ`И_пс/ aЎP…kаcХЕИ@ / bр6Х2Ѓ`Д,rИnЄsХЫ[√,mwb∞ ЛЌюf÷∆Uґb∞ ЛХюfЏp∆mіe\ ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(SETSEQ)
.pa
*/
#include	"amie.h"
#include	"sysman.h"
#include	"dformat.h"
#include	"disc.h"

EXTERN
struct	dtext	*fdtext;	/* Pointer to format names in BIOS	*/

EXTERN
struct	drvtbl	*drvtab;	/* Pointer to BIOS drive tables		*/

EXTERN
struct	disctb	*dtbl;		/* Pointer to BIOS disc tables		*/

EXTERN
struct	dphdr	*dph;		/* Pointer to Disc Parameter Headers	*/

EXTERN
BOOLEAN	f_forced[];		/* Flags if drives were forced		*/

/*======================================================================*/
STATUS                                            /*			*/
setseq(sframe,sdtype,iniseq)                      /* Setup BIOS formats */
struct	ssf	*sframe;/* SOURCE / DEST versions of setup structure	*/
WORD	sdtype;		/* 0 - source  1 - dest				*/
BOOLEAN	iniseq;		/* Are we in initialisation sequence yes or no	*/
/*======================================================================*/
/*USE
Portability	Level 4
Parent module	AMIE system manager
Revision history:
07/02/90 Modified call to 'dvclash' - ICFO
31/01/90 Modified so that only SOURCE or DEST is set up - ICFO
22/06/89 Listing brought up to latest standards - ICFO
03/10/88 If drive cannot accept format and drive is forced 'setfail'
         is called with argument REQDRV - ICFO
18/06/88 Message 66 changed to 57 - ICFO
16/05/88 'BUG' output changed to screen from printer - ICFO
         Call to 'settab' removed - ICFO
02/10/87 'iniseq' added - ICFO
15/06/87 Created - DAR
*/

{

LOCAL
WORD	cd;		/* Current logged in drive			*/

LOCAL
STATUS	setrv;		/* Return value from 'setovr'			*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#ifdef BUG
putstr("\n\nSETSEQ");
getkey();
#endif

/* Indicate the forcing status of the set up drive			*/
f_forced[sdtype] = (BOOLEAN) (sframe->fdriv != -2);

/* Get logged in drive							*/
cd = bdos(0x19,0);

/* Initialise the setup function					*/
/* Set up the number of allocated drives and set the allocation vector	*/
/* for the destination drive to top of memory.  This is needed because	*/
/* the definitions in a newly booted BIOS will have been set up by	*/
/* 'SETUP.COM' and will therefore be just above the definition for the	*/
/* source drive.  This would cause problems if a new source format	*/
/* required a larger allocation vector.  On first entry the system is	*/
/* initialised ('iniseq' is TRUE) so if the destination format is CP/M	*/
/* format the pointer to the allocation vector will be set up correctly	*/
if (iniseq == TRUE && sdtype == SOURCE) {
    dph[(dtbl->dct_defdrv = floppy[DEST])].dph_alv = MEMTOP;
    ++dtbl->dct_defdrv;
}

#ifdef BUG
putstr("\nCall setovr drv = ");
putnum(sframe->fdriv);
putstr(" Fmt = ");
putstr(sframe->fmtnm);
putstr(" Fmt area = ");
putstr(sframe->fdata);
getkey();
#endif

setrv = setovr(sframe,sdtype);

#ifdef BUG
putstr("\nSetovr returns ");
putnum(setrv);
getkey();
#endif

/* Restore logged in drive						*/
bdos(0x0e,cd);

if (setrv < 0) {
    if (setrv == NODRIV && sframe->fdriv != -2)  setrv = REQDRV;
    return(setfail(setrv,sframe));
}

/* If SOURCE and DEST devices both disks & both have been setup on the	*/
/* same drive try to reassign the source drive				*/
if (iniseq == TRUE && sdtype == SOURCE)  return(SUCCESS);
if (device[sdtype ^ TRUE].medium == 'D' &&	/* 'other' drive	*/
		(drvtab[floppy[SOURCE]].dvt_dadty & 0x07) ==
				(drvtab[floppy[DEST]].dvt_dadty & 0x07)) {
    dvclash(sframe,sdtype);
}

/* If the destination drive has been forced to double step issue warning*/
if ((drvtab[floppy[DEST]].dvt_step & 0x80) != 0) {
    chat(54,57,3,0);
    if (getkey() == ESC) return(FAIL);
}

#ifdef BUG
putstr("\nEXIT SETSEQ source on DV:");
putnum(drvtab[floppy[SOURCE]].dvt_dadty & 0x07);
putstr(" dest on DV:");
putnum(drvtab[floppy[DEST]].dvt_dadty & 0x07);
getkey();
#endif

return(SUCCESS);

}

/*======================================================================*/∆Ьaўј…n`ЂА9Y† ЫdВYіPB 9Y† UЛј2Ёј∆џИё& 2EB°P®@F7ЬН¶°–“n3ИB°P® E9Нз!Ркr4ЫМв1Љдm0ЭЖУqЬ D9N∆QЄёtМ¶!д D4Ьћbє»“t2И
#y– c:LАє»“t2И∆©∞и *М&3XАZ- CС§мeNb ёr6ШNВIћ@ 'ƒCС§мeќІБЉдt9ИЖГIћ@f7ЬН¶† Ѓh4ШЌ!»“v2Пƒ∞ АZ  з! рКS!ПЛ†yЄЎyЌ∆QМ–a9LgC)»@r2ЬN¶УСФ» "Н'c(А“sM∆C)Ш“n2Щ cy»Џa:'1‘№d2ЩН&г)Р T9Lf±–ёoжг8Аћo9GS1Ш rИD 9N :ƒcy»Џa:RЩ@t7ИІГI–X  M«СЉиh2ЬД≥)д@t7И
∆SС§ћy A ТIЄжe9CAФ@D4ЬћbIЄ@t4DCС§мe 
ЕB°PАТn4Э&a§жi7ƒ°P®T IƒР»ƒ !ШM∆гy–@l7Шћ'C(А\I'DcI∞  7ЫДCС§мe@CСД∆k  Ажi2GB $Ўl2Щћ&Ѕ–дa1Ъƒсћ“d2И∆a‘  "ЬОFуРА»u9M∆q$ЬIќFУ°Ф P9Ng1 р§e:NFбрАёrІ3ш@t7Иfуq–“n:Щ@ФРМ\¶ЃТ®ЗX®(IкJСХ†lВ™®ЮМЩ  »+й)»ЛА ДИ§≠  ИI)кqА ДШЮЖЦІ  »IйкКkQЯРґД†І4»J®»»™QЮp\Д™М¶Тµ		®e»*jQШPКЖ\ЖЮЫЄИe»кСЬрЄЖ\Ш© »e…™©КСШ† Ж\ЬЮ©/®e k
СТPzЖ\®¶©  »i)…»±А 
ЖШЮЖЧ»iКH©йСЪPlЖШ§КЮІщ»iй…к™СФАzЖЮЬ¶©< »j™Kйи—ЮPЖ™§ЊЮЭхИИ*И1А ИКМИ§≠  ®И®…КСЯј|ИКЬ¶Т©  hЙ*QА ИТ§КЖ©’	»Йк®IИ±А И†Е  »КHH*qА И†®®ВЕЅ®КI*»±А И§ђЬВЫ>»КJ И(Qў ЬИЊРЮЪЛ≠H•—Ыp∆К\a–®™JIкQА 
МВ®ТЙ«»»iЙкh±а МИЩk»»КИЂ
С÷–ЬМТ§К™°&	®…*JjСџ0lМШВ¶РУЛ»…™ИK*СА МЪ®ИКІ  »…™ИЙ*qА МЪ®И§≠»…™Й®1Щp™МЪ®ТЙњ»…™КК	1Ш МЪ®®§Ч»»…»ИКJ—ЭА™МЮ†КЭZ» JjКh±Ы`МЊКЬЙR »ЋкjИ*QЬАіО]*Ии*1ЩАXОВ†e£Ии*qя ОК®ИМГЧ»и™И»iсЮ LОК®МЪ©Э»и™ЙhЂ1С LОК®Ш®•№»и™Кh®qЯ0ДР]Т…*HКи1А РВ§ИЊЛ  Й©КА РТОРКІbЙ	йИ±ЯАRУ©)®(и±С∞ZТЬИК±ы…)»ИЂ	±‘аlТЬТ®И• …)…*К»1„†ђТЬТ®ЊЙu…) »™JССРћТЬђ¶ТЙ  )QС†ЇШИТ§Ы  ©Й)©*СТаШ¶†©	…®)h™
qА 
ЪКИТГ€i®»Qя ,ЪМДИ§≠Й©к»±ТР§ЪІ^I≈—ЧP<ЬИ§ТђЛ°…»Ђ
ККQА 
ЬМВ®ІД……®»HКQРАLЬ™ЪЃТЭc	…и» h™СЦpТ° jИ1ХPЬ†¶КЖЬЂ  ™
ih™с„∞v†™©н ™
™ЖHС÷0М†™®ИВ©Р 
™Ии*Ш∞Љ†™®Ь™ЫШ 
™Кh*СШ0Љ†™®¶®•  *1Щ@*ҐШТ¶©  ™)Йи»—Р@»§КВЙ H™(КJ—Ъ М§К¶®§Ч   KиH*h±ФАd¶]   hi)»сА ¶КЖ®§Г≤	Кh®©qаP¶К®®ШЛ	™i(И®—Ш Z¶ТіКН	 ih™кh±Ьј:¶ЪЮђЛ   iи Ли±А ¶†З&jjСА 
¶†МВ©   j	ИЂ	±Х`∆¶†©{
 jй)…1а0
¶®К†•Ћ
 jКHj1Э†<¶®§ШКЭ   k*jКIqА ¶≤¶®≤°   k*kкЛ1А ®МЩ   КH) hQА 
®¶ЦКѓИjКЙСЧ∞j™††К•ђ »™I(Ћ1ЭP»ЃВТ©5
 и)*Кh±—АzЃИТ¶З?
 кJККIqА Ѓ¶†ВЖЛ8  ЮqаP¶К®®ШЛ	™i(И®—Ш Z¶ТіКН	 ih™кh±Ьј:¶ЪЮђееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                          SETFDP(GETFCODE)
.pa
*/
#ifndef	HEADER
#include	"portab.h"
#include	"setup.h"

EXTERN
struct	drec	hardware[];		/* System Hardware Definitions	*/
#endif

#ifndef	SET
/*======================================================================*/
VOID                             /*					*/
getfcode()                       /* Get a format definition code & data */
/*======================================================================*/
/*USE
Portability	Level 4 (Depends on Gemini hardware)
Parent Module	SET, SETUP etc
Revision History:
10/03/88 Code to test for and set the state of Line 2 to the drive has
         been rewritten - ICFO
20/07/86 Version 3.41
03/10/85 Modified fnddrv() so that the drive->tpi is forced to be even
         (allows 3" drives to be double stepped as 67*2 will now match
         a drive tpi of 135).
24/05/85 Split out from SETFMT.C & SETBIO.C as these routines are used
         by the standalone F
step & 0x80) != 0) {
    chat(54,57,3,0);
    if (getkey() == ESC) return(FAIL);
}

#ifdef BUG
putstr("\nEXIT SETSEQ source on DV:");
putnum(drvtab[floppy[SOURCE]].dvt_dadty & 0x07);
putstr(" dest on DV:");
putnum(drvtab[floppy[DEST]].dvt_dadty & 0x07);
getkey();
#endif

return(SUCCESS);

}

/*======================================================================*/ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                             SYSMAN(SETUP)
.pa
*/

#include	"amie.h"
#include	"sysman.h"
#include	"dformat.h"
#include	"disc.h"

EXTERN
struct	dtext	*fdtext;	/* Pointer to format names in BIOS	*/

EXTERN
struct	drvtbl	*drvtab;	/* Pointer to BIOS drive tables		*/

EXTERN
struct	disctb	*dtbl;		/* Pointer to BIOS disc tables		*/

EXTERN
BOOLEAN	f_forced[];		/* Flags if drive was forced		*/


EXTERN
WORD	phytran[];		/* Translation table for physical drive	*/
				/* values taken from BIOS		*/

/*======================================================================*/
STATUS                          /* Set SOURCE or DEST drive to a format */
setup(format,fcedrv,osno,sdtype,iniseq)/*				*/
BYTE	*format;	/* Name of format				*/
WORD	fcedrv,		/* Force to drive 0-7 or -2 if not needed	*/
	osno,		/* Operating system code			*/
	sdtype;		/* 0 - source   1 - dest			*/
BOOLEAN	iniseq;		/* Are we in initialisation sequence yes or no	*/
/*=============ormat program.
         Version for GM849 & MFB II
         Written by David Parkinson
        (c) dci software 1983, 1984
*/

{

/* Module for dealing with prompts etc for formats & drives		*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (TRUE) {
    putsat(23 RC 16,"Enter Format code : ");
    putsat(23 RC 37,fmtid);
    getfrom(23 RC 37,fmtid);

    switch (buffer[0] & 0xff) {		/* Allow scroll up / down	*/

	case SC_UP:
	case C_UP:
	case SC_DOWN:
	case C_DOWN:

	   adj_ql(buffer[0]);
	   qlist();
	   continue;
    }

/* If something entered copy name over & parse				*/
    if (strcmp(fmtid,buffer) == MATCH)  fmtname();		         
    if (getfmt() != 0)	break;
    error("Format code is undefined");
}

/*clreos(23,0);							!!!!!!!!*/
clreos(5,0);

}

/*======================================================================*/
#endif
/*
.he                                                            SETFDP(FNDDRV)
.pa
*/
/*======================================================================*/
WORD                             /*					*/
fnddrv()                         /* Locate the appropriate drive to use */
/*======================================================================*/

{

/* Given a format, locate the appropriate drive to use			*/
/* Returns the drive address if found, otherwise -1			*/
/* Also uses DEFDRV if one is given.					*/

LOCAL
WORD	d;

#ifndef	GM829 
LOCAL
WORD	h,klock,bits3n7;
#ifndef SET
EXTERN
WORD	state[][4];
#endif
#endif

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

for (drive = hardware; drive->id[0] != 0; ++drive) {

    d = drive->addr;		/* Get drive address			*/

/* No match if address doesn't match any default			*/
    if (defdrv != -1 && defdrv != d)  continue;

#ifndef	GM829
/* Set the values for bits 3 and 7 if valid				*/
    h = ((fmtdrv & H_BIT) != 0) ? 2 : 0;
    klock = (clock == 'H') ? 1 : 0;
    bits3n7 = state[drive->hsp - 'A'][h + klock];

    if ((drive->tpi & 254) == (fmttpi & 254)
	&& ((drive->type & 255) == fmtdrv || (drive->type & 3) == fmtdrv)
	&& fmttrk <= (drive->trk & 255)
	&& spd <= drive->sides && bits3n7 != -1)  break;
#else
    if ((drive->tpi  & 254) == (fmttpi & 254)
	&& ((drive->type & 255) == fmtdrv || (drive->type & 3) == fmtdrv)
		&& fmttrk <= (drive->trk & 255)
		&& spd <= drive->sides)  break;
#endif

}

if (drive->id[0] == 0)  return(-1);	/* Not found			*/
#ifdef GM829
d = (1 << (d & 3));			/* Convert to physical address	*/
#else
d = tfl[d & 7];				/* Allow for skewed addresses	*/
#endif
if (clock == 'H')  d += 32;
if (density == 'S')  d += 16;

#ifndef	GM829
d += bits3n7;
#endif

return(d);

}

/*======================================================================*/
/*
.he                                                            SETFDP(GETFMT)
.pa
*/
/*======================================================================*/
WORD                           /*					*/
getfmt()                       /* Fill in the details to match a format */
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if ((i = srchdir(FIND)) != 0)  rdent(i);

return(i);

}

/*======================================================================*/
#ifndef SET
/*
.he                                                           SETFDP(MAKEPST)
.pa
*/
/*======================================================================*/
WORD                               /*					*/
makepst()                          /* Compute the Physical Sector Table */
/*======================================================================*/

{

LOCAL
WORD	i,
	j,
	wrap;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if ((spt < 1 || spt > 60) || frstsec < 0)  return(0);

for (i = 0; i < spt; ++i)  psecnum[i] = -1;	/* Mark all as empty	*/

j = 0;
for (i = frstsec; i < spt + frstsec; ++i) {
    if (psecnum[j] != -1) {
	wrap = 100;			/* Protect against endless loop	*/
	while (psecnum[j] != -1 && --wrap)
	    if (++j >= spt)
		j = 0;
		if (wrap == 0) {
		   error("Program error 32");
		   return(1);
		}
    }К    psecnum[j] = i;
    j += pskew + 1;
    if (j >= spt)  j -= spt;		/* Wrap around on overflow	*/
}

return(1);

}

/*======================================================================*/
/*
.he                                                           SETFDP(FMTNAME)
.pa
*/
/*======================================================================*/
VOID                                                /*			*/
fmtname()                                           /* Request a format */
/*======================================================================*/

{

/* Request a format, and maybe accept a default drive for it as well	*/

LOCAL
BYTE	*p;

/* - - - - - - - - - - - - - - - - - - - - - - =========================================================*/
/*USE
Portability	Level 4 (refers to BIOS tables)
Parent module	AMIE system manager
Revision history:
31/01/90 Modified to set up SOURCE OR DEST - ICFO
22/06/89 Listing brought up to latest standards - ICFO
09/05/88 Call to 'read_a' changed to 'biflush' - ICFO
06/01/87 Selects Drive A to ensure that the BIOS realises that the disc
         has been changed - ICFO
02/10/87 'iniseq' added - ICFO
08/06/87	Created - DAR
*/

{

LOCAL
WORD	fstflp;			/* SOURCE floppy drive number		*/

LOCAL
struct	dformat	fmtdet;		/* Holds 128 byte format description	*/

LOCAL
struct	ssf	sframe;		/* SOURCE / DEST versions of 'setup'	*/
				/* structure				*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#ifdef BUG
putstr("\nSETUP entry - Format = ");
putstr(format);
putstr(" Osno = ");
putnum(osno);
putstr(" Fcedrv = ");
putnum(fcedrv);
putstr(" Sdtype = ");
putnum(sdtype);
getkey();
#endif

/* Get drive number of 1st floppy					*/
/* If the format is already set up forget it unless we are in the	*/
/* initialisation phase							*/
if (iniseq != TRUE) {
    if (strcmp(fdtext[(fstflp = floppy[0]) + sdtype].dtxt_format,format)
							       == MATCH) {

/* But only if forced drive bit is ok					*/
	    if ((phytran[drvtab[fstflp + sdtype].dvt_dadty & 0x07])
					      == fcedrv)  return(SUCCESS);

/* Or if we are a floating format & both drives are different		*/
	    if (fcedrv == -2 && ((drvtab[fstflp].dvt_dadty & 0x07)
	       != (drvtab[fstflp + 1].dvt_dadty & 0x07)))  return(SUCCESS);
    }
}

/* Set up the relevant entries in 'sframe'				*/
sframe.fdriv = fcedrv;
strncpy(sframe.fmtnm,format,9);
sframe.osnum = osno;
sframe.fdata = &fmtdet;

/* Select Drive A to force the BIOS to recognise that the actual drive	*/
/* has (possibly) been changed						*/
biflush();

#ifdef BUG
putstr("\nAfter BIFLUSH\n");
getkey();
#endif

/* Read the format offsets into FORMATS.DAT into 'sframe'		*/
if (getoff(&sframe) == FAIL)  return(FAIL);

#ifdef BUG
putstr("\nAfter GETOFF\n");
getkey();
#endif

/* Get the format details from FORMATS.DAT				*/
if (rdform(&sframe) == FAIL)  return(FAIL);

#ifdef BUG
putstr("\nAfter RDFORM\n");
getkey();
#endif

/* Set up the formats in the BIOS tables				*/
if (setseq(&sframe,sdtype,iniseq) == FAIL)  return(FAIL);

#ifdef BUG
putstr("\nFINISH SETUP\n");
getkey();
#endif

return(SUCCESS);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(SKIPWS)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
WORD                               /*					*/
skipws(fd)                         /* Skip all white space excluding LF */
FILE	fd;					/* File descriptor	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

LOCAL
WORD	c;	/* Character returned from 'spgetc'			*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while ((c = spgetc(fd)) <= ' ' && c != LF)  continue;

if (c == -1 || c == 0x1a)  return(FAIL);

return(c);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее- - - - - - - - - - - - -*/

defdrv = -1;			/* Flag no specific drive		*/
p = buffer;			/* Scan buffer for name			*/
while ((*p = upper(*p)) != NULL)  ++p;
p = buffer;			/* Look for drive address option	*/
while (*p != NULL)  if (*p++ == '[')  break;
if (*p != NULL) {
    if (numeric(*p) != FALSE)  defdrv = *p & 0x0f;/* Mask out address	*/
    *--p = '\0';		/* Set NULL				*/
}

movstr(fmtid,buffer,9);		/* Copy name over			*/

/* Let C/80 supply the return						*/
}

/*======================================================================*/
#endif
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—UС dtUDd4ш5Q96GETFMTБСУСХ†d‘іU9@Р’XZ -  А@≈Ђ*« Bw(ЖЛВ9Y† В!Е№Ґ  ЌҐ ДJrИh–ХЪ  0X#† Ъ  	А:Ь-: ЦЭ KNАTјЫLјђ– ВЌ  t ЗXј† : CА)–NА 
t Д   N е”∞+4  `∞OЛVx f„p6m8>-YVЗcА4∞ Ќ  ,:  !АҐ  Ќ  ,LЄ          [8 !  @  ™– 3@ в’ХvјXvф Uhј!  dEl@vИ Un  Р eЫiАX  T  ў† *п 
∞ ФUrј† 6зА2ѓ8Ў 
А 0 ъжўЈ|Х   €А@    √ь2Ќ  TTB 0ијД  `@UЊ Д@Цm≈ ѓябСH§R  .QV uК∞  dR—≥@  QјИ, f“00 ъж№Ґ†  L >єЯ∆цh   ≤@"™Ж ,ЏФ& 9EW†ЫW@XV<UXјB † eЫZАDјлШorКЂА6єА≥oИ6» ≤≠X™ЉАДAА Ћ6ј ЙА±P  Ќ  ґLХpАEVd" YґА÷*  ґ§Ыk YW<UБАlџЖЌє†,Ђ∞√ї`,;` *ґ@,џr|Z∞ѓPЕю€dК∞  Ш }sЌб  2Ќїа",  *†`!√ь2|Z∞®ШЂ  D  »Л  
А  Кµю>-XT§UА !  dEА X ÷*јјС  ` LЄ    ЦЬ@ +4  `И∞@6и ≤™ИЂ 9Y† UВ 2а†       %™†B†  " 3@ jU` Ир Ќ  µ	Е^@Е@  D  f’ј&mkeX0!  …А , *ђ@N±V
 f„p&UѓaЏ0!V
 И∞PƒБ
∞P D  НЯм;2!  X0 U\@ДX( UbАЭbЂluК∞P6»Б2ЂШн
∞P МEВАvмUГ 6Ь2Ќњ "3в’ХO ƒ&@ Л 
∞` FпYЈИFЌѓ@L™*Ѕј± fяј&U(`јЛ :≈Vр	Ыp YTФB  ∞`ш
∞pсj¬ІАbКеfЎАД dЋO ≈X0 #} Г.QV
 hЯBB†  Fл`ј »Л 
®ЄђUГ † *ЄК∞`ФUUјў†  Л 0оАД dЋД   	kЄЕю€]Рh a V rК∞А6ь9Y† Ґ}	3hH*“БК∞А МEД vC_АƒX@ UД ґ,шµe] 1V И∞А ≠Ыkј¬*Wшdшµa\–6–aЏ∞1V fџр3в’ХAX@Ыu №ђ– ВЌ≤јlЂц*¬ џЊ& \јуxКљБК∞А ђEД јd rИm0ФB	 9Y† ВЅdСM«C)»@F7ЬН¶†А∆o2D°  Мo9L'AМёd2И'1‘№d2ЩН&г)Р P9ћз#	і@e9Нз! ћd МІАbе5tХD8 ADJ_QLМ  dфФдEИј BDRVМ  D$Фх8ј BLOCKSМ  d$фхE5®ј BPSМДВd%TddU(ј BUFSIZМНƒ2дtXќ@C.GTМѓƒ2дƒXЋ@C.LTМЕ ‘2ддхH…рC.SXTМ  d4ДддXѕрCLOCKМЋАd4≈$Tх8ј DATAМьБдDTdE%hј DEFLTМКdDTе4ХHј DIRМ  dDХ$T5Hј DOUBLEМ  4E(ј DPBBASМ  dEED(ќаDRIVEМ  dE%dдЎј DRVTABМ∆А§Rиѕ8E.0МЪБ‘U%$х(ј FATIDМ  ddEDUЕHј FIRSTМ  dd’D%ХHј FMTDESМ≈ дd’DE%h»(%FMTIDОїБдd’DдЎ †FMTTPIМ” дd’EE$ЄмаFNDDRVМаde%5E4XѕАG.М  Dtј GAP2М  Dt8и GETFCOОЬdtUDd’H…XGETFROМЮА§ВићиHARDWAМ  DДT≈ј HIGHESМ  Шј INDEXМ  dФеdU%Hј INVSIDМ  ®ј LIMITМ  D≈5Hк®MAKEPSМ  T‘TDФј MFBМИВd‘хe5E(ј MSМо $виј NDRIVEМ  TдdE8ѕNUMERIМ  dеT’tФиј OFFSETМ    PSECNUМ•Б’4іUx»рPUTSATМ   0QLISTМ  Uƒфdh pRDENTМ  e$U5E$Єј R_BASEМµБ•2иј SCHANGМ  e4T5E$ј SIDEFМ  U4Х§Thј SPCМёАµ5Hј SPFATМ  e5ƒUДЎЋ@SPTМ  e5фФдШ…иSRCHDIМЦА’5DDXЋ`STRCMPМ  e5Х5E$Єј SYSTYPМ  e5Х5хEШѕ†TFLМ  eE$е4(ј TSKEWМ  5ED»ћxUPPERМ  eu54Yј  ЮрPUTSATМ   0QLISTМ  Uƒфdh pRDENTМ  e$U5E$Єј R_BASEМµБ•2иј SCHANGМ  e4T5E$ј SIDEFМ  U4Х§Thј SPCМёАµ5Hј SPFATМ  e®ј LIMITМ  D≈5Hк®MAKEPSМ  T‘TDФј MFBМИВd‘хe5E(ј MSМо $виј NDRIVEМ  TдdE8ѕNUMERIМ  dеT’tФиј OFFSETМ    PSECNUМ•Б’4ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(STABOX)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

EXTERN
WORD	type_clock,	/* Type of clock found in the system		*/
	gctab[];	/* Table of graphic characters			*/

/*======================================================================*/
VOID                            /*					*/
statbox()                       /* Draw status box at top of the screen */
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/05/88 If the SVC is present display the clock - ICFO
05/06/87 Created - DAR
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

boxst();		/* Set box drawing mode				*/
clrbox(0,0,80,5);	/* Clear status area				*/
dobox(4,0,36,5);	/* Draw the boxes				*/
dobox(4,44,36,5);
dobox(3,35,10,3);	/* Draw pipe					*/
move(1,35);
putvid(gctab[5]);
move(3,35);
putvid(gctab[3]);
move(1,44);
putvid(gctab[6]);
move(3,44);
putvid(gctab[4]);
boxend();		/* Exit box drawing mode			*/
move(2,35);
putstr(">---------");	/* Pipe contents				*/

/* If the SVC is present display the clock				*/
/*                            <Esc>t=0 36<Esc>tE			*/
if (type_clock == SVC)  putstr("\33t= D\33tE");

/* Let C80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SETFIL(NOTMFB)
.pa
*/
#ifndef	HEADER
#include	"portab.h"
#include	"setup.h"		/* Global variables */

EXTERN
BYTE	Cmode;			/* In CLIB.REL - 0 = RAWIO (no poll) */

EXTERN
struct	fred	{
	BYTE	yzx[126];
	WORD	zzy;
} secbuf;
#endif

/*======================================================================*/
VOID                       /*						*/
notmfb()                   /* Error message & exit if not an MFB system */
/*======================================================================*/
/*USE
Portability	Level 4 (Assembler)
Parent Module	SET, SETUP etc
Revision History:
28/12/90 Initial announcement message changed - ICFO
04/11/89 Brought up to Timeclaim standards - ICFO
11/05/88 'initvar' changed to get global MS for delay seed so that CPU's
         greater than 4Mz can be used.
18/10/86 'enter' modified to ensure a new format was placed in the
         correct place in the alpha index.
         Moved 'ldirm' before 'insert' or the alpha index got screwed up
         (Change in ENTER)
28/06/86 'srchdir' and 'match8' recoded in assembler for added speed.
19/06/86 'enter' modified to remove double entry of a format in the alpha
         index following the edit of an existing format.
14/04/85 Split out from main SETUP module
         Version for GM849 & MFB II
         Written by David Parkinson
        (c) dci software 1983, 1984, 1985
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putsat(1 RC 16,"**** Not a Gemini MFB system ****");

byebye();

}

/*======================================================================*/
/*
.he                                                            SETFIL(BYEBYE)
.pa
*/
/*======================================================================*/
VOID                          /*					*/
byebye(opt)                   /* Exit from SETUP, tidying up the screen */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

unlock();			/* Unlock screen			*/
move(3,0);
if (opt != 0)  exit();
else	       return;		/* So SET can exec() if necessary	*/

}

/*======================================================================*/
/*
.he                                                           SETFIL(INITVAR)
.pa
*/
/*======================================================================*/
VOID                        /*						*/
initvar()                   /* Initialise global variables and pointers */
/*======================================================================*/

{

LOCAL
WORD	*ip;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

#asm
	.z80

;   Log on to drive A
	ld	e,0
	ld	c,14
	call	5

;   Check for Special GM849
	ld	c,0E5h
	ld	a,0F7h
	out	(c),a
	in	a,(c)
	add	a,0E0h
	ld	hl,exit
	jr	c,indzzz

;   Pick up the vector to the MFB patch area
	ld	hl,(1)		; Do a CALL HOME
	ld	de,21
	add	hl,de
	call	indzzz
	ld	(bios),bc	; Set the pointer
	ld	hl,(1)
	ld	de,55		; Offset to MS
	add	hl,de
	ld	a,(hl)
	ld	(ms),a		; Set it
	jp	$1
indzzz:	jp	(hl)		; For an indirect CALL
$1:	ds	0
	.8080
#endasm

mfb = strcmp(bios,"MFB");	/* Check BIOS				*/
if (mfb == 0) {
    notmfb();
    byebye();
}
ip = bios + 5;			/* Pointer to maximum number of drives	*/
ndrives = ip;			/* Pointer to maximum number of drives	*/
limit = *ndrives;
++ndrives;			/* Pointer to number of drives defined	*/
drvtab  = *++ip;		/* Pointer to drive tables		*/
dpttab  = *++ip;		/* Pointer to Disc parameters		*/
dpbbas	= *++ip;		/* Pointer to Disc par. blocks		*/
transb	= *++ip;		/* Pointer to Sector trans. tables	*/
wspace  = *++ip;		/* Start of workspace area		*/
fdtext	= *++ip;		/* Pointer to drive/format text		*/
/*	ewspace  = *++ip;	/* End of workspace for MFB		*/
numwin  = 0;			/* No winchesters			*/
p = drvtab;			/* Check in drive tables		*/
i = *ndrives;			/* Numееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(STATUS)
.pa
*/
#include	"amie.h"
#include	"sysman.h"
#include	"disc.h"

#define		DISCMES	42	/* } Message 		Disc		*/
#define		TAPEMES	43	/* }   Numbers		Tape		*/
#define		I_O_MES	44	/* }     from		I/O Device	*/
#define		FMTMES	29	/* } 	   AMIE.MS1	Format =	*/

EXTERN
struct	dtext	*fdtext;	/* 'settab' sets this pointer to tables	*/

STATIC
WORD	start;		/* Holds start column of the device details	*/

/*======================================================================*/
VOID                                         /*				*/
status(sdtype)                               /* Print out device status */
WORD	sdtype;					/* 0 - SOURCE  1 - DEST	*/
/*======================================================================*/
/*USE
Portability	Level 4 (Uses BIOS tables for readout)
Parent Module	AMIE system manager
Revision history:
31/01/90 Optimised - ICFO
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

LOCAL
WORD	n;		/* General WORD					*/

STATIC
BYTE	*tstring = 0x80;/* Pointer to string assembly area		*/

STATIC
VOID	movput();

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (sdtype == SOURCE) {
    clrbox(1,start = 1,34,3);	/* Clear contents of boxes		*/
    n = 9;			/* Number of SOURCE message		*/
}
else{
    clrbox(1,start = 45,34,3);
    n = 10;			/* Number of DEST message		*/
}

/* Write SOURCE or DEST into ID line					*/
strcpy(tstring,genmes[n]);

switch(device[sdtype].medium) {

    case 'D':		/* 'Disk'					*/
	n = DISCMES;	/* Disc message number				*/
	break;

    case 'T':		/* 'Tape'					*/
	n = TAPEMES;	/* Tape message number				*/
	break;

    case 'I':		/* 'Stream Device' or Hard disc	or 'M' drive	*/
	n = I_O_MES;	/* I/O Message number				*/
	break;
}

strcat(tstring," ");
strcat(tstring,genmes[n]);
movput(1,tstring);

/* Write device driver name						*/
movput(2,device[sdtype].dv_name);

/* Write drive & format details						*/
if (n == DISCMES) {
    strcpy(tstring,fdtext[n = floppy[sdtype]].dtxt_drive);
    strcat(tstring," ");
    strcat(tstring,genmes[FMTMES]);		/* Format = 		*/
    strcat(tstring,fdtext[n].dtxt_format);
    movput(3,tstring);
}

return(SUCCESS);

}

/*======================================================================*/
/*
.he                                                   SYSMAN(STATUS / MOVPUT)
.pa
*/
/*======================================================================*/
STATIC VOID                                    /*			*/
movput(row,s)                                  /* Move and put a string */
WORD	row;					/* Row number		*/
BYTE	*s;					/* String to put	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(row,justify(start,34,s));
putstr(s);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
           /* Move and put a string */
WORD	row;					/* Row number		*/
BYTE	*s;					/* String to put	*/
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

move(row,justify(start,34,s));
putstr(s);

/* Let C/80 supply the return						*/

}

/*======================ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееber to check			*/
while (i-- && (*p & 0x0f) == 0) {
    ++numwin;
    p += 16;
}
while (limit - numwin > 5)  --limit;
i = bios;
i = (i & 0xff00) + 0x53; 	/* Winnie system track position in BIOS	*/
ip = i;
if ((systrk = *ip) != 0 && systrk != 1) {
    error("Unlikely system track in BIOS, assuming 0");
    systrk = 0;
}

Cmode = 0;			/* Set "RAWIO" mode			*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                              SETFIL(HEAD)
.pa
*/
/*======================================================================*/
VOID                                         /*				*/
head()                                       /* Put up the main heading */
/*======================================================================*/

{

/* Put up the main heading on the top two lines	and lock it into place	*/

LOCAL
WORD	k,
	s;

LOCAL
BYTE	*p;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(0);
crlf();
smove(0);				/* Get column count straight	*/

p = "          Gemini Multi-Format-BIOS ";
putsat(0 RC 0,p);
#ifdef FORMAT
putstr("Format");
#else
putstr("Setup");
#endif
putstr(" program Version 04.01");

if (mfb != 0) {
    s = numwin;				/* Possible Wini offset		*/
    for (i = 0; i < limit - numwin; ++i) {
	move(1,i * 15);
	conout(' ');
	conout('A' + s);
	putstr(" = ");
	if (s < *ndrives) {
	    p = drvtab + s * 16;	/* Point at table entry 	*/
	    if (*(p + 13) != 0)	 hil_on();	/* Offset to Media flag */
	    putstr(fdtext + s * 18);
	    hil_off();
	    clreol();
	    move(2,i * 15);
	    conout('(');
#ifdef GM829
	    j = *p & 0x0f;
	    for (k = -1; j > 0; j = j >> 1)  k++;
	    putnum(k);
#else
	    putnum(ttl[*p & 7]);	/* Translate to logical		*/
#endif
	    putstr(")  ");
	    putstr(fdtext + s * 18 + 9);
	    clreol();
	}
	++s;
    }
}
else {
    notmfb();
    byebye();
}

lock(3);				/* Lock the screen 0-2		*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                              SETFIL(OPEN)
.pa
*/
/*======================================================================*/
VOID                                  /*				*/
open()                                /* Open the data file FORMATS.DAT */
/*======================================================================*/

{

/* Open the data file FORMATS.DAT and read the directory into memory	*/

LOCAL
WORD	*ip,
	n;

LOCAL
BYTE	**ap;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

channel = fopen("A:FORMATS.DAT","ub");
if (channel != 0) {
    read(channel,dir,128);		/* Read first sector		*/
    ip = dir;
    r_base = *ip++;			/* Base sector number		*/
    highest = *ip;			/* Highest active entry		*/
    n = r_base * 128;			/* Total size in bytes		*/
    data += n;
    bufsiz -= n;
    read(channel,dir + 128,n);		/* Fill the buffer		*/
    a_indx = data;			/* Alphabetic index		*/
    n /= 4;
    data += n;
    bufsiz -= n;
    sort();				/* Sort into order		*/
}
else {
    putsat(3 RC 8,"Cannot locate FORMATS.DAT on drive A");
    byebye();
}

/* Let C80 supply the return						*/

}

/*======================================================================*/
#ifdef FGRT
/*
.he                                                            SETFIL(FNDCFG)
.pa
*/
/*======================================================================*/
VOID                            /*					*/
fndcfg()                        /* Set up the system Configuration data */
/*======================================================================*/

{

/* This code is redundant and was only used for MFB I.  It has NOT been	*/
/* tested since it was brought up to Timeclaim standards		*/

/* Set up the system Configuration data. To do this the file		*/
/* HARDWARE.DAT is opened and read into the buffer. Next the		*/
/* configuration entry is copied out, and the appropriate drive	entries	*/
/* are also retained. The rest of the data is discarded. Hardware	*/
/* ensures that the data is stored as:					*/
/*	<config entry>, <drives present> <other drives>.		*/

LOCAL
BYTE	*p;

LOCAL
WORD	i,
	pda;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

zero(cinfo,64);			/* Clear out to start with		*/
channel = fopen("A:HARDWARE.DAT","rb");  /* Open the file		*/
if (channel == 0) {
    putsat(3 RC 8,"Cannot locate HARDWARE.DAT on drive A");
    byebye();			/* Abort if nothing 			*/
}
read(channel,cinfo,384);	/* Read in the data 			*/
fclose(channel);
*(cinfo + 320) = 0;		/* Mark the end 			*/
p = cinfo;			/* Start of data file			*/
if (*p != 'C') {
    zero(cinfo,63);
    putsat(3 RC 8,"Error in HARDWARE.DAT format");
    exit();
}

}

/*======================================================================*/
#endif
/*
.he                                                            SYSMAN(STFAIL)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
STATUS                                            /*			*/
setfail(fcode,stdets)                             /* Report setup error */
WORD	fcode;				/* Set failure code		*/
struct	ssf	*stdets;		/* Setup details that errorred	*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
03/10/88 Code REQDRV added - ICFO
08/06/87 Created - DAR
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */

switch (fcode) {

    case WKSPERR:
    case SSPERR:
	nferr(42);			/* System workspace exhausted	*/
	break;

    case NODRIV:
	flerr(stdets->fmtnm,43);	/* No drive accepts this format	*/
	break;

    case REQDRV:
	flerr(stdets->fmtnm,51);	/* Drive does not accept format	*/
}

return(FAIL);

}

/*======================================================================*/
- - - - - - - - - - - - - - - - */

switch (fcode) {

    case WKSPERR:
    case SSPERR:
	nferr(42);			/* System workspace exhausted	*/
	break;

    case NODRIV:
	flerr(stdets->fmtnm,43);	/* No drive accepts this format	*/
	break;

    case REееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееpip m:=b:$1.c[g4
c $1
era $1.c
m80 =$1
era $1.mac
lib syslib=syslib,$1
era $1.rel
SYSBL1  SUB                    	APACSINIC     "ф D            еSTFAIћ  C     	E              STOP †  REL   F              SWCLS≈  C     G              SWOPEќ  C     	H              SYMCON  COM   0IJ            еSYSBL±  SUB   K              еSYSBLƒ  SUB   L              еSYSLNЋ  SUB   M              DKREAD  C     5’n            еSYSMAќ  H     P              ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее
#ifndef HEADER
/*
.he                                                            SETFIL(DELETE)
.pa
*/
/*======================================================================*/
VOID                              /*					*/
delete()                          /* Delete an entry from the data file */
/*======================================================================*/

{

/* Delete an entry from the data file. First locate it in the directory	*/
/* Next the entry is removed from the directory.  Finally the updated	*/
/* directory is written to disc.					*/

LOCAL
WORD	record;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if ((record = srchdir()) != 0) {	/* Locate the entry		*/
    *(dir + (record * 8)) = 0;		/* Delete the entry		*/
    if (record == highest)  --highest;
    wrtdir();				/* Write the directory out	*/
    remove(record);			/* Delete from alpha Index	*/
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETFIL(ENTER)
.pa
*/
/*======================================================================*/
VOID                              /*					*/
enter()                                /* Add an entry to the data file */
/*======================================================================*/

{

/* Add an entry to the data file.  First the directory is scanned to	*/
/* see if an entry already exists.  If so this entry is	overwritten,	*/
/* otherwise the new entry is inserted at the appropriate place. Next	*/
/* the data entry is written to disc, and finally the directory is	*/
/* updated on disc. It is assumed that the data is stored at FRECID	*/
/* onwards.								*/

LOCAL
WORD	record;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

record = srchdir();		/* Locate the entry or a free record	*/
if (record == 0) {		/* New entry ........			*/
    record = getent();		/*          ...find somewhere to put it */
    ++highest;			/* We now have another entry		*/
    ldirm(dir + record * 8,fmtid,8);
    insert(record);		/* Add the pointer to the alpha index	*/
    wrtdir();			/* Update the directory on disk		*/
}

wrtent(record);		/* Write it out to disc */

/* Let C/80 supply the return						*/

}

/*======================================================================*/
#endif
/*======================================================================*/
/*
.he                                                           SETFIL(SRCHDIR)
.pa
*/
/*======================================================================*/
WORD            /*							*/
srchdir()       /* Search directory for a matching entry to format name */
/*======================================================================*/

{

/* Search the directory for a matching entry to the format name	held in	*/
/* 'fmtid'  If found it returns the record number of the data entry,	*/
/* otherwise it returns 0.						*/

/*	static char *p;
/*	static int record;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/*	p = dir + 8;		 /* start at the beginning */
/*	for(record=1; record<=highest; ++record, p += 8)
/*	    if(match8(fmtid,p))
/*		return record;
/*	return 0;		/* No match */

#asm
	.z80
	ld	hl,(dir)	; Point HL at base of directory
	ld	bc,0		; BC = starting record of 1
sd$lp:	inc	bc		; Bump record count
	ld	de,8		; Advance pointer
	add	hl,de
	ld	de,fmtid	; Point at FMTID
	push	hl		; Save pointer
	ld	a,(de)		; Look ahead to save time
	cp	(hl)
	jr	nz,sd$fai	; Skip save / call / restore
	push	bc		; Save count
	call	match8a		; Match found?
	ld	a,h
	or	l		; Check return value
	pop	bc
	jr	nz,sd$fnd	; Skip if found
sd$fai:	ld	hl,(highest)
	sbc	hl,bc		; Over the top yet?
	pop	hl
	jr	nc,sd$lp	; Repeat
	ld	hl,0		; Not found
	ret
sd$fnd:	pop	hl		; Clean stack
	ld	h,b		; Move record to HL
	ld	l,c
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                            SETFIL(MATCH8)
.pa
*/
/*======================================================================*/
WORD                                /*					*/
match8(p,q)                         /* Compare two strings for equality */
BYTE	*p,				/* First  string to compare	*/
	*q;				/* Second string to compare	*/
/*======================================================================*/

{

/* Compare two strings for equality. The strings have a maximum	of 8	*/
/* characters each.  (Not NULL terminated in that case).		*/

/*	static int i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/*	for(i=8; i; --i)
/*	{   if(*p != *q++)
/*		return 0;	/* No match */
/*	    if(*p++ == 0)
/*		break;		/* NULL terminated match */
/*	}
/*	return 1;		/* 8 character match */

#asm
	.z80
	pop	bc		; Get comparison pointers to DE & HL
	pop	de
	popееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееpip m:=b:sysbl1.sub[g4
pip m:=b:sysman.h[g4
;pip m:=b:setup.h[g4			Not used with new 'setovr'
pip m:=b:gocrt9.c[g4
c gocrt9
era gocrt9.c
m80 =gocrt9
era gocrt9.mac
lib syslib=gocrt9
era gocrt9.rel
;pip m:=b:setpak.c[g4			Not used with new 'setovr'
x sysbl1 setovr
;era setpak.c				Not used with new 'setovr'
x sysbl1 badsm
x sysbl1 dodve
x sysbl1 dvchan
;x sysbl1 gsfail			Incorporated into 'sechan'
x sysbl1 getswt
x sysbl1 idsfil
x sysbl1 opnswt
x sysbl1 prcent
x sysbl1 rd2lf
x sysbl1 sechan
x sysbl1 skipws
x sysbl1 stabox
x sysbl1 status
x sysbl1 tdvcpy
x sysbl1 prcfmt
x sysbl1 getfnm
x sysbl1 getos
x sysbl1 setup
x sysbl1 getoff
x sysbl1 offhan
x sysbl1 rdform
x sysbl1 getfce
x sysbl1 stfail
x sysbl1 dclash
x sysbl1 setseq
x sysbl1 ctdrvs
xp b:[g4]=syslib.rel
era syslib.rel
pip m:=b:sysman.c[g4
c sysman
era sysman.c
m80 =sysman
era sysman.mac
era sysman.h
era setup.h
xp b:[g4]=sysman.rel
era sysman.rel
era sysbl1.sub
era sysbld.sub
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее	hl
	push	hl
	push	de
	push	bc
match8a:
	ld	b,8		; Set match length
m8a:	ld	a,(de)
	cp	(hl)
	jr	nz,m8b
	or	a		; Nulls ?
	ret	z		; Yes, return NZ
	inc	hl
	inc	de
	djnz	m8a
	ret			; Return NZ if at the end
m8b:	ld	hl,0		; No match return
	.8080
#endasm

}

/*======================================================================*/
/*
.he                                                            SETFIL(GETENT)
.pa
*/
/*======================================================================*/
WORD                                /*					*/
getent()                /* Locate the first free entry in the directory */
/*======================================================================*/

{

LOCAL
BYTE	*p;

LOCAL
WORD	record;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = dir + 8;				/* Start of directory 		*/
record = 1;
while (*p != NULL) {
    p += 8;
    ++record;
}

if (record > highest)  highest = record;

return(record);

}

/*======================================================================*/
#ifndef HEADER
/*
.he                                                            SETFIL(WRTDIR)
.pa
*/
/*======================================================================*/
VOID                                /*					*/
wrtdir()                             /* Write the directory out to disc */
/*======================================================================*/

{

LOCAL
WORD	*ip;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

ip = dir;
*++ip = highest;
seekrc(channel,0);			/* Seek to record 0		*/
write(channel,dir,r_base * 128);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFIL(WRTENT)
.pa
*/
/*======================================================================*/
VOID                                   /*				*/
wrtent(record)                         /* Write a new entry out to disc */
WORD	record;				/* Record to write		*/
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

seekrc(channel,record + r_base);
pack();
i = write(channel,&secbuf,128);
if (i != 128)  error("***Disc Write error***");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
#endif
/*
.he                                                            SETFIL(WRTENT)
.pa
*/
/*======================================================================*/
VOID                         /*						*/
rdent(record)                /* Read an entry from disc into the buffer */
WORD	record;					/* Record to read	*/
/*======================================================================*/

{

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

seekrc(channel,record + r_base);
i = read(channel,&secbuf,128);
if (i != 128)  error("***Disc Read error***");
unpack();				/* Unpack it			*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                              SETFIL(SORT)
.pa
*/
/*======================================================================*/
VOID             /*							*/
sort()           /* Build the alphabetic Index - uses an insertion sort */
/*======================================================================*/

{

LOCAL
BYTE	*p,
	**ap;

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = dir + 8;				/* Start of entry names		*/
ap = a_indx;				/* Start of alpha index		*/
*ap = 0;				/* Bottom end stop		*/

for (n = 1; n <= highest; ++n, p += 8) {
    if (*p != NULL) {
	if (compare(p,*ap) == TRUE)  *++ap = p;	/* Append		*/
	else {
	    *++ap = 0;			/* Mark the end			*/
	    insert(n);			/* Insert the record		*/
	}
    }
}

*ap = 0;				/* Mark end of records		*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                           SETFIL(COMPARE)
.pa
*/
/*======================================================================*/
BOOLEAN                          /*					*/
compare(n,m)                     /* Compare entry <n> against entry <m> */
BYTE	*n,						/* First  entry	*/
	*m;						/* Second entry	*/
/*======================================================================*/

{

/* Returns TRUE if  n > m						*/

LOCAL
BYTE	*x,
	*y;

LOCAL
WORD	i;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

x = n - 1;
y = m - 1;
for (i = 8; i != 0; --i)
		      if (*++x != *++y)  return((*x > *y) ? TRUE : FALSE);

return(FALSE);

}

/*=========ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕС”–‘Х`dtф5%CЩ@ ’Ш                                   Ж£Б9D4< ! ђ– ВЅ`И®0 НЪ  2™H Ж£Б9D 0ХЪ  0X,С$ еfА P  е’ '+4  `∞DT  FЌ¶ј™м *™@Q еf‘@Т!™`NVm#`И@  P  ЛшюЌ  UиЗg@T F"†@; !АђЏjЅP  Й  Ќ     e Ќ§`LЬ еf”P&Д r≥i®U@А$А6÷ mx d"G Y† ХЫM@Ш"  EA T "ь?≥lXjЈА∞и ™В ƒT V√ЉјH Ќ¶†LU Т џЬ Ї РИД rК®  D f–рИe Ќ§`LU К]b™ Дhx eЪ  3n»4  eVј	l еf”P&™Б 
E.±U КB4< 2ЌІ@.Vm#`ИK†+6ЪБ0Xw‘ CUјЬђЏFЅaў0P  Ќ® ,+*Т W∞m~fЎpХI , 6≈ ≥lШ*ГБjиХЫHјШ"Ђ е–А+4  `∞D4  Ќ§`L "†А™ ~ЯўЈіµјXw\UA b* √Јј"` Ќ¶†LU Дm eЫW@\Ґ еfЏјCB ђЏFЅa№–br≥iB 9Yі‘	В*† Vh  ЅP`+4  `И@ H™А 9D @ еЫz \ђ– ВЅdИ@@Ћ6ЮАєET  Ќ  ,IЪI"ЛКer† ЃC Ѕ†† 4#ВА≤	0t .ГA@ѕ ALARMМРАд2д’T≈HЋC.NOTМвА‘2еE5H»аCLS_TXМ  D5D≈»РDEVICEМ  dDe$‘Xћ∞E.0МіАDUДхhЋИFLERRМ  ddƒхШ…–G.М  dtTд‘U8ј GENMFОПАdtф5%CШ…`H.Мш ƒХDф pMKNAMМЦ dхехEИј POOLQМ  U$4Xј QCМШe4eUE8»†SPCLOSМ≠ e5хTи SPPUTCЬ   ЕФ—U’Ф†e4UDхe)@ ’04                                                                                                                                                                                                     
Б                                       9fА H 2Ќї`Q rИP +4  `∞X,ЏH!і`Q 9fё (Д r≥l[ВЅБ Цm€ ВјЦmА – ХM D @ еЫF B ∞ eЫJ Xt№B€ИЃР Д ≥ix§"  YіьEm µXEu WPУ-VА@≈Ђ*Ќ И@ ° f№Pи А ў† *ЇА∞м–Д ZUЉ И≠а6вАЯFT  FЌ≠†,Ђ&√≥@"ыэТ√™ј,Џј#fА ЂP!~њў,ЏВЌђ6mЯe[Рщю…[@H         Д  YрUЯ fА ≈Ђ*эБ
ђш D ≥nxКёАКЃР НЫl XW№Uo@\ҐЂ§ Ќ  ґ,Х{АЕVЎ L >єАЖцmшeQ ! √Ґ†B  EoјEVи "ЄЖYЈ†ХJјД Ч@ ЅYр ИD fЁаКэюКE!  2е[рX™аАЖE-Ћ6£АИЃ™ѕАA` Ћ6ЬБ	А„3шёе[ј0 ъжўЈ‘Хj ЕV| "
 YµАL rК≠∞6єБ0≠(™ѕАA@ Ћ6ј	А„0ёе[`mЙf–p&m¶e\!UЯ Г ЦmЦ bЂ| Ќ  ґ§	Хv ЕV| " YґЎ	÷*ЄАџ~ЌЄ@LЂ *Є`"6mўfё0&Uоaя∞)op™ѕАB@ »КѕА0оX™ѕА3nxсj¬°@bыэТ*Ј†"`хћ7Дm` eЫјДVфUnА+ЗшdшµaS01UљИ СљTh  & \јC{6Р2™x™ёАДB  »КёАК≠иђUpјC"+z*Ј†,Р  UpАb Ъ  ™рД  >М® ™ѓД_«цh  “і l;":† Џn#>М®ЇК™рђB 3k@Кѓ∞м™б :ƒ( 6ћБКѕ£* :™`џ& \јyфe@јVаЗDt§u@јґ–" O£* √• Г™ Ќє†a  2}P0)P0mёР Уи БА0йH кБА3oxD ЯFTЗJAt§Ъ  \`2ШдБХ h™ љ`d0ь!   ’A f– A0 ъж@ўЈШ	ХRATЫKA(  dъ2†`™∞ ЌІаВ`хћ 7≥i∞#*іВ®6¶ВA  …фe@јUDЫWЅ  4  uО™А6ґВElЏђ ≤ Г™ Ќѓ@В1фe@јW  V}P@’J fЎА@И ЌЃ`О±
  Ќµ b≥и ВА
ђш D ≥hјђV+>М®0 кГ 3lа D Аf„∞6’„А —Х Z[6†≤ѓx кГ 3n( E  ЯFT Ugј!  eЫn£* *≥аx 2ЌЊаЗ—Х [аYфeB@µ@$EBАb16о2©0(Ею€dКЃђBА 3mH#ђUp ґИEWА≈Vа "љЖOЛVSUа7X™в 3i®(КѓКЃ@6њВ2Ђ0(™ѓєEW Ъ  3jЄ+*їКЃ@фeC vUWАƒW  B  FT0 UrА£* *ЄА±Yсj¬і@£™ ЌЉ†З„≤ ё}P–c f–PQ6≥В≤≠»(™№ WѓрЋ6’≥mЄ+*нО®6ћЙА„3шё}P0’ f№0QфeA UlЫtЅO£* :Ђ@џЉ
}Pа  rК≠† §R)Ї≈@  e ! ђџ№ Ѕ`∞EV– " 3jp+ђT  \ҐF еfА ™Џ B@muК®†0d"	 \ҐЂ> еf—–fB  2EW  ED Vш÷*ЄАЏPл\ mOrКЃђBА 3ip+EЫUБДTT UrАuьЫB¬v,ЫkAШv,ЗbЅЩіDЄ @  їhАФUm  р6≤Г:≈@  e !АђЏЅ`∞Y     :©@џ–
"µ ¬ ъ2Ґ@ЂRўЈ,•zБШwpUjAЭbЫXAДV§ЗoAЗTHЫlAДg—Х a№јa’ fё cи ЙА
™h Ш л\АmЦrК®®НЪ  ®® к• 3op0§R)Z=============================================================*/
/*
.he                                                            SETFIL(INSERT)
.pa
*/
/*======================================================================*/
VOID                          /*					*/
insert(record)                /* Insert a new record into the data file */
WORD	record;					/* Record to insert	*/
/*======================================================================*/

{

LOCAL
WORD	*ip;

LOCAL
BYTE	*p,
	**ap,
	*here;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = dir + record * 8;
ap = a_indx;
while (*++ap != 0)  if (compare(*ap,p) == TRUE)  break;
here = *ap;
while (*ap++ != 0)  continue;		/* Locate the end		*/
while ((*ap = *(ap - 1)) != here)  --ap;
*--ap = p;

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFIL(REMOVE)
.pa
*/
/*======================================================================*/
VOID                              /*					*/
remove(record)                    /* Delete a record from the data file */
WORD	record;					/* Record to delete	*/
/*======================================================================*/

{

LOCAL
WORD	*p,
	**ap,
	**aq;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = dir + record * 8;			/* Address of entry to delete	*/
ap = a_indx;
while (*++ap != 0)  if (*ap == p)  break;
if (*ap != 0) {
    aq = ap++;
    while(*aq++ = *ap++)  continue;
}
else  error("Program error 45");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

p = dir + record * 8;			/* Address of entry to delete	*/
aееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееРaU uК≠H34  И®® ™КА_аh   ®@г™Ф Ќ°ао± ЌЇА¬ґIT†m5ЯFTP uQ µL µЯбЦmЇeVрq’D f’q0 "–ЖO£*( :©@Џ∆+f—–VUЕQP Ль Ќ•АмЏі ≥ вш EE@  фeE U, V"Ґа™Ф ЌЃ`вСH§R)ZРaUK uК≠H0dVлZРfm<ZРa  "µ`¬ЂR+ZРaсj ЉавЂVлА@–  шц@ƒVђЗqБ≈Vђ÷! Јlъ2£ ЂV}Q†  "£`™Ъ & ®и$URјT\ UW £*$ :ЂјџF}Q0’_ f—јБ V m&>М®† к∞А3ixAфeF@UИЫNB£*4 :ђ ЏЖ}QР’b f‘–Ги Н 2@ U  >-XU$Um "СH•÷*  !` 2еА –  UE@n±  Ќ£ав1^T0(™Џ 3m*рД
≠† §R)Ї≈Uƒ 2 .QP  А,Џ¶Ќѓ°±U^єEV– F)КE.±U§ДAј Ћ6Џ4YЈX	ХwВ/чы%ЗPBEV– R)К]bЂТГАЧ(Ею€rК™рC6Г≥mЄCФUm bСH§Rл^†А»D ≥nИCФUm axЫБЭbЂ4Б@Цm	Їƒ А6ƒ4C"6Л4  eTСэю…Ц†ДЋPBY                @ N	TјСc fЏ`Qсj ≠!bЂp ^њ√,Џо ѓ!"ЂА )a„јСUј T@СUПrК≠†6Ћ2≠H™Џ ƒU$UkB – eЫJBDU(%ЗpВEV– V"®A"Ђ(А,џ6SА.QUD	fя†БJ	T СH§R)uКѓЎ(d"
 Yґ»% !  µРЕ}BEU$R)К]b™fЁ0Ч(Д  fЁ†ЦmЖeV–°UB	КE"ЧX™еДЖDb16ЃДЙА„1 ёЌЊЅ,™К*®A"СH§RлP@†»D ≥hXP§"І 5Yґф%÷*®Б,Џ< ®ABлэТ√≠°B™Д)КE.±U"
Д@А Ћ6ХTаЂ6Щ:≈U%ЫNBЩUі(Bэ≤e≠°R÷–°c rК™PKФUQ\ђџFЅ`∞EVа "љЖYµі%ХeBЕU$"< 3@ m
e_ °UJ	T`Ч(™ҐЇƒ  6ЁГіC"*Р!  U$Up b™ДЌ  Wј)ЗtBЕU$F"®A,;n*©"1H	єEU$F"®Ѕ"ґmV
uКЃ  eҐ}	0о8TЈј(Un +„шeЫa¬ЩT ,uTјµ\ L fў`¶meTp±UJ	T`С  "®A"™ИлT Цmњ
eTpґ4T СК°∞и–X™£ИƒU$Vеfё0°[Dъa“†єj8X™б :ƒ( 6’_«цmƒiV0±UJ	TаЦiT†СL	ЦіЕК≠† §R)Ї≈W†$2еTјЦmэTаЦH  !  V ,B YЈ∞%÷*∞lЏD Ј°b0 rеfЎ–±6љК№Ґ0 rеfўр±6—ЕКўіш-Ґ}	3hH[6ЁЕ≤ЃhX™јИƒV -Зbƒ ` е Ќµ°b±[6ЎЕКђ XђE`ƒa Ыd¬ЩWр,B YЈL-ЫmB¬.шeЫ~Щґш-ХEC ` е ЌЊbґmЎ≥oШ[нИ@јЋХЫBlЏ6 2GU Ы@BЁb0Ы{ЅƒјлШo[`’X f“АЅ0 ъж@ўЈф-ХUГVЎ " DVЎ uP іш0L >єЗжс  TmZ ЃcБљЗi$0 К№ 0на`ДД [АЉХ@+p √ЈБВ† En vр0BS ≠јё0наc6јW@¬ ЊЖ 0@ ±бБ    √≥Г™В Ќ≠!В`хћ7≥j8c*к@@„А@+И :® џА& \ј{6дЖ2ѓР`ДР aяPЅ	0 "Ј@™Д ЌїЅВ` Ка ™6юP m	\ G f— јИ Ќ°°ЃQF f—`÷ИdEo 5$ЫH√B  6ОєD5 ЫKГZ!СЊ Tрm\АLfФ3)Ђ§™!∆K√*r
ЪФe<.°Ч"$ЂFuB"r:,fP.!Ч#™FYҐrb,gШ.!Ч&*FMrrj™b§gи.°Ч''™FQГjrЪ¬§eT.°Ч*)™FLBjr™"іdа&°Ч*¶"∆`Ѕкr™b§eи+!®,¶Ґ¶∆  "ҐbМ` ""Ђ$°Ґ∆  2"2Т
j,dД%Ґ(!F\ВЏ"ВDe8+")+* °Fj¬b"Ґdf%"ЧFy√)qД` "ђ'ЂFK≤2"Ґ*¬§f '#&'®(,∆N√R9t` #ҐІ&Ґ©∆  *:*rj4dl1$FqАrB
Т"Їgћ%'F  *ВzzbМd|1(ЧF  *К
Ъ,` (°∆WBТЩtwX)Ґ™'Ђ)FPј™ЪҐ
Ґ,dд)™)!®,ќ   ЕPРQ”`T$E4ў@ ‘ђЪ  @ (Д  r≥@ B 9D  ФB  9D  ХЪ  0X,Ею€d∆@@2
ҐЪЇ§t ° Ґ)¶∆  "ҐbМ` ""Ђ$°Ґ∆  2"2Т
j,d0"+!ѓ§ ∆  "*¬zі` #&'®(,∆  9t` #ҐІ&Ґ©∆  *:*rj4` $ ©"+†∆  *ВzzbМ` ®° ©Ґ∆  КdД)Ґ°ѓ§ ќ   ЕQ—С`TDфEdY@ ’№      @ еЪ  9D @ еЫB@T Ъ  3k Д ≥hИ МFеP m А * *†@бэЪ  6Ђ6±А@АЋ6РА@А ЋФU@Аb* +іC.QU  f“†2 dЋXјT  F"† ґh  |Z≤Ђ∞±А2c' єQMR0 ’c  Y%0 СФРSQc†А=Y0 V’£  1=AAf2Ў СЋ£  95N0 Q—SУQ£(ј	 Ї0 ТTС–c  A==1F2Ї ФK£  E	M0  ФPз   ЕСР“S†dEd5фД@ ’h   Б Цh  √©А` Ќ  "*  ењям– ХI@/чы$U@ Ґ  rЌ†аVh  Ѕ`К® $U@ ђ– В"†  Т√Ђ – Ж   и    1Ф–\¶ЃТ®З  ИjЙК1А ИКђТЖЛ  »И H)®±У 
ИЮИђЛ »К»kй1СјК]  ИЂ	к—А МШЮ††≥  Hе—А ОКЬЪКІ  ®и©…®—ТаР]  …*HКи1А 
†ЮЮШ£  ™(H*h±А ҐЗ  j)ЙЙсУр¶†М§КЛ8  ЕС—U’’ dtUE5uI@ ‘–                                                                                                                                                                                                                  Д`  "Т   ) ¬ \P  ! ,–  !•`nVh  Ѕ`И®  НЪ  2ѓ` Ею€dИ@ 
 P +4  p±Z°   3@ UP (D € њямV®Д r≥@ ВЅЦПАИ@ в’Хo D   КД @ в’Хg@ET  Ќ  '—Х rК®@ FЁАY† 4  eVаU И®@ФCnјђ– ВЌ©†,™÷√≥†,;4:°А–  FЌЉ`+:°АЏдs?√,ЏмЌ  VPЗGјЎvhB  ®@ґhЗK@ET  Ќ  "™  еf”†EJ€Яђ+r√ЈА,:>*† Q rИJ +4  `∞X"6mЖe]ААјQ rИmxФCm@ђ– ВЅ`∞DT FЌЇ ,™!њƒT(ЗGј≈T !µаQ.r≥@ В"†А6mЙeV†!U Дm® eЫtАµ( Ќ  !гь2ЌЊА,™В! АuЬUA !j f“p&m*r≥ip"ЂЖYіЎ	ХY Д/чы≥Б@ 	k8КеА
®0ФCkјҐbеf–р&В"†А6meQр1U Дm® eЫRАДT4 B  ® ™Б _Іцh  Џ£аl;f*†@1 aў†!U Дn@ e *°†Vh  ЅfА ™ Ќ©†NVh  Ѕ≥j»
у
®h6еБZoрЋ6к3l
ьБ
®h6оБZѓрЋ6т3o8*ДБК®h МEC@wUC@b* +fя #в’ЕG Ўt|Зj@•£аr—р1U  r≥@ ™Е 2JD0§  У ЫА*ВШВ§ЫЅИ*Йй1ЦА,В™®Ю§Ђч®e……кСЧрЖ\¶∞©°®e КjСР0ЖШ\О©cH•—Я†&К\aч »…)И™i1Чp,МЬИ¶Ѓ©Hе—ЬРОК®¶®•Њ »и™КjкСШр$Р]ѕ…*hЙ(й1ЬP$Ґ]Ґ™HЖIИ—ЮР¶К®¶Ѓ©$ jiЙкqЪ†¶†ОК®ЗЏ  j	к©—СР¶†¶ККЧ_ jКIИ©—Х,®Ю™††Л8  ЕТQ—ТS dФE4dФ…@ ’h§АU  9fА ґh   §†™  еfА [6ЖА2©( ™А 2e§†™ еf—p6О 2™  ™Б 9D  ХЪ  0X,ЦH P K$ВM$СE√Ад A&ТHҐв	L. ®e……кСА Ж®Ш£  »И™…(h±А ИМ§ВЪЛ  ИЂ	к—Т†МК∞Т¶©< ®…И™JQА МШЮ††≥  Hе—А ОКЬЪКІ  ®и©…®—РРР]  …*HКи1–@ТИ¶МТЩ  ™	ййК1А 
ҐДВ¶Л  J(sА  ЕУ‘Ф’’ dхех5x	QM]RCLS_SWФ  M[@k  €А ™  еfА [4  eTАU  rИ@АЋ4  rИA +4  `∞X"* #f— UE P (Д r≥@ Т√ѓј  EAАT "ш?≥@ ’~ a÷pU И®0І 
®0 •÷! ,Џ@ rИkH4  a’–	kр Д r≥@ КБ 9D/чы4  eZ@U r≥@ Д r≥@ $U@АҐ  !  ђ– ВЅ`К®$U@Ађ– В"†@™ #>-YWp UA ђџ0 Ѕњяв* …    U  rИkPХЪ  0X"+Ї #f” U	fџ†U  rИ@`+6† 0X,С  "їаЂЊ |ўµTµQ@Xt†Uwјb+Њ √°а"ЂЇ е]рKђB Yµƒ 2Ќ¶ј.Vh  Ѕ`∞ирД4 rКЃиХЪ  0X"ЂЇ еfА mЇ А Т	4ТE е@\Ж ОЁ d%E5uHѕШC.NOTМЛ ‘2еE5HпCLS_SWМйАd4≈5хEИј CTLQМ  dDUdФ4Xј DFRAMEМ« $Rиј EXOVМЖАddUДХ5H» FLERRМ  ddƒхШ…рFPUTSМ  $rиј GENMESМ  TtTд‘h…–
H.М  dД$EtЌ NFERRОД dхех5x…@OPN_TXМ  Uфф≈Ћ»Q.М  U$4Xј QCМЎАe4UD‘TЎћSPALLOМЂЕФ—UТS dдхD‘d(	e	eINITVAБPQ DхTиM=IRDELETEБФ‘Р“`eu%DDХ(I5=YENTERБС—USХ dФе4U%H]IQ9RMATCH8БTСSХ d4ф’)A∞„D"Z  ! \ҐИеfА 6ИА2Y†  Д rИ@ +4  `∞D   еЪ  ђ™f Ќ  t–Т…Ч    ”P	i® x 3@† sФ|чvЮ]ІЖ3АCKАЅP 
А,Џќ н!А † "7 O√  ЗZ 2÷АUW rИo0;ХЪ  0X'—Р  :Ѓа–  шµaX†m  f—Ui Б@С  `   *≥ –  D  
ђЎ МEi X  F#` m&   ђ  #И∞ 6ўАА V  ИƒX Ыp@@  Ђ  ƒb,  Ќєа   UА b1  fЁ–  *ј 1Л  3oX И  А    UmА@  ™‘ 3lр И  QXКК ИѕЛVU/PАm Ѓ`yљЪ  3@ UIP КЫ К©D  И©иЙАЋR@EVД *І@,–  "ъ?≥@ ХfT†XКЃА∞кH™≈А®ј™µ ЛАШ 2"≠†"™м"ј ђ  Ќњ   ЫL YVPUa@ElџЌ≤@,ЂP!љ@оVh  ЅА +!  £  У.       [`!  ђ– ВЌ    ХЫm@X"("јј  *јјVm	 `∞D4а! Ќ  "|еfЁ∞кљ 3kисj њ@B™Ь"јА  E^@EUД *Њ@,ЏҐл_∞h   ЊаL:<*° B1aя– еQР И< Ќ  ђЏ: Ѕ`ИD +4  `К∞  DВ єYіЎ	В!™°Vmг`К®X6Т Ї≈XЫC ЩWіUБ "СH•÷*††!С `` И4 f’&mХeWр&h  *јАРЫJ@ЭbЂш r≥jPЪ  3@  еR0 И< Ќ∞јNVm-`∞D"АХЫPАШ"ђ ЌЃАB`хћ7Д@  Ћ6џБ9Y† CVBђџЅ`@ ИH Ќі`N±UКДA  ЋХЫt Ш,џ,*јА1 a—@& f– m АјVh  ЅdЋВ        ЦДБИjиCФCZ¬ђ– ВЅ  ™.|Z≤≠и™НєE@ ФBА 9Y† ВЅR`1 `АМEВ bґmВ  ђ Ќ®Аb   UQј¬( 6н∞P ®  uК∞P dEWј≈@ ФUВАіEZА≈TИ *¶Аa  2е`†+6Ч∞X,Ug  ђ лБ –  EВАV4÷*Ѕ@С†W@7(Ђ 3kИК’Б≥l–+жБИA 7(ЖЈ9YЈHВЅf—LЄ8   Цз≥jА Л 3kЄ*Г
∞p §R)uКЂЎdl U 7(Ђ 3@ Uы^А1XКъБ≥n» Ђ 9YірВ…Ч   –pFmPa V >-XUЫdЅX@ U~@ƒb*8*¬ СH•÷*Љ@aЧ(Д  rИA +4  `∞X"ђ  еfЏ f6мВ
∞АХЫEX,ЩjА ™Х @  D Дix#Ф4ЊXђџ|Z∞D ЅU vРЬ#Д  dЄLЦLµрВ—pєZђP0 4Њ÷мБL цdИ@ LЄH     %≤`В™Ґ ",$ ! АXP UДАЈшµe\ AV В С a@Л
 0н ™ґВ:≈XPЪ  2Ѓ® Ђ
 Ѓ Ђ
 2e¬ј  ЈdUeXX UЕАb1 rКЃШ#4  Wp7(Д  r≥@ U{ЅҐЂіеU00К  ЌЂ nVh  Ѕ`∞Y2бА  Z(
*њАОQ 9f‘–7X™ВЖ\ђџоЅ`≥@ UrИ@ (Е  r≥hp+ВЅaАV †бУв’ХUБD6L! Ќ≥а,LЄh   ЦЂВК©p+ФB Yіt÷*§ °Ч+6У∞X"™∞
е” W(Е  r≥l8ВЅa†V †бУв’ХeБD6®! Ќ™`ђh  …Ч       -ЪP PИ  aјUРaаV  c` Д b UйuК± 4  eRАf№b Л 
∞а D И∞а№К∞а6”Вђ™J*√АQV f÷ W+6ШГ0X"ґm-eQ aV ИƒXx *√АџЎ√§†¬ђ< #И∞р Ў # XА Ќі@ћi(3дК∞р Ў # 2в        %¶ ¬  rЌљаҐ±" ААЦm6И±  Д b`V& >-YVxЗXБЕXШ V"ƒј:Ъ*ƒ@1" fё W(Ђ ƒXРЫZБЩ† *ЌГ
±6ЇГ9EXРЫ`AЪ,Џ∞ ≤а¬ЗfБД  %ЗVД  &\P         -ҐААЦmAКE.±UЫИ±P ™“ВИ±` Ђ ƒb,X Ќіа«≈Ђ*уГ
±`6бГ9EX® Ќ¶ ћ≠Ы~AYWРЗyЅШvиUЛ Ј8EЛАX∞ F#bјX≠ЫzЅПЛVUaя fрЦДК±`ФUЛ bґmыf–∞g(Ђ 3kј3*ЦК±` ђV"≈А:*≈А±XЛ 9EX®ЫEAў2г        %ІАв rЌҐ@вСH•÷*µјЅС0 [Pa2 c МEМАµшµeW†qV2 f’–w(Ђ 3ox*їГ∞л–;™К±Р6іЯђЂv*∆@1Л 
≈b,h *∆А1Л 
≈nQV2 ИƒX» V+f„аvm9>-YVаЗdБЎvHЗpЅƒ7 ! Ќ≤`ђH®T*	∆у†А¬ #ЩM¶Уq§@M#Д3…ћиe6ИB°P® M#АSq∞“k2Ы"Щджt2ЫDCСД∆kM¬$ЮS'3Щ‘Џi7ƒ  А@  А@G2ЫM&гHАЪu6"“1Љдm0Э§"I<¶  ћІC©ј  8НжsСДЏ +NG3IЉ№ √И @= "  В:# D“	P¶."JА©И C0ЫН∆у†АЎo1ШNЖQЮR&РJЕ1qВTЌ¬!»“v2И P®TD4Ьћbє»“t2ИІ#СЉд*
А°P®Иi9Шƒ#)Д» 2ЬОFуР®T* Fу9»¬mNG#y»@4А#)ащ}%9b0 СХ£,а1	%=N0 РУ–“‘г  	==QMj0  –Фг  	UJ3jРХQФ“V£Ґ 	e	e34PЋСU£8 ±є3ЋС’#9@Сє1R2РЋУUS#;А’є9=R3‘PЋФ÷#*а5єQMR2№Р“SУСc  1=.3÷Р”СS”#5†55=:bР””TT£6 Y=9=UR3r‘У£5 qQ0 СQСХ£  1R;ЬСSUc  9M%R2Р—T£  %IR0 С’PУc  A
3§СРРTг8АAQQ
0 QТUСc  IY962ћСХХP£-айЇ3™—KМ#†аХ9QJ3АQTФУ‘£(аa%R0 QРUQ#;јYQaR0 QТTФ’#  5Q	eR0 СУUTг  5QIZ2Є	QУUQ#  5QQA&0 СУUТг"@u=A:0 СФФ’—c1 …Ї0 –Tc  @ 0 –Tг≤`ЩQ9R3PТ£ґ 1!0 S#7 є!%!N3&ТS”—£/†Y!%1}=:3:Rc  %9b:jТSТUРcі@ў%9MIR0 ТSХСTХ#  %9YM%0  R£&аХ1%I63ьSSRU# †q1=.0 ‘#ѓАЩ5Q в0 SQQPc<а-5
3NS’Сc,@	5N28УЛ£)јY9I%Y0 SСРUг† 9=Q5
2УХSU“S£  =MR:‘S£(А%B2VP“г  AM9V0 T“—Uг9 YAUQ9U63МФU–U#<аYAUQMQJ0  Tc5`йDЇ0 TS—С£™аµI9R2фСPQ#ІАщI5=Y0 ФСT’Тг,АєI}	M3dФЋ£  M!92дФ—P–ХQ£  MQI2“Ф—QR‘Рг  M%0 T“VСQ£8 5M5=Y;4”‘Х#  MA0  ‘‘#  MAR0 Ф‘Vc  MAR0 Ф‘“SТc™ ЩMI!&2вФ’Р”T#4ј9MeMQI.0 Ф÷T’T#  MeM}Qf0  ’У#< QI9M
0 U“—Uг8 MQQ22$ХSУ–“г2аєU9A.2tU‘ТUcї Щ]IQ%J:(Х‘ХSХ#=ј]MAp  Ю M!92дФ—P–ХQ£  MQI2“Ф—QR‘Рг  M%0 T“VСQ£8 5M5=Y;4”‘Х#  MA0  ‘‘#  MA/*
.he                                                         SETFMT(SETFORMAT)
.pa
*/
#include	"portab.h"
#include	"setup.h"

/* Module for adding / updating formats in FORMATS.DAT			*/

WORD	g1,
	gh,				/* Gap limits 			*/
	gl;

/* Local functions to reduce 'publics'					*/
STATIC
VOID	getdrv(),
	getsys(),
	opsys(),
	getcpm(),
	cpmdos(),
	getmsd(),
	msdos(),
	gaplim(),
	do_sdf(),
	do_szf(),
	df_szf(),
	printps(),
	printsk();

/*======================================================================*/
WORD
setformat(fill)                 /* Read in the values for a disc format */
WORD	fill;
/*======================================================================*/
/*USE
Portability	Level 4 (Depends on Gemini hardware)
Parent Module	SET, SETUP etc
Revision History:
06/11/89 Gap1 lower limit (g1) introduced (BR472)
         (Change in SETFMT / GAPLIM and SETFMT / SETFORMAT) - ICFO
04/11/89 Format byte must be within certain limits (see Page 14 of
         WD2793 speciАе54ƒх8ЌшSPFREEМх e5хTи pSPPUTCЬ   ЕФР—SХ e$4TеI@ „X       9fА Q( 9f–∞m rИA Ћ6Л D [ХЪ  0X, 9f—а Й rИA@Ћ6Ш ƒlЏx Ќ  ђ– В—>ДДT  U@ +«шeЪ  2Ђ@ ™А UПрЋ6ђА3k0*Љ 
®  En€≥kH6ї 2ђШ Д ≥j6ЅА9D"`ХЪ  0X,С 9fЎ`h   іј Зj@ @ КБ @   P  ЛрюЌ  WHЗtјT  F"† ±U И®ў A Ћ6ћ @А ЋФU@ -Ћ6м ®  ™В 3j 6ЉА2® ™В 3ox EJ€≥oР6Б ≤© ™В 9ET F"†Аґmы r≥j@Ґ}	0пX ™В 3hЄEJ€Яђ+*†А1 НА™ )uИ@јЋ6у \Ґ™ Ќ  TЫJ YіХZАETЫU@B*7шeЫV Yµ†Х^јET F"†АґQP@∞ЗeјET RлБАЦmGєETЫSјD @ еЫc@B" e *† HЪ  4C.Q( 9fўјИ rК®  •Ґfџ@(Д r≥i0ВЅa№  …М’ д2д’T≈HћЎC.NOTМ№АT2еE5Hј CTLQМ  dDUdФ4Xј DFRAMEМµАіRгј EXOVМ« TdƒU%(ј FLOPPYМ∞А§rиј GENMESМ  TtTд‘hќ
H.М  dД$Etј POOLQОГ e$4TеHћ®
Q.М  U$4Xј QCМе е5E$д5»ЎTOUPPEЬ   ЕTСУ†U$C$ƒi@ ’    ЦБ @@Ћ4  r≥@ КА ^ѕрЋ4  eSјU  ≥@ / P  ЛЩюf“ m eSРэю…a– U  d∆K@*rrz§` !™&(∆  2"*≤J,` "#) ¶Ґ∆L )qД` "ђ'ЂF  22bzВВћ` #ЧF  2:*rj*Ь` £ҐІ&£FAјAt` $ ©"+†∆  *ВzzbМ` ®° ©Ґ∆  Кt©"&#FBј2ЪВ:*Ґа  ЕФ—P“S†e4T5фД@ „†                           B Y†  ђшµaS@U r≥@ КВ @ HД ≥hиФCyAЬђ– ВЅP 4  eU0эю…–ј+4  `И®  КЛ 9D/чы4  eWp еfА mїdИ@АЋ6ЬА3jP*≈ @ Н АА*$ *Ґ@± ЯђЂƒ Ќґ@¬* nњ√,– ХwјT FЌѓа+В *†@3ь2Ќґ@џP  їА rЌѓАQФ еfА 6ЁГ2XvtЗd T  Ќ  "6mњ e_Pmїd≥mР0КБ ўЈ∞ЕC ET "жЖYЈфЫpАTЬB YЈ0 !Ађџ® Ѕ`≥mЎ3&ZN*†@Ћь2|Z≤≠X™А 9YЈЬВ#f–†UFfџ∞fH™Б [ѓр…сj¬™†,;V*†@+ь2|Z≤Ђ∞Д ≥hЄФB% 9Yі|ВЅfџ∞fK6ў® НЫO@XV4U@А.gшeЫ_АYі4Хj D   еЫYА\Ґ( Ќ≠ј,6ЁГ2XtЬUC b8Ъ  
]b™ PА А *  ! ,џ0+fЎ∞UА * А† ђUB ! 2еP +4  p±ZҐЪ  3@ 4  aџ09h(™Б [ѓр…сj ∞ lџd"†@6m–aRА!U єЯбЦmfЎаUCААЦmћrИD†+6– ∞X,џv…Q КИ 
≈.±U єET Ъ  ®† ™Д 9ET÷*°АЧ(™Д D h  —fА Ђ! ,ЏfеЙ@Vm;`∞YґмТ*° ( 2"° џь2А.QU  r≥oАЕ¬Ќ† B™ lњ√'≈Ђ*ю
®† МEE nQU hЯBLџd"†@6m&a]а!U єЯбЦmѕf“Р&UщААЦm}rИD†+6¬Б0X,џv…aЏј!U И®† ђl P +6Ь ∞DlџЄ £ lџv…ЦМБИ@ в’Х_@ўґ»E@А,WшeЫD ўUU@ ђЏЅ≥i`*Ґ≥mЎ3%ЗYј≈T "ЁЖYімЕWА≈T "ўЖYµ<ЫwјЩUЬЗ_@еђаb™  еf”`6НЫW ўUиЫnЅЩ,:2√††B™  еQ`(Д ≥oH6ЄБ≤ђЎДd aўа1ћ еfА ECАlџ  ґ`lџv…ЦўБК® ФUCА"P6пАЇ≈T 2А,– К’А@џтЌ  ≠Q  еfА В#fЏ†6U ААЦmНrИD†+6шБ0X,џv…ААЦmрr≥i–#EBАҐыэЫYАTtB€≤ET *°@Vh  Ѕ`К® ХЪ  0ETТ    ™ "І Мџd"†@6mжaUpAU єЯбЦmHf’р6UrААЦmrИD†+6ь∞X,џv…Цє
® E≤€ЯђЂД*І В18єETҐ}	3mР0КБ ўµTЕiT "жЖYґTЫVVьB YµИ !АђЏ‘Ѕ`≥mЎ3%З\БTаF"І В±∞ B ©∞#6ў®ХЪ  0ElџD¬љјВ™ yњ√,џЊЌі†МЂо√Ї@В™ #fёјFP  ЛЩюfяјFmпeR`Q 9fЏрG(ДJ r≥mЄ#ВЌЈ`ћСU8И©ј ≠ *†@иHUMБ/£ы4  mZ`fm≤P +6н0Yі$ХWET "уЖYі0ЫVБYVМU@АlЏЪ
¬ЃјҐ™ s?√,Џќ
ЌЂ†ђЂ"
! ,Џ,
еЙ@Vm`∞YґмТ*І В18єETҐ}	0к(™ЫƒTЎUNb*p+ ґ»E@АђЏТ
Ѕ≥k†+
иК® Eж€≥n+6їВ≤Ѓ»+ЏК® НЫsБXWіU@А.gшeЫwБYЈDХBД   еЫ`A\Ґ( Ќ± ђ6ЁГ2ETаF"І ВЈ(™Б 4O°!U ±_бУв’ЕhЅЕT  Ќ≠Аl6хВ≤©∞36ЁГ2ETаV"І Мџd"†@VmЉ`КўііЕVAЕT "уЖYµ(Ы{БYUИЗOAЕT FЌ™аћ*м*†@3ь2ЌђаћЏі ≤ ¬ rЌњ ЃQФ еf– fЫnЅЩ"™p#SАA[ФU@А'–УЛГ0й®(™Ь9ETЫ[јЕlСU  r≥@ $U@ /уы6ЮіЃx0™А 9YіЉВ*†Аыь2“Љ ¬™ еf“†Ею€dФИ` јALLOCMМ–д$Фt‘TиЌрC.MULTМЇT2ддхHќ5C.TSTМўА‘2еTEhЋШC.UGEМ  D5D≈ј DEVICEМ  dDe$‘X»†"E.МїГ4Rгј EXOVМƒГTdƒU%(ј FLOPPYМ  $rиј GENMESМ  TtTд‘hћ2H.М  dД$EtќРHI.BLМҐГdХ558ѕаL.ADDМкБ‘¬е5T(ќPLLONG.МЄ TдdU%(ј POOLQМЂ%иј QBASEМ  %8…@5RD2LFМУe$TƒƒшЌp2S.ОМ e4T5фДЌPSLONG.Мжe54ƒх8ќр6SPFREEМџГe5tUD8 SPOPENМпе54TTЄЌ(SPTELLЬ   ЕФ““T‘аe4іХu9@ ’H   ЦБ @@Ћ4  r≥@ КА D h   §А™  {?√,– ЫHАTјЗ@Аt U@ l– ЕQ T  "жЖYі‘ЫI@U8 B€≤ET У Иe»и±Ф 
Ж\ЬЮ©  ИjЙК1А ИКђТЖЛ  »И H)®±ФPК\a  ИЂ	к—А МШЮ††≥  Hе—А ОКЬЪКІ  ®и©…®—РpР]  …*HКи1А 
†ЮЮШ£  ™(H*h±А ҐЗ  ii*
кqР∞¶†ОК®З8  ЕФ’PУ÷ e5DD$щ@ „ƒЪ  @ (Д  rИJ (Д
 r≥@ ВЅБ Q  еЙ Q еfА В! Ґ` ! Ґ( Ќ•`В!АҐ ! Ґ Ќ®@В! АҐ Ќ  ,TР(   r≥@ Д rИD`+6і 0X"© 0m r≥kИB 9D"јХЫ_@,TР0Ѕ 9YґВ!АҐ` Ќ≤@™Heјђџ6 ЅfА  !АђџN Ѕ`ИnиХЪ  0E@  ђшµa]ји r≥n@Т>ЛEҐ—hіZ-АgAиАИ:@Ы@ДЮ∞КЬЙ ®Iл
jСС@ЖШ§ДЮ±  ИjЙК1А ИКђТЖЛ  »И H)®±ХР
ИЮДЮ±  ИЂ	к—А МШЮ††≥  Hе—Ъј
ОЖ®ВЕ  »и©…®™qА 
ОКЬЪН  …*HКи1ЫрЪЮђЛ  ™	ййК1ЭР†™®¶®•∞  
™К…(СА 
ҐДВ¶Л  J(q– ¶®В®ДЯћ  Л*ЂиsА  ЕФ’UTаe5DEU9@ ÷ђ      9fА ≈Ђ
ЪА@ (Д P (ДD rИ@`+4  `∞X,$ "†@:™ ! АҐh E@ Ґ !АђЏL Ѕ`∞X"P E@АT *†@РИ  f–∞+4  `∞D   еЫXА$А4  А РЙ fА ;F ! TЗm "∞ КБ 0н† ДX P і aџ@h a@А T YpH   P@(Ж‘АєY† В*†АQU Дjр eЫ[јђџz Ѕ`И@ (™В 9YµаВЅААQ 9f№а Й  ЌЃ†р r≥kјВ*†@≥ь2|Z∞Ђ†™В 9D @ еЫ{ !  2ЌҐ`"* 	 Ј»÷*  !H 2еf÷`UA ҐRеfЁ UA Ґ©!–  r≥iрВ*†АQU ДАЏHлRАЋХЫRјX, еP@+6Љ ∞X" Т! ,Џ6еP (ДD rИA Ћ6ЊАєY† ВЅr≥@ B Yґ4 Ќ  ,С 3HЛФ’“Uг+@9є5U1R2ТР”РУ÷#  Q1F3кСUТP—c  I50 V’£+ј9QaR2.СУ‘c0 	Ї2ОС—SУQTг  953BТ£  !I]3"ТХT’Q£3 15=Y0 T””c4†9AUQMQJ0 TPРT—c  	E:Ф’UTг,`9MQIR2bФ’Р‘g   ЕХР‘`eDEd5Щ@ ‘† B Y† ФB Yі "H 3@  И  rИI +4  `∞X" У »e…™©КССрЖ†≤ЪКЫ  ИjЙК1С`ИКђТЖЛ  »И H)®±А К∞Ю≠  »…Йк
1А О]  »и©…®™qА 
ОКЬЪН I—А РВ§ИЃГ  ™	ййК1А 
ҐДВ¶Л  J(q– ®ИђЖ†≥fication for details) - ICFO
         If there is only one side to the disc then only one side
         field is requested - ICFO
01/11/89 'kflush' introduced - ICFO
14/03/88 Now refers to 'Lowest' sector number not 'First' sector
         number - ICFO
10/06/85 Various additions for MFB II. Format tables restructured &
         various extra fields added.
10/06/85 Version 3.0
24/08/84 Modified to support a logical skew across a whole cylinder in
         "T" format. (Previously it was assumed side 1 was a duplicate
         of side 0).
         Also most text was encrypted by SETHIDE.IT.
         Written by David Parkinson
         (c) dci software 1983, 1984
*/

{

/* There is a static default initialisation string that may need	*/
/* alteration if the variable declarations in SETUP.H are changed.	*/

LOCAL
BYTE	*p,
	notW;

LOCAL
WORD	first;

STATIC
WORD	ival[] = { 0, 'N', 'S', 'N',  'N', 'D', 'L',  96, 80,    10, 512,
		   2,  34,  35,  37, 0xE5,   1,   2,   0,  4,   128,   2,
		   0,   0,   0, '*',  'N',   0,   4,   4,   4, 0xfe,   2,
		   0xfe,  -1 };

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (fill != 0) {			/* Set some intial values	*/
    first = 1;
    zero(fmtid,127);			/* Clear out			*/
    ldirm(&fmtdrv,ival,sizeof(ival));
}
else first = 0;

format();				/* Set up the display		*/
fvalues();				/* Put up various defaults	*/
if (first != 0)	{
    putsfat(5 RC 30,"--------",8);
    putsat (6 RC 30,"________________________________");
}
while (TRUE) {
    if (abort(0) != 0)	break;		/* Set abort break		*/
    first = fillname(first);		/* Get the format id		*/
    if (first == 0) {
	getsys();			/* Get the operating system 	*/
	opsys();			/* Update the system prompts	*/
	getfrom(6 RC 30,fmtdesc);
	if (*buffer > 0x1f)  movstr(fmtdesc,buffer,33);
	putsat(6 RC 30,fmtdesc);
	getdrv();			/* Get required drive type	*/
	fmttpi = getint(9 RC 20,fmttpi);
	fmttrk = getint(10 RC 20,fmttrk);
	spd = getir(11 RC 20,spd,2,1);
	do {
	    spt = getint(12 RC 20,spt);
	} while (chkspt() != FALSE);
	i = bps;			/* Temporary save		*/
	bps = getint(13 RC 20,bps);
	if (bps > 1024)  bps = 1024;
	bps = power2(bps / 128) << 7;
	putnat(13 RC 20,bps);
	if (bps != i)  sizef = df_szf();/* If changed set new default	*/
	do_szf();
	density = getltr(14 RC 20,density,"SD");
	clock = getltr(15 RC 20,clock,"HL");
	invert = getltr(16 RC 20,invert,"YN");
	invside = getltr(17 RC 20,invside,"YN");
	schange = (spd==1) ? 'S' : getltr(8 RC 46,schange,"SCTUB");
	switch (systyp) {

	    default:
	    case CPM:
		getcpm();
		break;

	    case MSDS:
		getmsd();
		break;
	}
	index = getltr(8 RC 73,index,"YN");
	fmtbyt = gethex(9 RC 73,fmtbyt) & 0xff;
	while ((density == 'S' && fmtbyt > 0xf4 && fmtbyt < 0xff)
	    || (density == 'D' && fmtbyt > 0xf4 && fmtbyt < 0xf8)) {
	    error("Invalid Format Byte");
	    fmtbyt = gethex(9 RC 73,fmtbyt) & 0xff;
	}
	printps();
	frstsec = gethex(10 RC 73,frstsec);
	printps();
	pskew = getir(11 RC 73,pskew,spt,0);
	printps();
	gaplim();			/* Set up gap limits		*/
	gap1 = getir(12 RC 73,gap1,120,g1);
	gap2 = getir(13 RC 73,gap2,gh,gl);
	gap3 = getir(14 RC 73,gap3,1024,gl);
	printsk();
	if (spd == 1)  sidef = (gethex(15 RC 73,sidef >> 8) << 8);
	else           sidef = get4hex(15 RC 73,sidef);
	if (*buffer == '*')  sidef = 0x0001;
	do_sdf();
	sizef = gethex (16 RC 73,sizef);
	if (*buffer == '*')  sizef = df_szf();
	do_szf();
	sp_init = getltr(17 RC 73,sp_init,"YN");
	smove (19 RC 24);		/* Sector translation		*/
	getskew();
    }
    abort(-1);		/* remove abort linkage */
    first = 0;
    fvalues();		/* Redisplay for confirmation */
    do {
	putsat(23 RC 20,"Save, Delete, Edit,Ignore ? (S/D/E/I): ");
	switch (*buffer = (upper(getkey()) & 0xff)) {

	    case 'E':
		break;

	    case 'S':
		putstr("Save");
		enter();		/* Enter the record */
		return;

	    case 'D':
		putsat(23 RC 20,"Press 'Y' to Delete ");
		clreol();
		if (upper(conin()) == 'Y' ) {
		    putstr("Deleting");
		    delete();		/* Delete the record */
		    clreos(23,20);
		    return;
		}
		else  break;

	    case ESC:
	    case 'I':
		return;

	    case S_DUMP:
		scrdump();		/* CTRL / P			*/
	}
    } while (*buffer != 'E');
    clreos(23,0);
}
abort(-1);		/* Remove abort linkage */
return('I');

}

/*======================================================================*/
/*
.he                                                          SETFMT(FILLNAME)
.pa
*/
/*======================================================================*/
BOOLEAN                                            /*			*/
fillname(fill)                                     /* Get a format name */
WORD	fill;
/*======================================================================*/

{

/* Get a format name entered into the display & load the values if it	*/
/* exists (only if FILL is true). Return TRUE if so, otherwise 0.	*/

/* A name must be entered.						*/

/* - - - - - - - - - - - - - - -8  ЕФР—УU e$4d’I@ „Ф                                                                                                                      ! ,–  "E \ҐP rЌ≠јVh  ЅfА 6h   Ї`@ rЌѓ@8 2Ќ  +«шdшµe[Р  9fў  Й ƒc` Д  d∞оШ Д ≥m8 DB ДB@ ЋФB) 9Y† В…ЦйАA Ћ6я Hа Ћ6ЋАWПр…сj љј Т! ,џ∞ Ќ∞ј™! tB Ђ ™∞А
]bP rЌЊ`ЦmPРP еPР(ЖЕА9D4‘ Ќ  ,EYјlџм  Іа"ыэТ! ,Џ*"А,ЏИЌ  U∞UYјҐ еЁ7+4  `∞X"*Њ #f”`mNeP@1Ug rИhXФCu №ђЏјЅ`∞DU| FЌ≠†,ЂF*ЂаРН5 ≥jX6пА9D  4  fЎРU∆– (™ѓА
B4‘ 2Ќ≤а.Q$ еfА З|АD ` еЫmА\ҐP rЌє`!( 2ЌЇ`.Q  r≥@ В#f÷†UтњямЩoР™≥А9D4, !ЇаnVm`∞X"*Њ #fЏ@U8UрHFЪАYЈh ! ,Џ.еfА К±АўЈ§ХM@Д/чы%ЗOАД/зшК±Аh  КДА
®HФUB@b* +fў†+4  `іO°#в’ХXјШuC@ Ґ™∆ еГ ЦmС@ЦmprИAАЋ6їБ9D † еЫ_јЬђ– ВЅ`∞X"6m,eY–!эю…Б ЦmЗrИn–ХЪ  0X"  rЌі@NQ  r≥@ B Yґћ	 !їјnVmї`∞EUМ F#fў@&UбКА;–*ђ`А 2}P   }P 9f№@'(ЖА 9YЈ0	ВЅА *Њ *ђа±U_ fА Ђj√§†b™Њ #Uр[ЕК™ш §#Bј,џреЁ@7+4  `∞Yі$	ХV ≈U| R°`Цm.rИnЄХЫMАЎ,m;f’`6U≤Б ЦmIrИoХЫ@ Ў, 9f÷07(™ѓА
B4, 2ЌЃАnVmk`∞D @ еЫ` №ҐЄеfЎ@6B Yґ4 *ЂаРН5 ≥lрХЫe@Ў,VKђB
 Yґ®2еБАЦmњfЎ   …"Аbx МC Йг† ЉМC а»РC.GTМлT2ддхHј CTLQМ  dDUdФ4Xј DFRAMEМ  dE%eD( »E.0М  DUДхhќpFLERRМ  ddƒхШѕшFNDSWTМ®Б$rиј GENMESМ  TtTд‘h…GETFCEМс дtUDdдЎЋрGETOSМд§Виј HARDWAМ–А§виј POOLQОіАe$4d’HќXQ.М  U$4Xј QCМХАе4UE5uHћXSETUPМ„е5E$4H ИSTRCMPМ’e5E$5ШЌрSTRNCPМ™БeDхUYј  ЕС—UУУ`dtUDdдў@ ÷P               h  ! ,–  Rл  Цm rИ@јЋ6ПА@ h   ®ј0 rЌ§а±KђUFј,Џn √©   EA † ђB 3@  А – Х[А†  ДN r≥@ $UAА ∞4  r≥@ КБ 9D/чы4  eYPmc А@Vmj `≤ET Rеf„РКЖ 9D/чы6¬ 2≠» Д r≥lИEB u®UA † ™Ќ  , ≥@ U” a÷†  "° ЧX™Ж \Ґ™ Ќ  ђ– В"† ™ #PАX™Г 3@ UPАKђUC .QU  fё@+6ф 0DT З{АT *°АQ( 9f‘mЋ eSP№ √І "ј Ќ  ,КД ў† *µ И@@Ћ6УАєET  " 3k®ђU@А.Q$ еfА Z‘Ќ±@™ еfА U r≥kРB€єET ЫiАV@B€∞мШД  d∆fј*
bbzdи!$£¶ҐІFK@"rb§e`!Ч&™¶*FJАjrrz§eP°Ч*Ґ+FW@*r™:,gи°Ч*¶*F  "ҐbМ` ""Ђ$°Ґ∆  2"2Т
j,f"ЧFQ Z)qД` "ђ'ЂF  22bzВВћeи#)"Ґ∆  9t` #ҐІ&Ґ©∆  *:*rj4t8#Ґ™#'&∆SАRAt` $ ©"+†∆o@*B©rdfјІ#"©)FZјrz22b|dD'£##Ґ™FCј2z22zВ,g'£#)ҐҐ∆O@2z22Ъ*§` ®'І¶(∆C@RЙt` ®° ©Ґ∆  Кe4)ЧFY@rЪҐТrДа  ЕQ—U‘аTtUDх9@ „,                     ААЦh  А!Р 2"† X Ќ  "†  !є Vh  Ѕ`И®А НЪ  2™И ™ЦА9D 0ХЪ  0X,СU rИhФB	 9Y† ВЅ≥iр*єА_пс aџј  "°ј еP (Д r≥@ В|Z≤≠а ™И 9D4 !АђЏЉ Ѕ`∞DlЏ   ґ@ыьECАvр UCАb* √ѓ џјU r≥@ ™З 2JD0fР°Ч''™F  "ҐbМ` ""Ђ$°Ґ∆  2"2Т
j,e"ђ'ЂFS *2b*ТФ` #&'®(,∆  9t` #ҐІ&Ґ©∆  *:*rj4tH£Ґ™'©∆g@2:*ҐЪҐФd\$F  2B
Т"Їd§¶•І ¶∆  *ВzzbМ` ®° ©Ґ∆  Кg)®!¶'©∆M@2ЪВzВ*tf)™)'!¶ќ   ЕT—UT U4UEU	@ „D                                                                                                                                                                     @@Ћ4  ≥@ UO  *  лБ ЦmШ ДB@h  л  Ч(Д ≥mhХЪ  0X,– ХSјET ÷! ,џВ КE"ЧX®  ≥@ 0 ъжЫ≈!  2Ќї Q( 9fя0h   †а" Т! ,џц #≥nP*ҐАК®  §R)Ї≈WД 2ЌЉ†`хћ7єET  F)КE.±U≥iШ }sЌм– Ыg U<B  2e©а2‘р  9f–јН Ў (Д ≥j†ФB	 9Y† ВЅБАЦmbY X∞h  !∞@Vh  Ѕ≥hИ* АИ_пцHЖЅ 9Y† FЌ±А,ЂP!њў" еБАЦmtrИ@јЋ6ЎАєY† ВЅ≥lш*жАИ_пцHД  d∆` rJ2b™Ьf–!Ч&™¶*Fq jrrz§` !™&(∆  2"*≤J,` "#) ¶Ґ∆MАr"Т≤Ґ
` "*!&FА)teҐЧF  "*¬zіfа#"*"ђ*FhА22bzВВћ` #/£'©!∆NАR9t` #ҐІ&Ґ©∆  *:*rj4f#Ґ™'£#Fn@RAt` $ ©"+†∆PјRqtgЉ($,™) ∆  *ВzzbМ` ®° ©Ґ∆  Кfh)"#'©&∆o@rЪ*ҐЪ*МvL©Ґ™*®Fq@2ЪҐТjДe®)™)'!®N   ЕС—U—С†dtUDфdi@ ‘<                   !  T,Ъ  @@Ћ4  ГјЦm Ї≈@  eЫIАҐ  rЌ•аx 2Ќ¶а Ъ  2Ђ  Д ≥iр D ≥jp ђRлR∞ Ћ6™А0л8 Е  P–h  лВј–  ECј  4  eXаЬ еfА  a–АU fА VЂ4  `∞Dl– Хi@t C@ ђ– В!† Q 9f’р(Д r≥@ В|Z≤ѓ∞ ™ЗА
ƒT< шµa^∞ 9fџ`(Д  r≥@ EBјt C@ ђџT ЅaЏ– 9fЁР И4 rК®H4  fА ™ …МҐ D2д≈HћиC.NOTМє T2еTEhЋЎC.UGEМ  D5D≈ј DEVICEМ  dDe$‘Xј EXOVМрАTdƒU%(ј FLOPPYМ  $rиј GENMESМ  TtTд‘hиИGETOFFМэА$Виј HARDWAМ… TЕRд$»ћ(NFERRМДАдфdd4ƒшѕАOFFGETММ dфddхXћЄOFFSEEМ≠Аdфde4UHј POOLQМГ •иј QBASEМ  %8ЋXS.Мя e5E$д4ўј  ЕУ—СТS†dфde4UH==AOFFSEEБУ—СС—U dфdd4ƒщ@ ‘X         CBА\Ґ&еfА КА ў† *ЦАhPФB 9Y† В…† Vh  ЅP` rИ_пцh   ™ј™  еfА  еfА HЕю€P U И® E fА Ђ *†А1 єET  Ќ  -иIЗW "™  еБ Цh  ≈jИ@ +4  `∞X,6Н 2≠Ш ЖЕ єD ∞ХЫJ ,ґ А С 9fА * !  T U@Аb* +љOмЏќ Џља™ #P@[ФU@ ђЏф ЅhЯBL;О *†АСU r≥@ КГ 
® ХЫRА"*  … УI$Qq§M И`…РALLOCМѕ T2ддхHќШC.TSTМ  D5D≈ј DEVICEМ  dDe$‘X  E.М  DUДхhЌ`FLERRМ  ddƒхШѕјFREEМ  $rиј GENMESМ  TtTд‘hЌаH.М  dД$EtћhLLONG.М© TдdU%(пШOFFCLOОџАdфddtUHи@OFFOPEО¬ dфde4TXи0OFFSETМ  Uфф≈ј QBASEМ  %8»SPCLOSМу e5tUD8»ИSPOPENМЋ e54TTєј  ЕФСУ‘У`e$Ddх$ў@ ‘      ж !њƒT Ъ  
ў† *ЦА
®0 ЎЪ*†јQr≥@ E@ T  FЌҐ`™¬ *†јb™Г 9D4 Ќ§јКА ўі»ХX@T !Ађ– ВЅdЋX@T  ! ,–  " Yµ®Ъ  1Z°    3@ +TB  9Y† ВЅ`Иўµ8Хj T !АђЏЄ Ѕ`И®уА
® ФB Yµƒ "	 Yґƒ !@ ђ– ВЅ`ДPр…сj Љ ™ еБ@VmЮ `∞DTЗyј   КБ 
® ХЪ  0ETТ?Йе"i®S%@HД М» T2ддхHј CTLQМ  dDUdФ4Xј DFRAMEМ  DUДхhќЄFLERRМ  ddƒхШј G.М  dtTд‘U8ј GENMFМ№ $Виј HARDWAМЇ TДТд$»»xIS_MDRМњАT¬д’T»ј POOLQМ  U - - - - - - - - - - - - - - - - - - - -*/

while (TRUE) {
    getfrom(5 RC 30,fmtid);		/* Get the format ID		*/
    fmtname();				/* Copy name over		*/
    if (fmtid[0])  break;
}
putsfat(5 RC 30,fmtid,8);		/* Redisplay			*/
if (fill != 0 && getfmt() != 0) {
    fvalues();				/* Copy entry into display	*/
    return(TRUE);
}
else  return(FALSE);

}

/*======================================================================*/
/*
.he                                                            SETFMT(POWER2)
.pa
*/
/*======================================================================*/
WORD                                /*					*/
power2(n)                           /* Force a value to be a power of 2 */
WORD	n;		/* Value to be forced to be a power of 2	*/
/*======================================================================*/

{

LOCAL
WORD	x,
	y;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

x = n;
y = 0x4000;
if (x == 0)  return 1;
while ((x & y) == 0)  y >>= 1;

return(y);

}

/*======================================================================*/
/*
.he                                                             SETFMT(GETIR)
.pa
*/
/*======================================================================*/
WORD                           /*					*/
getir(rowcol,d,max,min)        /* Get an integer within a certain range */
WORD	rowcol,				/* Cursor position		*/
	d,				/* Current value		*/
	max,				/* Maximum possible value	*/
	min;				/* Minimum possible value	*/
/*======================================================================*/

{

LOCAL
WORD	n;


/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

do
    n = getint(rowcol,d);
while (n > max || n < min);

return(n);

}

/*======================================================================*/
/*
.he                                                             SETFMT(GETDRV)
.pa
*/
/*======================================================================*/
STATIC VOID               /*						*/
getdrv()                  /* Get the drive type required for the format */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

while (TRUE) {
    getfrom(8 RC 20,drvname[fmtdrv]);
    p = buffer;
    raise(buffer);			/* Promote line to upper case	*/
    for (fmtdrv = 0; fmtdrv < 5; ++fmtdrv) {
	if (strcmp(buffer,drvname[fmtdrv]))  break;
    }
    if (fmtdrv < 5)  break;		/* Stop if fmtdrv is valid	*/
    error("Entry should be 8/5/5H/3.5/3");
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(GETSYS)
.pa
*/
/*======================================================================*/
STATIC VOID               /*						*/
getsys()             /* Get the operating system type from the keyboard */
/*======================================================================*/

{

LOCAL
BYTE	dflt[12];

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

dflt[0] = 'O';
dflt[1] = 'P';
itoa(&dflt[2],systyp);		/* Set default to OPxx */
while (TRUE) {
    getfrom(5 RC 68,dflt);
    raise(buffer);
    for (systyp = 0; systyp < DEFSYS; ++systyp) {
	if (strcmp(buffer,sys_typ[systyp]))  break;
    }
    if (systyp < DEFSYS)  break;		/* Found matching string */
    if (buffer[0] == 'O' && buffer[1] == 'P' && numeric(buffer[2]) != 0) {
	systyp = atoi( &buffer[2] );	/* Extract number from OPxx */
	if (systyp < MAXSYS)  break;
    }
    if (strcmp(buffer,"NONE") != 0) {
	systyp = MAXSYS - 1;
	break;
    }
    error("Unrecognised ID, use name or OPxx");
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETFMT(OPSYS)
.pa
*/
/*======================================================================*/
STATIC VOID /*								*/
opsys()     /* Set up the display prompts to match the Operating System */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(5 RC 68);
if (systyp == MAXSYS - 1)  putstr("NONE");
else if (systyp < DEFSYS)  putstr(sys_typ[systyp]);
else {
    putstr("OP");
    putnum(systyp);
}
clreol();

switch (systyp) {

    default:
    case CPM:
	cpmdos();
	break;

    case MSDS:
	msdos();
	break;
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(GETCPM)
.pa
*/
/*======================================================================*/
STATIC VOID                                 /*				*/
getcpm() $4Xј QCОД e$Ddх$Ўѕ`SPCLOSМҐАe5хTиќ SPREADМƒ e54TTєј  ЕС—UР—`dtUDd4Y@ ÷і   Т	 P 	!  Т P@	"@ Т- PА	#`
 Т? Pј   B Y† 4  >-YUЎ B Yі\ЫFА-gшeЪ  2©Ў Еь€a„P 9f“`+4  `И®А D  fА *Є *Ґ 8Ъ  3@ Ur Q (ДP r≥@ З]@T@Zк …fА Q  rИ@јЋ6† 3iА*»А@ Ф А@Vh  Ѕ`∞B! 4  –а »D ≥iH&2ИU“c2ј	%5:2ЬЋС’#+@є1R3>РЋУUS#0јє9=R2оР’ХФг  Q1F0 СUТP—c  I52Ї —KМ#  a=Z2÷QУTФ£  1=AAf3T СЋ£  95N0 Q—SУQ£Ґ@Q3 Т£4@!I]0 T””c  E	M0  ФPз   ЕФ’РRS e4UDdЩ@ ’X B Y† ЮАKBА"†ХЪ  0XuH B Yі !Ађ– ВЅa’  9f—†(Дf r≥iВ√™@– Е ?_ф(ь€Ґ†чэ) ~?ј эю…МЯ bе5tХD8ј CTLQМ  dDUdФ4Xј DFRAMEМ  DUДхh…∞FLERRМ  ddƒхШј G.М  dtTд‘U8ј GENMFМЧ $Виј HARDWAМЗАTдdU%(ј POOLQМ  U$4Xј QCОА e4UDdЩј  ЕС”T“ dEd4ƒ9@ ÷Р                                                                                                                                                                                       
А H§R)uКА  Ћ4   Ѓ`9ЉR  ,–  EA !РФB  9Y† В"†ј–  E@А48 ! ,џ| }w MвРН§ ≥o D$ fА ±P  r≥@ CHјT\ B YЈЄ ъо Ы¬$А6ъ @  »DК ≥h`КОАhpХЪ  0Dl– ХN@D/чы$CCАђ– В#f” ULњямС 9f“в’ЕZјD @ еЫT@DT| CCАTДЗ^јD48 EGј @ еЫW@DTД B  ®` Д  P†U f‘0UЩP† И Ќ  † *ЅБ
®P §"  YµЎЫbјYUдU@АT  UBА!> fЏАИ,  c` ™А 
ƒT  F  † *рАК®`6’А≥l–*ЉБ0и ™Е 
B4| 2ЌЈа!X 2еfя04  a№†U
 Дhш eЫ~јB ∞ eЫC@ЬҐ™ Ќ  UЎUBА!> f—@'(™Е 9Y† В"°  Ъ  2Ђ∞™Е 
ўЈ|ХYјЕW® R)К]bЂX БАЦm∞  ЃdљЫxАYµФ	Х\ Шw®B ®`µЎ	ЗzАeѓ B™ #P†ЗГАQU r≥n`В*°АґmFeZ !  √і`BыэУМИHЙкqЩpЖ\ОЛ<Иe…И±Э`Ж\Ш©»e…™©КСЩP*Ж\ЬЮ©‘ »jИКJ qА Ж®Ш£»И™…(h±А ИМ§ВЪЛT»КJ И(QА И®ДЩ£ »К»iИ*qЦА&К\a  ИЂ	к—ЯАМИ®К∞©L»…Йк
1Ъ@МЊМЮ§З\Hе—А ОКЬЪКІ  ®и©…®—Т∞ОК®ЮМН)I—А РВ§ИЃГI≈—Ы††Р≤®§Г  ™	ййК1ЯрҐ]  ™(H*h±А ҐЗ> HИ…кI±У,¶К®Юђ•э  jКHj3А  ЕФ—U—T`e4UE4U@ „,     @ еЪ  
B   e ! ,Џ А,Џ, #≥@ h  !АҐ  Ќ  ,  ААЦm ≥@ UO Б Цm< f‘ m" eX@P   .QTР   hЯBBСH§Rл  РИ8 ?ƒcgш™Ђ @ј ЋХЪ  Џ'–РД ≥jPФB Yґ$ Ќ  , ГАQU  r≥iАВ*†@Ъ  6ѓА ™Б ўµ4ХtА ` еЫd@ ∞ eЫq b6mP fЁ Uё њв* *†@Q  9f№∞+4  `∞Y" rЌЉаґmЇ ePА 9fяPmщ fЁ0UА С 9f–0лЄoТ –  "  B$p eЫ_А+«шeЫAАYUШUWА"СH•÷*  ,ЏX& \јs{ФU$ І "СH§RлTЋ6ҐАЙА„0ёЌ  і$Х`@D ` еЫEј\Ґ0 rЌЃ .Vh  Ѕ`К§А@<R)К]b™ЃБАЦm[ ЃdљЫYјYWB6 9D#РФB 9D  ХЪ  0X,4  є_бУв’ЕqјD/чы&[О!  1ЪPДИЮІ!»e…™©КСУ0Ж\ЬЮ©∞ ®e КjСЫЖРВ©  ИjЙК1Т@ИКђТЖЛ  »И H)®±ЦРИ†СК»КJ И(QЧ`И®ДЩ}»К»iИ*qЦ@К]Ыh•∆А К∞Ю≠  »»КИЂ
СШ МШЮ††≥ »Ћи…кHqЩ О]  »и©…®™qА 
ОКЬЪНЄ»и™ЙhЂ1ЧРР]  …*HКи1А 
†ЮЮШ£% J%—А 
ҐДВ¶Л  J(qЮ∞¶К®МВУХ  h™Йк Q–@¶К®¶К£8  ЕР’ХФаd5DE%e9@ ‘†   њяв*  *† 1  ДА–  "  Y† сj §А: *† Ш»ШC.MULTОБ d5DE%e8ј CTLQМ  dDUdФ4Xј DFRAMEМ  DUДхhј FLOPPYМН $rиј GENMESМ  TtTд‘h»∞HARDWAМ  Uфф≈ј QBASEМ  %9ј  ЮЖРВ©  ИjЙК1Т@ИКђТЖЛ  »И H)®±ЦРИ†СК»КJ И(QЧ`И®ДЩ}»К»iИ*qЦ@К]Ыh•∆А К∞Ю≠  »»КИЂ
СШ МШЮ††≥ »Ћи…кHqЩ О]  »и©…®™qАееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее                                   /* Get CP/M specific values */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

lspt = getint(10 RC 46,lspt);
if (lspt == 0)  putsfat(10 RC 46,"* ",2);	/* Mark default		*/
restrk = getint(11 RC 46,restrk);
blocksz = power2(getint(12 RC 46,blocksz));
putnat(12 RC 46,blocksz);
splexm  = getltr(13 RC 46,splexm,"*0137");
directry= getint(14 RC 46,directry);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(CPMDOS)
.pa
*/
/*======================================================================*/
STATIC VOID                    /*					*/
cpmdos()                       /* Alter the display for CP/M parameters */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putsat(10 RC 26,"Logical secs/trk..:");
putsat(11 RC 26,"Reserved tracks...:");
putsat(12 RC 26,"Block size (K)....:");
putsat(13 RC 26,"Extent mask.......:");
putsat(15 RC 26,"                       ");
putsat(16 RC 26,"                       ");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(GETMSD)
.pa
*/
/*======================================================================*/
STATIC VOID                                /*				*/
getmsd()                                   /* Get MSDOS specific values */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

bootsz = getint(10 RC 46,bootsz);	/* Boot size (sectors)		*/
spc = getir (11 RC 46,spc,128,1);	/* Sectors / cluster		*/
spfat = getir (12 RC 46,spfat,128,1);	/* Sectors / fat		*/
media = gethex(13 RC 46,media);		/* Media byte			*/
directry = getint(14 RC 46,directry);
nfats = getltr(15 RC 46,nfats,"1234");	/* Number of FATS		*/
fatid = gethex(16 RC 46,fatid);		/* FAT ID byte			*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                             SETFMT(MSDOS)
.pa
*/
/*======================================================================*/
STATIC VOID                   /*					*/
msdos()                       /* Alter the display for MSDOS parameters */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putsat(10 RC 26,"Boot size(sectors):");
putsat(11 RC 26,"Sectors/cluster...:");
putsat(12 RC 26,"Sectors/FAT.......:");
putsat(13 RC 26,"Media byte........:");
putsat(15 RC 26,"Number of FATS....:");
putsat(16 RC 26,"FAT ID byte.......:");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(FORMAT)
.pa
*/
/*======================================================================*/
VOID               /*							*/
format()           /* Set up the screen template for Format Information */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

clreos(3,0);
putsat( 3 RC 17,"Format Definition\n\n");
putsat( 5 RC  8,"Format name.........: ");
putsat( 5 RC 48,"Operating System..:  \n");
putsat( 6 RC  8,"Format description..: \n\n");
putsat( 8 RC  0,"Drive type (8/5/3):");
putsat( 8 RC 26,"Side mode(C/T/S/U):");
putsat( 8 RC 52,"Index mark (Y/N)...:\n");
putsat( 9 RC  0,"Tracks-per-inch...:");
putsat( 9 RC 52,"Format byte........:\n");
putsat(10 RC  0,"Tracks-per-side...:");
putsat(10 RC 26,"Logical secs/track:");
putsat(10 RC 52,"Lowest sector no...:\n");
putsat(11 RC  0,"Sides-per-disc....:");
putsat(11 RC 26,"Reserved tracks...:");
putsat(11 RC 52,"Phys. sector skew..:\n");
putsat(12 RC  0,"Sectors-per-track.:");
putsat(12 RC 26,"Block size (k)....:");
putsat(12 RC 52,"Gap 1 length( 15)..:\n");
putsat(13 RC  0,"Bytes-per-sector..:");
putsat(13 RC 26,"Extent mask.......:");
putsat(13 RC 52,"Gap 2 length(34/43):\n");
putsat(14 RC  0,"Density (S/D).....:");
putsat(14 RC 26,"Directory entries.:");
putsat(14 RC 52,"Gap 3 length( 34)..:\n");
putsat(15 RC  0,"Data rate (H/L)...:");
putsat(15 RC 52,"Side fields........:\n");
putsat(16 RC  0,"Invted data (Y/N).:");
putsat(16 RC 52,"Sector size field..:\n");
putsat(17 RC  0,"Reverse sides(Y/N):");
putsat(17 RC 52,"Special init.......:");

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he        ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееpip m:=b:sysman.rel[g4
pip m:=b:syslib.rel[g4
pip m:=b:sethw.rel[g16
xsubm
link amie.006=sysman[a,op,gam006,l8000],sethw,syslib,amlib.irl[s],&
amdum,tlib.irl[s]
dexsub
prlpat amie.006 $1 $2 255 $3
prltrm amie.006
xp b:[g4]=amie.006
symsort amie
era amie.srt
era amie.sym
era sethw.rel
era syslib.rel
era sysman.rel
era syslnk.sub
LANEO÷0 C     ’               LANEO÷1 C     C÷ „ Ў           LANEO÷2 C     ў               LANEW–  ERR   Џ               ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее                                                    SETFMT(GAPLIM)
.pa
*/
/*======================================================================*/
STATIC VOID                            /*				*/
gaplim()                               /* Insert the correct Gap limits */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (density == 'S') { 			/* Single Density limit		*/
    g1 = 7;
    gh = 30;
    gl = 17;
}
else { 					/* Double Density limit		*/
    g1 = 16;
    gh = 43;
    gl = 34;
}
smove(12 RC 65);
conout('>');
put2d(g1);
smove(13 RC 65);
putnum(gl);
conout('/');
putnum(gh);
smove(14 RC 65);
conout('>');
putnum(gl);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                           SETFMT(FVALUES)
.pa
*/
/*======================================================================*/
VOID                           /*					*/
fvalues()                      /* Put in the values on a Format display */
/*======================================================================*/

{

LOCAL
WORD	n;

STATIC
struct	d_int {				/* Integer values		*/
	WORD	position;
	WORD	*value;
} show_n[] = {
	{  9 RC 20,  &fmttpi },
	{ 10 RC 20,  &fmttrk },
	{ 11 RC 20,     &spd },
	{ 12 RC 20,     &spt },
	{ 13 RC 20,     &bps },
	{ 14 RC 46,&directry },
	{ 10 RC 73, &frstsec },
	{ 11 RC 73,   &pskew },
	{ 12 RC 73,    &gap1 },
	{ 13 RC 73,    &gap2 },
	{ 14 RC 73,    &gap3 }
};

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

cur_off();
for (n = 0; n < sizeof(show_n) / sizeof(struct d_int); ++n)
			      putnat(show_n[n].position,*show_n[n].value);
putsfat(5 RC 30,fmtid,8);
opsys();
putsat(6 RC 30,fmtdesc);
clreol();
putsfat(8 RC 20,drvname[fmtdrv],3);
putcat(14 RC 20,density);
putcat(15 RC 20,clock);
putcat(16 RC 20,invert);
putcat(17 RC 20,invside);
putcat(08 RC 46,schange);
switch (systyp) {
    default:
    case CPM:
	if (lspt == 0)  putsfat(10 RC 46,"* ",2);
	else		putnat(10 RC 46,lspt);
	putnat(11 RC 46,restrk);
	putnat(12 RC 46,blocksz);
	putcat(13 RC 46,splexm);
	conout(' ');
	break;

    case MSDS:
	putnat(10 RC 46,bootsz);
	putnat(11 RC 46,spc);
	putnat(12 RC 46,spfat);
	puthat(13 RC 46,media);
	putcat(15 RC 46,nfats);
	puthat(16 RC 46,fatid);
	break;
}
putcat( 8 RC 73,index);
puthat( 9 RC 73,fmtbyt);
puthat(10 RC 73,frstsec);
do_sdf();					/* Print side fields	*/
do_szf();					/* Print size field	*/
putcat(17 RC 73,sp_init);
printsk();
gaplim();
cur_on();

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(DO_SDF)
.pa
*/
/*======================================================================*/
STATIC VOID                                    /*			*/
do_sdf()                                       /* Print the side fields */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(15 RC 73);
if (sidef == 0x0001)  putstr("*    ");
else {
    puthex(sidef >> 8);
    if (spd != 1) {
	conout(' ');
	puthex(sidef);
    }
    else putstr("   ");
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(DO_SZF)
.pa
*/
/*======================================================================*/
STATIC VOID                           /*				*/
do_szf()                              /* Print / compute the size field */
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(16 RC 73);
if (sizef == df_szf())  putstr("* ");
else			puthex(sizef);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(DF_SZF)
.pa
*/
/*======================================================================*/
STATIC VOID                        /*					*/
df_szf()                           /* Compute the correct default value */
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if ((n = bps / 256) == 4)  --n;

return(n);

}

/*======================================================================*/
/*
.he                                                           SETFMT(PRINTPS)
.pa
*/
/*======================================================================*/
STATIC VOID                   /*
.he                                                            SYSMAN(SYSMAN)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

#define		OPEN	0		/* For 'sec_han' & 'dvc_han'	*/
#define		CLOSE	1		/* For 'sec_han' & 'dvc_han'	*/

/* Translation table for physical drive values taken from BIOS		*/
WORD	phytran[] = { 3, 0, 1, 2, 7, 4, 5, 6 };

EXTERN
WORD	autorun;	/* Set non-zero for AutoRun			*/

/*======================================================================*/
STATUS                /*						*/
am006(sdtype)         /* Enter system manager with target device as arg */
WORD	sdtype;	/* 0 = SOURCE  1 = DEST  -1 = init SCE  -2 = init DEST	*/
                /* -3 = set up Run Switches				*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Module Version   03.12
For AMIE version 05.10
Revision history:-
03/01/91 V03.12 issued - ICFO
         Correction to search for Global Switches.  The original code
         worked only by coincidence and fell over if there was a
         string of 'newline'# in the rubbish after the '1a' at the end
         of the data in AMIE.009
         (Fix in GETSWT) - ICFO
         Final few bytes of AMIE.009 written as NULL to pad up to the
         next 128 byte sector
         (Fix in GOCRT9) - ICFO
09/02/90 V03.11 issued - ICFO
         Many changes made particularly to SETUP.C, SETOVR.C, SETSEQ.C,
         DCLASH.C, GETOFF.C and RDFORM.C to allow for the fact that by
         redoing the allocation of workspace for CP/M formats we can
         set up SOURCE and DEST separately - ICFO
         Some hiding introduced (C++ where are you?) in the handling of
         AMIE.FRM
         (OFFHAN.C introduced and GETFNM.C and GETOFF.C modified to
         suit) - ICFO
         CTDRVS.C introduced to count the number of drives attached
         to the system.  Corresponding modifications made to
         DCLASH.C and GETFCE.C - ICFO 
25/01/90 V03.10 issued - ICFO
         Third parameter to 'dvc_han' removed because it wasn't used
         (Also changes to 'dvc_han' and 'badsm') - ICFO
16/01/90 'setovr' much modified and brought into the AMIE fold - ICFO
13/12/89 V03.09 issued - ICFO
         If AMIE.AS doesn't exist it now outputs an error message
         (Change in IDSFIL.C) - ICFO
29/11/89 V03.08 issued - ICFO
         'logtyp' removed from 'getswt' - ICFO
29/09/89 V03.07 issued - ICFO
         Assignments can now run over several lines
         (Change in SECHAN) - ICFO
09/08/89 V03.06 issued - ICFO
         Bug fixed in SECHAN which missed off the final assignment
         in a section - ICFO
10/07/89 V03.05 Issued - ICFO
25/06/89 Major upheval to 'sec_han' and 'dvc_han' so that just the
         Assignment Names are read in before the operator is asked to
         choose then just the chosen assignment is read in and parsed.
         This gives an upper limit of about 550 assignments per section
         (INPUT or OUTPUT) - ICFO
         'opnsec' and 'clssec' removed because they only called 'sec_han'
         and were called only once each so were not worth a separate
         function - ICFO
         'smopen' removed because it only cleared a structure to NULL
         and wasn't worth a function on its own - ICFO
22/06/89 Listing brought up to latest standards - ICFO
17/04/89 V03.04 issued - ICFO
         If CP/M and switch "DV" present it now allows for other
         switches but not "FO" or *FC"
         (see 'prcfmt') - ICFO
25/10/88 V03.03 issued - ICFO
         If 'Format not found' all files are closed and buffers released.
         (see 'getoff') - ICFO
         Method of finding 'AR' and 'AL' switches rewritten
         (see 'getsgt') - ICFO
20/10/88 V03.02 issued - ICFO
         Switch values for AutoRun changed 'toupper'
         (see 'getswt') - ICFO
03/10/88 V03.01 issued - ICFO
         When "forced" drive selected from the menu of available
         drives, the function 'getfce' now returns actual Physical
         Drive Number - ICFO
         If requested drive cannot support the format 'setfail' outputs
         better error message (#51)
05/07/88 V03.00 issued - ICFO
06/05/88 Erase "AMIE.SWT" on very first entry (sdtype = -3) - ICFO
02/02/88 Setting of AutoRun etc flags introduced when 'sdtype' = -3 - ICFO
29/01/88 'settab' removed because it has already been done in INIT
         overlay - ICFO
06/01/88 'setup' modified to read a sector from Drive A when chancing
         drives so that the BIOS can be persuaded that the drive has
         actually been changed - ICFO
15/12/87 'setovr' modified to set up a 'proper' DPB unless the format
         is for MS-DOS in which case a non-standard version is set
         up - ICFO
02/10/87 Modified to create AMIE.009 after each successful setup
         Passes 'iniseq' to 'prcfmt' to allow subsequent routines to
         detect whether in initialisation phase - ICFO
05/06/87 Created - DAR
*/

{

LOCAL
struct	dvce	tdvce;	/* Temporary devic       /*					*/
printps()                            /* Print the physical sector table */
/*======================================================================*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (makepst() == 0)  return;
putsat(19 RC 0,"Physical sector numbers: ");
ptable(psecnum,spt);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                           SETFMT(PRINTSK)
.pa
*/
/*======================================================================*/
STATIC VOID                              /*				*/
printsk()                                /* Print the sector skew table */
/*======================================================================*/

{

LOCAL
WORD	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

putsat(19 RC 0,"Sector translate table : ");
if (sectrans[0] == -1) {
    putstr(" None");
    clreos(19,30);
}
else {
    n = (schange == 'C') ? spt * spd : spt;
    ptable(sectrans,n);
}

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(PTABLE)
.pa
*/
/*======================================================================*/
VOID                                               /*			*/
ptable(p,limit)                                    /* Print out a table */
BYTE	*p;					/* Table of sectors	*/
WORD	limit;					/* Number of sectors	*/
/*======================================================================*/

{

LOCAL
WORD	i,j;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

for (i = 0; i < limit; ++i) {
    conout(' ');
    put2d(*p++ & 255);			/* Print as nn			*/
    if (i == 17 || i == 43) {
	clreol();
	putstr("\n ");
    }
}
clreos(-1,0);				/* Clear to End of Screeen	*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(CHKSPT)
.pa
*/
/*======================================================================*/
BOOLEAN                          /*					*/
chkspt()                         /* Check for invalid Sectors Per Track */
/*======================================================================*/

{

/* Returns TRUE if invalid						*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

return((spt < 1 || spt > 60) ? TRUE : FALSE);

}

/*======================================================================*/
/*
.he                                                           SETFMT(GETSKEW)
.pa
*/
/*======================================================================*/
VOID                                   /*				*/
getskew()                              /* Read in the sector skew table */
/*======================================================================*/

{

LOCAL
WORD	lastsec,
	i,
	j,
	n,
	secs;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (chkspt() == TRUE)  return;		/* Ignore			*/

getstr();				/* Read first response		*/
if (buffer[0] == NULL)  return;		/* Leave unchanged if NULL entry*/
zero(sectrans,60);			/* Zero out current		*/
j = frstsec;
lastsec = frstsec + spt;
i = 0;
secs = ((schange == 'C') && spt < 31) ? spt * 2 : spt;
while (i < secs) {
    sectrans[i] = j;
    if (buffer[0] == 0) {		/* If buffer is empty ... 	*/
	promptsk(i);			/* 	     ...prompt for more	*/
	getstr();
    }
    if (buffer[0] != NULL)  i = scanskew(i);/* Scan buffer if an entry..*/
    else if (chkrpt(i) == FALSE)  ++i;	/*	    ..else take default	*/
    if (buffer[0] == '-')  break;	/* Delete entry?		*/
    n = sectrans[1] - sectrans[0];	/* Calculate apparent skew	*/
    if (n < 1 || n >= spt)  n = 1;	/* Adjust			*/
    j = sectrans[i - 1] + n;		/* Next sector? 		*/
    if (j >= lastsec && sectrans[i-1] < lastsec)  j -= spt;
    else if (j >= secs + frstsec)  j -= secs;
    if (i == spt && secs != spt && missing(spt,1) == TRUE)
		 for (j = 0; j < spt; ++j)  sectran[++i] = sectran[j]+spt;
}
printsk();
if (sectrans[0] != -1)  missing(secs,0);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                          SETFMT(SCANSKEW)
.pa
*/
/*======================================================================*/
WORD          /*							*/
scanskew(i)   /* Scan the buffer and extract numbers for the Skew table */
WORD	i;				/* Sector numbr to look for	*/
/*======================================================================*/

{

LOCAL
BYTE	*p;

LOCAL
WORD	index;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

index = i;
p = buffer;				/* Scan the buffee description		 	*/

LOCAL
struct	dvcent	*dvdesc;/* Pointer to a device description		*/

LOCAL
BYTE	*ssect,		/* Points to section in assignment file		*/
	*sfile,		/* Name of assignment file to be used		*/
	*swpoint[8],	/* Array of pointers to switch strings		*/
	*scratch;	/* Points to area to take temp copy of switches	*/

LOCAL
BOOLEAN	iniseq;		/* Are we in init sequence yes or no		*/

VOID	tlibv();	/* To put Main Library TLIB version to Load Map	*/

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Set the init flag to correct value					*/
if ((sfile = idsfile(iniseq = (sdtype < 0) ? TRUE : FALSE)) == FAIL)
							  return(badsm());

/* Set up the AMIE Control switches (AutoRun, ALarm etc)		*/
if (sdtype == -3) {
    unlink("AMIE.SWT");
    return(getswt(sfile));
}

/* Make 'sdtype' either 0 or 1 ( SOURCE OR DEST)			*/
if (sdtype < 0)  sdtype = (sdtype == -1) ? SOURCE : DEST;

/* If in 1st pass of initialisation sequence set up status box		*/
if (iniseq == TRUE && sdtype == SOURCE)  statbox();

/* Initialise the system manager module					*/
setmem(&tdvce,sizeof(struct dvce),NULL);
ssect = 0;

/* Get the section required from the assignment file			*/
if ((ssect = sec_han(OPEN,iniseq,sdtype,sfile)) == (BYTE *) FAIL)
							  return(badsm());

/* Create an array of entry structures from the section loaded		*/
/* NB this automatically points 'dvdesc' to 1st entry in set		*/
if ((dvdesc = dvc_handle(OPEN,ssect)) == (struct dvcent *) FAIL)
							  return(badsm());

/* Load the current switch settings					*/
if ((scratch = opn_swit(swpoint)) == FAIL)  return(badsm());

/* Process the driver name & switch settings				*/
if (prcent(dvdesc,swpoint,&tdvce,sdtype) == FAIL)  return(badsm());

/* Set up the format / process switches if necessary			*/
if (prcfmt(swpoint,&tdvce,sdtype,scratch,iniseq) == FAIL) return(badsm());

/* Write out the current switch settings				*/
if (cls_swit(swpoint) == FAIL)  return(badsm());

tdvcpy(&tdvce,sdtype);

/* Close the device descriptor structures				*/
dvc_handle(CLOSE,NULLPTR);

/* Close the section of assignment file used				*/
sec_han(CLOSE,0,0,0);

/* Print the device details for setup device				*/
if (iniseq == FALSE || sdtype == DEST) {
    status(SOURCE);
    status(DEST);
    getswt(sfile);
    gocrt9();	
}

return(SUCCESS);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                           AMIE (SYSMAN.H)
.pa
*/
/*======================================================================*/
/*                          SYSMAN.H					*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	SYSMAN - System Manager
Revision History:
31/01/89 MEMTOP added - ICFO
03/10/88 REQDRV added - ICFO
*/

#define		MEMTOP	0xffff	/* Top of memory			*/

#define		EPERLIN	6	/* No of entries in assignment file line*/

#define		REQDRV	-4	/* Requested drive doesn't accept format*/
#define 	WKSPERR -3	/* No table space error code		*/
#define 	SSPERR	-2	/* Sector workspace error code		*/
#define		NODRIV	-1	/* No drive will accept this format	*/


struct dvcent {			/* Device entry strings structure	*/
	BYTE	*dv_id;		/* User device ID			*/
	BYTE	*dv_type;	/* Type of device (D,T or I)		*/
	BYTE	*dv_prc[4];	/* Processor descriptions		*/
} ;

struct	osn	{ 		/* OS entry in AMIE.FRM header		*/
	BYTE	osname[9];
	UWORD	osoff;
} ;

/* Setup structure filled in during the setup process			*/
struct	ssf	{
	BYTE	fmtnm[9],	/* Format name for the drive		*/
		*fdata;		/* Pointer to formats.dat entry		*/
	WORD	fdriv,		/* Drives to force setups onto		*/
		fmtoff,		/* Format offset in formats.dat		*/
		osnum;		/* OP sys numbers of the formats	*/
} ;

struct	_asgn	{		/* Assignment name structure		*/
	BYTE	as_name[33];	/* Assignment name			*/
	LONG	as_addr;	/* Disc address of the assignment	*/
} ;

/* Hardware description array in AMIE base				*/
EXTERN
struct	ddf	hardware[];

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееr... 		*/
while (*p != '\0') {			/*     ...while something there	*/
    p = skip(p);			/* Skip whitespace		*/
    if (numeric(*p) == 0)  break;	/* Possible error		*/
    sectrans[index] = atoi(p);		/* Convert next number 		*/
    if (chkrpt(index) == TRUE) {	/* Check not a duplicate	*/
	*p = '\0';			/* Do no more if it is		*/
	break;
    }
    ++index;
    while (numeric(*p) != 0)  ++p;	/* Skip the last number		*/
}
buffer[0] = *p;				/* Set for exit			*/
if (buffer[0] == '-')  sectrans[0] = -1;/* Delete entry			*/
else if (buffer[0] != NULL) {
    error("invalid character");
    buffer[0] = 0;
}
return(index);

}

/*======================================================================*/
/*
.he                                                           SETFMT(MISSING)
.pa
*/
/*======================================================================*/
BOOLEAN                         /*					*/
missing(limit,flag)             /* Check for any missing sector numbers */
WORD	limit,		/* Higest sector number				*/
	flag;		/* If TRUE add missing sector else return error	*/
/*======================================================================*/

{

LOCAL
WORD	i,
	j,
	n;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

n = frstsec;
for (i = 0; i < limit; ++i) {
    for (j = 0; j < limit; ++j)	 if (sectrans[j] == n)  break;
    if (j == limit) {
	p = addsec("Warning...Sector XX missing from table",n);
	if (flag != 0)  return(FALSE);
	error(p);
	break;
    }
    ++n;
}		

return(TRUE);

}

/*======================================================================*/
/*
.he                                                            SETFMT(CHKRPT)
.pa
*/
/*======================================================================*/
BOOLEAN          /*							*/
chkrpt(i)        /* Check ith entry is not a repeat of a previous entry */
WORD	i;					/* Sector number	*/
/*======================================================================*/

{

LOCAL
WORD	n,
	m;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

m = sectrans[i];
for (n = 0; n < i; ++n)	{
    if (m == sectrans[n]) {
	error("Duplicate sector number");
	return(TRUE);
    }
}

return(FALSE);

}

/*======================================================================*/
/*
.he                                                            SETFMT(PROMPTSK)
.pa
*/
/*======================================================================*/
VOID                    /*						*/
promptsk(n)             /* Put out the prompt for a physical skew entry */
WORD	n;					/* Sector number	*/
/*======================================================================*/

{

LOCAL
WORD	r,
	c;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

smove(19 RC 24);
conout(' ');
ptable(sectrans,n + 1);			/* Print the table		*/
c = 26 + (n * 3);			/* Column offset		*/
r = 19;
while (c > 78) {
    ++r;
    c -= 78;
}
move(r,c);				/* Position at last		*/

/* Let C/80 supply the return						*/

}

/*======================================================================*/
/*
.he                                                            SETFMT(PROMPTSK)
.pa
*/
/*======================================================================*/
WORD                                /*					*/
addsec(p,n)                         /* Add a sector number to a message */
BYTE	*p;					/* Pointer to message	*/
WORD	n;					/* Sector number	*/
/*======================================================================*/

{

LOCAL
BYTE	*q;

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

q = p;
while (*p++ != ' ')  continue;		/* Locate the space		*/
*p++ = n / 10 + '0';
*p   = n % 10 + '0';

return(q);

/* Let C/80 supply the return						*/

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ÷T”PS†eЕХE$4јјЏP 5`А     А А (                                                                                                                   еЪ  @ h   ± Зbј   КЄ 9Y† EW l– Хh@† $B Yµ№ F#Яђ+В !™аNVh  ЅUј+4  `≤D   еЫiА 4  m_  9rИ@АЋ6г ўґ`ХzА  цА@ h  *Ѓ ґmя eP@ 9fЁ∞mх fА ™Ќ  4@ !$ Ґ  Ќ  ,Д  U†  еW (Д ≥oшФUW ђ– ВЅ`∞DUh !њў† *®А≥lр$B  9EUh Ќ  ,X rИ_пцmHeVрmNdИjрХЪ  0DUЄ FЌ†@,Ђ
Ќ≠А,СUX rИjрФCD Ґ@ rЌ¶@.Vh  Ѕ`∞X"6m|eZ∞mВdИjрФCD Ґ0 rЌ≤ј.QUn rКЂАХЪ  0X,FЌі@,ЂђЌµ ,С^ r≥@ НЫs@YW§ЫtјY"  еБ ЦmЄr≥@ B 9D  ХЫVАX, еА Q  еА Vm:`∞X,Up fё 2ААЦmт≥i6ВА≤™ШД  r≥@ Д r≥iиUW ђџz ЅfА  ТA&ТHҐвЩ\® Оє T”hј AUTORUМу ‘$E4ЎЋиC.GTМШT2ддхHќ`C.TSTМнАд4≈5х5xј CTLQМ  dDUdФ4Xј DFRAMEМББdEd5фДЋ0
E.МЩБ4Rгј EXOVМ  ddƒхШј G.М  dtTд‘U8ј GENMFМ¶БdtUE5uH ИGOCRT9МЦ$Виј HARDWAМ» dФE4dФ»Ћ†OPN_SWОА eЕХE$ј POOLQМЌ е$4TеHќ PRCFMTМч %иј QBASEМ  %8»јSEC_HAМН е4UD‘TЎ»XSTATBOМҐБe5DEU8ѕ∞TDVCPYМ  UDƒФ%hЌ®UNLINKЬ   ЮdФ4Xј DFRAMEМББdEd5фДЋ0
E.МЩБ4Rгј EXOVМ  ddƒхШј G.М  dtTд‘U8ј GENMFМ¶БdtUE5uH ИGOCRT9МЦ$Виј `∞X,Up fё 2ААЦmт≥i6ВА≤™ШД  r≥@ Д r≥iиUW ђџz ЅfА  ТA&ТHҐвЩ\® Оє T”hј AUTORUМу ‘$E4ЎЋиC.GTМШT2ддхHќ`C.TSTМнАд4≈5х5xј CTLQМ  dDUdФ4Xј DFRAMEМББdEd5фДЋ0
E.МЩБ4Rгј EXOVМ  ddƒхШј G.М  dtTд‘U8ј GENMFМ¶БdtUE5uH ИGOCRT9МЦ$Виј HARDWAМ» dФE4dФ»Ћ†OPN_SWОА eЕХE$ј POOLQМЌ е$4TеHќ PRCFMTМч %иј QBASEМ  %8»јSEC_HAМН е4UD‘TЎ»XSTATBOМҐБe5DEU8ѕ∞TDVCееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееЕФ—UУU $s	"GLБФ—UУ‘†ddх$‘HY1UFILLNAБQ—UT†d4Дµ5HA=]H GETSKEБФPУ`e$ф’HM9M.CHKRPTБУRT‘“S†dDE4T9B8÷рb\              %†   8 S Аа L    (   А  М % 9@                ® N    @   ?А  ш €И@@Ћ4  >-YUи B ∞H Д  rИOа+4  `∞D  ФC@ Ґ0 Ќ  ,ј @ 	 fЎ Цmƒ`Рв’Хk@!а+ФCCEҐ@ Ќ  ,Д<rИh∞£ХЪ  0X2Џ– |Z≤ѓА Д  r≥@ 	сj Є†;а*Ѕ Vmь`И∞H ЂАђ*^Ќђ ћЏЊ!ЬҐ  Ќ  ,–  Ќ  .ы4  iPјг rИo`ФB! 9Y† ВЅЗАќQы r≥mHВЌїАҐ†% *  ђ– ВЅRPе  Vm%`∞DTƒBєE@ ФB 9D ХЫfЅX,EP@D!@cФT  9Yі‘ВЅU∞m1fА *ђ*  @  Д(rКЂАХЫWјX,zX0ЛьцЌЊ†+.! VUe@]b Ъ  9YµlВлБј–  Ef D!@kФUkА\ђ– ВЅW0(™ЏА≥@ U–f— б  ЌЉбҐ†9 *  Ґn(еfА Ev D!@{ФT  9D4иQ ЌЉ ,E{@D!@ГФT  9D4фQ ЌЊ†,E@АД!@ЛФT  9D4фQ Ќ°@LEEјЕUPVЌ  T№BS 0кHД\rКА (Ж†
9Yі|	ВЅ`И©а®  a÷)jР6л∞лИ6”Д0лИЄБ3@ 
§  UА    a’ !	$е  Q=r≥j ВЅW`!	$е  Vh  Ѕ`ЙА+*Љј!kь2Ќ•АLЂ\*≤јA†Ъ  3kP*ёБ
≠0Eю fА џ^¬љ`BЂ2^?√,џ@ ї BЂjz ґ∞	ЫoАЩW†Ut@В/А6ЁБ3n–6фБ2®pЖ£
9Y† BIєEWА	 Ќ±аLШ "њјL;0Ќ¶A¬H) *  ђЏЅ`И®∞6ЩI Ј(®  rКЂ ФB  9YґlВЅ`∞DT§ЫLГЩіP,BI9E@ ФBx 9EX  Ќ≥`ђВ"© bH5 *  Ґђ е`@+6ЌВ∞X,К±БИI з(®  rИ@ G(Ђ 9YґlВЅ`∞DUфЫUГЕT†V|Z∞≠шДТrКА XД fА Vm`∞]b@ЫjјDVМЗsјƒ$Р{ФUnА№ђ– ВЅ\@1’€ fёр ЛYю>-XWРB Ѓh6ЋЖИI!(™з єYґЄВЅ^ј1’–fЁ00ЛYю>-XT0ЫDДW‘Ыy√D$РЛФT  9D4фQ ЌѓјLEE!АЫХЪ  0YµX<B€єYґиВ!  X$Ыqƒ!@їФCVЕђЏ*Ѕ`≥@ +4  `ЙА—Хшaџ@F—Ў!G+4  `≥@ HД(rИl8£ХЫRA,h  Ќ  ђЏ§Ѕ©ябУв’ЕjБ6pQ ЌђјМh  !АҐ† Ќ  ,K÷В0оИ$ґі[Z…fА ;ҐЌђ@UxК ђ Е0m" -h lkA	 \Й   ЁA’Yfя∞0Кню>-XU B 9D  ХЫhБ,≠ њяоVm4`ИI LЈрB ђ™B
!\Ґ≤ еfёpЪ  ®H*ЁХGБXtДЗ!а+ФCEA\Ґ@ Ќ≥`B Yµ,Ы{ ЩUЪ  3iЎ+6Ґ≤™∞+6вИ@ K≠И@ K&\     ’∞Q 9f”АQ А, *Ѕ`≈Ђ
їВИ@ Lµ№UВјҐђ Ќ  Ј,	ХeЅEX4÷! Аґ®EГ@u№UГ@2ар  [6-ЫВ Цm`rИA Ћ6–єYµшВЅ`р 9fЏАWXЂА3nЄ
йИ@@Ћ6№Ї≈X<ЫyАЩµЕfЅEX<У-№А@≈Ђ*∞BАЗ(™≥ 
B   eЫrA\ђЏ
Ѕ`ИnР И  я†W+4  `И@ йP∞`ЛмюЌ±А-™М√§ј¬™#Q–f– g(™РГ
B7і2ЌЊ ЃVh  Ѕ`Яђ™Ж√®јћ:8*•`ЅўэЫEЫUTЗXД6ФQ ЌЊјL№dЋД@             Z¬!'А£," !( £,$ !¬`QUMr≥@ B ђ™Љ!"\Ґ" еfяPVCIЅЬђЏЅА *и*≥†ЅщэЫSAЫW`ЗnЕVАF"µаћ;>!≤@ќQU≥Д@  Ћ6ЩГ9Yі№ВЅ>-YWTЗvШvЄUoAВ-уы6”6ѓ83ѓО≠»36кВV/рЋ6Ѕ≤® 8кHzЩЈђ"∞ЖYЈ»ЫtЅYT`u$ њ ћџцеfА mf—`vU8… А(X;ХЪ  0DWdUIЅ¬,ы6пГ6©ј;ѓЋNƒ4| !ЄBОVm…`∞OЛVUSПј*T√ЂјвО(еf’†fЊ2D$@+ХЫJA"™Ь`њ√'≈Ђ
њИn£ХЫdЅ,;Z*≠ бщэЫLџVtU_Ѕ≈!Вf№Pg+6Љ∞XvіCzEђџ.ЅX∞w+4  `ЋkAўµмUiБЎw[lЌЂ;™Ќ¶!,;™√Ї†мџj	mБј x   ;l…ЛБNQP  еfЏјVEvЅ≈WРшµaP БЄеёЅG(Д r≥ip+ВЅЛБnQP  еfЁрvEAB"аcФT  9Yі$!ВЅr≥jЎ+EEB"аcФUH¬ђџrЅ`ИEј„(®  rИox£ХЫG,КЫДEјз(®  r≥h»CВ"©БСhеяQG+6ї0X"–- !°"ЃVma`∞D!†cФCGE\ђЏ№Ѕ`ИC@„(ЖШКєYµм!ВЅЖБоQEr≥l@CВ!ҐК*еfўPЖТ!ЬҐ†  Ќ™К÷EјЈ(®  rИP (Д r≥lЎ+ВЅ`И≠а@Д\rКА (Е  rИ@ +6ЌВ∞X,КлEј„(®  r≥oАВ"Њp9 *™°Vm∞`∞DT $B.єE@ ФCWE\ђЏ~Ѕ`∞DT@$B.9E@ ХЫ},%	dИC@І(Ж±
єYґИ!ВЅЖБnQvr≥i–KВ!Ґ*еf‘pЦBєD6xU Ќ™Б,Д4rИmРЂХЫXBX,h е№aW+6Ј∞X,С еА Vmй`∞D!ФCvЕ\ђЏцЅ`ИA W(Жч
єYґX%ВЅМ ЃQr≥mKВ!ЬҐ8,еfџ ЦB 9D4‘Y ЌЈ°,Д4rИjH≥ХЫrВX,–е’—g+6лД∞X" % !ЃbќVmд	`∞D#@KФCa≈ЬђџвЅ`И@ І(ЖќЛ9YЈш%ВЅЖБNQ±r≥hXSВ!ЬҐК,еf—А¶B єD7lY Ќ§°LД4rИhHЂХЫLВШ,–еёсg+6ЯЕ0X" 1 !†ҐоVmL
`∞D!†cФCFE№ђЏ≤Ѕ`ИFА«(ЖЦЛєYµШ)ВЅАЃQCr≥kШSВ!\Ґb*еfЎ ¶B4єD5\] Ќ±°LД rИkhїХЫfВШ,hеЎw+6”Е0X"†9 !≤ҐоVmі
`∞D  {ФCj≈№ђџВЅ`ИFАч(ЖяЛєYЈ8)ВЅАQ’r≥nЎSВ!Ґ“.еfёА¶B єD7ь] ЌЊ°LДhrИhШ√ХЫ@ВЎ,H™вUѓр…сj¬¶°b8 EА !а Л B  a‘p±@ "ј X EАА"  Л H «+6≤∞D#аХЪ  0EX  Ќ  "5 Ќ©БlV r≥mP;B/ 9YµP-В*ј@Vml`ИH з+6≤∞D#аХЫ]Ў"ђ еf„јґ&\:   Kf¬АЪTS††.ЋЕФі(Є@"аu		$В®ш$O …  ЄI„`2H:»≥@   "√†ђ: zЯўґµCCwШ,UЗ@b,: √є°bђ: )ДlјXeЫdЅ№Ґђ: )ДlјXdF#fя ґm€r≥ipCВ√їБbр !§јЃQ  еfя∞vВЌЂавр !Ґ .Vm`∞YґЄB9EUR•аЅЦmrИ@`+6Н0X,PеQPЈ+4  `∞D!@{ФU~ј\ђЏ™Ѕ`ИBБ(™И9YµИ1ВЅЕ.QU%r≥kxcВ!Ґ™Феf„ј∆UlAЎu6[&*Љаз≈Ђ
ЎEјІ(Жц
9D  ХЫQ√,ёЖEјІ(™ 9Yі1ВЅЛБnQUr≥m»cВ!Ґ™Tеf№`∆B.єEU! Ќ±!МД@ r≥l`[ЗT√D"аSФUmBђџ¶Ѕ`ИEјЈ(™зД9YЈа1ВЅЛБОQUйr≥h(kВ!\ҐЂтеfА Д\ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее/*
.he                                                            SYSMAN(TDVCPY)
.pa
*/
#include	"amie.h"
#include	"sysman.h"

/*======================================================================*/
STATUS                               /*					*/
tdvcpy(tdvce,sdtype)                 /* Close the system manager module */
struct	dvce	*tdvce;			/* Temporary device descriptors	*/
WORD	sdtype;				/* 0 - SOURCE  1 - DEST		*/
/*======================================================================*/
/*USE
Portability	Level 1
Parent Module	AMIE system manager
Revision history:
22/06/89 Listing brought up to latest standards - ICFO
05/06/87 Created - DAR
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

/* Copy temporary device descriptors to the real ones			*/
cpymem(tdvce,&device[sdtype],sizeof(struct dvce));

return(SUCCESS);

}

/*======================================================================*/
ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееrК®рKХЫx,Є еRаЧ+6ПЖ∞X,:¶√™aђџМd√  ё   ;&!$ВҐЂеf“ј÷BIєET$ ЌІ!ђДТ
rК≠Р[ХЫZCX,mЧfёp—	$"еR G+6Ѓ∞X,ЏђЌҐБl– Т!$Г№ђџЅ^ 1Yсj¬ґaҐP0еfЏ vуК≠ kђB 3lx+ХЪ  0EVИ,V|Z≤ЃрhД@ r≥oHcUm\ђџ~Ѕaё`—Yr≥mhk[ћ…ЧА  ёp—	$ еfўј÷6И9ET(Ъ  2®8pЖц
9YЈМ5В√°б¬ЂиеfЁА÷&\B   KDЕV®-÷!  Yґ|EИ@/«шeЫ@БўTЄ8UИ@b,B *ƒ Цh  |Z∞©Ўs$B 	єD4Єa Ќ•aМД  rК≠0[ХЫmCШ,LЄМ   ЦЂ@7(Ж§9Yµ9ВЅ  Џ#>-XV8CXЖђЏЅДјQx еfЎРЦЗmЕV0"љЖYіИ9ХhCЕU49÷*Єaђ– ЗiЕVT8EИј5Р9 *ƒ`Vmµ`∞Y2вP     ЦЏЗ@ % ААЦm?uК±(6и≤©{мЗ
±( МEЙ@vм8B  9YЈ@5В! .Vmј≥@ [4   ђЏЄЅbP ЛљюfЎржbP ЛUюf– цmeR цm0÷БЗ+6Ї0Xw<8B€єD  ХЫ`Ш,H™—@ m«aT`сU2П џ~
ЌҐм™§! АuT<B  2e≈            µX=ЫLC≈lЏ ђ!мЦh  :І мЏќ|Z∞ЂА{$CjЬҐа Ќђ ™єИ±h ™њЇ≈Tш<2"≈   EКјV 8"љЖYµl=ХjГ≈V <" 3iј{6£З≤≠Єx™—КXvи<UlCƒXƒ UМ@bђV Ќµм™Д"*≈`вrК±hDъVPцmh>-XWЄ<UКјђЏj&Ѕf÷ с’ўfЁјув’ХAƒXђ ЌЂв,+ a—ЅV+ r≥n»УЫgўTp@UКјb,V-^рцmтіябУв’ЕKДuDu$ єЅмЏ@ еRсm2fА ,^ *≈аЫqCЎU\@UnЁbђ^ Ќ  ґђ=ХXƒ  ЛА
±X ђ#MД,џёлbр »ЛА
±HђUЛ@µTAХeDXђ V≠ЦmluК±H6Ґ≥jјГ*’И
±hФUSДір@EЛ@w(@UМ@bЂuК±h6њ2ЃPАЂА9EXƒЫhƒXі[Ф *іQV+ fяp÷Uб\±(ЂА3n(6Ћ2ѓјА™м9D ХЫIƒШ,[6И3oГ*ЯИИ@ - ^БXЂА3j@Г*ЯИ∞ирИЂАƒXіЗAEXђ F"≈` rК±h FУЖYґ0A÷*†Ґ!ЦЙф$√ҐВ2”сљf’`б’.f”Ссj Ђ¬"ђb еА Vm'`∞Y2г0     ЦѓИИ@@Ћ6уЗ±® ЖОИ±Ш ЂА3iРЙсj Љ¬"ђf еfА 3 c0msr≥hР;шµaYБжcP НFєEXћ Ќ§`мЙф$*∆†Vmў`КўЈЎAХpДEXћ l aёaV5 И±® ЂА3lHЛХЫcDX'≈Ђ*сИК±Ш МEМјw$EЗ[ƒEXћЫsDO£*‘":љ¬,ЏТ"iњ√'≈Ђ
ДЙ_пуи ќ∞йРкшИ≥o†Йсj §bB÷0еf’АvД  >М®PФіМHUН@2гp       %§вBЂ` "«`  EНј @ еЫY]bђn Ќ°В,Ђ™$√™"Bђn #cp3А ,r ! ,Џp$лcРm?eXс&ucРЛА0кЄРЂАh РeЫzД\Ґђv ЌЇBЂ$√±вL:÷$! ,ЏЄ$еcРmДe\±!}rК±ЎХЫgƒЎ,эААЦmФ>-YW HB  2EVЄI Ќ£"L’c∞ЛА0к8РД dЋП@    [≤$! ,џj$ѓ"AЦm}cр  "«† rЌї¬N±V= f÷1&U1a–б1V= И±иш	
±и FрЙYЈФI *«аџ6$ •¬bH0еf№Q&Д d∞и ШД  dЋР@    Zj&!№ђџЎЅИ Vmё`ИhРЫФB YЈ‘HFеfџPжB Yµ8L" 3lаpD4 И≤ Д& dVC ђOмџ®“≤"bђВ #dVC ђЯбСC a„1VA rК≤ХЪ  0X,Щr(  -ЯБ Цm\dP 9r≥m ШНЫz√ЕlЏ,&p?√'≈Ђ*д	∞нHЫ‘ЙИ@АЋХЫkƒƒlџf&+rИ@АЋ6з	Їƒ †6МF  ЋDъБ ЦmџrИ@АЋ6ш	Їƒ †6с	Ї¬#  eҐ}	
≤($Z-ЛEҐ—hі _/ЧЋетщ|Њ_/ЧЋетщ|Њ_/ЧЋетщ|Њ_/ЧЋетщ|Њ )С В` ≤N »eB© I7М&√IР@F7ЬН¶†АДy:@3	Ў ,¶√)– ,LЖУ†∞Тg7ќFQ ь@()Л»Вт(ЉТ) 3	Ў  (МІ3ШАNYИЖс l2ЭҐ  l2Э&г8 Кn:П"Щ†ёu6#(Аp/Л∆§Бxћ\5Мјвy8К *ЫОFSЉќn4Ьћ¶A$И,NfQЄ¬m2Из!<†x< 	е  ®@ #1Є Шo3ЪLf`Ажe1Ь≈зCСђ\. 
FSЩФдv2ЩCСД∆k9ЛЕ¬б– Дl7ШЌbЩ§фe
	bСpЄ\. ІГ°Ф№tL'3XЄ\.Е¬б– @  А@  А@   b2Н #yЉи 9ЪOFQAћ c:ќG1Hи S2ШќЖуСћ^c6NgC)»\.А3)Миo9≈дb	P\.Е¬бpи M2Щ&Итt2ЛЕ¬бpЄ\.Аг©іƒe9жaВT)ЛЕ¬бpи F ХТ Аƒy:E¬бpЄ\.Аcy»Џa:ЖS1§№i:MжаP( F7ЬН¶†А№a6ЩE¬бpЄ\.Е√°  Юp2ЬМ'CIЄќ )ЮNgC)і\. †ёr6ШNВ!Фжc9NCIЉ№.Д †P Иr4ЭМҐ°даe
с®Љf) 
fУ!Ф@m7ЩҐВЉ®/)Л ҐС– Тn2OiДдk
"тp§\.Б@°»¬c5Ь≈І)»Zi7ЌбpЄt #ќF”	–@b<ЭҐбpЄ\.Е√†P ®r0ШЌg1iј rЬЌ&C(Є\. 	Жу9§∆a6fSћ^t9Lf±– Шo;ЩNgAћ c:ќBqЉ\.Б@Щ§»e9ЛNSРі»i9Ш≈¬бpЄt ('1pАжe1Эз!ћ÷e;ЛЕ√†P ¶e1Эз#Шіаe9NЗ#	М÷. F√yМ÷ 9ЪOFQ †÷)Е¬б– Оa8"aФ№g:И‘R.Б@диe9ЛNSРіжe1Эз!pЄt #ШNРАЎe7ќЖБ@ћh/≈#†P Иe7Ќ'C»АPSС"бpЄ\. ЖУСФ∆t7ЬП")Єиr4ЩNbб– Оa8baФ№g:Ш–R.Б@!ДиaМ'C(АPHУ"бpЄt )ЪLЖQШ“e6bбpЄ\.Е√†P Тn;¶AР¬t0ИСy8R. 
fS–ёrЌ'£(Аћi2ЫВбpи )N∆SСћ  9ЪLЖSШ†≤/'
G@Щј c4ШMВIЄ“tЕ¬бpЄ\: 
Д А P4NfУДЎ 9ЩLgCy»@n:ЫLFSСћt  ћ¶3°Љд :М&гЩ∞¬t2ИЖ∞   qЉ№e Д IЄмa6LВ†¬r0ШќЖSР Ѓa9Н&г8Є\.)ЩLgCy»@X,¶УЩћ“n3И«#yі@t0ШНЖPкp6Lf°Ф@s2ШќЖуРА№u6ШМІ e7)Ђ§™!∆_ЅR	tg‘†°'©*Ggƒт
""Ъ*fФF ™'§∆  2
ъJr"ƒ` !")+F  "JzЬg<3!&'°•©∆}2zzҐЪ‘dD9°()∆HD≤™22*Ф` !*£)§≠Fmјкr
Ъdfм6°Ч ©©Fƒкr"JіgрJ!Ч#™Fn"rb,fLB!Ч&*FXДтrj™b§f‘F°Ч''™FCD™rЪ¬§eаN°Ч*)™F  2B
rr,wdK!§%©(*GLCтBZЪВ§ex2°¶'°•∆EГтbТ*zdd∞?!¶)"І©∆_Б*zrJteO!ІІ'™™FqBт™Тъz4fP7!™©/ІІF  ""
Ґ` ""£")+F  *"*2b§f\""¶"™"∆TC2"*rЪJ§` Ґ$©FkВт"JТ*§` "'™°&"∆  "В` "(!! ©∆  2"ВҐҐ
` Ґ)$Ђ"∆N√2"Т≤r
l` ")+* °FGD“)tgдAҐЧFZБ**rҐ*ФdЬNҐ©)'©FMCj2
ҐJ$` #"*"ђ*G22Jbbr` £$©)™FYCr2jҐ §dЬ3#&™""©∆M√22jҐ"ТіdH2£&™$ҐFDБr2jҐr
lfh/#&™*($∆gВт2jҐҐТ\v '#'©&†™FJ≤2ТЪҐЪ,w/#+ ¶*Ґ∆mƒ“9tx #Ш∆nВв:
БМfш.#†®FpВв:
БЬg #Ґ™$"∆PAr:*Ґ2j§f4#Ґ™#)'∆JBr:*ҐB*ƒd'#Ґ™$І*GfЅj:*ҐJФe8#Ґ™%Ґђ∆Fr:*ҐbҐФuX?#Ґ™)•Ґ∆{т:*ҐЪҐФx#§GБ :dgаM$F  "B*bД` $$£§"©∆oАJLe`6§І""ђFZ√2Jr≤*Т§eа3$І+)§ҐF^ҐJҐz`  •F\А*b"JТl` ¶$¶§™FmC"bЪВ§dћ;&†•Ґ®)∆F√jj*"J` ¶£!GIƒ≤jJЪЪJtfhN&ІЂ"∆Aјrjz≤ЪҐФ` &©∆wƒqt` '")$Ђ"∆Jjr2
ҐЬgDG'*¶Ґ©$∆  2r™jЇJt` '£#)Ґ™FpDКДul('ЂҐ©GMDтВТzjВ§e$;()Ґ°І*∆mВкВЪZ*Љv‘;(* °&"∆}C™В™°Т$f$7(*™!†™F]ГrВ™ҐB
§d0;(*™$"ђFDГrВ™Ґr
§fP/(*™'*¶∆W√≤В™ҐЪ
§f†3(*™)£ ∆GCтВ™ҐЪҐФ`  ®∆tД“Йt` ®¶'£#FeБ™Т
JЪ,g3)"©™)%∆  2Тъ
Ъ,gA)ЧGWƒrЪ
rЪ\fT?)°§ І#∆kЅ2ЪТ"™leO)Ґ°™) «QА2Ъ*Ґ2zФgP6©§Ґ"£FB™ЪJ“*4eьF)•§®FNДкЪjz≤,d5©®!∆fCЪЪВ$d86©®# ™Fw2ЪВb*¬ldЎE©®*FaCrЪВъJrLe)™)!¶®F  2Ъ ЪҐТ\f83)ђ©™,®FcЅтЪ ЪъҐћ` ™#&F  2ҐТ
rЪ` ™)•ҐЂ∆  ҐҐdf™®("©F  2ЇЪВ
,eд>-"©'ќ   Ю
JЪ,g3)"©™)%∆  2Тъ
Ъ,gA)ЧGWƒееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее
/*
.he                                                                   SETFORM
.pa
*/
#include	"portab.h"

#asm
	.request setfd,setvf,sethw,sethop,setlib,setterm
#endasm

#define		FORMAT			/* Format option		*/
#define		HEADER
#undef		EXTERN			/* Variables are declared here	*/
#include	"setup.h"		/* Global variables		*/
#define		EXTERN	extern

EXTERN
BYTE	hardware[],
	Cmode;

WORD	autofl = 0,	/* Set if automatic run on a particular drive	*/
	reqdrv = -1,	/* Requested drive form command line		*/
	soft_err,	/* 'Soft error' count				*/
	hard_err;

BYTE	*ex_com = 0,
	*ex_arg = 0;

#include	"setpak.c"	/* Get SETPAK.. */
#include	"setfil.c"	/* ..and SETFIL */
#include	"setlst.c"	/* ..and QLIST  */
#include	"setfdp.c"	/* ..and SETFDP */

/*======================================================================*/
main(argc,argv)
WORD	argc;
BYTE	*argv[];
/*======================================================================*/
/*USE
Portability	Level 4 (Depends on Gemini hardware)
Parent Module	FORMAT
Revision History:
26/10/89 Brought up to Timeclaim standards - ICFO
01/07/86 Version 3.4
         Extensively modified. Command line arguments added.  Can now
         enter drive letter from command line, -a for no pause for
         manual inputs, -e for 'exec' on to another command.  Also
         restructured and 'printf' introduced so that the ouput can be
         redirected to a file.
10/06/85 Version 3.0
         Format section split out from main body of SETUP.
         Modified for GM849 & MFB II
         Written by David Parkinson
         (c) dci software 1983, 1984
*/

{

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*/

if (abort(0) != 0)  byebye();
clrs();				/* Clear screen 			*/

putsat(10 RC 15,"(c) dci software 1986 & Timeclaim 1988, 1989");

initvar();			/* Set up pointers to BIOS		*/
head();				/* Put up a heading			*/
bufsiz = 32512;			/* Reserve memory for the data file	*/
while ((data = alloc(bufsiz)) ==ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее