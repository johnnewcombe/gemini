;CP/M TEXT EDITOR
;
BDOS EQU 5
BOOT EQU 0
CR EQU 0DH
LF EQU 0AH
;
ORG 100H
BEGIN:	JMP START
SIGNON:	DB CR,LF,'CP/M EDITOR, D.R.BACK VERSION 1.2',CR,LF,0
BRKMS:	DB CR,LF,'*BREAK*',CR,LF,0
BBMS:	DB ':BB: '
SWCH:	DB 1FH
	DB 0FFH,0DBH,0FFH,0EFH
SPC1MS:	DB '    '
SPC2MS:	DB ' '
TXTMS:	DB 'TEXT: '
FREEMS:	DB '     ',CR,LF,'FREE: '
UCMS:	DB '     ',CR,LF,'UC: '
CRMS:	DB '     ',CR,LF,0
NWFILM:	DB 'NEW FILE',CR,LF,0
STKFMS:	DB 'STACK FAULT',0
BUFLMS:	DB 7,'BUFFER FULL',0
DR0RDY:	DB 'DRIVE 0 NOT READY',0
BDMCFL:	DB 'BAD MACROFILE',CR,LF,0
SPCRMS:	DB '  ',CR,0
NOFIL:	DB 'NO OUTPUT FILE',CR,LF,0
BAKMS:	DB 'BAK',0
TOMS:	DB 'TO',0
NOTFND:	DB 'CANNOT FIND "',0
QUITMS:	DB 'QUIT? ',0
EXITMS:	DB 'EXIT',0
ESCMS:	DB 'NEW ESC!',0
KILLMS:	DB 'N-KILL? ',0
ILEGMS:	DB '" ILLEGAL CONTEXT',CR,LF,0
;================
;
START:	LXI SP,STACK
	LXI H,81H
	SHLD CIPNT
	XRA A
	CMA
	STA INITSW
	CALL STRTUP
X378DH:	LHLD BB1PNT
	MOV B,H
	MOV C,L
	CALL AOPEN3
	LHLD BB1PNT
	MOV B,H
	MOV C,L
	CALL ISERCK
X379DH:	LHLD BB2PNT
	MOV B,H
	MOV C,L
	CALL AOPEN4
	LDA STATUS
	CPI 00H
	JZ X37B9H
	LXI H,BBMS
	SHLD BB2PNT
	CALL OPNOFL
	JMP X379DH
X37B9H:	LXI B,TXTBUF
	LXI D,MSIZ1
	CALL AP0100
	XCHG
	LXI H,000CH
	CALL AP0029
	XCHG
	SHLD X5C6AH
	CALL AP0033
	XCHG
	LXI H,E14UF
	CALL AP0104
	JNC X37E3H
	LHLD X5C6AH
	SHLD X5C6EH
	JMP X37E9H
X37E3H:	LHLD E14UF
	SHLD X5C6EH
X37E9H:	LXI B,X5C6EH
	LXI D,MSIZ1
	CALL AP0098
	SHLD BFPNT
	SHLD TXTND
	LXI B,X5C6AH
	LXI D,BFPNT
	CALL AP0098
	XCHG
	LXI H,TXTBUF
	CALL AP0095
	SHLD X5C66H
	CALL X5790H
	LDA X5D91H
	RAR
	JNC X381DH
	LHLD X5C66H
	MOV B,H
	MOV C,L
	CALL APPND
X381DH:	LXI H,X5D91H
	MVI M,0FFH
	CALL X4039H
	LXI H,CITMP
	MVI M,0FFH
	CALL MACRX
ERRBK:	LXI SP,STACK
	LXI B,BRKMS
	CALL WRSTR
ERRST:	LXI SP,STACK
	LXI H,X5D63H
	MVI M,00H
	CALL X4039H
ERRLP:	LXI SP,STACK
LOOP:	LXI H,X5D5FH
	MVI M,00H
	LXI H,0001H
	SHLD X5D54H
X384FH:	CALL GETCMD
	STA CITMP
	STA X5D58H
	CPI '-'
	JNZ X3867H
	LDA X5D5FH
	CMA
	STA X5D5FH
	JMP X384FH
X3867H:	LDA CITMP
	SUI 2EH
	SUI 01H
	SBB A
	STA X5D5EH
	LDA CITMP
	SUI '/'
	SUI 01H
	SBB A
	STA X5D56H
	LDA X5D5AH
	CPI 01H
	JNZ X388BH
	CALL X475DH
	SHLD X5D54H
X388BH:	LHLD X5D58H
	MOV C,L
	CALL X5035H
	RAR
	JNC X3899H
	CALL X4F7AH
X3899H:	LDA X5D5AH
	CPI 00H
	JZ CMDBRN
	CALL X4CB9H
CMDBRN:	LDA CITMP
	ORI 20H
	SUI 61H
	MOV C,A
	MVI B,00H
	LXI H,X3C98H
	DAD B
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	PCHL
;
AA:	LDA X5D56H
	RAR
	JNC X38C5H
	LHLD X5C66H
	SHLD X5D54H
X38C5H:	MVI A,00H
	LXI H,X5D54H
	CALL AP0103
	JNC X38E1H
	LHLD X5D22H
	SHLD X5D20H
	LHLD X5D54H
	MOV B,H
	MOV C,L
	CALL APPND
	CALL STRST
X38E1H:	CALL OPUCMS
	JMP X3CCCH
;
AB:	CALL SETLBP
	JMP X3CCCH
;
AC:	CALL X5106H
	CALL LPMOVE
	JMP X3CCCH
;
AD:	CALL X5106H
	CALL X51C9H
	JMP X3CCCH
;
AE:	CALL COMAND
	STA CITMP
	LXI H,X5DB9H
	CMP M
	JNZ X3912H
	CALL EXSUB
	CALL AEXIT
X3912H:	LDA CITMP
	CPI 'R'
	JNZ X3920H
	CALL EXSUB
	JMP X378DH
X3920H:	JMP SYNERR
	JMP X3CCCH
;
F:	CALL FIND
	JMP X3CCCH
;
G:	CALL X4A20H
	LDA X5DC2H
	RAR
	JNC X39D4H
	LXI H,X5D5FH
	MVI M,00H
	LXI B,X5D22H
	LXI D,VSTACK+2
	CALL AP0098
	ORA L
	JNZ X394EH
	LHLD TXTND
	SHLD VSTACK+2
X394EH:	LHLD TXTND
	SHLD X5C80H
	LHLD VSTACK+2
	SHLD TXTND
	CALL X4830H
	SHLD X5C6EH
	LXI D,X5D22H
	LXI B,X5C6EH
	CALL AP0098
	SBB A
	LXI B,TXTND
	LXI D,VSTACK+2
	PUSH PSW
	CALL AP0098
	SBB A
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X397FH
	JMP SYNERR
X397FH:	LHLD X5C80H
	SHLD TXTND
	LHLD X5C6EH
	XCHG
	LHLD X5D22H
	DAD D
	XCHG
	LHLD VSTACK+2
	CALL AP0095
	SHLD X5C80H
	MVI A,0AH
	LXI D,TXTND
	PUSH H
	CALL AP0101
	XCHG
	POP H
	CALL AP0095
	JNC X39ABH
	CALL X3FD8H
X39ABH:	LXI B,VSTACK+2
	LXI D,X5C6EH
	CALL AP0098
	JNC X39BAH
	JMP SYNERR
X39BAH:	LHLD VSTACK+2
	PUSH H
	LHLD X5C6EH
	DCX H
	MOV B,H
	MOV C,L
	LHLD X5D22H
	XCHG
	CALL X55CCH
	LHLD X5C80H
	SHLD X5D22H
	JMP X3A05H
X39D4H:	MVI C,01H
	CALL X49F2H
X39D9H:	CALL X3DFEH
	XCHG
	LHLD X5D22H
	MOV B,H
	MOV C,L
	CALL AREAD1
	LHLD ACTUAL
	XCHG
	LHLD X5D22H
	DAD D
	SHLD X5D22H
	CALL X3DFEH
	XCHG
	MVI A,0AH
	CALL AP0096
	JNC X3A02H
	CALL X4DF8H
	JMP X39D9H
X3A02H:	CALL ACLOS1
X3A05H:	JMP X3CCCH
;
AH:	CALL X5106H
	LDA X5D5FH
	RAR
	JC X3A18H
	LHLD TXTND
	SHLD X5C80H
X3A18H:	LXI H,0001H
	SHLD X5C6EH
X3A1EH:	LXI D,X5D54H
	LXI B,X5C6EH
	CALL AP0098
	JC X3A80H
	LHLD X5C80H
	MOV E,M
	MVI D,00H
	LXI H,0010H
	CALL AP0029
	MOV C,E
	CALL X5787H
	MOV C,A
	CALL CONSOP
	LHLD X5C80H
	MVI A,0FH
	ANA M
	MOV C,A
	CALL X5787H
	MOV C,A
	CALL CONSOP
	MVI C,20H
	CALL CONSOP
	CALL CTLSWT
	LHLD X5C6EH
	XCHG
	LHLD E3UF
	MVI H,00H
	CALL AP0029
	MVI A,00H
	CALL AP0094
	ORA L
	JNZ X3A6CH
	CALL CRLF
X3A6CH:	LHLD X5C80H
	INX H
	SHLD X5C80H
	LXI D,0001H
	LHLD X5C6EH
	DAD D
	SHLD X5C6EH
	JNC X3A1EH
X3A80H:	CALL CRLF
	JMP X3CCCH
;
I:	CALL X5140H
	RAR
	JNC X3A93H
	CALL INSSTR
	JMP I
X3A93H:	JMP X3CCCH
;
J:	CALL X5140H
	RAR
	JNC X3AB8H
	LDA X5D5FH
	RAR
	JNC X3AAEH
	LHLD CITMP
	MOV C,L
	CALL CO
	JMP X3AB5H
X3AAEH:	LHLD CITMP
	MOV C,L
	CALL CONSOP
X3AB5H:	JMP J
X3AB8H:	JMP X3CCCH
;
K:	CALL X4830H
	SHLD X5C80H
	CALL X51C9H
	JMP X3CCCH
;
AL:	CALL X4830H
	SHLD X5C80H
	CALL LPMOVE
	JMP X3CCCH
;
AM:	CALL COMAND
	STA CITMP
	CALL X4056H
	MVI C,4EH
	CALL CNDCO
	LDA X5D5FH
	RAR
	JNC X3AEDH
	MVI C,01H
	CALL CNDCO
X3AEDH:	LHLD X5C76H
	INX H
	INX H
	XCHG
	LXI H,X5C72H
	CALL AP0104
	JNC X3B09H
	LHLD X5C72H
	MOV C,M
	CALL CNDCO
	CALL X430EH
	JMP X3AEDH
X3B09H:	CALL X4E31H
	JMP X3CCCH
;
N:	LDA X5DC4H
	CPI 00H
	JZ X3B1AH
	JMP SYNERR
X3B1AH:	CALL COMAND
	CPI 20H
	JNZ X3B38H
	LXI B,KILLMS
	CALL WRSTR
	CALL X4EA7H
	RAR
	JNC X3B35H
	LHLD MSIZ2
	SHLD MSIZ1
X3B35H:	JMP X3C13H
X3B38H:	LHLD X5D4EH
	SHLD X5C7CH
	LHLD X5C70H
	SHLD X5C78H
	CALL X4610H
	RAR
	JNC X3B63H
X3B4BH:	CALL X576DH
	RAR
	JNC X3B5CH
	LHLD X5D4EH
	DCX H
	SHLD X5D4EH
	JMP X3B4BH
X3B5CH:	LHLD X5D4EH
	INX H
	SHLD X5C78H
X3B63H:	LHLD MSIZ1
	DCX H
	SHLD X5C72H
	LDA CITMP
	MOV M,A
	CALL X430EH
	LXI B,X5C78H
	LXI D,X5C7CH
	CALL AP0098
	LXI D,0005H
	DAD D
	SHLD X5C74H
	LXI D,MSIZ1
	CALL AP0102
	XCHG
	DCX H
	MOV M,E
	INX H
	MOV M,D
	LXI H,X5C84H
	CALL AP0104
	JNC X3BA3H
	LHLD X5C74H
	XCHG
	LHLD MSIZ1
	DAD D
	SHLD MSIZ1
	CALL X3FD8H
X3BA3H:	LHLD X5C78H
	PUSH H
	LHLD MSIZ1
	INX H
	INX H
	INX H
	XCHG
	LHLD X5C7CH
	MOV B,H
	MOV C,L
	CALL X55CCH
	LXI H,X5E41H
	MVI M,0FFH
X3BBBH:	LHLD MSIZ1
	INX H
	INX H
	INX H
	LXI D,X5C72H
	CALL AP0102
	JC X3BEDH
	LHLD X5C72H
	MOV A,M
	CPI 01H
	JNZ X3BD9H
	CALL X430EH
	JMP X3BE7H
X3BD9H:	LHLD X5C72H
	MOV A,M
	SUI 02H
	SUI 01H
	SBB A
	LXI H,X5E41H
	ADD M
	MOV M,A
X3BE7H:	CALL X430EH
	JMP X3BBBH
X3BEDH:	LHLD X5C72H
	LDA X5E41H
	MOV M,A
	CALL X430EH
	CALL X430EH
	LHLD X5C72H
	PUSH H
	LHLD X5C74H
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	CALL X402DH
	CALL X4610H
	RAR
	JC X3C13H
	JMP ERRST
X3C13H:	JMP X3CCCH
;
O:	CALL COMAND
	CPI 4FH
	JZ X3C21H
	JMP SYNERR
X3C21H:	CALL X4907H
	JMP X3CCCH
;
P:	CALL X4A20H
	MVI C,02H
	CALL X49F2H
	LXI B,X4E14H
	CALL WROP
	CALL ACLOS1
	JMP X3CCCH
;
Q:	CALL QUITR
	JMP X3CCCH
;
R:	CALL COMAND
	STA CITMP
	CALL MACRX
	JMP X3CCCH
;
S:	CALL FIND
	LDA X5DB8H
	LXI D,X5D22H
	CALL AP0101
	XCHG
	DCX H
	MOV M,E
	INX H
	MOV M,D
	JMP I
	JMP X3CCCH
;
T:	LXI B,X3E08H
	CALL WROP
	JMP X3CCCH
;
U:	CALL X51E0H
	JMP X3CCCH
;
V:	CALL SETV
	JMP X3CCCH
;
W:	CALL NWFLSH
	JMP X3CCCH
;
X:	LXI B,WROP2
	CALL WROP
	JMP X3CCCH
;
Y:	CALL X4E5AH
	MOV C,A
	CALL X5042H
	JMP X3CCCH
;
Z:	CALL SETLPZ
	JMP X3CCCH
;==========
X3C98H:	DW AA,AB,AC,AD
	DW AE,F,G,AH
	DW I,J,K,AL
	DW AM,N,O,P
	DW Q,R,S,T
	DW U,V,W,X
	DW Y,Z
;==============
X3CCCH:	JMP LOOP
SYNERR:	LXI SP,STACK
	MVI A,20H
	LXI H,CITMP
	SUB M
	SBB A
	PUSH PSW
	MOV A,M
	SUI 7EH
	ADI 0FFH
	SBB A
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X3CFFH
	CALL CRLF
	MVI C,22H
	CALL CO
	LHLD CITMP
	MOV C,L
	CALL CONSOP
	LXI B,ILEGMS
	CALL WRSTR
	CALL X4039H
X3CFFH:	JMP ERRLP
	EI
	HLT
;=========================
;SUBROUTINES FOLLOW
;===================
X3D04H:	LXI H,X5DF3H
	MOV M,C
	LHLD X5DF3H
	MOV C,L
	LXI D,SWCH
	CALL X580FH
	RET
;================
CONIP:	LDA E10UF
	RRC
	RAR
	JNC X3D27H
	LXI D,0001H
	LXI B,X5DF4H
	CALL ACIRD
	JMP X3D2DH
X3D27H:	CALL CI
	STA X5DF4H
X3D2DH:	LDA X5DF4H
	ANI 7FH
	RET
;==================
CONSTS:	CALL CSTS
	RAR
	JNC X3D48H
	CALL CONIP
	STA CITMP
	CPI 03H; CTRL C
	JNZ X3D48H
	JMP ERRBK
X3D48H:	RET
;================
CTLSWT:	LDA X5DF5H
	INR A
	STA X5DF5H
	CPI 00H
	JNZ X3D66H
	CALL CONSTS
X3D58H:	LDA CITMP
	CPI 13H; CTRL S
	JNZ X3D66H
	CALL CONSTS
	JMP X3D58H
X3D66H:	RET
;================
CONSOP:	LXI H,X5DF6H
	MOV M,C
	LXI H,X5DF7H
	MVI M,00H
	LDA X5DB9H
	DCX H
	CMP M
	JNZ X3D7EH
	LDA E12UF
	STA X5DF6H
X3D7EH:	LDA X5DF6H
	CPI 09H; CTRL I
	JNZ X3DA5H
	LDA E11UF
	DCR A
	LHLD X5D59H
	MVI H,00H
	XCHG
	LHLD E11UF
	MVI H,00H
	PUSH PSW
	CALL AP0029
	POP PSW
	CALL AP0094
	XCHG
	LXI H,X5DF7H
	MOV M,E
	DCX H
	MVI M,' '
X3DA5H:	LDA X5DF6H
	CPI CR
	JNZ X3DB2H
	LXI H,X5D59H
	MVI M,0FEH
X3DB2H:	LHLD X5DF6H
	MOV C,L
	CALL X3D04H
	RAR
	JNC X3DCEH
	MVI C,'^'
	CALL CO
	LDA X5DF6H
	ADI 40H
	STA X5DF6H
	LXI H,X5D59H
	INR M
X3DCEH:	LXI H,X5DF8H
	MVI M,00H
X3DD3H:	LDA X5DF7H
	LXI H,X5DF8H
	CMP M
	JC X3DFDH
	LXI H,X5D59H
	INR M
	LDA X5DF6H
	CPI ' '
	JNZ X3DEFH
	LDA E1UF
	STA X5DF6H
X3DEFH:	LHLD X5DF6H
	MOV C,L
	CALL CO
	LXI H,X5DF8H
	INR M
	JNZ X3DD3H
X3DFDH:	RET
;==============
X3DFEH:	LXI B,X5D22H
	LXI D,TXTND
	CALL AP0098
	RET
;=============
X3E08H:	LXI H,X5DFCH
	MOV M,D
	DCX H
	MOV M,E
	DCX H
	MOV M,B
	DCX H
	MOV M,C
X3E12H:	LXI B,X5DFBH
	LXI D,X5DF9H
	CALL AP0098
	JNC X3E32H
	LHLD X5DF9H
	MOV C,M
	CALL CONSOP
	CALL CTLSWT
	LHLD X5DF9H
	INX H
	SHLD X5DF9H
	JMP X3E12H
X3E32H:	RET
;===============
WRSTR:	LXI H,X5DFEH
	MOV M,B
	DCX H
	MOV M,C
X3E39H:	LHLD X5DFDH
	MOV A,M
	CPI 00H
	JZ X3E53H
	LHLD X5DFDH
	MOV C,M
	CALL CO
	LHLD X5DFDH
	INX H
	SHLD X5DFDH
	JMP X3E39H
X3E53H:	RET
;===============
CRLF:	MVI C,CR
	CALL CONSOP
	MVI C,LF
	CALL CONSOP
	RET
;=================
STKFLT:	LXI H,X5E00H
	MOV M,B
	DCX H
	MOV M,C
	LHLD X5DFFH
	MOV A,M
	INR A
	MOV M,A
	MOV C,A
	MVI A,LF
	CMP C
	JNC X3E7BH
	LXI B,STKFMS
	CALL WRSTR
	JMP ERRBK
X3E7BH:	RET
;===============
LDUCMS:	LXI H,X5E04H
	MOV M,D
	DCX H
	MOV M,E
	DCX H
	MOV M,B
	DCX H
	MOV M,C
	LXI B,SPC1MS
	PUSH B
	LHLD X5E03H
	XCHG
	LXI B,SPC2MS
	CALL X55CCH
	LXI H,X5D5BH
	MVI M,10H
X3E99H:	LHLD X5E01H
	XCHG
	LHLD E3UF
	MVI H,00H
	CALL AP0029
	MOV C,L
	CALL X5787H
	PUSH PSW
	LDA X5D5BH
	DCR A
	STA X5D5BH
	MOV C,A
	MVI B,00H
	LXI H,X5E05H
	DAD B
	POP B
	MOV C,B
	MOV M,C
	LHLD X5E01H
	XCHG
	LHLD E3UF
	MVI H,00H
	CALL AP0029
	XCHG
	SHLD X5E01H
	MVI A,00H
	CALL AP0094
	JNC X3ED6H
	JMP X3E99H
X3ED6H:	LHLD X5D5BH
	MVI H,00H
	LXI B,X5E05H
	DAD B
	PUSH H
	LHLD X5E03H
	XCHG
	LXI B,X5E14H
	CALL X55CCH
	LXI H,X5D5BH
	MVI A,10H
	SUB M
	MOV M,A
	RET
;============
LPMOVE:	LXI B,X5D22H
	LXI D,X5C80H
	CALL AP0098
	ORA L
	JNZ X3F00H
	RET
X3F00H:	CALL X3DFEH
	SHLD X5D4AH
	LXI D,X5D22H
	LXI B,X5C80H
	CALL AP0098
	JNC X3F57H
	LXI B,TXTND
	LXI D,X5C80H
	CALL AP0098
	JNC X3F24H
	LHLD TXTND
	SHLD X5C80H
X3F24H:	LHLD TXTND
	SHLD X5D50H
	LHLD TXTND
	PUSH H
	LHLD X5C80H
	MOV B,H
	MOV C,L
	LHLD X5D22H
	XCHG
	CALL X55CCH
	LHLD X5D4AH
	CALL AP0041
	SHLD X5D4AH
	XCHG
	LHLD X5C80H
	DAD D
	SHLD X5D22H
	LHLD X5C80H
	SHLD TXTND
	SHLD X5D4CH
	JMP X3F89H
X3F57H:	LHLD X5D22H
	SHLD X5D4CH
	LHLD X5C80H
	PUSH H
	LHLD X5D22H
	DCX H
	PUSH H
	CALL X3DFEH
	PUSH H
	LHLD X5C80H
	POP B
	DAD B
	XCHG
	POP B
	CALL X55CCH
	LHLD X5D4AH
	XCHG
	LHLD X5C80H
	DAD D
	SHLD TXTND
	LHLD X5C80H
	SHLD X5D22H
	INX H
	SHLD X5D50H
X3F89H:	CALL X5E42H
	RET
;===============
X5E42H:	LHLD X5D50H
	SUB A
	SUB L
	MOV L,A
	MVI A,00H
	SBB H
	MOV H,A
	SHLD X5E6AH
	LHLD X5D4CH
	MOV A,H
	CMA
	MOV H,A
	MOV A,L
	CMA
	MOV L,A
	SHLD X5E71H
	MVI A,09H
	LXI H,X5D0FH
	PUSH H
X5E61H:	POP H
X5E62H:	DCR A
	RM
	INX H
	MOV E,M
	INX H
	MOV D,M
	PUSH H
	DB 21H
X5E6AH:	DW 0000H
	DAD D
	JNC X5E61H
	DB 21H
X5E71H:	DW 0000H
	DAD D
	JC X5E61H
	LHLD X5D4AH
	DAD D
	XCHG
	POP H
	MOV M,D
	DCX H
	MOV M,E
	INX H
	JMP X5E62H
;=================
ISERCK:	LXI H,X5E16H
	MOV M,B
	DCX H
	MOV M,C
	LDA STATUS
	CPI 00H
	JNZ X3F9CH
	RET
X3F9CH:	LHLD X5E15H
	MOV B,H
	MOV C,L
	CALL X5A4AH
X3FA4H:	CALL X5962H
	RAR
	JC X3FB8H
	LHLD ISERNO
	MOV C,M
	CALL CONSOP
	CALL X599FH
	JMP X3FA4H
X3FB8H:	CALL AERROR
	LXI H,X5F36H
	MVI M,0FFH
	JMP ERRBK
	RET
;==============
SETLBP:	LXI H,TXTBUF
	SHLD X5C80H
	CALL LPMOVE
	RET
;===============
SETLPZ:	LHLD BFPNT
	SHLD X5C80H
	CALL LPMOVE
	RET
;===============
X3FD8H:	LXI B,BUFLMS
	CALL WRSTR
	JMP ERRBK
	RET
;================
X3FE2H:	CALL X3DFEH
	XCHG
	MVI A,0AH
	CALL AP0096
	JNC X3FF1H
	CALL X3FD8H
X3FF1H:	RET
;===============
X3FF2H:	LDA E13UF
	RAR
	JNC X3FFAH
	RET
X3FFAH:	XRA A
	CMA		;DUMMY TEST FOR DISK STATUS
	RAR
	JC X400AH
	LXI B,DR0RDY
	CALL WRSTR
	JMP ERRBK
X400AH:	RET
;==============
X402DH:	LXI H,X5DC0H
	MVI M,0FFH
	LHLD MSIZ1
	SHLD X5C70H
	RET
;===============
X4039H:	LHLD BFPNT
	SHLD X5C84H
	CALL X402DH
	LHLD X5C70H
	DCX H
	SHLD X5D4EH
	LXI B,0035H
	PUSH B
	MVI E,00H
	LXI B,X5DBAH
	CALL X5847H
	RET
;==============
X4056H:	LHLD MSIZ1
	SHLD X5C72H
X405CH:	LHLD X5C72H
	MVI A,00H
	CALL AP0103
	ORA L
	JZ X408DH
	LHLD X5C72H
	SHLD X5C76H
	LXI D,X5C72H
	CALL AP0012
	DCX H
	XCHG
	DCX H
	MOV M,E
	INX H
	MOV M,D
	LXI H,CITMP
	LDAX D
	CMP M
	JNZ X4083H
	RET
X4083H:	LHLD X5C72H
	INX H
	SHLD X5C72H
	JMP X405CH
X408DH:	JMP SYNERR
	RET
;==============
STKCK:	LXI B,X5DDBH
	CALL STKFLT
	LHLD X5DDCH
	MVI H,00H
	LXI B,X5DC5H
	DAD H
	DAD B
	PUSH H
	LHLD X5D4EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	RET
;=============
X40ABH:	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CE4H
	DAD H
	DAD B
	PUSH H
	LHLD X5D4EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	LHLD X5C72H
	DCX H
	SHLD X5D4EH
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5D24H
	DAD H
	DAD B
	PUSH H
	LHLD X5D54H
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CB8H
	DAD B
	LDA X5D5FH
	MOV M,A
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CC3H
	DAD B
	MVI M,00H
	LXI H,X5DDCH
	INR M
	JMP ERRLP
	RET
;==============
MACRX:	CALL X4056H
	CALL STKCK
	LHLD X5C76H
	INX H
	INX H
	MVI A,0FFH
	SUB M
	STA X5E19H
	CPI 00H
	JZ X4153H
X410EH:	MVI A,00H
	LXI H,X5E19H
	SUB M
	SBB A
	LXI D,X5C70H
	LXI B,X5D4EH
	PUSH PSW
	CALL AP0098
	SBB A
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X4153H
	LHLD X5D4EH
	MOV A,M
	CPI 01H
	JNZ X413AH
	LHLD X5D4EH
	DCX H
	SHLD X5D4EH
	JMP X4149H
X413AH:	LHLD X5D4EH
	LDA X5DB9H
	SUB M
	SUI 01H
	SBB A
	LXI H,X5E19H
	ADD M
	MOV M,A
X4149H:	LHLD X5D4EH
	DCX H
	SHLD X5D4EH
	JMP X410EH
X4153H:	CALL X40ABH
	RET
;===============
EDMCLD:	LXI B,BFPNT
	LXI D,MSIZ1
	CALL AP0098
	XCHG
	MVI A,0F0H
	CALL AP0096
	SHLD X5C6EH
	LHLD BFPNT
	MOV B,H
	MOV C,L
	LHLD X5C6EH
	XCHG
	CALL AREAD1
	CALL ACLOS1
	LXI B,X5C6EH
	LXI D,ACTUAL
	CALL AP0098
	ORA L
	JNZ X4188H
	CALL X3FD8H
X4188H:	MVI A,10H
	LXI H,ACTUAL
	CALL AP0103
	JNC X420CH
	LXI D,0010H
	LHLD BFPNT
	DAD D
	PUSH H
	LHLD ACTUAL
	XCHG
	LHLD BFPNT
	DAD D
	DCX H
	LXI B,ACTUAL
	LXI D,MSIZ1
	PUSH H
	CALL AP0098
	LXI D,0010H
	DAD D
	SHLD X5C72H
	SHLD X5E1AH
	XCHG
	POP B
	CALL X55CCH
X41BDH:	LXI B,MSIZ1
	LXI D,X5C72H
	CALL AP0098
	ORA L
	JZ X4206H
	LHLD X5C72H
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5C6EH
	LXI B,X5C72H
	PUSH D
	LXI D,MSIZ1
	CALL AP0098
	XCHG
	POP H
	DCX H
	CALL AP0104
	JNC X41F8H
	LXI B,BDMCFL
	CALL WRSTR
	LDA X5DBAH
	RAR
	JNC X41F5H
	RET
X41F5H:	JMP ERRBK
X41F8H:	LHLD X5C6EH
	XCHG
	LHLD X5C72H
	DAD D
	SHLD X5C72H
	JMP X41BDH
X4206H:	LHLD X5E1AH
	SHLD MSIZ1
X420CH:	LXI B,000BH
	LHLD BFPNT
	DAD B
	MOV A,M
	CPI 00H
	JZ X422CH
	LHLD BFPNT
	PUSH H
	LXI D,000FH
	LHLD BFPNT
	DAD D
	MOV B,H
	MOV C,L
	LXI D,X5D91H
	CALL X55CCH
X422CH:	CALL X402DH
	LDA X5DBAH
	RAR
	JNC X4237H
	RET
X4237H:	LXI H,CITMP
	MVI M,0FEH
	CALL MACRX
	RET
;================
APPND:	LXI H,X5E1DH
	MOV M,B
	DCX H
	MOV M,C
	CALL X3FF2H
	CALL SETLPZ
	CALL X3DFEH
	XCHG
	MVI A,0F0H
	CALL AP0096
	XCHG
	LHLD X5E1CH
	MOV B,H
	MOV C,L
	CALL X583EH
	SHLD X5E1CH
	LHLD X5D22H
	MOV B,H
	MOV C,L
	LHLD X5E1CH
	XCHG
	CALL AREAD3
	LHLD ACTUAL
	XCHG
	LHLD X5D22H
	DAD D
	SHLD X5D22H
	CALL SETLBP
	RET
;===============
INSSTR:	CALL X3FE2H
	LHLD X5D22H
	LDA CITMP
	MOV M,A
	LHLD X5D22H
	INX H
	SHLD X5D22H
	RET
;==============
CNDCO:	LXI H,X5E1EH
	MOV M,C
	LDA X5E1EH
	STA CITMP
	LDA X5D5FH
	RAR
	JNC X42A3H
	CALL INSSTR
	RET
X42A3H:	LHLD CITMP
	MOV C,L
	CALL CONSOP
	RET
;================
X42ABH:	LXI H,X5E1FH
	MOV M,C
	LDA E10UF
	RAR
	JC X42BDH
	LHLD X5E1FH
	MOV C,L
	CALL CONSOP
X42BDH:	LHLD X5C70H
	DCX H
	SHLD X5C70H
	LDA X5E1FH
	MOV M,A
	LHLD X5D22H
	XCHG
	LHLD MSIZ1
	DAD D
	PUSH H
	LHLD TXTND
	XCHG
	LHLD X5C70H
	DAD D
	POP D
	CALL AP0095
	XCHG
	MVI A,03H
	CALL AP0096
	JNC X42EBH
	MVI C,07H;BELL
	CALL CO
X42EBH:	RET
;==============
DELCHR:	LXI H,X5D59H
	DCR M
	LHLD E2UF
	MOV C,L
	CALL CO
	LHLD E1UF
	MOV C,L
	CALL CO
	LHLD E2UF
	MOV C,L
	CALL CO
	RET
;=================
WRPRM:	LHLD E6UF
	MOV C,L
	CALL CONSOP
	RET
;==============
X430EH:	LHLD X5C72H
	DCX H
	SHLD X5C72H
	RET
;===============
SPCCO:	LXI B,SPCRMS
	CALL WRSTR
	LHLD X5C70H
	SHLD X5C72H
X4322H:	LXI B,MSIZ1
	LXI D,X5C72H
	CALL AP0098
	SBB A
	XCHG
	DCX H
	MOV C,M
	INX H
	MOV B,M
	PUSH PSW
	LDAX B
	SUI LF
	ADI 0FFH
	SBB A
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X4349H
	LHLD X5C72H
	INX H
	SHLD X5C72H
	JMP X4322H
X4349H:	LXI B,X5C70H
	LXI D,X5C72H
	CALL AP0098
	ORA L
	JZ X4363H
	CALL X430EH
	LHLD X5C72H
	MOV C,M
	CALL CONSOP
	JMP X4349H
X4363H:	RET
;===============
X4364H:	LDA CITMP
	STA X5DBFH
	MOV C,A
	CALL X42ABH
	CALL CONIP
	STA CITMP
	RET
;===============
PRMPT:	CALL WRPRM
	LHLD E2UF
	MOV C,L
	CALL CO
	LXI H,X5D59H
	DCR M
	RET
;================
LDCMD:	LDA X5D63H
	RAR
	JNC X438EH
	CALL PRMPT
X438EH:	CALL X4039H
	CALL CONIP
	STA CITMP
	CPI 7FH; RUBOUT
	JNZ X43A4H
	MVI C,07H; BELL
	CALL CO
	JMP LDCMD
X43A4H:	LDA CITMP
	CPI 7EH
	JNZ X43AFH
	JMP LDCMD
X43AFH:	LDA X5D63H
	RAR
	JC X43DAH
	LHLD CITMP
	MOV C,L
	CALL X3D04H
	RAR
	JNC X43CDH
	LHLD X5C70H
	DCX H
	SHLD X5C70H
	LDA CITMP
	MOV M,A
	RET
X43CDH:	LDA CITMP
	ANI 5FH
	SUI 49H
	ADI 0FFH
	SBB A
	STA X5DBBH
X43DAH:	LXI H,X5DB9H
	LDA CITMP
	SUB M
	ADI 0FFH
	SBB A
	PUSH PSW
	LDA X5DBFH
	SUB M
	ADI 0FFH
	SBB A
	POP B
	MOV C,B
	ORA C
	RAR
	JNC X450DH
X43F3H:	LDA CITMP
	SUI 01H
	SUI 01H
	SBB A
	PUSH PSW
	LDA CITMP
	SUI 7EH
	SUI 01H
	SBB A
	POP B
	MOV C,B
	ORA C
	RAR
	JNC X4421H
	CALL X4364H
	LDA CITMP
	CPI 7FH;RUBOUT
	JZ X4419H
	CALL X4364H
X4419H:	LXI H,X5DBFH
	MVI M,00H
	JMP X43F3H
X4421H:	LDA CITMP
	CPI 03H;CTRL C
	JNZ X442CH
	JMP ERRBK
X442CH:	LDA CITMP
	CPI CR
	JNZ X4451H
	LDA X5DBBH
	RAR
	JNC X4440H
	MVI C,07H;BELL
	CALL CO
X4440H:	LDA E10UF
	RAR
	JC X4451H
	MVI C,CR
	CALL X42ABH
	LXI H,CITMP
	MVI M,LF
X4451H:	LDA CITMP
	CPI 12H;CTRL R
	JNZ X4468H
	CALL CRLF
	CALL SPCCO
	CALL CONIP
	STA CITMP
	JMP X450AH
X4468H:	LDA CITMP
	CPI 1AH;CTRL Z
	JNZ X4481H
	CALL CRLF
	CALL CONIP
	STA CITMP
	LXI H,X5DBBH
	MVI M,00H
	JMP X450AH
X4481H:	LDA CITMP
	CPI 7FH;RUBOUT
	JNZ X44CEH
	CALL DELCHR
	LHLD X5C70H
	MOV A,M
	STA X5DBFH
	MOV C,A
	CALL X3D04H
	RAR
	JNC X449EH
	CALL DELCHR
X449EH:	LHLD X5C70H
	INX H
	SHLD X5C70H
	LDA X5DBFH
	CPI 0DH
	JNZ X44B0H
	CALL SPCCO
X44B0H:	LXI H,X5DBFH
	MVI M,00H
	LXI B,MSIZ1
	LXI D,X5C70H
	CALL AP0098
	ORA L
	JNZ X44C5H
	JMP LDCMD
X44C5H:	CALL CONIP
	STA CITMP
	JMP X450AH
X44CEH:	LDA CITMP
	CPI 18H;CTRL X
	JNZ X4507H
	MVI C,'#'
	CALL CONSOP
	CALL CRLF
X44DEH:	LHLD X5C70H
	MOV A,M
	CPI LF
	JZ X44FEH
	LHLD X5C70H
	INX H
	SHLD X5C70H
	LXI D,MSIZ1
	CALL AP0102
	ORA L
	JNZ X44FBH
	JMP LDCMD
X44FBH:	JMP X44DEH
X44FEH:	CALL CONIP
	STA CITMP
	JMP X450AH
X4507H:	CALL X4364H
X450AH:	JMP X43DAH
X450DH:	LHLD CITMP
	MOV C,L
	CALL X42ABH
	CALL CRLF
	LXI H,X5D63H
	MVI M,00H
	LHLD X5D4EH
	INX H
	SHLD ISERNO
X4523H:	LHLD ISERNO
	DCX H
	SHLD ISERNO
	PUSH H
	LHLD X5C70H
	INX H
	POP D
	CALL AP0095
	JC X45D4H
X4536H:	LHLD ISERNO
	MOV A,M
	CPI 01H
	JNZ X454AH
	LHLD ISERNO
	DCX H
	DCX H
	SHLD ISERNO
	JMP X4536H
X454AH:	LHLD ISERNO
	MOV A,M
	SUI 04H;CTRL D
	SUI 01H
	SBB A
	STA CITMP
	RAR
	JNC X455FH
	LHLD ISERNO
	MVI M,00H
X455FH:	LDA X5DBDH
	STA X5D61H
	LXI H,CITMP
	XRA M
	STA X5DBDH
	LDA X5D61H
	RAR
	JNC X45CCH
	LDA X5DBEH
	CMA
	STA X5DBEH
	RAR
	JNC X45A0H
	CALL X590FH
	RAR
	JNC X4593H
	CALL X5985H
	STA X5D5DH
	LHLD ISERNO
	MVI M,01H
	JMP X459DH
X4593H:	LXI H,X5DBEH
	MVI M,00H
	LHLD ISERNO
	MVI M,00H
X459DH:	JMP X45C9H
X45A0H:	CALL X590FH
	RAR
	JNC X45C2H
	LHLD X5D5DH
	MVI H,00H
	DAD H
	DAD H
	DAD H
	DAD H
	PUSH H
	CALL X5985H
	MOV E,A
	MVI D,00H
	POP H
	DAD D
	PUSH H
	LHLD ISERNO
	POP B
	MOV M,C
	JMP X45C9H
X45C2H:	LHLD ISERNO
	LDA X5D5DH
	MOV M,A
X45C9H:	JMP X45D1H
X45CCH:	LXI H,X5DBEH
	MVI M,00H
X45D1H:	JMP X4523H
X45D4H:	RET
;=============
X45D5H:	LDA X5DDCH
	DCR A
	STA X5DDCH
	CPI 00H
	JNZ X45EBH
	LDA X5DC0H
	RAR
	JNC X45EBH
	JMP ERRST
X45EBH:	RET
;===============
X45ECH:	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CE4H
	DAD H
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5D4EH
	LDA X5DDBH
	DCR A
	STA X5DDBH
	CPI 0FFH
	JNZ X460CH
	JMP SYNERR
X460CH:	CALL X45D5H
	RET
;==============
X4610H:	MVI A,00H
	LXI H,X5DDCH
	SUB M
	SBB A
	RET
;===================
GETCMD:	LXI D,MSIZ1
	LXI B,X5D4EH
	CALL AP0098
	JNC X462EH
	CALL X4610H
	RAR
	JC X462EH
	JMP ERRST
X462EH:	LHLD X5D4EH
	INX H
	LXI D,X5C70H
	CALL AP0102
	ORA L
	JNZ X4642H
	CALL WRPRM
	CALL LDCMD
X4642H:	CALL CTLSWT
	LHLD X5D4EH
	MOV A,M
	STA X5E20H
	MOV C,A
	CALL X570CH
	STA X5D5AH
	LHLD X5D4EH
	DCX H
	SHLD X5D4EH
	LDA X5DC1H
	RAR
	JNC X4669H
	LXI H,X5DC1H
	MVI M,00H
	JMP X4759H
X4669H:	LDA X5E20H
	CPI 00H
	JNZ X4674H
	JMP X462EH
X4674H:	MVI A,00H
	LXI H,X5DDBH
	CMP M
	JNC X474EH
	LDA X5E20H
	CPI 02H
	JNZ X46D7H
	CALL X4610H
	RAR
	JC X468FH
	JMP ERRBK
X468FH:	LXI B,X5DDBH
	CALL STKFLT
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CC3H
	DAD B
	MVI M,0FFH
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CE4H
	DAD H
	DAD B
	PUSH H
	LHLD X5D4EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	CALL X45D5H
	LHLD X5DDCH
	MVI H,00H
	LXI B,X5DC5H
	DAD H
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5D4EH
	XCHG
	LXI H,X5C70H
	CALL AP0104
	JNC X46D4H
	JMP ERRBK
X46D4H:	JMP X4642H
X46D7H:	LDA X5E20H
	CPI 05H;CTRL E
	JNZ X46EAH
	LXI H,X5D63H
	MVI M,0FFH
	CALL LDCMD
	JMP X4642H
X46EAH:	LXI H,X5DB9H
	LDA X5E20H
	CMP M
	JNZ X4720H
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CC3H
	DAD B
	MOV A,M
	RAR
	JNC X4720H
	LHLD X5DDCH
	MVI H,00H
	LXI B,X5DC5H
	DAD H
	DAD B
	PUSH H
	LHLD X5D4EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	LXI H,X5DDCH
	INR M
	INR M
	CALL X45ECH
	JMP X4642H
X4720H:	LDA X5E20H
	CPI 06H;CTRL F
	JNZ X474EH
	CALL PRMPT
	CALL CONIP
	STA X5E20H
	MOV C,A
	CALL CONSOP
	LHLD X5E20H
	MOV C,L
	CALL X570CH
	STA X5D5AH
	LDA X5E20H
	CPI 03H;CTRL C
	JNZ X474AH
	JMP ERRBK
X474AH:	LDA X5E20H
	RET
X474EH:	LDA X5E20H
	SUI 01H
	SUI 01H
	SBB A
	STA X5DC1H
X4759H:	LDA X5E20H
	RET
;===============
X475DH:	LDA CITMP
	SUI '0'
	SBB A
	PUSH PSW
	MVI A,3AH
	LXI H,CITMP
	SUB M
	SBB A
	POP B
	MOV C,B
	ORA C
	RAR
	JNC X4778H
	CALL GETCMD
	STA CITMP
X4778H:	LXI H,0000H
	SHLD X5E21H
X477EH:	LDA X5D5AH
	CPI 01H
	JNZ X47B5H
	LHLD X5E21H
	DAD H
	DAD H
	PUSH H
	LHLD X5E21H
	POP B
	DAD B
	DAD H
	LDA CITMP
	SUI '0'
	MOV E,A
	MVI D,00H
	DAD D
	SHLD X5E21H
	LDA CITMP
	CPI ':'
	JNZ X47ACH
	LXI H,0FFFFH
	SHLD X5E21H
X47ACH:	CALL GETCMD
	STA CITMP
	JMP X477EH
X47B5H:	MVI A,00H
	LXI D,X5E21H
	CALL AP0101
	ORA L
	JNZ X47EDH
	LDA X5D5EH
	LXI H,X5D5FH
	ORA M
	PUSH PSW
	LDA X5D58H
	SUI ';'
	SUI 01H
	SBB A
	POP B
	MOV C,B
	ORA C
	PUSH PSW
	LDA X5D58H
	SUI '='
	SUI 01H
	SBB A
	POP B
	MOV C,B
	ORA C
	RAR
	JNC X47E8H
	LXI H,0001H
	RET
X47E8H:	LXI H,X5D5FH
	MVI M,0FFH
X47EDH:	LHLD X5E21H
	RET
;=================
LDCK:	MVI A,07H
	LXI D,X5D54H
	CALL AP0025
	MOV A,L
	RET
;================
SETV:	CALL LDCK
	MOV C,A
	MVI B,00H
	LXI H,VSTACK
	DAD B
	DAD B
	PUSH H
	LHLD X5D22H
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	RET
;===============
LDSCLN:	CALL LDCK
	MOV C,A
	MVI B,00H
	LXI H,SCOLON
	DAD B
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	RET
;================
LDVMRK:	CALL LDCK
	MOV C,A
	MVI B,00H
	LXI H,VSTACK
	DAD B
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	RET
;================
X4830H:	LDA X5D5EH
	RAR
	JNC X483BH
	CALL LDVMRK
	RET
;================
X483BH:	LXI B,0FFFFH
	LXI D,X5D54H
	CALL AP0100
	ORA L
	JNZ X4857H
	LDA X5D5FH
	RAR
	JNC X4853H
	LXI H,TXTBUF
	RET
X4853H:	LHLD BFPNT
	RET
X4857H:	LDA X5D5FH
	RAR
	JNC X4872H
	LXI B,TXTBUF
	LXI D,X5D22H
	CALL AP0100
	INX H
	MOV B,H
	MOV C,L
	LHLD X5D22H
	XCHG
	CALL X5678H
	RET
X4872H:	LXI B,TXTND
	LXI D,BFPNT
	CALL AP0098
	MOV B,H
	MOV C,L
	LHLD TXTND
	XCHG
	CALL X56A3H
	RET
;===============
WROPND:	LXI H,X5E26H
	MOV M,D
	DCX H
	MOV M,E
	DCX H
	MOV M,B
	DCX H
	MOV M,C
	LXI B,X5E23H
	LXI D,X5E25H
	CALL AP0098
	XCHG
	LHLD X5E23H
	MOV B,H
	MOV C,L
	CALL AWRIT4
	LHLD BB2PNT
	MOV B,H
	MOV C,L
	CALL ISERCK
	RET
;===============
WROP:	LXI H,WRBRAN+1
	MOV M,B
	DCX H
	MOV M,C
	CALL X4830H
	SHLD X5C6EH
	LXI D,X5D22H
	CALL AP0102
	ORA L
	ADI 0FFH
	SBB A
	LXI B,TXTND
	LXI D,X5C6EH
	PUSH PSW
	CALL AP0098
	ORA L
	ADI 0FFH
	SBB A
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X4906H
	LXI B,X5C6EH
	LXI D,X5D22H
	CALL AP0098
	JNC X48F5H
	LHLD TXTND
	MOV B,H
	MOV C,L
	LHLD X5C6EH
	XCHG
	LXI H,X48F2H
	PUSH H
	LHLD WRBRAN
	PCHL
;
X48F2H:	JMP X4906H
X48F5H:	LHLD X5C6EH
	MOV B,H
	MOV C,L
	LHLD X5D22H
	XCHG
	LXI H,X4906H
	PUSH H
	LHLD WRBRAN
	PCHL
;
X4906H:	RET
;==================
X4907H:	LXI B,WROPND
	CALL WROP
	RET
;===============
STRST:	LHLD X5D20H
	SHLD X5C80H
	CALL LPMOVE
	RET
;================
NWFLSH:	LHLD X5D22H
	SHLD X5D20H
	CALL SETLBP
	CALL X4907H
	LHLD X5C6EH
	SHLD TXTND
	CALL STRST
	RET
;==================
X492EH:	LXI H,X5D64H
	SHLD X5C6EH
	MOV A,M
	STA X5E29H
X4938H:	CALL GETCMD
	LHLD X5C6EH
	MOV M,A
	LXI H,X5DB9H
	CMP M
	JZ X4972H
	LHLD X5C6EH
	MOV A,M
	CPI 01H
	JNZ X4956H
	CALL GETCMD
	LHLD X5C6EH
	MOV M,A
X4956H:	LXI B,X5D64H
	LXI D,X5C6EH
	CALL AP0100
	XCHG
	MVI A,1FH
	CALL AP0096
	JNC X496FH
	LHLD X5C6EH
	INX H
	SHLD X5C6EH
X496FH:	JMP X4938H
X4972H:	LXI B,X5D64H
	LXI D,X5C6EH
	CALL AP0100
	ORA L
	SUI 01H
	SBB A
	STA X5DC2H
	RAR
	JNC X498EH
	LHLD X5C6EH
	LDA X5E29H
	MOV M,A
	RET
X498EH:	LXI B,X5D64H
	LXI D,X5C6EH
	CALL AP0100
	XCHG
	LXI H,X5DB8H
	MOV M,E
	RET
;===================
X499DH:	LXI B,TXTBUF
	LXI D,X5D22H
	CALL AP0100
	RET
;==================
X49A7H:	LXI B,TXTND
	LXI D,BFPNT
	CALL AP0098
	RET
;==================
OPUCMS:	LDA E3UF
	CPI 0AH
	JNC X49BEH
	LXI H,E3UF
	MVI M,0AH
X49BEH:	CALL X499DH
	PUSH H
	CALL X49A7H
	POP B
	DAD B
	MOV B,H
	MOV C,L
	LXI D,FREEMS
	CALL LDUCMS
	CALL X3DFEH
	MOV B,H
	MOV C,L
	LXI D,UCMS
	CALL LDUCMS
	LXI B,BFPNT
	LXI D,MSIZ1
	CALL AP0098
	MOV B,H
	MOV C,L
	LXI D,CRMS
	CALL LDUCMS
	LXI B,TXTMS
	CALL WRSTR
	RET
;================
X49F2H:	LXI H,X5E2AH
	MOV M,C
	LDA X5DC2H
	RAR
	JNC X4A00H
	JMP SYNERR
X4A00H:	CALL X3FF2H
	LHLD X5E2AH
	XCHG
	LXI B,X5D64H
	CALL AOPEN1
	LXI B,X5D64H
	CALL ISERCK
	RET
;=================
OPNOFL:	LXI H,X5D62H
	MVI M,0FFH
	LXI B,NOFIL
	CALL WRSTR
	RET
;================
X4A20H:	CALL X492EH
	LDA X5DC2H
	RAR
	JNC X4A2BH
	RET
X4A2BH:	LXI H,X5F36H
	MVI M,00H
	RET
;================
X4A31H:	LHLD X5DC4H
	MVI H,00H
	LXI B,X5CCEH
	DAD H
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5E2BH
	LXI H,X5D61H
	MVI M,01H
X4A47H:	MVI A,00H
	LXI H,X5D61H
	CMP M
	JNC X4A79H
	LHLD X5E2BH
	MOV A,M
	CPI 01H
	JNZ X4A63H
	LHLD X5E2BH
	DCX H
	SHLD X5E2BH
	JMP X4A6FH
X4A63H:	LHLD X5E2BH
	MOV C,M
	CALL X573AH
	LXI H,X5D61H
	ADD M
	MOV M,A
X4A6FH:	LHLD X5E2BH
	DCX H
	SHLD X5E2BH
	JMP X4A47H
X4A79H:	LHLD X5E2BH
	RET
;=================
X4A7DH:	LXI H,X5E2DH
	MOV M,C
	LHLD X5C84H
	LDA X5E2DH
	MOV M,A
	LHLD X5C84H
	INX H
	SHLD X5C84H
	RET
;================
X4A90H:	LXI D,BAKMS
	LXI B,X5DA1H
	CALL X57C9H
	LXI H,X5D84H
	SHLD BB2PNT
	CALL X57A1H
	STA X5D86H
	RET
;================
WROP2:	LXI H,X5E31H
	MOV M,D
	DCX H
	MOV M,E
	DCX H
	MOV M,B
	DCX H
	MOV M,C
	MVI C,0FFH
	CALL X4A7DH
	LHLD X5DB9H
	MOV C,L
	CALL X4A7DH
	LHLD X5DB9H
	MOV C,L
	CALL X4A7DH
X4AC3H:	LXI B,X5E30H
	LXI D,X5E2EH
	CALL AP0098
	JNC X4AE7H
	LHLD X5E30H
	DCX H
	SHLD X5E30H
	PUSH H
	LHLD X5C84H
	POP B
	LDAX B
	MOV M,A
	LHLD X5C84H
	INX H
	SHLD X5C84H
	JMP X4AC3H
X4AE7H:	LHLD X5C84H
	SHLD X5C72H
	CALL STKCK
	CALL X40ABH
	RET
;=================
X4AF4H:	CALL X57A1H
	SUI 39H
	SBB A
	RET
;==================-
STRTUP:	LXI H,X5F36H
	MVI M,0FFH
	LXI H,X5F34H
	MVI M,00H
	CALL MEMSIZ
	XCHG
	MVI A,0AH
	CALL AP0096
	SHLD MSIZ2
	SHLD MSIZ1
	LXI B,X5DA1H
	PUSH B
	LHLD MSIZ1
	XCHG
	LXI B,X5DAAH
	CALL X55CCH
	LXI H,CIBUF
	SHLD ISERNO
	MOV B,H
	MOV C,L
	CALL AWHOCN
	CALL X4AF4H
	STA X5D60H
	LXI D,0032H
	LXI B,CIBUF
	CALL ACIRD
	XRA A
	STA X5D61H
	MVI A,'0'		;EDIT MAC MUST BE ON DRIVE 0
	STA X5D66H
	LXI B,X5951H
	CALL X59D4H
	LHLD ISERNO
	SHLD X5C68H
	MOV A,M
	SUI 2CH
	SBB A
	STA X5D91H
	RAR
	JNC X4B7EH
	MVI E,01H
	LXI B,X5D64H
	CALL AOPEN1
	LDA STATUS
	CPI 00H
	JNZ X4B7EH
	CALL EDMCLD
X4B7EH:	CALL X4039H
	LXI B,SIGNON
	CALL WRSTR
	CALL X5962H
	RAR
	JC X4B91H
	CALL X599FH
X4B91H:	CALL X5A43H
	LDA X5D60H
	STA E10UF
	CALL X5962H
	RAR
	JNC X4BA7H
	CALL OPNOFL
	JMP X4C0CH
X4BA7H:	CALL X4A90H
	LHLD ISERNO
	MOV B,H
	MOV C,L
	LHLD ISERNO
	XCHG
	CALL ARENAM
	LDA STATUS
	SUI 0DH
	SUI 01H
	SBB A
	STA X5DC3H
	RAR
	JC X4BCBH
	LHLD ISERNO
	SHLD BB1PNT
X4BCBH:	LHLD ISERNO
	SHLD BB3PNT
	LXI B,X5951H
	CALL X59D4H
	CALL X5A43H
	LXI B,TOMS
	CALL X59F3H
	RAR
	JNC X4C0CH
	CALL X5A43H
	LDA X5DC3H
	RAR
	JNC X4BF6H
	LHLD X5C68H
	MOV B,H
	MOV C,L
	CALL ISERCK
X4BF6H:	LHLD ISERNO
	SHLD BB3PNT
	CALL X4A90H
	CALL X4AF4H
	RAR
	JC X4C0CH
	LHLD ISERNO
	SHLD BB2PNT
X4C0CH:	LDA X5DC3H
	RAR
	JNC X4C19H
	LXI B,NWFILM
	CALL WRSTR
X4C19H:	RET
;==================
X4C1AH:	CALL X5751H
	LXI B,STRTUP
	DAD B
	RET
;================
X4C22H:	LDA X5DC4H
	CPI 00H
	JNZ X4C2DH
	JMP ERRBK
X4C2DH:	LHLD X5DC4H
	MVI H,00H
	LXI B,X5CFAH
	DAD H
	DAD B
	MOV C,M
	INX H
	MOV B,M
	DCX B
	DCX H
	MOV M,C
	INX H
	MOV M,B
	LXI D,0000H
	CALL AP0097
	JNC X4C67H
	LHLD X5DC4H
	MVI H,00H
	LXI B,X5CCEH
	DAD H
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5D4EH
	CALL X4C1AH
	MOV B,H
	MOV C,L
	LXI D,X5DC5H
	CALL X5668H
	JMP X4CA1H
X4C67H:	LHLD X5DC4H
	MVI H,00H
	LXI B,X5DDDH
	DAD H
	DAD B
	MVI A,00H
	CALL AP0103
	ORA L
	JNZ X4C8CH
	CALL X4A31H
	PUSH H
	LHLD X5DC4H
	MVI H,00H
	LXI B,X5DDDH
	DAD H
	DAD B
	POP B
	MOV M,C
	INX H
	MOV M,B
X4C8CH:	LHLD X5DC4H
	MVI H,00H
	LXI B,X5DDDH
	DAD H
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5D4EH
	LXI H,X5DC4H
	DCR M
X4CA1H:	RET
;================
X4CA2H:	LHLD X5DC4H
	MVI H,00H
	LXI B,X5CFAH
	DAD H
	DAD B
	MVI A,01H
	MOV M,A
	INX H
	MVI M,00H
	CALL X4C22H
	JMP ERRLP
	RET
;=================
X4CB9H:	MVI A,7FH
	LXI H,CITMP
	CMP M
	JNC X4CC8H
	CALL X45ECH
	JMP ERRLP
X4CC8H:	LHLD CITMP
	MOV C,L
	CALL X573AH
	STA X5D61H
	RAR
	JNC X4D54H
	LDA X5D61H
	CPI 01H
	JNZ X4D3BH
	LXI B,X5DC4H
	CALL STKFLT
	CALL X4C1AH
	XCHG
	LXI B,X5DC5H
	CALL X5668H
	LHLD X5DC4H
	MVI H,00H
	LXI B,X5CCEH
	DAD H
	DAD B
	PUSH H
	LHLD X5D4EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	LHLD X5DC4H
	MVI H,00H
	LXI B,X5DDDH
	DAD H
	DAD B
	MVI A,00H
	MOV M,A
	INX H
	MVI M,00H
	LHLD X5DC4H
	MVI H,00H
	LXI B,X5CFAH
	DAD H
	DAD B
	PUSH H
	LHLD X5D54H
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	MVI A,00H
	CALL AP0096
	ORA L
	SUI 01H
	SBB A
	LXI H,X5D5FH
	ORA M
	RAR
	JNC X4D38H
	CALL X4CA2H
X4D38H:	JMP ERRLP
X4D3BH:	LHLD X5DC4H
	MVI H,00H
	LXI B,X5DDDH
	DAD H
	DAD B
	PUSH H
	LHLD X5D4EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	CALL X4C22H
	JMP ERRLP
X4D54H:	LHLD CITMP
	MOV C,L
	CALL X3D04H
	RAR
	JNC X4D62H
	CALL MACRX
X4D62H:	JMP SYNERR
	RET
;===================
FIND:	CALL X492EH
	LHLD BFPNT
	SHLD X5C6CH
	LDA X5D5EH
	RAR
	JNC X4D95H
	CALL LDVMRK
	XCHG
	LXI H,X5D22H
	CALL AP0104
	JNC X4D8FH
	CALL LDVMRK
	SHLD X5C80H
	CALL SETV
	CALL LPMOVE
X4D8FH:	CALL LDVMRK
	SHLD X5C6CH
X4D95H:	LXI H,X5D5CH
	MVI M,00H
	LXI D,TXTND
	LXI B,X5C6CH
	CALL AP0098
	JNC X4DCDH
	LHLD TXTND
	MOV B,H
	MOV C,L
	LHLD X5C6CH
	XCHG
	CALL X56C2H
	STA X5D5CH
	RAR
	JNC X4DCDH
	LHLD X5D52H
	SHLD X5C80H
	XCHG
	LDA X5DB8H
	CALL AP0096
	SHLD X5D20H
	CALL LPMOVE
	RET
X4DCDH:	MVI A,00H
	LXI H,X5DC4H
	CMP M
	JNC X4DD9H
	CALL X4CA2H
X4DD9H:	LXI B,NOTFND
	CALL WRSTR
	LHLD X5DB8H
	MVI H,00H
	LXI B,X5D64H
	DAD B
	XCHG
	CALL X3E08H
	MVI C,'"'
	CALL CO
	CALL CRLF
	JMP ERRBK
	RET
;==================
X4DF8H:	LXI B,TXTBUF
	LXI D,X5D22H
	CALL AP0100
	XCHG
	CALL AWRIT4
	LHLD BB2PNT
	MOV B,H
	MOV C,L
	CALL ISERCK
	LXI H,TXTBUF
	SHLD X5D22H
	RET
;==================
X4E14H:	LXI H,X5E35H
	MOV M,D
	DCX H
	MOV M,E
	DCX H
	MOV M,B
	DCX H
	MOV M,C
	LXI B,X5E32H
	LXI D,X5E34H
	CALL AP0098
	XCHG
	LHLD X5E32H
	MOV B,H
	MOV C,L
	CALL AWRIT1
	RET
;====================
X4E31H:	MVI C,0DH
	CALL CNDCO
	MVI C,0AH
	CALL CNDCO
	RET
;==================
DTAIL:	LHLD X5C68H
	SHLD ISERNO
X4E42H:	CALL X5962H
	RAR
	JC X4E56H
	LHLD ISERNO
	MOV C,M
	CALL CNDCO
	CALL X599FH
	JMP X4E42H
X4E56H:	CALL X4E31H
	RET
;===================
X4E5AH:	LDA X5DBCH
	RAR
	JNC X4E71H
	CALL CONSTS
	LXI H,CITMP
	MVI M,'G'
	MVI C,'G'
	CALL CONSOP
	JMP X4E7BH
X4E71H:	CALL CI
	STA CITMP
	MOV C,A
	CALL CONSOP
X4E7BH:	CALL CRLF
	LDA CITMP
	CPI 03H;CTRL C
	JNZ X4E89H
	JMP ERRBK
X4E89H:	LDA CITMP
	ANI 5FH
	STA CITMP
	CPI 'G'
	JNZ X4E9EH
	LXI H,X5DBCH
	MVI M,0FFH
	MVI A,0FFH
	RET
X4E9EH:	LDA CITMP
	SUI 'Y'
	SUI 01H
	SBB A
	RET
;===================
X4EA7H:	LDA E10UF
	RRC
	RAR
	JNC X4EB2H
	MVI A,0FFH
	RET
X4EB2H:	CALL X4E5AH
	RET
;======================
QUITR:	LXI B,QUITMS
	CALL WRSTR
	CALL X4EA7H
	RAR
	JNC X4ED1H
	CALL ACLOS4
	LHLD BB2PNT
	MOV B,H
	MOV C,L
	CALL ADELET
	CALL AEXIT
X4ED1H:	JMP ERRBK
	RET
;======================
EXSUB:	CALL X3FF2H
	CALL SETLPZ
	LDA X5D62H
	RAR
	JNC X4EE8H
	CALL OPNOFL
	CALL QUITR
X4EE8H:	LXI B,X5D22H
	LXI D,MSIZ1
	CALL AP0098
	XCHG
	LHLD X5D22H
	MOV B,H
	MOV C,L
	CALL AREAD3
	LHLD ACTUAL
	XCHG
	LHLD X5D22H
	DAD D
	SHLD X5D22H
	LXI D,TXTBUF
	CALL AP0095
	JNC X4F14H
	CALL X4DF8H
	JMP X4EE8H
X4F14H:	CALL ACLOS3
	CALL ACLOS4
	LXI B,BB3PNT
	LXI D,BB1PNT
	CALL AP0098
	ORA L
	JNZ X4F38H
	LXI B,X5DA1H
	CALL ADELET
	LHLD BB3PNT
	MOV B,H
	MOV C,L
	LXI D,X5DA1H
	CALL ARENAM
X4F38H:	LXI B,X5D84H
	LXI D,BB2PNT
	CALL AP0100
	ORA L
	JNZ X4F5FH
	LHLD BB3PNT
	MOV B,H
	MOV C,L
	CALL ADELET
	LHLD BB3PNT
	XCHG
	LXI B,X5D84H
	CALL ARENAM
	LHLD BB3PNT
	MOV B,H
	MOV C,L
	CALL ISERCK
X4F5FH:	LHLD BB3PNT
	SHLD BB1PNT
	SHLD ISERNO
	CALL X4A90H
	LXI B,EXITMS
	CALL WRSTR
	LXI H,X5D5FH
	MVI M,00H
	CALL DTAIL
	RET
;======================
X4F7AH:	LDA X5D5EH
	RAR
	JNC X4FA7H
	CALL LDVMRK
	LXI D,X5D22H
	CALL AP0102
	SBB A
	CMA
	STA X5D5FH
	CMA
	PUSH PSW
	CALL LDVMRK
	XCHG
	LXI H,TXTND
	CALL AP0104
	SBB A
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X4FA6H
	CALL SETV
X4FA6H:	RET
;===================
X4FA7H:	LDA X5D58H
	CPI '='
	JNZ X4FD1H
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5D24H
	DAD H
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5D54H
	LHLD X5DDBH
	MVI H,00H
	LXI B,X5CB8H
	DAD B
	LDA X5D5FH
	XRA M
	STA X5D5FH
	RET
X4FD1H:	LDA X5D56H
	RAR
	JNC X4FE7H
	CALL SETLBP
	LXI H,0FFFFH
	SHLD X5D54H
	LXI H,X5D5FH
	MVI M,00H
	RET
X4FE7H:	CALL LDSCLN
	SHLD X5D54H
	LXI D,7FFFH
	CALL AP0095
	SBB A
	STA X5D61H
	RAR
	JNC X5004H
	LHLD X5D54H
	CALL AP0041
	SHLD X5D54H
X5004H:	LDA X5D61H
	LXI H,X5D5FH
	XRA M
	MOV M,A
	RET
;===================
COMAND:	CALL GETCMD
	STA CITMP
	LDA X5DC1H
	RAR
	JNC X5021H
	CALL GETCMD
	STA CITMP
	RET
X5021H:	LDA X5D5AH
	CPI 00H
	JNZ X5031H
	LDA CITMP
	ANI 5FH
	STA CITMP
X5031H:	LDA CITMP
	RET
;==================
X5035H:	LXI H,X5E36H
	MOV M,C
	LHLD X5E36H
	MOV C,L
	CALL X575EH
	CMA
	RET
;=================
X5042H:	LXI H,X5E37H
	MOV M,C
	LDA X5E37H
	LXI H,X5D5FH
	XRA M
	RAR
	JNC X5052H
	RET
X5052H:	CALL X4C22H
	RET
;===================
ROLDN:	LXI H,X5E39H
	MOV M,B
	DCX H
	MOV M,C
	LXI B,000EH
	LHLD X5E38H
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5C6EH
	LHLD X5E38H
	PUSH H
	LXI D,000DH
	LHLD X5E38H
	DAD D
	PUSH H
	LHLD X5E38H
	INX H
	INX H
	XCHG
	POP B
	CALL X55CCH
	LHLD X5E38H
	PUSH H
	LHLD X5C6EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	RET
;===============
ROLUP:	LXI H,X5E3BH
	MOV M,B
	DCX H
	MOV M,C
	LHLD X5E3AH
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5C6EH
	LHLD X5E3AH
	INX H
	INX H
	PUSH H
	LXI D,000FH
	LHLD X5E3AH
	DAD D
	MOV B,H
	MOV C,L
	LHLD X5E3AH
	XCHG
	CALL X55CCH
	LXI B,000EH
	LHLD X5E3AH
	DAD B
	PUSH H
	LHLD X5C6EH
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	RET
;==================
X50C4H:	LXI H,X5E3DH
	MOV M,B
	DCX H
	MOV M,C
	LHLD X5E3CH
	INX H
	INX H
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD X5C72H
	CALL LDCK
	MOV L,A
	MVI H,00H
	DAD H
	XCHG
	LHLD X5E3CH
	DAD D
	PUSH H
	LHLD X5E3CH
	INX H
	INX H
	XTHL
	MOV C,M
	INX H
	MOV B,M
	POP H
	MOV M,C
	INX H
	MOV M,B
	CALL LDCK
	MOV L,A
	MVI H,00H
	DAD H
	XCHG
	LHLD X5E3CH
	DAD D
	PUSH H
	LHLD X5C72H
	XCHG
	POP H
	MOV M,E
	INX H
	MOV M,D
	RET
;=====================
X5106H:	LDA X5D5FH
	RAR
	JNC X5128H
	CALL X499DH
	XCHG
	LHLD X5D54H
	MOV B,H
	MOV C,L
	CALL X583EH
	SHLD X5D54H
	LXI D,X5D22H
	CALL AP0102
	SHLD X5C80H
	JMP X513FH
X5128H:	CALL X49A7H
	XCHG
	LHLD X5D54H
	MOV B,H
	MOV C,L
	CALL X583EH
	SHLD X5D54H
	XCHG
	LHLD TXTND
	DAD D
	SHLD X5C80H
X513FH:	RET
;===================
X5140H:	CALL GETCMD
	STA CITMP
	LXI H,X5DB9H
	CMP M
	JNZ X5150H
	MVI A,00H
	RET
X5150H:	LDA X5DC1H
	RAR
	JNC X515DH
	CALL GETCMD
	STA CITMP
X515DH:	MVI A,0FFH
	RET
;=================
X5160H:	LXI B,BFPNT
	LXI D,TXTND
	CALL AP0098
	ORA L
	JNZ X5170H
	MVI A,00H
	RET
X5170H:	LHLD TXTND
	MOV A,M
	STA X5E3EH
	LXI H,X5E3FH
	MVI M,00H
X517CH:	CALL X5140H
	RAR
	JNC X51C5H
	LDA CITMP
	STA X5D61H
	CALL X5140H
	RAR
	JC X51A3H
	LXI H,X5D61H
	LDA X5E3EH
	CMP M
	JNZ X519FH
	LXI H,X5E3FH
	MVI M,0FFH
X519FH:	LDA X5E3FH
	RET
X51A3H:	LDA X5E3EH
	LXI H,X5D61H
	SUB M
	SBB A
	CMA
	PUSH PSW
	LDA CITMP
	LXI H,X5E3EH
	SUB M
	SBB A
	CMA
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X51C2H
	LXI H,X5E3FH
	MVI M,0FFH
X51C2H:	JMP X517CH
X51C5H:	LDA X5E3FH
	RET
;==================
X51C9H:	LDA X5D5FH
	RAR
	JNC X51D9H
	LHLD X5C80H
	SHLD X5D22H
	JMP X51DFH
X51D9H:	LHLD X5C80H
	SHLD TXTND
X51DFH:	RET
;======================-
;COMMAND BRANCH
;=======================
X51E0H:	CALL COMAND
	SUI 41H
	STA X5D61H
	MOV C,A
	MVI A,19H
	CMP C
	JNC X51F2H
	JMP SYNERR
X51F2H:	LHLD X5D61H
	MOV C,L
	MVI B,00H
	LXI H,X5597H
	DAD B
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG
	PCHL
;
UA:	LDA X5D5FH
	RAR
	JNC X521AH
	LXI B,SCOLON+2
	LXI D,SCOLON+4
	CALL AP0098
	XCHG
	DCX H
	MOV M,E
	INX H
	MOV M,D
	JMP X5225H
X521AH:	LHLD SCOLON+2
	XCHG
	LHLD SCOLON+4
	DAD D
	SHLD SCOLON+4
X5225H:	LXI B,SCOLON
	CALL ROLUP
	JMP X55CBH
;
UB:	CALL STRST
	JMP X55CBH
;
UC:	LDA X5D5FH
	RAR
	JNC X5244H
	LXI H,0FFFFH
	SHLD E14UF
	JMP X5275H
X5244H:	CALL SETLPZ
	LHLD X5D54H
	XCHG
	LXI B,00F0H
	CALL X5835H
	LXI B,X5D22H
	LXI D,MSIZ1
	PUSH H
	CALL AP0098
	XCHG
	POP B
	CALL X583EH
	SHLD E14UF
	LXI B,E14UF
	LXI D,MSIZ1
	CALL AP0098
	SHLD BFPNT
	SHLD TXTND
	CALL OPUCMS
X5275H:	JMP X55CBH
;
UD:	LXI H,X5E40H
	MVI M,00H
	LHLD MSIZ1
	SHLD X5C72H
X5283H:	LHLD X5C72H
	LXI D,X5C72H
	CALL AP0012
	DCX H
	XCHG
	DCX H
	MOV M,E
	INX H
	MOV M,D
	LXI H,MSIZ2
	CALL AP0104
	JNC X52C2H
	MVI C,20H
	CALL CNDCO
	LHLD X5C72H
	MOV C,M
	CALL CNDCO
	LDA X5E40H
	INR A
	STA X5E40H
	ANI 0FH
	CPI 00H
	JNZ X52B8H
	CALL X4E31H
X52B8H:	LHLD X5C72H
	INX H
	SHLD X5C72H
	JMP X5283H
X52C2H:	CALL X4E31H
	JMP X55CBH
;
UE:	CALL LDSCLN
	LXI D,SCOLON+2
	CALL AP0102
	ORA L
	SUI 01H
	SBB A
	MOV C,A
	CALL X5042H
	JMP X55CBH
;
UF:	CALL COMAND
	PUSH PSW
	MVI A,0FH
	LXI D,X5D54H
	CALL AP0025
	LXI B,X5D91H
	DAD B
	POP B
	MOV C,B
	MOV M,C
	JMP X55CBH
;
UG:	CALL X4A20H
	MVI C,01H
	CALL X49F2H
	CALL EDMCLD
	JMP ERRST
	JMP X55CBH
;
UH:	CALL LDCK
	MOV C,A
	MVI B,00H
	LXI H,SCOLON
	DAD B
	DAD B
	LDA X5D5FH
	INR A
	MOV E,A
	MVI D,00H
	DAD D
	SHLD X5C72H
	LHLD X5C72H
	MVI M,00H
	JMP X55CBH
UI:	LHLD TXTND
	SHLD X5C72H
	PUSH H
	CALL LDCK
	MOV C,A
	MVI B,00H
	LXI H,SCOLON
	DAD B
	DAD B
	XTHL
	MOV C,M
	INX H
	MOV B,M
	POP H
	MOV M,C
	INX H
	MOV M,B
	JMP X55CBH
;
UJ:	LDA X5D5FH
	RAR
	JNC X5349H
	CALL DELCHR
	RET
X5349H:	LHLD E8UF
	MOV C,L
	CALL CO
	LHLD E9UF
	MOV C,L
	CALL CO
	LXI H,X5D59H
	MVI M,00H
	JMP X55CBH
;
UK:	CALL COMAND
	STA CITMP
	CALL X4056H
	LXI D,MSIZ2
	LXI B,X5C76H
	CALL AP0098
	JNC X5377H
	JMP SYNERR
X5377H:	LHLD X5C76H
	LXI D,MSIZ1
	CALL AP0012
	SHLD X5C6EH
	LHLD MSIZ1
	PUSH H
	LHLD X5C76H
	DCX H
	MOV B,H
	MOV C,L
	LHLD X5C6EH
	XCHG
	CALL X55CCH
	LHLD X5C6EH
	SHLD MSIZ1
	MVI A,00H
	LXI H,X5DDBH
	CMP M
	JNC X53A6H
	JMP ERRST
X53A6H:	JMP X55CBH
;
UL:	CALL LDSCLN
	LXI D,SCOLON+2
	CALL AP0102
	SBB A
	MOV C,A
	CALL X5042H
	JMP X55CBH
;
UM:	LDA X5D5FH
	RAR
	JNC X53E2H
	LHLD SCOLON+4
	XCHG
	LHLD SCOLON+2
	CALL AP0029
	SHLD X5C80H
	LHLD SCOLON+4
	XCHG
	CALL AP0030
	XCHG
	SHLD SCOLON+4
	LHLD X5C80H
	SHLD SCOLON+2
	JMP X53F5H
X53E2H:	LHLD SCOLON+4
	XCHG
	LHLD SCOLON+2
	CALL AP0034
	SHLD SCOLON+4
	LXI B,SCOLON
	CALL ROLUP
X53F5H:	JMP X55CBH
;
UN:	LDA X5D5FH
	RAR
	JNC X5408H
	LHLD X5D54H
	CALL AP0041
	SHLD X5D54H
X5408H:	LHLD X5D54H
	SHLD SCOLON+2
	JMP X55CBH
;
UO:	CALL X3FE2H
	LHLD X5D22H
	SHLD X5C72H
	CALL LDSCLN
	PUSH H
	LHLD X5C72H
	POP B
	MOV M,C
	INX H
	MOV M,B
	LHLD X5D22H
	INX H
	INX H
	SHLD X5D22H
	JMP X55CBH
;
UP:	CALL X4A20H
	MVI C,02H
	CALL X49F2H
	LDA X5D5FH
	RAR
	JNC X5448H
	LXI H,BRKMS
	SHLD X5C6EH
	JMP X544EH
X5448H:	LXI H,X5D91H
	SHLD X5C6EH
X544EH:	LXI D,0010H
	LHLD X5C6EH
	DAD D
	XCHG
	LHLD X5C6EH
	MOV B,H
	MOV C,L
	CALL X4E14H
	LHLD MSIZ1
	MOV B,H
	MOV C,L
	LHLD MSIZ2
	XCHG
	CALL X4E14H
	CALL ACLOS1
	JMP X55CBH
;
UQ:	LXI H,TXTBUF
	SHLD X5D22H
	SHLD TXTND
	JMP X55CBH
;
UR:	CALL X5160H
	MOV C,A
	CALL X5042H
	JMP X55CBH
;
US:	LDA X5D5FH
	RAR
	JNC X5496H
	LXI B,SCOLON
	CALL ROLUP
	JMP X549CH
X5496H:	LXI B,SCOLON
	CALL ROLDN
X549CH:	JMP X55CBH
;
UT:	LXI B,0713H
	LXI D,X5D54H
	CALL AP0100
	ORA L
	JNZ X54BBH
	CALL COMAND
	STA X5DB9H
	LXI B,ESCMS
	CALL WRSTR
	JMP ERRBK
X54BBH:	LXI B,BFPNT
	LXI D,TXTND
	CALL AP0098
	ORA L
	SUI 01H
	SBB A
	LXI H,X5D5FH
	ORA M
	RAR
	JNC X54E0H
	LHLD X5DC4H
	MVI H,00H
	LXI B,X5CFAH
	DAD H
	DAD B
	MVI A,01H
	MOV M,A
	INX H
	MVI M,00H
X54E0H:	JMP X55CBH
;
UU:	CALL DTAIL
	JMP X55CBH
;
UV:	LDA X5D5FH
	RAR
	JNC X54F9H
	LXI B,VSTACK
	CALL ROLUP
	JMP X54FFH
X54F9H:	LXI B,VSTACK
	CALL ROLDN
X54FFH:	JMP X55CBH
;
UW:	LDA X5D5FH
	RAR
	JNC X5521H
	LHLD X5D54H
	DCX H
	DCX H
	MVI A,0EH
	CALL AP0094
	JC X551EH
	LHLD X5D54H
	XCHG
	LXI H,E3UF
	MOV M,E
X551EH:	JMP X553EH
X5521H:	CALL X3FE2H
	CALL LDSCLN
	MOV B,H
	MOV C,L
	LHLD X5D22H
	XCHG
	CALL LDUCMS
	LDA X5D5BH
	LXI D,X5D22H
	CALL AP0014
	XCHG
	DCX H
	MOV M,E
	INX H
	MOV M,D
X553EH:	JMP X55CBH
;
UX:	LDA X5D5FH
	RAR
	JNC X5551H
	LXI B,VSTACK
	CALL X50C4H
	JMP X5557H
X5551H:	LXI B,SCOLON
	CALL X50C4H
X5557H:	JMP X55CBH
;
UY:	LHLD X5D5CH
	MOV C,L
	CALL X5042H
	JMP X55CBH
;
UZ:	LDA X5D5FH
	RAR
	JNC X5581H
	CALL X499DH
	PUSH H
	CALL LDCK
	MOV C,A
	MVI B,00H
	LXI H,SCOLON
	DAD B
	DAD B
	POP B
	MOV M,C
	INX H
	MOV M,B
	JMP X5594H
X5581H:	CALL X49A7H
	PUSH H
	CALL LDCK
	MOV C,A
	MVI B,00H
	LXI H,SCOLON
	DAD B
	DAD B
	POP B
	MOV M,C
	INX H
	MOV M,B
X5594H:	JMP X55CBH
;
X5597H:	DW UA,UB,UC,UD
	DW UE,UF,UG,UH
	DW UI,UJ,UK,UL
	DW UM,UN,UO,UP
	DW UQ,UR,US,UT
	DW UU,UV,UW,UX
	DW UY,UZ
;
X55CBH:	RET
;======================================
X55CCH:	POP H
	XTHL
	MOV A,C
	SUB L
	MOV C,A
	MOV A,B
	SBB H
	MOV B,A
	MOV A,E
	SUB L
	MOV A,D
	JZ X55DEH
	SBB H
	JMP X55E0H
X55DEH:	SBB H
	RZ
X55E0H:	PUSH H
	LXI H,X5636H
	JC X55F0H
	POP H
	DAD B
	PUSH H
	XCHG
	DAD B
	XCHG
	LXI H,X565FH
X55F0H:	INX B
	MOV A,B
	RRC
	RRC
	RRC
	MOV B,A
	MVI A,07H
	ANA C
	PUSH PSW
	XRA C
	RRC
	RRC
	RRC
	XRA B
	ANI 1FH
	XRA B
	MOV C,A
	MVI A,1FH
	ANA B
	MOV B,A
	INR B
	INR C
	POP PSW
	RLC
	RLC
	PUSH B
	CMA
	MOV C,A
	MVI B,0FFH
	INX B
	DAD B
	POP B
	XTHL
	RET
;==================
X5616H:	MOV A,M
	STAX D
	INX H
	INX D
	MOV A,M
	STAX D
	INX H
	INX D
	MOV A,M
	STAX D
	INX H
	INX D
	MOV A,M
	STAX D
	INX H
	INX D
	MOV A,M
	STAX D
	INX H
	INX D
	MOV A,M
	STAX D
	INX H
	INX D
	MOV A,M
	STAX D
	INX H
	INX D
	MOV A,M
	STAX D
	INX H
	INX D
X5636H:	DCR C
	JNZ X5616H
	DCR B
	JNZ X5616H
	RET
;======================
X563FH:	MOV A,M
	STAX D
	DCX H
	DCX D
	MOV A,M
	STAX D
	DCX H
	DCX D
	MOV A,M
	STAX D
	DCX H
	DCX D
	MOV A,M
	STAX D
	DCX H
	DCX D
	MOV A,M
	STAX D
	DCX H
	DCX D
	MOV A,M
	STAX D
	DCX H
	DCX D
	MOV A,M
	STAX D
	DCX H
	DCX D
	MOV A,M
	STAX D
	DCX H
	DCX D
X565FH:	DCR C
	JNZ X563FH
	DCR B
	JNZ X563FH
	RET
;==================
X5668H:	MOV H,B
	MOV L,C
	LXI B,0104H
	JMP X5636H
;=================
X5678H:	CALL X5697H
X567BH:	CALL X568AH
	DCR E
	JNZ X567BH
	DCR D
	JNZ X567BH
	INX H
	RET
;=================
X5688H:	CMP M
	RZ
X568AH:	DCX H
	DCR C
	JNZ X5688H
	DCR B
	JNZ X5688H
	INX H
	INX H
	POP PSW
	RET
;=================
X5697H:	LDA E5UF
	LHLD X5D54H
	XCHG
	INR B
	INR C
	INR D
	INR E
	RET
;=================
X56A3H:	CALL X5697H
	JMP X56ACH
X56A9H:	CALL X56B8H
X56ACH:	DCR E
	JNZ X56A9H
	DCR D
	JNZ X56A9H
	RET
;===============
X56B5H:	CMP M
	INX H
	RZ
X56B8H:	DCR C
	JNZ X56B5H
	DCR B
	JNZ X56B5H
	POP PSW
	RET
;=================
X56C2H:	LHLD X5DB8H
	LDA E4UF
	MOV H,A
	MOV A,E
	SUB C
	MOV E,A
	MOV A,D
	SBB B
	MOV D,A
	PUSH B
	XTHL
	POP B
	INR D
	INR E
X56D4H:	LDA X5D64H
	CALL X5701H
	PUSH B
	PUSH D
	PUSH H
	LXI D,X5D64H
X56E0H:	DCR C
	INX D
	JZ X56F5H
	LDAX D
	CMP M
	INX H
	JZ X56E0H
	CMP B
	JZ X56E0H
	POP H
	POP D
	POP B
	JMP X56D4H
X56F5H:	POP PSW
	POP PSW
	POP PSW
	SHLD X5D52H
	MVI A,0FFH
	RET
;================
X56FEH:	CMP M
	INX H
	RZ
X5701H:	DCR E
	JNZ X56FEH
	DCR D
	JNZ X56FEH
	POP PSW
	SUB A
	RET
;=================
X570CH:	MVI B,00H
	MOV A,C
	CPI 2BH
	JZ X5737H
	CPI 2DH
	JC X5736H
	SUI 3CH
	JC X5737H
	DCR A
	JZ X5737H
	SUI 04H
	JC X5736H
	CPI 1AH
	JC X5738H
	SUI 20H
	JC X5736H
	CPI 1AH
	JC X5738H
X5736H:	INR B
X5737H:	INR B
X5738H:	MOV A,B
	RET
;================
X573AH:	MVI A,60H
	ANA C
	RZ
	CPI 20H
	JNZ X5744H
	DCR C
X5744H:	XRA C
	SUI 1AH
	CPI 01H
	RZ
	SUI 04H
	CPI 0FFH
	RZ
	SUB A
	RET
;==================
X5751H:	LDA X5DC4H
	MOV C,A
	ADD A
	ADD C
	ADD A
	ADD A
	ADD A
	MOV L,A
	MVI H,00H
	RET
;==================
X575EH:	MOV A,C
	SUI 2EH
	RZ
	DCR A
	RZ
	SUI 0EH
	RZ
	ADI 02H
	RZ
X576AH:	MVI A,0FFH
	RET
;=================
X576DH:	LHLD X5D4EH
	MVI A,0DH
	CMP M
	JZ X5778H
	ORA M
	RP
X5778H:	LDA X5DB9H
	INX H
	CMP M
	JNZ X576AH
	INX H
	CMP M
	JNZ X576AH
	SUB A
	RET
;===============
X5787H:	MVI A,'0'
	ADD C
	CPI ':'
	RC
	ADI 07H
	RET
;================
X5790H:	LXI D,TXTBUF
	MVI C,0AH
	LXI H,VSTACK
X5798H:	MOV M,E
	INX H
	MOV M,D
	INX H
	DCR C
	JNZ X5798H
	RET
;=================
X57A1H:	LHLD ISERNO
	MOV B,H
	MOV C,L
	CALL X5A4AH
	CALL X5903H
	CPI ':'
	JZ X57B4H
	MVI A,'0'
	RET
X57B4H:	CALL X599FH
	CALL X5903H
	CPI 'F'
	JZ X57C2H
	MVI A,0C8H
	RET
X57C2H:	CALL X599FH
	CALL X5903H
	RET
;=================
X57C9H:	LXI H,X5E87H
	MOV M,D
	DCX H
	MOV M,E
	DCX H
	MOV M,B
	DCX H
	MOV M,C
	LHLD ISERNO
	MOV B,H
	MOV C,L
	CALL X5A4AH
	LHLD X5E84H
	MOV B,H
	MOV C,L
	CALL X58CBH
X57E3H:	CALL X5951H
	PUSH PSW
	CALL X5903H
	SUI '.'
	ADI 0FFH
	SBB A
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X57FCH
	CALL X58E2H
	JMP X57E3H
X57FCH:	MVI C,'.'
	CALL X585AH
	LHLD X5E86H
	MOV B,H
	MOV C,L
	CALL X58A5H
	MVI C,00H
	CALL X585AH
	RET
;==================
X580FH:	LDAX D
	CMP C
	MVI A,00H
	RC
	INX D
	XCHG
	MOV D,A
	MOV A,C
	ANI 0F8H
	RRC
	RRC
	RRC
	MOV E,A
	DAD D
	MOV A,C
	ANI 07H
	MOV E,A
	MOV A,M
	LXI H,X582DH
	DAD D
	ANA M
	RZ
	MVI A,0FFH
	RET
;===================
X582DH:	DB 80H,40H,20H,10H
	DB 08H,04H,02H,01H
;==================
X5835H:	XCHG
	MOV A,C
	SUB L
	MOV A,B
	SBB H
	RC
	MOV H,B
	MOV L,C
	RET
;================
X583EH:	XCHG
	MOV A,C
	SUB L
	MOV A,B
	SBB H
	RNC
	MOV H,B
	MOV L,C
	RET
;===============
X5847H:	POP H
	XTHL
	MOV A,E
	INR L
	INR H
	JMP X5851H
X584FH:	STAX B
	INX B
X5851H:	DCR L
	JNZ X584FH
	DCR H
	JNZ X584FH
	RET
;===============
X585AH:	LXI H,X5E8AH
	MOV M,C
	LHLD X5E88H
	LDA X5E8AH
	MOV M,A
	LHLD X5E88H
	INX H
	SHLD X5E88H
	RET
;===============
X58A5H:	LXI H,X5E8FH
	MOV M,B
	DCX H
	MOV M,C
X58ABH:	LHLD X5E8EH
	MOV A,M
	CPI 00H
	JZ X58C5H
	LHLD X5E8EH
	MOV C,M
	CALL X585AH
	LHLD X5E8EH
	INX H
	SHLD X5E8EH
	JMP X58ABH
X58C5H:	LHLD X5E88H
	MVI M,00H
	RET
;=================
X58CBH:	POP D
	LHLD X5E88H
	PUSH H
	LXI H,X58DBH
	PUSH H
	MOV H,B
	MOV L,C
	SHLD X5E88H
	PUSH D
	RET
;===================
X58DBH:	XCHG
	POP H
	SHLD X5E88H
	XCHG
	RET
;================
X58E2H:	LHLD ISERNO
	MOV C,M
	CALL X585AH
	CALL X599FH
	RET
;===============
X58EDH:	LHLD ISERNO
	MOV A,M
	MOV B,A
	RET
;=================
X58F3H:	CALL X58EDH
	CPI 30H
	JC X5920H
	CPI 3AH
	JNC X5920H
X5900H:	STC
	SBB A
	RET
X5903H:	CALL X58EDH
	CPI 61H
	RC
	CPI 7BH
	RNC
	SUI 20H
	RET
X590FH:	CALL X58F3H
	RC
	CALL X5903H
	CPI 'A'
	JC X5920H
	CPI 'G'
	JC X5900H
X5920H:	SUB A
	RET
X5922H:	CALL X5903H
	CPI 'A'
	JC X5920H
	CPI 5BH;'['
	JC X5900H
	SUB A
	RET
X5931H:	CALL X5922H
	RC
	CALL X58F3H
	RC
	SUB A
	RET
	CALL X5931H
	RC
	MOV A,B
	CPI '?'
	JZ X5900H
	CPI 'A'
	JZ X5900H
	CPI 5FH;BACKSPACE CURSOR
	JZ X5900H
	SUB A
	RET
X5951H:	CALL X5931H
	RC
	MOV A,B
	CPI ':'
	JZ X5900H
	CPI '.'
	JZ X5900H
	SUB A
	RET
X5962H:	CALL X58EDH
	CPI CR
	JZ X5900H
	CPI LF
	JZ X5900H
	CPI 1BH;ESC
	JZ X5900H
	SUB A
	RET
X5976H:	CALL X58EDH
	CPI 09H;CTRL I
	JZ X5900H
	CPI ' '
	JZ X5900H
	SUB A
	RET
;==================
X5985H:	CALL X58EDH
	SUI '0'
	CPI 0AH
	RC
	SUI 07H
	ANI 5FH
	RET
;=================
X5992H:	LHLD ISERNO
	MOV A,M
	SUI 00H
	SUI 01H
	SBB A
	STA X5E92H
	RET
;================
X599FH:	CALL X5992H
	LDA X5E92H
	INR A
	LXI D,ISERNO
	CALL AP0014
	XCHG
	DCX H
	MOV M,E
	INX H
	MOV M,D
	CALL X5992H
	RET
;==================
X59D4H:	LXI H,X5E95H+1
	MOV M,B
	DCX H
	MOV M,C
	CALL X5A3DH
X59DDH:	CALL X5E9BH
	RAR
	JNC X59F2H
	CALL X599FH
	LDA X5E92H
	RAR
	JNC X59EFH
	RET
X59EFH:	JMP X59DDH
X59F2H:	RET
;=================-
X59F3H:	LXI H,X5E98H
	MOV M,B
	DCX H
	MOV M,C
	CALL X5992H
	LHLD ISERNO
	SHLD X5E99H
X5A02H:	CALL X5903H
	LHLD X5E97H
	SUB M
	SUI 01H
	SBB A
	PUSH PSW
	LDA X5E92H
	CMA
	POP B
	MOV C,B
	ANA C
	RAR
	JNC X5A31H
	LHLD X5E97H
	INX H
	SHLD X5E97H
	CALL X599FH
	LHLD X5E97H
	MOV A,M
	CPI 00H
	JNZ X5A2EH
	MVI A,0FFH
	RET
X5A2EH:	JMP X5A02H
X5A31H:	LHLD X5E99H
	SHLD ISERNO
	CALL X5992H
	MVI A,00H
	RET
;================
X5A3DH:	MOV H,B
	MOV L,C
	SHLD X5E9CH
	RET
;===============
X5A43H:	LXI B,X5976H
	CALL X59D4H
	RET
;================
X5A4AH:	POP D
	LHLD ISERNO
	PUSH H
	LXI H,X5A5AH
	PUSH H
	MOV H,B
	MOV L,C
	SHLD ISERNO
	PUSH D
	RET
;==================
X5A5AH:	XCHG
	POP H
	SHLD ISERNO
	MOV B,A
	SUB A
	SUB M
	CMC
	SBB A
	STA X5E92H
	MOV A,B
	XCHG
	RET
;====================-
MEMSIZ:	CALL MEMCK
	MOV H,B
	MOV L,A
	RET
;=============================
;CP/M INTERFACE
;==============================
ADELET:	LXI H,DELETE+1
	MOV M,B
	DCX H
	MOV M,C
	MVI A,02H
	JMP X5B2BH
AOPEN1:	LXI H,ACCES1
	MOV M,E
	DCX H
	CALL X5B56H
	LHLD WRITE1
	SHLD READ1
	SHLD CLOSE1
	RET
ACLOS1:	LXI D,CLOSE1
	JMP X5B5FH
AREAD1:	LXI H,READ1+5
	JMP X5B5AH
AWRIT1:	LXI H,WRITE1+5
	JMP X5B20H
AOPEN3:	LXI H,OPEN3+3
	CALL X5B56H
	LHLD READ3
	SHLD CLOSE3
	RET
ACLOS3:	LXI D,CLOSE3
	JMP X5B5FH
AREAD3:	LXI H,READ3+5
	JMP X5B5AH
AOPEN4:	LXI H,OPEN4+3
	CALL X5B56H
	LHLD WRITE4
	SHLD CLOSE4
	RET
ACLOS4:	LXI D,CLOSE4
	JMP X5B5FH
AWRIT4:	LXI H,WRITE4+5
	JMP X5B20H
ACIRD:	LXI H,CIREAD+5
	JMP X5B5AH
ARENAM:	MVI A,07H
	LXI H,RENAME+3
	MOV M,D
	DCX H
	MOV M,E
	DCX H
	MOV M,B
	DCX H
	MOV M,C
	JMP X5B2BH
AWHOCN:	MVI A,0DH
	LXI H,WHOCON+3
	JMP X5B26H
X5B20H:	MVI A,04H
X5B22H:	MOV M,D
	DCX H
	MOV M,E
	DCX H
X5B26H:	MOV M,B
	DCX H
	MOV M,C
	DCX H
	DCX H
X5B2BH:	XCHG
	MOV C,A
X5B2DH:	CALL ISIS
	LHLD STATUS
	MOV A,H
	ORA L
	RZ
	MVI A,0FFH
	STA X5F35H
	LDA X5F34H
	RAR
	RNC
AERROR:	MVI C,0CH
	LXI D,STATUS
	CALL ISIS
	LDA X5F36H
	RAR
	RNC
AEXIT:	MVI C,09H
	LXI D,EXIT
	CALL ISIS
	RST 0
X5B56H:	SUB A
	JMP X5B26H
X5B5AH:	MVI A,03H
	JMP X5B22H
X5B5FH:	MVI C,01H
	JMP X5B2DH
;=====================
CO:	MOV E,C
	MVI C,6		;DIRECT O/P
	CALL BDOS
	RET
;=================
CI:	MVI C,6
	MVI E,0FFH	;DIRECT I/P
	CALL BDOS
	ORA A
	JZ CI
	RET
;====================
CSTS:	MVI C,11
	CALL BDOS
	ORA A
	RET
;===================
MEMCK:	LHLD BOOT+6
	DCX H
	MOV B,H
	MOV A,L
	RET
;========================
;REQUIRES C=ISIS FUNCTION CODE
;DE=.ISIS CONTROL BLOCK
ISIS:	LXI H,0
	DAD SP
	SHLD USERSP
	LXI SP,USERSP
	MVI A,14	;CALLS 0 TO 14 VALID
	SUB C
	JC ISERR
	MOV L,C
	MVI H,0
	DAD H
	LXI B,ISBASE
	DAD B
	MOV A,M
	INX H
	MOV H,M
	MOV L,A
	PCHL		;TO SIMULATED ISIS PROCEDURE
;
ISBASE:	DW OPEN
	DW CLOSE
	DW DXLETE
	DW READ
	DW WRITE
	DW ISERR
	DW ISERR
	DW RXNAME
	DW ISERR
	DW XIT
	DW ISERR
	DW ISERR
	DW ERROR
	DW WHXCON
	DW ISERR
;=====================
OPEN:	CALL OPN
	JMP ISRET
OPN:	XCHG
	SHLD ISCBL
	LXI H,TABLE2
	LXI D,TABLEN
	MVI C,6
OPN1:	MOV A,M
	ORA A
	JZ OPNFND
	DAD D
	DCR C
	JNZ OPN1
	LXI B,3
	JMP ERR		;NO TABLE SPACE
OPNFND:	CMA
	MOV M,A		;RECORD ALLOCATION
	SHLD OPNTAB	;SAVE .TABLE
	INX H
	INX H
	MOV C,M
	INX H
	MOV B,M		;BC=AFTN
	LHLD ISCBL
	MOV E,M
	INX H
	MOV D,M		;RETURN OAFT
	XCHG
	MOV M,C
	INX H
	MOV M,B
	XCHG
	LXI D,5
	DAD D
	XRA A
	CMP M		;TEST ECHO
	INX H
	JNZ ECHERR
	CMP M
	JZ OPN2
ECHERR:	LXI B,25
	JMP ERR		;ILLEGAL ECHO
OPN2:	DCX H
	DCX H
	DCX H
	MOV A,M		;ACCESS
	ORA A
	JZ OPN3
	CPI 4
	JC OPN4
OPN3:	LXI B,22
	JMP ERR
OPN4:	XCHG
	LHLD OPNTAB
	INX H
	MOV M,A		;ACCESS
	XCHG
	DCX H
	DCX H		;FILENAME POINT
	MOV C,M
	INX H
	MOV B,M
	LXI D,14
	LHLD OPNTAB
	DAD D
	PUSH B
	PUSH H
	XRA A
	MVI C,36
	CALL CLEAR	;CLEAR FCB TO NULLS
	POP D
	POP H
	PUSH D
	CALL MAKFCB
	RAR
	POP D
	JNC OPN5
	LHLD OPNTAB
	XRA A
	MOV M,A		;REMOVE TABLE ALLOC
	LHLD ISCBL
	INX H
	INX H
	MOV E,M
	INX H
	MOV D,M		;DE=.ISIS FILENAME
	CALL LTST	;LEGAL DEVICE ?
	CPI 0FFH
	JNZ OPN6
	LXI B,5
	JMP OPN10	;ILLEGAL DEVICE
OPN6:	CPI 2
	JC OPN17
	ADI 6
OPN17:	MOV C,A
	MVI B,0		;BC=AFTN
	LXI D,0
	CALL SAVST	;RETURN AFTN
	LXI B,0
	JMP OPN10
OPN5:	LHLD OPNTAB
	INX H
	INX H
	MOV B,M		;CURRENT AFTN
	MVI C,6
	LXI H,TABLE2
OPN15:	MOV A,M		;TEST FOR OPEN TABLE
	ORA A
	PUSH D
	PUSH H
	JZ OPN20
	INX H
	INX H
	MOV A,B
	CMP M
	JZ OPN20
	PUSH B
	LXI B,12
	DAD B
	MVI C,12
OPN16:	LDAX D
	CMP M
	JNZ OPN19
	INX H
	INX D
	DCR C
	JNZ OPN16
	POP B
	POP H
	POP D
	LXI B,12
	JMP ERR		;ALREADY OPEN
OPN19:	POP B
OPN20:	POP H
	LXI D,TABLEN
	DAD D
	POP D
	DCR C
	JNZ OPN15
	PUSH D
	MVI C,15	;OPEN
	CALL BDOS
	POP D
	INR A
	JNZ OPN8
	LHLD OPNTAB	;FILE NON EXISTING
	INX H
	MOV A,M		;ACCESS
	CPI 2
	JZ OPN7
	CPI 3
	JZ OPN7
	LXI B,13
	JMP ERR		;NO SUCH FILE
OPN7:	PUSH D
	MVI C,22	;MAKE
	CALL BDOS
	INR A
	POP D
	JNZ OPN21
	LXI B,9
	JMP ERR		;DIR FULL
OPN8:	LXI H,9
	DAD D
	MOV A,M
	ANI 80H		;WR PROT BIT
	JZ OPN9A
	LHLD OPNTAB
	INX H
	MOV A,M
	DCR A
	JZ OPN30
	LXI B,14	;WRITE PROTECTED
ERR:	LHLD OPNTAB
	MVI M,0
	JMP OPN10
OPN9A:	LHLD OPNTAB
	INX H
	MOV A,M
	CPI 2		;WRITE
	JNZ OPN30
	PUSH D
	MVI C,19	;DELETE THEN MAKE
	CALL BDOS
	POP D
	JMP OPN7
OPN30:	PUSH D		;SAVE .FCB
	LXI D,3
	DAD D
	MOV E,M
	INX H
	MOV D,M		;DE=.BUFF
	MVI C,26	;SET DMA
	CALL BDOS
	POP D
	MVI C,20	;READ
	CALL BDOS
OPN21:	CALL SETEOF	;NON ZERO=EOF
OPN9:	LHLD OPNTAB
	LXI D,4
	DAD D
	MOV E,M
	INX H
	MOV D,M
	INX H
	MOV M,E
	INX H
	MOV M,D		;INIT CURRENT BYTE POINT
	LXI B,0		;NO ERROR
OPN10:	LXI D,8		;RETURN STATUS
	CALL SAVST
	RET
;========================
CLOSE:	CALL CLOS
	JMP ISRET
CLOS:	XCHG
	SHLD ISCBL
	MOV A,M		;AFTN
	CPI 8
	JC CLO1
CLO0:	LXI B,0
	JMP CLER
CLO1:	SUI 2
	JM CLO0
	LXI H,TABLE2
	LXI D,TABLEN
CLO2:	JZ CLO3
	DAD D
	DCR A
	JMP CLO2
CLO3:	SHLD OPNTAB
	MOV A,M
	ORA A
	LXI B,2
	JZ CLER		;TABLE NOT OPEN
	CALL CLO6	;CLOSE TABLE
	LHLD OPNTAB
	MVI M,0		;CLOSE TABLE
	LXI B,0
CLER:	LXI D,2		;RETURN STATUS
	CALL SAVST
	RET
;========================
DXLETE:	XCHG
	SHLD GPCB
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD DBLK+2
	LXI H,3
	SHLD DBLK+4	;UPDATE
	LXI D,DBLK	;ISIS OPEN
	CALL OPN
	LHLD DSTAT
	MOV A,L
	ORA A
	JZ DELET1
	MOV C,L
	MOV B,H
	JMP DELET3
DELET1:	LXI B,17
	LDA DAFT
	CPI 8
	JNC DELET2	;NOT DISK FILE
	SUI 2
	JM DELET2
	LHLD OPNTAB	;.TABLE
	LXI D,14
	DAD D
	XCHG		;DE=.FCB
	MVI C,19	;DELETE
	CALL BDOS
	INR A
	JZ IOERR	;NOT FOUND, FATAL
	LXI B,0		;NO ERROR
DELET2:	LHLD OPNTAB
	XRA A
	MOV M,A		;DE ALLOCATE TABLE
DELET3:	LHLD GPCB
	SHLD ISCBL
	LXI D,2		;RETURN STATUS
	CALL SAVST
	JMP ISRET
;========================
READ:	LXI H,0
	SHLD ACT	;SET ACTUAL=0
	XCHG
	SHLD ISCBL
	MOV A,M		;AFTN
	ORA A
	JNZ RD1
	LXI B,8
	JMP RDERR	;OPEN FOR WRITE
RD1:	CPI 1
	JNZ RD2
	XRA A
	CMA
	STA CONSW	;SET :CI: SWITCH
	LHLD CIPNT
	SHLD INPTR
	JMP RD8
RD2:	CPI 8
	JC RD3
	LXI B,8
	JMP RDERR	;ILLEGAL ACCESS
RD3:	SUI 2
	LXI H,TABLE2
	LXI D,TABLEN	;FIND TABLE
RD4:	JZ RD5
	DAD D
	DCR A
	JMP RD4
RD5:	SHLD OPNTAB	;SAVE TABLE POINT
	MOV A,M
	ORA A
	JNZ RD6
	LXI B,2
	JMP RDERR	;FILE NOT OPEN
RD6:	INX H
	MOV A,M
	CPI 1
	JZ RD7
	CPI 3
	JZ RD7
	LXI B,8
	JMP RDERR	;ILLEGAL ACCESS
RD7:	CALL RWSET1
RD8:	CALL RWSET2
GETNXT:	LHLD LEN
	XCHG
	LHLD ACT
	MOV A,E
	SUB L
	JNZ GETN1
	MOV A,D
	SUB H
	JZ RD80
GETN1:	LDA CONSW
	RAR
	JNC GETN3
	LHLD IBFPNT
	XCHG
	LHLD INPTR
	LDA INITSW
	RAR
	JC RD10
	PUSH D
	PUSH H
RD9:	MVI E,0FFH
	MVI C,6		;READ CI
	CALL BDOS
	ORA A
	JZ RD9		;WAIT FOR CHAR
	POP H
	POP D
	STAX D
	JMP RD11
RD10:	MOV A,M
	STAX D
	INX H
RD11:	CALL TERMTS
	JNC GETN2
	LXI H,81H
	SHLD INPTR	;START OF BUF
	XRA A
	STA INITSW
	LHLD IBFPNT
	INX H
	MVI M,LF
	LHLD ACT
	INX H
	INX H
	SHLD ACT
	JMP RD80
GETN3:	LHLD OPNTAB
	XCHG
	LXI H,8
	DAD D
	MOV A,M		;TEST EOF SW
	ORA A
	JNZ RD80
	LXI H,46	;CR
	DAD D
	MOV A,M
	LXI H,29	;RC
	DAD D
	CMP M
	JNZ RD50	;CR<>RC
	LXI H,27	;S1
	DAD D
	MOV A,M
	ANI 7FH		;IGNORE BIT 7
	JZ RD50		;OK FULL BUFFER
	LHLD STRTBF	;FORM END BYTE POINT
	MOV C,A
	MVI B,0
	DAD B
	LXI D,INPTR
	MOV C,L
	MOV B,H
	CALL AP0100
	JNC RD80	;END OF FILE
RD50:	LHLD INPTR
	XCHG
	LHLD IBFPNT
	LDAX D
	MOV M,A
	INX D
	LHLD ENDPTR
	MOV A,E
	SUB L
	JNZ GETN4
	MOV A,D
	SUB H
	JNZ GETN4
	LHLD OPNTAB
	LXI D,14
	DAD D
	XCHG
	MVI C,20	;READ
	CALL BDOS
	CALL SETEOF	;NON ZERO=EOF
	LHLD OPNTAB
	LXI B,4
	DAD B
	MOV E,M
	INX H
	MOV D,M
GETN4:	LHLD IBFPNT
	XCHG		;HL=INPTR (.BUFFER)
GETN2:	SHLD INPTR
	INX D
	XCHG
	SHLD IBFPNT
	LHLD ACT
	INX H
	SHLD ACT
	JMP GETNXT
RD82:	LHLD INPTR
	SHLD CIPNT
	JMP RD81
RD80:	LDA CONSW
	RAR
	JC RD82
	LHLD INPTR
	XCHG
	LHLD OPNTAB
	LXI B,6
	DAD B
	MOV M,E
	INX H
	MOV M,D		;SAVE INPTR IN TABLE
RD81:	LXI B,0
RDERR:	LXI D,8		;RETURN STATUS
	CALL SAVST
	LHLD ACT
	MOV C,L
	MOV B,H
	LXI D,6
	CALL SAVST	;SAVE ACTUAL
	JMP ISRET
;========================
WRITE:	XCHG
	SHLD ISCBL
	MOV A,M		;AFTN
	CPI 1
	JNZ WR1
	LXI B,6		;OPEN FOR I/P
	JMP WRERR
WR1:	ORA A
	JNZ WR2
WR3:	MVI A,0FFH	;NOT DISK
	STA CONSW
	JMP WR8
WR2:	CPI 8
	JNC WR3
	SUI 2
	LXI H,TABLE2
	LXI D,TABLEN	;FIND TABLE
WR4:	JZ WR5
	DAD D
	DCR A
	JMP WR4
WR5:	SHLD OPNTAB	;SAVE TABLE POINT
	MOV A,M
	ORA A
	JNZ WR6
	LXI B,2
	JMP WRERR	;TABLE NOT OPEN
WR6:	INX H
	MOV A,M
	CPI 2
	JZ WR7
	CPI 3
	JZ WR7
	LXI B,6		;ILLEGAL ACCESS
	JMP WRERR
WR7:	CALL RWSET1
WR8:	CALL RWSET2
WR9:	LHLD LEN
	XCHG
	LHLD ACT
	MOV A,E
	SUB L
	JNZ WR10
	MOV A,D
	SUB H
	JZ WR80
WR10:	LHLD IBFPNT
	MOV C,M		;GET CHAR
	INX H
	SHLD IBFPNT
	LHLD ACT
	INX H
	SHLD ACT
	LDA CONSW
	RAR
	JC WR11
	LHLD ENDPTR
	XCHG
	LHLD INPTR
	MOV M,C		;SAVE CHAR IN BUFFER
	INX H
	SHLD INPTR
	MOV A,E
	SUB L
	JNZ WR9
	MOV A,D
	SUB H
	JNZ WR9
	LHLD OPNTAB
	INX H
	MOV A,M		;ACCESS
	DCX H
	CPI 3
	CZ BACKUP
	LHLD OPNTAB
	XCHG
	LXI H,27
	DAD D
	MOV A,M
	ANI 80H
	MOV M,A		;ZERO S1
	XCHG
	CALL CLOWR	;BDOS WRITE
	LHLD OPNTAB
	INX H
	MOV A,M
	LXI B,3
	DAD B
	MOV E,M
	INX H
	MOV D,M
	XCHG		;START OF BUFFER
	SHLD INPTR
	CPI 3
	JNZ WR9
	LHLD OPNTAB
	LXI D,14
	DAD D
	XCHG
	MVI C,20	;READ
	CALL BDOS
	CALL SETEOF
	ORA A
	JZ WR9
	XRA A
	LHLD INPTR
	MVI C,128
	CALL CLEAR	;128 NULLS TO BUFFER
	JMP WR9
WR11:	LHLD ISCBL
	MOV A,M		;AFTN
	ORA A
	JNZ WR9
	MOV E,C		;WRITE TO CO
	MVI C,6
	CALL BDOS
	JMP WR9
WR80:	LDA CONSW
	RAR
	JC WR90
	LHLD INPTR
	XCHG
	LHLD OPNTAB
	LXI B,6
	DAD B
	MOV M,E
	INX H
	MOV M,D		;SAVE INPTR IN TABLE
	CALL UPDCLO	;WRITE BUFFER IF REQUIRED
WR90:	LXI B,0
WRERR:	LXI D,6		;RETURN STATUS
	CALL SAVST
	JMP ISRET
;========================
RXNAME:	XCHG
	SHLD GPCB
	INX H
	INX H
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD DBLK+2
	LXI H,1		;ACCESS=READ
	SHLD DBLK+4
	LXI D,DBLK
	CALL OPN	;ISIS OPEN
	LDA DSTAT
	CPI 13
	LXI B,11
	JNZ RENER
	LHLD OPNTAB
	LXI D,14
	DAD D
	XCHG
	LXI H,RENTMP
	MVI C,16
REN2:	LDAX D		;MOVE FCB TO BUFFER
	MOV M,A
	INX D
	INX H
	DCR C
	JNZ REN2
	LHLD GPCB
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD DBLK+2
	LXI D,DBLK
	CALL OPN	;ISIS OPEN
	LDA DSTAT
	LXI B,13
	ORA A
	JNZ RENER
	LHLD OPNTAB
	LXI D,14
	DAD D
	PUSH H		;.FCB
	LXI D,16
	DAD D
	XCHG
	LXI H,RENTMP
	MVI C,16
REN3:	MOV A,M
	STAX D
	INX H
	INX D
	DCR C
	JNZ REN3
	POP D		;.FCB
	LDAX D
	LXI H,16
	DAD D
	CMP M		;SAME DRIVES?
	LXI B,10
	JNZ RENER
	MVI C,23	;RENAME
	CALL BDOS
	INR A
	JZ IOERR	;FATAL
	LXI B,0
RENER:	LHLD OPNTAB
	XRA A
	MOV M,A		;REMOVE ALLOC
	LHLD GPCB
	SHLD ISCBL
	LXI D,4		;RETURN STATUS
	CALL SAVST
	JMP ISRET
;========================
XIT:	XCHG
	SHLD ISCBL
	MVI C,6
	LXI H,TABLE2
EXIT1:	MOV A,M
	ORA A
	JZ EXIT2	;ZERO=NOT OPEN
	PUSH H
	PUSH B
	CALL CLO6	;CLOSE TABLE
	POP B
	POP H
	MVI M,0		;DE ALLOCATE TABLE
EXIT2:	LXI D,TABLEN
	DAD D
	DCR C
	JNZ EXIT1
	JMP BOOT	;SAFEST RETURN TO CCP
;========================
ERROR:	XCHG
	SHLD ISCBL
	XCHG
	CALL XERROR
	LXI B,0
	LXI D,2		;SAVE STATUS
	CALL SAVST
	JMP ISRET
XERROR:	XCHG
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD VALUE
	LXI H,EBUF
	SHLD BUFADR
	MVI A,10
	STA BASE
	MVI A,' '
	STA PADCHR
	MVI A,4
	STA SIZE
	CALL CONV
	MVI C,9
	LXI D,EMSSG
	CALL BDOS
	RET
;========================
WHXCON:	XCHG
	SHLD ISCBL
	MOV A,M
	INX H
	INX H
	MOV E,M
	INX H
	MOV D,M
	MVI C,15
	LXI H,WHCO
	ORA A
	JZ WHOC1
	LXI H,WHCI
WHOC1:	CALL WHMOV	;MOVE NAME TO BUFFER
	LXI B,0
	LXI D,4		;SAVE STATUS
	CALL SAVST
	JMP ISRET
;========================
;NORMAL AND NON FATAL ERROR RETURN
ISRET:	LHLD USERSP
	SPHL
	RET
;=============================
;FATAL ERROR RETURNS
DSKFUL:	LXI H,7		;DISK FULL
	JMP ISERR1
IOERR:	LXI H,24	;I/O ERROR
	JMP ISERR1
ISERR:	LXI H,33	;ILLEGAL SYSTEM CALL
ISERR1:	SHLD EBUF
	LXI D,EBUF
	CALL XERROR
	JMP BOOT
;
;======SUBROUTINES==============
;HL=.ISIS BUFFER  DE=.FCB
;RETURNS A=0 IF OK ELSE A=FF
MAKFCB:	XRA A
	CMA
	STA FSTSW
	SHLD IBFPNT	;FIRST CHAR OF SOURCE
	XCHG
	SHLD FCBST
	MVI M,1		;ISIS DEFAULT DRIVE 0
	INX H
	SHLD FCBPNT
	MVI C,11	;INITIALISE FCB
	MVI A,' '
	CALL CLEAR
	MVI C,6		;CHAR COUNT
NXTCHR:	LHLD IBFPNT
	MOV A,M
	CALL COCAS
	CALL DELTST
	JZ DEL
	CALL TERMTS
	JC DEL
	CPI ':'
	JZ COLON
	CPI '.'
	JZ DOT
	CPI '*'
	JZ INVAL
	LHLD FCBPNT
	MOV M,A
	INX H
	SHLD FCBPNT
	XRA A
	STA FSTSW
	DCR C
	JM INVAL
INCBUF:	LHLD IBFPNT
	INX H
	SHLD IBFPNT
	JMP NXTCHR
DEL:	MOV B,A
	LDA FSTSW
	RAR
	JNC VAL
	MOV A,B
	CALL TERMTS
	JC VAL
	JMP INCBUF
COCAS:	CPI 'a'
	RC
	CPI 'Z'+1
	RNC
	SUI 20H
	RET
DOT:	LDA FSTSW
	RAR
	JC INVAL
	MVI C,3
	LXI D,9
	LHLD FCBST
	DAD D
	SHLD FCBPNT
	JMP INCBUF
COLON:	LDA FSTSW
	RAR
	JC COLON1
	LHLD FCBST
	INX H
	MOV A,M
	CPI '0'
	JC INVAL
	CPI '5'+1	;DRIVES 0 TO 5 ARE OK
	JNC INVAL
	SUI 2FH
	DCX H
	MOV M,A
	INX H
	SHLD FCBPNT
	MVI A,' '
	MOV M,A
	MVI C,6
	JMP INCBUF
COLON1:	LHLD IBFPNT
	INX H
	SHLD IBFPNT
	MOV A,M
	CPI 'F'
	JZ INCBUF
	CPI 'f'
	JZ INCBUF
INVAL:	XRA A
	CMA
	RET
VAL:	XRA A
	RET
;==========================
;DELIMITER TEST
DELTST:	CPI ' '
	RZ
	CPI 9H		;TAB
	RZ
	CPI ','
	RZ
	CPI '='
	RZ
	CPI '<'
	RZ
	CPI '"'
	RET
;===========================
;TERMINATOR TEST, CY SET=TERMINATOR
TERMTS:	CPI ' '
	RC
	CPI 7BH
	CMC
	RET
;===================
;TEST FOR LEGAL DEVICE
;REQUIRES DE=.ISIS DEVICE NAME
;RETURNS A=DEVICE COUNT IF LEGAL ELSE A=FF
;RETURNS E=DEVICE NO.
LTST:	XRA A
	STA DEVCNT
	MVI A,18H
	STA DEVNO
	LXI B,DEVLEN
	LXI H,LEGDEV
LTST1:	PUSH D
	PUSH H
LTST2:	LDAX D
	CALL COCAS
	CMP M
	JNZ LTST3
	INX H
	INX D
	DCR C
	JNZ LTST2
	POP H
	POP D
	LDA DEVNO	;RETURN DEVICE NO
	MOV E,A
	LDA DEVCNT	;RETURN DEVICE COUNT
	RET
LTST3:	POP H
	POP D
	LXI B,DEVLEN
	DAD B
	LDA DEVCNT
	INR A
	STA DEVCNT
	LDA DEVNO
	DCR A
	STA DEVNO
	XRA A
	CMP M
	JNZ LTST1
	MVI A,0FFH
	RET
LEGDEV:	DB ':CO:'	;CONSOLE O/P
DEVLEN EQU $-LEGDEV
	DB ':CI:'	;CONSOLE I/P
	DB ':BB:'	;BYTE BUCKET
	DB ':L1:'	;USER LIST 1
	DB ':LP:'	;LINE PRINTER
	DB ':P2:'	;USER PUNCH 2
	DB ':P1:'	;USER PUNCH 1
	DB ':HP:'	;HIGH SPEED PUNCH
	DB ':TP:'	;TELETYPE PUNCH
	DB ':R2:'	;USER READER 2
	DB ':R1:'	;USER READER 1
	DB ':HR:'	;HIGH SPEED READER
	DB ':TR:'	;TELETYPE READER
	DB ':O1:'	;USER CO
	DB ':I1:'	;USER CI
	DB ':VO:'	;CRT O/P
	DB ':VI:'	;CRT I/P
	DB ':TO:'	;TELETYPE O/P
	DB ':TI:'	;TELETYPE I/P
NODEV EQU ($-LEGDEV)/DEVLEN
	DB 0		;END TAB MARK
;======================
;SETS EOF SW TO A
SETEOF:	LHLD OPNTAB
	LXI D,8
	DAD D
	MOV M,A
	RET
;=====================
RWSET1:	XRA A
	STA CONSW
	LXI B,4
	LHLD OPNTAB
	DAD B
	MOV E,M
	INX H
	MOV D,M		;DE=.ITM IO BUFF
	PUSH D
	INX H
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD INPTR	;CURRENT BYTE POINT
	POP H
	SHLD STRTBF
	XCHG
	LXI H,80H
	DAD D
	SHLD ENDPTR	;SET END POINTER
	MVI C,26	;SET DMA
	CALL BDOS
	RET
;===========================
RWSET2:	LHLD ISCBL
	INX H
	INX H
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD IBFPNT	;ISIS I/O BUFFER POINT
	XCHG
	INX H
	MOV E,M
	INX H
	MOV D,M
	XCHG
	SHLD LEN	;LENGTH OF READ/WRITE
	LXI H,0
	SHLD ACT	;ACTUAL R/W
	RET
;=========================
;RETURN HL=BUFFER POINT-.BUFFER
GETBYT:	LHLD OPNTAB
	LXI D,4
	DAD D
	MOV E,L
	MOV D,H
	INX H
	INX H
	XCHG
	CALL AP0099
	RET
;========================
;SAVE DATA IN ISIS CONTROL BLOCK
;BC=DATA  DE=ISIS BLOCK ADD FACTOR
SAVST:	LHLD ISCBL
	DAD D
	MOV E,M
	INX H
	MOV D,M
	XCHG
	MOV M,C
	INX H
	MOV M,B
	RET
;==================
WHMOV:	MOV A,M
	STAX D
	INX H
	INX D
	DCR C
	JNZ WHMOV
	RET
;========================
CLEAR:	MOV M,A
	INX H
	DCR C
	JNZ CLEAR
	RET
;=========================
;CLOSE DISK FILE I/O TABLE
;REQUIRES HL=.OPEN TABLE
CLO6:	SHLD TMPTAB
	INX H		;ACCESS
	MOV A,M
	CPI 2
	JNZ CLO4
	INX H
	INX H
	INX H
	MOV C,M		;.BUFFER
	INX H
	MOV B,M
	PUSH B
	INX H
	XCHG
	CALL AP0100
	SHLD BYTDIF
	POP D		;.BUFFER
	MOV A,L
	ORA H
	JZ CLO5
	MVI C,26	;SET DMA
	CALL BDOS
	LHLD TMPTAB
	CALL CLOWR	;BDOS WRITE
CLO5:	LHLD TMPTAB
	LXI B,27
	DAD B		;S1
	MOV A,M
	ANI 80H
	MOV C,A
	LDA BYTDIF
	ANI 7FH		;ENSURE MAX BYTDIF=7F
	ORA C		;COMBINE WITH S1
	MOV M,A		;SAVE LO BYTDIF IN S1
CLO4:	LHLD TMPTAB
	LXI D,14
	DAD D
	XCHG
	MVI C,16	;CLOSE
	CALL BDOS
	INR A
	JZ IOERR	;FATAL
	RET
;=====================
;REQUIRES HL=.OPEN TABLE
CLOWR:	LXI D,14
	DAD D
	XCHG
	MVI C,21	;WRITE
	CALL BDOS
	ORA A
	JNZ DSKFUL	;FATAL
	RET
;======================
UPDCLO:	LHLD OPNTAB
	INX H
	MOV A,M
	CPI 3
	RNZ
	CALL GETBYT	;BYTEPOINT-.BUFFER
	SHLD BYTDIF
	MOV A,L
	ORA H
	RZ
	LHLD OPNTAB
	CALL BACKUP
	LHLD OPNTAB
	CALL CLOWR	;BDOS WRITE
	LHLD OPNTAB
	CALL BACK1	;BACKUP
	LHLD OPNTAB
	XCHG
	LXI H,8
	DAD D
	MOV A,M
	ORA A		;EOF SW
	JNZ UPDCL1
	LXI H,46	;CR
	DAD D
	MOV A,M
	LXI H,29	;RC
	DAD D
	CMP M
	RNZ
	LXI H,27
	DAD D
	MOV A,M		;S1
	ANI 7FH
	LHLD STRTBF
	MOV C,A
	MVI B,0
	DAD B
	PUSH D
	LXI D,INPTR
	MOV C,L
	MOV B,H
	CALL AP0100
	POP D
	RC		;INPTR < END BYTE
UPDCL1:	LXI H,27
	DAD D		;S1
	MOV A,M
	ANI 80H
	MOV C,A		;SAVE HI BIT OF S1
	LDA BYTDIF
	ANI 7FH
	ORA C
	MOV M,A
	RET
;==========================
;DECREMENT CR FOR UPDATE WRITE
;REQUIRES HL=.OPEN TABLE
BACK1:	XCHG
	LXI H,8
	DAD D
	XRA A
	CMP M
	JNZ BACK2
	RET
BACKUP:	XCHG
	LXI H,8
	DAD D
	XRA A
	CMP M		;EOF SW
	RNZ
BACK2:	LXI H,14+32	;CR
	DAD D
	MOV A,M
	DCR A
	MOV M,A
	RET
;================================-
;BIN TO ASCII, VARIABLE BASE
CONV:	LXI H,INT
	MVI M,1
CONV1:	LDA SIZE
	CMP M
	RC
	LDA INT
	DCR A
	JZ A1
	LHLD VALUE
	MOV A,L
	ORA H
	JNZ A1
	LDA PADCHR
	JMP A2
A1:	LHLD VALUE
	XCHG
	LHLD BASE
	MVI H,0
	CALL AP0029
	XCHG
	SHLD VALUE
	LXI H,'0'
	DAD D
	MOV A,L		;REMAINDER+'0'
	CPI '9'+1
	JC A2
	ADI 7
A2:	MOV E,A
	LXI H,INT
	LDA SIZE
	SUB M
	MOV C,A
	MVI B,0
	LHLD BUFADR
	DAD B
	MOV M,E		;J INTO BUFFER
	LXI H,INT
	INR M
	JMP CONV1
;=======FILE I/O TABLES============
TABLE2:	DB 0		;OPEN MARK
	DB 0		;ACCESS MODE
	DW 2		;AFTN
	DW BUFF2	;.BUFFER
	DW 0		;CURRENT BYTE POINTER
	DW 0		;EOF SW (LO BYTE)
	DW 0		;SPARE
	DW 0		;SPARE
	DS 36		;ICOS80 FCB
TABLEN EQU $-TABLE2
TABLE3:	DB 0
	DB 0
	DW 3
	DW BUFF3
	DW 0
	DW 0
	DW 0
	DW 0
	DS 36
TABLE4:	DB 0
	DB 0
	DW 4
	DW BUFF4
	DW 0
	DW 0
	DW 0
	DW 0
	DS 36
TABLE5:	DB 0
	DB 0
	DW 5
	DW BUFF5
	DW 0
	DW 0
	DW 0
	DW 0
	DS 36
TABLE6:	DB 0
	DB 0
	DW 6
	DW BUFF6
	DW 0
	DW 0
	DW 0
	DW 0
	DS 36
TABLE7:	DB 0
	DB 0
	DW 7
	DW BUFF7
	DW 0
	DW 0
	DW 0
	DW 0
	DS 36
EMSSG:	DB CR,LF,'ITM ERROR '
EBUF:	DS 4
	DB CR,LF,'$'
;========================
COAFT:	DW 0		;AFT OF CURRENT CO FILE
CIAFT:	DW 1		;AFT OF CURRENT CI FILE
WHCI:	DB ':CI: '	;CURRENT CI FILE
	DS 10
WHCO:	DB ':CO: '	;CURRENT CO FILE
	DS 10
;=============================
;CLOSE BLOCK
CBLK:	DS 2		;AFTN
	DW DSTAT	;.STATUS
;==========================
;OPEN BLOCK
DBLK:	DW DAFT		;AFTN POINT
	DS 2		;FILENAME POINT
	DS 2		;ACCESS
	DW 0		;ECHO
	DW DSTAT
DAFT:	DS 2		;AFTN
DSTAT:	DS 2		;STATUS
;====DATA MEMORY AREA===========
	DS 100		;ITM STACK
USERSP:	DS 2		;ISIS STACK POINT
;
ISCBL:	DS 2		;.ISIS CONTROL BLOCK
GPCB:	DS 2		;.GENERAL PURPOSE ISIS BLOCK
OPNTAB:	DS 2		;.CURRENT TABLE
ACT:	DS 2		;TEMP ACTUAL
LEN:	DS 2		;TEMP LENGTH
DOTFCB:	DS 2		;.FCB READ
BIAS:	DS 2		;LOAD BIAS
STRTBF:	DS 2		;.START OF BUFFER
INPTR:	DS 2		;INPUT BUF PNT
ENDPTR:	DS 2		;.BUFFER END
FCBPNT:	DS 2
FSTSW:	DS 1		;FIRST SWITCH
IBFPNT:	DS 2		;ISIS BUF PNT
FCBST:	DS 2		;.FCB
;
INITSW:	DS 1		;INITIAL READ SW
CONSW:	DS 1		;:CI: SWITCH
CIPNT:	DS 2		;CI BUF POINT
RENTMP:	DS 16		;RENAME BUFFER
;
TMPTAB:	DS 2		;USED BY CLO6
BYTDIF:	DS 2		;USED BY CLO6
;
DEVCNT:	DS 1		;DEVICE COUNTER
DEVNO:	DS 1		;DEVICE NUMBER
;
VALUE:	DS 2		;USED BY CONV
BUFADR:	DS 2
BASE:	DS 1
PADCHR:	DS 1
SIZE:	DS 1
INT:	DS 1
;==================
;PLM80.LIB MODULES
;===================
AP0012:	MOV C,M
	INX H
	MOV B,M
	LDAX D
	ADD C
	MOV L,A
	INX D
	LDAX D
	ADC B
	MOV H,A
	RET
;================
AP0014:	XCHG
	MOV E,A
	MVI D,00H
	XCHG
	LDAX D
	ADD L
	MOV L,A
	INX D
	LDAX D
	ADC H
	MOV H,A
	RET
;==================
AP0025:	XCHG
	MOV E,A
	MVI D,00H
	XCHG
	LDAX D
	ANA L
	MOV L,A
	INX D
	LDAX D
	ANA H
	MOV H,A
	RET
;==================
AP0029:	MOV B,H
	MOV C,L
AP0030:	LXI H,0000H
	MVI A,10H
X5B92H:	PUSH PSW
	DAD H
	XCHG
	SUB A
	DAD H
	XCHG
	ADC L
	SUB C
	MOV L,A
	MOV A,H
	SBB B
	MOV H,A
	INX D
	JNC X5BA4H
	DAD B
	DCX D
X5BA4H:	POP PSW
	DCR A
	JNZ X5B92H
	RET
;====================
AP0033:	DAD H
	PUSH H
	DAD H
	DAD H
	POP B
	DAD B
	RET
;================
AP0034:	MOV B,H
	MOV C,L
AP0035:	LXI H,0000H
	MVI A,10H
X5BBCH:	DAD H
	XCHG
	DAD H
	XCHG
	JNC X5BC4H
	DAD B
X5BC4H:	DCR A
	JNZ X5BBCH
	RET
;=================
AP0041:	SUB A
	SUB L
	MOV L,A
	MVI A,00H
	SBB H
	MOV H,A
	RET
;================
AP0094:	MOV E,A
	MVI D,00H
AP0095:	MOV A,E
	SUB L
	MOV L,A
	MOV A,D
	SBB H
	MOV H,A
	RET
;===================
AP0096:	MOV C,A
	MVI B,00H
AP0097:	MOV A,E
	SUB C
	MOV L,A
	MOV A,D
	SBB B
	MOV H,A
	RET
;=================
AP0098:	MOV L,C
	MOV H,B
AP0099:	MOV C,M
	INX H
	MOV B,M
AP0100:	LDAX D
	SUB C
	MOV L,A
	INX D
	LDAX D
	SBB B
	MOV H,A
	RET
;===================
AP0101:	MOV L,A
	MVI H,00H
AP0102:	LDAX D
	SUB L
	MOV L,A
	INX D
	LDAX D
	SBB H
	MOV H,A
	RET
;=================
AP0103:	MOV E,A
	MVI D,00H
AP0104:	MOV A,E
	SUB M
	MOV E,A
	MOV A,D
	INX H
	SBB M
	MOV D,A
	XCHG
	RET
;==================
X5C66H:	DS 2
X5C68H:	DS 2
X5C6AH:	DS 2
X5C6CH:	DS 2
X5C6EH:	DS 2
X5C70H:	DS 2
X5C72H:	DS 2
X5C74H:	DS 2
X5C76H:	DS 2
X5C78H:	DS 2
MSIZ1:	DS 2
X5C7CH:	DS 2
MSIZ2:	DS 2
X5C80H:	DS 2
TXTND:	DS 2
X5C84H:	DS 2
CIBUF:	DS 50
X5CB8H:	DS 11
X5CC3H:	DS 11
X5CCEH:	DS 22
X5CE4H:	DS 22
X5CFAH:	DS 21
X5D0FH:	DS 1
VSTACK:	DS 16
X5D20H:	DS 2
X5D22H:	DS 2
X5D24H:	DS 22
SCOLON:	DS 16
X5D4AH:	DS 2
X5D4CH:	DS 2
X5D4EH:	DS 2
X5D50H:	DS 2
X5D52H:	DS 2
X5D54H:	DS 2
X5D56H:	DS 1
CITMP:	DS 1
X5D58H:	DS 1
X5D59H:	DS 1
X5D5AH:	DS 1
X5D5BH:	DS 1
X5D5CH:	DS 1
X5D5DH:	DS 1
X5D5EH:	DS 1
X5D5FH:	DS 1
X5D60H:	DS 1
X5D61H:	DS 1
X5D62H:	DB 0
X5D63H:	DB 0
X5D64H:	DB ':F'
X5D66H:	DB '0:EDIT.MAC '
	DS 19
;
;
X5D84H:	DB ':F'
X5D86H:	DB 'X:EDIT.TMP '
X5D91H:	DB 0
E1UF:	DB ' '
E2UF:	DB 8
E3UF:	DB 10
E4UF:	DB '?'
E5UF:	DB LF
E6UF:	DB '*',0
E8UF:	DB 1AH
E9UF:	DB 0
E10UF:	DB 0
E11UF:	DB 8
E12UF:	DB '!'
E13UF:	DB 0
E14UF:	DW 0FFFFH
X5DA1H:	DB 04H,00H,0FFH
	DB 0FEH,04H,00H,0FFH
	DB 0FFH,00H
X5DAAH:	DB 00H,00H
	DB 00H,00H,00H,00H
BB1PNT:	DW BBMS
BB2PNT:	DW BBMS
BB3PNT:	DW BBMS
BFPNT:	DW TXTBUF
X5DB8H:	DB 0CH
X5DB9H:	DB 1BH
X5DBAH:	DB 0FFH
X5DBBH:	DS 1
X5DBCH:	DS 1
X5DBDH:	DS 1
X5DBEH:	DS 1
X5DBFH:	DS 1
X5DC0H:	DS 1
X5DC1H:	DS 1
X5DC2H:	DS 1
X5DC3H:	DS 1
X5DC4H:	DS 1
X5DC5H:	DS 22
X5DDBH:	DS 1
X5DDCH:	DS 1
X5DDDH:	DS 22
X5DF3H:	DS 1
X5DF4H:	DS 1
X5DF5H:	DS 1
X5DF6H:	DS 1
X5DF7H:	DS 1
X5DF8H:	DS 1
X5DF9H:	DS 2
X5DFBH:	DS 1
X5DFCH:	DS 1
X5DFDH:	DS 1
X5DFEH:	DS 1
X5DFFH:	DS 1
X5E00H:	DS 1
X5E01H:	DS 2
X5E03H:	DS 1
X5E04H:	DS 1
X5E05H:	DS 15
X5E14H:	DS 1
X5E15H:	DS 1
X5E16H:	DS 1
X5E19H:	DS 1
X5E1AH:	DS 2
X5E1CH:	DS 1
X5E1DH:	DS 1
X5E1EH:	DS 1
X5E1FH:	DS 1
X5E20H:	DS 1
X5E21H:	DS 2
X5E23H:	DS 2
X5E25H:	DS 1
X5E26H:	DS 1
WRBRAN:	DS 2
X5E29H:	DS 1
X5E2AH:	DS 1
X5E2BH:	DS 2
X5E2DH:	DS 1
X5E2EH:	DS 2
X5E30H:	DS 1
X5E31H:	DS 1
X5E32H:	DS 2
X5E34H:	DS 1
X5E35H:	DS 1
X5E36H:	DS 1
X5E37H:	DS 1
X5E38H:	DS 1
X5E39H:	DS 1
X5E3AH:	DS 1
X5E3BH:	DS 1
X5E3CH:	DS 1
X5E3DH:	DS 1
X5E3EH:	DS 1
X5E3FH:	DS 1
X5E40H:	DS 1
X5E41H:	DS 1
;======================
X5E84H:	DS 2
X5E86H:	DS 1
X5E87H:	DS 1
X5E88H:	DS 2
X5E8AH:	DS 1
X5E8BH:	DS 2
X5E8DH:	DS 1
X5E8EH:	DS 1
X5E8FH:	DS 1
ISERNO:	DW 0
X5E92H:	DS 1
X5E95H:	DS 2
X5E97H:	DS 1
X5E98H:	DS 1
X5E99H:	DS 2
X5E9BH:	DB 0C3H
X5E9CH:	DW 0
;
;
X5F34H:	DB 0FFH
X5F35H:	DB 0
X5F36H:	DB 0
;
DELETE:	DW 0
	DW STATUS
;
OPEN1:	DW WRITE1
	DW 0
ACCES1:	DW 0
	DW 0
	DW STATUS
;
CLOSE1:	DW 0
	DW STATUS
;
READ1:	DW 1
	DW 0
	DW 0
	DW ACTUAL
	DW STATUS
;
WRITE1:	DW 0
	DW 0
	DW 0
	DW STATUS
;
OPEN3:	DW READ3
	DW 0
	DW 1 ;READ
	DW 0
	DW STATUS
;
CLOSE3:	DW 0
	DW STATUS
;
READ3:	DW 1
	DW 0
	DW 0
	DW ACTUAL
	DW STATUS
;
OPEN4:	DW WRITE4
	DW 0
	DW 2 ;WRITE
	DW 0
	DW STATUS
;
CLOSE4:	DW 0
	DW STATUS
;
WRITE4:	DW 0
	DW 0
	DW 0
	DW STATUS
;
CIREAD:	DW 1
	DW 0
	DW 0
	DW ACTUAL
	DW STATUS
;
RENAME:	DW 0
	DW 0
	DW STATUS
;
WHOCON:	DW 1;CI
	DW 0
	DW STATUS
;
ACTUAL:	DW 0
;
;ERROR & EXIT
STATUS:	DW 0
EXIT:	DW STATUS
;
;
	DS 100		;STACK
STACK:
;BUFFER AREA
BUFF2:	DS 128		;FILE I/O BUFFERS
BUFF3:	DS 128
BUFF4:	DS 128
BUFF5:	DS 128
BUFF6:	DS 128
BUFF7:	DS 128
TXTBUF:	DS 1
END BEGIN
	DS 128		;FILE I/O BUFFERS
BUFF3:	DS 128